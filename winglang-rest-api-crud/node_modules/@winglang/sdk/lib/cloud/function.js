"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.FunctionInflightMethods = exports.Function = exports.FUNCTION_FQN = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const fs_1 = require("fs");
const path_1 = require("path");
const constants_1 = require("../constants");
const core_1 = require("../core");
const types_1 = require("../core/types");
const resource_names_1 = require("../shared/resource-names");
const std_1 = require("../std");
/**
 * Global identifier for `Function`.
 */
exports.FUNCTION_FQN = (0, constants_1.fqnForType)("cloud.Function");
/**
 * A function.
 *
 * @inflight `@winglang/sdk.cloud.IFunctionClient`
 * @abstract
 */
class Function extends std_1.Resource {
    constructor(scope, id, handler, props = {}) {
        if (new.target === Function) {
            return std_1.Resource._newFromFactory(exports.FUNCTION_FQN, scope, id, handler, props);
        }
        super(scope, id);
        this._env = {};
        std_1.Node.of(this).title = "Function";
        std_1.Node.of(this).description = "A cloud function (FaaS)";
        for (const [key, value] of Object.entries(props.env ?? {})) {
            this.addEnvironment(key, value);
        }
        this.handler = handler;
        const assetName = resource_names_1.ResourceNames.generateName(this, {
            // Avoid characters that may cause path issues
            disallowedRegex: /[><:"/\\|?*\s]/g,
            case: resource_names_1.CaseConventions.LOWERCASE,
            sep: "_",
        });
        const workdir = core_1.App.of(this).workdir;
        (0, fs_1.mkdirSync)(workdir, { recursive: true });
        const entrypoint = (0, path_1.join)(workdir, `${assetName}.cjs`);
        this.entrypoint = entrypoint;
        if (process.env.WING_TARGET) {
            this.addEnvironment("WING_TARGET", process.env.WING_TARGET);
        }
        if (props.concurrency !== undefined && props.concurrency <= 0) {
            throw new Error("concurrency option on cloud.Function must be a positive integer");
        }
    }
    /** @internal */
    _preSynthesize() {
        super._preSynthesize();
        // write the entrypoint next to the partial inflight code emitted by the compiler,
        // so that `require` resolves naturally.
        const lines = this._getCodeLines(this.handler);
        (0, fs_1.writeFileSync)(this.entrypoint, lines.join("\n"));
        // indicates that we are calling the inflight constructor and the
        // inflight "handle" method on the handler resource.
        core_1.Lifting.lift(this.handler, this, ["handle"]);
    }
    /**
     * @internal
     * @param handler IFunctionHandler
     * @returns the function code lines as strings
     */
    _getCodeLines(handler) {
        const inflightClient = handler._toInflight();
        const lines = new Array();
        const client = "$handler";
        lines.push('"use strict";');
        lines.push(`var ${client} = undefined;`);
        lines.push("exports.handler = async function(event) {");
        lines.push(`  ${client} = ${client} ?? (${inflightClient});`);
        lines.push(`  return await ${client}.handle(event);`);
        lines.push("};");
        return lines;
    }
    /**
     * Add an environment variable to the function.
     */
    addEnvironment(name, value) {
        if (this._env[name] !== undefined && this._env[name] !== value) {
            throw new Error(`Environment variable "${name}" already set with a different value.`);
        }
        this._env[name] = value;
    }
    /**
     * Returns the set of environment variables for this function.
     */
    get env() {
        return { ...this._env };
    }
}
exports.Function = Function;
_a = JSII_RTTI_SYMBOL_1;
Function[_a] = { fqn: "@winglang/sdk.cloud.Function", version: "0.0.0" };
/**
 * List of inflight operations available for `Function`.
 * @internal
 */
var FunctionInflightMethods;
(function (FunctionInflightMethods) {
    /** `Function.invoke` */
    FunctionInflightMethods["INVOKE"] = "invoke";
    /** `Function.invokeAsync` */
    FunctionInflightMethods["INVOKE_ASYNC"] = "invokeAsync";
})(FunctionInflightMethods || (exports.FunctionInflightMethods = FunctionInflightMethods = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY2xvdWQvZnVuY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwyQkFBOEM7QUFDOUMsK0JBQTRCO0FBRTVCLDRDQUEwQztBQUMxQyxrQ0FBdUM7QUFDdkMseUNBQWdEO0FBQ2hELDZEQUEwRTtBQUMxRSxnQ0FBNEU7QUFFNUU7O0dBRUc7QUFDVSxRQUFBLFlBQVksR0FBRyxJQUFBLHNCQUFVLEVBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQXNDekQ7Ozs7O0dBS0c7QUFDSCxNQUFhLFFBQVMsU0FBUSxjQUFRO0lBY3BDLFlBQ0UsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLE9BQXlCLEVBQ3pCLFFBQXVCLEVBQUU7UUFFekIsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzVCLE9BQU8sY0FBUSxDQUFDLGVBQWUsQ0FBQyxvQkFBWSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzNFLENBQUM7UUFFRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBckJGLFNBQUksR0FBMkIsRUFBRSxDQUFDO1FBdUJqRCxVQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUM7UUFDakMsVUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLEdBQUcseUJBQXlCLENBQUM7UUFFdEQsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQzNELElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2xDLENBQUM7UUFFRCxJQUFJLENBQUMsT0FBTyxHQUFH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RztRQUNaLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUMxQixDQUFDOztBQTVHSCw0QkE2R0M7OztBQTRDRDs7O0dBR0c7QUFDSCxJQUFZLHVCQUtYO0FBTEQsV0FBWSx1QkFBdUI7SUFDakMsd0JBQXdCO0lBQ3hCLDRDQUFpQixDQUFBO0lBQ2pCLDZCQUE2QjtJQUM3Qix1REFBNEIsQ0FBQTtBQUM5QixDQUFDLEVBTFcsdUJBQXVCLHVDQUF2Qix1QkFBdUIsUUFLbEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBta2RpclN5bmMsIHdyaXRlRmlsZVN5bmMgfSBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IGpvaW4gfSBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IGZxbkZvclR5cGUgfSBmcm9tIFwiLi4vY29uc3RhbnRzXCI7XG5pbXBvcnQgeyBBcHAsIExpZnRpbmcgfSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgSU5GTElHSFRfU1lNQk9MIH0gZnJvbSBcIi4uL2NvcmUvdHlwZXNcIjtcbmltcG9ydCB7IENhc2VDb252ZW50aW9ucywgUmVzb3VyY2VOYW1lcyB9IGZyb20gXCIuLi9zaGFyZWQvcmVzb3VyY2UtbmFtZXNcIjtcbmltcG9ydCB7IER1cmF0aW9uLCBJSW5mbGlnaHQsIElJbmZsaWdodEhvc3QsIE5vZGUsIFJlc291cmNlIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG4vKipcbiAqIEdsb2JhbCBpZGVudGlmaWVyIGZvciBgRnVuY3Rpb25gLlxuICovXG5leHBvcnQgY29uc3QgRlVOQ1RJT05fRlFOID0gZnFuRm9yVHlwZShcImNsb3VkLkZ1bmN0aW9uXCIpO1xuXG4vKipcbiAqIE9wdGlvbnMgZm9yIGBGdW5jdGlvbmAuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRnVuY3Rpb25Qcm9wcyB7XG4gIC8qKlxuICAgKiBFbnZpcm9ubWVudCB2YXJpYWJsZXMgdG8gcGFzcyB0byB0aGUgZnVuY3Rpb24uXG4gICAqIEBkZWZhdWx0IC0gTm8gZW52aXJvbm1lbnQgdmFyaWFibGVzLlxuICAgKi9cbiAgcmVhZG9ubHkgZW52PzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcblxuICAvKipcbiAgICogVGhlIG1heGltdW0gYW1vdW50IG9mIHRpbWUgdGhlIGZ1bmN0aW9uIGNhbiBydW4uXG4gICAqIEBkZWZhdWx0IDFtXG4gICAqL1xuICByZWFkb25seSB0aW1lb3V0PzogRHVyYXRpb247XG5cbiAgLyoqXG4gICAqIFRoZSBhbW91bnQgb2YgbWVtb3J5IHRvIGFsbG9jYXRlIHRvIHRoZSBmdW5jdGlvbiwgaW4gTUIuXG4gICAqIEBkZWZhdWx0IDEwMjRcbiAgICovXG4gIHJlYWRvbmx5IG1lbW9yeT86IG51bWJlcjtcblxuICAvKipcbiAgICogU3BlY2lmaWVzIHRoZSBudW1iZXIgb2YgZGF5cyB0aGF0IGZ1bmN0aW9uIGxvZ3Mgd2lsbCBiZSBrZXB0LlxuICAgKiBTZXR0aW5nIG5lZ2F0aXZlIHZhbHVlIG1lYW5zIGxvZ3Mgd2lsbCBub3QgZXhwaXJlLlxuICAgKiBAZGVmYXVsdCAzMFxuICAgKi9cbiAgcmVhZG9ubHkgbG9nUmV0ZW50aW9uRGF5cz86IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIG1heGltdW0gY29uY3VycmVudCBpbnZvY2F0aW9ucyB0aGF0IGNhbiBydW4gYXQgb25lIHRpbWUuXG4gICAqIEBkZWZhdWx0IC0gcGxhdGZvcm0gc3BlY2lmaWMgbGltaXRzICgxMDAgb24gdGhlIHNpbXVsYXRvcilcbiAgICovXG4gIHJlYWRvbmx5IGNvbmN1cnJlbmN5PzogbnVtYmVyO1xufVxuXG4vKipcbiAqIEEgZnVuY3Rpb24uXG4gKlxuICogQGluZmxpZ2h0IGBAd2luZ2xhbmcvc2RrLmNsb3VkLklGdW5jdGlvbkNsaWVudGBcbiAqIEBhYnN0cmFjdFxuICovXG5leHBvcnQgY2xhc3MgRnVuY3Rpb24gZXh0ZW5kcyBSZXNvdXJjZSBpbXBsZW1lbnRzIElJbmZsaWdodEhvc3Qge1xuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyBbSU5GTElHSFRfU1lNQk9MXT86IElGdW5jdGlvbkNsaWVudDtcbiAgcHJpdmF0ZSByZWFkb25seSBfZW52OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gIC8qKlxuICAgKiBSZWZlcmVuY2UgdG8gdGhlIGZ1bmN0aW9uIGhhbmRsZXIgLSBhbiBpbmZsaWdodCBjbG9zdXJlLlxuICAgKi9cbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGhhbmRsZXIhOiBJRnVuY3Rpb25IYW5kbGVyO1xuXG4gIC8qKlxuICAgKiBUaGUgcGF0aCB3aGVyZSB0aGUgZW50cnlwb2ludCBvZiB0aGUgZnVuY3Rpb24gc291cmNlIGNvZGUgd2lsbCBiZSBldmVudHVhbGx5IHdyaXR0ZW4gdG8uXG4gICAqL1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgZW50cnlwb2ludCE6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgaGFuZGxlcjogSUZ1bmN0aW9uSGFuZGxlcixcbiAgICBwcm9wczogRnVuY3Rpb25Qcm9wcyA9IHt9XG4gICkge1xuICAgIGlmIChuZXcudGFyZ2V0ID09PSBGdW5jdGlvbikge1xuICAgICAgcmV0dXJuIFJlc291cmNlLl9uZXdGcm9tRmFjdG9yeShGVU5DVElPTl9GUU4sIHNjb3BlLCBpZCwgaGFuZGxlciwgcHJvcHMpO1xuICAgIH1cblxuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBOb2RlLm9mKHRoaXMpLnRpdGxlID0gXCJGdW5jdGlvblwiO1xuICAgIE5vZGUub2YodGhpcykuZGVzY3JpcHRpb24gPSBcIkEgY2xvdWQgZnVuY3Rpb24gKEZhYVMpXCI7XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhwcm9wcy5lbnYgPz8ge30pKSB7XG4gICAgICB0aGlzLmFkZEVudmlyb25tZW50KGtleSwgdmFsdWUpO1xuICAgIH1cblxuICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXI7XG4gICAgY29uc3QgYXNzZXROYW1lID0gUmVzb3VyY2VOYW1lcy5nZW5lcmF0ZU5hbWUodGhpcywge1xuICAgICAgLy8gQXZvaWQgY2hhcmFjdGVycyB0aGF0IG1heSBjYXVzZSBwYXRoIGlzc3Vlc1xuICAgICAgZGlzYWxsb3dlZFJlZ2V4OiAvWz48OlwiL1xcXFx8PypcXHNdL2csXG4gICAgICBjYXNlOiBDYXNlQ29udmVudGlvbnMuTE9XRVJDQVNFLFxuICAgICAgc2VwOiBcIl9cIixcbiAgICB9KTtcblxuICAgIGNvbnN0IHdvcmtkaXIgPSBBcHAub2YodGhpcykud29ya2RpcjtcbiAgICBta2RpclN5bmMod29ya2RpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgY29uc3QgZW50cnlwb2ludCA9IGpvaW4od29ya2RpciwgYCR7YXNzZXROYW1lfS5janNgKTtcbiAgICB0aGlzLmVudHJ5cG9pbnQgPSBlbnRyeXBvaW50O1xuXG4gICAgaWYgKHByb2Nlc3MuZW52LldJTkdfVEFSR0VUKSB7XG4gICAgICB0aGlzLmFkZEVudmlyb25tZW50KFwiV0lOR19UQVJHRVRcIiwgcHJvY2Vzcy5lbnYuV0lOR19UQVJHRVQpO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5jb25jdXJyZW5jeSAhPT0gdW5kZWZpbmVkICYmIHByb3BzLmNvbmN1cnJlbmN5IDw9IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJjb25jdXJyZW5jeSBvcHRpb24gb24gY2xvdWQuRnVuY3Rpb24gbXVzdCBiZSBhIHBvc2l0aXZlIGludGVnZXJcIlxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyBfcHJlU3ludGhlc2l6ZSgpOiB2b2lkIHtcbiAgICBzdXBlci5fcHJlU3ludGhlc2l6ZSgpO1xuXG4gICAgLy8gd3JpdGUgdGhlIGVudHJ5cG9pbnQgbmV4dCB0byB0aGUgcGFydGlhbCBpbmZsaWdodCBjb2RlIGVtaXR0ZWQgYnkgdGhlIGNvbXBpbGVyLFxuICAgIC8vIHNvIHRoYXQgYHJlcXVpcmVgIHJlc29sdmVzIG5hdHVyYWxseS5cbiAgICBjb25zdCBsaW5lcyA9IHRoaXMuX2dldENvZGVMaW5lcyh0aGlzLmhhbmRsZXIpO1xuICAgIHdyaXRlRmlsZVN5bmModGhpcy5lbnRyeXBvaW50LCBsaW5lcy5qb2luKFwiXFxuXCIpKTtcblxuICAgIC8vIGluZGljYXRlcyB0aGF0IHdlIGFyZSBjYWxsaW5nIHRoZSBpbmZsaWdodCBjb25zdHJ1Y3RvciBhbmQgdGhlXG4gICAgLy8gaW5mbGlnaHQgXCJoYW5kbGVcIiBtZXRob2Qgb24gdGhlIGhhbmRsZXIgcmVzb3VyY2UuXG4gICAgTGlmdGluZy5saWZ0KHRoaXMuaGFuZGxlciwgdGhpcywgW1wiaGFuZGxlXCJdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW50ZXJuYWxcbiAgICogQHBhcmFtIGhhbmRsZXIgSUZ1bmN0aW9uSGFuZGxlclxuICAgKiBAcmV0dXJucyB0aGUgZnVuY3Rpb24gY29kZSBsaW5lcyBhcyBzdHJpbmdzXG4gICAqL1xuICBwcm90ZWN0ZWQgX2dldENvZGVMaW5lcyhoYW5kbGVyOiBJRnVuY3Rpb25IYW5kbGVyKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGluZmxpZ2h0Q2xpZW50ID0gaGFuZGxlci5fdG9JbmZsaWdodCgpO1xuICAgIGNvbnN0IGxpbmVzID0gbmV3IEFycmF5PHN0cmluZz4oKTtcbiAgICBjb25zdCBjbGllbnQgPSBcIiRoYW5kbGVyXCI7XG5cbiAgICBsaW5lcy5wdXNoKCdcInVzZSBzdHJpY3RcIjsnKTtcbiAgICBsaW5lcy5wdXNoKGB2YXIgJHtjbGllbnR9ID0gdW5kZWZpbmVkO2ApO1xuICAgIGxpbmVzLnB1c2goXCJleHBvcnRzLmhhbmRsZXIgPSBhc3luYyBmdW5jdGlvbihldmVudCkge1wiKTtcbiAgICBsaW5lcy5wdXNoKGAgICR7Y2xpZW50fSA9ICR7Y2xpZW50fSA/PyAoJHtpbmZsaWdodENsaWVudH0pO2ApO1xuICAgIGxpbmVzLnB1c2goYCAgcmV0dXJuIGF3YWl0ICR7Y2xpZW50fS5oYW5kbGUoZXZlbnQpO2ApO1xuICAgIGxpbmVzLnB1c2goXCJ9O1wiKTtcblxuICAgIHJldHVybiBsaW5lcztcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUgdG8gdGhlIGZ1bmN0aW9uLlxuICAgKi9cbiAgcHVibGljIGFkZEVudmlyb25tZW50KG5hbWU6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xuICAgIGlmICh0aGlzLl9lbnZbbmFtZV0gIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9lbnZbbmFtZV0gIT09IHZhbHVlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBFbnZpcm9ubWVudCB2YXJpYWJsZSBcIiR7bmFtZX1cIiBhbHJlYWR5IHNldCB3aXRoIGEgZGlmZmVyZW50IHZhbHVlLmBcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMuX2VudltuYW1lXSA9IHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHNldCBvZiBlbnZpcm9ubWVudCB2YXJpYWJsZXMgZm9yIHRoaXMgZnVuY3Rpb24uXG4gICAqL1xuICBwdWJsaWMgZ2V0IGVudigpOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICByZXR1cm4geyAuLi50aGlzLl9lbnYgfTtcbiAgfVxufVxuXG4vKipcbiAqIEluZmxpZ2h0IGludGVyZmFjZSBmb3IgYEZ1bmN0aW9uYC5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJRnVuY3Rpb25DbGllbnQge1xuICAvKipcbiAgICogSW52b2tlcyB0aGUgZnVuY3Rpb24gd2l0aCBhIHBheWxvYWQgYW5kIHdhaXRzIGZvciB0aGUgcmVzdWx0LlxuICAgKiBAcGFyYW0gcGF5bG9hZCBwYXlsb2FkIHRvIHBhc3MgdG8gdGhlIGZ1bmN0aW9uLiBJZiBub3QgZGVmaW5lZCwgYW4gZW1wdHkgc3RyaW5nIHdpbGwgYmUgcGFzc2VkLlxuICAgKiBAcmV0dXJucyBBbiBvcHRpb25hbCByZXNwb25zZSBmcm9tIHRoZSBmdW5jdGlvblxuICAgKiBAaW5mbGlnaHRcbiAgICovXG4gIGludm9rZShwYXlsb2FkPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+O1xuXG4gIC8qKlxuICAgKiBLaWNrcyBvZmYgdGhlIGV4ZWN1dGlvbiBvZiB0aGUgZnVuY3Rpb24gd2l0aCBhIHBheWxvYWQgYW5kIHJldHVybnMgaW1tZWRpYXRlbHkgd2hpbGUgdGhlIGZ1bmN0aW9uIGlzIHJ1bm5pbmcuXG4gICAqIEBwYXJhbSBwYXlsb2FkIHBheWxvYWQgdG8gcGFzcyB0byB0aGUgZnVuY3Rpb24uIElmIG5vdCBkZWZpbmVkLCBhbiBlbXB0eSBzdHJpbmcgd2lsbCBiZSBwYXNzZWQuXG4gICAqIEBpbmZsaWdodFxuICAgKi9cbiAgaW52b2tlQXN5bmMocGF5bG9hZD86IHN0cmluZyk6IFByb21pc2U8dm9pZD47XG59XG5cbi8qKlxuICogQSByZXNvdXJjZSB3aXRoIGFuIGluZmxpZ2h0IFwiaGFuZGxlXCIgbWV0aG9kIHRoYXQgY2FuIGJlIHVzZWQgdG9cbiAqIGNyZWF0ZSBhIGBjbG91ZC5GdW5jdGlvbmAuXG4gKlxuICogQGluZmxpZ2h0IGBAd2luZ2xhbmcvc2RrLmNsb3VkLklGdW5jdGlvbkhhbmRsZXJDbGllbnRgXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUZ1bmN0aW9uSGFuZGxlciBleHRlbmRzIElJbmZsaWdodCB7XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgW0lORkxJR0hUX1NZTUJPTF0/OiBJRnVuY3Rpb25IYW5kbGVyQ2xpZW50W1wiaGFuZGxlXCJdO1xufVxuXG4vKipcbiAqIEluZmxpZ2h0IGNsaWVudCBmb3IgYElGdW5jdGlvbkhhbmRsZXJgLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIElGdW5jdGlvbkhhbmRsZXJDbGllbnQge1xuICAvKipcbiAgICogRW50cnlwb2ludCBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIGNsb3VkIGZ1bmN0aW9uIGlzIGludm9rZWQuXG4gICAqIEBpbmZsaWdodFxuICAgKi9cbiAgaGFuZGxlKGV2ZW50Pzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+O1xufVxuXG4vKipcbiAqIExpc3Qgb2YgaW5mbGlnaHQgb3BlcmF0aW9ucyBhdmFpbGFibGUgZm9yIGBGdW5jdGlvbmAuXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGVudW0gRnVuY3Rpb25JbmZsaWdodE1ldGhvZHMge1xuICAvKiogYEZ1bmN0aW9uLmludm9rZWAgKi9cbiAgSU5WT0tFID0gXCJpbnZva2VcIixcbiAgLyoqIGBGdW5jdGlvbi5pbnZva2VBc3luY2AgKi9cbiAgSU5WT0tFX0FTWU5DID0gXCJpbnZva2VBc3luY1wiLFxufVxuIl19