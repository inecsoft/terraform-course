"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CdktfApp = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const cdktf = __importStar(require("cdktf"));
const safe_stable_stringify_1 = __importDefault(require("safe-stable-stringify"));
const tokens_1 = require("./tokens");
const core_1 = require("../core");
const tokens_2 = require("../core/tokens");
const tree_1 = require("../core/tree");
const TERRAFORM_STACK_NAME = "root";
/**
 * An app that knows how to synthesize constructs into Terraform configuration
 * using cdktf. No polycon factory or Terraform providers are included.
 */
class CdktfApp extends core_1.App {
    constructor(props) {
        const outdir = props.outdir ?? ".";
        const cdktfOutdir = (0, path_1.join)(outdir, ".tmp.cdktf.out");
        (0, fs_1.mkdirSync)(cdktfOutdir, { recursive: true });
        const cdktfApp = new cdktf.App({ outdir: cdktfOutdir });
        const cdktfStack = new cdktf.TerraformStack(cdktfApp, TERRAFORM_STACK_NAME);
        super(cdktfStack, props.rootId ?? "Default", props);
        // TODO: allow the user to specify custom backends
        // https://github.com/winglang/wing/issues/2003
        new cdktf.LocalBackend(cdktfStack, {
            path: "./terraform.tfstate",
        });
        this.outdir = outdir;
        (0, tokens_2.registerTokenResolver)(new tokens_1.CdkTfTokens());
        this._synthHooks = props.synthHooks;
        // HACK: monkey patch the `new` method on the cdktf app (which is the root of the tree) so that
        // we can intercept the creation of resources and replace them with our own.
        cdktfApp.new = (fqn, ctor, scope, id, ...args) => this.new(fqn, ctor, scope, id, ...args);
        cdktfApp.newAbstract = (fqn, scope, id, ...args) => this.newAbstract(fqn, scope, id, ...args);
        cdktfApp.typeForFqn = (fqn) => this.typeForFqn(fqn);
        this.outdir = outdir;
        this.cdktfApp = cdktfApp;
        this.cdktfStack = cdktfStack;
        this.terraformManifestPath = (0, path_1.join)(this.outdir, "main.tf.json");
        this.synthed = false;
    }
    /**
     * Synthesize the app into Terraform configuration in a `cdktf.out` directory.
     *
     * This method returns a cleaned snapshot of the resulting Terraform manifest
     * for unit testing.
     */
    synth() {
        if (this.synthed) {
            return this.synthedOutput;
        }
        // call preSynthesize() on every construct in the tree
        (0, core_1.preSynthesizeAllConstructs)(this);
        if (this._synthHooks?.preSynthesize) {
            this._synthHooks.preSynthesize.forEach((hook) => hook(this));
        }
        // synthesize Terraform files in `outdir/.tmp.cdktf.out/stacks/root`
        this.cdktfApp.synth();
        // move Terraform files from `outdir/.tmp.cdktf.out/stacks/root` to `outdir`
        this.moveCdktfArtifactsToOutdir();
        // rename `outdir/cdk.tf.json` to `outdir/main.tf.json`
        (0, fs_1.renameSync)((0, path_1.join)(this.outdir, "cdk.tf.json"), (0, path_1.join)(this.outdir, `main.tf.json`));
        // delete `outdir/.tmp.cdktf.out`
        (0, fs_1.rmSync)(this.cdktfApp.outdir, { recursive: true, force: true });
        // write `outdir/tree.json`
        (0, tree_1.synthesizeTree)(this, this.outdir);
        // write `outdir/connections.json`
        core_1.Connections.of(this).synth(this.outdir);
        // return a cleaned snapshot of the resulting Terraform manifest for unit testing
        const tfConfig = this.cdktfStack.toTerraform();
        const cleaned = cleanTerraformConfig(tfConfig);
        if (this._synthHooks?.postSynthesize) {
            this._synthHooks.postSynthesize.forEach((hook) => {
                (0, fs_1.writeFileSync)((0, path_1.resolve)(`${this.outdir}/main.tf.json`), JSON.stringify(hook(tfConfig), null, 2));
            });
        }
        if (this._synthHooks?.validate) {
            this._synthHooks.validate.forEach((hook) => hook(tfConfig));
        }
        this.synthed = true;
        this.synthedOutput = (0, safe_stable_stringify_1.default)(cleaned, null, 2) ?? "";
        return this.synthedOutput;
    }
    /**
     * Move files from `outdir/cdktf.out/stacks/root` to `outdir`.
     */
    moveCdktfArtifactsToOutdir() {
        const directoriesToMove = ["assets"];
        const cdktfOutdir = this.cdktfApp.outdir;
        const cdktfStackDir = (0, path_1.join)(cdktfOutdir, this.cdktfApp.manifest.stacks[TERRAFORM_STACK_NAME].workingDirectory);
        const files = (0, fs_1.readdirSync)(cdktfStackDir, { withFileTypes: true });
        for (const file of files) {
            if (file.isFile() || directoriesToMove.includes(file.name)) {
                const source = (0, path_1.join)(cdktfStackDir, file.name);
                const destination = (0, path_1.join)(this.outdir, file.name);
                // If the file is a directory we need to delete contents of previous synthesis
                // or rename will fail
                if ((0, fs_1.existsSync)(destination)) {
                    (0, fs_1.rmSync)(destination, { recursive: true });
                }
                (0, fs_1.renameSync)(source, destination);
            }
        }
    }
}
exports.CdktfApp = CdktfApp;
/**
 * Return a cleaned Terraform template for unit testing
 * https://github.com/hashicorp/terraform-cdk/blob/55009f99f7503e5de2bacb1766ab51547821e6be/packages/cdktf/lib/testing/index.ts#L109
 */
function cleanTerraformConfig(template) {
    function removeMetadata(item) {
        if (item !== null && typeof item === "object") {
            if (Array.isArray(item)) {
                return item.map(removeMetadata);
            }
            const cleanedItem = Object.entries(item)
                // order alphabetically
                .sort(([a], [b]) => a.localeCompare(b))
                .reduce((acc, [key, value]) => ({
                ...acc,
                [key]: removeMetadata(value),
            }), {});
            // Remove metadata
            delete cleanedItem["//"];
            return cleanedItem;
        }
        return item;
    }
    const cleaned = removeMetadata(template);
    cleaned.terraform = undefined;
    cleaned.provider = undefined;
    return cleaned;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NoYXJlZC10Zi9hcHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQkFPWTtBQUNaLCtCQUFxQztBQUNyQyw2Q0FBK0I7QUFFL0Isa0ZBQThDO0FBQzlDLHFDQUF1QztBQUN2QyxrQ0FLaUI7QUFDakIsMkNBQXVEO0FBQ3ZELHVDQUE4QztBQUU5QyxNQUFNLG9CQUFvQixHQUFHLE1BQU0sQ0FBQztBQUVwQzs7O0dBR0c7QUFDSCxNQUFzQixRQUFTLFNBQVEsVUFBRztJQWF4QyxZQUFZLEtBQWU7UUFDekIsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUM7UUFDbkMsTUFBTSxXQUFXLEdBQUcsSUFBQSxXQUFJLEVBQUMsTUFBTSxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFFbkQsSUFBQSxjQUFTLEVBQUMsV0FBVyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFFNUMsTUFBTSxRQUFRLEdBQUcsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDeEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO1FBRTVFLEtBQUssQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLE1BQU0sSUFBSSxTQUFTLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFcEQsa0RBQWtEO1FBQ2xELCtDQUErQztRQUMvQyxJQUFJLEtBQUssQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFO1lBQ2pDLElBQUksRUFBRSxxQkFBcUI7U0FDNUIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBQSw4QkFBcUIsRUFBQyxJQUFJ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LENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUN0QixHQUFHLEdBQUc7Z0JBQ04sQ0FBQyxHQUFHLENBQUMsRUFBRSxjQUFjLENBQUMsS0FBSyxDQUFDO2FBQzdCLENBQUMsRUFDRixFQUFFLENBQ0gsQ0FBQztZQUVKLGtCQUFrQjtZQUNsQixPQUFRLFdBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEMsT0FBTyxXQUFXLENBQUM7UUFDckIsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUNELE1BQU0sT0FBTyxHQUFHLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN6QyxPQUFPLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztJQUM5QixPQUFPLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQztJQUM3QixPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgbWtkaXJTeW5jLFxuICByZWFkZGlyU3luYyxcbiAgcmVuYW1lU3luYyxcbiAgcm1TeW5jLFxuICBleGlzdHNTeW5jLFxuICB3cml0ZUZpbGVTeW5jLFxufSBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IGpvaW4sIHJlc29sdmUgfSBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgY2RrdGYgZnJvbSBcImNka3RmXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHN0cmluZ2lmeSBmcm9tIFwic2FmZS1zdGFibGUtc3RyaW5naWZ5XCI7XG5pbXBvcnQgeyBDZGtUZlRva2VucyB9IGZyb20gXCIuL3Rva2Vuc1wiO1xuaW1wb3J0IHtcbiAgQXBwLFxuICBBcHBQcm9wcyxcbiAgQ29ubmVjdGlvbnMsXG4gIHByZVN5bnRoZXNpemVBbGxDb25zdHJ1Y3RzLFxufSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgcmVnaXN0ZXJUb2tlblJlc29sdmVyIH0gZnJvbSBcIi4uL2NvcmUvdG9rZW5zXCI7XG5pbXBvcnQgeyBzeW50aGVzaXplVHJlZSB9IGZyb20gXCIuLi9jb3JlL3RyZWVcIjtcblxuY29uc3QgVEVSUkFGT1JNX1NUQUNLX05BTUUgPSBcInJvb3RcIjtcblxuLyoqXG4gKiBBbiBhcHAgdGhhdCBrbm93cyBob3cgdG8gc3ludGhlc2l6ZSBjb25zdHJ1Y3RzIGludG8gVGVycmFmb3JtIGNvbmZpZ3VyYXRpb25cbiAqIHVzaW5nIGNka3RmLiBObyBwb2x5Y29uIGZhY3Rvcnkgb3IgVGVycmFmb3JtIHByb3ZpZGVycyBhcmUgaW5jbHVkZWQuXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBDZGt0ZkFwcCBleHRlbmRzIEFwcCB7XG4gIC8qKlxuICAgKiBQYXRoIHRvIHRoZSBUZXJyYWZvcm0gbWFuaWZlc3QgZmlsZS5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSB0ZXJyYWZvcm1NYW5pZmVzdFBhdGg6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IG91dGRpcjogc3RyaW5nO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgY2RrdGZBcHA6IGNka3RmLkFwcDtcbiAgcHJpdmF0ZSByZWFkb25seSBjZGt0ZlN0YWNrOiBjZGt0Zi5UZXJyYWZvcm1TdGFjaztcblxuICBwcml2YXRlIHN5bnRoZWQ6IGJvb2xlYW47XG4gIHByaXZhdGUgc3ludGhlZE91dHB1dDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBBcHBQcm9wcykge1xuICAgIGNvbnN0IG91dGRpciA9IHByb3BzLm91dGRpciA/PyBcIi5cIjtcbiAgICBjb25zdCBjZGt0Zk91dGRpciA9IGpvaW4ob3V0ZGlyLCBcIi50bXAuY2RrdGYub3V0XCIpO1xuXG4gICAgbWtkaXJTeW5jKGNka3RmT3V0ZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcblxuICAgIGNvbnN0IGNka3RmQXBwID0gbmV3IGNka3RmLkFwcCh7IG91dGRpcjogY2RrdGZPdXRkaXIgfSk7XG4gICAgY29uc3QgY2RrdGZTdGFjayA9IG5ldyBjZGt0Zi5UZXJyYWZvcm1TdGFjayhjZGt0ZkFwcCwgVEVSUkFGT1JNX1NUQUNLX05BTUUpO1xuXG4gICAgc3VwZXIoY2RrdGZTdGFjaywgcHJvcHMucm9vdElkID8/IFwiRGVmYXVsdFwiLCBwcm9wcyk7XG5cbiAgICAvLyBUT0RPOiBhbGxvdyB0aGUgdXNlciB0byBzcGVjaWZ5IGN1c3RvbSBiYWNrZW5kc1xuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS93aW5nbGFuZy93aW5nL2lzc3Vlcy8yMDAzXG4gICAgbmV3IGNka3RmLkxvY2FsQmFja2VuZChjZGt0ZlN0YWNrLCB7XG4gICAgICBwYXRoOiBcIi4vdGVycmFmb3JtLnRmc3RhdGVcIixcbiAgICB9KTtcblxuICAgIHRoaXMub3V0ZGlyID0gb3V0ZGlyO1xuICAgIHJlZ2lzdGVyVG9rZW5SZXNvbHZlcihuZXcgQ2RrVGZUb2tlbnMoKSk7XG4gICAgdGhpcy5fc3ludGhIb29rcyA9IHByb3BzLnN5bnRoSG9va3M7XG5cbiAgICAvLyBIQUNLOiBtb25rZXkgcGF0Y2ggdGhlIGBuZXdgIG1ldGhvZCBvbiB0aGUgY2RrdGYgYXBwICh3aGljaCBpcyB0aGUgcm9vdCBvZiB0aGUgdHJlZSkgc28gdGhhdFxuICAgIC8vIHdlIGNhbiBpbnRlcmNlcHQgdGhlIGNyZWF0aW9uIG9mIHJlc291cmNlcyBhbmQgcmVwbGFjZSB0aGVtIHdpdGggb3VyIG93bi5cbiAgICAoY2RrdGZBcHAgYXMgYW55KS5uZXcgPSAoXG4gICAgICBmcW46IHN0cmluZyxcbiAgICAgIGN0b3I6IGFueSxcbiAgICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgICBpZDogc3RyaW5nLFxuICAgICAgLi4uYXJnczogYW55W11cbiAgICApID0+IHRoaXMubmV3KGZxbiwgY3Rvciwgc2NvcGUsIGlkLCAuLi5hcmdzKTtcblxuICAgIChjZGt0ZkFwcCBhcyBhbnkpLm5ld0Fic3RyYWN0ID0gKFxuICAgICAgZnFuOiBzdHJpbmcsXG4gICAgICBzY29wZTogQ29uc3RydWN0LFxuICAgICAgaWQ6IHN0cmluZyxcbiAgICAgIC4uLmFyZ3M6IGFueVtdXG4gICAgKSA9PiB0aGlzLm5ld0Fic3RyYWN0KGZxbiwgc2NvcGUsIGlkLCAuLi5hcmdzKTtcblxuICAgIChjZGt0ZkFwcCBhcyBhbnkpLnR5cGVGb3JGcW4gPSAoZnFuOiBzdHJpbmcpID0+IHRoaXMudHlwZUZvckZxbihmcW4pO1xuXG4gICAgdGhpcy5vdXRkaXIgPSBvdXRkaXI7XG4gICAgdGhpcy5jZGt0ZkFwcCA9IGNka3RmQXBwO1xuICAgIHRoaXMuY2RrdGZTdGFjayA9IGNka3RmU3RhY2s7XG4gICAgdGhpcy50ZXJyYWZvcm1NYW5pZmVzdFBhdGggPSBqb2luKHRoaXMub3V0ZGlyLCBcIm1haW4udGYuanNvblwiKTtcbiAgICB0aGlzLnN5bnRoZWQgPSBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTeW50aGVzaXplIHRoZSBhcHAgaW50byBUZXJyYWZvcm0gY29uZmlndXJhdGlvbiBpbiBhIGBjZGt0Zi5vdXRgIGRpcmVjdG9yeS5cbiAgICpcbiAgICogVGhpcyBtZXRob2QgcmV0dXJucyBhIGNsZWFuZWQgc25hcHNob3Qgb2YgdGhlIHJlc3VsdGluZyBUZXJyYWZvcm0gbWFuaWZlc3RcbiAgICogZm9yIHVuaXQgdGVzdGluZy5cbiAgICovXG4gIHB1YmxpYyBzeW50aCgpOiBzdHJpbmcge1xuICAgIGlmICh0aGlzLnN5bnRoZWQpIHtcbiAgICAgIHJldHVybiB0aGlzLnN5bnRoZWRPdXRwdXQhO1xuICAgIH1cblxuICAgIC8vIGNhbGwgcHJlU3ludGhlc2l6ZSgpIG9uIGV2ZXJ5IGNvbnN0cnVjdCBpbiB0aGUgdHJlZVxuICAgIHByZVN5bnRoZXNpemVBbGxDb25zdHJ1Y3RzKHRoaXMpO1xuXG4gICAgaWYgKHRoaXMuX3N5bnRoSG9va3M/LnByZVN5bnRoZXNpemUpIHtcbiAgICAgIHRoaXMuX3N5bnRoSG9va3MucHJlU3ludGhlc2l6ZS5mb3JFYWNoKChob29rKSA9PiBob29rKHRoaXMpKTtcbiAgICB9XG5cbiAgICAvLyBzeW50aGVzaXplIFRlcnJhZm9ybSBmaWxlcyBpbiBgb3V0ZGlyLy50bXAuY2RrdGYub3V0L3N0YWNrcy9yb290YFxuICAgIHRoaXMuY2RrdGZBcHAuc3ludGgoKTtcblxuICAgIC8vIG1vdmUgVGVycmFmb3JtIGZpbGVzIGZyb20gYG91dGRpci8udG1wLmNka3RmLm91dC9zdGFja3Mvcm9vdGAgdG8gYG91dGRpcmBcbiAgICB0aGlzLm1vdmVDZGt0ZkFydGlmYWN0c1RvT3V0ZGlyKCk7XG5cbiAgICAvLyByZW5hbWUgYG91dGRpci9jZGsudGYuanNvbmAgdG8gYG91dGRpci9tYWluLnRmLmpzb25gXG4gICAgcmVuYW1lU3luYyhcbiAgICAgIGpvaW4odGhpcy5vdXRkaXIsIFwiY2RrLnRmLmpzb25cIiksXG4gICAgICBqb2luKHRoaXMub3V0ZGlyLCBgbWFpbi50Zi5qc29uYClcbiAgICApO1xuXG4gICAgLy8gZGVsZXRlIGBvdXRkaXIvLnRtcC5jZGt0Zi5vdXRgXG4gICAgcm1TeW5jKHRoaXMuY2RrdGZBcHAub3V0ZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSwgZm9yY2U6IHRydWUgfSk7XG5cbiAgICAvLyB3cml0ZSBgb3V0ZGlyL3RyZWUuanNvbmBcbiAgICBzeW50aGVzaXplVHJlZSh0aGlzLCB0aGlzLm91dGRpcik7XG5cbiAgICAvLyB3cml0ZSBgb3V0ZGlyL2Nvbm5lY3Rpb25zLmpzb25gXG4gICAgQ29ubmVjdGlvbnMub2YodGhpcykuc3ludGgodGhpcy5vdXRkaXIpO1xuXG4gICAgLy8gcmV0dXJuIGEgY2xlYW5lZCBzbmFwc2hvdCBvZiB0aGUgcmVzdWx0aW5nIFRlcnJhZm9ybSBtYW5pZmVzdCBmb3IgdW5pdCB0ZXN0aW5nXG4gICAgY29uc3QgdGZDb25maWcgPSB0aGlzLmNka3RmU3RhY2sudG9UZXJyYWZvcm0oKTtcbiAgICBjb25zdCBjbGVhbmVkID0gY2xlYW5UZXJyYWZvcm1Db25maWcodGZDb25maWcpO1xuXG4gICAgaWYgKHRoaXMuX3N5bnRoSG9va3M/LnBvc3RTeW50aGVzaXplKSB7XG4gICAgICB0aGlzLl9zeW50aEhvb2tzLnBvc3RTeW50aGVzaXplLmZvckVhY2goKGhvb2spID0+IHtcbiAgICAgICAgd3JpdGVGaWxlU3luYyhcbiAgICAgICAgICByZXNvbHZlKGAke3RoaXMub3V0ZGlyfS9tYWluLnRmLmpzb25gKSxcbiAgICAgICAgICBKU09OLnN0cmluZ2lmeShob29rKHRmQ29uZmlnKSwgbnVsbCwgMilcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLl9zeW50aEhvb2tzPy52YWxpZGF0ZSkge1xuICAgICAgdGhpcy5fc3ludGhIb29rcy52YWxpZGF0ZS5mb3JFYWNoKChob29rKSA9PiBob29rKHRmQ29uZmlnKSk7XG4gICAgfVxuXG4gICAgdGhpcy5zeW50aGVkID0gdHJ1ZTtcbiAgICB0aGlzLnN5bnRoZWRPdXRwdXQgPSBzdHJpbmdpZnkoY2xlYW5lZCwgbnVsbCwgMikgPz8gXCJcIjtcblxuICAgIHJldHVybiB0aGlzLnN5bnRoZWRPdXRwdXQ7XG4gIH1cblxuICAvKipcbiAgICogTW92ZSBmaWxlcyBmcm9tIGBvdXRkaXIvY2RrdGYub3V0L3N0YWNrcy9yb290YCB0byBgb3V0ZGlyYC5cbiAgICovXG4gIHByaXZhdGUgbW92ZUNka3RmQXJ0aWZhY3RzVG9PdXRkaXIoKTogdm9pZCB7XG4gICAgY29uc3QgZGlyZWN0b3JpZXNUb01vdmUgPSBbXCJhc3NldHNcIl07XG4gICAgY29uc3QgY2RrdGZPdXRkaXIgPSB0aGlzLmNka3RmQXBwLm91dGRpcjtcbiAgICBjb25zdCBjZGt0ZlN0YWNrRGlyID0gam9pbihcbiAgICAgIGNka3RmT3V0ZGlyLFxuICAgICAgdGhpcy5jZGt0ZkFwcC5tYW5pZmVzdC5zdGFja3NbVEVSUkFGT1JNX1NUQUNLX05BTUVdLndvcmtpbmdEaXJlY3RvcnlcbiAgICApO1xuXG4gICAgY29uc3QgZmlsZXMgPSByZWFkZGlyU3luYyhjZGt0ZlN0YWNrRGlyLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSk7XG5cbiAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgIGlmIChmaWxlLmlzRmlsZSgpIHx8IGRpcmVjdG9yaWVzVG9Nb3ZlLmluY2x1ZGVzKGZpbGUubmFtZSkpIHtcbiAgICAgICAgY29uc3Qgc291cmNlID0gam9pbihjZGt0ZlN0YWNrRGlyLCBmaWxlLm5hbWUpO1xuICAgICAgICBjb25zdCBkZXN0aW5hdGlvbiA9IGpvaW4odGhpcy5vdXRkaXIsIGZpbGUubmFtZSk7XG5cbiAgICAgICAgLy8gSWYgdGhlIGZpbGUgaXMgYSBkaXJlY3Rvcnkgd2UgbmVlZCB0byBkZWxldGUgY29udGVudHMgb2YgcHJldmlvdXMgc3ludGhlc2lzXG4gICAgICAgIC8vIG9yIHJlbmFtZSB3aWxsIGZhaWxcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMoZGVzdGluYXRpb24pKSB7XG4gICAgICAgICAgcm1TeW5jKGRlc3RpbmF0aW9uLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlbmFtZVN5bmMoc291cmNlLCBkZXN0aW5hdGlvbik7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogUmV0dXJuIGEgY2xlYW5lZCBUZXJyYWZvcm0gdGVtcGxhdGUgZm9yIHVuaXQgdGVzdGluZ1xuICogaHR0cHM6Ly9naXRodWIuY29tL2hhc2hpY29ycC90ZXJyYWZvcm0tY2RrL2Jsb2IvNTUwMDlmOTlmNzUwM2U1ZGUyYmFjYjE3NjZhYjUxNTQ3ODIxZTZiZS9wYWNrYWdlcy9jZGt0Zi9saWIvdGVzdGluZy9pbmRleC50cyNMMTA5XG4gKi9cbmZ1bmN0aW9uIGNsZWFuVGVycmFmb3JtQ29uZmlnKHRlbXBsYXRlOiBhbnkpOiBhbnkge1xuICBmdW5jdGlvbiByZW1vdmVNZXRhZGF0YShpdGVtOiBhbnkpOiBhbnkge1xuICAgIGlmIChpdGVtICE9PSBudWxsICYmIHR5cGVvZiBpdGVtID09PSBcIm9iamVjdFwiKSB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShpdGVtKSkge1xuICAgICAgICByZXR1cm4gaXRlbS5tYXAocmVtb3ZlTWV0YWRhdGEpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjbGVhbmVkSXRlbSA9IE9iamVjdC5lbnRyaWVzKGl0ZW0pXG4gICAgICAgIC8vIG9yZGVyIGFscGhhYmV0aWNhbGx5XG4gICAgICAgIC5zb3J0KChbYV0sIFtiXSkgPT4gYS5sb2NhbGVDb21wYXJlKGIpKVxuICAgICAgICAucmVkdWNlKFxuICAgICAgICAgIChhY2MsIFtrZXksIHZhbHVlXSkgPT4gKHtcbiAgICAgICAgICAgIC4uLmFjYyxcbiAgICAgICAgICAgIFtrZXldOiByZW1vdmVNZXRhZGF0YSh2YWx1ZSksXG4gICAgICAgICAgfSksXG4gICAgICAgICAge31cbiAgICAgICAgKTtcblxuICAgICAgLy8gUmVtb3ZlIG1ldGFkYXRhXG4gICAgICBkZWxldGUgKGNsZWFuZWRJdGVtIGFzIGFueSlbXCIvL1wiXTtcbiAgICAgIHJldHVybiBjbGVhbmVkSXRlbTtcbiAgICB9XG5cbiAgICByZXR1cm4gaXRlbTtcbiAgfVxuICBjb25zdCBjbGVhbmVkID0gcmVtb3ZlTWV0YWRhdGEodGVtcGxhdGUpO1xuICBjbGVhbmVkLnRlcnJhZm9ybSA9IHVuZGVmaW5lZDtcbiAgY2xlYW5lZC5wcm92aWRlciA9IHVuZGVmaW5lZDtcbiAgcmV0dXJuIGNsZWFuZWQ7XG59XG4iXX0=