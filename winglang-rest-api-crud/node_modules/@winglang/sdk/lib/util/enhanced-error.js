"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.dedent = exports.rewriteCommonError = exports.prettyPrintError = void 0;
const promises_1 = require("node:fs/promises");
const node_path_1 = require("node:path");
const misc_1 = require("../shared/misc");
/**
 * Pretty print an error, rewrites stack traces with sourcemaps, shows line that caused the error, and add general formatting.
 * This function has some special handling for winglang-based errors, but can be used whether winglang is used or not.
 * @param error An error object or a simple error string. If the string contains a stacktrace, it will be rewritten.
 * @param options Display options
 * @returns a pretty printed error, containing ANSI formatting if color is enabled
 */
async function prettyPrintError(error, options) {
    const StackTracey = await Promise.resolve().then(() => __importStar(require("stacktracey"))).then((m) => m.default);
    const chalk = options?.chalk;
    const fRed = (s) => (chalk ? chalk.red(s) : s);
    const fBold = (s) => (chalk ? chalk.bold(s) : s);
    const fDim = (s) => (chalk ? chalk.dim(s) : s);
    let st;
    let originalMessage = "";
    if (typeof error === "string") {
        if (error === "") {
            return "";
        }
        st = new StackTracey(error);
        if (st.items.length > 0) {
            // we have a stack trace! extract the message (everything before a line that starts with "    at")
            const lines = error.split("\n");
            const idx = lines.findIndex((line) => line.startsWith("    at"));
            if (idx !== -1) {
                originalMessage = lines.slice(0, idx).join("\n");
            }
            else {
                originalMessage = error;
            }
        }
        else {
            originalMessage = error;
        }
        // stringy errors commonly start with "Error: ", we can just remove it
        originalMessage = originalMessage.replace(/^Error: /, "");
    }
    else {
        error = rewriteCommonError(error);
        st = new StackTracey(error.stack);
        originalMessage = error.message;
    }
    const message = fBold(fRed("Error: ")) + fRed(originalMessage);
    st = await st
        .clean()
        .filter((item) => !item.native)
        // strip node internals
        .filter((item) => !item.file.startsWith("node:"))
        // strip wingsdk
        .filter((item) => !(0, misc_1.normalPath)(item.file).includes("/libs/wingsdk/src/") &&
        !(0, misc_1.normalPath)(item.file).includes("/@winglang/sdk/"))
        // special: remove the handler wrapper (See `cloud.Function` entrypoint for where this comes from)
        .filter((item) => !(0, misc_1.normalPath)(item.file).match(/\.wing\/\w+(\.sandbox)?\.cjs$/))
        .withSourcesAsync();
    let traceWithSources = st.items;
    if (traceWithSources.length === 0) {
        return message;
    }
    let interestingRoot = options?.sourceEntrypoint;
    if (interestingRoot !== undefined &&
        (await (0, promises_1.stat)(interestingRoot)
            .then((s) => !s.isDirectory())
            .catch(() => true))) {
        interestingRoot = (0, node_path_1.resolve)(interestingRoot, "..");
    }
    if (interestingRoot !== undefined) {
        interestingRoot = interestingRoot + node_path_1.sep;
    }
    if (interestingRoot !== undefined) {
        traceWithSources = traceWithSources.filter((item) => (item.sourceFile?.path ?? item.file).startsWith(interestingRoot));
        const targetDir = (0, node_path_1.join)(interestingRoot, "target") + node_path_1.sep;
        traceWithSources = traceWithSources.filter((item) => !(item.sourceFile?.path ?? item.file).startsWith(targetDir));
    }
    let output = [];
    // use only the first item with a source
    const firstGoodItem = traceWithSources.find((item) => item.sourceFile !== undefined &&
        item.sourceFile.lines.length > 0 &&
        !item.native &&
        !item.thirdParty);
    if (firstGoodItem) {
        const sourceFile = firstGoodItem.sourceFile;
        const originLines = sourceFile.lines;
        const originLine = firstGoodItem.line ?? 1;
        const originColumn = firstGoodItem.column ?? 1;
        let startLine = Math.max(originLine - 3, 1);
        let finishLine = originLine;
        const maxDigits = finishLine.toString().length;
        // print line and its surrounding lines
        output.push(" ".repeat(maxDigits + 1) +
            `--> ${(0, node_path_1.relative)(process.cwd(), sourceFile.path)}:${originLine}:${originColumn}`);
        let linesOfInterest = originLines;
        if (linesOfInterest.length > 1) {
            linesOfInterest = originLines.slice(startLine - 1, finishLine);
        }
        linesOfInterest.push(" ".repeat(originColumn) + "^");
        linesOfInterest = dedent(linesOfInterest);
        let x = 0;
        for (let i = startLine; i <= finishLine; i++) {
            const interestingLine = i === originLine;
            let lineNumber = interestingLine
                ? `${i} | `
                : " ".repeat(maxDigits) + " | ";
            if (interestingLine) {
                lineNumber = fBold(fRed(lineNumber));
            }
            let lineText = linesOfInterest[x++];
            output.push(lineNumber + lineText);
            if (interestingLine) {
                // last line is the caret
                output.push(" ".repeat(maxDigits) + " |" + fRed(linesOfInterest[x]));
            }
        }
    }
    const outputText = output.length > 0 ? "\n" + output.join("\n") : "";
    const extraStack = traceWithSources.length > 0
        ? "\n" + fDim(traceWithSources.map(printItem).join("\n"))
        : "";
    // add the rest of the stack trace from the same file
    return message + outputText + extraStack;
}
exports.prettyPrintError = prettyPrintError;
function printItem(item) {
    let calleeShort = `${item.calleeShort} `;
    // These are typically useless
    // TODO These can possibly be removed when sourcemaps support "names" mappings
    if (item.calleeShort === "$Root" ||
        item.calleeShort === "new $Root" ||
        item.calleeShort.includes("<anonymous>")) {
        calleeShort = "";
    }
    if (item.callee.match(/\$Closure\d+\.handle$/)) {
        // inflight closures use "handle" as a way to represent calling the inflight itself
        calleeShort = "";
    }
    if (item.fileName.endsWith(".w") && calleeShort.startsWith("async ")) {
        // In userland wing traces, async = inflight and is currently redundant to mention
        calleeShort = calleeShort.replace("async ", "");
    }
    const file = item.file;
    const line = item.line;
    const column = item.column;
    return `at ${calleeShort}${file}:${line}:${column}`;
}
function rewriteCommonError(error) {
    if (error.message.startsWith("There is already a Construct with name")) {
        const newMessage = [];
        newMessage.push(error.message);
        newMessage.push("hint: Every preflight object needs a unique identifier within its scope. You can assign one as shown:");
        newMessage.push('> new cloud.Bucket() as "MyBucket";');
        newMessage.push("For more information, see https://www.winglang.io/docs/concepts/application-tree");
        error.message = newMessage.join("\n\n");
    }
    else if (error.constructor.name === "NotImplementedError") {
        error.name = "NotImplementedError";
    }
    return error;
}
exports.rewriteCommonError = rewriteCommonError;
function dedent(lines) {
    // first, replace all tabs with 2 spaces
    lines = lines.map((line) => line.replace(/\t/g, "  "));
    // find the smallest indentation
    let minIndent = Infinity;
    for (const line of lines) {
        const match = line.match(/^ */);
        if (match && match[0].length !== line.length) {
            minIndent = Math.min(minIndent, match[0].length);
        }
    }
    // remove the indentation
    return lines.map((line) => line.substring(minIndent));
}
exports.dedent = dedent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5oYW5jZWQtZXJyb3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbC9lbmhhbmNlZC1lcnJvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLCtDQUF3QztBQUN4Qyx5Q0FBeUQ7QUFHekQseUNBQTRDO0FBZ0I1Qzs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsZ0JBQWdCLENBQ3BDLEtBQXFCLEVBQ3JCLE9BQWlDO0lBRWpDLE1BQU0sV0FBVyxHQUFHLE1BQU0sa0RBQU8sYUFBYSxJQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXZFLE1BQU0sS0FBSyxHQUFHLE9BQU8sRUFBRSxLQUFLLENBQUM7SUFDN0IsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2RCxNQUFNLEtBQUssR0FBRyxDQUFDLENBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFdkQsSUFBSSxFQUEyQixDQUFDO0lBQ2hDLElBQUksZUFBZSxHQUFHLEVBQUUsQ0FBQztJQUN6QixJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQzlCLElBQUksS0FBSyxL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QUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7QUFDeEQsQ0FBQztBQWZELHdCQWVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3RhdCB9IGZyb20gXCJub2RlOmZzL3Byb21pc2VzXCI7XG5pbXBvcnQgeyByZWxhdGl2ZSwgcmVzb2x2ZSwgc2VwLCBqb2luIH0gZnJvbSBcIm5vZGU6cGF0aFwiO1xuaW1wb3J0IHR5cGUgQ2hhbGsgZnJvbSBcImNoYWxrXCI7XG5pbXBvcnQgdHlwZSBTdGFja1RyYWNleSBmcm9tIFwic3RhY2t0cmFjZXlcIjtcbmltcG9ydCB7IG5vcm1hbFBhdGggfSBmcm9tIFwiLi4vc2hhcmVkL21pc2NcIjtcblxuZXhwb3J0IGludGVyZmFjZSBQcmV0dHlQcmludEVycm9yT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBUaGUgc291cmNlIGVudHJ5cG9pbnQuIElmIHByb3ZpZGVkLCB0aGUgc3RhY2sgdHJhY2Ugd2lsbCBvbmx5IHNob3cgc291cmNlIGZpbGVzIHRoYXQgYXJlIGluIHRoZSBzYW1lIGRpcmVjdG9yeSBvciBpdHMgc3ViZGlyZWN0b3JpZXMuXG4gICAqIEl0IHdpbGwgYWxzbyBleGNsdWRlIGZpbGVzIGluIGEgYHRhcmdldGAgc3ViZGlyZWN0b3J5LlxuICAgKi9cbiAgc291cmNlRW50cnlwb2ludD86IHN0cmluZztcblxuICAvKipcbiAgICogXCJjaGFsa1wiIGluc3RhbmNlIHRvIGZvcm1hdCBvdXRwdXQuXG4gICAqIElmIHByb3ZpZGVkLCBBTlNJIGNvbG9yIGFuZCBmb3JtYXQgd2lsbCBiZSB1c2VkLlxuICAgKi9cbiAgY2hhbGs/OiB0eXBlb2YgQ2hhbGs7XG59XG5cbi8qKlxuICogUHJldHR5IHByaW50IGFuIGVycm9yLCByZXdyaXRlcyBzdGFjayB0cmFjZXMgd2l0aCBzb3VyY2VtYXBzLCBzaG93cyBsaW5lIHRoYXQgY2F1c2VkIHRoZSBlcnJvciwgYW5kIGFkZCBnZW5lcmFsIGZvcm1hdHRpbmcuXG4gKiBUaGlzIGZ1bmN0aW9uIGhhcyBzb21lIHNwZWNpYWwgaGFuZGxpbmcgZm9yIHdpbmdsYW5nLWJhc2VkIGVycm9ycywgYnV0IGNhbiBiZSB1c2VkIHdoZXRoZXIgd2luZ2xhbmcgaXMgdXNlZCBvciBub3QuXG4gKiBAcGFyYW0gZXJyb3IgQW4gZXJyb3Igb2JqZWN0IG9yIGEgc2ltcGxlIGVycm9yIHN0cmluZy4gSWYgdGhlIHN0cmluZyBjb250YWlucyBhIHN0YWNrdHJhY2UsIGl0IHdpbGwgYmUgcmV3cml0dGVuLlxuICogQHBhcmFtIG9wdGlvbnMgRGlzcGxheSBvcHRpb25zXG4gKiBAcmV0dXJucyBhIHByZXR0eSBwcmludGVkIGVycm9yLCBjb250YWluaW5nIEFOU0kgZm9ybWF0dGluZyBpZiBjb2xvciBpcyBlbmFibGVkXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcmV0dHlQcmludEVycm9yKFxuICBlcnJvcjogRXJyb3IgfCBzdHJpbmcsXG4gIG9wdGlvbnM/OiBQcmV0dHlQcmludEVycm9yT3B0aW9uc1xuKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3QgU3RhY2tUcmFjZXkgPSBhd2FpdCBpbXBvcnQoXCJzdGFja3RyYWNleVwiKS50aGVuKChtKSA9PiBtLmRlZmF1bHQpO1xuXG4gIGNvbnN0IGNoYWxrID0gb3B0aW9ucz8uY2hhbGs7XG4gIGNvbnN0IGZSZWQgPSAoczogc3RyaW5nKSA9PiAoY2hhbGsgPyBjaGFsay5yZWQocykgOiBzKTtcbiAgY29uc3QgZkJvbGQgPSAoczogc3RyaW5nKSA9PiAoY2hhbGsgPyBjaGFsay5ib2xkKHMpIDogcyk7XG4gIGNvbnN0IGZEaW0gPSAoczogc3RyaW5nKSA9PiAoY2hhbGsgPyBjaGFsay5kaW0ocykgOiBzKTtcblxuICBsZXQgc3Q6IFN0YWNrVHJhY2V5IHwgdW5kZWZpbmVkO1xuICBsZXQgb3JpZ2luYWxNZXNzYWdlID0gXCJcIjtcbiAgaWYgKHR5cGVvZiBlcnJvciA9PT0gXCJzdHJpbmdcIikge1xuICAgIGlmIChlcnJvciA9PT0gXCJcIikge1xuICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuICAgIHN0ID0gbmV3IFN0YWNrVHJhY2V5KGVycm9yKTtcbiAgICBpZiAoc3QuaXRlbXMubGVuZ3RoID4gMCkge1xuICAgICAgLy8gd2UgaGF2ZSBhIHN0YWNrIHRyYWNlISBleHRyYWN0IHRoZSBtZXNzYWdlIChldmVyeXRoaW5nIGJlZm9yZSBhIGxpbmUgdGhhdCBzdGFydHMgd2l0aCBcIiAgICBhdFwiKVxuICAgICAgY29uc3QgbGluZXMgPSBlcnJvci5zcGxpdChcIlxcblwiKTtcbiAgICAgIGNvbnN0IGlkeCA9IGxpbmVzLmZpbmRJbmRleCgobGluZSkgPT4gbGluZS5zdGFydHNXaXRoKFwiICAgIGF0XCIpKTtcbiAgICAgIGlmIChpZHggIT09IC0xKSB7XG4gICAgICAgIG9yaWdpbmFsTWVzc2FnZSA9IGxpbmVzLnNsaWNlKDAsIGlkeCkuam9pbihcIlxcblwiKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9yaWdpbmFsTWVzc2FnZSA9IGVycm9yO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBvcmlnaW5hbE1lc3NhZ2UgPSBlcnJvcjtcbiAgICB9XG5cbiAgICAvLyBzdHJpbmd5IGVycm9ycyBjb21tb25seSBzdGFydCB3aXRoIFwiRXJyb3I6IFwiLCB3ZSBjYW4ganVzdCByZW1vdmUgaXRcbiAgICBvcmlnaW5hbE1lc3NhZ2UgPSBvcmlnaW5hbE1lc3NhZ2UucmVwbGFjZSgvXkVycm9yOiAvLCBcIlwiKTtcbiAgfSBlbHNlIHtcbiAgICBlcnJvciA9IHJld3JpdGVDb21tb25FcnJvcihlcnJvcik7XG4gICAgc3QgPSBuZXcgU3RhY2tUcmFjZXkoZXJyb3Iuc3RhY2spO1xuICAgIG9yaWdpbmFsTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7XG4gIH1cblxuICBjb25zdCBtZXNzYWdlID0gZkJvbGQoZlJlZChcIkVycm9yOiBcIikpICsgZlJlZChvcmlnaW5hbE1lc3NhZ2UpO1xuXG4gIHN0ID0gYXdhaXQgc3RcbiAgICAuY2xlYW4oKVxuICAgIC5maWx0ZXIoKGl0ZW0pID0+ICFpdGVtLm5hdGl2ZSlcbiAgICAvLyBzdHJpcCBub2RlIGludGVybmFsc1xuICAgIC5maWx0ZXIoKGl0ZW0pID0+ICFpdGVtLmZpbGUuc3RhcnRzV2l0aChcIm5vZGU6XCIpKVxuICAgIC8vIHN0cmlwIHdpbmdzZGtcbiAgICAuZmlsdGVyKFxuICAgICAgKGl0ZW0pID0+XG4gICAgICAgICFub3JtYWxQYXRoKGl0ZW0uZmlsZSkuaW5jbHVkZXMoXCIvbGlicy93aW5nc2RrL3NyYy9cIikgJiZcbiAgICAgICAgIW5vcm1hbFBhdGgoaXRlbS5maWxlKS5pbmNsdWRlcyhcIi9Ad2luZ2xhbmcvc2RrL1wiKVxuICAgIClcbiAgICAvLyBzcGVjaWFsOiByZW1vdmUgdGhlIGhhbmRsZXIgd3JhcHBlciAoU2VlIGBjbG91ZC5GdW5jdGlvbmAgZW50cnlwb2ludCBmb3Igd2hlcmUgdGhpcyBjb21lcyBmcm9tKVxuICAgIC5maWx0ZXIoXG4gICAgICAoaXRlbSkgPT4gIW5vcm1hbFBhdGgoaXRlbS5maWxlKS5tYXRjaCgvXFwud2luZ1xcL1xcdysoXFwuc2FuZGJveCk/XFwuY2pzJC8pXG4gICAgKVxuICAgIC53aXRoU291cmNlc0FzeW5jKCk7XG5cbiAgbGV0IHRyYWNlV2l0aFNvdXJjZXMgPSBzdC5pdGVtcztcblxuICBpZiAodHJhY2VXaXRoU291cmNlcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gbWVzc2FnZTtcbiAgfVxuXG4gIGxldCBpbnRlcmVzdGluZ1Jvb3QgPSBvcHRpb25zPy5zb3VyY2VFbnRyeXBvaW50O1xuXG4gIGlmIChcbiAgICBpbnRlcmVzdGluZ1Jvb3QgIT09IHVuZGVmaW5lZCAmJlxuICAgIChhd2FpdCBzdGF0KGludGVyZXN0aW5nUm9vdClcbiAgICAgIC50aGVuKChzKSA9PiAhcy5pc0RpcmVjdG9yeSgpKVxuICAgICAgLmNhdGNoKCgpID0+IHRydWUpKVxuICApIHtcbiAgICBpbnRlcmVzdGluZ1Jvb3QgPSByZXNvbHZlKGludGVyZXN0aW5nUm9vdCwgXCIuLlwiKTtcbiAgfVxuXG4gIGlmIChpbnRlcmVzdGluZ1Jvb3QgIT09IHVuZGVmaW5lZCkge1xuICAgIGludGVyZXN0aW5nUm9vdCA9IGludGVyZXN0aW5nUm9vdCArIHNlcDtcbiAgfVxuXG4gIGlmIChpbnRlcmVzdGluZ1Jvb3QgIT09IHVuZGVmaW5lZCkge1xuICAgIHRyYWNlV2l0aFNvdXJjZXMgPSB0cmFjZVdpdGhTb3VyY2VzLmZpbHRlcigoaXRlbSkgPT5cbiAgICAgIChpdGVtLnNvdXJjZUZpbGU/LnBhdGggPz8gaXRlbS5maWxlKS5zdGFydHNXaXRoKGludGVyZXN0aW5nUm9vdCEpXG4gICAgKTtcbiAgICBjb25zdCB0YXJnZXREaXIgPSBqb2luKGludGVyZXN0aW5nUm9vdCwgXCJ0YXJnZXRcIikgKyBzZXA7XG4gICAgdHJhY2VXaXRoU291cmNlcyA9IHRyYWNlV2l0aFNvdXJjZXMuZmlsdGVyKFxuICAgICAgKGl0ZW0pID0+ICEoaXRlbS5zb3VyY2VGaWxlPy5wYXRoID8/IGl0ZW0uZmlsZSkuc3RhcnRzV2l0aCh0YXJnZXREaXIpXG4gICAgKTtcbiAgfVxuXG4gIGxldCBvdXRwdXQgPSBbXTtcblxuICAvLyB1c2Ugb25seSB0aGUgZmlyc3QgaXRlbSB3aXRoIGEgc291cmNlXG4gIGNvbnN0IGZpcnN0R29vZEl0ZW0gPSB0cmFjZVdpdGhTb3VyY2VzLmZpbmQoXG4gICAgKGl0ZW0pID0+XG4gICAgICBpdGVtLnNvdXJjZUZpbGUgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgaXRlbS5zb3VyY2VGaWxlLmxpbmVzLmxlbmd0aCA+IDAgJiZcbiAgICAgICFpdGVtLm5hdGl2ZSAmJlxuICAgICAgIWl0ZW0udGhpcmRQYXJ0eVxuICApO1xuXG4gIGlmIChmaXJzdEdvb2RJdGVtKSB7XG4gICAgY29uc3Qgc291cmNlRmlsZSA9IGZpcnN0R29vZEl0ZW0uc291cmNlRmlsZSE7XG4gICAgY29uc3Qgb3JpZ2luTGluZXMgPSBzb3VyY2VGaWxlLmxpbmVzO1xuICAgIGNvbnN0IG9yaWdpbkxpbmUgPSBmaXJzdEdvb2RJdGVtLmxpbmUgPz8gMTtcbiAgICBjb25zdCBvcmlnaW5Db2x1bW4gPSBmaXJzdEdvb2RJdGVtLmNvbHVtbiA/PyAxO1xuXG4gICAgbGV0IHN0YXJ0TGluZSA9IE1hdGgubWF4KG9yaWdpbkxpbmUgLSAzLCAxKTtcbiAgICBsZXQgZmluaXNoTGluZSA9IG9yaWdpbkxpbmU7XG4gICAgY29uc3QgbWF4RGlnaXRzID0gZmluaXNoTGluZS50b1N0cmluZygpLmxlbmd0aDtcblxuICAgIC8vIHByaW50IGxpbmUgYW5kIGl0cyBzdXJyb3VuZGluZyBsaW5lc1xuICAgIG91dHB1dC5wdXNoKFxuICAgICAgXCIgXCIucmVwZWF0KG1heERpZ2l0cyArIDEpICtcbiAgICAgICAgYC0tPiAke3JlbGF0aXZlKFxuICAgICAgICAgIHByb2Nlc3MuY3dkKCksXG4gICAgICAgICAgc291cmNlRmlsZS5wYXRoXG4gICAgICAgICl9OiR7b3JpZ2luTGluZX06JHtvcmlnaW5Db2x1bW59YFxuICAgICk7XG5cbiAgICBsZXQgbGluZXNPZkludGVyZXN0ID0gb3JpZ2luTGluZXM7XG4gICAgaWYgKGxpbmVzT2ZJbnRlcmVzdC5sZW5ndGggPiAxKSB7XG4gICAgICBsaW5lc09mSW50ZXJlc3QgPSBvcmlnaW5MaW5lcy5zbGljZShzdGFydExpbmUgLSAxLCBmaW5pc2hMaW5lKTtcbiAgICB9XG4gICAgbGluZXNPZkludGVyZXN0LnB1c2goXCIgXCIucmVwZWF0KG9yaWdpbkNvbHVtbikgKyBcIl5cIik7XG4gICAgbGluZXNPZkludGVyZXN0ID0gZGVkZW50KGxpbmVzT2ZJbnRlcmVzdCk7XG5cbiAgICBsZXQgeCA9IDA7XG4gICAgZm9yIChsZXQgaSA9IHN0YXJ0TGluZTsgaSA8PSBmaW5pc2hMaW5lOyBpKyspIHtcbiAgICAgIGNvbnN0IGludGVyZXN0aW5nTGluZSA9IGkgPT09IG9yaWdpbkxpbmU7XG4gICAgICBsZXQgbGluZU51bWJlciA9IGludGVyZXN0aW5nTGluZVxuICAgICAgICA/IGAke2l9IHwgYFxuICAgICAgICA6IFwiIFwiLnJlcGVhdChtYXhEaWdpdHMpICsgXCIgfCBcIjtcblxuICAgICAgaWYgKGludGVyZXN0aW5nTGluZSkge1xuICAgICAgICBsaW5lTnVtYmVyID0gZkJvbGQoZlJlZChsaW5lTnVtYmVyKSk7XG4gICAgICB9XG5cbiAgICAgIGxldCBsaW5lVGV4dCA9IGxpbmVzT2ZJbnRlcmVzdFt4KytdO1xuICAgICAgb3V0cHV0LnB1c2gobGluZU51bWJlciArIGxpbmVUZXh0KTtcblxuICAgICAgaWYgKGludGVyZXN0aW5nTGluZSkge1xuICAgICAgICAvLyBsYXN0IGxpbmUgaXMgdGhlIGNhcmV0XG4gICAgICAgIG91dHB1dC5wdXNoKFwiIFwiLnJlcGVhdChtYXhEaWdpdHMpICsgXCIgfFwiICsgZlJlZChsaW5lc09mSW50ZXJlc3RbeF0pKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25zdCBvdXRwdXRUZXh0ID0gb3V0cHV0Lmxlbmd0aCA+IDAgPyBcIlxcblwiICsgb3V0cHV0LmpvaW4oXCJcXG5cIikgOiBcIlwiO1xuICBjb25zdCBleHRyYVN0YWNrID1cbiAgICB0cmFjZVdpdGhTb3VyY2VzLmxlbmd0aCA+IDBcbiAgICAgID8gXCJcXG5cIiArIGZEaW0odHJhY2VXaXRoU291cmNlcy5tYXAocHJpbnRJdGVtKS5qb2luKFwiXFxuXCIpKVxuICAgICAgOiBcIlwiO1xuXG4gIC8vIGFkZCB0aGUgcmVzdCBvZiB0aGUgc3RhY2sgdHJhY2UgZnJvbSB0aGUgc2FtZSBmaWxlXG4gIHJldHVybiBtZXNzYWdlICsgb3V0cHV0VGV4dCArIGV4dHJhU3RhY2s7XG59XG5cbmZ1bmN0aW9uIHByaW50SXRlbShpdGVtOiBTdGFja1RyYWNleS5FbnRyeSkge1xuICBsZXQgY2FsbGVlU2hvcnQgPSBgJHtpdGVtLmNhbGxlZVNob3J0fSBgO1xuXG4gIC8vIFRoZXNlIGFyZSB0eXBpY2FsbHkgdXNlbGVzc1xuICAvLyBUT0RPIFRoZXNlIGNhbiBwb3NzaWJseSBiZSByZW1vdmVkIHdoZW4gc291cmNlbWFwcyBzdXBwb3J0IFwibmFtZXNcIiBtYXBwaW5nc1xuICBpZiAoXG4gICAgaXRlbS5jYWxsZWVTaG9ydCA9PT0gXCIkUm9vdFwiIHx8XG4gICAgaXRlbS5jYWxsZWVTaG9ydCA9PT0gXCJuZXcgJFJvb3RcIiB8fFxuICAgIGl0ZW0uY2FsbGVlU2hvcnQuaW5jbHVkZXMoXCI8YW5vbnltb3VzPlwiKVxuICApIHtcbiAgICBjYWxsZWVTaG9ydCA9IFwiXCI7XG4gIH1cblxuICBpZiAoaXRlbS5jYWxsZWUubWF0Y2goL1xcJENsb3N1cmVcXGQrXFwuaGFuZGxlJC8pKSB7XG4gICAgLy8gaW5mbGlnaHQgY2xvc3VyZXMgdXNlIFwiaGFuZGxlXCIgYXMgYSB3YXkgdG8gcmVwcmVzZW50IGNhbGxpbmcgdGhlIGluZmxpZ2h0IGl0c2VsZlxuICAgIGNhbGxlZVNob3J0ID0gXCJcIjtcbiAgfVxuXG4gIGlmIChpdGVtLmZpbGVOYW1lLmVuZHNXaXRoKFwiLndcIikgJiYgY2FsbGVlU2hvcnQuc3RhcnRzV2l0aChcImFzeW5jIFwiKSkge1xuICAgIC8vIEluIHVzZXJsYW5kIHdpbmcgdHJhY2VzLCBhc3luYyA9IGluZmxpZ2h0IGFuZCBpcyBjdXJyZW50bHkgcmVkdW5kYW50IHRvIG1lbnRpb25cbiAgICBjYWxsZWVTaG9ydCA9IGNhbGxlZVNob3J0LnJlcGxhY2UoXCJhc3luYyBcIiwgXCJcIik7XG4gIH1cblxuICBjb25zdCBmaWxlID0gaXRlbS5maWxlO1xuICBjb25zdCBsaW5lID0gaXRlbS5saW5lO1xuICBjb25zdCBjb2x1bW4gPSBpdGVtLmNvbHVtbjtcblxuICByZXR1cm4gYGF0ICR7Y2FsbGVlU2hvcnR9JHtmaWxlfToke2xpbmV9OiR7Y29sdW1ufWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXdyaXRlQ29tbW9uRXJyb3IoZXJyb3I6IEVycm9yKTogRXJyb3Ige1xuICBpZiAoZXJyb3IubWVzc2FnZS5zdGFydHNXaXRoKFwiVGhlcmUgaXMgYWxyZWFkeSBhIENvbnN0cnVjdCB3aXRoIG5hbWVcIikpIHtcbiAgICBjb25zdCBuZXdNZXNzYWdlID0gW107XG4gICAgbmV3TWVzc2FnZS5wdXNoKGVycm9yLm1lc3NhZ2UpO1xuICAgIG5ld01lc3NhZ2UucHVzaChcbiAgICAgIFwiaGludDogRXZlcnkgcHJlZmxpZ2h0IG9iamVjdCBuZWVkcyBhIHVuaXF1ZSBpZGVudGlmaWVyIHdpdGhpbiBpdHMgc2NvcGUuIFlvdSBjYW4gYXNzaWduIG9uZSBhcyBzaG93bjpcIlxuICAgICk7XG4gICAgbmV3TWVzc2FnZS5wdXNoKCc+IG5ldyBjbG91ZC5CdWNrZXQoKSBhcyBcIk15QnVja2V0XCI7Jyk7XG4gICAgbmV3TWVzc2FnZS5wdXNoKFxuICAgICAgXCJGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlIGh0dHBzOi8vd3d3LndpbmdsYW5nLmlvL2RvY3MvY29uY2VwdHMvYXBwbGljYXRpb24tdHJlZVwiXG4gICAgKTtcbiAgICBlcnJvci5tZXNzYWdlID0gbmV3TWVzc2FnZS5qb2luKFwiXFxuXFxuXCIpO1xuICB9IGVsc2UgaWYgKGVycm9yLmNvbnN0cnVjdG9yLm5hbWUgPT09IFwiTm90SW1wbGVtZW50ZWRFcnJvclwiKSB7XG4gICAgZXJyb3IubmFtZSA9IFwiTm90SW1wbGVtZW50ZWRFcnJvclwiO1xuICB9XG5cbiAgcmV0dXJuIGVycm9yO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVkZW50KGxpbmVzOiBzdHJpbmdbXSkge1xuICAvLyBmaXJzdCwgcmVwbGFjZSBhbGwgdGFicyB3aXRoIDIgc3BhY2VzXG4gIGxpbmVzID0gbGluZXMubWFwKChsaW5lKSA9PiBsaW5lLnJlcGxhY2UoL1xcdC9nLCBcIiAgXCIpKTtcblxuICAvLyBmaW5kIHRoZSBzbWFsbGVzdCBpbmRlbnRhdGlvblxuICBsZXQgbWluSW5kZW50ID0gSW5maW5pdHk7XG4gIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgIGNvbnN0IG1hdGNoID0gbGluZS5tYXRjaCgvXiAqLyk7XG4gICAgaWYgKG1hdGNoICYmIG1hdGNoWzBdLmxlbmd0aCAhPT0gbGluZS5sZW5ndGgpIHtcbiAgICAgIG1pbkluZGVudCA9IE1hdGgubWluKG1pbkluZGVudCwgbWF0Y2hbMF0ubGVuZ3RoKTtcbiAgICB9XG4gIH1cblxuICAvLyByZW1vdmUgdGhlIGluZGVudGF0aW9uXG4gIHJldHVybiBsaW5lcy5tYXAoKGxpbmUpID0+IGxpbmUuc3Vic3RyaW5nKG1pbkluZGVudCkpO1xufVxuIl19