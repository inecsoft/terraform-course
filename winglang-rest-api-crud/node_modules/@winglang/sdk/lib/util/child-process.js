"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChildProcess = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const child_process_1 = require("child_process");
const util_1 = require("./util");
const core_1 = require("../core");
/**
 * Handle to a running child process.
 */
class ChildProcess {
    /**
     * @internal
     */
    static _toInflightType() {
        return core_1.InflightClient.forType(__filename, this.name);
    }
    constructor(program, args, opts) {
        /**
         * The accumulated standard output from the child process.
         */
        this.stdout = "";
        /**
         * The accumulated standard error from the child process.
         */
        this.stderr = "";
        /**
         * The exit status of the child process. Null if the process has not yet finished.
         */
        this.exitStatus = null;
        const spawnOpts = {
            cwd: opts?.cwd,
            env: opts?.inheritEnv
                ? { ...process.env, ...opts.env }
                : { ...opts?.env },
            stdio: [
                opts?.stdin ?? util_1.Stdio.PIPED,
                opts?.stdout ?? util_1.Stdio.PIPED,
                opts?.stderr ?? util_1.Stdio.PIPED,
            ],
        };
        // Spawn the child process with the provided options
        this.child = (0, child_process_1.spawn)(program, args, spawnOpts);
        this.pid = this.child.pid;
        this.child.on("exit", (code) => {
            this.exitStatus = code;
        });
    }
    /**
     * Kill the process.
     * @param signal - the signal to send to the process (defaults to SIGTERM)
     */
    kill(signal = 15) {
        this.child.kill(signal);
    }
    /**
     * Wait for the process to finish and return its output.
     * Calling this method multiple times will return the same output.
     */
    async wait() {
        if (this.exitStatus !== null) {
            return {
                stdout: this.stdout,
                stderr: this.stderr,
                status: this.exitStatus,
            };
        }
        return new Promise((resolve, reject) => {
            const cleanup = () => {
                this.child.off("exit", onExit);
                this.child.off("error", onError);
                if (this.child.stdout) {
                    this.child.stdout.off("data", onDataStdout);
                }
                if (this.child.stderr) {
                    this.child.stderr.off("data", onDataStderr);
                }
            };
            const onExit = (code, signal) => {
                cleanup();
                if (code !== null) {
                    resolve({ stdout: this.stdout, stderr: this.stderr, status: code });
                }
                else {
                    reject(new Error(`Process terminated by signal ${signal}`));
                }
            };
            const onError = (error) => {
                cleanup();
                reject(error);
            };
            const onDataStdout = (data) => {
                this.stdout += data.toString();
            };
            const onDataStderr = (data) => {
                this.stderr += data.toString();
            };
            this.child.on("exit", onExit);
            this.child.on("error", onError);
            if (this.child.stdout) {
                this.child.stdout.on("data", onDataStdout);
            }
            if (this.child.stderr) {
                this.child.stderr.on("data", onDataStderr);
            }
        });
    }
}
exports.ChildProcess = ChildProcess;
_a = JSII_RTTI_SYMBOL_1;
ChildProcess[_a] = { fqn: "@winglang/sdk.util.ChildProcess", version: "0.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hpbGQtcHJvY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2NoaWxkLXByb2Nlc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxpREFBc0M7QUFDdEMsaUNBQXFEO0FBQ3JELGtDQUF5QztBQUV6Qzs7R0FFRztBQUNILE1BQWEsWUFBWTtJQUN2Qjs7T0FFRztJQUNJLE1BQU0sQ0FBQyxlQUFlO1FBQzNCLE9BQU8scUJBQWMsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBdUJELFlBQVksT0FBZSxFQUFFLElBQWMsRUFBRSxJQUFtQjtRQWJoRTs7V0FFRztRQUNLLFdBQU0sR0FBVyxFQUFFLENBQUM7UUFDNUI7O1dBRUc7UUFDSyxXQUFNLEdBQVcsRUFBRSxDQUFDO1FBQzVCOztXQUVHO1FBQ0ssZUFBVSxHQUFrQixJQUFJLENBQUM7UUFHdkMsTUFBTSxTQUFTLEdBQUc7WUFDaEIsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHO1lBQ2QsR0FBRyxFQUFFLElBQUksRUFBRSxVQUFVO2dCQUNuQixDQUFDLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUNqQyxDQUFDLENBQUMsRUFBRSxHQUFHLElBQUksRUFBRSxHQUFHLEVBQUU7WUFDcEIsS0FBSyxFQUFFO2dCQUNMLElBQUksRUFBRSxLQUFLLElBQUksWUFBSyxDQUFDLEtBQUs7Z0JBQzFCLElBQUksRUFBRSxNQUFNLElBQUksWUFBSyxDQUFDLEtBQUs7Z0JBQzNCLElBQUksRUFBRSxNQUFNLElBQUksWUFBSyxDQUFDLEtBQUs7YUFDNUI7U0FDRixDQUFDO1FBRUYsb0RBQW9EO1FBQ3BELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBQSxxQkFBSyxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7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LENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDN0MsQ0FBQztZQUNELElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxZQUFZLENBQUMsQ0FBQztZQUM3QyxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOztBQW5ISCxvQ0FvSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzcGF3biB9IGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5pbXBvcnQgeyBPdXRwdXQsIFNwYXduT3B0aW9ucywgU3RkaW8gfSBmcm9tIFwiLi91dGlsXCI7XG5pbXBvcnQgeyBJbmZsaWdodENsaWVudCB9IGZyb20gXCIuLi9jb3JlXCI7XG5cbi8qKlxuICogSGFuZGxlIHRvIGEgcnVubmluZyBjaGlsZCBwcm9jZXNzLlxuICovXG5leHBvcnQgY2xhc3MgQ2hpbGRQcm9jZXNzIHtcbiAgLyoqXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBfdG9JbmZsaWdodFR5cGUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gSW5mbGlnaHRDbGllbnQuZm9yVHlwZShfX2ZpbGVuYW1lLCB0aGlzLm5hbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSB1bmRlcmx5aW5nIG5hdGl2ZSBjaGlsZCBwcm9jZXNzIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHNwYXduZWQgcHJvY2Vzcy5cbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgY2hpbGQ6IFJldHVyblR5cGU8dHlwZW9mIHNwYXduPjtcbiAgLyoqXG4gICAqIFRoZSBjaGlsZCdzIE9TLWFzc2lnbmVkIHByb2Nlc3MgSUQuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcGlkOiBudW1iZXIgfCB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBUaGUgYWNjdW11bGF0ZWQgc3RhbmRhcmQgb3V0cHV0IGZyb20gdGhlIGNoaWxkIHByb2Nlc3MuXG4gICAqL1xuICBwcml2YXRlIHN0ZG91dDogc3RyaW5nID0gXCJcIjtcbiAgLyoqXG4gICAqIFRoZSBhY2N1bXVsYXRlZCBzdGFuZGFyZCBlcnJvciBmcm9tIHRoZSBjaGlsZCBwcm9jZXNzLlxuICAgKi9cbiAgcHJpdmF0ZSBzdGRlcnI6IHN0cmluZyA9IFwiXCI7XG4gIC8qKlxuICAgKiBUaGUgZXhpdCBzdGF0dXMgb2YgdGhlIGNoaWxkIHByb2Nlc3MuIE51bGwgaWYgdGhlIHByb2Nlc3MgaGFzIG5vdCB5ZXQgZmluaXNoZWQuXG4gICAqL1xuICBwcml2YXRlIGV4aXRTdGF0dXM6IG51bWJlciB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKHByb2dyYW06IHN0cmluZywgYXJnczogc3RyaW5nW10sIG9wdHM/OiBTcGF3bk9wdGlvbnMpIHtcbiAgICBjb25zdCBzcGF3bk9wdHMgPSB7XG4gICAgICBjd2Q6IG9wdHM/LmN3ZCxcbiAgICAgIGVudjogb3B0cz8uaW5oZXJpdEVudlxuICAgICAgICA/IHsgLi4ucHJvY2Vzcy5lbnYsIC4uLm9wdHMuZW52IH1cbiAgICAgICAgOiB7IC4uLm9wdHM/LmVudiB9LFxuICAgICAgc3RkaW86IFtcbiAgICAgICAgb3B0cz8uc3RkaW4gPz8gU3RkaW8uUElQRUQsXG4gICAgICAgIG9wdHM/LnN0ZG91dCA/PyBTdGRpby5QSVBFRCxcbiAgICAgICAgb3B0cz8uc3RkZXJyID8/IFN0ZGlvLlBJUEVELFxuICAgICAgXSxcbiAgICB9O1xuXG4gICAgLy8gU3Bhd24gdGhlIGNoaWxkIHByb2Nlc3Mgd2l0aCB0aGUgcHJvdmlkZWQgb3B0aW9uc1xuICAgIHRoaXMuY2hpbGQgPSBzcGF3bihwcm9ncmFtLCBhcmdzLCBzcGF3bk9wdHMpO1xuICAgIHRoaXMucGlkID0gdGhpcy5jaGlsZC5waWQ7XG5cbiAgICB0aGlzLmNoaWxkLm9uKFwiZXhpdFwiLCAoY29kZSkgPT4ge1xuICAgICAgdGhpcy5leGl0U3RhdHVzID0gY29kZTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBLaWxsIHRoZSBwcm9jZXNzLlxuICAgKiBAcGFyYW0gc2lnbmFsIC0gdGhlIHNpZ25hbCB0byBzZW5kIHRvIHRoZSBwcm9jZXNzIChkZWZhdWx0cyB0byBTSUdURVJNKVxuICAgKi9cbiAgcHVibGljIGtpbGwoc2lnbmFsOiBudW1iZXIgPSAxNSk6IHZvaWQge1xuICAgIHRoaXMuY2hpbGQua2lsbChzaWduYWwpO1xuICB9XG5cbiAgLyoqXG4gICAqIFdhaXQgZm9yIHRoZSBwcm9jZXNzIHRvIGZpbmlzaCBhbmQgcmV0dXJuIGl0cyBvdXRwdXQuXG4gICAqIENhbGxpbmcgdGhpcyBtZXRob2QgbXVsdGlwbGUgdGltZXMgd2lsbCByZXR1cm4gdGhlIHNhbWUgb3V0cHV0LlxuICAgKi9cbiAgcHVibGljIGFzeW5jIHdhaXQoKTogUHJvbWlzZTxPdXRwdXQ+IHtcbiAgICBpZiAodGhpcy5leGl0U3RhdHVzICE9PSBudWxsKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGRvdXQ6IHRoaXMuc3Rkb3V0LFxuICAgICAgICBzdGRlcnI6IHRoaXMuc3RkZXJyLFxuICAgICAgICBzdGF0dXM6IHRoaXMuZXhpdFN0YXR1cyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGNsZWFudXAgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuY2hpbGQub2ZmKFwiZXhpdFwiLCBvbkV4aXQpO1xuICAgICAgICB0aGlzLmNoaWxkLm9mZihcImVycm9yXCIsIG9uRXJyb3IpO1xuICAgICAgICBpZiAodGhpcy5jaGlsZC5zdGRvdXQpIHtcbiAgICAgICAgICB0aGlzLmNoaWxkLnN0ZG91dC5vZmYoXCJkYXRhXCIsIG9uRGF0YVN0ZG91dCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuY2hpbGQuc3RkZXJyKSB7XG4gICAgICAgICAgdGhpcy5jaGlsZC5zdGRlcnIub2ZmKFwiZGF0YVwiLCBvbkRhdGFTdGRlcnIpO1xuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBjb25zdCBvbkV4aXQgPSAoY29kZTogbnVtYmVyIHwgbnVsbCwgc2lnbmFsOiBzdHJpbmcgfCBudWxsKSA9PiB7XG4gICAgICAgIGNsZWFudXAoKTtcbiAgICAgICAgaWYgKGNvZGUgIT09IG51bGwpIHtcbiAgICAgICAgICByZXNvbHZlKHsgc3Rkb3V0OiB0aGlzLnN0ZG91dCwgc3RkZXJyOiB0aGlzLnN0ZGVyciwgc3RhdHVzOiBjb2RlIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFByb2Nlc3MgdGVybWluYXRlZCBieSBzaWduYWwgJHtzaWduYWx9YCkpO1xuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBjb25zdCBvbkVycm9yID0gKGVycm9yOiBFcnJvcikgPT4ge1xuICAgICAgICBjbGVhbnVwKCk7XG4gICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICB9O1xuXG4gICAgICBjb25zdCBvbkRhdGFTdGRvdXQgPSAoZGF0YTogQnVmZmVyKSA9PiB7XG4gICAgICAgIHRoaXMuc3Rkb3V0ICs9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG9uRGF0YVN0ZGVyciA9IChkYXRhOiBCdWZmZXIpID0+IHtcbiAgICAgICAgdGhpcy5zdGRlcnIgKz0gZGF0YS50b1N0cmluZygpO1xuICAgICAgfTtcblxuICAgICAgdGhpcy5jaGlsZC5vbihcImV4aXRcIiwgb25FeGl0KTtcbiAgICAgIHRoaXMuY2hpbGQub24oXCJlcnJvclwiLCBvbkVycm9yKTtcbiAgICAgIGlmICh0aGlzLmNoaWxkLnN0ZG91dCkge1xuICAgICAgICB0aGlzLmNoaWxkLnN0ZG91dC5vbihcImRhdGFcIiwgb25EYXRhU3Rkb3V0KTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmNoaWxkLnN0ZGVycikge1xuICAgICAgICB0aGlzLmNoaWxkLnN0ZGVyci5vbihcImRhdGFcIiwgb25EYXRhU3RkZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIl19