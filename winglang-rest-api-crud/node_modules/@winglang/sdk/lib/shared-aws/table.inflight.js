"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TableClient = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
const table_utils_1 = require("../shared/table-utils");
class TableClient {
    constructor(tableName, primaryKey, columns, client = new client_dynamodb_1.DynamoDBClient({})) {
        this.tableName = tableName;
        this.primaryKey = primaryKey;
        this.columns = columns;
        this.client = client;
    }
    async insert(key, row) {
        (0, table_utils_1.validateRow)(row, JSON.parse(this.columns));
        let insertRow = { [this.primaryKey]: key, ...row };
        try {
            const command = new client_dynamodb_1.PutItemCommand({
                TableName: this.tableName,
                Item: (0, util_dynamodb_1.marshall)(insertRow),
                ConditionExpression: `attribute_not_exists(#primary_key)`,
                ExpressionAttributeNames: {
                    "#primary_key": this.primaryKey,
                },
            });
            await this.client.send(command);
        }
        catch (e) {
            if (e instanceof client_dynamodb_1.ConditionalCheckFailedException) {
                throw new Error(`The primary key "${key}" already exists in the "${this.tableName}" table: ${e.stack})}`);
            }
            throw new Error(e.stack);
        }
    }
    async upsert(key, row) {
        (0, table_utils_1.validateRow)(row, JSON.parse(this.columns));
        let insertRow = { [this.primaryKey]: key, ...row };
        const command = new client_dynamodb_1.PutItemCommand({
            TableName: this.tableName,
            Item: (0, util_dynamodb_1.marshall)(insertRow),
        });
        await this.client.send(command);
    }
    async update(key, row) {
        (0, table_utils_1.validateRow)(row, JSON.parse(this.columns));
        let itemKey = { [this.primaryKey]: key };
        let updateExpression = [];
        let expressionAttributes = {};
        const item = (0, util_dynamodb_1.marshall)(row);
        for (const [id, value] of Object.entries(item)) {
            if (id !== this.primaryKey) {
                updateExpression.push(`${id} = :${id}`);
                expressionAttributes[`:${id}`] = value;
            }
        }
        const command = new client_dynamodb_1.UpdateItemCommand({
            TableName: this.tableName,
            Key: (0, util_dynamodb_1.marshall)(itemKey),
            UpdateExpression: `set ${updateExpression.toString()}`,
            ExpressionAttributeValues: expressionAttributes,
        });
        await this.client.send(command);
    }
    async delete(key) {
        const command = new client_dynamodb_1.DeleteItemCommand({
            TableName: this.tableName,
            Key: { [this.primaryKey]: { S: key } },
        });
        await this.client.send(command);
    }
    async get(key) {
        const result = await this.tryGetJson(key);
        if (!result) {
            throw new Error(`Row does not exist (key=${key})`);
        }
        return result;
    }
    async tryGet(key) {
        return this.tryGetJson(key);
    }
    async list() {
        const command = new client_dynamodb_1.ScanCommand({
            TableName: this.tableName,
        });
        const result = await this.client.send(command);
        const response = [];
        for (const item of result.Items) {
            response.push((0, util_dynamodb_1.unmarshall)(item));
        }
        return response;
    }
    async tryGetJson(key) {
        const command = new client_dynamodb_1.GetItemCommand({
            TableName: this.tableName,
            Key: { [this.primaryKey]: { S: key } },
        });
        const result = await this.client.send(command);
        if (result.Item) {
            return (0, util_dynamodb_1.unmarshall)(result.Item);
        }
        return undefined;
    }
}
exports.TableClient = TableClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuaW5mbGlnaHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2hhcmVkLWF3cy90YWJsZS5pbmZsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFRa0M7QUFDbEMsMERBQThEO0FBRTlELHVEQUFvRDtBQUdwRCxNQUFhLFdBQVc7SUFDdEIsWUFDbUIsU0FBaUIsRUFDakIsVUFBa0IsRUFDbEIsT0FBZSxFQUNmLFNBQVMsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQztRQUgvQixjQUFTLEdBQVQsU0FBUyxDQUFRO1FBQ2pCLGVBQVUsR0FBVixVQUFVLENBQVE7UUFDbEIsWUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUNmLFdBQU0sR0FBTixNQUFNLENBQXlCO0lBQy9DLENBQUM7SUFFRyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQVcsRUFBRSxHQUFTO1FBQ3hDLElBQUEseUJBQVcsRUFBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUMzQyxJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ25ELElBQUksQ0FBQztZQUNILE1BQU0sT0FBTyxHQUFHLElBQUksZ0NBQWMsQ0FBQztnQkFDakMsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO2dCQUN6QixJQUFJLEVBQUUsSUFBQSx3QkFBUSxFQUFDLFNBQVMsQ0FBQztnQkFDekIsbUJBQW1CLEVBQUUsb0NBQW9DO2dCQUN6RCx3QkFBd0IsRUFBRTtvQkFDeEIsY0FBYyxFQUFFLElBQUksQ0FBQyxVQUFVO2lCQUNoQzthQUNGLENBQUMsQ0FBQztZQUNILE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbEMsQ0FBQztRQUFDLE9BQU8sQ0FBQyxFQUFF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LE9BQU8sSUFBQSwwQkFBVSxFQUFDLE1BQU0sQ0FBQyxJQUFJLENBQVMsQ0FBQztRQUN6QyxDQUFDO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQUNGO0FBM0dELGtDQTJHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERlbGV0ZUl0ZW1Db21tYW5kLFxuICBHZXRJdGVtQ29tbWFuZCxcbiAgVXBkYXRlSXRlbUNvbW1hbmQsXG4gIFB1dEl0ZW1Db21tYW5kLFxuICBTY2FuQ29tbWFuZCxcbiAgRHluYW1vREJDbGllbnQsXG4gIENvbmRpdGlvbmFsQ2hlY2tGYWlsZWRFeGNlcHRpb24sXG59IGZyb20gXCJAYXdzLXNkay9jbGllbnQtZHluYW1vZGJcIjtcbmltcG9ydCB7IG1hcnNoYWxsLCB1bm1hcnNoYWxsIH0gZnJvbSBcIkBhd3Mtc2RrL3V0aWwtZHluYW1vZGJcIjtcbmltcG9ydCB7IElUYWJsZUNsaWVudCB9IGZyb20gXCIuLi9leFwiO1xuaW1wb3J0IHsgdmFsaWRhdGVSb3cgfSBmcm9tIFwiLi4vc2hhcmVkL3RhYmxlLXV0aWxzXCI7XG5pbXBvcnQgeyBKc29uIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG5leHBvcnQgY2xhc3MgVGFibGVDbGllbnQgaW1wbGVtZW50cyBJVGFibGVDbGllbnQge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRhYmxlTmFtZTogc3RyaW5nLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJpbWFyeUtleTogc3RyaW5nLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29sdW1uczogc3RyaW5nLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KVxuICApIHt9XG5cbiAgcHVibGljIGFzeW5jIGluc2VydChrZXk6IHN0cmluZywgcm93OiBKc29uKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdmFsaWRhdGVSb3cocm93LCBKU09OLnBhcnNlKHRoaXMuY29sdW1ucykpO1xuICAgIGxldCBpbnNlcnRSb3cgPSB7IFt0aGlzLnByaW1hcnlLZXldOiBrZXksIC4uLnJvdyB9O1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjb21tYW5kID0gbmV3IFB1dEl0ZW1Db21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgICAgSXRlbTogbWFyc2hhbGwoaW5zZXJ0Um93KSxcbiAgICAgICAgQ29uZGl0aW9uRXhwcmVzc2lvbjogYGF0dHJpYnV0ZV9ub3RfZXhpc3RzKCNwcmltYXJ5X2tleSlgLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgICBcIiNwcmltYXJ5X2tleVwiOiB0aGlzLnByaW1hcnlLZXksXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUgaW5zdGFuY2VvZiBDb25kaXRpb25hbENoZWNrRmFpbGVkRXhjZXB0aW9uKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGhlIHByaW1hcnkga2V5IFwiJHtrZXl9XCIgYWxyZWFkeSBleGlzdHMgaW4gdGhlIFwiJHtcbiAgICAgICAgICAgIHRoaXMudGFibGVOYW1lXG4gICAgICAgICAgfVwiIHRhYmxlOiAkeyhlIGFzIEVycm9yKS5zdGFja30pfWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcigoZSBhcyBFcnJvcikuc3RhY2spO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyB1cHNlcnQoa2V5OiBzdHJpbmcsIHJvdzogSnNvbik6IFByb21pc2U8dm9pZD4ge1xuICAgIHZhbGlkYXRlUm93KHJvdywgSlNPTi5wYXJzZSh0aGlzLmNvbHVtbnMpKTtcbiAgICBsZXQgaW5zZXJ0Um93ID0geyBbdGhpcy5wcmltYXJ5S2V5XToga2V5LCAuLi5yb3cgfTtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFB1dEl0ZW1Db21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogdGhpcy50YWJsZU5hbWUsXG4gICAgICBJdGVtOiBtYXJzaGFsbChpbnNlcnRSb3cpLFxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKGtleTogU3RyaW5nLCByb3c6IEpzb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB2YWxpZGF0ZVJvdyhyb3csIEpTT04ucGFyc2UodGhpcy5jb2x1bW5zKSk7XG4gICAgbGV0IGl0ZW1LZXkgPSB7IFt0aGlzLnByaW1hcnlLZXldOiBrZXkgfTtcbiAgICBsZXQgdXBkYXRlRXhwcmVzc2lvbjogc3RyaW5nW10gPSBbXTtcbiAgICBsZXQgZXhwcmVzc2lvbkF0dHJpYnV0ZXM6IGFueSA9IHt9O1xuICAgIGNvbnN0IGl0ZW0gPSBtYXJzaGFsbChyb3cpO1xuICAgIGZvciAoY29uc3QgW2lkLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoaXRlbSkpIHtcbiAgICAgIGlmIChpZCAhPT0gdGhpcy5wcmltYXJ5S2V5KSB7XG4gICAgICAgIHVwZGF0ZUV4cHJlc3Npb24ucHVzaChgJHtpZH0gPSA6JHtpZH1gKTtcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZXNbYDoke2lkfWBdID0gdmFsdWU7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgVXBkYXRlSXRlbUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgIEtleTogbWFyc2hhbGwoaXRlbUtleSksXG4gICAgICBVcGRhdGVFeHByZXNzaW9uOiBgc2V0ICR7dXBkYXRlRXhwcmVzc2lvbi50b1N0cmluZygpfWAsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBleHByZXNzaW9uQXR0cmlidXRlcyxcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLmNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlbGV0ZShrZXk6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgRGVsZXRlSXRlbUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgIEtleTogeyBbdGhpcy5wcmltYXJ5S2V5XTogeyBTOiBrZXkgfSB9LFxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0KGtleTogc3RyaW5nKTogUHJvbWlzZTxKc29uPiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy50cnlHZXRKc29uKGtleSk7XG4gICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUm93IGRvZXMgbm90IGV4aXN0IChrZXk9JHtrZXl9KWApO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHRyeUdldChrZXk6IHN0cmluZyk6IFByb21pc2U8SnNvbiB8IHVuZGVmaW5lZD4ge1xuICAgIHJldHVybiB0aGlzLnRyeUdldEpzb24oa2V5KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsaXN0KCk6IFByb21pc2U8QXJyYXk8SnNvbj4+IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFNjYW5Db21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogdGhpcy50YWJsZU5hbWUsXG4gICAgfSk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5jbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBjb25zdCByZXNwb25zZTogYW55ID0gW107XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIHJlc3VsdC5JdGVtcyEpIHtcbiAgICAgIHJlc3BvbnNlLnB1c2godW5tYXJzaGFsbChpdGVtKSk7XG4gICAgfVxuICAgIHJldHVybiByZXNwb25zZTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdHJ5R2V0SnNvbihrZXk6IHN0cmluZyk6IFByb21pc2U8SnNvbiB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0SXRlbUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiB0aGlzLnRhYmxlTmFtZSxcbiAgICAgIEtleTogeyBbdGhpcy5wcmltYXJ5S2V5XTogeyBTOiBrZXkgfSB9LFxuICAgIH0pO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgaWYgKHJlc3VsdC5JdGVtKSB7XG4gICAgICByZXR1cm4gdW5tYXJzaGFsbChyZXN1bHQuSXRlbSkgYXMgSnNvbjtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufVxuIl19