"use strict";
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BucketEventHandler = exports.BucketRef = exports.Bucket = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const inflight_host_1 = require("./inflight-host");
const permissions_1 = require("./permissions");
const __1 = require("..");
const core_1 = require("../core");
const types_1 = require("../core/types");
const std_1 = require("../std");
/**
 * A helper class for working with AWS buckets.
 */
class Bucket {
    /**
     * If the bucket is an AWS Bucket, return a helper interface for
     * working with it.
     * @param bucket The cloud.Bucket.
     */
    static from(bucket) {
        if (this.isAwsBucket(bucket)) {
            return bucket;
        }
        return undefined;
    }
    static isAwsBucket(obj) {
        return (typeof obj.bucketArn === "string" && typeof obj.bucketName === "string");
    }
}
exports.Bucket = Bucket;
_a = JSII_RTTI_SYMBOL_1;
Bucket[_a] = { fqn: "@winglang/sdk.aws.Bucket", version: "0.0.0" };
/**
 * A reference to an external S3 bucket.
 * @inflight `@winglang/sdk.aws.IAwsBucketClient`
 */
class BucketRef extends std_1.Resource {
    constructor(scope, id, bucketName) {
        super(scope, id);
        this.bucketName = bucketName;
        this.bucketArn = `arn:aws:s3:::${bucketName}`;
        this.addUserInterface();
    }
    onLift(host, ops) {
        if (inflight_host_1.AwsInflightHost.isAwsInflightHost(host)) {
            host.addPolicyStatements(...(0, permissions_1.calculateBucketPermissions)(this.bucketArn, ops));
        }
        // The bucket name needs to be passed through an environment variable since
        // it may not be resolved until deployment time.
        host.addEnvironment(this.envName(), this.bucketName);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core_1.InflightClient.for(__dirname, __filename, "BucketClient", [
            `process.env["${this.envName()}"]`,
        ]);
    }
    envName() {
        return `BUCKET_NAME_${this.node.addr.slice(-8)}`;
    }
    /** @internal */
    get _liftMap() {
        return {
            [__1.cloud.BucketInflightMethods.DELETE]: [],
            [__1.cloud.BucketInflightMethods.GET]: [],
            [__1.cloud.BucketInflightMethods.GET_JSON]: [],
            [__1.cloud.BucketInflightMethods.LIST]: [],
            [__1.cloud.BucketInflightMethods.PUT]: [],
            [__1.cloud.BucketInflightMethods.PUT_JSON]: [],
            [__1.cloud.BucketInflightMethods.PUBLIC_URL]: [],
            [__1.cloud.BucketInflightMethods.EXISTS]: [],
            [__1.cloud.BucketInflightMethods.TRY_GET]: [],
            [__1.cloud.BucketInflightMethods.TRY_GET_JSON]: [],
            [__1.cloud.BucketInflightMethods.TRY_DELETE]: [],
            [__1.cloud.BucketInflightMethods.SIGNED_URL]: [],
            [__1.cloud.BucketInflightMethods.METADATA]: [],
            [__1.cloud.BucketInflightMethods.COPY]: [],
            [__1.cloud.BucketInflightMethods.RENAME]: [],
            bucketRegion: [],
        };
    }
    addUserInterface() {
        std_1.Node.of(this).color = "amber";
        const awsConsoleHandler = (0, core_1.lift)({
            bucket: this,
            bucketName: this.bucketName,
        }).inflight(async (ctx) => {
            try {
                const region = await ctx.bucket.bucketRegion();
                return ("https://" +
                    region +
                    ".console.aws.amazon.com/s3/buckets/" +
                    ctx.bucketName +
                    "?region=" +
                    region);
            }
            catch (e) {
                return e.message;
            }
        });
        new __1.ui.Field(this, "AwsConsoleField", "AWS Console", awsConsoleHandler, {
            link: true,
        });
        new __1.ui.ValueField(this, "BucketNameField", "Bucket Name", this.bucketName);
        new __1.ui.ValueField(this, "BucketArnField", "Bucket ARN", this.bucketArn);
        new __1.ui.FileBrowser(this, "FileBrowser", "File Browser", {
            put: (0, core_1.lift)({ bucket: this }).inflight(async (ctx, fileName, fileContent) => {
                await ctx.bucket.put(fileName, fileContent);
            }),
            get: (0, core_1.lift)({ bucket: this }).inflight(async (ctx, fileName) => {
                return ctx.bucket.get(fileName);
            }),
            delete: (0, core_1.lift)({ bucket: this }).inflight(async (ctx, fileName) => {
                await ctx.bucket.delete(fileName);
            }),
            list: (0, core_1.lift)({ bucket: this }).inflight(async (ctx) => {
                return ctx.bucket.list();
            }),
        });
    }
}
exports.BucketRef = BucketRef;
_b = JSII_RTTI_SYMBOL_1;
BucketRef[_b] = { fqn: "@winglang/sdk.aws.BucketRef", version: "0.0.0" };
/**
 * Utility class to work with bucket event handlers.
 */
class BucketEventHandler {
    /**
     * Converts a `cloud.IBucketEventHandler` to a `cloud.ITopicOnMessageHandler`.
     * @param handler the handler to convert
     * @param eventType the event type
     * @returns the on message handler.
     */
    static toTopicOnMessageHandler(handler, eventType) {
        return (0, core_1.lift)({ handler, eventType }).inflight(async (ctx, event) => {
            try {
                const message = JSON.parse(event);
                if (message?.Event === "s3:TestEvent") {
                    // aws sends a test event to the topic before of the actual one, we're ignoring it for now
                    return;
                }
                return await ctx.handler(message.Records[0].s3.object.key, ctx.eventType);
            }
            catch (error) {
                console.warn("Error parsing the notification event message: ", error);
                console.warn("Event: ", event);
            }
        });
    }
}
exports.BucketEventHandler = BucketEventHandler;
_c = JSII_RTTI_SYMBOL_1;
BucketEventHandler[_c] = { fqn: "@winglang/sdk.aws.BucketEventHandler", version: "0.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NoYXJlZC1hd3MvYnVja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsbURBQWtEO0FBQ2xELCtDQUEyRDtBQUMzRCwwQkFBK0I7QUFDL0Isa0NBQXdEO0FBQ3hELHlDQUFnRDtBQUNoRCxnQ0FBdUQ7QUFpQnZEOztHQUVHO0FBQ0gsTUFBYSxNQUFNO0lBQ2pCOzs7O09BSUc7SUFDSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQW9CO1FBQ3JDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1lBQzdCLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUM7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRU8sTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFRO1FBQ2pDLE9BQU8sQ0FDTCxPQUFPLEdBQUcsQ0FBQyxTQUFTLEtBQUssUUFBUSxJQUFJLE9BQU8sR0FBRyxDQUFDLFVBQVUsS0FBSyxRQUFRLENBQ3hFLENBQUM7SUFDSixDQUFDOztBQWpCSCx3QkFrQkM7OztBQWFEOzs7R0FHRztBQUNILE1BQWEsU0FBVSxTQUFRLGNBQVE7SUFjckMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxVQUFrQjtRQUMxRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxTQUFTLEdBQUcsZ0JBQWdCLFVBQVUsRUFBRSxDQUFDO1FBRTlDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTSxNQUFNLENBQUMsSUFBbUIsRUFBRSxHQUFhO1FBQzlDLElBQUksK0JBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzVDLElBQUksQ0FBQyxtQkFBbUIsQ0FDdEIsR0FBRyxJQUFB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Q0FBQyxDQUFDO0lBQ0wsQ0FBQzs7QUEzQkgsZ0RBNEJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IEF3c0luZmxpZ2h0SG9zdCB9IGZyb20gXCIuL2luZmxpZ2h0LWhvc3RcIjtcbmltcG9ydCB7IGNhbGN1bGF0ZUJ1Y2tldFBlcm1pc3Npb25zIH0gZnJvbSBcIi4vcGVybWlzc2lvbnNcIjtcbmltcG9ydCB7IGNsb3VkLCB1aSB9IGZyb20gXCIuLlwiO1xuaW1wb3J0IHsgSW5mbGlnaHRDbGllbnQsIExpZnRNYXAsIGxpZnQgfSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgSU5GTElHSFRfU1lNQk9MIH0gZnJvbSBcIi4uL2NvcmUvdHlwZXNcIjtcbmltcG9ydCB7IElJbmZsaWdodEhvc3QsIE5vZGUsIFJlc291cmNlIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG4vKipcbiAqIEEgc2hhcmVkIGludGVyZmFjZSBmb3IgQVdTIGJ1Y2tldHMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUF3c0J1Y2tldCB7XG4gIC8qKlxuICAgKiBBV1MgQnVja2V0IGFyblxuICAgKi9cbiAgcmVhZG9ubHkgYnVja2V0QXJuOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEFXUyBCdWNrZXQgbmFtZVxuICAgKi9cbiAgcmVhZG9ubHkgYnVja2V0TmFtZTogc3RyaW5nO1xufVxuXG4vKipcbiAqIEEgaGVscGVyIGNsYXNzIGZvciB3b3JraW5nIHdpdGggQVdTIGJ1Y2tldHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBCdWNrZXQge1xuICAvKipcbiAgICogSWYgdGhlIGJ1Y2tldCBpcyBhbiBBV1MgQnVja2V0LCByZXR1cm4gYSBoZWxwZXIgaW50ZXJmYWNlIGZvclxuICAgKiB3b3JraW5nIHdpdGggaXQuXG4gICAqIEBwYXJhbSBidWNrZXQgVGhlIGNsb3VkLkJ1Y2tldC5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZnJvbShidWNrZXQ6IGNsb3VkLkJ1Y2tldCk6IElBd3NCdWNrZXQgfCB1bmRlZmluZWQge1xuICAgIGlmICh0aGlzLmlzQXdzQnVja2V0KGJ1Y2tldCkpIHtcbiAgICAgIHJldHVybiBidWNrZXQ7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBpc0F3c0J1Y2tldChvYmo6IGFueSk6IG9iaiBpcyBJQXdzQnVja2V0IHtcbiAgICByZXR1cm4gKFxuICAgICAgdHlwZW9mIG9iai5idWNrZXRBcm4gPT09IFwic3RyaW5nXCIgJiYgdHlwZW9mIG9iai5idWNrZXROYW1lID09PSBcInN0cmluZ1wiXG4gICAgKTtcbiAgfVxufVxuXG4vKipcbiAqIEEgZmV3IGluZmxpZ2h0IG1ldGhvZHMgdGhhdCBjYW4gYmUgdXNlZCB3aXRoIGFuIEFXUyBidWNrZXQuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUF3c0J1Y2tldENsaWVudCBleHRlbmRzIGNsb3VkLklCdWNrZXRDbGllbnQge1xuICAvKipcbiAgICogR2V0IHRoZSByZWdpb24gb2YgdGhlIGJ1Y2tldC5cbiAgICogQGluZmxpZ2h0XG4gICAqL1xuICBidWNrZXRSZWdpb24oKTogUHJvbWlzZTxzdHJpbmc+O1xufVxuXG4vKipcbiAqIEEgcmVmZXJlbmNlIHRvIGFuIGV4dGVybmFsIFMzIGJ1Y2tldC5cbiAqIEBpbmZsaWdodCBgQHdpbmdsYW5nL3Nkay5hd3MuSUF3c0J1Y2tldENsaWVudGBcbiAqL1xuZXhwb3J0IGNsYXNzIEJ1Y2tldFJlZiBleHRlbmRzIFJlc291cmNlIHtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgW0lORkxJR0hUX1NZTUJPTF0/OiBJQXdzQnVja2V0Q2xpZW50O1xuXG4gIC8qKlxuICAgKiBUaGUgTmFtZSBvZiB0aGlzIGJ1Y2tldC5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBidWNrZXROYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhpcyBidWNrZXQuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgYnVja2V0QXJuOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgYnVja2V0TmFtZTogc3RyaW5nKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIHRoaXMuYnVja2V0TmFtZSA9IGJ1Y2tldE5hbWU7XG4gICAgdGhpcy5idWNrZXRBcm4gPSBgYXJuOmF3czpzMzo6OiR7YnVja2V0TmFtZX1gO1xuXG4gICAgdGhpcy5hZGRVc2VySW50ZXJmYWNlKCk7XG4gIH1cblxuICBwdWJsaWMgb25MaWZ0KGhvc3Q6IElJbmZsaWdodEhvc3QsIG9wczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICBpZiAoQXdzSW5mbGlnaHRIb3N0LmlzQXdzSW5mbGlnaHRIb3N0KGhvc3QpKSB7XG4gICAgICBob3N0LmFkZFBvbGljeVN0YXRlbWVudHMoXG4gICAgICAgIC4uLmNhbGN1bGF0ZUJ1Y2tldFBlcm1pc3Npb25zKHRoaXMuYnVja2V0QXJuLCBvcHMpXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFRoZSBidWNrZXQgbmFtZSBuZWVkcyB0byBiZSBwYXNzZWQgdGhyb3VnaCBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSBzaW5jZVxuICAgIC8vIGl0IG1heSBub3QgYmUgcmVzb2x2ZWQgdW50aWwgZGVwbG95bWVudCB0aW1lLlxuICAgIGhvc3QuYWRkRW52aXJvbm1lbnQodGhpcy5lbnZOYW1lKCksIHRoaXMuYnVja2V0TmFtZSk7XG5cbiAgICBzdXBlci5vbkxpZnQoaG9zdCwgb3BzKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIF90b0luZmxpZ2h0KCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIEluZmxpZ2h0Q2xpZW50LmZvcihfX2Rpcm5hbWUsIF9fZmlsZW5hbWUsIFwiQnVja2V0Q2xpZW50XCIsIFtcbiAgICAgIGBwcm9jZXNzLmVudltcIiR7dGhpcy5lbnZOYW1lKCl9XCJdYCxcbiAgICBdKTtcbiAgfVxuXG4gIHByaXZhdGUgZW52TmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgQlVDS0VUX05BTUVfJHt0aGlzLm5vZGUuYWRkci5zbGljZSgtOCl9YDtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIGdldCBfbGlmdE1hcCgpOiBMaWZ0TWFwIHtcbiAgICByZXR1cm4ge1xuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5ERUxFVEVdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuR0VUXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkdFVF9KU09OXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkxJU1RdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuUFVUXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlBVVF9KU09OXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlBVQkxJQ19VUkxdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuRVhJU1RTXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlRSWV9HRVRdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0dFVF9KU09OXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlRSWV9ERUxFVEVdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuU0lHTkVEX1VSTF06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5NRVRBREFUQV06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5DT1BZXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlJFTkFNRV06IFtdLFxuICAgICAgYnVja2V0UmVnaW9uOiBbXSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRVc2VySW50ZXJmYWNlKCkge1xuICAgIE5vZGUub2YodGhpcykuY29sb3IgPSBcImFtYmVyXCI7XG5cbiAgICBjb25zdCBhd3NDb25zb2xlSGFuZGxlciA9IGxpZnQoe1xuICAgICAgYnVja2V0OiB0aGlzLFxuICAgICAgYnVja2V0TmFtZTogdGhpcy5idWNrZXROYW1lLFxuICAgIH0pLmluZmxpZ2h0KGFzeW5jIChjdHgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlZ2lvbiA9IGF3YWl0IGN0eC5idWNrZXQuYnVja2V0UmVnaW9uKCk7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgXCJodHRwczovL1wiICtcbiAgICAgICAgICByZWdpb24gK1xuICAgICAgICAgIFwiLmNvbnNvbGUuYXdzLmFtYXpvbi5jb20vczMvYnVja2V0cy9cIiArXG4gICAgICAgICAgY3R4LmJ1Y2tldE5hbWUgK1xuICAgICAgICAgIFwiP3JlZ2lvbj1cIiArXG4gICAgICAgICAgcmVnaW9uXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIGUubWVzc2FnZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIG5ldyB1aS5GaWVsZCh0aGlzLCBcIkF3c0NvbnNvbGVGaWVsZFwiLCBcIkFXUyBDb25zb2xlXCIsIGF3c0NvbnNvbGVIYW5kbGVyLCB7XG4gICAgICBsaW5rOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgbmV3IHVpLlZhbHVlRmllbGQodGhpcywgXCJCdWNrZXROYW1lRmllbGRcIiwgXCJCdWNrZXQgTmFtZVwiLCB0aGlzLmJ1Y2tldE5hbWUpO1xuICAgIG5ldyB1aS5WYWx1ZUZpZWxkKHRoaXMsIFwiQnVja2V0QXJuRmllbGRcIiwgXCJCdWNrZXQgQVJOXCIsIHRoaXMuYnVja2V0QXJuKTtcbiAgICBuZXcgdWkuRmlsZUJyb3dzZXIodGhpcywgXCJGaWxlQnJvd3NlclwiLCBcIkZpbGUgQnJvd3NlclwiLCB7XG4gICAgICBwdXQ6IGxpZnQoeyBidWNrZXQ6IHRoaXMgfSkuaW5mbGlnaHQoXG4gICAgICAgIGFzeW5jIChjdHgsIGZpbGVOYW1lLCBmaWxlQ29udGVudCkgPT4ge1xuICAgICAgICAgIGF3YWl0IGN0eC5idWNrZXQucHV0KGZpbGVOYW1lLCBmaWxlQ29udGVudCk7XG4gICAgICAgIH1cbiAgICAgICksXG4gICAgICBnZXQ6IGxpZnQoeyBidWNrZXQ6IHRoaXMgfSkuaW5mbGlnaHQoYXN5bmMgKGN0eCwgZmlsZU5hbWUpID0+IHtcbiAgICAgICAgcmV0dXJuIGN0eC5idWNrZXQuZ2V0KGZpbGVOYW1lKTtcbiAgICAgIH0pLFxuICAgICAgZGVsZXRlOiBsaWZ0KHsgYnVja2V0OiB0aGlzIH0pLmluZmxpZ2h0KGFzeW5jIChjdHgsIGZpbGVOYW1lKSA9PiB7XG4gICAgICAgIGF3YWl0IGN0eC5idWNrZXQuZGVsZXRlKGZpbGVOYW1lKTtcbiAgICAgIH0pLFxuICAgICAgbGlzdDogbGlmdCh7IGJ1Y2tldDogdGhpcyB9KS5pbmZsaWdodChhc3luYyAoY3R4KSA9PiB7XG4gICAgICAgIHJldHVybiBjdHguYnVja2V0Lmxpc3QoKTtcbiAgICAgIH0pLFxuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogVXRpbGl0eSBjbGFzcyB0byB3b3JrIHdpdGggYnVja2V0IGV2ZW50IGhhbmRsZXJzLlxuICovXG5leHBvcnQgY2xhc3MgQnVja2V0RXZlbnRIYW5kbGVyIHtcbiAgLyoqXG4gICAqIENvbnZlcnRzIGEgYGNsb3VkLklCdWNrZXRFdmVudEhhbmRsZXJgIHRvIGEgYGNsb3VkLklUb3BpY09uTWVzc2FnZUhhbmRsZXJgLlxuICAgKiBAcGFyYW0gaGFuZGxlciB0aGUgaGFuZGxlciB0byBjb252ZXJ0XG4gICAqIEBwYXJhbSBldmVudFR5cGUgdGhlIGV2ZW50IHR5cGVcbiAgICogQHJldHVybnMgdGhlIG9uIG1lc3NhZ2UgaGFuZGxlci5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgdG9Ub3BpY09uTWVzc2FnZUhhbmRsZXIoXG4gICAgaGFuZGxlcjogY2xvdWQuSUJ1Y2tldEV2ZW50SGFuZGxlcixcbiAgICBldmVudFR5cGU6IGNsb3VkLkJ1Y2tldEV2ZW50VHlwZVxuICApOiBjbG91ZC5JVG9waWNPbk1lc3NhZ2VIYW5kbGVyIHtcbiAgICByZXR1cm4gbGlmdCh7IGhhbmRsZXIsIGV2ZW50VHlwZSB9KS5pbmZsaWdodChhc3luYyAoY3R4LCBldmVudCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IEpTT04ucGFyc2UoZXZlbnQpO1xuICAgICAgICBpZiAobWVzc2FnZT8uRXZlbnQgPT09IFwiczM6VGVzdEV2ZW50XCIpIHtcbiAgICAgICAgICAvLyBhd3Mgc2VuZHMgYSB0ZXN0IGV2ZW50IHRvIHRoZSB0b3BpYyBiZWZvcmUgb2YgdGhlIGFjdHVhbCBvbmUsIHdlJ3JlIGlnbm9yaW5nIGl0IGZvciBub3dcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGF3YWl0IGN0eC5oYW5kbGVyKFxuICAgICAgICAgIG1lc3NhZ2UuUmVjb3Jkc1swXS5zMy5vYmplY3Qua2V5LFxuICAgICAgICAgIGN0eC5ldmVudFR5cGVcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihcIkVycm9yIHBhcnNpbmcgdGhlIG5vdGlmaWNhdGlvbiBldmVudCBtZXNzYWdlOiBcIiwgZXJyb3IpO1xuICAgICAgICBjb25zb2xlLndhcm4oXCJFdmVudDogXCIsIGV2ZW50KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIl19