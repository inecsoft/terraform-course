"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.calculateSecretPermissions = exports.calculateBucketPermissions = exports.calculateCounterPermissions = exports.calculateQueuePermissions = exports.calculateTopicPermissions = void 0;
const cloud = __importStar(require("../cloud"));
function calculateTopicPermissions(arn, ops) {
    const policies = [];
    if (ops.includes(cloud.TopicInflightMethods.PUBLISH)) {
        policies.push({
            actions: ["sns:Publish"],
            resources: [arn],
        });
    }
    return policies;
}
exports.calculateTopicPermissions = calculateTopicPermissions;
function calculateQueuePermissions(arn, ops) {
    const policies = [];
    // this is always needed in order to resolve URL from ARN/name
    policies.push({
        actions: ["sqs:GetQueueUrl"],
        resources: [arn],
    });
    if (ops.includes(cloud.QueueInflightMethods.PUSH)) {
        policies.push({
            actions: ["sqs:SendMessage"],
            resources: [arn],
        });
    }
    if (ops.includes(cloud.QueueInflightMethods.PURGE)) {
        policies.push({
            actions: ["sqs:PurgeQueue"],
            resources: [arn],
        });
    }
    if (ops.includes(cloud.QueueInflightMethods.APPROX_SIZE)) {
        policies.push({
            actions: ["sqs:GetQueueAttributes"],
            resources: [arn],
        });
    }
    if (ops.includes(cloud.QueueInflightMethods.POP)) {
        policies.push({
            actions: ["sqs:ReceiveMessage", "sqs:DeleteMessage"],
            resources: [arn],
        });
    }
    return policies;
}
exports.calculateQueuePermissions = calculateQueuePermissions;
function calculateCounterPermissions(arn, ops) {
    const policies = [];
    if (ops.includes(cloud.CounterInflightMethods.INC) ||
        ops.includes(cloud.CounterInflightMethods.DEC) ||
        ops.includes(cloud.CounterInflightMethods.SET)) {
        policies.push({
            actions: ["dynamodb:UpdateItem"],
            resources: [arn],
        });
    }
    if (ops.includes(cloud.CounterInflightMethods.PEEK)) {
        policies.push({
            actions: ["dynamodb:GetItem"],
            resources: [arn],
        });
    }
    return policies;
}
exports.calculateCounterPermissions = calculateCounterPermissions;
function calculateBucketPermissions(arn, ops) {
    const actions = [];
    // const policies: PolicyStatement[] = [];
    // contains a check if an object exists/list
    if (ops.includes(cloud.BucketInflightMethods.PUBLIC_URL) ||
        ops.includes(cloud.BucketInflightMethods.SIGNED_URL) ||
        ops.includes(cloud.BucketInflightMethods.LIST) ||
        ops.includes(cloud.BucketInflightMethods.EXISTS) ||
        ops.includes(cloud.BucketInflightMethods.TRY_GET) ||
        ops.includes(cloud.BucketInflightMethods.TRY_GET_JSON) ||
        ops.includes(cloud.BucketInflightMethods.TRY_DELETE) ||
        // get requires list permissions too https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/s3/command/GetObjectCommand/
        ops.includes(cloud.BucketInflightMethods.GET) ||
        ops.includes(cloud.BucketInflightMethods.GET_JSON)) {
        actions.push("s3:List*");
    }
    // putting an object
    if (ops.includes(cloud.BucketInflightMethods.PUT) ||
        ops.includes(cloud.BucketInflightMethods.PUT_JSON) ||
        ops.includes(cloud.BucketInflightMethods.SIGNED_URL)) {
        actions.push("s3:PutObject*", "s3:Abort*");
    }
    // getting an object
    if (ops.includes(cloud.BucketInflightMethods.GET) ||
        ops.includes(cloud.BucketInflightMethods.GET_JSON) ||
        ops.includes(cloud.BucketInflightMethods.METADATA) ||
        ops.includes(cloud.BucketInflightMethods.LIST) ||
        ops.includes(cloud.BucketInflightMethods.TRY_GET) ||
        ops.includes(cloud.BucketInflightMethods.TRY_GET_JSON) ||
        ops.includes(cloud.BucketInflightMethods.TRY_DELETE) ||
        ops.includes(cloud.BucketInflightMethods.PUBLIC_URL) ||
        ops.includes(cloud.BucketInflightMethods.SIGNED_URL) ||
        ops.includes(cloud.BucketInflightMethods.EXISTS)) {
        actions.push("s3:GetObject*", "s3:GetBucket*");
    }
    // accessing the publicAccessBlock
    if (ops.includes(cloud.BucketInflightMethods.PUBLIC_URL)) {
        actions.push("s3:GetBucketPublicAccessBlock");
    }
    // deleting an object
    if (ops.includes(cloud.BucketInflightMethods.TRY_DELETE) ||
        ops.includes(cloud.BucketInflightMethods.DELETE) ||
        ops.includes(cloud.BucketInflightMethods.RENAME)) {
        actions.push("s3:DeleteObject*", "s3:DeleteObjectVersion*", "s3:PutLifecycleConfiguration*");
    }
    // copying an object
    if (ops.includes(cloud.BucketInflightMethods.COPY) ||
        ops.includes(cloud.BucketInflightMethods.RENAME)) {
        actions.push("s3:CopyObject");
    }
    if (actions.length === 0) {
        return [];
    }
    return [{ actions, resources: [arn, `${arn}/*`] }];
}
exports.calculateBucketPermissions = calculateBucketPermissions;
function calculateSecretPermissions(arn, ops) {
    const policies = [];
    if (ops.includes(cloud.SecretInflightMethods.VALUE) ||
        ops.includes(cloud.SecretInflightMethods.VALUE_JSON)) {
        policies.push({
            actions: ["secretsmanager:GetSecretValue"],
            resources: [arn],
        });
    }
    return policies;
}
exports.calculateSecretPermissions = calculateSecretPermissions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2hhcmVkLWF3cy9wZXJtaXNzaW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLGdEQUFrQztBQUVsQyxTQUFnQix5QkFBeUIsQ0FDdkMsR0FBVyxFQUNYLEdBQWE7SUFFYixNQUFNLFFBQVEsR0FBc0IsRUFBRSxDQUFDO0lBRXZDLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztRQUNyRCxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ1osT0FBTyxFQUFFLENBQUMsYUFBYSxDQUFDO1lBQ3hCLFNBQVMsRUFBRSxDQUFDLEdBQUcsQ0FBQztTQUNqQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxRQUFRLENBQUM7QUFDbEIsQ0FBQztBQWRELDhEQWNDO0FBRUQsU0FBZ0IseUJBQXlCLENBQ3ZDLEdBQVcsRUFDWCxHQUFhO0lBRWIsTUFBTSxRQUFRLEdBQXNCLEVBQUUsQ0FBQztJQUV2Qyw4REFBOEQ7SUFDOUQsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNaLE9BQU8sRUFBRSxDQUFDLGlCQUFpQixDQUFDO1FBQzVCLFNBQVMsRUFBRSxDQUFDLEdBQUcsQ0FBQztLQUNqQixDQUFDLENBQUM7SUFFSCxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDbEQsUUFBUSxDQUFDLElBQUksQ0FBQztZQUNaLE9BQU8sRUFBRSxDQUFDLGlCQUFpQixDQUFDO1lBQzVCLFNBQVMsRUFBRSxDQUFDLEdBQUcsQ0FBQztTQUNqQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMs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QUFnQiwwQkFBMEIsQ0FDeEMsR0FBVyxFQUNYLEdBQWE7SUFFYixNQUFNLFFBQVEsR0FBc0IsRUFBRSxDQUFDO0lBRXZDLElBQ0UsR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDO1FBQy9DLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxFQUNwRCxDQUFDO1FBQ0QsUUFBUSxDQUFDLElBQUksQ0FBQztZQUNaLE9BQU8sRUFBRSxDQUFDLCtCQUErQixDQUFDO1lBQzFDLFNBQVMsRUFBRSxDQUFDLEdBQUcsQ0FBQztTQUNqQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxRQUFRLENBQUM7QUFDbEIsQ0FBQztBQWpCRCxnRUFpQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tIFwiLi90eXBlc1wiO1xuaW1wb3J0ICogYXMgY2xvdWQgZnJvbSBcIi4uL2Nsb3VkXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVUb3BpY1Blcm1pc3Npb25zKFxuICBhcm46IHN0cmluZyxcbiAgb3BzOiBzdHJpbmdbXVxuKTogUG9saWN5U3RhdGVtZW50W10ge1xuICBjb25zdCBwb2xpY2llczogUG9saWN5U3RhdGVtZW50W10gPSBbXTtcblxuICBpZiAob3BzLmluY2x1ZGVzKGNsb3VkLlRvcGljSW5mbGlnaHRNZXRob2RzLlBVQkxJU0gpKSB7XG4gICAgcG9saWNpZXMucHVzaCh7XG4gICAgICBhY3Rpb25zOiBbXCJzbnM6UHVibGlzaFwiXSxcbiAgICAgIHJlc291cmNlczogW2Fybl0sXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcG9saWNpZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVRdWV1ZVBlcm1pc3Npb25zKFxuICBhcm46IHN0cmluZyxcbiAgb3BzOiBzdHJpbmdbXVxuKTogUG9saWN5U3RhdGVtZW50W10ge1xuICBjb25zdCBwb2xpY2llczogUG9saWN5U3RhdGVtZW50W10gPSBbXTtcblxuICAvLyB0aGlzIGlzIGFsd2F5cyBuZWVkZWQgaW4gb3JkZXIgdG8gcmVzb2x2ZSBVUkwgZnJvbSBBUk4vbmFtZVxuICBwb2xpY2llcy5wdXNoKHtcbiAgICBhY3Rpb25zOiBbXCJzcXM6R2V0UXVldWVVcmxcIl0sXG4gICAgcmVzb3VyY2VzOiBbYXJuXSxcbiAgfSk7XG5cbiAgaWYgKG9wcy5pbmNsdWRlcyhjbG91ZC5RdWV1ZUluZmxpZ2h0TWV0aG9kcy5QVVNIKSkge1xuICAgIHBvbGljaWVzLnB1c2goe1xuICAgICAgYWN0aW9uczogW1wic3FzOlNlbmRNZXNzYWdlXCJdLFxuICAgICAgcmVzb3VyY2VzOiBbYXJuXSxcbiAgICB9KTtcbiAgfVxuXG4gIGlmIChvcHMuaW5jbHVkZXMoY2xvdWQuUXVldWVJbmZsaWdodE1ldGhvZHMuUFVSR0UpKSB7XG4gICAgcG9saWNpZXMucHVzaCh7XG4gICAgICBhY3Rpb25zOiBbXCJzcXM6UHVyZ2VRdWV1ZVwiXSxcbiAgICAgIHJlc291cmNlczogW2Fybl0sXG4gICAgfSk7XG4gIH1cblxuICBpZiAob3BzLmluY2x1ZGVzKGNsb3VkLlF1ZXVlSW5mbGlnaHRNZXRob2RzLkFQUFJPWF9TSVpFKSkge1xuICAgIHBvbGljaWVzLnB1c2goe1xuICAgICAgYWN0aW9uczogW1wic3FzOkdldFF1ZXVlQXR0cmlidXRlc1wiXSxcbiAgICAgIHJlc291cmNlczogW2Fybl0sXG4gICAgfSk7XG4gIH1cblxuICBpZiAob3BzLmluY2x1ZGVzKGNsb3VkLlF1ZXVlSW5mbGlnaHRNZXRob2RzLlBPUCkpIHtcbiAgICBwb2xpY2llcy5wdXNoKHtcbiAgICAgIGFjdGlvbnM6IFtcInNxczpSZWNlaXZlTWVzc2FnZVwiLCBcInNxczpEZWxldGVNZXNzYWdlXCJdLFxuICAgICAgcmVzb3VyY2VzOiBbYXJuXSxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBwb2xpY2llcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZUNvdW50ZXJQZXJtaXNzaW9ucyhcbiAgYXJuOiBzdHJpbmcsXG4gIG9wczogc3RyaW5nW11cbik6IFBvbGljeVN0YXRlbWVudFtdIHtcbiAgY29uc3QgcG9saWNpZXM6IFBvbGljeVN0YXRlbWVudFtdID0gW107XG5cbiAgaWYgKFxuICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5Db3VudGVySW5mbGlnaHRNZXRob2RzLklOQykgfHxcbiAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQ291bnRlckluZmxpZ2h0TWV0aG9kcy5ERUMpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkNvdW50ZXJJbmZsaWdodE1ldGhvZHMuU0VUKVxuICApIHtcbiAgICBwb2xpY2llcy5wdXNoKHtcbiAgICAgIGFjdGlvbnM6IFtcImR5bmFtb2RiOlVwZGF0ZUl0ZW1cIl0sXG4gICAgICByZXNvdXJjZXM6IFthcm5dLFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKG9wcy5pbmNsdWRlcyhjbG91ZC5Db3VudGVySW5mbGlnaHRNZXRob2RzLlBFRUspKSB7XG4gICAgcG9saWNpZXMucHVzaCh7XG4gICAgICBhY3Rpb25zOiBbXCJkeW5hbW9kYjpHZXRJdGVtXCJdLFxuICAgICAgcmVzb3VyY2VzOiBbYXJuXSxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBwb2xpY2llcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZUJ1Y2tldFBlcm1pc3Npb25zKFxuICBhcm46IHN0cmluZyxcbiAgb3BzOiBzdHJpbmdbXVxuKTogUG9saWN5U3RhdGVtZW50W10ge1xuICBjb25zdCBhY3Rpb25zOiBzdHJpbmdbXSA9IFtdO1xuICAvLyBjb25zdCBwb2xpY2llczogUG9saWN5U3RhdGVtZW50W10gPSBbXTtcblxuICAvLyBjb250YWlucyBhIGNoZWNrIGlmIGFuIG9iamVjdCBleGlzdHMvbGlzdFxuICBpZiAoXG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5QVUJMSUNfVVJMKSB8fFxuICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuU0lHTkVEX1VSTCkgfHxcbiAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkxJU1QpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5FWElTVFMpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5UUllfR0VUKSB8fFxuICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0dFVF9KU09OKSB8fFxuICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0RFTEVURSkgfHxcbiAgICAvLyBnZXQgcmVxdWlyZXMgbGlzdCBwZXJtaXNzaW9ucyB0b28gaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL0FXU0phdmFTY3JpcHRTREsvdjMvbGF0ZXN0L2NsaWVudC9zMy9jb21tYW5kL0dldE9iamVjdENvbW1hbmQvXG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5HRVQpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5HRVRfSlNPTilcbiAgKSB7XG4gICAgYWN0aW9ucy5wdXNoKFwiczM6TGlzdCpcIik7XG4gIH1cblxuICAvLyBwdXR0aW5nIGFuIG9iamVjdFxuICBpZiAoXG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5QVVQpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5QVVRfSlNPTikgfHxcbiAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlNJR05FRF9VUkwpXG4gICkge1xuICAgIGFjdGlvbnMucHVzaChcInMzOlB1dE9iamVjdCpcIiwgXCJzMzpBYm9ydCpcIik7XG4gIH1cblxuICAvLyBnZXR0aW5nIGFuIG9iamVjdFxuICBpZiAoXG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5HRVQpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5HRVRfSlNPTikgfHxcbiAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLk1FVEFEQVRBKSB8fFxuICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuTElTVCkgfHxcbiAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlRSWV9HRVQpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5UUllfR0VUX0pTT04pIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5UUllfREVMRVRFKSB8fFxuICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuUFVCTElDX1VSTCkgfHxcbiAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlNJR05FRF9VUkwpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5FWElTVFMpXG4gICkge1xuICAgIGFjdGlvbnMucHVzaChcInMzOkdldE9iamVjdCpcIiwgXCJzMzpHZXRCdWNrZXQqXCIpO1xuICB9XG5cbiAgLy8gYWNjZXNzaW5nIHRoZSBwdWJsaWNBY2Nlc3NCbG9ja1xuICBpZiAob3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5QVUJMSUNfVVJMKSkge1xuICAgIGFjdGlvbnMucHVzaChcInMzOkdldEJ1Y2tldFB1YmxpY0FjY2Vzc0Jsb2NrXCIpO1xuICB9XG5cbiAgLy8gZGVsZXRpbmcgYW4gb2JqZWN0XG4gIGlmIChcbiAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlRSWV9ERUxFVEUpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5ERUxFVEUpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5SRU5BTUUpXG4gICkge1xuICAgIGFjdGlvbnMucHVzaChcbiAgICAgIFwiczM6RGVsZXRlT2JqZWN0KlwiLFxuICAgICAgXCJzMzpEZWxldGVPYmplY3RWZXJzaW9uKlwiLFxuICAgICAgXCJzMzpQdXRMaWZlY3ljbGVDb25maWd1cmF0aW9uKlwiXG4gICAgKTtcbiAgfVxuXG4gIC8vIGNvcHlpbmcgYW4gb2JqZWN0XG4gIGlmIChcbiAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkNPUFkpIHx8XG4gICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5SRU5BTUUpXG4gICkge1xuICAgIGFjdGlvbnMucHVzaChcInMzOkNvcHlPYmplY3RcIik7XG4gIH1cbiAgaWYgKGFjdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIHJldHVybiBbeyBhY3Rpb25zLCByZXNvdXJjZXM6IFthcm4sIGAke2Fybn0vKmBdIH1dO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlU2VjcmV0UGVybWlzc2lvbnMoXG4gIGFybjogc3RyaW5nLFxuICBvcHM6IHN0cmluZ1tdXG4pOiBQb2xpY3lTdGF0ZW1lbnRbXSB7XG4gIGNvbnN0IHBvbGljaWVzOiBQb2xpY3lTdGF0ZW1lbnRbXSA9IFtdO1xuXG4gIGlmIChcbiAgICBvcHMuaW5jbHVkZXMoY2xvdWQuU2VjcmV0SW5mbGlnaHRNZXRob2RzLlZBTFVFKSB8fFxuICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5TZWNyZXRJbmZsaWdodE1ldGhvZHMuVkFMVUVfSlNPTilcbiAgKSB7XG4gICAgcG9saWNpZXMucHVzaCh7XG4gICAgICBhY3Rpb25zOiBbXCJzZWNyZXRzbWFuYWdlcjpHZXRTZWNyZXRWYWx1ZVwiXSxcbiAgICAgIHJlc291cmNlczogW2Fybl0sXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcG9saWNpZXM7XG59XG4iXX0=