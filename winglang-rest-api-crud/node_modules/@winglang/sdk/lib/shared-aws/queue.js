"use strict";
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.QueueSetConsumerHandler = exports.QueueRef = exports.Queue = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const inflight_host_1 = require("./inflight-host");
const permissions_1 = require("./permissions");
const util_1 = require("./util");
const __1 = require("..");
const core_1 = require("../core");
const types_1 = require("../core/types");
const std_1 = require("../std");
/**
 * A helper class for working with AWS queues.
 */
class Queue {
    /**
     * If the queue is an AWS SQS, return a helper interface for
     * working with it.
     * @param queue The cloud.Queue.
     */
    static from(queue) {
        if (this.isAwsQueue(queue)) {
            return queue;
        }
        return undefined;
    }
    static isAwsQueue(obj) {
        return (typeof obj.queueArn === "string" &&
            typeof obj.queueName === "string" &&
            typeof obj.queueUrl === "string");
    }
}
exports.Queue = Queue;
_a = JSII_RTTI_SYMBOL_1;
Queue[_a] = { fqn: "@winglang/sdk.aws.Queue", version: "0.0.0" };
/**
 * A reference to an external SQS queue.
 *
 * @inflight `@winglang/sdk.aws.IAwsQueueClient`
 */
class QueueRef extends std_1.Resource {
    constructor(scope, id, queueArn) {
        super(scope, id);
        if (!(0, util_1.isValidArn)(queueArn, "sqs")) {
            throw new Error(`"${queueArn}" is not a valid Amazon SQS ARN`);
        }
        this.queueArn = queueArn;
        this.addUserInterface();
    }
    onLift(host, ops) {
        // if this is an AWS function, add the necessary IAM permissions
        if (inflight_host_1.AwsInflightHost.isAwsInflightHost(host)) {
            host.addPolicyStatements(...(0, permissions_1.calculateQueuePermissions)(this.queueArn, ops));
        }
        host.addEnvironment(this.envName(), this.queueArn);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core_1.InflightClient.for(__dirname, __filename, "QueueClient", [
            `process.env["${this.envName()}"]`,
        ]);
    }
    envName() {
        return `QUEUE_ARN_${this.node.addr.slice(-8)}`;
    }
    /** @internal */
    get _liftMap() {
        return {
            ["queueUrl"]: [], // AWS-specific
            [__1.cloud.QueueInflightMethods.PUSH]: [],
            [__1.cloud.QueueInflightMethods.PURGE]: [],
            [__1.cloud.QueueInflightMethods.APPROX_SIZE]: [],
            [__1.cloud.QueueInflightMethods.POP]: [],
        };
    }
    addUserInterface() {
        std_1.Node.of(this).color = "pink";
        const queueUrlHandler = (0, core_1.lift)({ queue: this }).inflight(async (ctx) => {
            try {
                return await ctx.queue.queueUrl();
            }
            catch (e) {
                return e.message;
            }
        });
        new __1.ui.Field(this, "QueueUrlField", "SQS Queue URL", queueUrlHandler, {
            link: true,
        });
        const awsConsoleHandler = (0, core_1.lift)({ queue: this }).inflight(async (ctx) => {
            try {
                const url = await ctx.queue.queueUrl();
                const x = new URL(url);
                const region = x.hostname.split(".")[1];
                return ("https://" +
                    region +
                    ".console.aws.amazon.com/sqs/v3/home?region=" +
                    region +
                    "#/queues/" +
                    encodeURIComponent(url));
            }
            catch (e) {
                return e.message;
            }
        });
        new __1.ui.Field(this, "AwsConsoleField", "AWS Console", awsConsoleHandler, {
            link: true,
        });
        new __1.ui.ValueField(this, "QueueArnField", "SQS Queue ARN", this.queueArn);
    }
}
exports.QueueRef = QueueRef;
_b = JSII_RTTI_SYMBOL_1;
QueueRef[_b] = { fqn: "@winglang/sdk.aws.QueueRef", version: "0.0.0" };
/**
 * Utility class for working with the queue consumer handler.
 */
class QueueSetConsumerHandler {
    /**
     * Converts a queue consumer handler to a function handler.
     * @param handler The queue consumer handler.
     * @returns The function handler.
     */
    static toFunctionHandler(handler) {
        return (0, core_1.lift)({ handler }).inflight(async (ctx, event) => {
            const batchItemFailures = [];
            for (const record of event.Records ?? []) {
                try {
                    await ctx.handler(record.body);
                }
                catch (error) {
                    batchItemFailures.push({
                        itemIdentifier: record.messageId,
                    });
                }
            }
            return { batchItemFailures };
        });
    }
}
exports.QueueSetConsumerHandler = QueueSetConsumerHandler;
_c = JSII_RTTI_SYMBOL_1;
QueueSetConsumerHandler[_c] = { fqn: "@winglang/sdk.aws.QueueSetConsumerHandler", version: "0.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVldWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2hhcmVkLWF3cy9xdWV1ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLG1EQUFrRDtBQUNsRCwrQ0FBMEQ7QUFDMUQsaUNBQW9DO0FBQ3BDLDBCQUErQjtBQUMvQixrQ0FBd0Q7QUFDeEQseUNBQWdEO0FBQ2hELGdDQUF1RDtBQXNCdkQ7O0dBRUc7QUFDSCxNQUFhLEtBQUs7SUFDaEI7Ozs7T0FJRztJQUNJLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBa0I7UUFDbkMsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDM0IsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVPLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBUTtRQUNoQyxPQUFPLENBQ0wsT0FBTyxHQUFHLENBQUMsUUFBUSxLQUFLLFFBQVE7WUFDaEMsT0FBTyxHQUFHLENBQUMsU0FBUyxLQUFLLFFBQVE7WUFDakMsT0FBTyxHQUFHLENBQUMsUUFBUSxLQUFLLFFBQVEsQ0FDakMsQ0FBQztJQUNKLENBQUM7O0FBbkJILHNCQW9CQzs7O0FBYUQ7Ozs7R0FJRztBQUNILE1BQWEsUUFBUyxTQUFRLGNBQVE7SUFTcEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxRQUFnQjtRQUN4RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxJQUFBLGlCQUFVLEVBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDakMsTUFBTSxJQUFJLEtBQUssQ0FBQyxJQUFJLFFBQVEsaUNBQWlDLENBQUMsQ0FBQztRQUNqRSxDQUFDO1FBRUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFFekIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDMUIsQ0FB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c3RydWN0c1wiO1xuaW1wb3J0IHsgQXdzSW5mbGlnaHRIb3N0IH0gZnJvbSBcIi4vaW5mbGlnaHQtaG9zdFwiO1xuaW1wb3J0IHsgY2FsY3VsYXRlUXVldWVQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3Blcm1pc3Npb25zXCI7XG5pbXBvcnQgeyBpc1ZhbGlkQXJuIH0gZnJvbSBcIi4vdXRpbFwiO1xuaW1wb3J0IHsgY2xvdWQsIHVpIH0gZnJvbSBcIi4uXCI7XG5pbXBvcnQgeyBJbmZsaWdodENsaWVudCwgbGlmdCwgTGlmdE1hcCB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBJTkZMSUdIVF9TWU1CT0wgfSBmcm9tIFwiLi4vY29yZS90eXBlc1wiO1xuaW1wb3J0IHsgSUluZmxpZ2h0SG9zdCwgTm9kZSwgUmVzb3VyY2UgfSBmcm9tIFwiLi4vc3RkXCI7XG5cbi8qKlxuICogQSBzaGFyZWQgaW50ZXJmYWNlIGZvciBBV1MgcXVldWVzLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIElBd3NRdWV1ZSB7XG4gIC8qKlxuICAgKiBBV1MgUXVldWUgYXJuXG4gICAqL1xuICByZWFkb25seSBxdWV1ZUFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBBV1MgUXVldWUgbmFtZVxuICAgKi9cbiAgcmVhZG9ubHkgcXVldWVOYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEFXUyBRdWV1ZSB1cmxcbiAgICovXG4gIHJlYWRvbmx5IHF1ZXVlVXJsOiBzdHJpbmc7XG59XG5cbi8qKlxuICogQSBoZWxwZXIgY2xhc3MgZm9yIHdvcmtpbmcgd2l0aCBBV1MgcXVldWVzLlxuICovXG5leHBvcnQgY2xhc3MgUXVldWUge1xuICAvKipcbiAgICogSWYgdGhlIHF1ZXVlIGlzIGFuIEFXUyBTUVMsIHJldHVybiBhIGhlbHBlciBpbnRlcmZhY2UgZm9yXG4gICAqIHdvcmtpbmcgd2l0aCBpdC5cbiAgICogQHBhcmFtIHF1ZXVlIFRoZSBjbG91ZC5RdWV1ZS5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZnJvbShxdWV1ZTogY2xvdWQuUXVldWUpOiBJQXdzUXVldWUgfCB1bmRlZmluZWQge1xuICAgIGlmICh0aGlzLmlzQXdzUXVldWUocXVldWUpKSB7XG4gICAgICByZXR1cm4gcXVldWU7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBpc0F3c1F1ZXVlKG9iajogYW55KTogb2JqIGlzIElBd3NRdWV1ZSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHR5cGVvZiBvYmoucXVldWVBcm4gPT09IFwic3RyaW5nXCIgJiZcbiAgICAgIHR5cGVvZiBvYmoucXVldWVOYW1lID09PSBcInN0cmluZ1wiICYmXG4gICAgICB0eXBlb2Ygb2JqLnF1ZXVlVXJsID09PSBcInN0cmluZ1wiXG4gICAgKTtcbiAgfVxufVxuXG4vKipcbiAqIFRoZSBpbmZsaWdodCBBUEkgZm9yIEFXUyBxdWV1ZXMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUF3c1F1ZXVlQ2xpZW50IGV4dGVuZHMgY2xvdWQuSVF1ZXVlQ2xpZW50IHtcbiAgLyoqXG4gICAqIEdldCB0aGUgcXVldWUgVVJMLlxuICAgKiBAaW5mbGlnaHRcbiAgICovXG4gIHF1ZXVlVXJsKCk6IFByb21pc2U8c3RyaW5nPjtcbn1cblxuLyoqXG4gKiBBIHJlZmVyZW5jZSB0byBhbiBleHRlcm5hbCBTUVMgcXVldWUuXG4gKlxuICogQGluZmxpZ2h0IGBAd2luZ2xhbmcvc2RrLmF3cy5JQXdzUXVldWVDbGllbnRgXG4gKi9cbmV4cG9ydCBjbGFzcyBRdWV1ZVJlZiBleHRlbmRzIFJlc291cmNlIHtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgW0lORkxJR0hUX1NZTUJPTF0/OiBJQXdzUXVldWVDbGllbnQ7XG5cbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhpcyBxdWV1ZS5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBxdWV1ZUFybjogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHF1ZXVlQXJuOiBzdHJpbmcpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgaWYgKCFpc1ZhbGlkQXJuKHF1ZXVlQXJuLCBcInNxc1wiKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBcIiR7cXVldWVBcm59XCIgaXMgbm90IGEgdmFsaWQgQW1hem9uIFNRUyBBUk5gKTtcbiAgICB9XG5cbiAgICB0aGlzLnF1ZXVlQXJuID0gcXVldWVBcm47XG5cbiAgICB0aGlzLmFkZFVzZXJJbnRlcmZhY2UoKTtcbiAgfVxuXG4gIHB1YmxpYyBvbkxpZnQoaG9zdDogSUluZmxpZ2h0SG9zdCwgb3BzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIC8vIGlmIHRoaXMgaXMgYW4gQVdTIGZ1bmN0aW9uLCBhZGQgdGhlIG5lY2Vzc2FyeSBJQU0gcGVybWlzc2lvbnNcbiAgICBpZiAoQXdzSW5mbGlnaHRIb3N0LmlzQXdzSW5mbGlnaHRIb3N0KGhvc3QpKSB7XG4gICAgICBob3N0LmFkZFBvbGljeVN0YXRlbWVudHMoXG4gICAgICAgIC4uLmNhbGN1bGF0ZVF1ZXVlUGVybWlzc2lvbnModGhpcy5xdWV1ZUFybiwgb3BzKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBob3N0LmFkZEVudmlyb25tZW50KHRoaXMuZW52TmFtZSgpLCB0aGlzLnF1ZXVlQXJuKTtcblxuICAgIHN1cGVyLm9uTGlmdChob3N0LCBvcHMpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3RvSW5mbGlnaHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gSW5mbGlnaHRDbGllbnQuZm9yKF9fZGlybmFtZSwgX19maWxlbmFtZSwgXCJRdWV1ZUNsaWVudFwiLCBbXG4gICAgICBgcHJvY2Vzcy5lbnZbXCIke3RoaXMuZW52TmFtZSgpfVwiXWAsXG4gICAgXSk7XG4gIH1cblxuICBwcml2YXRlIGVudk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFFVRVVFX0FSTl8ke3RoaXMubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgZ2V0IF9saWZ0TWFwKCk6IExpZnRNYXAge1xuICAgIHJldHVybiB7XG4gICAgICBbXCJxdWV1ZVVybFwiXTogW10sIC8vIEFXUy1zcGVjaWZpY1xuICAgICAgW2Nsb3VkLlF1ZXVlSW5mbGlnaHRNZXRob2RzLlBVU0hdOiBbXSxcbiAgICAgIFtjbG91ZC5RdWV1ZUluZmxpZ2h0TWV0aG9kcy5QVVJHRV06IFtdLFxuICAgICAgW2Nsb3VkLlF1ZXVlSW5mbGlnaHRNZXRob2RzLkFQUFJPWF9TSVpFXTogW10sXG4gICAgICBbY2xvdWQuUXVldWVJbmZsaWdodE1ldGhvZHMuUE9QXTogW10sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVXNlckludGVyZmFjZSgpIHtcbiAgICBOb2RlLm9mKHRoaXMpLmNvbG9yID0gXCJwaW5rXCI7XG5cbiAgICBjb25zdCBxdWV1ZVVybEhhbmRsZXIgPSBsaWZ0KHsgcXVldWU6IHRoaXMgfSkuaW5mbGlnaHQoYXN5bmMgKGN0eCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IGN0eC5xdWV1ZS5xdWV1ZVVybCgpO1xuICAgICAgfSBjYXRjaCAoZTogYW55KSB7XG4gICAgICAgIHJldHVybiBlLm1lc3NhZ2U7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBuZXcgdWkuRmllbGQodGhpcywgXCJRdWV1ZVVybEZpZWxkXCIsIFwiU1FTIFF1ZXVlIFVSTFwiLCBxdWV1ZVVybEhhbmRsZXIsIHtcbiAgICAgIGxpbms6IHRydWUsXG4gICAgfSk7XG5cbiAgICBjb25zdCBhd3NDb25zb2xlSGFuZGxlciA9IGxpZnQoeyBxdWV1ZTogdGhpcyB9KS5pbmZsaWdodChhc3luYyAoY3R4KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB1cmwgPSBhd2FpdCBjdHgucXVldWUucXVldWVVcmwoKTtcbiAgICAgICAgY29uc3QgeCA9IG5ldyBVUkwodXJsKTtcbiAgICAgICAgY29uc3QgcmVnaW9uID0geC5ob3N0bmFtZS5zcGxpdChcIi5cIilbMV07XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgXCJodHRwczovL1wiICtcbiAgICAgICAgICByZWdpb24gK1xuICAgICAgICAgIFwiLmNvbnNvbGUuYXdzLmFtYXpvbi5jb20vc3FzL3YzL2hvbWU/cmVnaW9uPVwiICtcbiAgICAgICAgICByZWdpb24gK1xuICAgICAgICAgIFwiIy9xdWV1ZXMvXCIgK1xuICAgICAgICAgIGVuY29kZVVSSUNvbXBvbmVudCh1cmwpXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIGUubWVzc2FnZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIG5ldyB1aS5GaWVsZCh0aGlzLCBcIkF3c0NvbnNvbGVGaWVsZFwiLCBcIkFXUyBDb25zb2xlXCIsIGF3c0NvbnNvbGVIYW5kbGVyLCB7XG4gICAgICBsaW5rOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgbmV3IHVpLlZhbHVlRmllbGQodGhpcywgXCJRdWV1ZUFybkZpZWxkXCIsIFwiU1FTIFF1ZXVlIEFSTlwiLCB0aGlzLnF1ZXVlQXJuKTtcbiAgfVxufVxuXG4vKipcbiAqIFV0aWxpdHkgY2xhc3MgZm9yIHdvcmtpbmcgd2l0aCB0aGUgcXVldWUgY29uc3VtZXIgaGFuZGxlci5cbiAqL1xuZXhwb3J0IGNsYXNzIFF1ZXVlU2V0Q29uc3VtZXJIYW5kbGVyIHtcbiAgLyoqXG4gICAqIENvbnZlcnRzIGEgcXVldWUgY29uc3VtZXIgaGFuZGxlciB0byBhIGZ1bmN0aW9uIGhhbmRsZXIuXG4gICAqIEBwYXJhbSBoYW5kbGVyIFRoZSBxdWV1ZSBjb25zdW1lciBoYW5kbGVyLlxuICAgKiBAcmV0dXJucyBUaGUgZnVuY3Rpb24gaGFuZGxlci5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgdG9GdW5jdGlvbkhhbmRsZXIoXG4gICAgaGFuZGxlcjogY2xvdWQuSVF1ZXVlU2V0Q29uc3VtZXJIYW5kbGVyXG4gICk6IGNsb3VkLklGdW5jdGlvbkhhbmRsZXIge1xuICAgIHJldHVybiBsaWZ0KHsgaGFuZGxlciB9KS5pbmZsaWdodChhc3luYyAoY3R4LCBldmVudCkgPT4ge1xuICAgICAgY29uc3QgYmF0Y2hJdGVtRmFpbHVyZXMgPSBbXTtcbiAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIChldmVudCBhcyBhbnkpLlJlY29yZHMgPz8gW10pIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBjdHguaGFuZGxlcihyZWNvcmQuYm9keSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgYmF0Y2hJdGVtRmFpbHVyZXMucHVzaCh7XG4gICAgICAgICAgICBpdGVtSWRlbnRpZmllcjogcmVjb3JkLm1lc3NhZ2VJZCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHsgYmF0Y2hJdGVtRmFpbHVyZXMgfSBhcyBhbnk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==