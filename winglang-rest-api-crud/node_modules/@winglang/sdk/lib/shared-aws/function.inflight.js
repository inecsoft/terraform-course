"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseLogs = exports.FunctionClient = void 0;
const client_lambda_1 = require("@aws-sdk/client-lambda");
const util_utf8_1 = require("@smithy/util-utf8");
const std_1 = require("../std");
class FunctionClient {
    static async context() {
        const obj = globalThis.$awsLambdaContext;
        if (!obj) {
            return undefined;
        }
        // workaround for the fact that JSII doesn't allow methods to start with "get"
        obj.remainingTimeInMillis = obj.getRemainingTimeInMillis;
        return obj;
    }
    constructor(functionArn, constructPath, lambdaClient = new client_lambda_1.LambdaClient({})) {
        this.functionArn = functionArn;
        this.constructPath = constructPath;
        this.lambdaClient = lambdaClient;
    }
    /**
     * Invokes the function with a payload and waits for the result.
     *  @returns the function response payload.
     */
    async invoke(payload) {
        const command = new client_lambda_1.InvokeCommand({
            FunctionName: this.functionArn,
            // If payload is undefined, pass json `null` as the payload to the function
            // to ensure the received event will be `null` (which will be converted to `undefined` in the function code)
            // If the Payload is undefined, the resulting event will instead be `{}`
            Payload: (0, util_utf8_1.fromUtf8)(payload !== undefined ? JSON.stringify(payload) : "null"),
        });
        const response = await this.lambdaClient.send(command);
        return parseCommandOutput(response, this.functionArn);
    }
    /**
     * Kicks off the execution of the function with a payload and returns immediately while the function is running.
     * @returns immediately once the event has been handed off to AWS Lambda.
     */
    async invokeAsync(payload) {
        const command = new client_lambda_1.InvokeCommand({
            FunctionName: this.functionArn,
            Payload: (0, util_utf8_1.fromUtf8)(JSON.stringify(payload)),
            InvocationType: "Event",
        });
        const response = await this.lambdaClient.send(command);
        if (response.StatusCode !== 202) {
            console.error("Error: " + response.FunctionError);
            console.error(response.Payload ? (0, util_utf8_1.toUtf8)(response.Payload) : "");
            throw new Error(`Failed to enqueue event. Received status code: ${response.StatusCode}`);
        }
    }
    /**
     * Invokes the function synchronously, passing the given payload as an argument.
     * @returns the function response payload with execution logs included.
     */
    async invokeWithLogs(payload) {
        const command = new client_lambda_1.InvokeCommand({
            FunctionName: this.functionArn,
            Payload: (0, util_utf8_1.fromUtf8)(JSON.stringify(payload)),
            LogType: client_lambda_1.LogType.Tail,
        });
        const response = await this.lambdaClient.send(command);
        const logs = Buffer.from(response.LogResult ?? "", "base64").toString();
        const traces = parseLogs(logs, this.constructPath);
        const value = parseCommandOutput(response, this.functionArn);
        if (!value) {
            return ["", traces];
        }
        if (typeof value !== "string") {
            throw new Error(`function returned value of type ${typeof value}, not string`);
        }
        return ["", traces];
    }
}
exports.FunctionClient = FunctionClient;
function parseCommandOutput(payload, functionArn) {
    if (payload.FunctionError) {
        let errorText = (0, util_utf8_1.toUtf8)(payload.Payload);
        let errorData;
        try {
            errorData = JSON.parse(errorText);
        }
        catch (_) { }
        if (errorData && "errorMessage" in errorData) {
            let errorMessage = `Invoke failed with message: "${errorData.errorMessage}"\nLogs: ${cloudwatchLogsPath(functionArn)}`;
            errorMessage = errorMessage.replace("Task timed out after", "Function timed out after");
            const newError = new Error();
            newError.message = errorMessage;
            newError.name = errorData.errorType;
            newError.stack = errorData.trace?.join("\n");
            throw newError;
        }
        throw new Error(`Invoke failed with message: "${payload.FunctionError}"\nLogs: ${cloudwatchLogsPath(functionArn)}\nFull Error: "${errorText}"`);
    }
    if (!payload.Payload) {
        return undefined;
    }
    else {
        const returnObject = JSON.parse((0, util_utf8_1.toUtf8)(payload.Payload));
        return returnObject === null ? undefined : returnObject;
    }
}
function cloudwatchLogsPath(functionArn) {
    const functionName = encodeURIComponent(functionArn.split(":").slice(-1)[0]);
    const region = functionArn.split(":")[3];
    return `https://${region}.console.aws.amazon.com/cloudwatch/home?region=${region}#logsV2:log-groups/log-group/%2Faws%2Flambda%2F${functionName}`;
}
function parseLogs(logs, sourcePath) {
    const lines = logs.split("\n");
    const traces = [];
    for (const line of lines) {
        const parts = line.split("\t");
        // 2023-08-04T16:40:47.309Z 6beb7628-d0c3-4fe9-bf5a-d64c559aa25f INFO hello
        // 2023-08-04T16:40:47.309Z 6beb7628-d0c3-4fe9-bf5a-d64c559aa25f Task timed out after 3.0 seconds
        if (parts.length >= 3 &&
            parts[0].match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/) !==
                null &&
            parts[1].match(/^[0-9a-fA-F-]{36}$/) !== null) {
            const timestamp = parts[0];
            if (parts.slice(2).join(" ").startsWith("Task timed out after")) {
                continue;
            }
            const message = parts.slice(3).join(" ");
            const trace = {
                data: { message },
                timestamp,
                sourceType: "@winglang/sdk.cloud.Function",
                sourcePath,
                type: std_1.TraceType.LOG,
                level: std_1.LogLevel.INFO,
            };
            traces.push(trace);
        }
    }
    return traces;
}
exports.parseLogs = parseLogs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb24uaW5mbGlnaHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2hhcmVkLWF3cy9mdW5jdGlvbi5pbmZsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFLZ0M7QUFDaEMsaURBQXFEO0FBR3JELGdDQUFvRDtBQUVwRCxNQUFhLGNBQWM7SUFDbEIsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPO1FBQ3pCLE1BQU0sR0FBRyxHQUFJLFVBQWtCLENBQUMsaUJBQWlCLENBQUM7UUFDbEQsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ1QsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQztRQUNELDhFQUE4RTtRQUM5RSxHQUFHLENBQUMscUJBQXFCLEdBQUcsR0FBRyxDQUFDLHdCQUF3QixDQUFDO1FBQ3pELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVELFlBQ21CLFdBQW1CLEVBQ25CLGFBQXFCLEVBQ3JCLGVBQWUsSUFBSSw0QkFBWSxDQUFDLEVBQUUsQ0FBQztRQUZuQyxnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUNuQixrQkFBYSxHQUFiLGFBQWEsQ0FBUTtRQUNyQixpQkFBWSxHQUFaLFlBQVksQ0FBdUI7SUFDbkQsQ0FBQztJQUVKOzs7T0FHRztJQUNJLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBZ0I7UUFDbEMsTUFBTSxPQUFPLEdBQUcsSUFBSSw2QkFBYSxDQUFDO1lBQ2hDLFlBQVksRUFBRSxJQUFJLENBQUMsV0FBVztZQUM5QiwyRUFBMkU7WUFDM0UsNEdBQTRHO1lBQzVHLHdFQUF3RTtZQUN4RSxPQUFPLEVBQUUsSUFBQSxvQkFBUSxFQUNmLE9BQU8sS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FDekQ7U0FDRixDQUFDLENBQUM7UUFDSCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FB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QyxVQUFVO2dCQUNWLElBQUksRUFBRSxlQUFTLENBQUMsR0FBRztnQkFDbkIsS0FBSyxFQUFFLGNBQVEsQ0FBQyxJQUFJO2FBQ3JCLENBQUM7WUFDRixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JCLENBQUM7SUFDSCxDQUFDO0lBQ0QsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQztBQTlCRCw4QkE4QkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbnZva2VDb21tYW5kLFxuICBJbnZva2VDb21tYW5kT3V0cHV0LFxuICBMYW1iZGFDbGllbnQsXG4gIExvZ1R5cGUsXG59IGZyb20gXCJAYXdzLXNkay9jbGllbnQtbGFtYmRhXCI7XG5pbXBvcnQgeyBmcm9tVXRmOCwgdG9VdGY4IH0gZnJvbSBcIkBzbWl0aHkvdXRpbC11dGY4XCI7XG5pbXBvcnQgeyBJTGFtYmRhQ29udGV4dCB9IGZyb20gXCIuL2Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBJRnVuY3Rpb25DbGllbnQgfSBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCB7IExvZ0xldmVsLCBUcmFjZSwgVHJhY2VUeXBlIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG5leHBvcnQgY2xhc3MgRnVuY3Rpb25DbGllbnQgaW1wbGVtZW50cyBJRnVuY3Rpb25DbGllbnQge1xuICBwdWJsaWMgc3RhdGljIGFzeW5jIGNvbnRleHQoKTogUHJvbWlzZTxJTGFtYmRhQ29udGV4dCB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IG9iaiA9IChnbG9iYWxUaGlzIGFzIGFueSkuJGF3c0xhbWJkYUNvbnRleHQ7XG4gICAgaWYgKCFvYmopIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIC8vIHdvcmthcm91bmQgZm9yIHRoZSBmYWN0IHRoYXQgSlNJSSBkb2Vzbid0IGFsbG93IG1ldGhvZHMgdG8gc3RhcnQgd2l0aCBcImdldFwiXG4gICAgb2JqLnJlbWFpbmluZ1RpbWVJbk1pbGxpcyA9IG9iai5nZXRSZW1haW5pbmdUaW1lSW5NaWxsaXM7XG4gICAgcmV0dXJuIG9iajtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25Bcm46IHN0cmluZyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbnN0cnVjdFBhdGg6IHN0cmluZyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGxhbWJkYUNsaWVudCA9IG5ldyBMYW1iZGFDbGllbnQoe30pXG4gICkge31cblxuICAvKipcbiAgICogSW52b2tlcyB0aGUgZnVuY3Rpb24gd2l0aCBhIHBheWxvYWQgYW5kIHdhaXRzIGZvciB0aGUgcmVzdWx0LlxuICAgKiAgQHJldHVybnMgdGhlIGZ1bmN0aW9uIHJlc3BvbnNlIHBheWxvYWQuXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgaW52b2tlKHBheWxvYWQ/OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgSW52b2tlQ29tbWFuZCh7XG4gICAgICBGdW5jdGlvbk5hbWU6IHRoaXMuZnVuY3Rpb25Bcm4sXG4gICAgICAvLyBJZiBwYXlsb2FkIGlzIHVuZGVmaW5lZCwgcGFzcyBqc29uIGBudWxsYCBhcyB0aGUgcGF5bG9hZCB0byB0aGUgZnVuY3Rpb25cbiAgICAgIC8vIHRvIGVuc3VyZSB0aGUgcmVjZWl2ZWQgZXZlbnQgd2lsbCBiZSBgbnVsbGAgKHdoaWNoIHdpbGwgYmUgY29udmVydGVkIHRvIGB1bmRlZmluZWRgIGluIHRoZSBmdW5jdGlvbiBjb2RlKVxuICAgICAgLy8gSWYgdGhlIFBheWxvYWQgaXMgdW5kZWZpbmVkLCB0aGUgcmVzdWx0aW5nIGV2ZW50IHdpbGwgaW5zdGVhZCBiZSBge31gXG4gICAgICBQYXlsb2FkOiBmcm9tVXRmOChcbiAgICAgICAgcGF5bG9hZCAhPT0gdW5kZWZpbmVkID8gSlNPTi5zdHJpbmdpZnkocGF5bG9hZCkgOiBcIm51bGxcIlxuICAgICAgKSxcbiAgICB9KTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMubGFtYmRhQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgcmV0dXJuIHBhcnNlQ29tbWFuZE91dHB1dChyZXNwb25zZSwgdGhpcy5mdW5jdGlvbkFybik7XG4gIH1cblxuICAvKipcbiAgICogS2lja3Mgb2ZmIHRoZSBleGVjdXRpb24gb2YgdGhlIGZ1bmN0aW9uIHdpdGggYSBwYXlsb2FkIGFuZCByZXR1cm5zIGltbWVkaWF0ZWx5IHdoaWxlIHRoZSBmdW5jdGlvbiBpcyBydW5uaW5nLlxuICAgKiBAcmV0dXJucyBpbW1lZGlhdGVseSBvbmNlIHRoZSBldmVudCBoYXMgYmVlbiBoYW5kZWQgb2ZmIHRvIEFXUyBMYW1iZGEuXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgaW52b2tlQXN5bmMocGF5bG9hZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBJbnZva2VDb21tYW5kKHtcbiAgICAgIEZ1bmN0aW9uTmFtZTogdGhpcy5mdW5jdGlvbkFybixcbiAgICAgIFBheWxvYWQ6IGZyb21VdGY4KEpTT04uc3RyaW5naWZ5KHBheWxvYWQpKSxcbiAgICAgIEludm9jYXRpb25UeXBlOiBcIkV2ZW50XCIsXG4gICAgfSk7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmxhbWJkYUNsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gICAgaWYgKHJlc3BvbnNlLlN0YXR1c0NvZGUgIT09IDIwMikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yOiBcIiArIHJlc3BvbnNlLkZ1bmN0aW9uRXJyb3IpO1xuICAgICAgY29uc29sZS5lcnJvcihyZXNwb25zZS5QYXlsb2FkID8gdG9VdGY4KHJlc3BvbnNlLlBheWxvYWQpIDogXCJcIik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gZW5xdWV1ZSBldmVudC4gUmVjZWl2ZWQgc3RhdHVzIGNvZGU6ICR7cmVzcG9uc2UuU3RhdHVzQ29kZX1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VzIHRoZSBmdW5jdGlvbiBzeW5jaHJvbm91c2x5LCBwYXNzaW5nIHRoZSBnaXZlbiBwYXlsb2FkIGFzIGFuIGFyZ3VtZW50LlxuICAgKiBAcmV0dXJucyB0aGUgZnVuY3Rpb24gcmVzcG9uc2UgcGF5bG9hZCB3aXRoIGV4ZWN1dGlvbiBsb2dzIGluY2x1ZGVkLlxuICAgKi9cbiAgcHVibGljIGFzeW5jIGludm9rZVdpdGhMb2dzKHBheWxvYWQ6IHN0cmluZyk6IFByb21pc2U8W3N0cmluZywgVHJhY2VbXV0+IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEludm9rZUNvbW1hbmQoe1xuICAgICAgRnVuY3Rpb25OYW1lOiB0aGlzLmZ1bmN0aW9uQXJuLFxuICAgICAgUGF5bG9hZDogZnJvbVV0ZjgoSlNPTi5zdHJpbmdpZnkocGF5bG9hZCkpLFxuICAgICAgTG9nVHlwZTogTG9nVHlwZS5UYWlsLFxuICAgIH0pO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5sYW1iZGFDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICAgIGNvbnN0IGxvZ3MgPSBCdWZmZXIuZnJvbShyZXNwb25zZS5Mb2dSZXN1bHQgPz8gXCJcIiwgXCJiYXNlNjRcIikudG9TdHJpbmcoKTtcbiAgICBjb25zdCB0cmFjZXMgPSBwYXJzZUxvZ3MobG9ncywgdGhpcy5jb25zdHJ1Y3RQYXRoKTtcblxuICAgIGNvbnN0IHZhbHVlID0gcGFyc2VDb21tYW5kT3V0cHV0KHJlc3BvbnNlLCB0aGlzLmZ1bmN0aW9uQXJuKTtcblxuICAgIGlmICghdmFsdWUpIHtcbiAgICAgIHJldHVybiBbXCJcIiwgdHJhY2VzXTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgZnVuY3Rpb24gcmV0dXJuZWQgdmFsdWUgb2YgdHlwZSAke3R5cGVvZiB2YWx1ZX0sIG5vdCBzdHJpbmdgXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gW1wiXCIsIHRyYWNlc107XG4gIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VDb21tYW5kT3V0cHV0KFxuICBwYXlsb2FkOiBJbnZva2VDb21tYW5kT3V0cHV0LFxuICBmdW5jdGlvbkFybjogc3RyaW5nXG4pOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICBpZiAocGF5bG9hZC5GdW5jdGlvbkVycm9yKSB7XG4gICAgbGV0IGVycm9yVGV4dCA9IHRvVXRmOChwYXlsb2FkLlBheWxvYWQhKTtcbiAgICBsZXQgZXJyb3JEYXRhO1xuICAgIHRyeSB7XG4gICAgICBlcnJvckRhdGEgPSBKU09OLnBhcnNlKGVycm9yVGV4dCk7XG4gICAgfSBjYXRjaCAoXykge31cblxuICAgIGlmIChlcnJvckRhdGEgJiYgXCJlcnJvck1lc3NhZ2VcIiBpbiBlcnJvckRhdGEpIHtcbiAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSBgSW52b2tlIGZhaWxlZCB3aXRoIG1lc3NhZ2U6IFwiJHtcbiAgICAgICAgZXJyb3JEYXRhLmVycm9yTWVzc2FnZVxuICAgICAgfVwiXFxuTG9nczogJHtjbG91ZHdhdGNoTG9nc1BhdGgoZnVuY3Rpb25Bcm4pfWA7XG4gICAgICBlcnJvck1lc3NhZ2UgPSBlcnJvck1lc3NhZ2UucmVwbGFjZShcbiAgICAgICAgXCJUYXNrIHRpbWVkIG91dCBhZnRlclwiLFxuICAgICAgICBcIkZ1bmN0aW9uIHRpbWVkIG91dCBhZnRlclwiXG4gICAgICApO1xuXG4gICAgICBjb25zdCBuZXdFcnJvciA9IG5ldyBFcnJvcigpO1xuICAgICAgbmV3RXJyb3IubWVzc2FnZSA9IGVycm9yTWVzc2FnZTtcbiAgICAgIG5ld0Vycm9yLm5hbWUgPSBlcnJvckRhdGEuZXJyb3JUeXBlO1xuICAgICAgbmV3RXJyb3Iuc3RhY2sgPSBlcnJvckRhdGEudHJhY2U/LmpvaW4oXCJcXG5cIik7XG4gICAgICB0aHJvdyBuZXdFcnJvcjtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgSW52b2tlIGZhaWxlZCB3aXRoIG1lc3NhZ2U6IFwiJHtcbiAgICAgICAgcGF5bG9hZC5GdW5jdGlvbkVycm9yXG4gICAgICB9XCJcXG5Mb2dzOiAke2Nsb3Vkd2F0Y2hMb2dzUGF0aChmdW5jdGlvbkFybil9XFxuRnVsbCBFcnJvcjogXCIke2Vycm9yVGV4dH1cImBcbiAgICApO1xuICB9XG5cbiAgaWYgKCFwYXlsb2FkLlBheWxvYWQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHJldHVybk9iamVjdCA9IEpTT04ucGFyc2UodG9VdGY4KHBheWxvYWQuUGF5bG9hZCkpO1xuICAgIHJldHVybiByZXR1cm5PYmplY3QgPT09IG51bGwgPyB1bmRlZmluZWQgOiByZXR1cm5PYmplY3Q7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2xvdWR3YXRjaExvZ3NQYXRoKGZ1bmN0aW9uQXJuOiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBmdW5jdGlvbk5hbWUgPSBlbmNvZGVVUklDb21wb25lbnQoZnVuY3Rpb25Bcm4uc3BsaXQoXCI6XCIpLnNsaWNlKC0xKVswXSk7XG4gIGNvbnN0IHJlZ2lvbiA9IGZ1bmN0aW9uQXJuLnNwbGl0KFwiOlwiKVszXTtcbiAgcmV0dXJuIGBodHRwczovLyR7cmVnaW9ufS5jb25zb2xlLmF3cy5hbWF6b24uY29tL2Nsb3Vkd2F0Y2gvaG9tZT9yZWdpb249JHtyZWdpb259I2xvZ3NWMjpsb2ctZ3JvdXBzL2xvZy1ncm91cC8lMkZhd3MlMkZsYW1iZGElMkYke2Z1bmN0aW9uTmFtZX1gO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VMb2dzKGxvZ3M6IHN0cmluZywgc291cmNlUGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IGxpbmVzID0gbG9ncy5zcGxpdChcIlxcblwiKTtcbiAgY29uc3QgdHJhY2VzOiBUcmFjZVtdID0gW107XG4gIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgIGNvbnN0IHBhcnRzID0gbGluZS5zcGxpdChcIlxcdFwiKTtcbiAgICAvLyAyMDIzLTA4LTA0VDE2OjQwOjQ3LjMwOVogNmJlYjc2MjgtZDBjMy00ZmU5LWJmNWEtZDY0YzU1OWFhMjVmIElORk8gaGVsbG9cbiAgICAvLyAyMDIzLTA4LTA0VDE2OjQwOjQ3LjMwOVogNmJlYjc2MjgtZDBjMy00ZmU5LWJmNWEtZDY0YzU1OWFhMjVmIFRhc2sgdGltZWQgb3V0IGFmdGVyIDMuMCBzZWNvbmRzXG4gICAgaWYgKFxuICAgICAgcGFydHMubGVuZ3RoID49IDMgJiZcbiAgICAgIHBhcnRzWzBdLm1hdGNoKC9eXFxkezR9LVxcZHsyfS1cXGR7Mn1UXFxkezJ9OlxcZHsyfTpcXGR7Mn1cXC5cXGR7M31aJC8pICE9PVxuICAgICAgICBudWxsICYmXG4gICAgICBwYXJ0c1sxXS5tYXRjaCgvXlswLTlhLWZBLUYtXXszNn0kLykgIT09IG51bGxcbiAgICApIHtcbiAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IHBhcnRzWzBdO1xuICAgICAgaWYgKHBhcnRzLnNsaWNlKDIpLmpvaW4oXCIgXCIpLnN0YXJ0c1dpdGgoXCJUYXNrIHRpbWVkIG91dCBhZnRlclwiKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBwYXJ0cy5zbGljZSgzKS5qb2luKFwiIFwiKTtcbiAgICAgIGNvbnN0IHRyYWNlOiBUcmFjZSA9IHtcbiAgICAgICAgZGF0YTogeyBtZXNzYWdlIH0sXG4gICAgICAgIHRpbWVzdGFtcCxcbiAgICAgICAgc291cmNlVHlwZTogXCJAd2luZ2xhbmcvc2RrLmNsb3VkLkZ1bmN0aW9uXCIsXG4gICAgICAgIHNvdXJjZVBhdGgsXG4gICAgICAgIHR5cGU6IFRyYWNlVHlwZS5MT0csXG4gICAgICAgIGxldmVsOiBMb2dMZXZlbC5JTkZPLFxuICAgICAgfTtcbiAgICAgIHRyYWNlcy5wdXNoKHRyYWNlKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHRyYWNlcztcbn1cbiJdfQ==