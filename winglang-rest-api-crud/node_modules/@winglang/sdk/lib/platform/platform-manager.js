"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports._loadCustomPlatform = exports.PlatformManager = exports.SECRETS_FILE_NAME = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const process_1 = require("process");
const vm = __importStar(require("vm"));
const util_1 = require("./util");
const types_1 = require("../core/types");
const BUILTIN_PLATFORMS = ["tf-aws", "tf-azure", "tf-gcp", "sim"];
/** @internal */
exports.SECRETS_FILE_NAME = "secrets.json";
/** @internal */
class PlatformManager {
    constructor(options) {
        this.platformInstances = [];
        this.platformPaths = options.platformPaths ?? [];
        this.retrieveImplicitPlatforms();
        this.createPlatformInstances();
    }
    /**
     * Retrieve all implicit platform declarations.
     *
     * These are platforms that are not explicitly declared in the cli options
     * but are implicitly available to the app.
     *
     * We look for platforms in the following locations:
     * - The source directory
     * - Any imported namespaces (provided by the wingc compiler output)
     *
     * To determine if a directory contains a platform, we check if it contains a file ending in "wplatform.js"
     * TODO: Support platforms defined in Wing (platform.w) https://github.com/winglang/wing/issues/4937
     */
    retrieveImplicitPlatforms() {
        const importedNamespaces = process.env.WING_IMPORTED_NAMESPACES?.split(";");
        const sourceDir = process.env.WING_SOURCE_DIR;
        if (sourceDir) {
            const sourceDirPlatformFile = (0, util_1.scanDirForPlatformFile)(sourceDir);
            if (sourceDirPlatformFile) {
                this.platformPaths.push(...sourceDirPlatformFile);
            }
        }
        if (importedNamespaces) {
            importedNamespaces.forEach((namespaceDir) => {
                const namespaceDirPlatformFile = (0, util_1.scanDirForPlatformFile)(namespaceDir);
                if (namespaceDirPlatformFile) {
                    this.platformPaths.push(...namespaceDirPlatformFile);
                }
            });
        }
    }
    loadPlatformPath(platformPath) {
        const platformName = (0, path_1.basename)(platformPath);
        const isBuiltin = BUILTIN_PLATFORMS.includes(platformName);
        const pathToRead = isBuiltin
            ? (0, path_1.join)(__dirname, `../target-${platformName}/platform`)
            : (0, path_1.join)(platformPath);
        this.platformInstances.push(isBuiltin
            ? this.loadBuiltinPlatform(pathToRead)
            : _loadCustomPlatform(pathToRead));
    }
    /**
     * Builtin platforms are loaded from the SDK
     *
     * @param builtinPlatformPath path to a builtin platform
     */
    loadBuiltinPlatform(builtinPlatformPath) {
        // eslint-disable-next-line @typescript-eslint/no-require-imports
        const loadedPlatform = require(builtinPlatformPath);
        if (!loadedPlatform || !loadedPlatform.Platform) {
            console.error(`Failed to load platform from ${builtinPlatformPath}`);
            return;
        }
        return new loadedPlatform.Platform();
    }
    createPlatformInstances() {
        this.platformInstances = [];
        this.platformPaths.forEach((platformPath) => {
            this.loadPlatformPath(platformPath);
        });
    }
    // This method is called from preflight.cjs in order to return an App instance
    // that can be synthesized
    createApp(appProps) {
        this.createPlatformInstances();
        let appCall = this.platformInstances[0].newApp;
        if (!appCall) {
            throw new Error(`No newApp method found on platform: ${this.platformPaths[0]} (Hint: The first platform provided must have a newApp method)`);
        }
        let hooks = collectHooks(this.platformInstances);
        const app = appCall({
            ...appProps,
            synthHooks: hooks.synthHooks,
            newInstanceOverrides: hooks.newInstanceOverrides,
        });
        let secretNames = [];
        for (const c of app.node.findAll()) {
            if (c[types_1.SECRET_SYMBOL]) {
                const secret = c;
                secretNames.push(secret.name);
            }
        }
        if (secretNames.length > 0) {
            (0, fs_1.writeFileSync)((0, path_1.join)(app.outdir, exports.SECRETS_FILE_NAME), JSON.stringify(secretNames));
        }
        let registrar = app.parameters;
        hooks.parameterSchemas.forEach((schema) => {
            registrar.addSchema(schema);
        });
        return app;
    }
    async storeSecrets(secrets) {
        const hooks = collectHooks(this.platformInstances);
        if (!hooks.storeSecretsHook) {
            throw new Error(`Cannot find a platform or platform extension that supports storing secrets`);
        }
        await hooks.storeSecretsHook(secrets);
    }
}
exports.PlatformManager = PlatformManager;
/**
 * Custom platforms need to be loaded into a custom context in order to
 * resolve their dependencies correctly.
 *
 * @internal
 */
function _loadCustomPlatform(customPlatformPath) {
    const isScoped = customPlatformPath.startsWith("@");
    const platformBaseDir = isScoped
        ? (0, path_1.dirname)((0, path_1.dirname)(customPlatformPath))
        : (0, path_1.dirname)(customPlatformPath);
    const platformDir = (0, path_1.join)(platformBaseDir, "node_modules");
    /**
     * Support platforms that are provided as:
     * - A single js file (e.g. "/some/path/to/platform.js")
     * - A scoped package (e.g. "@scope/platform")
     * - A non-scoped package (e.g. "/some/path/platform")
     */
    const fullCustomPlatformPath = customPlatformPath.endsWith(".js")
        ? customPlatformPath
        : isScoped
            ? (0, path_1.join)(platformDir, `${customPlatformPath}/lib/index.js`)
            : `${customPlatformPath}/index.js`;
    // enable relative imports from the platform file
    const customPlatformBaseDir = customPlatformPath.endsWith(".js")
        ? (0, path_1.dirname)(customPlatformPath)
        : customPlatformPath;
    const cwdNodeModules = (0, path_1.join)((0, process_1.cwd)(), "node_modules");
    const customPlatformLib = (0, path_1.join)(cwdNodeModules, customPlatformPath, "lib");
    const resolvablePaths = [
        ...module.paths,
        customPlatformBaseDir,
        platformDir,
        cwdNodeModules,
        customPlatformLib,
    ];
    const requireResolve = (path) => {
        return require.resolve(path, {
            paths: resolvablePaths,
        });
    };
    const platformRequire = (path) => {
        // eslint-disable-next-line @typescript-eslint/no-require-imports
        return require(requireResolve(path));
    };
    platformRequire.resolve = requireResolve;
    const platformModule = {
        exports: {},
    };
    const context = vm.createContext({
        require: platformRequire,
        console,
        exports: platformModule.exports,
        module: platformModule,
        process,
        __dirname: customPlatformPath,
    });
    try {
        const platformCode = (0, fs_1.readFileSync)(fullCustomPlatformPath, "utf-8");
        const script = new vm.Script(platformCode);
        script.runInContext(context);
        return new platformModule.exports.Platform();
    }
    catch (error) {
        if (process.env.DEBUG) {
            console.error(error);
        }
        const hint = customPlatformPath.includes(".")
            ? "Ensure the path to the platform is correct"
            : `Ensure you have installed the platform provider by running 'npm install ${customPlatformPath}'`;
        console.error(`An error occurred while loading the custom platform: ${customPlatformPath}\n\n(hint: ${hint})`);
    }
}
exports._loadCustomPlatform = _loadCustomPlatform;
function collectHooks(platformInstances) {
    let result = {
        synthHooks: {
            preSynthesize: [],
            postSynthesize: [],
            validate: [],
        },
        newInstanceOverrides: [],
        parameterSchemas: [],
        storeSecretsHook: undefined,
    };
    platformInstances.forEach((instance) => {
        if (instance.parameters) {
            result.parameterSchemas.push(instance.parameters);
        }
        if (instance.preSynth) {
            result.synthHooks.preSynthesize.push(instance.preSynth.bind(instance));
        }
        if (instance.postSynth) {
            result.synthHooks.postSynthesize.push(instance.postSynth.bind(instance));
        }
        if (instance.validate) {
            result.synthHooks.validate.push(instance.validate.bind(instance));
        }
        if (instance.newInstance) {
            result.newInstanceOverrides.push(instance.newInstance.bind(instance));
        }
        if (instance.storeSecrets) {
            result.storeSecretsHook = instance.storeSecrets.bind(instance);
        }
    });
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxhdGZvcm0tbWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbGF0Zm9ybS9wbGF0Zm9ybS1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkJBQWlEO0FBQ2pELCtCQUErQztBQUMvQyxxQ0FBOEI7QUFDOUIsdUNBQXlCO0FBRXpCLGlDQUFnRDtBQUVoRCx5Q0FBOEM7QUFTOUMsTUFBTSxpQkFBaUIsR0FBRyxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBRWxFLGdCQUFnQjtBQUNILFFBQUEsaUJBQWlCLEdBQUcsY0FBYyxDQUFDO0FBRWhELGdCQUFnQjtBQUNoQixNQUFhLGVBQWU7SUFJMUIsWUFBWSxPQUErQjtRQUZuQyxzQkFBaUIsR0FBZ0IsRUFBRSxDQUFDO1FBRzFDLElBQUksQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDLGFBQWEsSUFBSSxFQUFFLENBQUM7UUFDakQsSUFBSSxDQUFDLHlCQUF5QixFQUFFLENBQUM7UUFDakMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7T0FZRztJQUNLLHlCQUF5QjtRQUMvQixNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzVFLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZ0IsQ0FBQztRQUUvQyxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQ2QsTUFBTSxxQkFBcUIsR0FBRyxJQUFBLDZCQUFzQixFQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2hFLElBQUkscUJBQXFCLEVBQUUsQ0FBQztnQkFDMUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxxQkFBcUIsQ0FBQyxDQUFDO1lBQ3BE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QztRQUVELElBQUksUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQzFCLE1BQU0sQ0FBQyxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNqRSxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVhZEZpbGVTeW5jLCB3cml0ZUZpbGVTeW5jIH0gZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBiYXNlbmFtZSwgZGlybmFtZSwgam9pbiB9IGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBjd2QgfSBmcm9tIFwicHJvY2Vzc1wiO1xuaW1wb3J0ICogYXMgdm0gZnJvbSBcInZtXCI7XG5pbXBvcnQgeyBJUGxhdGZvcm0gfSBmcm9tIFwiLi9wbGF0Zm9ybVwiO1xuaW1wb3J0IHsgc2NhbkRpckZvclBsYXRmb3JtRmlsZSB9IGZyb20gXCIuL3V0aWxcIjtcbmltcG9ydCB7IEFwcCwgQXBwUHJvcHMsIFN5bnRoSG9va3MgfSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgU0VDUkVUX1NZTUJPTCB9IGZyb20gXCIuLi9jb3JlL3R5cGVzXCI7XG5cbmludGVyZmFjZSBQbGF0Zm9ybU1hbmFnZXJPcHRpb25zIHtcbiAgLyoqXG4gICAqIEVpdGhlciBhIGJ1aWx0aW4gcGxhdGZvcm0gbmFtZSBvciBhIHBhdGggdG8gYSBjdXN0b20gcGxhdGZvcm1cbiAgICovXG4gIHJlYWRvbmx5IHBsYXRmb3JtUGF0aHM/OiBzdHJpbmdbXTtcbn1cblxuY29uc3QgQlVJTFRJTl9QTEFURk9STVMgPSBbXCJ0Zi1hd3NcIiwgXCJ0Zi1henVyZVwiLCBcInRmLWdjcFwiLCBcInNpbVwiXTtcblxuLyoqIEBpbnRlcm5hbCAqL1xuZXhwb3J0IGNvbnN0IFNFQ1JFVFNfRklMRV9OQU1FID0gXCJzZWNyZXRzLmpzb25cIjtcblxuLyoqIEBpbnRlcm5hbCAqL1xuZXhwb3J0IGNsYXNzIFBsYXRmb3JtTWFuYWdlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgcGxhdGZvcm1QYXRoczogc3RyaW5nW107XG4gIHByaXZhdGUgcGxhdGZvcm1JbnN0YW5jZXM6IElQbGF0Zm9ybVtdID0gW107XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogUGxhdGZvcm1NYW5hZ2VyT3B0aW9ucykge1xuICAgIHRoaXMucGxhdGZvcm1QYXRocyA9IG9wdGlvbnMucGxhdGZvcm1QYXRocyA/PyBbXTtcbiAgICB0aGlzLnJldHJpZXZlSW1wbGljaXRQbGF0Zm9ybXMoKTtcbiAgICB0aGlzLmNyZWF0ZVBsYXRmb3JtSW5zdGFuY2VzKCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0cmlldmUgYWxsIGltcGxpY2l0IHBsYXRmb3JtIGRlY2xhcmF0aW9ucy5cbiAgICpcbiAgICogVGhlc2UgYXJlIHBsYXRmb3JtcyB0aGF0IGFyZSBub3QgZXhwbGljaXRseSBkZWNsYXJlZCBpbiB0aGUgY2xpIG9wdGlvbnNcbiAgICogYnV0IGFyZSBpbXBsaWNpdGx5IGF2YWlsYWJsZSB0byB0aGUgYXBwLlxuICAgKlxuICAgKiBXZSBsb29rIGZvciBwbGF0Zm9ybXMgaW4gdGhlIGZvbGxvd2luZyBsb2NhdGlvbnM6XG4gICAqIC0gVGhlIHNvdXJjZSBkaXJlY3RvcnlcbiAgICogLSBBbnkgaW1wb3J0ZWQgbmFtZXNwYWNlcyAocHJvdmlkZWQgYnkgdGhlIHdpbmdjIGNvbXBpbGVyIG91dHB1dClcbiAgICpcbiAgICogVG8gZGV0ZXJtaW5lIGlmIGEgZGlyZWN0b3J5IGNvbnRhaW5zIGEgcGxhdGZvcm0sIHdlIGNoZWNrIGlmIGl0IGNvbnRhaW5zIGEgZmlsZSBlbmRpbmcgaW4gXCJ3cGxhdGZvcm0uanNcIlxuICAgKiBUT0RPOiBTdXBwb3J0IHBsYXRmb3JtcyBkZWZpbmVkIGluIFdpbmcgKHBsYXRmb3JtLncpIGh0dHBzOi8vZ2l0aHViLmNvbS93aW5nbGFuZy93aW5nL2lzc3Vlcy80OTM3XG4gICAqL1xuICBwcml2YXRlIHJldHJpZXZlSW1wbGljaXRQbGF0Zm9ybXMoKSB7XG4gICAgY29uc3QgaW1wb3J0ZWROYW1lc3BhY2VzID0gcHJvY2Vzcy5lbnYuV0lOR19JTVBPUlRFRF9OQU1FU1BBQ0VTPy5zcGxpdChcIjtcIik7XG4gICAgY29uc3Qgc291cmNlRGlyID0gcHJvY2Vzcy5lbnYuV0lOR19TT1VSQ0VfRElSITtcblxuICAgIGlmIChzb3VyY2VEaXIpIHtcbiAgICAgIGNvbnN0IHNvdXJjZURpclBsYXRmb3JtRmlsZSA9IHNjYW5EaXJGb3JQbGF0Zm9ybUZpbGUoc291cmNlRGlyKTtcbiAgICAgIGlmIChzb3VyY2VEaXJQbGF0Zm9ybUZpbGUpIHtcbiAgICAgICAgdGhpcy5wbGF0Zm9ybVBhdGhzLnB1c2goLi4uc291cmNlRGlyUGxhdGZvcm1GaWxlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoaW1wb3J0ZWROYW1lc3BhY2VzKSB7XG4gICAgICBpbXBvcnRlZE5hbWVzcGFjZXMuZm9yRWFjaCgobmFtZXNwYWNlRGlyKSA9PiB7XG4gICAgICAgIGNvbnN0IG5hbWVzcGFjZURpclBsYXRmb3JtRmlsZSA9IHNjYW5EaXJGb3JQbGF0Zm9ybUZpbGUobmFtZXNwYWNlRGlyKTtcbiAgICAgICAgaWYgKG5hbWVzcGFjZURpclBsYXRmb3JtRmlsZSkge1xuICAgICAgICAgIHRoaXMucGxhdGZvcm1QYXRocy5wdXNoKC4uLm5hbWVzcGFjZURpclBsYXRmb3JtRmlsZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbG9hZFBsYXRmb3JtUGF0aChwbGF0Zm9ybVBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IHBsYXRmb3JtTmFtZSA9IGJhc2VuYW1lKHBsYXRmb3JtUGF0aCk7XG5cbiAgICBjb25zdCBpc0J1aWx0aW4gPSBCVUlMVElOX1BMQVRGT1JNUy5pbmNsdWRlcyhwbGF0Zm9ybU5hbWUpO1xuXG4gICAgY29uc3QgcGF0aFRvUmVhZCA9IGlzQnVpbHRpblxuICAgICAgPyBqb2luKF9fZGlybmFtZSwgYC4uL3RhcmdldC0ke3BsYXRmb3JtTmFtZX0vcGxhdGZvcm1gKVxuICAgICAgOiBqb2luKHBsYXRmb3JtUGF0aCk7XG5cbiAgICB0aGlzLnBsYXRmb3JtSW5zdGFuY2VzLnB1c2goXG4gICAgICBpc0J1aWx0aW5cbiAgICAgICAgPyB0aGlzLmxvYWRCdWlsdGluUGxhdGZvcm0ocGF0aFRvUmVhZClcbiAgICAgICAgOiBfbG9hZEN1c3RvbVBsYXRmb3JtKHBhdGhUb1JlYWQpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdWlsdGluIHBsYXRmb3JtcyBhcmUgbG9hZGVkIGZyb20gdGhlIFNES1xuICAgKlxuICAgKiBAcGFyYW0gYnVpbHRpblBsYXRmb3JtUGF0aCBwYXRoIHRvIGEgYnVpbHRpbiBwbGF0Zm9ybVxuICAgKi9cbiAgcHJpdmF0ZSBsb2FkQnVpbHRpblBsYXRmb3JtKGJ1aWx0aW5QbGF0Zm9ybVBhdGg6IHN0cmluZyk6IGFueSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1yZXF1aXJlLWltcG9ydHNcbiAgICBjb25zdCBsb2FkZWRQbGF0Zm9ybSA9IHJlcXVpcmUoYnVpbHRpblBsYXRmb3JtUGF0aCk7XG4gICAgaWYgKCFsb2FkZWRQbGF0Zm9ybSB8fCAhbG9hZGVkUGxhdGZvcm0uUGxhdGZvcm0pIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBsb2FkIHBsYXRmb3JtIGZyb20gJHtidWlsdGluUGxhdGZvcm1QYXRofWApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgbG9hZGVkUGxhdGZvcm0uUGxhdGZvcm0oKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUGxhdGZvcm1JbnN0YW5jZXMoKSB7XG4gICAgdGhpcy5wbGF0Zm9ybUluc3RhbmNlcyA9IFtdO1xuICAgIHRoaXMucGxhdGZvcm1QYXRocy5mb3JFYWNoKChwbGF0Zm9ybVBhdGgpID0+IHtcbiAgICAgIHRoaXMubG9hZFBsYXRmb3JtUGF0aChwbGF0Zm9ybVBhdGgpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gVGhpcyBtZXRob2QgaXMgY2FsbGVkIGZyb20gcHJlZmxpZ2h0LmNqcyBpbiBvcmRlciB0byByZXR1cm4gYW4gQXBwIGluc3RhbmNlXG4gIC8vIHRoYXQgY2FuIGJlIHN5bnRoZXNpemVkXG4gIHB1YmxpYyBjcmVhdGVBcHAoYXBwUHJvcHM6IEFwcFByb3BzKTogQXBwIHtcbiAgICB0aGlzLmNyZWF0ZVBsYXRmb3JtSW5zdGFuY2VzKCk7XG4gICAgbGV0IGFwcENhbGwgPSB0aGlzLnBsYXRmb3JtSW5zdGFuY2VzWzBdLm5ld0FwcDtcblxuICAgIGlmICghYXBwQ2FsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTm8gbmV3QXBwIG1ldGhvZCBmb3VuZCBvbiBwbGF0Zm9ybTogJHt0aGlzLnBsYXRmb3JtUGF0aHNbMF19IChIaW50OiBUaGUgZmlyc3QgcGxhdGZvcm0gcHJvdmlkZWQgbXVzdCBoYXZlIGEgbmV3QXBwIG1ldGhvZClgXG4gICAgICApO1xuICAgIH1cblxuICAgIGxldCBob29rcyA9IGNvbGxlY3RIb29rcyh0aGlzLnBsYXRmb3JtSW5zdGFuY2VzKTtcblxuICAgIGNvbnN0IGFwcCA9IGFwcENhbGwhKHtcbiAgICAgIC4uLmFwcFByb3BzLFxuICAgICAgc3ludGhIb29rczogaG9va3Muc3ludGhIb29rcyxcbiAgICAgIG5ld0luc3RhbmNlT3ZlcnJpZGVzOiBob29rcy5uZXdJbnN0YW5jZU92ZXJyaWRlcyxcbiAgICB9KSBhcyBBcHA7XG5cbiAgICBsZXQgc2VjcmV0TmFtZXMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IGMgb2YgYXBwLm5vZGUuZmluZEFsbCgpKSB7XG4gICAgICBpZiAoKGMgYXMgYW55KVtTRUNSRVRfU1lNQk9MXSkge1xuICAgICAgICBjb25zdCBzZWNyZXQgPSBjIGFzIGFueTtcbiAgICAgICAgc2VjcmV0TmFtZXMucHVzaChzZWNyZXQubmFtZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHNlY3JldE5hbWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHdyaXRlRmlsZVN5bmMoXG4gICAgICAgIGpvaW4oYXBwLm91dGRpciwgU0VDUkVUU19GSUxFX05BTUUpLFxuICAgICAgICBKU09OLnN0cmluZ2lmeShzZWNyZXROYW1lcylcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IHJlZ2lzdHJhciA9IGFwcC5wYXJhbWV0ZXJzO1xuXG4gICAgaG9va3MucGFyYW1ldGVyU2NoZW1hcy5mb3JFYWNoKChzY2hlbWEpID0+IHtcbiAgICAgIHJlZ2lzdHJhci5hZGRTY2hlbWEoc2NoZW1hKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBhcHA7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RvcmVTZWNyZXRzKHNlY3JldHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBob29rcyA9IGNvbGxlY3RIb29rcyh0aGlzLnBsYXRmb3JtSW5zdGFuY2VzKTtcbiAgICBpZiAoIWhvb2tzLnN0b3JlU2VjcmV0c0hvb2spIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbm5vdCBmaW5kIGEgcGxhdGZvcm0gb3IgcGxhdGZvcm0gZXh0ZW5zaW9uIHRoYXQgc3VwcG9ydHMgc3RvcmluZyBzZWNyZXRzYFxuICAgICAgKTtcbiAgICB9XG4gICAgYXdhaXQgaG9va3Muc3RvcmVTZWNyZXRzSG9vayhzZWNyZXRzKTtcbiAgfVxufVxuXG4vKipcbiAqIEN1c3RvbSBwbGF0Zm9ybXMgbmVlZCB0byBiZSBsb2FkZWQgaW50byBhIGN1c3RvbSBjb250ZXh0IGluIG9yZGVyIHRvXG4gKiByZXNvbHZlIHRoZWlyIGRlcGVuZGVuY2llcyBjb3JyZWN0bHkuXG4gKlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBfbG9hZEN1c3RvbVBsYXRmb3JtKGN1c3RvbVBsYXRmb3JtUGF0aDogc3RyaW5nKTogYW55IHtcbiAgY29uc3QgaXNTY29wZWQgPSBjdXN0b21QbGF0Zm9ybVBhdGguc3RhcnRzV2l0aChcIkBcIik7XG5cbiAgY29uc3QgcGxhdGZvcm1CYXNlRGlyID0gaXNTY29wZWRcbiAgICA/IGRpcm5hbWUoZGlybmFtZShjdXN0b21QbGF0Zm9ybVBhdGgpKVxuICAgIDogZGlybmFtZShjdXN0b21QbGF0Zm9ybVBhdGgpO1xuXG4gIGNvbnN0IHBsYXRmb3JtRGlyID0gam9pbihwbGF0Zm9ybUJhc2VEaXIsIFwibm9kZV9tb2R1bGVzXCIpO1xuXG4gIC8qKlxuICAgKiBTdXBwb3J0IHBsYXRmb3JtcyB0aGF0IGFyZSBwcm92aWRlZCBhczpcbiAgICogLSBBIHNpbmdsZSBqcyBmaWxlIChlLmcuIFwiL3NvbWUvcGF0aC90by9wbGF0Zm9ybS5qc1wiKVxuICAgKiAtIEEgc2NvcGVkIHBhY2thZ2UgKGUuZy4gXCJAc2NvcGUvcGxhdGZvcm1cIilcbiAgICogLSBBIG5vbi1zY29wZWQgcGFja2FnZSAoZS5nLiBcIi9zb21lL3BhdGgvcGxhdGZvcm1cIilcbiAgICovXG4gIGNvbnN0IGZ1bGxDdXN0b21QbGF0Zm9ybVBhdGggPSBjdXN0b21QbGF0Zm9ybVBhdGguZW5kc1dpdGgoXCIuanNcIilcbiAgICA/IGN1c3RvbVBsYXRmb3JtUGF0aFxuICAgIDogaXNTY29wZWRcbiAgICA/IGpvaW4ocGxhdGZvcm1EaXIsIGAke2N1c3RvbVBsYXRmb3JtUGF0aH0vbGliL2luZGV4LmpzYClcbiAgICA6IGAke2N1c3RvbVBsYXRmb3JtUGF0aH0vaW5kZXguanNgO1xuXG4gIC8vIGVuYWJsZSByZWxhdGl2ZSBpbXBvcnRzIGZyb20gdGhlIHBsYXRmb3JtIGZpbGVcbiAgY29uc3QgY3VzdG9tUGxhdGZvcm1CYXNlRGlyID0gY3VzdG9tUGxhdGZvcm1QYXRoLmVuZHNXaXRoKFwiLmpzXCIpXG4gICAgPyBkaXJuYW1lKGN1c3RvbVBsYXRmb3JtUGF0aClcbiAgICA6IGN1c3RvbVBsYXRmb3JtUGF0aDtcblxuICBjb25zdCBjd2ROb2RlTW9kdWxlcyA9IGpvaW4oY3dkKCksIFwibm9kZV9tb2R1bGVzXCIpO1xuICBjb25zdCBjdXN0b21QbGF0Zm9ybUxpYiA9IGpvaW4oY3dkTm9kZU1vZHVsZXMsIGN1c3RvbVBsYXRmb3JtUGF0aCwgXCJsaWJcIik7XG5cbiAgY29uc3QgcmVzb2x2YWJsZVBhdGhzID0gW1xuICAgIC4uLm1vZHVsZS5wYXRocyxcbiAgICBjdXN0b21QbGF0Zm9ybUJhc2VEaXIsXG4gICAgcGxhdGZvcm1EaXIsXG4gICAgY3dkTm9kZU1vZHVsZXMsXG4gICAgY3VzdG9tUGxhdGZvcm1MaWIsXG4gIF07XG5cbiAgY29uc3QgcmVxdWlyZVJlc29sdmUgPSAocGF0aDogc3RyaW5nKSA9PiB7XG4gICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShwYXRoLCB7XG4gICAgICBwYXRoczogcmVzb2x2YWJsZVBhdGhzLFxuICAgIH0pO1xuICB9O1xuXG4gIGNvbnN0IHBsYXRmb3JtUmVxdWlyZSA9IChwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXJlcXVpcmUtaW1wb3J0c1xuICAgIHJldHVybiByZXF1aXJlKHJlcXVpcmVSZXNvbHZlKHBhdGgpKTtcbiAgfTtcblxuICBwbGF0Zm9ybVJlcXVpcmUucmVzb2x2ZSA9IHJlcXVpcmVSZXNvbHZlO1xuXG4gIGNvbnN0IHBsYXRmb3JtTW9kdWxlID0ge1xuICAgIGV4cG9ydHM6IHt9LFxuICB9O1xuICBjb25zdCBjb250ZXh0ID0gdm0uY3JlYXRlQ29udGV4dCh7XG4gICAgcmVxdWlyZTogcGxhdGZvcm1SZXF1aXJlLFxuICAgIGNvbnNvbGUsXG4gICAgZXhwb3J0czogcGxhdGZvcm1Nb2R1bGUuZXhwb3J0cyxcbiAgICBtb2R1bGU6IHBsYXRmb3JtTW9kdWxlLFxuICAgIHByb2Nlc3MsXG4gICAgX19kaXJuYW1lOiBjdXN0b21QbGF0Zm9ybVBhdGgsXG4gIH0pO1xuXG4gIHRyeSB7XG4gICAgY29uc3QgcGxhdGZvcm1Db2RlID0gcmVhZEZpbGVTeW5jKGZ1bGxDdXN0b21QbGF0Zm9ybVBhdGgsIFwidXRmLThcIik7XG4gICAgY29uc3Qgc2NyaXB0ID0gbmV3IHZtLlNjcmlwdChwbGF0Zm9ybUNvZGUpO1xuICAgIHNjcmlwdC5ydW5JbkNvbnRleHQoY29udGV4dCk7XG4gICAgcmV0dXJuIG5ldyAocGxhdGZvcm1Nb2R1bGUuZXhwb3J0cyBhcyBhbnkpLlBsYXRmb3JtKCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKHByb2Nlc3MuZW52LkRFQlVHKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICB9XG4gICAgY29uc3QgaGludCA9IGN1c3RvbVBsYXRmb3JtUGF0aC5pbmNsdWRlcyhcIi5cIilcbiAgICAgID8gXCJFbnN1cmUgdGhlIHBhdGggdG8gdGhlIHBsYXRmb3JtIGlzIGNvcnJlY3RcIlxuICAgICAgOiBgRW5zdXJlIHlvdSBoYXZlIGluc3RhbGxlZCB0aGUgcGxhdGZvcm0gcHJvdmlkZXIgYnkgcnVubmluZyAnbnBtIGluc3RhbGwgJHtjdXN0b21QbGF0Zm9ybVBhdGh9J2A7XG4gICAgY29uc29sZS5lcnJvcihcbiAgICAgIGBBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBsb2FkaW5nIHRoZSBjdXN0b20gcGxhdGZvcm06ICR7Y3VzdG9tUGxhdGZvcm1QYXRofVxcblxcbihoaW50OiAke2hpbnR9KWBcbiAgICApO1xuICB9XG59XG5cbmludGVyZmFjZSBDb2xsZWN0SG9va3NSZXN1bHQge1xuICBzeW50aEhvb2tzOiBTeW50aEhvb2tzO1xuICBuZXdJbnN0YW5jZU92ZXJyaWRlczogYW55W107XG4gIHBhcmFtZXRlclNjaGVtYXM6IGFueVtdO1xuICBzdG9yZVNlY3JldHNIb29rPzogYW55O1xufVxuXG5mdW5jdGlvbiBjb2xsZWN0SG9va3MocGxhdGZvcm1JbnN0YW5jZXM6IElQbGF0Zm9ybVtdKSB7XG4gIGxldCByZXN1bHQ6IENvbGxlY3RIb29rc1Jlc3VsdCA9IHtcbiAgICBzeW50aEhvb2tzOiB7XG4gICAgICBwcmVTeW50aGVzaXplOiBbXSxcbiAgICAgIHBvc3RTeW50aGVzaXplOiBbXSxcbiAgICAgIHZhbGlkYXRlOiBbXSxcbiAgICB9LFxuICAgIG5ld0luc3RhbmNlT3ZlcnJpZGVzOiBbXSxcbiAgICBwYXJhbWV0ZXJTY2hlbWFzOiBbXSxcbiAgICBzdG9yZVNlY3JldHNIb29rOiB1bmRlZmluZWQsXG4gIH07XG5cbiAgcGxhdGZvcm1JbnN0YW5jZXMuZm9yRWFjaCgoaW5zdGFuY2UpID0+IHtcbiAgICBpZiAoaW5zdGFuY2UucGFyYW1ldGVycykge1xuICAgICAgcmVzdWx0LnBhcmFtZXRlclNjaGVtYXMucHVzaChpbnN0YW5jZS5wYXJhbWV0ZXJzKTtcbiAgICB9XG5cbiAgICBpZiAoaW5zdGFuY2UucHJlU3ludGgpIHtcbiAgICAgIHJlc3VsdC5zeW50aEhvb2tzLnByZVN5bnRoZXNpemUhLnB1c2goaW5zdGFuY2UucHJlU3ludGguYmluZChpbnN0YW5jZSkpO1xuICAgIH1cblxuICAgIGlmIChpbnN0YW5jZS5wb3N0U3ludGgpIHtcbiAgICAgIHJlc3VsdC5zeW50aEhvb2tzLnBvc3RTeW50aGVzaXplIS5wdXNoKGluc3RhbmNlLnBvc3RTeW50aC5iaW5kKGluc3RhbmNlKSk7XG4gICAgfVxuXG4gICAgaWYgKGluc3RhbmNlLnZhbGlkYXRlKSB7XG4gICAgICByZXN1bHQuc3ludGhIb29rcy52YWxpZGF0ZSEucHVzaChpbnN0YW5jZS52YWxpZGF0ZS5iaW5kKGluc3RhbmNlKSk7XG4gICAgfVxuXG4gICAgaWYgKGluc3RhbmNlLm5ld0luc3RhbmNlKSB7XG4gICAgICByZXN1bHQubmV3SW5zdGFuY2VPdmVycmlkZXMucHVzaChpbnN0YW5jZS5uZXdJbnN0YW5jZS5iaW5kKGluc3RhbmNlKSk7XG4gICAgfVxuXG4gICAgaWYgKGluc3RhbmNlLnN0b3JlU2VjcmV0cykge1xuICAgICAgcmVzdWx0LnN0b3JlU2VjcmV0c0hvb2sgPSBpbnN0YW5jZS5zdG9yZVNlY3JldHMuYmluZChpbnN0YW5jZSk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gcmVzdWx0O1xufVxuIl19