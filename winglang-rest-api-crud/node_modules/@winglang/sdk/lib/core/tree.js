"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.synthesizeTree = exports.TREE_FILE_PATH = void 0;
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const std_1 = require("../std");
const base_1 = require("../ui/base");
const colors_1 = require("../ui/colors");
exports.TREE_FILE_PATH = "tree.json";
/**
 * Symbol for accessing jsii runtime information.
 */
const JSII_RUNTIME_SYMBOL = Symbol.for("jsii.rtti");
function constructInfoFromConstruct(construct) {
    const jsiiRuntimeInfo = Object.getPrototypeOf(construct).constructor[JSII_RUNTIME_SYMBOL];
    if (typeof jsiiRuntimeInfo === "object" &&
        jsiiRuntimeInfo !== null &&
        typeof jsiiRuntimeInfo.fqn === "string" &&
        typeof jsiiRuntimeInfo.version === "string") {
        return { fqn: jsiiRuntimeInfo.fqn, version: jsiiRuntimeInfo.version };
    }
    return undefined;
}
function synthesizeTree(app, outdir) {
    const visit = (construct) => {
        const children = construct.node.children.map((c) => visit(c));
        const childrenMap = children
            .filter((child) => child !== undefined)
            .reduce((map, child) => Object.assign(map, { [child.id]: child }), {});
        const node = {
            id: construct.node.id || "App",
            path: construct.node.path,
            children: Object.keys(childrenMap).length === 0 ? undefined : childrenMap,
            constructInfo: constructInfoFromConstruct(construct),
            display: synthDisplay(construct),
        };
        return node;
    };
    const tree = {
        version: "tree-0.1",
        tree: visit(app.node.root),
    };
    fs.writeFileSync(path.join(outdir, exports.TREE_FILE_PATH), JSON.stringify(tree, undefined, 2), { encoding: "utf8" });
}
exports.synthesizeTree = synthesizeTree;
function isIResource(construct) {
    return construct instanceof std_1.Resource;
}
function synthDisplay(construct) {
    if (!isIResource(construct)) {
        return;
    }
    const display = std_1.Node.of(construct);
    const ui = [];
    // generate ui data only based on direct children
    for (const child of construct.node.children) {
        if (base_1.VisualComponent.isVisualComponent(child) &&
            child._newParent === undefined) {
            ui.push(child._toUIComponent());
        }
    }
    if (display.description ||
        display.title ||
        display.hidden ||
        ui ||
        display.color ||
        display.icon) {
        return {
            title: display.title,
            description: display.description,
            hidden: display.hidden,
            sourceModule: display.sourceModule,
            ui: ui.length > 0 ? ui : undefined,
            color: (0, colors_1.isOfTypeColors)(display.color) ? display.color : undefined,
            icon: display.icon,
        };
    }
    return;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb3JlL3RyZWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx1Q0FBeUI7QUFDekIsMkNBQTZCO0FBRzdCLGdDQUFtRDtBQUNuRCxxQ0FBNkM7QUFDN0MseUNBQXNEO0FBRXpDLFFBQUEsY0FBYyxHQUFHLFdBQVcsQ0FBQztBQW9KMUM7O0dBRUc7QUFDSCxNQUFNLG1CQUFtQixHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7QUFpQnBELFNBQVMsMEJBQTBCLENBQ2pDLFNBQXFCO0lBRXJCLE1BQU0sZUFBZSxHQUNuQixNQUFNLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3BFLElBQ0UsT0FBTyxlQUFlLEtBQUssUUFBUTtRQUNuQyxlQUFlLEtBQUssSUFBSTtRQUN4QixPQUFPLGVBQWUsQ0FBQyxHQUFHLEtBQUssUUFBUTtRQUN2QyxPQUFPLGVBQWUsQ0FBQyxPQUFPLEtBQUssUUFBUSxFQUMzQyxDQUFDO1FBQ0QsT0FBTyxFQUFFLEdBQUcsRUFBRSxlQUFlLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxlQUFlLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDeEUsQ0FBQztJQUNELE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUM7QUFFRCxTQUFnQixjQUFjLENBQUMsR0FBUSxFQUFFLE1BQWM7SUFDckQsTUFBTSxLQUFLLEdBQUcsQ0FBQyxTQUFxQixFQUFxQixFQUFFO1FBQ3pELE1BQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUQsTUFBTSxXQUFXLEdBQUcsUUFBUTthQUN6QixNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUM7YUFDdEMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLEtBQU0sQ0FBQyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTFFLE1BQU0sSUFBSSxHQUFzQjtZQUM5QixFQUFFLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksS0FBSztZQUM5QixJQUFJLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJO1lBQ3pCLFFBQVEsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsV0FBVztZQUN6RSxhQUFhLEVBQUUsMEJBQTBCLENBQUMsU0FBUyxDQUFDO1lBQ3BELE9BQU8sRUFBRSxZQUFZLENBQUMsU0FBUyxDQUFDO1NBQ2pDLENBQUM7UUFFRixPQUFPLElBQUksQ0FBQztJQUNkLENBQUMsQ0FBQztJQUVGLE1BQU0sSUFBSSxHQUFrQjtRQUMxQixPQUFPLEVBQUUsVUFBVTtRQUNuQixJQUFJLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0tBQzNCLENBQUM7SUFFRixFQUFFLENBQUMsYUFBYSxDQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLHNCQUFjLENBQUMsRUFDakMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxFQUNsQyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsQ0FDckIsQ0FBQztBQUNKLENBQUM7QUE1QkQsd0NBNEJDO0FBRUQsU0FBUyxXQUFXLENBQUMsU0FBcUI7SUFDeEMsT0FBTyxTQUFTLFlBQVksY0FBUSxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxTQUFxQjtJQUN6QyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7UUFDNUIsT0FBTztJQUNULENBQUM7SUFDRCxNQUFNLE9BQU8sR0FBRyxVQUFJLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRW5DLE1BQU0sRUFBRSxHQUFrQixFQUFFLENBQUM7SUFDN0IsaURBQWlEO0lBQ2pELEtBQUssTUFBTSxLQUFLLElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUM1QyxJQUNFLHNCQUFlLENBQUMsaUJBQWlCLENBQUMsS0FBSyxDQUFDO1lBQ3hDLEtBQUssQ0FBQyxVQUFVLEtBQUssU0FBUyxFQUM5QixDQUFDO1lBQ0QsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUNsQyxDQUFDO0lBQ0gsQ0FBQztJQUVELElBQ0UsT0FBTyxDQUFDLFdBQVc7UUFDbkIsT0FBTyxDQUFDLEtBQUs7UUFDYixPQUFPLENBQUMsTUFBTTtRQUNkLEVBQUU7UUFDRixPQUFPLENBQUMsS0FBSztRQUNiLE9BQU8sQ0FBQyxJQUFJLEVBQ1osQ0FBQztRQUNELE9BQU87WUFDTCxLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7WUFDcEIsV0FBVyxFQUFFLE9BQU8sQ0FBQyxXQUFXO1lBQ2hDLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTTtZQUN0QixZQUFZLEVBQUUsT0FBTyxDQUFDLFlBQVk7WUFDbEMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVM7WUFDbEMsS0FBSyxFQUFFLElBQUEsdUJBQWMsRUFBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVM7WUFDaEUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1NBQ25CLENBQUM7SUFDSixDQUFDO0lBQ0QsT0FBTztBQUNULENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IElDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vYXBwXCI7XG5pbXBvcnQgeyBJUmVzb3VyY2UsIE5vZGUsIFJlc291cmNlIH0gZnJvbSBcIi4uL3N0ZFwiO1xuaW1wb3J0IHsgVmlzdWFsQ29tcG9uZW50IH0gZnJvbSBcIi4uL3VpL2Jhc2VcIjtcbmltcG9ydCB7IENvbG9ycywgaXNPZlR5cGVDb2xvcnMgfSBmcm9tIFwiLi4vdWkvY29sb3JzXCI7XG5cbmV4cG9ydCBjb25zdCBUUkVFX0ZJTEVfUEFUSCA9IFwidHJlZS5qc29uXCI7XG5cbi8qKlxuICogQSBub2RlIGluIHRoZSBjb25zdHJ1Y3QgdHJlZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb25zdHJ1Y3RUcmVlTm9kZSB7XG4gIC8qKlxuICAgKiBUaGUgSUQgb2YgdGhlIG5vZGUuIElzIHBhcnQgb2YgdGhlIGBwYXRoYC5cbiAgICovXG4gIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBwYXRoIG9mIHRoZSBub2RlLlxuICAgKi9cbiAgcmVhZG9ubHkgcGF0aDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgY2hpbGQgbm9kZXMuXG4gICAqL1xuICByZWFkb25seSBjaGlsZHJlbj86IHsgW2tleTogc3RyaW5nXTogQ29uc3RydWN0VHJlZU5vZGUgfTtcblxuICAvKipcbiAgICogVGhlIG5vZGUgYXR0cmlidXRlcy5cbiAgICovXG4gIHJlYWRvbmx5IGF0dHJpYnV0ZXM/OiB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuXG4gIC8qKlxuICAgKiBJbmZvcm1hdGlvbiBvbiB0aGUgY29uc3RydWN0IGNsYXNzIHRoYXQgbGVkIHRvIHRoaXMgbm9kZSwgaWYgYXZhaWxhYmxlLlxuICAgKi9cbiAgcmVhZG9ubHkgY29uc3RydWN0SW5mbz86IENvbnN0cnVjdEluZm87XG5cbiAgLyoqXG4gICAqIEluZm9ybWF0aW9uIG9uIGhvdyB0byBkaXNwbGF5IHRoaXMgbm9kZSBpbiB0aGUgVUkuXG4gICAqL1xuICByZWFkb25seSBkaXNwbGF5PzogRGlzcGxheUluZm87XG59XG5cbi8qKlxuICogSW5mb3JtYXRpb24gb24gaG93IHRvIGRpc3BsYXkgYSBjb25zdHJ1Y3QgaW4gdGhlIFVJLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIERpc3BsYXlJbmZvIHtcbiAgLyoqXG4gICAqIFRpdGxlIG9mIHRoZSByZXNvdXJjZS5cbiAgICogQGRlZmF1bHQgLSBUaGUgdHlwZSBhbmQvb3IgaWRlbnRpZmllciBvZiB0aGUgcmVzb3VyY2VcbiAgICovXG4gIHJlYWRvbmx5IHRpdGxlPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBEZXNjcmlwdGlvbiBvZiB0aGUgcmVzb3VyY2UuXG4gICAqIEBkZWZhdWx0IC0gTm8gZGVzY3JpcHRpb25cbiAgICovXG4gIHJlYWRvbmx5IGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRoZSByZXNvdXJjZSBzaG91bGQgYmUgaGlkZGVuIGZyb20gdGhlIFVJLlxuICAgKiBAZGVmYXVsdCBmYWxzZSAodmlzaWJsZSlcbiAgICovXG4gIHJlYWRvbmx5IGhpZGRlbj86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFRoZSBzb3VyY2UgZmlsZSBvciBsaWJyYXJ5IHdoZXJlIHRoZSBjb25zdHJ1Y3Qgd2FzIGRlZmluZWQuXG4gICAqIEBkZWZhdWx0IC0gbm8gc291cmNlIGluZm9ybWF0aW9uXG4gICAqL1xuICByZWFkb25seSBzb3VyY2VNb2R1bGU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFVJIGNvbXBvbmVudHMgdG8gZGlzcGxheSBmb3IgdGhpcyByZXNvdXJjZS5cbiAgICogQGRlZmF1bHQgLSBubyBVSSBjb21wb25lbnRzXG4gICAqL1xuICByZWFkb25seSB1aT86IGFueVtdOyAvLyBVSUNvbXBvbmVudFxuXG4gIC8qKlxuICAgKiBUaGUgY29sb3Igb2YgdGhlIHJlc291cmNlIGluIHRoZSBVSS5cbiAgICovXG4gIHJlYWRvbmx5IGNvbG9yPzogQ29sb3JzO1xuXG4gIC8qKlxuICAgKiBUaGUgaWNvbiBvZiB0aGUgcmVzb3VyY2UgaW4gdGhlIFVJLlxuICAgKi9cbiAgcmVhZG9ubHkgaWNvbj86IHN0cmluZztcbn1cblxuLyoqIEBpbnRlcm5hbCAqL1xuZXhwb3J0IHR5cGUgVUlDb21wb25lbnQgPVxuICB8IFVJRmllbGRcbiAgfCBVSVNlY3Rpb25cbiAgfCBVSUJ1dHRvblxuICB8IFVJSHR0cENsaWVudFxuICB8IFVJRmlsZUJyb3dzZXI7XG5cbi8qKiBAaW50ZXJuYWwgKi9cbmV4cG9ydCBpbnRlcmZhY2UgVUlGaWVsZCB7XG4gIHJlYWRvbmx5IGtpbmQ6IFwiZmllbGRcIjtcbiAgcmVhZG9ubHkgbGFiZWw6IHN0cmluZztcbiAgLyoqIFRoZSBjb25zdHJ1Y3QgcGF0aCB0byBhIGNsb3VkLkZ1bmN0aW9uICovXG4gIHJlYWRvbmx5IGhhbmRsZXI6IHN0cmluZztcbiAgcmVhZG9ubHkgcmVmcmVzaFJhdGU6IG51bWJlciB8IHVuZGVmaW5lZDtcbiAgcmVhZG9ubHkgbGluaz86IGJvb2xlYW47XG59XG5cbi8qKiBAaW50ZXJuYWwgKi9cbmV4cG9ydCBpbnRlcmZhY2UgVUlCdXR0b24ge1xuICByZWFkb25seSBraW5kOiBcImJ1dHRvblwiO1xuICByZWFkb25seSBsYWJlbDogc3RyaW5nO1xuICAvKiogVGhlIGNvbnN0cnVjdCBwYXRoIHRvIGEgY2xvdWQuRnVuY3Rpb24gKi9cbiAgcmVhZG9ubHkgaGFuZGxlcjogc3RyaW5nO1xufVxuXG4vKiogQGludGVybmFsICovXG5leHBvcnQgaW50ZXJmYWNlIFVJU2VjdGlvbiB7XG4gIHJlYWRvbmx5IGtpbmQ6IFwic2VjdGlvblwiO1xuICByZWFkb25seSBsYWJlbD86IHN0cmluZztcbiAgcmVhZG9ubHkgY2hpbGRyZW46IFVJQ29tcG9uZW50W107XG59XG5cbi8qKiBAaW50ZXJuYWwgKi9cbmV4cG9ydCBpbnRlcmZhY2UgVUlIdHRwQ2xpZW50IHtcbiAgcmVhZG9ubHkga2luZDogXCJodHRwLWNsaWVudFwiO1xuICByZWFkb25seSBsYWJlbDogc3RyaW5nO1xuICByZWFkb25seSBnZXRVcmxIYW5kbGVyOiBzdHJpbmc7XG4gIHJlYWRvbmx5IGdldEFwaVNwZWNIYW5kbGVyOiBzdHJpbmc7XG59XG5cbi8qKiBAaW50ZXJuYWwgKi9cbmV4cG9ydCBpbnRlcmZhY2UgVUlGaWxlQnJvd3NlciB7XG4gIHJlYWRvbmx5IGtpbmQ6IFwiZmlsZS1icm93c2VyXCI7XG4gIHJlYWRvbmx5IGxhYmVsOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHB1dEhhbmRsZXI6IHN0cmluZztcbiAgcmVhZG9ubHkgZGVsZXRlSGFuZGxlcjogc3RyaW5nO1xuICByZWFkb25seSBnZXRIYW5kbGVyOiBzdHJpbmc7XG4gIHJlYWRvbmx5IGxpc3RIYW5kbGVyOiBzdHJpbmc7XG59XG5cbi8qKlxuICogVGhlIGNvbnN0cnVjdCB0cmVlLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbnN0cnVjdFRyZWUge1xuICAvKipcbiAgICogVGhlIGNvbnN0cnVjdCB0cmVlIHZlcnNpb24uXG4gICAqL1xuICByZWFkb25seSB2ZXJzaW9uOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSByb290IG5vZGUuXG4gICAqL1xuICByZWFkb25seSB0cmVlOiBDb25zdHJ1Y3RUcmVlTm9kZTtcbn1cblxuLyoqXG4gKiBTeW1ib2wgZm9yIGFjY2Vzc2luZyBqc2lpIHJ1bnRpbWUgaW5mb3JtYXRpb24uXG4gKi9cbmNvbnN0IEpTSUlfUlVOVElNRV9TWU1CT0wgPSBTeW1ib2wuZm9yKFwianNpaS5ydHRpXCIpO1xuXG4vKipcbiAqIFNvdXJjZSBpbmZvcm1hdGlvbiBvbiBhIGNvbnN0cnVjdCAoY2xhc3MgZnFuIGFuZCB2ZXJzaW9uKS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb25zdHJ1Y3RJbmZvIHtcbiAgLyoqXG4gICAqIEZ1bGx5IHF1YWxpZmllZCBjbGFzcyBuYW1lLlxuICAgKi9cbiAgcmVhZG9ubHkgZnFuOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFZlcnNpb24gb2YgdGhlIG1vZHVsZS5cbiAgICovXG4gIHJlYWRvbmx5IHZlcnNpb246IHN0cmluZztcbn1cblxuZnVuY3Rpb24gY29uc3RydWN0SW5mb0Zyb21Db25zdHJ1Y3QoXG4gIGNvbnN0cnVjdDogSUNvbnN0cnVjdFxuKTogQ29uc3RydWN0SW5mbyB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IGpzaWlSdW50aW1lSW5mbyA9XG4gICAgT2JqZWN0LmdldFByb3RvdHlwZU9mKGNvbnN0cnVjdCkuY29uc3RydWN0b3JbSlNJSV9SVU5USU1FX1NZTUJPTF07XG4gIGlmIChcbiAgICB0eXBlb2YganNpaVJ1bnRpbWVJbmZvID09PSBcIm9iamVjdFwiICYmXG4gICAganNpaVJ1bnRpbWVJbmZvICE9PSBudWxsICYmXG4gICAgdHlwZW9mIGpzaWlSdW50aW1lSW5mby5mcW4gPT09IFwic3RyaW5nXCIgJiZcbiAgICB0eXBlb2YganNpaVJ1bnRpbWVJbmZvLnZlcnNpb24gPT09IFwic3RyaW5nXCJcbiAgKSB7XG4gICAgcmV0dXJuIHsgZnFuOiBqc2lpUnVudGltZUluZm8uZnFuLCB2ZXJzaW9uOiBqc2lpUnVudGltZUluZm8udmVyc2lvbiB9O1xuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzeW50aGVzaXplVHJlZShhcHA6IEFwcCwgb3V0ZGlyOiBzdHJpbmcpIHtcbiAgY29uc3QgdmlzaXQgPSAoY29uc3RydWN0OiBJQ29uc3RydWN0KTogQ29uc3RydWN0VHJlZU5vZGUgPT4ge1xuICAgIGNvbnN0IGNoaWxkcmVuID0gY29uc3RydWN0Lm5vZGUuY2hpbGRyZW4ubWFwKChjKSA9PiB2aXNpdChjKSk7XG4gICAgY29uc3QgY2hpbGRyZW5NYXAgPSBjaGlsZHJlblxuICAgICAgLmZpbHRlcigoY2hpbGQpID0+IGNoaWxkICE9PSB1bmRlZmluZWQpXG4gICAgICAucmVkdWNlKChtYXAsIGNoaWxkKSA9PiBPYmplY3QuYXNzaWduKG1hcCwgeyBbY2hpbGQhLmlkXTogY2hpbGQgfSksIHt9KTtcblxuICAgIGNvbnN0IG5vZGU6IENvbnN0cnVjdFRyZWVOb2RlID0ge1xuICAgICAgaWQ6IGNvbnN0cnVjdC5ub2RlLmlkIHx8IFwiQXBwXCIsXG4gICAgICBwYXRoOiBjb25zdHJ1Y3Qubm9kZS5wYXRoLFxuICAgICAgY2hpbGRyZW46IE9iamVjdC5rZXlzKGNoaWxkcmVuTWFwKS5sZW5ndGggPT09IDAgPyB1bmRlZmluZWQgOiBjaGlsZHJlbk1hcCxcbiAgICAgIGNvbnN0cnVjdEluZm86IGNvbnN0cnVjdEluZm9Gcm9tQ29uc3RydWN0KGNvbnN0cnVjdCksXG4gICAgICBkaXNwbGF5OiBzeW50aERpc3BsYXkoY29uc3RydWN0KSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIG5vZGU7XG4gIH07XG5cbiAgY29uc3QgdHJlZTogQ29uc3RydWN0VHJlZSA9IHtcbiAgICB2ZXJzaW9uOiBcInRyZWUtMC4xXCIsXG4gICAgdHJlZTogdmlzaXQoYXBwLm5vZGUucm9vdCksXG4gIH07XG5cbiAgZnMud3JpdGVGaWxlU3luYyhcbiAgICBwYXRoLmpvaW4ob3V0ZGlyLCBUUkVFX0ZJTEVfUEFUSCksXG4gICAgSlNPTi5zdHJpbmdpZnkodHJlZSwgdW5kZWZpbmVkLCAyKSxcbiAgICB7IGVuY29kaW5nOiBcInV0ZjhcIiB9XG4gICk7XG59XG5cbmZ1bmN0aW9uIGlzSVJlc291cmNlKGNvbnN0cnVjdDogSUNvbnN0cnVjdCk6IGNvbnN0cnVjdCBpcyBJUmVzb3VyY2Uge1xuICByZXR1cm4gY29uc3RydWN0IGluc3RhbmNlb2YgUmVzb3VyY2U7XG59XG5cbmZ1bmN0aW9uIHN5bnRoRGlzcGxheShjb25zdHJ1Y3Q6IElDb25zdHJ1Y3QpOiBEaXNwbGF5SW5mbyB8IHVuZGVmaW5lZCB7XG4gIGlmICghaXNJUmVzb3VyY2UoY29uc3RydWN0KSkge1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCBkaXNwbGF5ID0gTm9kZS5vZihjb25zdHJ1Y3QpO1xuXG4gIGNvbnN0IHVpOiBVSUNvbXBvbmVudFtdID0gW107XG4gIC8vIGdlbmVyYXRlIHVpIGRhdGEgb25seSBiYXNlZCBvbiBkaXJlY3QgY2hpbGRyZW5cbiAgZm9yIChjb25zdCBjaGlsZCBvZiBjb25zdHJ1Y3Qubm9kZS5jaGlsZHJlbikge1xuICAgIGlmIChcbiAgICAgIFZpc3VhbENvbXBvbmVudC5pc1Zpc3VhbENvbXBvbmVudChjaGlsZCkgJiZcbiAgICAgIGNoaWxkLl9uZXdQYXJlbnQgPT09IHVuZGVmaW5lZFxuICAgICkge1xuICAgICAgdWkucHVzaChjaGlsZC5fdG9VSUNvbXBvbmVudCgpKTtcbiAgICB9XG4gIH1cblxuICBpZiAoXG4gICAgZGlzcGxheS5kZXNjcmlwdGlvbiB8fFxuICAgIGRpc3BsYXkudGl0bGUgfHxcbiAgICBkaXNwbGF5LmhpZGRlbiB8fFxuICAgIHVpIHx8XG4gICAgZGlzcGxheS5jb2xvciB8fFxuICAgIGRpc3BsYXkuaWNvblxuICApIHtcbiAgICByZXR1cm4ge1xuICAgICAgdGl0bGU6IGRpc3BsYXkudGl0bGUsXG4gICAgICBkZXNjcmlwdGlvbjogZGlzcGxheS5kZXNjcmlwdGlvbixcbiAgICAgIGhpZGRlbjogZGlzcGxheS5oaWRkZW4sXG4gICAgICBzb3VyY2VNb2R1bGU6IGRpc3BsYXkuc291cmNlTW9kdWxlLFxuICAgICAgdWk6IHVpLmxlbmd0aCA+IDAgPyB1aSA6IHVuZGVmaW5lZCxcbiAgICAgIGNvbG9yOiBpc09mVHlwZUNvbG9ycyhkaXNwbGF5LmNvbG9yKSA/IGRpc3BsYXkuY29sb3IgOiB1bmRlZmluZWQsXG4gICAgICBpY29uOiBkaXNwbGF5Lmljb24sXG4gICAgfTtcbiAgfVxuICByZXR1cm47XG59XG4iXX0=