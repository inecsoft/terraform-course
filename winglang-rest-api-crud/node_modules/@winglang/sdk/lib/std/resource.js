"use strict";
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AutoIdResource = exports.Resource = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const constructs_1 = require("constructs");
const core_1 = require("../core");
const errors_1 = require("../core/errors");
const std_1 = require("../std");
function hasLiftMap(x) {
    return x != null && typeof x._liftMap === "object";
}
/**
 * Shared behavior between all Wing SDK resources.
 * @skipDocs
 * @noinflight
 */
class Resource extends constructs_1.Construct {
    /**
     * A hook called by the Wing compiler once for each inflight host that needs to
     * use this type inflight. The list of requested inflight methods
     * needed by the inflight host are given by `ops`.
     *
     * This method is commonly used for adding permissions, environment variables, or
     * other capabilities to the inflight host.
     */
    static onLiftType(host, ops) {
        host;
        ops;
    }
    /**
     * Generates an asynchronous JavaScript statement which can be used to create an inflight client
     * for a resource.
     *
     * NOTE: This statement must be executed within an async context.
     */
    static toInflight(obj) {
        return obj._toInflight();
    }
    /**
     * Create an instance of this resource with the current App factory.
     * This is commonly used in the constructor of a pseudo-abstract resource class before the super() call.
     *
     * @example
     * ```ts
     * export class MyResource extends Resource {
     *   constructor(scope: Construct, id: string, props: MyResourceProps) {
     *     if (new.target === MyResource) {
     *      return MyResource._newFromFactory(MYRESOURCE_FQN, scope, id, props);
     *     }
     *     super(scope, id);
     *     // ...
     *  ```
     *
     * @internal
     */
    static _newFromFactory(fqn, scope, id, ...props) {
        return core_1.App.of(scope).newAbstract(fqn, scope, id, ...props);
    }
    /**
     * Return a code snippet that can be used to reference this resource inflight.
     *
     * @internal
     * @abstract
     */
    _toInflight() {
        throw new errors_1.AbstractMemberError();
    }
    /**
     * A hook called by the Wing compiler once for each inflight host that needs to
     * use this resource inflight.
     *
     * You can override this method to perform additional logic like granting
     * IAM permissions to the host based on what methods are being called. But
     * you must call `super.bind(host, ops)` to ensure that the resource is
     * actually bound.
     */
    onLift(host, ops) {
        host;
        ops;
    }
    /**
     * A hook for performing operations after the tree of resources has been
     * created, but before they are synthesized.
     *
     * Currently used for binding resources to hosts.
     *
     * @internal
     */
    _preSynthesize() {
        if (hasLiftMap(this) && !(this instanceof AutoIdResource)) {
            addConnectionsFromLiftMap(this, this._liftMap);
        }
    }
}
exports.Resource = Resource;
_a = JSII_RTTI_SYMBOL_1;
Resource[_a] = { fqn: "@winglang/sdk.std.Resource", version: "0.0.0" };
function addConnectionsFromLiftMap(construct, liftData, baseOp) {
    for (const [op, liftEntries] of Object.entries(liftData)) {
        for (const [dep, depOps] of liftEntries) {
            if (constructs_1.Construct.isConstruct(dep) && !(dep instanceof AutoIdResource)) {
                // case 1: dep is an ordinary resource
                for (const depOp of depOps) {
                    std_1.Node.of(construct).addConnection({
                        source: construct,
                        sourceOp: baseOp ?? op,
                        target: dep,
                        targetOp: depOp,
                        name: depOp,
                    });
                }
            }
            else if (hasLiftMap(dep)) {
                // case 2: dep is an inflight
                addConnectionsFromLiftMap(construct, dep._liftMap, baseOp ?? op);
            }
        }
    }
}
/**
 * A resource that has an automatically generated id.
 * Used by the Wing compiler to generate unique ids for auto generated resources
 * from inflight function closures.
 * @noinflight
 */
class AutoIdResource extends Resource {
    constructor(scope, idPrefix = "") {
        const id = core_1.App.of(scope).makeId(scope, idPrefix ? `${idPrefix}_` : "");
        super(scope, id);
    }
}
exports.AutoIdResource = AutoIdResource;
_b = JSII_RTTI_SYMBOL_1;
AutoIdResource[_b] = { fqn: "@winglang/sdk.std.AutoIdResource", version: "0.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RkL3Jlc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsMkNBQW1EO0FBQ25ELGtDQUF1QztBQUN2QywyQ0FBcUQ7QUFDckQsZ0NBQThCO0FBaUc5QixTQUFTLFVBQVUsQ0FBQyxDQUFNO0lBQ3hCLE9BQU8sQ0FBQyxJQUFJLElBQUksSUFBSSxPQUFPLENBQUMsQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDO0FBQ3JELENBQUM7QUFtQkQ7Ozs7R0FJRztBQUNILE1BQXNCLFFBQVMsU0FBUSxzQkFBUztJQUM5Qzs7Ozs7OztPQU9HO0lBQ0ksTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFtQixFQUFFLEdBQWE7UUFDekQsSUFBSSxDQUFDO1FBQ0wsR0FBRyxDQUFDO0lBQ04sQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ksTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFjO1FBQ3JDLE9BQU8sR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRDs7Ozs7Ozs7Ozs7Ozs7OztPQWdCRztJQUNPLE1BQU0sQ0FBQyxlQUFlLENBQzlCLEdBQVcsRUFDWCxLQUFnQixFQUNoQixFQUFVLEVBQ1YsR0FBRyxLQUFZO1FBRWYsT0FBTyxVQUFHLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxHQUFHLEtBQUssQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLFdBQVc7UUFDaEIsTUFBTSxJQUFJLDRCQUFtQixFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVEOzs7Ozs7OztPQVFHO0lBQ0ksTUFBTSxDQUFDLElBQW1CLEVBQUUsR0FBYTtRQUM5QyxJQUFJLENBQUM7UUFDTCxHQUFHLENBQUM7SUFDTixDQUFDO0lBRUQ7Ozs7Ozs7T0FPRztJQUNJLGNBQWM7UUFDbkIsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksWUFBWSxjQUFjLENBQUMsRUFBRSxDQUFDO1lBQzFELHlCQUF5QixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDakQsQ0FBQztJQUNILENBQUM7O0FBdEZILDRCQXVGQzs7O0FBRUQsU0FBUyx5QkFBeUIsQ0FDaEMsU0FBcUIsRUFDckIsUUFBaUIsRUFDakIsTUFBZTtJQUVmLEtBQUssTUFBTSxDQUFDLEVBQUUsRUFBRSxXQUFXLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7UUFDekQsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxJQUFJLFdBQVcsRUFBRSxDQUFDO1lBQ3hDLElBQUksc0JBQVMsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsWUFBWSxjQUFjLENBQUMsRUFBRSxDQUFDO2dCQUNuRSxzQ0FBc0M7Z0JBQ3RDLEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFLENBQUM7b0JBQzNCLFVBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsYUFBYSxDQUFDO3dCQUMvQixNQUFNLEVBQUUsU0FBUzt3QkFDakIsUUFBUSxFQUFFLE1BQU0sSUFBSSxFQUFFO3dCQUN0QixNQUFNLEVBQUUsR0FBRzt3QkFDWCxRQUFRLEVBQUUsS0FBSzt3QkFDZixJQUFJLEVBQUUsS0FBSztxQkFDWixDQUFDLENBQUM7Z0JBQ0wsQ0FBQztZQUNILENBQUM7aUJBQU0sSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDM0IsNkJBQTZCO2dCQUM3Qix5QkFBeUIsQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLFFBQVEsRUFBRSxNQUFNLElBQUksRUFBRSxDQUFDLENBQUM7WUFDbkUsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQUVEOzs7OztHQUtHO0FBQ0gsTUFBc0IsY0FBZSxTQUFRLFFBQVE7SUFDbkQsWUFBWSxLQUFnQixFQUFFLFdBQW1CLEVBQUU7UUFDakQsTUFBTSxFQUFFLEdBQUcsVUFBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdkUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNuQixDQUFDOztBQUpILHdDQUtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0LCBJQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IEFwcCwgTGlmdE1hcCB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBBYnN0cmFjdE1lbWJlckVycm9yIH0gZnJvbSBcIi4uL2NvcmUvZXJyb3JzXCI7XG5pbXBvcnQgeyBOb2RlIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG4vKipcbiAqIEEgcmVzb3VyY2UgdGhhdCBjYW4gcnVuIGluZmxpZ2h0IGNvZGUuXG4gKiBAc2tpcERvY3NcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJSW5mbGlnaHRIb3N0IGV4dGVuZHMgSVJlc291cmNlIHtcbiAgLyoqXG4gICAqIEFkZHMgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUgdG8gdGhlIGhvc3QuXG4gICAqL1xuICBhZGRFbnZpcm9ubWVudChuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiB2b2lkO1xufVxuXG4vKipcbiAqIENvZGUgdGhhdCBydW5zIGF0IHJ1bnRpbWUgYW5kIGltcGxlbWVudHMgeW91ciBhcHBsaWNhdGlvbidzIGJlaGF2aW9yLlxuICogRm9yIGV4YW1wbGUsIGhhbmRsaW5nIEFQSSByZXF1ZXN0cywgcHJvY2Vzc2luZyBxdWV1ZSBtZXNzYWdlcywgZXRjLlxuICogSW5mbGlnaHQgY29kZSBjYW4gYmUgZXhlY3V0ZWQgb24gdmFyaW91cyBjb21wdXRlIHBsYXRmb3JtcyBpbiB0aGUgY2xvdWQsXG4gKiBzdWNoIGFzIGZ1bmN0aW9uIHNlcnZpY2VzIChzdWNoIGFzIEFXUyBMYW1iZGEgb3IgQXp1cmUgRnVuY3Rpb25zKSxcbiAqIGNvbnRhaW5lcnMgKHN1Y2ggYXMgRUNTIG9yIEt1YmVybmV0ZXMpLCBWTXMgb3IgZXZlbiBwaHlzaWNhbCBzZXJ2ZXJzLlxuICpcbiAqIFRoaXMgZGF0YSByZXByZXNlbnRzIHRoZSBjb2RlIHRvZ2V0aGVyIHdpdGggdGhlIGJpbmRpbmdzIHRvIHByZWZsaWdodCBkYXRhIHJlcXVpcmVkIHRvIHJ1bi5cbiAqXG4gKiBAbGluayBodHRwczovL3d3dy53aW5nbGFuZy5pby9kb2NzL2NvbmNlcHRzL2luZmxpZ2h0c1xuICogQHNraXBEb2NzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUluZmxpZ2h0IGV4dGVuZHMgSUhvc3RlZExpZnRhYmxlIHtcbiAgLyoqXG4gICAqIEFuIG9wYXF1ZSBpZGVudGlmaWVyIGZvciB0aGlzIGluZmxpZ2h0IGNvZGUuIFRoaXMgY2FuIGJlIHVzZWQgZm9yIGRldGVybWluaW5nXG4gICAqIHdoZXRoZXIgdHdvIGluZmxpZ2h0IGNsb3N1cmVzIGFyZSBzYW1lIGJ5IGlkZW50aXR5LCBidXQgc2hvdWxkIG5vdCBiZSB1c2VkXG4gICAqIGZvciBhbnkgb3RoZXIgcHVycG9zZSBzaW5jZSBpdCBtYXkgbm90IGJlIHN0YWJsZSBhY3Jvc3MgY29tcGlsYXRpb25zLlxuICAgKlxuICAgKiBDb21wYXJpbmcgaW5mbGlnaHQgY2xvc3VyZXMgZm9yIHZhbHVlIGVxdWFsaXR5IChpLmUuIHdoZXRoZXIgdGhleSB3aWxsIGJ1bmRsZVxuICAgKiBpbnRvIHRoZSBzYW1lIEphdmFTY3JpcHQgY29kZSkgaXNuJ3QgcG9zc2libGUgc2luY2UgdGhlIGV4YWN0IGNvZGUgaXMgb25seVxuICAgKiByZXNvbHZlZCBhZnRlciBhbGwgcHJlZmxpZ2h0IGNvZGUgaGFzIGZpbmlzaGVkIHJ1bm5pbmcgYW5kIHByZWZsaWdodCB2YWx1ZXMgdGhhdFxuICAgKiBhcmUgcmVmZXJlbmNlZCBieSB0aGUgaW5mbGlnaHQgY2xvc3VyZSBoYXZlIHNldHRsZWQgb24gdGhlaXIgdmFsdWVzLlxuICAgKlxuICAgKiBDb25zaWRlciBlLmcuXG4gICAqXG4gICAqIGBgYFxuICAgKiBsZXQgYXJyID0gTXV0QXJyYXk8c3RyPltcImhlbGxvXCJdO1xuICAgKlxuICAgKiBuZXcgY2xvdWQuRnVuY3Rpb24oaW5mbGlnaHQgKCkgPT4ge1xuICAgKiAgIGZvciB4IGluIGFyciB7XG4gICAqICAgICBsb2coeCk7XG4gICAqICAgfVxuICAgKiB9KTtcbiAgICpcbiAgICogYXJyLnB1c2goXCJ3b3JsZFwiKTtcbiAgICogYGBgXG4gICAqXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgX2lkOiBudW1iZXI7XG59XG5cbi8qKlxuICogRGF0YSB0aGF0IGNhbiBiZSBsaWZ0ZWQgaW50byBpbmZsaWdodC5cbiAqIEBza2lwRG9jc1xuICovXG5leHBvcnQgaW50ZXJmYWNlIElMaWZ0YWJsZSB7XG4gIC8qKlxuICAgKiBSZXR1cm4gYSBjb2RlIHNuaXBwZXQgdGhhdCBjYW4gYmUgdXNlZCB0byByZWZlcmVuY2UgdGhpcyByZXNvdXJjZSBpbmZsaWdodC5cbiAgICpcbiAgICogTm90ZSB0aGlzIGNvZGUgc25pcHBldCBtYXkgYmUgYXN5bmMgY29kZSwgc28gaXQncyB1bnNhZmUgdG8gcnVuIGl0IGluIGFcbiAgICogY29uc3RydWN0b3Igb3Igb3RoZXIgc3luYyBjb250ZXh0LlxuICAgKlxuICAgKiBAaW50ZXJuYWxcbiAgICovXG4gIF90b0luZmxpZ2h0KCk6IHN0cmluZztcbn1cblxuLyoqXG4gKiBBIGxpZnRhYmxlIG9iamVjdCB0aGF0IG5lZWRzIHRvIGJlIHJlZ2lzdGVyZWQgb24gdGhlIGhvc3QgYXMgcGFydCBvZlxuICogdGhlIGxpZnRpbmcgcHJvY2Vzcy5cbiAqIFRoaXMgaXMgZ2VuZXJhbGx5IHVzZWQgc28gdGhlIGhvc3QgY2FuIHNldCB1cCBwZXJtaXNzaW9uc1xuICogdG8gYWNjZXNzIHRoZSBsaWZ0ZWQgb2JqZWN0IGluZmxpZ2h0LlxuICovXG5leHBvcnQgaW50ZXJmYWNlIElIb3N0ZWRMaWZ0YWJsZSBleHRlbmRzIElMaWZ0YWJsZSB7XG4gIC8qKlxuICAgKiBDb21waWxlci1nZW5lcmF0ZWQgZGF0YSB0aGF0IGRlc2NyaWJlcyB0aGUgZGVwZW5kZW5jaWVzIG9mIHRoaXMgb2JqZWN0IG9uIG90aGVyXG4gICAqIG9iamVjdHMuIFRoaXMgaXMgdXNlZCB0byBkZXRlcm1pbmUgd2hpY2ggcGVybWlzc2lvbnMgbmVlZCB0byBiZSBncmFudGVkIHRvIHRoZVxuICAgKiBpbmZsaWdodCBob3N0LlxuICAgKiBAaW50ZXJuYWxcbiAgICovXG4gIF9saWZ0TWFwPzogTGlmdE1hcDtcblxuICAvKipcbiAgICogQSBob29rIGNhbGxlZCBieSB0aGUgV2luZyBjb21waWxlciBvbmNlIGZvciBlYWNoIGluZmxpZ2h0IGhvc3QgdGhhdCBuZWVkcyB0b1xuICAgKiB1c2UgdGhpcyBvYmplY3QgaW5mbGlnaHQuIFRoZSBsaXN0IG9mIHJlcXVlc3RlZCBpbmZsaWdodCBtZXRob2RzXG4gICAqIG5lZWRlZCBieSB0aGUgaW5mbGlnaHQgaG9zdCBhcmUgZ2l2ZW4gYnkgYG9wc2AuXG4gICAqXG4gICAqIFRoaXMgbWV0aG9kIGlzIGNvbW1vbmx5IHVzZWQgZm9yIGFkZGluZyBwZXJtaXNzaW9ucywgZW52aXJvbm1lbnQgdmFyaWFibGVzLCBvclxuICAgKiBvdGhlciBjYXBhYmlsaXRpZXMgdG8gdGhlIGluZmxpZ2h0IGhvc3QuXG4gICAqL1xuICBvbkxpZnQoaG9zdDogSUluZmxpZ2h0SG9zdCwgb3BzOiBzdHJpbmdbXSk6IHZvaWQ7XG59XG5cbmZ1bmN0aW9uIGhhc0xpZnRNYXAoeDogYW55KTogeCBpcyB7IF9saWZ0TWFwOiBMaWZ0TWFwIH0ge1xuICByZXR1cm4geCAhPSBudWxsICYmIHR5cGVvZiB4Ll9saWZ0TWFwID09PSBcIm9iamVjdFwiO1xufVxuXG4vKipcbiAqIEFic3RyYWN0IGludGVyZmFjZSBmb3IgYFJlc291cmNlYC5cbiAqIEBza2lwRG9jc1xuICogQG5vaW5mbGlnaHRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJUmVzb3VyY2UgZXh0ZW5kcyBJQ29uc3RydWN0LCBJSG9zdGVkTGlmdGFibGUge1xuICAvKipcbiAgICogQSBob29rIGZvciBwZXJmb3JtaW5nIG9wZXJhdGlvbnMgYWZ0ZXIgdGhlIHRyZWUgb2YgcmVzb3VyY2VzIGhhcyBiZWVuXG4gICAqIGNyZWF0ZWQsIGJ1dCBiZWZvcmUgdGhleSBhcmUgc3ludGhlc2l6ZWQuXG4gICAqXG4gICAqIEN1cnJlbnRseSB1c2VkIGZvciBiaW5kaW5nIHJlc291cmNlcyB0byBob3N0cy5cbiAgICpcbiAgICogQGludGVybmFsXG4gICAqL1xuICBfcHJlU3ludGhlc2l6ZSgpOiB2b2lkO1xufVxuXG4vKipcbiAqIFNoYXJlZCBiZWhhdmlvciBiZXR3ZWVuIGFsbCBXaW5nIFNESyByZXNvdXJjZXMuXG4gKiBAc2tpcERvY3NcbiAqIEBub2luZmxpZ2h0XG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSZXNvdXJjZSBleHRlbmRzIENvbnN0cnVjdCBpbXBsZW1lbnRzIElSZXNvdXJjZSB7XG4gIC8qKlxuICAgKiBBIGhvb2sgY2FsbGVkIGJ5IHRoZSBXaW5nIGNvbXBpbGVyIG9uY2UgZm9yIGVhY2ggaW5mbGlnaHQgaG9zdCB0aGF0IG5lZWRzIHRvXG4gICAqIHVzZSB0aGlzIHR5cGUgaW5mbGlnaHQuIFRoZSBsaXN0IG9mIHJlcXVlc3RlZCBpbmZsaWdodCBtZXRob2RzXG4gICAqIG5lZWRlZCBieSB0aGUgaW5mbGlnaHQgaG9zdCBhcmUgZ2l2ZW4gYnkgYG9wc2AuXG4gICAqXG4gICAqIFRoaXMgbWV0aG9kIGlzIGNvbW1vbmx5IHVzZWQgZm9yIGFkZGluZyBwZXJtaXNzaW9ucywgZW52aXJvbm1lbnQgdmFyaWFibGVzLCBvclxuICAgKiBvdGhlciBjYXBhYmlsaXRpZXMgdG8gdGhlIGluZmxpZ2h0IGhvc3QuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIG9uTGlmdFR5cGUoaG9zdDogSUluZmxpZ2h0SG9zdCwgb3BzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIGhvc3Q7XG4gICAgb3BzO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlcyBhbiBhc3luY2hyb25vdXMgSmF2YVNjcmlwdCBzdGF0ZW1lbnQgd2hpY2ggY2FuIGJlIHVzZWQgdG8gY3JlYXRlIGFuIGluZmxpZ2h0IGNsaWVudFxuICAgKiBmb3IgYSByZXNvdXJjZS5cbiAgICpcbiAgICogTk9URTogVGhpcyBzdGF0ZW1lbnQgbXVzdCBiZSBleGVjdXRlZCB3aXRoaW4gYW4gYXN5bmMgY29udGV4dC5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgdG9JbmZsaWdodChvYmo6IElSZXNvdXJjZSkge1xuICAgIHJldHVybiBvYmouX3RvSW5mbGlnaHQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYW4gaW5zdGFuY2Ugb2YgdGhpcyByZXNvdXJjZSB3aXRoIHRoZSBjdXJyZW50IEFwcCBmYWN0b3J5LlxuICAgKiBUaGlzIGlzIGNvbW1vbmx5IHVzZWQgaW4gdGhlIGNvbnN0cnVjdG9yIG9mIGEgcHNldWRvLWFic3RyYWN0IHJlc291cmNlIGNsYXNzIGJlZm9yZSB0aGUgc3VwZXIoKSBjYWxsLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGB0c1xuICAgKiBleHBvcnQgY2xhc3MgTXlSZXNvdXJjZSBleHRlbmRzIFJlc291cmNlIHtcbiAgICogICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogTXlSZXNvdXJjZVByb3BzKSB7XG4gICAqICAgICBpZiAobmV3LnRhcmdldCA9PT0gTXlSZXNvdXJjZSkge1xuICAgKiAgICAgIHJldHVybiBNeVJlc291cmNlLl9uZXdGcm9tRmFjdG9yeShNWVJFU09VUkNFX0ZRTiwgc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAqICAgICB9XG4gICAqICAgICBzdXBlcihzY29wZSwgaWQpO1xuICAgKiAgICAgLy8gLi4uXG4gICAqICBgYGBcbiAgICpcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwcm90ZWN0ZWQgc3RhdGljIF9uZXdGcm9tRmFjdG9yeTxUUmVzb3VyY2UgZXh0ZW5kcyBSZXNvdXJjZT4oXG4gICAgZnFuOiBzdHJpbmcsXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBpZDogc3RyaW5nLFxuICAgIC4uLnByb3BzOiBhbnlbXVxuICApOiBUUmVzb3VyY2Uge1xuICAgIHJldHVybiBBcHAub2Yoc2NvcGUpLm5ld0Fic3RyYWN0KGZxbiwgc2NvcGUsIGlkLCAuLi5wcm9wcyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGEgY29kZSBzbmlwcGV0IHRoYXQgY2FuIGJlIHVzZWQgdG8gcmVmZXJlbmNlIHRoaXMgcmVzb3VyY2UgaW5mbGlnaHQuXG4gICAqXG4gICAqIEBpbnRlcm5hbFxuICAgKiBAYWJzdHJhY3RcbiAgICovXG4gIHB1YmxpYyBfdG9JbmZsaWdodCgpOiBzdHJpbmcge1xuICAgIHRocm93IG5ldyBBYnN0cmFjdE1lbWJlckVycm9yKCk7XG4gIH1cblxuICAvKipcbiAgICogQSBob29rIGNhbGxlZCBieSB0aGUgV2luZyBjb21waWxlciBvbmNlIGZvciBlYWNoIGluZmxpZ2h0IGhvc3QgdGhhdCBuZWVkcyB0b1xuICAgKiB1c2UgdGhpcyByZXNvdXJjZSBpbmZsaWdodC5cbiAgICpcbiAgICogWW91IGNhbiBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwZXJmb3JtIGFkZGl0aW9uYWwgbG9naWMgbGlrZSBncmFudGluZ1xuICAgKiBJQU0gcGVybWlzc2lvbnMgdG8gdGhlIGhvc3QgYmFzZWQgb24gd2hhdCBtZXRob2RzIGFyZSBiZWluZyBjYWxsZWQuIEJ1dFxuICAgKiB5b3UgbXVzdCBjYWxsIGBzdXBlci5iaW5kKGhvc3QsIG9wcylgIHRvIGVuc3VyZSB0aGF0IHRoZSByZXNvdXJjZSBpc1xuICAgKiBhY3R1YWxseSBib3VuZC5cbiAgICovXG4gIHB1YmxpYyBvbkxpZnQoaG9zdDogSUluZmxpZ2h0SG9zdCwgb3BzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIGhvc3Q7XG4gICAgb3BzO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgaG9vayBmb3IgcGVyZm9ybWluZyBvcGVyYXRpb25zIGFmdGVyIHRoZSB0cmVlIG9mIHJlc291cmNlcyBoYXMgYmVlblxuICAgKiBjcmVhdGVkLCBidXQgYmVmb3JlIHRoZXkgYXJlIHN5bnRoZXNpemVkLlxuICAgKlxuICAgKiBDdXJyZW50bHkgdXNlZCBmb3IgYmluZGluZyByZXNvdXJjZXMgdG8gaG9zdHMuXG4gICAqXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIF9wcmVTeW50aGVzaXplKCk6IHZvaWQge1xuICAgIGlmIChoYXNMaWZ0TWFwKHRoaXMpICYmICEodGhpcyBpbnN0YW5jZW9mIEF1dG9JZFJlc291cmNlKSkge1xuICAgICAgYWRkQ29ubmVjdGlvbnNGcm9tTGlmdE1hcCh0aGlzLCB0aGlzLl9saWZ0TWFwKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gYWRkQ29ubmVjdGlvbnNGcm9tTGlmdE1hcChcbiAgY29uc3RydWN0OiBJQ29uc3RydWN0LFxuICBsaWZ0RGF0YTogTGlmdE1hcCxcbiAgYmFzZU9wPzogc3RyaW5nXG4pIHtcbiAgZm9yIChjb25zdCBbb3AsIGxpZnRFbnRyaWVzXSBvZiBPYmplY3QuZW50cmllcyhsaWZ0RGF0YSkpIHtcbiAgICBmb3IgKGNvbnN0IFtkZXAsIGRlcE9wc10gb2YgbGlmdEVudHJpZXMpIHtcbiAgICAgIGlmIChDb25zdHJ1Y3QuaXNDb25zdHJ1Y3QoZGVwKSAmJiAhKGRlcCBpbnN0YW5jZW9mIEF1dG9JZFJlc291cmNlKSkge1xuICAgICAgICAvLyBjYXNlIDE6IGRlcCBpcyBhbiBvcmRpbmFyeSByZXNvdXJjZVxuICAgICAgICBmb3IgKGNvbnN0IGRlcE9wIG9mIGRlcE9wcykge1xuICAgICAgICAgIE5vZGUub2YoY29uc3RydWN0KS5hZGRDb25uZWN0aW9uKHtcbiAgICAgICAgICAgIHNvdXJjZTogY29uc3RydWN0LFxuICAgICAgICAgICAgc291cmNlT3A6IGJhc2VPcCA/PyBvcCxcbiAgICAgICAgICAgIHRhcmdldDogZGVwLFxuICAgICAgICAgICAgdGFyZ2V0T3A6IGRlcE9wLFxuICAgICAgICAgICAgbmFtZTogZGVwT3AsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoaGFzTGlmdE1hcChkZXApKSB7XG4gICAgICAgIC8vIGNhc2UgMjogZGVwIGlzIGFuIGluZmxpZ2h0XG4gICAgICAgIGFkZENvbm5lY3Rpb25zRnJvbUxpZnRNYXAoY29uc3RydWN0LCBkZXAuX2xpZnRNYXAsIGJhc2VPcCA/PyBvcCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQSByZXNvdXJjZSB0aGF0IGhhcyBhbiBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBpZC5cbiAqIFVzZWQgYnkgdGhlIFdpbmcgY29tcGlsZXIgdG8gZ2VuZXJhdGUgdW5pcXVlIGlkcyBmb3IgYXV0byBnZW5lcmF0ZWQgcmVzb3VyY2VzXG4gKiBmcm9tIGluZmxpZ2h0IGZ1bmN0aW9uIGNsb3N1cmVzLlxuICogQG5vaW5mbGlnaHRcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEF1dG9JZFJlc291cmNlIGV4dGVuZHMgUmVzb3VyY2Uge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZFByZWZpeDogc3RyaW5nID0gXCJcIikge1xuICAgIGNvbnN0IGlkID0gQXBwLm9mKHNjb3BlKS5tYWtlSWQoc2NvcGUsIGlkUHJlZml4ID8gYCR7aWRQcmVmaXh9X2AgOiBcIlwiKTtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuICB9XG59XG5cbi8qKlxuICogQW5ub3RhdGlvbnMgYWJvdXQgcHJlZmxpZ2h0IGRhdGEgYW5kIGRlc2lyZWQgaW5mbGlnaHQgb3BlcmF0aW9ucy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBMaWZ0QW5ub3RhdGlvbiB7XG4gIC8qKlxuICAgKiBQcmVmbGlnaHQgb2JqZWN0IHRvIGxpZnRcbiAgICovXG4gIHJlYWRvbmx5IG9iajogYW55O1xuXG4gIC8qKlxuICAgKiBOYW1lIG9mIHRoZSBvYmplY3QgaW4gdGhlIGluZmxpZ2h0IGNvbnRleHQuXG4gICAqIFJlcXVpcmVkIGlmIHRoZSBvYmplY3QgcHJvdmlkZWQgaXMgbm90IGFuIGlkZW50aWZpZXIuXG4gICAqIEBkZWZhdWx0IFwib2JqXCIgSWYgdGhlIG9iamVjdCBpcyBhIHNpbXBsZSBpZGVudGlmaWVyLCBpdCB3aWxsIGJlIHVzZWQgYXMgdGhlIGFsaWFzXG4gICAqL1xuICByZWFkb25seSBhbGlhcz86IHN0cmluZztcblxuICAvKipcbiAgICogT3BlcmF0aW9ucyB0byBsaWZ0IG9uIHRoZSBvYmplY3QuXG4gICAqIEBkZWZhdWx0ICogQWxsIHBvc3NpYmxlIG9wZXJhdGlvbnMgd2lsbCBiZSBhdmFpbGFibGVcbiAgICovXG4gIHJlYWRvbmx5IG9wcz86IHN0cmluZ1tdO1xufVxuXG4vKiogT3B0aW9ucyBmb3IgdGhlIGBAaW5mbGlnaHRgIGludHJpbnNpYyAqL1xuZXhwb3J0IGludGVyZmFjZSBJbXBvcnRJbmZsaWdodE9wdGlvbnMge1xuICAvKipcbiAgICogTmFtZSBvZiBleHBvcnRlZCBmdW5jdGlvblxuICAgKiBAZGVmYXVsdCBcImRlZmF1bHRcIlxuICAgKiAqL1xuICByZWFkb25seSBleHBvcnQ/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBNYXBwaW5nIG9mIGF2YWlsYWJsZSBzeW1ib2xzIHRvIGEgbGlmdCBkZWNsYXJhdGlvblxuICAgKiBAZGVmYXVsdCAqIEFsbCBwb3NzaWJsZSBvcGVyYXRpb25zIHdpbGwgYmUgYXZhaWxhYmxlXG4gICAqL1xuICByZWFkb25seSBsaWZ0cz86IExpZnRBbm5vdGF0aW9uW107XG59XG4iXX0=