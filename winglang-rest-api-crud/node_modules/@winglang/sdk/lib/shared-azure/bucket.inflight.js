"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BucketClient = void 0;
const identity_1 = require("@azure/identity");
const storage_blob_1 = require("@azure/storage-blob");
const mime_types_1 = __importDefault(require("mime-types"));
const std_1 = require("../std");
class BucketClient {
    constructor(bucketName, storageAccount, blobServiceClient) {
        this.defaultAzureCredential = new identity_1.DefaultAzureCredential();
        this.bucketName = bucketName;
        this.storageAccount = storageAccount;
        this.blobServiceClient =
            blobServiceClient ??
                new storage_blob_1.BlobServiceClient(`https://${storageAccount}.blob.core.windows.net`, this.defaultAzureCredential);
        this.containerClient = this.blobServiceClient.getContainerClient(this.bucketName);
    }
    /**
     * Check if an object exists in the bucket
     *
     * @param key Key of the object
     */
    async exists(key) {
        const blobClient = this.containerClient.getBlobClient(key);
        return blobClient.exists();
    }
    /**
     * Put object into bucket with given body contents
     *
     * @param key Key of the object
     * @param body string contents of the object
     */
    async put(key, body, opts) {
        const blobClient = this.containerClient.getBlockBlobClient(key);
        const options = {
            blobHTTPHeaders: {
                blobContentType: (opts?.contentType ?? mime_types_1.default.lookup(key)) || "application/octet-stream",
            },
        };
        await blobClient.upload(body, body.length, options);
    }
    /**
     * Put Json object into bucket with given body contents
     *
     * @param key Key of the object
     * @param body Json object
     */
    async putJson(key, body) {
        await this.put(key, JSON.stringify(body, null, 2), {
            contentType: "application/json",
        });
    }
    /**
     * Get an object from the bucket
     *
     * @param key Key of the object
     * @returns string content of the object as string
     */
    async get(key, options) {
        const blobClient = this.containerClient.getBlobClient(key);
        let downloadResponse;
        try {
            const start = options?.startByte !== undefined ? options.startByte : 0;
            const length = options?.endByte !== undefined ? options.endByte - start : undefined;
            downloadResponse = await blobClient.download(start, length);
        }
        catch (e) {
            throw new Error(`Object does not exist (key=${key}).`);
        }
        if (downloadResponse.readableStreamBody === undefined) {
            return "";
        }
        try {
            return new TextDecoder("utf8", { fatal: true }).decode(await this.streamToBuffer(downloadResponse.readableStreamBody));
        }
        catch (e) {
            throw new Error(`Object contents could not be read as text (key=${key}): ${e.stack})}`);
        }
    }
    /**
     * Get an object from the bucket if it exists
     *
     * @param key Key of the object
     * @returns string content of the object as string
     */
    async tryGet(key, options) {
        if (await this.exists(key)) {
            return this.get(key, options);
        }
        return undefined;
    }
    /**
     * Get a Json object from the bucket
     *
     * @param key Key of the object
     * @returns Json content of the object
     */
    async getJson(key) {
        return JSON.parse(await this.get(key));
    }
    /**
     * Get a Json object from the bucket if it exists
     *
     * @param key Key of the object
     * @returns Json content of the object
     */
    async tryGetJson(key) {
        if (await this.exists(key)) {
            return this.getJson(key);
        }
        return undefined;
    }
    /**
     * Delete an object from the bucket
     *
     * @param key Key of the object
     * @param opts Option object supporting additional strategies to delete item from a bucket
     */
    async delete(key, opts = {}) {
        const mustExist = opts.mustExist ?? false;
        const blockBlobClient = this.containerClient.getBlockBlobClient(key);
        try {
            await blockBlobClient.delete();
        }
        catch (err) {
            const error = err;
            if (error.details.errorCode === "BlobNotFound") {
                if (mustExist) {
                    throw new Error(`Object does not exist (key=${key}).`);
                }
                else {
                    return;
                }
            }
            throw Error(`Failed to delete object (key=${key}).`);
        }
    }
    /**
     * Delete an object from the bucket if it exists
     *
     * @param key Key of the object
     * @param opts Option object supporting additional strategies to delete item from a bucket
     */
    async tryDelete(key) {
        if (await this.exists(key)) {
            await this.delete(key);
            return true;
        }
        return false;
    }
    /**
     * List all keys in the bucket
     *
     * @param prefix Limits the response to keys that begin with the specified prefix
     */
    async list(prefix) {
        const list = [];
        for await (const blob of this.containerClient.listBlobsFlat({ prefix })) {
            list.push(blob.name);
        }
        return list;
    }
    async signedUrl(key, options) {
        options;
        throw new Error(`signedUrl is not implemented yet for tf-azure (key=${key})`);
    }
    /**
     * Returns a url to the given file.
     * @Throws if the file is not public or if object does not exist.
     */
    // TODO: NOT SUPPORTED!! - see https://github.com/winglang/wing/issues/5117
    async publicUrl(key) {
        // this returns an optional `blobPublicAccess` prop - if exists the bucket is public
        const accessPolicy = await this.containerClient.getAccessPolicy();
        if (!accessPolicy?.blobPublicAccess) {
            throw new Error("Cannot provide public url for a non-public bucket");
        }
        if (!(await this.exists(key))) {
            throw new Error(`Cannot provide public url for a non-existent key (key=${key})`);
        }
        return encodeURI(`https://${this.storageAccount}.blob.core.windows.net/${this.bucketName}/${key}`);
    }
    /**
     * Get the metadata of an object in the bucket.
     * @param key Key of the object.
     * @throws if the object does not exist.
     */
    async metadata(key) {
        const blobClient = this.containerClient.getBlobClient(key);
        try {
            const properties = await blobClient.getProperties();
            return {
                contentType: properties.contentType,
                lastModified: std_1.Datetime.fromDate(properties.lastModified),
                size: properties.contentLength,
            };
        }
        catch (error) {
            throw new Error(`Object does not exist (key=${key}).`);
        }
    }
    /**
     * Copy object within the bucket
     *
     * @param srcKey The key of the source object you wish to copy.
     * @param dstKey The key of the destination object after copying.
     * @throws if `srcKey` object doesn't exist.
     */
    async copy(srcKey, dstKey) {
        const srcBlobUrl = this.containerClient.getBlobClient(srcKey).url;
        const dstBlobClient = this.containerClient.getBlockBlobClient(dstKey);
        try {
            await dstBlobClient.syncCopyFromURL(srcBlobUrl);
        }
        catch (error) {
            throw new Error(`Source object does not exist (srcKey=${srcKey}).`);
        }
    }
    /**
     * Move object within the container
     *
     * @param srcKey The key of the source object you wish to rename.
     * @param dstKey The key of the destination object after rename.
     * @throws if `srcKey` object doesn't exist or if it matches `dstKey`.
     */
    async rename(srcKey, dstKey) {
        return Promise.reject(`rename is not implemented: (srcKey=${srcKey}, dstKey=${dstKey})`);
    }
    /**
     * Required helper function for node js only.
     *
     * See https://github.com/Azure/azure-sdk-for-js/tree/main/sdk/storage/storage-blob
     */
    streamToBuffer(stream) {
        return new Promise((resolve, reject) => {
            const chunks = [];
            stream.on("data", (data) => {
                chunks.push(Buffer.isBuffer(data) ? data : Buffer.from(data));
            });
            stream.on("end", () => {
                resolve(Buffer.concat(chunks));
            });
            stream.on("error", reject);
        });
    }
}
exports.BucketClient = BucketClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmluZmxpZ2h0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NoYXJlZC1henVyZS9idWNrZXQuaW5mbGlnaHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsOENBQXlEO0FBQ3pELHNEQUk2QjtBQUM3Qiw0REFBOEI7QUFVOUIsZ0NBQXdDO0FBRXhDLE1BQWEsWUFBWTtJQVF2QixZQUNFLFVBQWtCLEVBQ2xCLGNBQXNCLEVBQ3RCLGlCQUFxQztRQU50QiwyQkFBc0IsR0FDckMsSUFBSSxpQ0FBc0IsRUFBRSxDQUFDO1FBTzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxpQkFBaUI7WUFDcEIsaUJBQWlCO2dCQUNqQixJQUFJLGdDQUFpQixDQUNuQixXQUFXLGNBQWMsd0JBQXdCLEVBQ2pELElBQUksQ0FBQyxzQkFBc0IsQ0FDNUIsQ0FBQztRQUNKLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGtCQUFrQixDQUM5RCxJQUFJLENBQUMsVUFBVSxDQUNoQixDQUFDO0lBQ0osQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQVc7UUFDN0IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDM0QsT0FBTyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ksS0FBSyxDQUFDLEdBQUcsQ0FDZCxHQUFXLEVBQ1gsSUFBWSxFQUNaLElBQXVCO1FBRXZCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEUsTUFBTSxPQUFPLEdBQUc7WUFDZCxlQUFlLEVBQUU7Z0JB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QU0sRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFO2dCQUN6QixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2hFLENBQUMsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFO2dCQUNwQixPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2pDLENBQUMsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDN0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFoVEQsb0NBZ1RDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVmYXVsdEF6dXJlQ3JlZGVudGlhbCB9IGZyb20gXCJAYXp1cmUvaWRlbnRpdHlcIjtcbmltcG9ydCB7XG4gIEJsb2JEb3dubG9hZFJlc3BvbnNlUGFyc2VkLFxuICBCbG9iU2VydmljZUNsaWVudCxcbiAgQ29udGFpbmVyQ2xpZW50LFxufSBmcm9tIFwiQGF6dXJlL3N0b3JhZ2UtYmxvYlwiO1xuaW1wb3J0IG1pbWUgZnJvbSBcIm1pbWUtdHlwZXNcIjtcbmltcG9ydCB7XG4gIElCdWNrZXRDbGllbnQsXG4gIE9iamVjdE1ldGFkYXRhLFxuICBCdWNrZXRQdXRPcHRpb25zLFxuICBCdWNrZXREZWxldGVPcHRpb25zLFxuICBCdWNrZXRTaWduZWRVcmxPcHRpb25zLFxuICBCdWNrZXRHZXRPcHRpb25zLFxuICBCdWNrZXRUcnlHZXRPcHRpb25zLFxufSBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCB7IERhdGV0aW1lLCBKc29uIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG5leHBvcnQgY2xhc3MgQnVja2V0Q2xpZW50IGltcGxlbWVudHMgSUJ1Y2tldENsaWVudCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgYnVja2V0TmFtZTogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHN0b3JhZ2VBY2NvdW50OiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgYmxvYlNlcnZpY2VDbGllbnQ6IEJsb2JTZXJ2aWNlQ2xpZW50O1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbnRhaW5lckNsaWVudDogQ29udGFpbmVyQ2xpZW50O1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRBenVyZUNyZWRlbnRpYWw6IERlZmF1bHRBenVyZUNyZWRlbnRpYWwgPVxuICAgIG5ldyBEZWZhdWx0QXp1cmVDcmVkZW50aWFsKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgYnVja2V0TmFtZTogc3RyaW5nLFxuICAgIHN0b3JhZ2VBY2NvdW50OiBzdHJpbmcsXG4gICAgYmxvYlNlcnZpY2VDbGllbnQ/OiBCbG9iU2VydmljZUNsaWVudFxuICApIHtcbiAgICB0aGlzLmJ1Y2tldE5hbWUgPSBidWNrZXROYW1lO1xuICAgIHRoaXMuc3RvcmFnZUFjY291bnQgPSBzdG9yYWdlQWNjb3VudDtcbiAgICB0aGlzLmJsb2JTZXJ2aWNlQ2xpZW50ID1cbiAgICAgIGJsb2JTZXJ2aWNlQ2xpZW50ID8/XG4gICAgICBuZXcgQmxvYlNlcnZpY2VDbGllbnQoXG4gICAgICAgIGBodHRwczovLyR7c3RvcmFnZUFjY291bnR9LmJsb2IuY29yZS53aW5kb3dzLm5ldGAsXG4gICAgICAgIHRoaXMuZGVmYXVsdEF6dXJlQ3JlZGVudGlhbFxuICAgICAgKTtcbiAgICB0aGlzLmNvbnRhaW5lckNsaWVudCA9IHRoaXMuYmxvYlNlcnZpY2VDbGllbnQuZ2V0Q29udGFpbmVyQ2xpZW50KFxuICAgICAgdGhpcy5idWNrZXROYW1lXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBhbiBvYmplY3QgZXhpc3RzIGluIHRoZSBidWNrZXRcbiAgICpcbiAgICogQHBhcmFtIGtleSBLZXkgb2YgdGhlIG9iamVjdFxuICAgKi9cbiAgcHVibGljIGFzeW5jIGV4aXN0cyhrZXk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGJsb2JDbGllbnQgPSB0aGlzLmNvbnRhaW5lckNsaWVudC5nZXRCbG9iQ2xpZW50KGtleSk7XG4gICAgcmV0dXJuIGJsb2JDbGllbnQuZXhpc3RzKCk7XG4gIH1cblxuICAvKipcbiAgICogUHV0IG9iamVjdCBpbnRvIGJ1Y2tldCB3aXRoIGdpdmVuIGJvZHkgY29udGVudHNcbiAgICpcbiAgICogQHBhcmFtIGtleSBLZXkgb2YgdGhlIG9iamVjdFxuICAgKiBAcGFyYW0gYm9keSBzdHJpbmcgY29udGVudHMgb2YgdGhlIG9iamVjdFxuICAgKi9cbiAgcHVibGljIGFzeW5jIHB1dChcbiAgICBrZXk6IHN0cmluZyxcbiAgICBib2R5OiBzdHJpbmcsXG4gICAgb3B0cz86IEJ1Y2tldFB1dE9wdGlvbnNcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgYmxvYkNsaWVudCA9IHRoaXMuY29udGFpbmVyQ2xpZW50LmdldEJsb2NrQmxvYkNsaWVudChrZXkpO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBibG9iSFRUUEhlYWRlcnM6IHtcbiAgICAgICAgYmxvYkNvbnRlbnRUeXBlOlxuICAgICAgICAgIChvcHRzPy5jb250ZW50VHlwZSA/PyBtaW1lLmxvb2t1cChrZXkpKSB8fCBcImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbVwiLFxuICAgICAgfSxcbiAgICB9O1xuICAgIGF3YWl0IGJsb2JDbGllbnQudXBsb2FkKGJvZHksIGJvZHkubGVuZ3RoLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQdXQgSnNvbiBvYmplY3QgaW50byBidWNrZXQgd2l0aCBnaXZlbiBib2R5IGNvbnRlbnRzXG4gICAqXG4gICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBvYmplY3RcbiAgICogQHBhcmFtIGJvZHkgSnNvbiBvYmplY3RcbiAgICovXG4gIHB1YmxpYyBhc3luYyBwdXRKc29uKGtleTogc3RyaW5nLCBib2R5OiBKc29uKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5wdXQoa2V5LCBKU09OLnN0cmluZ2lmeShib2R5LCBudWxsLCAyKSwge1xuICAgICAgY29udGVudFR5cGU6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbiBvYmplY3QgZnJvbSB0aGUgYnVja2V0XG4gICAqXG4gICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBvYmplY3RcbiAgICogQHJldHVybnMgc3RyaW5nIGNvbnRlbnQgb2YgdGhlIG9iamVjdCBhcyBzdHJpbmdcbiAgICovXG4gIHB1YmxpYyBhc3luYyBnZXQoa2V5OiBzdHJpbmcsIG9wdGlvbnM/OiBCdWNrZXRHZXRPcHRpb25zKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBibG9iQ2xpZW50ID0gdGhpcy5jb250YWluZXJDbGllbnQuZ2V0QmxvYkNsaWVudChrZXkpO1xuXG4gICAgbGV0IGRvd25sb2FkUmVzcG9uc2U6IEJsb2JEb3dubG9hZFJlc3BvbnNlUGFyc2VkO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdGFydCA9IG9wdGlvbnM/LnN0YXJ0Qnl0ZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5zdGFydEJ5dGUgOiAwO1xuICAgICAgY29uc3QgbGVuZ3RoID1cbiAgICAgICAgb3B0aW9ucz8uZW5kQnl0ZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5lbmRCeXRlIC0gc3RhcnQgOiB1bmRlZmluZWQ7XG4gICAgICBkb3dubG9hZFJlc3BvbnNlID0gYXdhaXQgYmxvYkNsaWVudC5kb3dubG9hZChzdGFydCwgbGVuZ3RoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE9iamVjdCBkb2VzIG5vdCBleGlzdCAoa2V5PSR7a2V5fSkuYCk7XG4gICAgfVxuICAgIGlmIChkb3dubG9hZFJlc3BvbnNlLnJlYWRhYmxlU3RyZWFtQm9keSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIG5ldyBUZXh0RGVjb2RlcihcInV0ZjhcIiwgeyBmYXRhbDogdHJ1ZSB9KS5kZWNvZGUoXG4gICAgICAgIGF3YWl0IHRoaXMuc3RyZWFtVG9CdWZmZXIoZG93bmxvYWRSZXNwb25zZS5yZWFkYWJsZVN0cmVhbUJvZHkpXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE9iamVjdCBjb250ZW50cyBjb3VsZCBub3QgYmUgcmVhZCBhcyB0ZXh0IChrZXk9JHtrZXl9KTogJHtcbiAgICAgICAgICAoZSBhcyBFcnJvcikuc3RhY2tcbiAgICAgICAgfSl9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFuIG9iamVjdCBmcm9tIHRoZSBidWNrZXQgaWYgaXQgZXhpc3RzXG4gICAqXG4gICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBvYmplY3RcbiAgICogQHJldHVybnMgc3RyaW5nIGNvbnRlbnQgb2YgdGhlIG9iamVjdCBhcyBzdHJpbmdcbiAgICovXG4gIHB1YmxpYyBhc3luYyB0cnlHZXQoXG4gICAga2V5OiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IEJ1Y2tldFRyeUdldE9wdGlvbnNcbiAgKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoYXdhaXQgdGhpcy5leGlzdHMoa2V5KSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0KGtleSwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYSBKc29uIG9iamVjdCBmcm9tIHRoZSBidWNrZXRcbiAgICpcbiAgICogQHBhcmFtIGtleSBLZXkgb2YgdGhlIG9iamVjdFxuICAgKiBAcmV0dXJucyBKc29uIGNvbnRlbnQgb2YgdGhlIG9iamVjdFxuICAgKi9cbiAgcHVibGljIGFzeW5jIGdldEpzb24oa2V5OiBzdHJpbmcpOiBQcm9taXNlPEpzb24+IHtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShhd2FpdCB0aGlzLmdldChrZXkpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYSBKc29uIG9iamVjdCBmcm9tIHRoZSBidWNrZXQgaWYgaXQgZXhpc3RzXG4gICAqXG4gICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBvYmplY3RcbiAgICogQHJldHVybnMgSnNvbiBjb250ZW50IG9mIHRoZSBvYmplY3RcbiAgICovXG4gIHB1YmxpYyBhc3luYyB0cnlHZXRKc29uKGtleTogc3RyaW5nKTogUHJvbWlzZTxKc29uIHwgdW5kZWZpbmVkPiB7XG4gICAgaWYgKGF3YWl0IHRoaXMuZXhpc3RzKGtleSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldEpzb24oa2V5KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBhbiBvYmplY3QgZnJvbSB0aGUgYnVja2V0XG4gICAqXG4gICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBvYmplY3RcbiAgICogQHBhcmFtIG9wdHMgT3B0aW9uIG9iamVjdCBzdXBwb3J0aW5nIGFkZGl0aW9uYWwgc3RyYXRlZ2llcyB0byBkZWxldGUgaXRlbSBmcm9tIGEgYnVja2V0XG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZGVsZXRlKFxuICAgIGtleTogc3RyaW5nLFxuICAgIG9wdHM6IEJ1Y2tldERlbGV0ZU9wdGlvbnMgPSB7fVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBtdXN0RXhpc3QgPSBvcHRzLm11c3RFeGlzdCA/PyBmYWxzZTtcblxuICAgIGNvbnN0IGJsb2NrQmxvYkNsaWVudCA9IHRoaXMuY29udGFpbmVyQ2xpZW50LmdldEJsb2NrQmxvYkNsaWVudChrZXkpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGJsb2NrQmxvYkNsaWVudC5kZWxldGUoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnN0IGVycm9yID0gZXJyIGFzIGFueTtcbiAgICAgIGlmIChlcnJvci5kZXRhaWxzLmVycm9yQ29kZSA9PT0gXCJCbG9iTm90Rm91bmRcIikge1xuICAgICAgICBpZiAobXVzdEV4aXN0KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPYmplY3QgZG9lcyBub3QgZXhpc3QgKGtleT0ke2tleX0pLmApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhyb3cgRXJyb3IoYEZhaWxlZCB0byBkZWxldGUgb2JqZWN0IChrZXk9JHtrZXl9KS5gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIGFuIG9iamVjdCBmcm9tIHRoZSBidWNrZXQgaWYgaXQgZXhpc3RzXG4gICAqXG4gICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBvYmplY3RcbiAgICogQHBhcmFtIG9wdHMgT3B0aW9uIG9iamVjdCBzdXBwb3J0aW5nIGFkZGl0aW9uYWwgc3RyYXRlZ2llcyB0byBkZWxldGUgaXRlbSBmcm9tIGEgYnVja2V0XG4gICAqL1xuICBwdWJsaWMgYXN5bmMgdHJ5RGVsZXRlKGtleTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKGF3YWl0IHRoaXMuZXhpc3RzKGtleSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlKGtleSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogTGlzdCBhbGwga2V5cyBpbiB0aGUgYnVja2V0XG4gICAqXG4gICAqIEBwYXJhbSBwcmVmaXggTGltaXRzIHRoZSByZXNwb25zZSB0byBrZXlzIHRoYXQgYmVnaW4gd2l0aCB0aGUgc3BlY2lmaWVkIHByZWZpeFxuICAgKi9cbiAgcHVibGljIGFzeW5jIGxpc3QocHJlZml4Pzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IGxpc3Q6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgYXdhaXQgKGNvbnN0IGJsb2Igb2YgdGhpcy5jb250YWluZXJDbGllbnQubGlzdEJsb2JzRmxhdCh7IHByZWZpeCB9KSkge1xuICAgICAgbGlzdC5wdXNoKGJsb2IubmFtZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGxpc3Q7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2lnbmVkVXJsKFxuICAgIGtleTogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBCdWNrZXRTaWduZWRVcmxPcHRpb25zXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgb3B0aW9ucztcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgc2lnbmVkVXJsIGlzIG5vdCBpbXBsZW1lbnRlZCB5ZXQgZm9yIHRmLWF6dXJlIChrZXk9JHtrZXl9KWBcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSB1cmwgdG8gdGhlIGdpdmVuIGZpbGUuXG4gICAqIEBUaHJvd3MgaWYgdGhlIGZpbGUgaXMgbm90IHB1YmxpYyBvciBpZiBvYmplY3QgZG9lcyBub3QgZXhpc3QuXG4gICAqL1xuICAvLyBUT0RPOiBOT1QgU1VQUE9SVEVEISEgLSBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3dpbmdsYW5nL3dpbmcvaXNzdWVzLzUxMTdcbiAgcHVibGljIGFzeW5jIHB1YmxpY1VybChrZXk6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgLy8gdGhpcyByZXR1cm5zIGFuIG9wdGlvbmFsIGBibG9iUHVibGljQWNjZXNzYCBwcm9wIC0gaWYgZXhpc3RzIHRoZSBidWNrZXQgaXMgcHVibGljXG4gICAgY29uc3QgYWNjZXNzUG9saWN5ID0gYXdhaXQgdGhpcy5jb250YWluZXJDbGllbnQuZ2V0QWNjZXNzUG9saWN5KCk7XG4gICAgaWYgKCFhY2Nlc3NQb2xpY3k/LmJsb2JQdWJsaWNBY2Nlc3MpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBwcm92aWRlIHB1YmxpYyB1cmwgZm9yIGEgbm9uLXB1YmxpYyBidWNrZXRcIik7XG4gICAgfVxuICAgIGlmICghKGF3YWl0IHRoaXMuZXhpc3RzKGtleSkpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgcHJvdmlkZSBwdWJsaWMgdXJsIGZvciBhIG5vbi1leGlzdGVudCBrZXkgKGtleT0ke2tleX0pYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZW5jb2RlVVJJKFxuICAgICAgYGh0dHBzOi8vJHt0aGlzLnN0b3JhZ2VBY2NvdW50fS5ibG9iLmNvcmUud2luZG93cy5uZXQvJHt0aGlzLmJ1Y2tldE5hbWV9LyR7a2V5fWBcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgbWV0YWRhdGEgb2YgYW4gb2JqZWN0IGluIHRoZSBidWNrZXQuXG4gICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBvYmplY3QuXG4gICAqIEB0aHJvd3MgaWYgdGhlIG9iamVjdCBkb2VzIG5vdCBleGlzdC5cbiAgICovXG4gIHB1YmxpYyBhc3luYyBtZXRhZGF0YShrZXk6IHN0cmluZyk6IFByb21pc2U8T2JqZWN0TWV0YWRhdGE+IHtcbiAgICBjb25zdCBibG9iQ2xpZW50ID0gdGhpcy5jb250YWluZXJDbGllbnQuZ2V0QmxvYkNsaWVudChrZXkpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSBhd2FpdCBibG9iQ2xpZW50LmdldFByb3BlcnRpZXMoKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNvbnRlbnRUeXBlOiBwcm9wZXJ0aWVzLmNvbnRlbnRUeXBlLFxuICAgICAgICBsYXN0TW9kaWZpZWQ6IERhdGV0aW1lLmZyb21EYXRlKHByb3BlcnRpZXMubGFzdE1vZGlmaWVkISksXG4gICAgICAgIHNpemU6IHByb3BlcnRpZXMuY29udGVudExlbmd0aCEsXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE9iamVjdCBkb2VzIG5vdCBleGlzdCAoa2V5PSR7a2V5fSkuYCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENvcHkgb2JqZWN0IHdpdGhpbiB0aGUgYnVja2V0XG4gICAqXG4gICAqIEBwYXJhbSBzcmNLZXkgVGhlIGtleSBvZiB0aGUgc291cmNlIG9iamVjdCB5b3Ugd2lzaCB0byBjb3B5LlxuICAgKiBAcGFyYW0gZHN0S2V5IFRoZSBrZXkgb2YgdGhlIGRlc3RpbmF0aW9uIG9iamVjdCBhZnRlciBjb3B5aW5nLlxuICAgKiBAdGhyb3dzIGlmIGBzcmNLZXlgIG9iamVjdCBkb2Vzbid0IGV4aXN0LlxuICAgKi9cbiAgcHVibGljIGFzeW5jIGNvcHkoc3JjS2V5OiBzdHJpbmcsIGRzdEtleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgc3JjQmxvYlVybCA9IHRoaXMuY29udGFpbmVyQ2xpZW50LmdldEJsb2JDbGllbnQoc3JjS2V5KS51cmw7XG4gICAgY29uc3QgZHN0QmxvYkNsaWVudCA9IHRoaXMuY29udGFpbmVyQ2xpZW50LmdldEJsb2NrQmxvYkNsaWVudChkc3RLZXkpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGRzdEJsb2JDbGllbnQuc3luY0NvcHlGcm9tVVJMKHNyY0Jsb2JVcmwpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNvdXJjZSBvYmplY3QgZG9lcyBub3QgZXhpc3QgKHNyY0tleT0ke3NyY0tleX0pLmApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNb3ZlIG9iamVjdCB3aXRoaW4gdGhlIGNvbnRhaW5lclxuICAgKlxuICAgKiBAcGFyYW0gc3JjS2V5IFRoZSBrZXkgb2YgdGhlIHNvdXJjZSBvYmplY3QgeW91IHdpc2ggdG8gcmVuYW1lLlxuICAgKiBAcGFyYW0gZHN0S2V5IFRoZSBrZXkgb2YgdGhlIGRlc3RpbmF0aW9uIG9iamVjdCBhZnRlciByZW5hbWUuXG4gICAqIEB0aHJvd3MgaWYgYHNyY0tleWAgb2JqZWN0IGRvZXNuJ3QgZXhpc3Qgb3IgaWYgaXQgbWF0Y2hlcyBgZHN0S2V5YC5cbiAgICovXG4gIHB1YmxpYyBhc3luYyByZW5hbWUoc3JjS2V5OiBzdHJpbmcsIGRzdEtleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVqZWN0KFxuICAgICAgYHJlbmFtZSBpcyBub3QgaW1wbGVtZW50ZWQ6IChzcmNLZXk9JHtzcmNLZXl9LCBkc3RLZXk9JHtkc3RLZXl9KWBcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlcXVpcmVkIGhlbHBlciBmdW5jdGlvbiBmb3Igbm9kZSBqcyBvbmx5LlxuICAgKlxuICAgKiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL0F6dXJlL2F6dXJlLXNkay1mb3ItanMvdHJlZS9tYWluL3Nkay9zdG9yYWdlL3N0b3JhZ2UtYmxvYlxuICAgKi9cbiAgcHJpdmF0ZSBzdHJlYW1Ub0J1ZmZlcihzdHJlYW06IE5vZGVKUy5SZWFkYWJsZVN0cmVhbSk6IFByb21pc2U8QnVmZmVyPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGNodW5rczogQnVmZmVyW10gPSBbXTtcbiAgICAgIHN0cmVhbS5vbihcImRhdGFcIiwgKGRhdGEpID0+IHtcbiAgICAgICAgY2h1bmtzLnB1c2goQnVmZmVyLmlzQnVmZmVyKGRhdGEpID8gZGF0YSA6IEJ1ZmZlci5mcm9tKGRhdGEpKTtcbiAgICAgIH0pO1xuICAgICAgc3RyZWFtLm9uKFwiZW5kXCIsICgpID0+IHtcbiAgICAgICAgcmVzb2x2ZShCdWZmZXIuY29uY2F0KGNodW5rcykpO1xuICAgICAgfSk7XG4gICAgICBzdHJlYW0ub24oXCJlcnJvclwiLCByZWplY3QpO1xuICAgIH0pO1xuICB9XG59XG4iXX0=