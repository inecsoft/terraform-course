"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Bucket = void 0;
const app_1 = require("./app");
const function_1 = require("./function");
const permissions_1 = require("./permissions");
const project_service_1 = require("../.gen/providers/google/project-service");
const storage_bucket_1 = require("../.gen/providers/google/storage-bucket");
const storage_bucket_iam_member_1 = require("../.gen/providers/google/storage-bucket-iam-member");
const storage_bucket_object_1 = require("../.gen/providers/google/storage-bucket-object");
const id_1 = require("../.gen/providers/random/id");
const cloud = __importStar(require("../cloud"));
const core_1 = require("../core");
const errors_1 = require("../core/errors");
const resource_names_1 = require("../shared/resource-names");
/**
 * Bucket names must be between 3 and 63 characters. We reserve 9 characters for
 * a random ID, so the maximum length is 54.
 *
 * You can use lowercase alphanumeric characters, dashes (-), underscores (_),
 * and dots (.). However, names containing dots require verification, so we
 * generate names without dots by default.
 *
 * We skip generating a hash since we need to append a random string to the
 * bucket name to make it globally unique.
 *
 * See: https://cloud.google.com/storage/docs/naming-buckets
 */
const BUCKET_NAME_OPTS = {
    maxLen: 54,
    case: resource_names_1.CaseConventions.LOWERCASE,
    disallowedRegex: /([^a-z0-9_\-]+)/g,
    includeHash: false,
};
/**
 * GCP implementation of `cloud.Bucket`.
 *
 * @inflight `@winglang/sdk.cloud.IBucketClient`
 */
class Bucket extends cloud.Bucket {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        const bucketName = resource_names_1.ResourceNames.generateName(this, BUCKET_NAME_OPTS);
        // GCP bucket names must be globally unique, but the Terraform resource
        // provider doesn't provide a mechanism like `bucketPrefix` as AWS does,
        // so we must generate a random string to append to the bucket name.
        //
        // The random string must be managed in Terraform state so that it doesn't
        // change on every subsequent compile or deployment.
        const randomId = new id_1.Id(this, "Id", {
            byteLength: 4, // 4 bytes = 8 hex characters
        });
        const isTestEnvironment = app_1.App.of(scope).isTestEnvironment;
        // Enable `IAM Service Account Credentials API` for the project
        // This is disabled by default, but required for generating presigned URLs
        const iamServiceAccountCredentialsApi = new project_service_1.ProjectService(this, "IamServiceAccountCredentialsApi", {
            service: "iamcredentials.googleapis.com",
            disableDependentServices: false,
            disableOnDestroy: false,
        });
        this.bucket = new storage_bucket_1.StorageBucket(this, "Default", {
            name: bucketName + "-" + randomId.hex,
            location: app_1.App.of(this).region,
            // recommended by GCP: https://cloud.google.com/storage/docs/uniform-bucket-level-access#should-you-use
            uniformBucketLevelAccess: true,
            publicAccessPrevention: props.public ? "inherited" : "enforced",
            forceDestroy: !!isTestEnvironment,
            dependsOn: [iamServiceAccountCredentialsApi],
        });
        if (props.public) {
            // https://cloud.google.com/storage/docs/access-control/making-data-public#terraform
            new storage_bucket_iam_member_1.StorageBucketIamMember(this, "PublicAccessIamMember", {
                bucket: this.bucket.name,
                role: "roles/storage.objectViewer",
                member: "allUsers",
            });
        }
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud.BucketInflightMethods.DELETE]: [],
            [cloud.BucketInflightMethods.GET]: [],
            [cloud.BucketInflightMethods.GET_JSON]: [],
            [cloud.BucketInflightMethods.LIST]: [],
            [cloud.BucketInflightMethods.PUT]: [],
            [cloud.BucketInflightMethods.PUT_JSON]: [],
            [cloud.BucketInflightMethods.PUBLIC_URL]: [],
            [cloud.BucketInflightMethods.EXISTS]: [],
            [cloud.BucketInflightMethods.TRY_GET]: [],
            [cloud.BucketInflightMethods.TRY_GET_JSON]: [],
            [cloud.BucketInflightMethods.TRY_DELETE]: [],
            [cloud.BucketInflightMethods.METADATA]: [],
            [cloud.BucketInflightMethods.COPY]: [],
            [cloud.BucketInflightMethods.RENAME]: [],
            [cloud.BucketInflightMethods.SIGNED_URL]: [],
        };
    }
    addObject(key, body) {
        new storage_bucket_object_1.StorageBucketObject(this, `Object-${key}`, {
            bucket: this.bucket.id,
            name: key,
            content: body,
        });
    }
    /**
     * Run an inflight whenever a file is uploaded to the bucket.
     */
    onCreate(fn, opts) {
        fn;
        opts;
        throw new errors_1.NotImplementedError("onCreate method isn't implemented yet on the current target.", {
            resource: this.constructor.name,
            operation: cloud.BucketEventType.CREATE,
        });
    }
    /**
     * Run an inflight whenever a file is deleted from the bucket.
     */
    onDelete(fn, opts) {
        fn;
        opts;
        throw new errors_1.NotImplementedError("onDelete method isn't implemented yet on the current target.", {
            resource: this.constructor.name,
            operation: cloud.BucketEventType.DELETE,
        });
    }
    /**
     * Run an inflight whenever a file is updated in the bucket.
     */
    onUpdate(fn, opts) {
        fn;
        opts;
        throw new errors_1.NotImplementedError("onUpdate method isn't implemented yet on the current target.", {
            resource: this.constructor.name,
            operation: cloud.BucketEventType.UPDATE,
        });
    }
    /**
     * Run an inflight whenever a file is uploaded, modified, or deleted from the bucket.
     */
    onEvent(fn, opts) {
        fn;
        opts;
        throw new errors_1.NotImplementedError("onEvent method isn't implemented yet on the current target.", { resource: this.constructor.name, operation: "onEvent" });
    }
    onLift(host, ops) {
        if (!(host instanceof function_1.Function)) {
            throw new Error("buckets can only be bound by tfgcp.Function for now");
        }
        const permissions = (0, permissions_1.calculateBucketPermissions)(ops);
        host.addPermissions(permissions);
        host.addEnvironment(this.envName(), this.bucket.name);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core_1.InflightClient.for(__dirname.replace("target-tf-gcp", "shared-gcp"), __filename, "BucketClient", [`process.env["${this.envName()}"]`]);
    }
    envName() {
        return `BUCKET_NAME_${this.node.addr.slice(-8)}`;
    }
}
exports.Bucket = Bucket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC10Zi1nY3AvYnVja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsK0JBQTRCO0FBQzVCLHlDQUFxRDtBQUNyRCwrQ0FBMkQ7QUFDM0QsOEVBQTBFO0FBQzFFLDRFQUF3RTtBQUN4RSxrR0FBNEY7QUFDNUYsMEZBQXFGO0FBQ3JGLG9EQUFpRDtBQUNqRCxnREFBa0M7QUFDbEMsa0NBQWtEO0FBQ2xELDJDQUFxRDtBQUNyRCw2REFJa0M7QUFHbEM7Ozs7Ozs7Ozs7OztHQVlHO0FBQ0gsTUFBTSxnQkFBZ0IsR0FBZ0I7SUFDcEMsTUFBTSxFQUFFLEVBQUU7SUFDVixJQUFJLEVBQUUsZ0NBQWUsQ0FBQyxTQUFTO0lBQy9CLGVBQWUsRUFBRSxrQkFBa0I7SUFDbkMsV0FBVyxFQUFFLEtBQUs7Q0FDbkIsQ0FBQztBQUVGOzs7O0dBSUc7QUFDSCxNQUFhLE1BQU8sU0FBUSxLQUFLLENBQUMsTUFBTTtJQUd0QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLFFBQTJCLEVBQUU7UUFDckUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsTUFBTSxVQUFVLEdBQUcsOEJBQWEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFFdEUsdUVBQXVFO1FBQ3ZFLHdFQUF3RTtRQUN4RSxvRUFBb0U7UUFDcEUsRUFBRTtRQUNGLDBFQUEwRTtRQUMxRSxvREFBb0Q7UUFDcEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxPQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRTtZQUNsQyxVQUFVLEVBQUUsQ0FBQyxFQUFFLDZCQUE2QjtTQUM3QyxDQUFDLENBQUM7UUFFSCxNQUFNLGlCQUFpQixHQUFHLFNBQUcsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsaUJBQWlCLENBQUM7UUFFMUQsK0RBQStEO1FBQy9ELDBFQUEwRTtRQUMxRSxNQUFNLCtCQUErQixHQUFHLElBQUksZ0NBQWMsQ0FDeEQsSUFBSSxFQUNKLGlDQUFpQyxFQUNqQztZQUNFLE9BQU8sRUFBRSwrQkFBK0I7WUFDeEMsd0JBQXdCLEVBQUUsS0FBSztZQUMvQixnQkFBZ0IsRUFBRSxLQUFLO1NBQ3hCLENBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSw4QkFBYSxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUU7WUFDL0MsSUFBSSxFQUFFLFVBQVUsR0FBRyxHQUFHLEdBQUcsUUFBUSxDQUFDLEdBQUc7WUFDckMsUUFBUSxFQUFHLFNBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFTLENBQUMsTUFBTTtZQUN0Qyx1R0FBdUc7WUFDdkcsd0JBQXdCLEVBQUUsSUFBSTtZQUM5QixzQkFBc0IsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFVBQVU7WUFDL0QsWUFBWSxFQUFFLENBQUMsQ0FBQyxpQkFBaUI7WUFDakMsU0FBUyxFQUFFLENBQUMsK0JBQStCLENBQUM7U0FDN0MsQ0FBQyxDQUFDO1FBRUgsSUFBSSxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDakIsb0ZBQW9GO1lBQ3BGLElBQUksa0RBQXNCLENBQUMsSUFBSSxFQUFFLHVCQUF1QixFQUFFO2dCQUN4RCxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJO2dCQUN4QixJQUFJLEVBQUUsNEJBQTRCO2dCQUNsQyxNQUFNLEVBQUUsVUFBVTthQUNuQixDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQztJQUVELGdCQUFnQjtJQUNoQixJQUFXLFFBQVE7UUFDakIsT0FBTztZQUNMLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUU7WUFDeEMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRTtZQUNyQyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFO1lBQzFDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDdEMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRTtZQUNyQyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFO1lBQzFDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUU7WUFDNUMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtZQUN4QyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFO1lBQ3pDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxFQUFFLEVBQUU7WUFDOUMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsVUFBVSxDQUFDLEVBQUUsRUFBRTtZQUM1QyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFO1lBQzFDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDdEMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtZQUN4QyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFO1NBQzdDLENBQUM7SUFDSixDQUFDO0lBRU0sU0FBUyxDQUFDLEdBQVcsRUFBRSxJQUFZO1FBQ3hDLElBQUksMkNBQW1CLENBQUMsSUFBSSxFQUFFLFVBQVUsR0FBRyxFQUFFLEVBQUU7WUFDN0MsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN0QixJQUFJLEVBQUUsR0FBRztZQUNULE9BQU8sRUFBRSxJQUFJO1NBQ2QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ksUUFBUSxDQUNiLEVBQTZCLEVBQzdCLElBQWtDO1FBRWxDLEVBQUUsQ0FBQztRQUNILElBQUksQ0FBQztRQUNMLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsOERBQThELEVBQzlEO1lBQ0UsUUFBUSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSTtZQUMvQixTQUFTLEVBQUUsS0FBSyxDQUFDLGVBQWUsQ0FBQyxNQUFNO1NBQ3hDLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNJLFFBQVEsQ0FDYixFQUE2QixFQUM3QixJQUFrQztRQUVsQyxFQUFFLENBQUM7UUFDSCxJQUFJLENBQUM7UUFDTCxNQUFNLElBQUksNEJBQW1CLENBQzNCLDhEQUE4RCxFQUM5RDtZQUNFLFFBQVEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUk7WUFDL0IsU0FBUyxFQUFFLEtBQUssQ0FBQyxlQUFlLENBQUMsTUFBTTtTQUN4QyxDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSSxRQUFRLENBQ2IsRUFBNkIsRUFDN0IsSUFBa0M7UUFFbEMsRUFBRSxDQUFDO1FBQ0gsSUFBSSxDQUFDO1FBQ0wsTUFBTSxJQUFJLDRCQUFtQixDQUMzQiw4REFBOEQsRUFDOUQ7WUFDRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJO1lBQy9CLFNBQVMsRUFBRSxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQU07U0FDeEMsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0ksT0FBTyxDQUNaLEVBQTZCLEVBQzdCLElBQWlDO1FBRWpDLEVBQUUsQ0FBQztRQUNILElBQUksQ0FBQztRQUNMLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsNkRBQTZELEVBQzdELEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsQ0FDMUQsQ0FBQztJQUNKLENBQUM7SUFFTSxNQUFNLENBQUMsSUFBbUIsRUFBRSxHQUFhO1FBQzlDLElBQUksQ0FBQyxDQUFDLElBQUksWUFBWSxtQkFBVyxDQUFDLEVBQUUsQ0FBQztZQUNuQyxNQUFNLElBQUksS0FBSyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7UUFDekUsQ0FBQztRQUVELE1BQU0sV0FBVyxHQUFHLElBQUEsd0NBQTBCLEVBQUMsR0FBRyxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVqQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RELEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRCxnQkFBZ0I7SUFDVCxXQUFXO1FBQ2hCLE9BQU8scUJBQWMsQ0FBQyxHQUFHLENBQ3ZCLFNBQVMsQ0FBQyxPQUFPLENBQUMsZUFBZSxFQUFFLFlBQVksQ0FBQyxFQUNoRCxVQUFVLEVBQ1YsY0FBYyxFQUNkLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQ3JDLENBQUM7SUFDSixDQUFDO0lBRU8sT0FBTztRQUNiLE9BQU8sZUFBZSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ25ELENBQUM7Q0FDRjtBQS9LRCx3QkErS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vYXBwXCI7XG5pbXBvcnQgeyBGdW5jdGlvbiBhcyBHQ1BGdW5jdGlvbiB9IGZyb20gXCIuL2Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBjYWxjdWxhdGVCdWNrZXRQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3Blcm1pc3Npb25zXCI7XG5pbXBvcnQgeyBQcm9qZWN0U2VydmljZSB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9nb29nbGUvcHJvamVjdC1zZXJ2aWNlXCI7XG5pbXBvcnQgeyBTdG9yYWdlQnVja2V0IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2dvb2dsZS9zdG9yYWdlLWJ1Y2tldFwiO1xuaW1wb3J0IHsgU3RvcmFnZUJ1Y2tldElhbU1lbWJlciB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9nb29nbGUvc3RvcmFnZS1idWNrZXQtaWFtLW1lbWJlclwiO1xuaW1wb3J0IHsgU3RvcmFnZUJ1Y2tldE9iamVjdCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9nb29nbGUvc3RvcmFnZS1idWNrZXQtb2JqZWN0XCI7XG5pbXBvcnQgeyBJZCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9yYW5kb20vaWRcIjtcbmltcG9ydCAqIGFzIGNsb3VkIGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0IHsgSW5mbGlnaHRDbGllbnQsIExpZnRNYXAgfSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgTm90SW1wbGVtZW50ZWRFcnJvciB9IGZyb20gXCIuLi9jb3JlL2Vycm9yc1wiO1xuaW1wb3J0IHtcbiAgQ2FzZUNvbnZlbnRpb25zLFxuICBOYW1lT3B0aW9ucyxcbiAgUmVzb3VyY2VOYW1lcyxcbn0gZnJvbSBcIi4uL3NoYXJlZC9yZXNvdXJjZS1uYW1lc1wiO1xuaW1wb3J0IHsgSUluZmxpZ2h0SG9zdCB9IGZyb20gXCIuLi9zdGRcIjtcblxuLyoqXG4gKiBCdWNrZXQgbmFtZXMgbXVzdCBiZSBiZXR3ZWVuIDMgYW5kIDYzIGNoYXJhY3RlcnMuIFdlIHJlc2VydmUgOSBjaGFyYWN0ZXJzIGZvclxuICogYSByYW5kb20gSUQsIHNvIHRoZSBtYXhpbXVtIGxlbmd0aCBpcyA1NC5cbiAqXG4gKiBZb3UgY2FuIHVzZSBsb3dlcmNhc2UgYWxwaGFudW1lcmljIGNoYXJhY3RlcnMsIGRhc2hlcyAoLSksIHVuZGVyc2NvcmVzIChfKSxcbiAqIGFuZCBkb3RzICguKS4gSG93ZXZlciwgbmFtZXMgY29udGFpbmluZyBkb3RzIHJlcXVpcmUgdmVyaWZpY2F0aW9uLCBzbyB3ZVxuICogZ2VuZXJhdGUgbmFtZXMgd2l0aG91dCBkb3RzIGJ5IGRlZmF1bHQuXG4gKlxuICogV2Ugc2tpcCBnZW5lcmF0aW5nIGEgaGFzaCBzaW5jZSB3ZSBuZWVkIHRvIGFwcGVuZCBhIHJhbmRvbSBzdHJpbmcgdG8gdGhlXG4gKiBidWNrZXQgbmFtZSB0byBtYWtlIGl0IGdsb2JhbGx5IHVuaXF1ZS5cbiAqXG4gKiBTZWU6IGh0dHBzOi8vY2xvdWQuZ29vZ2xlLmNvbS9zdG9yYWdlL2RvY3MvbmFtaW5nLWJ1Y2tldHNcbiAqL1xuY29uc3QgQlVDS0VUX05BTUVfT1BUUzogTmFtZU9wdGlvbnMgPSB7XG4gIG1heExlbjogNTQsXG4gIGNhc2U6IENhc2VDb252ZW50aW9ucy5MT1dFUkNBU0UsXG4gIGRpc2FsbG93ZWRSZWdleDogLyhbXmEtejAtOV9cXC1dKykvZyxcbiAgaW5jbHVkZUhhc2g6IGZhbHNlLFxufTtcblxuLyoqXG4gKiBHQ1AgaW1wbGVtZW50YXRpb24gb2YgYGNsb3VkLkJ1Y2tldGAuXG4gKlxuICogQGluZmxpZ2h0IGBAd2luZ2xhbmcvc2RrLmNsb3VkLklCdWNrZXRDbGllbnRgXG4gKi9cbmV4cG9ydCBjbGFzcyBCdWNrZXQgZXh0ZW5kcyBjbG91ZC5CdWNrZXQge1xuICBwdWJsaWMgcmVhZG9ubHkgYnVja2V0OiBTdG9yYWdlQnVja2V0O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBjbG91ZC5CdWNrZXRQcm9wcyA9IHt9KSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICBjb25zdCBidWNrZXROYW1lID0gUmVzb3VyY2VOYW1lcy5nZW5lcmF0ZU5hbWUodGhpcywgQlVDS0VUX05BTUVfT1BUUyk7XG5cbiAgICAvLyBHQ1AgYnVja2V0IG5hbWVzIG11c3QgYmUgZ2xvYmFsbHkgdW5pcXVlLCBidXQgdGhlIFRlcnJhZm9ybSByZXNvdXJjZVxuICAgIC8vIHByb3ZpZGVyIGRvZXNuJ3QgcHJvdmlkZSBhIG1lY2hhbmlzbSBsaWtlIGBidWNrZXRQcmVmaXhgIGFzIEFXUyBkb2VzLFxuICAgIC8vIHNvIHdlIG11c3QgZ2VuZXJhdGUgYSByYW5kb20gc3RyaW5nIHRvIGFwcGVuZCB0byB0aGUgYnVja2V0IG5hbWUuXG4gICAgLy9cbiAgICAvLyBUaGUgcmFuZG9tIHN0cmluZyBtdXN0IGJlIG1hbmFnZWQgaW4gVGVycmFmb3JtIHN0YXRlIHNvIHRoYXQgaXQgZG9lc24ndFxuICAgIC8vIGNoYW5nZSBvbiBldmVyeSBzdWJzZXF1ZW50IGNvbXBpbGUgb3IgZGVwbG95bWVudC5cbiAgICBjb25zdCByYW5kb21JZCA9IG5ldyBJZCh0aGlzLCBcIklkXCIsIHtcbiAgICAgIGJ5dGVMZW5ndGg6IDQsIC8vIDQgYnl0ZXMgPSA4IGhleCBjaGFyYWN0ZXJzXG4gICAgfSk7XG5cbiAgICBjb25zdCBpc1Rlc3RFbnZpcm9ubWVudCA9IEFwcC5vZihzY29wZSkuaXNUZXN0RW52aXJvbm1lbnQ7XG5cbiAgICAvLyBFbmFibGUgYElBTSBTZXJ2aWNlIEFjY291bnQgQ3JlZGVudGlhbHMgQVBJYCBmb3IgdGhlIHByb2plY3RcbiAgICAvLyBUaGlzIGlzIGRpc2FibGVkIGJ5IGRlZmF1bHQsIGJ1dCByZXF1aXJlZCBmb3IgZ2VuZXJhdGluZyBwcmVzaWduZWQgVVJMc1xuICAgIGNvbnN0IGlhbVNlcnZpY2VBY2NvdW50Q3JlZGVudGlhbHNBcGkgPSBuZXcgUHJvamVjdFNlcnZpY2UoXG4gICAgICB0aGlzLFxuICAgICAgXCJJYW1TZXJ2aWNlQWNjb3VudENyZWRlbnRpYWxzQXBpXCIsXG4gICAgICB7XG4gICAgICAgIHNlcnZpY2U6IFwiaWFtY3JlZGVudGlhbHMuZ29vZ2xlYXBpcy5jb21cIixcbiAgICAgICAgZGlzYWJsZURlcGVuZGVudFNlcnZpY2VzOiBmYWxzZSxcbiAgICAgICAgZGlzYWJsZU9uRGVzdHJveTogZmFsc2UsXG4gICAgICB9XG4gICAgKTtcblxuICAgIHRoaXMuYnVja2V0ID0gbmV3IFN0b3JhZ2VCdWNrZXQodGhpcywgXCJEZWZhdWx0XCIsIHtcbiAgICAgIG5hbWU6IGJ1Y2tldE5hbWUgKyBcIi1cIiArIHJhbmRvbUlkLmhleCxcbiAgICAgIGxvY2F0aW9uOiAoQXBwLm9mKHRoaXMpIGFzIEFwcCkucmVnaW9uLFxuICAgICAgLy8gcmVjb21tZW5kZWQgYnkgR0NQOiBodHRwczovL2Nsb3VkLmdvb2dsZS5jb20vc3RvcmFnZS9kb2NzL3VuaWZvcm0tYnVja2V0LWxldmVsLWFjY2VzcyNzaG91bGQteW91LXVzZVxuICAgICAgdW5pZm9ybUJ1Y2tldExldmVsQWNjZXNzOiB0cnVlLFxuICAgICAgcHVibGljQWNjZXNzUHJldmVudGlvbjogcHJvcHMucHVibGljID8gXCJpbmhlcml0ZWRcIiA6IFwiZW5mb3JjZWRcIixcbiAgICAgIGZvcmNlRGVzdHJveTogISFpc1Rlc3RFbnZpcm9ubWVudCxcbiAgICAgIGRlcGVuZHNPbjogW2lhbVNlcnZpY2VBY2NvdW50Q3JlZGVudGlhbHNBcGldLFxuICAgIH0pO1xuXG4gICAgaWYgKHByb3BzLnB1YmxpYykge1xuICAgICAgLy8gaHR0cHM6Ly9jbG91ZC5nb29nbGUuY29tL3N0b3JhZ2UvZG9jcy9hY2Nlc3MtY29udHJvbC9tYWtpbmctZGF0YS1wdWJsaWMjdGVycmFmb3JtXG4gICAgICBuZXcgU3RvcmFnZUJ1Y2tldElhbU1lbWJlcih0aGlzLCBcIlB1YmxpY0FjY2Vzc0lhbU1lbWJlclwiLCB7XG4gICAgICAgIGJ1Y2tldDogdGhpcy5idWNrZXQubmFtZSxcbiAgICAgICAgcm9sZTogXCJyb2xlcy9zdG9yYWdlLm9iamVjdFZpZXdlclwiLFxuICAgICAgICBtZW1iZXI6IFwiYWxsVXNlcnNcIixcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIGdldCBfbGlmdE1hcCgpOiBMaWZ0TWFwIHtcbiAgICByZXR1cm4ge1xuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5ERUxFVEVdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuR0VUXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkdFVF9KU09OXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkxJU1RdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuUFVUXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlBVVF9KU09OXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlBVQkxJQ19VUkxdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuRVhJU1RTXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlRSWV9HRVRdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0dFVF9KU09OXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlRSWV9ERUxFVEVdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuTUVUQURBVEFdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuQ09QWV06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5SRU5BTUVdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuU0lHTkVEX1VSTF06IFtdLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgYWRkT2JqZWN0KGtleTogc3RyaW5nLCBib2R5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBuZXcgU3RvcmFnZUJ1Y2tldE9iamVjdCh0aGlzLCBgT2JqZWN0LSR7a2V5fWAsIHtcbiAgICAgIGJ1Y2tldDogdGhpcy5idWNrZXQuaWQsXG4gICAgICBuYW1lOiBrZXksXG4gICAgICBjb250ZW50OiBib2R5LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJ1biBhbiBpbmZsaWdodCB3aGVuZXZlciBhIGZpbGUgaXMgdXBsb2FkZWQgdG8gdGhlIGJ1Y2tldC5cbiAgICovXG4gIHB1YmxpYyBvbkNyZWF0ZShcbiAgICBmbjogY2xvdWQuSUJ1Y2tldEV2ZW50SGFuZGxlcixcbiAgICBvcHRzPzogY2xvdWQuQnVja2V0T25DcmVhdGVPcHRpb25zXG4gICk6IHZvaWQge1xuICAgIGZuO1xuICAgIG9wdHM7XG4gICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoXG4gICAgICBcIm9uQ3JlYXRlIG1ldGhvZCBpc24ndCBpbXBsZW1lbnRlZCB5ZXQgb24gdGhlIGN1cnJlbnQgdGFyZ2V0LlwiLFxuICAgICAge1xuICAgICAgICByZXNvdXJjZTogdGhpcy5jb25zdHJ1Y3Rvci5uYW1lLFxuICAgICAgICBvcGVyYXRpb246IGNsb3VkLkJ1Y2tldEV2ZW50VHlwZS5DUkVBVEUsXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gYW4gaW5mbGlnaHQgd2hlbmV2ZXIgYSBmaWxlIGlzIGRlbGV0ZWQgZnJvbSB0aGUgYnVja2V0LlxuICAgKi9cbiAgcHVibGljIG9uRGVsZXRlKFxuICAgIGZuOiBjbG91ZC5JQnVja2V0RXZlbnRIYW5kbGVyLFxuICAgIG9wdHM/OiBjbG91ZC5CdWNrZXRPbkRlbGV0ZU9wdGlvbnNcbiAgKTogdm9pZCB7XG4gICAgZm47XG4gICAgb3B0cztcbiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcihcbiAgICAgIFwib25EZWxldGUgbWV0aG9kIGlzbid0IGltcGxlbWVudGVkIHlldCBvbiB0aGUgY3VycmVudCB0YXJnZXQuXCIsXG4gICAgICB7XG4gICAgICAgIHJlc291cmNlOiB0aGlzLmNvbnN0cnVjdG9yLm5hbWUsXG4gICAgICAgIG9wZXJhdGlvbjogY2xvdWQuQnVja2V0RXZlbnRUeXBlLkRFTEVURSxcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJ1biBhbiBpbmZsaWdodCB3aGVuZXZlciBhIGZpbGUgaXMgdXBkYXRlZCBpbiB0aGUgYnVja2V0LlxuICAgKi9cbiAgcHVibGljIG9uVXBkYXRlKFxuICAgIGZuOiBjbG91ZC5JQnVja2V0RXZlbnRIYW5kbGVyLFxuICAgIG9wdHM/OiBjbG91ZC5CdWNrZXRPblVwZGF0ZU9wdGlvbnNcbiAgKTogdm9pZCB7XG4gICAgZm47XG4gICAgb3B0cztcbiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcihcbiAgICAgIFwib25VcGRhdGUgbWV0aG9kIGlzbid0IGltcGxlbWVudGVkIHlldCBvbiB0aGUgY3VycmVudCB0YXJnZXQuXCIsXG4gICAgICB7XG4gICAgICAgIHJlc291cmNlOiB0aGlzLmNvbnN0cnVjdG9yLm5hbWUsXG4gICAgICAgIG9wZXJhdGlvbjogY2xvdWQuQnVja2V0RXZlbnRUeXBlLlVQREFURSxcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJ1biBhbiBpbmZsaWdodCB3aGVuZXZlciBhIGZpbGUgaXMgdXBsb2FkZWQsIG1vZGlmaWVkLCBvciBkZWxldGVkIGZyb20gdGhlIGJ1Y2tldC5cbiAgICovXG4gIHB1YmxpYyBvbkV2ZW50KFxuICAgIGZuOiBjbG91ZC5JQnVja2V0RXZlbnRIYW5kbGVyLFxuICAgIG9wdHM/OiBjbG91ZC5CdWNrZXRPbkV2ZW50T3B0aW9uc1xuICApOiB2b2lkIHtcbiAgICBmbjtcbiAgICBvcHRzO1xuICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKFxuICAgICAgXCJvbkV2ZW50IG1ldGhvZCBpc24ndCBpbXBsZW1lbnRlZCB5ZXQgb24gdGhlIGN1cnJlbnQgdGFyZ2V0LlwiLFxuICAgICAgeyByZXNvdXJjZTogdGhpcy5jb25zdHJ1Y3Rvci5uYW1lLCBvcGVyYXRpb246IFwib25FdmVudFwiIH1cbiAgICApO1xuICB9XG5cbiAgcHVibGljIG9uTGlmdChob3N0OiBJSW5mbGlnaHRIb3N0LCBvcHM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgaWYgKCEoaG9zdCBpbnN0YW5jZW9mIEdDUEZ1bmN0aW9uKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYnVja2V0cyBjYW4gb25seSBiZSBib3VuZCBieSB0ZmdjcC5GdW5jdGlvbiBmb3Igbm93XCIpO1xuICAgIH1cblxuICAgIGNvbnN0IHBlcm1pc3Npb25zID0gY2FsY3VsYXRlQnVja2V0UGVybWlzc2lvbnMob3BzKTtcbiAgICBob3N0LmFkZFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcblxuICAgIGhvc3QuYWRkRW52aXJvbm1lbnQodGhpcy5lbnZOYW1lKCksIHRoaXMuYnVja2V0Lm5hbWUpO1xuICAgIHN1cGVyLm9uTGlmdChob3N0LCBvcHMpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3RvSW5mbGlnaHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gSW5mbGlnaHRDbGllbnQuZm9yKFxuICAgICAgX19kaXJuYW1lLnJlcGxhY2UoXCJ0YXJnZXQtdGYtZ2NwXCIsIFwic2hhcmVkLWdjcFwiKSxcbiAgICAgIF9fZmlsZW5hbWUsXG4gICAgICBcIkJ1Y2tldENsaWVudFwiLFxuICAgICAgW2Bwcm9jZXNzLmVudltcIiR7dGhpcy5lbnZOYW1lKCl9XCJdYF1cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBlbnZOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBCVUNLRVRfTkFNRV8ke3RoaXMubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG59XG4iXX0=