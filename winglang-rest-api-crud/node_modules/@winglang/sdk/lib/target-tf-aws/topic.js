"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Topic = void 0;
const app_1 = require("./app");
const function_1 = require("./function");
const queue_1 = require("./queue");
const sns_topic_1 = require("../.gen/providers/aws/sns-topic");
const sns_topic_policy_1 = require("../.gen/providers/aws/sns-topic-policy");
const sns_topic_subscription_1 = require("../.gen/providers/aws/sns-topic-subscription");
const sqs_queue_policy_1 = require("../.gen/providers/aws/sqs-queue-policy");
const cloud = __importStar(require("../cloud"));
const core = __importStar(require("../core"));
const resource_names_1 = require("../shared/resource-names");
const shared_aws_1 = require("../shared-aws");
const permissions_1 = require("../shared-aws/permissions");
const topic_1 = require("../shared-aws/topic");
const std_1 = require("../std");
/**
 * Topic names are limited to 256 characters.
 * You can use alphanumeric characters, hyphens (-) and underscores (_).
 */
const NAME_OPTS = {
    maxLen: 256,
    disallowedRegex: /[^a-zA-Z0-9\_\-]+/g,
};
/**
 * AWS Implementation of `cloud.Topic`.
 *
 * @inflight `@winglang/sdk.cloud.ITopicClient`
 */
class Topic extends cloud.Topic {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        this.handlers = {};
        this.topic = new sns_topic_1.SnsTopic(this, "Default", {
            name: resource_names_1.ResourceNames.generateName(this, NAME_OPTS),
        });
    }
    onMessage(inflight, props = {}) {
        const functionHandler = topic_1.TopicOnMessageHandler.toFunctionHandler(inflight);
        let fn = this.handlers[inflight._id];
        if (fn) {
            return fn;
        }
        fn = new function_1.Function(
        // ok since we're not a tree root
        this.node.scope, app_1.App.of(this).makeId(this, `${this.node.id}-OnMessage`), functionHandler, props);
        this.handlers[inflight._id] = fn;
        // TODO: remove this constraint by adding generic permission APIs to cloud.Function
        if (!(fn instanceof function_1.Function)) {
            throw new Error("Topic only supports creating tfaws.Function right now");
        }
        new sns_topic_subscription_1.SnsTopicSubscription(this, app_1.App.of(this).makeId(this, "TopicSubscription"), {
            topicArn: this.topicArn,
            protocol: "lambda",
            endpoint: fn.functionArn,
        });
        fn.addPermissionToInvoke(this, "sns.amazonaws.com", this.topic.arn, {});
        std_1.Node.of(this).addConnection({
            source: this,
            sourceOp: cloud.TopicInflightMethods.PUBLISH,
            target: fn,
            targetOp: cloud.FunctionInflightMethods.INVOKE_ASYNC,
            name: "onMessage()",
        });
        return fn;
    }
    subscribeQueue(queue) {
        if (!(queue instanceof queue_1.Queue)) {
            throw new Error("'subscribeQueue' allows only tfaws.Queue to be subscribed to the Topic");
        }
        new sns_topic_subscription_1.SnsTopicSubscription(this, app_1.App.of(this).makeId(this, "TopicSubscription"), {
            topicArn: this.topicArn,
            protocol: "sqs",
            endpoint: queue.queueArn,
            rawMessageDelivery: true,
        });
        new sqs_queue_policy_1.SqsQueuePolicy(this, `SqsQueuePolicy-${queue.node.addr}`, {
            queueUrl: queue.queueUrl,
            policy: JSON.stringify({
                Version: "2012-10-17",
                Statement: [
                    {
                        Effect: "Allow",
                        Principal: {
                            Service: "sns.amazonaws.com",
                        },
                        Action: "sqs:SendMessage",
                        Resource: `${queue.queueArn}`,
                        Condition: {
                            ArnEquals: {
                                "aws:SourceArn": `${this.topicArn}`,
                            },
                        },
                    },
                ],
            }),
        });
    }
    /**
     * Grants the given identity permissions to publish this topic.
     * @param source the resource that will publish to the topic
     * @param principal The AWS principal to grant publish permissions to (e.g. "s3.amazonaws.com", "events.amazonaws.com", "sns.amazonaws.com")
     * @param sourceArn source arn
     */
    addPermissionToPublish(source, principal, sourceArn) {
        this.permissions = new sns_topic_policy_1.SnsTopicPolicy(this, `PublishPermission-${source.node.addr}`, {
            arn: this.topic.arn,
            policy: JSON.stringify({
                Statement: [
                    {
                        Effect: "Allow",
                        Principal: {
                            Service: principal,
                        },
                        Action: "sns:Publish",
                        Resource: this.topic.arn,
                        Condition: {
                            ArnEquals: {
                                "aws:SourceArn": sourceArn,
                            },
                        },
                    },
                ],
            }),
        });
    }
    onLift(host, ops) {
        if (!shared_aws_1.AwsInflightHost.isAwsInflightHost(host)) {
            throw new Error("Host is expected to implement `IAwsInfightHost`");
        }
        host.addPolicyStatements(...(0, permissions_1.calculateTopicPermissions)(this.topic.arn, ops));
        host.addEnvironment(this.envName(), this.topic.arn);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core.InflightClient.for(__dirname.replace("target-tf-aws", "shared-aws"), __filename, "TopicClient", [`process.env["${this.envName()}"]`]);
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud.TopicInflightMethods.PUBLISH]: [],
        };
    }
    envName() {
        return `TOPIC_ARN_${this.node.addr.slice(-8)}`;
    }
    get topicArn() {
        return this.topic.arn;
    }
    get topicName() {
        return this.topic.name;
    }
}
exports.Topic = Topic;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9waWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXRmLWF3cy90b3BpYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLCtCQUE0QjtBQUM1Qix5Q0FBc0M7QUFDdEMsbUNBQWdDO0FBQ2hDLCtEQUEyRDtBQUMzRCw2RUFBd0U7QUFDeEUseUZBQW9GO0FBQ3BGLDZFQUF3RTtBQUN4RSxnREFBa0M7QUFDbEMsOENBQWdDO0FBQ2hDLDZEQUFzRTtBQUN0RSw4Q0FBZ0Q7QUFDaEQsMkRBQXNFO0FBQ3RFLCtDQUF1RTtBQUN2RSxnQ0FBdUQ7QUFFdkQ7OztHQUdHO0FBQ0gsTUFBTSxTQUFTLEdBQWdCO0lBQzdCLE1BQU0sRUFBRSxHQUFHO0lBQ1gsZUFBZSxFQUFFLG9CQUFvQjtDQUN0QyxDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQWEsS0FBTSxTQUFRLEtBQUssQ0FBQyxLQUFLO0lBU3BDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBMEIsRUFBRTtRQUNwRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQVJULGFBQVEsR0FBNkIsRUFBRSxDQUFDO1FBVXZELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxvQkFBUSxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUU7WUFDekMsSUFBSSxFQUFFLDhCQUFhLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxTQUFTLENBQUM7U0FDbEQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLFNBQVMsQ0FDZCxRQUFzQyxFQUN0QyxRQUFxQyxFQUFFO1FBRXZDLE1BQU0sZUFBZSxHQUFHLDZCQUFxQixDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3JDLElBQUksRUFBRSxFQUFFLENBQUM7WUFDUCxPQUFPLEVBQUUsQ0FBQztRQUNaLENBQUM7UUFFRCxFQUFFLEdBQUcsSUFBSSxtQkFBUTtRQUNmLGlDQUFpQztRQUNqQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQU0sRUFDaEIsU0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLFlBQVksQ0FBQyxFQUN0RCxlQUFlLEVBQ2YsS0FBSyxDQUNOLENBQUM7UUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFakMsbUZBQW1GO1FBQ25GLElBQUksQ0FBQyxDQUFDLEVBQUUsWUFBWSxtQkFBUSxDQUFDLEVBQUUsQ0FBQztZQUM5QixNQUFNLElBQUksS0FBSyxDQUFDLHVEQUF1RCxDQUFDLENBQUM7UUFDM0UsQ0FBQztRQUVELElBQUksNkNBQW9CLENBQ3RCLElBQUksRUFDSixTQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLENBQUMsRUFDOUM7WUFDRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7WUFDdkIsUUFBUSxFQUFFLFFBQVE7WUFDbEIsUUFBUSxFQUFFLEVBQUUsQ0FBQyxXQUFXO1NBQ3pCLENBQ0YsQ0FBQztRQUVGLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFeEUsVUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUFhLENBQUM7WUFDMUIsTUFBTSxFQUFFLElBQUk7WUFDWixRQUFRLEVBQUUsS0FBSyxDQUFDLG9CQUFvQixDQUFDLE9BQU87WUFDNUMsTUFBTSxFQUFFLEVBQUU7WUFDVixRQUFRLEVBQUUsS0FBSyxDQUFDLHVCQUF1QixDQUFDLFlBQVk7WUFDcEQsSUFBSSxFQUFFLGFBQWE7U0FDcEIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDO0lBRU0sY0FBYyxDQUFDLEtBQWtCO1FBQ3RDLElBQUksQ0FBQyxDQUFDLEtBQUssWUFBWSxhQUFLLENBQUMsRUFBRSxDQUFDO1lBQzlCLE1BQU0sSUFBSSxLQUFLLENBQ2Isd0VBQXdFLENBQ3pFLENBQUM7UUFDSixDQUFDO1FBRUQsSUFBSSw2Q0FBb0IsQ0FDdEIsSUFBSSxFQUNKLFNBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxtQkFBbUIsQ0FBQyxFQUM5QztZQUNFLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixRQUFRLEVBQUUsS0FBSztZQUNmLFFBQVEsRUFBRSxLQUFLLENBQUMsUUFBUTtZQUN4QixrQkFBa0IsRUFBRSxJQUFJO1NBQ3pCLENBQ0YsQ0FBQztRQUVGLElBQUksaUNBQWMsQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDNUQsUUFBUSxFQUFFLEtBQUssQ0FBQyxRQUFRO1lBQ3hCLE1BQU0sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNyQixPQUFPLEVBQUUsWUFBWTtnQkFDckIsU0FBUyxFQUFFO29CQUNUO3dCQUNFLE1BQU0sRUFBRSxPQUFPO3dCQUNmLFNBQVMsRUFBRTs0QkFDVCxPQUFPLEVBQUUsbUJBQW1CO3lCQUM3Qjt3QkFDRCxNQUFNLEVBQUUsaUJBQWlCO3dCQUN6QixRQUFRLEVBQUUsR0FBRyxLQUFLLENBQUMsUUFBUSxFQUFFO3dCQUM3QixTQUFTLEVBQUU7NEJBQ1QsU0FBUyxFQUFFO2dDQUNULGVBQWUsRUFBRSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUU7NkJBQ3BDO3lCQUNGO3FCQUNGO2lCQUNGO2FBQ0YsQ0FBQztTQUNILENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLHNCQUFzQixDQUMzQixNQUFnQixFQUNoQixTQUFpQixFQUNqQixTQUFpQjtRQUVqQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksaUNBQWMsQ0FDbkMsSUFBSSxFQUNKLHFCQUFxQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUN2QztZQUNFLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUc7WUFDbkIsTUFBTSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ3JCLFNBQVMsRUFBRTtvQkFDVDt3QkFDRSxNQUFNLEVBQUUsT0FBTzt3QkFDZixTQUFTLEVBQUU7NEJBQ1QsT0FBTyxFQUFFLFNBQVM7eUJBQ25CO3dCQUNELE1BQU0sRUFBRSxhQUFhO3dCQUNyQixRQUFRLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHO3dCQUN4QixTQUFTLEVBQUU7NEJBQ1QsU0FBUyxFQUFFO2dDQUNULGVBQWUsRUFBRSxTQUFTOzZCQUMzQjt5QkFDRjtxQkFDRjtpQkFDRjthQUNGLENBQUM7U0FDSCxDQUNGLENBQUM7SUFDSixDQUFDO0lBRU0sTUFBTSxDQUFDLElBQW1CLEVBQUUsR0FBYTtRQUM5QyxJQUFJLENBQUMsNEJBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzdDLE1BQU0sSUFBSSxLQUFLLENBQUMsaURBQWlELENBQUMsQ0FBQztRQUNyRSxDQUFDO1FBRUQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEdBQUcsSUFBQSx1Q0FBeUIsRUFBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRTVFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFcEQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQUVELGdCQUFnQjtJQUNULFdBQVc7UUFDaEIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FDNUIsU0FBUyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsWUFBWSxDQUFDLEVBQ2hELFVBQVUsRUFDVixhQUFhLEVBQ2IsQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FDckMsQ0FBQztJQUNKLENBQUM7SUFDRCxnQkFBZ0I7SUFDaEIsSUFBVyxRQUFRO1FBQ2pCLE9BQU87WUFDTCxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFO1NBQ3pDLENBQUM7SUFDSixDQUFDO0lBRU8sT0FBTztRQUNiLE9BQU8sYUFBYSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ2pELENBQUM7SUFFRCxJQUFXLFFBQVE7UUFDakIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztJQUN4QixDQUFDO0lBRUQsSUFBVyxTQUFTO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7SUFDekIsQ0FBQztDQUNGO0FBckxELHNCQXFMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9hcHBcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIH0gZnJvbSBcIi4vZnVuY3Rpb25cIjtcbmltcG9ydCB7IFF1ZXVlIH0gZnJvbSBcIi4vcXVldWVcIjtcbmltcG9ydCB7IFNuc1RvcGljIH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9zbnMtdG9waWNcIjtcbmltcG9ydCB7IFNuc1RvcGljUG9saWN5IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9zbnMtdG9waWMtcG9saWN5XCI7XG5pbXBvcnQgeyBTbnNUb3BpY1N1YnNjcmlwdGlvbiB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3Mvc25zLXRvcGljLXN1YnNjcmlwdGlvblwiO1xuaW1wb3J0IHsgU3FzUXVldWVQb2xpY3kgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL3Nxcy1xdWV1ZS1wb2xpY3lcIjtcbmltcG9ydCAqIGFzIGNsb3VkIGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0ICogYXMgY29yZSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgTmFtZU9wdGlvbnMsIFJlc291cmNlTmFtZXMgfSBmcm9tIFwiLi4vc2hhcmVkL3Jlc291cmNlLW5hbWVzXCI7XG5pbXBvcnQgeyBBd3NJbmZsaWdodEhvc3QgfSBmcm9tIFwiLi4vc2hhcmVkLWF3c1wiO1xuaW1wb3J0IHsgY2FsY3VsYXRlVG9waWNQZXJtaXNzaW9ucyB9IGZyb20gXCIuLi9zaGFyZWQtYXdzL3Blcm1pc3Npb25zXCI7XG5pbXBvcnQgeyBJQXdzVG9waWMsIFRvcGljT25NZXNzYWdlSGFuZGxlciB9IGZyb20gXCIuLi9zaGFyZWQtYXdzL3RvcGljXCI7XG5pbXBvcnQgeyBJSW5mbGlnaHRIb3N0LCBOb2RlLCBSZXNvdXJjZSB9IGZyb20gXCIuLi9zdGRcIjtcblxuLyoqXG4gKiBUb3BpYyBuYW1lcyBhcmUgbGltaXRlZCB0byAyNTYgY2hhcmFjdGVycy5cbiAqIFlvdSBjYW4gdXNlIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzLCBoeXBoZW5zICgtKSBhbmQgdW5kZXJzY29yZXMgKF8pLlxuICovXG5jb25zdCBOQU1FX09QVFM6IE5hbWVPcHRpb25zID0ge1xuICBtYXhMZW46IDI1NixcbiAgZGlzYWxsb3dlZFJlZ2V4OiAvW15hLXpBLVowLTlcXF9cXC1dKy9nLFxufTtcblxuLyoqXG4gKiBBV1MgSW1wbGVtZW50YXRpb24gb2YgYGNsb3VkLlRvcGljYC5cbiAqXG4gKiBAaW5mbGlnaHQgYEB3aW5nbGFuZy9zZGsuY2xvdWQuSVRvcGljQ2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgVG9waWMgZXh0ZW5kcyBjbG91ZC5Ub3BpYyBpbXBsZW1lbnRzIElBd3NUb3BpYyB7XG4gIHByaXZhdGUgcmVhZG9ubHkgdG9waWM6IFNuc1RvcGljO1xuICBwcml2YXRlIHJlYWRvbmx5IGhhbmRsZXJzOiBSZWNvcmQ8c3RyaW5nLCBGdW5jdGlvbj4gPSB7fTtcbiAgLyoqXG4gICAqIFRvcGljJ3MgcHVibGlzaGluZyBwZXJtaXNzaW9ucy4gY2FuIGJlIHVzZSBhcyBhIGRlcGVuZGVuY3kgb2YgYW5vdGhlciByZXNvdXJjZS5cbiAgICogKHRoZSBvbmUgdGhhdCBnb3QgdGhlIHBlcm1pc3Npb25zIHRvIHB1Ymxpc2gpXG4gICAqICovXG4gIHB1YmxpYyBwZXJtaXNzaW9ucyE6IFNuc1RvcGljUG9saWN5O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBjbG91ZC5Ub3BpY1Byb3BzID0ge30pIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIHRoaXMudG9waWMgPSBuZXcgU25zVG9waWModGhpcywgXCJEZWZhdWx0XCIsIHtcbiAgICAgIG5hbWU6IFJlc291cmNlTmFtZXMuZ2VuZXJhdGVOYW1lKHRoaXMsIE5BTUVfT1BUUyksXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgb25NZXNzYWdlKFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JVG9waWNPbk1lc3NhZ2VIYW5kbGVyLFxuICAgIHByb3BzOiBjbG91ZC5Ub3BpY09uTWVzc2FnZU9wdGlvbnMgPSB7fVxuICApOiBjbG91ZC5GdW5jdGlvbiB7XG4gICAgY29uc3QgZnVuY3Rpb25IYW5kbGVyID0gVG9waWNPbk1lc3NhZ2VIYW5kbGVyLnRvRnVuY3Rpb25IYW5kbGVyKGluZmxpZ2h0KTtcbiAgICBsZXQgZm4gPSB0aGlzLmhhbmRsZXJzW2luZmxpZ2h0Ll9pZF07XG4gICAgaWYgKGZuKSB7XG4gICAgICByZXR1cm4gZm47XG4gICAgfVxuXG4gICAgZm4gPSBuZXcgRnVuY3Rpb24oXG4gICAgICAvLyBvayBzaW5jZSB3ZSdyZSBub3QgYSB0cmVlIHJvb3RcbiAgICAgIHRoaXMubm9kZS5zY29wZSEsXG4gICAgICBBcHAub2YodGhpcykubWFrZUlkKHRoaXMsIGAke3RoaXMubm9kZS5pZH0tT25NZXNzYWdlYCksXG4gICAgICBmdW5jdGlvbkhhbmRsZXIsXG4gICAgICBwcm9wc1xuICAgICk7XG4gICAgdGhpcy5oYW5kbGVyc1tpbmZsaWdodC5faWRdID0gZm47XG5cbiAgICAvLyBUT0RPOiByZW1vdmUgdGhpcyBjb25zdHJhaW50IGJ5IGFkZGluZyBnZW5lcmljIHBlcm1pc3Npb24gQVBJcyB0byBjbG91ZC5GdW5jdGlvblxuICAgIGlmICghKGZuIGluc3RhbmNlb2YgRnVuY3Rpb24pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUb3BpYyBvbmx5IHN1cHBvcnRzIGNyZWF0aW5nIHRmYXdzLkZ1bmN0aW9uIHJpZ2h0IG5vd1wiKTtcbiAgICB9XG5cbiAgICBuZXcgU25zVG9waWNTdWJzY3JpcHRpb24oXG4gICAgICB0aGlzLFxuICAgICAgQXBwLm9mKHRoaXMpLm1ha2VJZCh0aGlzLCBcIlRvcGljU3Vic2NyaXB0aW9uXCIpLFxuICAgICAge1xuICAgICAgICB0b3BpY0FybjogdGhpcy50b3BpY0FybixcbiAgICAgICAgcHJvdG9jb2w6IFwibGFtYmRhXCIsXG4gICAgICAgIGVuZHBvaW50OiBmbi5mdW5jdGlvbkFybixcbiAgICAgIH1cbiAgICApO1xuXG4gICAgZm4uYWRkUGVybWlzc2lvblRvSW52b2tlKHRoaXMsIFwic25zLmFtYXpvbmF3cy5jb21cIiwgdGhpcy50b3BpYy5hcm4sIHt9KTtcblxuICAgIE5vZGUub2YodGhpcykuYWRkQ29ubmVjdGlvbih7XG4gICAgICBzb3VyY2U6IHRoaXMsXG4gICAgICBzb3VyY2VPcDogY2xvdWQuVG9waWNJbmZsaWdodE1ldGhvZHMuUFVCTElTSCxcbiAgICAgIHRhcmdldDogZm4sXG4gICAgICB0YXJnZXRPcDogY2xvdWQuRnVuY3Rpb25JbmZsaWdodE1ldGhvZHMuSU5WT0tFX0FTWU5DLFxuICAgICAgbmFtZTogXCJvbk1lc3NhZ2UoKVwiLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHVibGljIHN1YnNjcmliZVF1ZXVlKHF1ZXVlOiBjbG91ZC5RdWV1ZSk6IHZvaWQge1xuICAgIGlmICghKHF1ZXVlIGluc3RhbmNlb2YgUXVldWUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiJ3N1YnNjcmliZVF1ZXVlJyBhbGxvd3Mgb25seSB0ZmF3cy5RdWV1ZSB0byBiZSBzdWJzY3JpYmVkIHRvIHRoZSBUb3BpY1wiXG4gICAgICApO1xuICAgIH1cblxuICAgIG5ldyBTbnNUb3BpY1N1YnNjcmlwdGlvbihcbiAgICAgIHRoaXMsXG4gICAgICBBcHAub2YodGhpcykubWFrZUlkKHRoaXMsIFwiVG9waWNTdWJzY3JpcHRpb25cIiksXG4gICAgICB7XG4gICAgICAgIHRvcGljQXJuOiB0aGlzLnRvcGljQXJuLFxuICAgICAgICBwcm90b2NvbDogXCJzcXNcIixcbiAgICAgICAgZW5kcG9pbnQ6IHF1ZXVlLnF1ZXVlQXJuLFxuICAgICAgICByYXdNZXNzYWdlRGVsaXZlcnk6IHRydWUsXG4gICAgICB9XG4gICAgKTtcblxuICAgIG5ldyBTcXNRdWV1ZVBvbGljeSh0aGlzLCBgU3FzUXVldWVQb2xpY3ktJHtxdWV1ZS5ub2RlLmFkZHJ9YCwge1xuICAgICAgcXVldWVVcmw6IHF1ZXVlLnF1ZXVlVXJsLFxuICAgICAgcG9saWN5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIFZlcnNpb246IFwiMjAxMi0xMC0xN1wiLFxuICAgICAgICBTdGF0ZW1lbnQ6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBFZmZlY3Q6IFwiQWxsb3dcIixcbiAgICAgICAgICAgIFByaW5jaXBhbDoge1xuICAgICAgICAgICAgICBTZXJ2aWNlOiBcInNucy5hbWF6b25hd3MuY29tXCIsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgQWN0aW9uOiBcInNxczpTZW5kTWVzc2FnZVwiLFxuICAgICAgICAgICAgUmVzb3VyY2U6IGAke3F1ZXVlLnF1ZXVlQXJufWAsXG4gICAgICAgICAgICBDb25kaXRpb246IHtcbiAgICAgICAgICAgICAgQXJuRXF1YWxzOiB7XG4gICAgICAgICAgICAgICAgXCJhd3M6U291cmNlQXJuXCI6IGAke3RoaXMudG9waWNBcm59YCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH0pLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdyYW50cyB0aGUgZ2l2ZW4gaWRlbnRpdHkgcGVybWlzc2lvbnMgdG8gcHVibGlzaCB0aGlzIHRvcGljLlxuICAgKiBAcGFyYW0gc291cmNlIHRoZSByZXNvdXJjZSB0aGF0IHdpbGwgcHVibGlzaCB0byB0aGUgdG9waWNcbiAgICogQHBhcmFtIHByaW5jaXBhbCBUaGUgQVdTIHByaW5jaXBhbCB0byBncmFudCBwdWJsaXNoIHBlcm1pc3Npb25zIHRvIChlLmcuIFwiczMuYW1hem9uYXdzLmNvbVwiLCBcImV2ZW50cy5hbWF6b25hd3MuY29tXCIsIFwic25zLmFtYXpvbmF3cy5jb21cIilcbiAgICogQHBhcmFtIHNvdXJjZUFybiBzb3VyY2UgYXJuXG4gICAqL1xuICBwdWJsaWMgYWRkUGVybWlzc2lvblRvUHVibGlzaChcbiAgICBzb3VyY2U6IFJlc291cmNlLFxuICAgIHByaW5jaXBhbDogc3RyaW5nLFxuICAgIHNvdXJjZUFybjogc3RyaW5nXG4gICk6IHZvaWQge1xuICAgIHRoaXMucGVybWlzc2lvbnMgPSBuZXcgU25zVG9waWNQb2xpY3koXG4gICAgICB0aGlzLFxuICAgICAgYFB1Ymxpc2hQZXJtaXNzaW9uLSR7c291cmNlLm5vZGUuYWRkcn1gLFxuICAgICAge1xuICAgICAgICBhcm46IHRoaXMudG9waWMuYXJuLFxuICAgICAgICBwb2xpY3k6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBTdGF0ZW1lbnQ6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgRWZmZWN0OiBcIkFsbG93XCIsXG4gICAgICAgICAgICAgIFByaW5jaXBhbDoge1xuICAgICAgICAgICAgICAgIFNlcnZpY2U6IHByaW5jaXBhbCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgQWN0aW9uOiBcInNuczpQdWJsaXNoXCIsXG4gICAgICAgICAgICAgIFJlc291cmNlOiB0aGlzLnRvcGljLmFybixcbiAgICAgICAgICAgICAgQ29uZGl0aW9uOiB7XG4gICAgICAgICAgICAgICAgQXJuRXF1YWxzOiB7XG4gICAgICAgICAgICAgICAgICBcImF3czpTb3VyY2VBcm5cIjogc291cmNlQXJuLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH0pLFxuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgb25MaWZ0KGhvc3Q6IElJbmZsaWdodEhvc3QsIG9wczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICBpZiAoIUF3c0luZmxpZ2h0SG9zdC5pc0F3c0luZmxpZ2h0SG9zdChob3N0KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSG9zdCBpcyBleHBlY3RlZCB0byBpbXBsZW1lbnQgYElBd3NJbmZpZ2h0SG9zdGBcIik7XG4gICAgfVxuXG4gICAgaG9zdC5hZGRQb2xpY3lTdGF0ZW1lbnRzKC4uLmNhbGN1bGF0ZVRvcGljUGVybWlzc2lvbnModGhpcy50b3BpYy5hcm4sIG9wcykpO1xuXG4gICAgaG9zdC5hZGRFbnZpcm9ubWVudCh0aGlzLmVudk5hbWUoKSwgdGhpcy50b3BpYy5hcm4pO1xuXG4gICAgc3VwZXIub25MaWZ0KGhvc3QsIG9wcyk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyBfdG9JbmZsaWdodCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBjb3JlLkluZmxpZ2h0Q2xpZW50LmZvcihcbiAgICAgIF9fZGlybmFtZS5yZXBsYWNlKFwidGFyZ2V0LXRmLWF3c1wiLCBcInNoYXJlZC1hd3NcIiksXG4gICAgICBfX2ZpbGVuYW1lLFxuICAgICAgXCJUb3BpY0NsaWVudFwiLFxuICAgICAgW2Bwcm9jZXNzLmVudltcIiR7dGhpcy5lbnZOYW1lKCl9XCJdYF1cbiAgICApO1xuICB9XG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIGdldCBfbGlmdE1hcCgpOiBjb3JlLkxpZnRNYXAge1xuICAgIHJldHVybiB7XG4gICAgICBbY2xvdWQuVG9waWNJbmZsaWdodE1ldGhvZHMuUFVCTElTSF06IFtdLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGVudk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFRPUElDX0FSTl8ke3RoaXMubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG5cbiAgcHVibGljIGdldCB0b3BpY0FybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnRvcGljLmFybjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdG9waWNOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMudG9waWMubmFtZTtcbiAgfVxufVxuIl19