"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Redis = void 0;
const app_1 = require("./app");
const elasticache_cluster_1 = require("../.gen/providers/aws/elasticache-cluster");
const elasticache_subnet_group_1 = require("../.gen/providers/aws/elasticache-subnet-group");
const security_group_1 = require("../.gen/providers/aws/security-group");
const core = __importStar(require("../core"));
const ex = __importStar(require("../ex"));
const resource_names_1 = require("../shared/resource-names");
const shared_aws_1 = require("../shared-aws");
const ELASTICACHE_NAME_OPTS = {
    maxLen: 50,
    disallowedRegex: /([^a-zA-Z0-9]+)/g,
    case: resource_names_1.CaseConventions.LOWERCASE,
};
class Redis extends ex.Redis {
    constructor(scope, id) {
        super(scope, id);
        if (process.env.REDIS_ENGINE_VERSION &&
            !process.env.REDIS_PARAMETER_GROUP_NAME) {
            throw new Error("REDIS_PARAMETER_GROUP_NAME must be set if REDIS_ENGINE_VERSION is set");
        }
        const engine = "redis";
        const engineVersion = process.env.REDIS_ENGINE_VERSION ?? "6.2";
        const nodeType = process.env.REDIS_CLUSTER_NODE_TYPE ?? "cache.t4g.small";
        const parameterGroupName = process.env.REDIS_PARAMETER_GROUP_NAME ?? "default.redis6.x";
        const REDIS_PORT = 6379;
        const app = app_1.App.of(this);
        const vpc = app.vpc;
        this.subnets = app.subnets.private;
        this.securityGroups = [];
        const clusterName = resource_names_1.ResourceNames.generateName(this, ELASTICACHE_NAME_OPTS);
        for (const subnet of this.subnets) {
            this.securityGroups.push(new security_group_1.SecurityGroup(this, `${subnet.id.slice(-8)}securityGroup`, {
                vpcId: vpc.id,
                name: `${this.node.addr.slice(-8)}-securityGroup`,
                ingress: [
                    {
                        cidrBlocks: [subnet.cidrBlock],
                        fromPort: REDIS_PORT,
                        toPort: REDIS_PORT,
                        protocol: "tcp",
                        selfAttribute: true,
                    },
                ],
                egress: [
                    {
                        cidrBlocks: ["0.0.0.0/0"],
                        fromPort: 0,
                        toPort: 0,
                        protocol: "-1",
                    },
                ],
            }));
        }
        const subnetGroup = new elasticache_subnet_group_1.ElasticacheSubnetGroup(this, "RedisSubnetGroup", {
            name: `${clusterName}-subnetGroup`,
            subnetIds: [...this.subnets.map((s) => s.id)],
        });
        const cluster = new elasticache_cluster_1.ElasticacheCluster(this, "RedisCluster", {
            clusterId: clusterName,
            engine,
            engineVersion,
            nodeType,
            parameterGroupName,
            availabilityZone: this.subnets[0].availabilityZone,
            subnetGroupName: subnetGroup.name,
            securityGroupIds: [...this.securityGroups.map((s) => s.id)],
            numCacheNodes: 1, // This number will always be 1 for Redis
        });
        this.clusterId = cluster.clusterId;
        this.clusterArn = cluster.arn;
    }
    /** @internal */
    get _liftMap() {
        return {
            [ex.RedisInflightMethods.URL]: [],
            [ex.RedisInflightMethods.SET]: [],
            [ex.RedisInflightMethods.GET]: [],
            [ex.RedisInflightMethods.HSET]: [],
            [ex.RedisInflightMethods.HGET]: [],
            [ex.RedisInflightMethods.SADD]: [],
            [ex.RedisInflightMethods.SMEMBERS]: [],
            [ex.RedisInflightMethods.DEL]: [],
        };
    }
    onLift(host, ops) {
        const env = this.envName();
        if (!shared_aws_1.AwsInflightHost.isAwsInflightHost(host)) {
            throw new Error("Host is expected to implement `IAwsInfightHost`");
        }
        // Ops do not matter here since the client connects directly to the cluster.
        // The only thing that we need to use AWS API for is to get the cluster endpoint
        // from the cluster ID.
        host.addPolicyStatements({
            actions: ["elasticache:Describe*"],
            resources: [this.clusterArn],
        });
        host.addEnvironment(env, this.clusterId);
        host.addNetwork({
            securityGroupIds: [...this.securityGroups.map((s) => s.id)],
            subnetIds: [...this.subnets.map((s) => s.id)],
        });
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core.InflightClient.for(__dirname, __filename, "RedisClient", [
            `process.env["${this.envName()}"]`,
        ]);
    }
    envName() {
        return `REDIS_CLUSTER_ID_${this.node.addr.slice(-8)}`;
    }
}
exports.Redis = Redis;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkaXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXRmLWF3cy9yZWRpcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLCtCQUE0QjtBQUU1QixtRkFBK0U7QUFDL0UsNkZBQXdGO0FBQ3hGLHlFQUFxRTtBQUVyRSw4Q0FBZ0M7QUFDaEMsMENBQTRCO0FBQzVCLDZEQUlrQztBQUNsQyw4Q0FBZ0Q7QUFHaEQsTUFBTSxxQkFBcUIsR0FBZ0I7SUFDekMsTUFBTSxFQUFFLEVBQUU7SUFDVixlQUFlLEVBQUUsa0JBQWtCO0lBQ25DLElBQUksRUFBRSxnQ0FBZSxDQUFDLFNBQVM7Q0FDaEMsQ0FBQztBQUVGLE1BQWEsS0FBTSxTQUFRLEVBQUUsQ0FBQyxLQUFLO0lBTWpDLFlBQVksS0FBZ0IsRUFBRSxFQUFVO1FBQ3RDLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsSUFDRSxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQjtZQUNoQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLEVBQ3ZDLENBQUM7WUFDRCxNQUFNLElBQUksS0FBSyxDQUNiLHVFQUF1RSxDQUN4RSxDQUFDO1FBQ0osQ0FBQztRQUVELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQztRQUN2QixNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixJQUFJLEtBQUssQ0FBQztRQUNoRSxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QixJQUFJLGlCQUFpQixDQUFDO1FBQzFFLE1BQU0sa0JBQWtCLEdBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLElBQUksa0JBQWtCLENBQUM7UUFDL0QsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBRXhCLE1BQU0sR0FBRyxHQUFHLFNBQUcsQ0FBQyxFQUFFLENBQUMsSUFB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QUM7SUFDMUIsQ0FBQztJQUVELGdCQUFnQjtJQUNULFdBQVc7UUFDaEIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRTtZQUNuRSxnQkFBZ0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJO1NBQ25DLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxPQUFPO1FBQ2IsT0FBTyxvQkFBb0IsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUN4RCxDQUFDO0NBQ0Y7QUE5SEQsc0JBOEhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL2FwcFwiO1xuaW1wb3J0IHsgRGF0YUF3c1N1Ym5ldCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvZGF0YS1hd3Mtc3VibmV0XCI7XG5pbXBvcnQgeyBFbGFzdGljYWNoZUNsdXN0ZXIgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL2VsYXN0aWNhY2hlLWNsdXN0ZXJcIjtcbmltcG9ydCB7IEVsYXN0aWNhY2hlU3VibmV0R3JvdXAgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL2VsYXN0aWNhY2hlLXN1Ym5ldC1ncm91cFwiO1xuaW1wb3J0IHsgU2VjdXJpdHlHcm91cCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3Mvc2VjdXJpdHktZ3JvdXBcIjtcbmltcG9ydCB7IFN1Ym5ldCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3Mvc3VibmV0XCI7XG5pbXBvcnQgKiBhcyBjb3JlIGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgKiBhcyBleCBmcm9tIFwiLi4vZXhcIjtcbmltcG9ydCB7XG4gIENhc2VDb252ZW50aW9ucyxcbiAgTmFtZU9wdGlvbnMsXG4gIFJlc291cmNlTmFtZXMsXG59IGZyb20gXCIuLi9zaGFyZWQvcmVzb3VyY2UtbmFtZXNcIjtcbmltcG9ydCB7IEF3c0luZmxpZ2h0SG9zdCB9IGZyb20gXCIuLi9zaGFyZWQtYXdzXCI7XG5pbXBvcnQgeyBJSW5mbGlnaHRIb3N0IH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG5jb25zdCBFTEFTVElDQUNIRV9OQU1FX09QVFM6IE5hbWVPcHRpb25zID0ge1xuICBtYXhMZW46IDUwLFxuICBkaXNhbGxvd2VkUmVnZXg6IC8oW15hLXpBLVowLTldKykvZyxcbiAgY2FzZTogQ2FzZUNvbnZlbnRpb25zLkxPV0VSQ0FTRSxcbn07XG5cbmV4cG9ydCBjbGFzcyBSZWRpcyBleHRlbmRzIGV4LlJlZGlzIHtcbiAgcHJpdmF0ZSByZWFkb25seSBjbHVzdGVySWQ6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBjbHVzdGVyQXJuOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgc2VjdXJpdHlHcm91cHM6IFNlY3VyaXR5R3JvdXBbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBzdWJuZXRzOiAoU3VibmV0IHwgRGF0YUF3c1N1Ym5ldClbXTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGlmIChcbiAgICAgIHByb2Nlc3MuZW52LlJFRElTX0VOR0lORV9WRVJTSU9OICYmXG4gICAgICAhcHJvY2Vzcy5lbnYuUkVESVNfUEFSQU1FVEVSX0dST1VQX05BTUVcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJSRURJU19QQVJBTUVURVJfR1JPVVBfTkFNRSBtdXN0IGJlIHNldCBpZiBSRURJU19FTkdJTkVfVkVSU0lPTiBpcyBzZXRcIlxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBlbmdpbmUgPSBcInJlZGlzXCI7XG4gICAgY29uc3QgZW5naW5lVmVyc2lvbiA9IHByb2Nlc3MuZW52LlJFRElTX0VOR0lORV9WRVJTSU9OID8/IFwiNi4yXCI7XG4gICAgY29uc3Qgbm9kZVR5cGUgPSBwcm9jZXNzLmVudi5SRURJU19DTFVTVEVSX05PREVfVFlQRSA/PyBcImNhY2hlLnQ0Zy5zbWFsbFwiO1xuICAgIGNvbnN0IHBhcmFtZXRlckdyb3VwTmFtZSA9XG4gICAgICBwcm9jZXNzLmVudi5SRURJU19QQVJBTUVURVJfR1JPVVBfTkFNRSA/PyBcImRlZmF1bHQucmVkaXM2LnhcIjtcbiAgICBjb25zdCBSRURJU19QT1JUID0gNjM3OTtcblxuICAgIGNvbnN0IGFwcCA9IEFwcC5vZih0aGlzKSBhcyBBcHA7XG4gICAgY29uc3QgdnBjID0gYXBwLnZwYztcbiAgICB0aGlzLnN1Ym5ldHMgPSBhcHAuc3VibmV0cy5wcml2YXRlO1xuICAgIHRoaXMuc2VjdXJpdHlHcm91cHMgPSBbXTtcbiAgICBjb25zdCBjbHVzdGVyTmFtZSA9IFJlc291cmNlTmFtZXMuZ2VuZXJhdGVOYW1lKHRoaXMsIEVMQVNUSUNBQ0hFX05BTUVfT1BUUyk7XG4gICAgZm9yIChjb25zdCBzdWJuZXQgb2YgdGhpcy5zdWJuZXRzKSB7XG4gICAgICB0aGlzLnNlY3VyaXR5R3JvdXBzLnB1c2goXG4gICAgICAgIG5ldyBTZWN1cml0eUdyb3VwKHRoaXMsIGAke3N1Ym5ldC5pZC5zbGljZSgtOCl9c2VjdXJpdHlHcm91cGAsIHtcbiAgICAgICAgICB2cGNJZDogdnBjLmlkLFxuICAgICAgICAgIG5hbWU6IGAke3RoaXMubm9kZS5hZGRyLnNsaWNlKC04KX0tc2VjdXJpdHlHcm91cGAsXG4gICAgICAgICAgaW5ncmVzczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBjaWRyQmxvY2tzOiBbc3VibmV0LmNpZHJCbG9ja10sXG4gICAgICAgICAgICAgIGZyb21Qb3J0OiBSRURJU19QT1JULFxuICAgICAgICAgICAgICB0b1BvcnQ6IFJFRElTX1BPUlQsXG4gICAgICAgICAgICAgIHByb3RvY29sOiBcInRjcFwiLFxuICAgICAgICAgICAgICBzZWxmQXR0cmlidXRlOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdLFxuICAgICAgICAgIGVncmVzczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBjaWRyQmxvY2tzOiBbXCIwLjAuMC4wLzBcIl0sXG4gICAgICAgICAgICAgIGZyb21Qb3J0OiAwLFxuICAgICAgICAgICAgICB0b1BvcnQ6IDAsXG4gICAgICAgICAgICAgIHByb3RvY29sOiBcIi0xXCIsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHN1Ym5ldEdyb3VwID0gbmV3IEVsYXN0aWNhY2hlU3VibmV0R3JvdXAodGhpcywgXCJSZWRpc1N1Ym5ldEdyb3VwXCIsIHtcbiAgICAgIG5hbWU6IGAke2NsdXN0ZXJOYW1lfS1zdWJuZXRHcm91cGAsXG4gICAgICBzdWJuZXRJZHM6IFsuLi50aGlzLnN1Ym5ldHMubWFwKChzKSA9PiBzLmlkKV0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBjbHVzdGVyID0gbmV3IEVsYXN0aWNhY2hlQ2x1c3Rlcih0aGlzLCBcIlJlZGlzQ2x1c3RlclwiLCB7XG4gICAgICBjbHVzdGVySWQ6IGNsdXN0ZXJOYW1lLFxuICAgICAgZW5naW5lLFxuICAgICAgZW5naW5lVmVyc2lvbixcbiAgICAgIG5vZGVUeXBlLFxuICAgICAgcGFyYW1ldGVyR3JvdXBOYW1lLFxuICAgICAgYXZhaWxhYmlsaXR5Wm9uZTogdGhpcy5zdWJuZXRzWzBdLmF2YWlsYWJpbGl0eVpvbmUsXG4gICAgICBzdWJuZXRHcm91cE5hbWU6IHN1Ym5ldEdyb3VwLm5hbWUsXG4gICAgICBzZWN1cml0eUdyb3VwSWRzOiBbLi4udGhpcy5zZWN1cml0eUdyb3Vwcy5tYXAoKHMpID0+IHMuaWQpXSxcbiAgICAgIG51bUNhY2hlTm9kZXM6IDEsIC8vIFRoaXMgbnVtYmVyIHdpbGwgYWx3YXlzIGJlIDEgZm9yIFJlZGlzXG4gICAgfSk7XG5cbiAgICB0aGlzLmNsdXN0ZXJJZCA9IGNsdXN0ZXIuY2x1c3RlcklkO1xuICAgIHRoaXMuY2x1c3RlckFybiA9IGNsdXN0ZXIuYXJuO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgZ2V0IF9saWZ0TWFwKCk6IGNvcmUuTGlmdE1hcCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIFtleC5SZWRpc0luZmxpZ2h0TWV0aG9kcy5VUkxdOiBbXSxcbiAgICAgIFtleC5SZWRpc0luZmxpZ2h0TWV0aG9kcy5TRVRdOiBbXSxcbiAgICAgIFtleC5SZWRpc0luZmxpZ2h0TWV0aG9kcy5HRVRdOiBbXSxcbiAgICAgIFtleC5SZWRpc0luZmxpZ2h0TWV0aG9kcy5IU0VUXTogW10sXG4gICAgICBbZXguUmVkaXNJbmZsaWdodE1ldGhvZHMuSEdFVF06IFtdLFxuICAgICAgW2V4LlJlZGlzSW5mbGlnaHRNZXRob2RzLlNBRERdOiBbXSxcbiAgICAgIFtleC5SZWRpc0luZmxpZ2h0TWV0aG9kcy5TTUVNQkVSU106IFtdLFxuICAgICAgW2V4LlJlZGlzSW5mbGlnaHRNZXRob2RzLkRFTF06IFtdLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgb25MaWZ0KGhvc3Q6IElJbmZsaWdodEhvc3QsIG9wczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICBjb25zdCBlbnYgPSB0aGlzLmVudk5hbWUoKTtcblxuICAgIGlmICghQXdzSW5mbGlnaHRIb3N0LmlzQXdzSW5mbGlnaHRIb3N0KGhvc3QpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJIb3N0IGlzIGV4cGVjdGVkIHRvIGltcGxlbWVudCBgSUF3c0luZmlnaHRIb3N0YFwiKTtcbiAgICB9XG5cbiAgICAvLyBPcHMgZG8gbm90IG1hdHRlciBoZXJlIHNpbmNlIHRoZSBjbGllbnQgY29ubmVjdHMgZGlyZWN0bHkgdG8gdGhlIGNsdXN0ZXIuXG4gICAgLy8gVGhlIG9ubHkgdGhpbmcgdGhhdCB3ZSBuZWVkIHRvIHVzZSBBV1MgQVBJIGZvciBpcyB0byBnZXQgdGhlIGNsdXN0ZXIgZW5kcG9pbnRcbiAgICAvLyBmcm9tIHRoZSBjbHVzdGVyIElELlxuICAgIGhvc3QuYWRkUG9saWN5U3RhdGVtZW50cyh7XG4gICAgICBhY3Rpb25zOiBbXCJlbGFzdGljYWNoZTpEZXNjcmliZSpcIl0sXG4gICAgICByZXNvdXJjZXM6IFt0aGlzLmNsdXN0ZXJBcm5dLFxuICAgIH0pO1xuXG4gICAgaG9zdC5hZGRFbnZpcm9ubWVudChlbnYsIHRoaXMuY2x1c3RlcklkKTtcblxuICAgIGhvc3QuYWRkTmV0d29yayh7XG4gICAgICBzZWN1cml0eUdyb3VwSWRzOiBbLi4udGhpcy5zZWN1cml0eUdyb3Vwcy5tYXAoKHMpID0+IHMuaWQpXSxcbiAgICAgIHN1Ym5ldElkczogWy4uLnRoaXMuc3VibmV0cy5tYXAoKHMpID0+IHMuaWQpXSxcbiAgICB9KTtcblxuICAgIHN1cGVyLm9uTGlmdChob3N0LCBvcHMpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3RvSW5mbGlnaHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY29yZS5JbmZsaWdodENsaWVudC5mb3IoX19kaXJuYW1lLCBfX2ZpbGVuYW1lLCBcIlJlZGlzQ2xpZW50XCIsIFtcbiAgICAgIGBwcm9jZXNzLmVudltcIiR7dGhpcy5lbnZOYW1lKCl9XCJdYCxcbiAgICBdKTtcbiAgfVxuXG4gIHByaXZhdGUgZW52TmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgUkVESVNfQ0xVU1RFUl9JRF8ke3RoaXMubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG59XG4iXX0=