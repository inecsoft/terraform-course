"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Function = void 0;
const cdktf_1 = require("cdktf");
const app_1 = require("./app");
const cloudwatch_log_group_1 = require("../.gen/providers/aws/cloudwatch-log-group");
const iam_role_1 = require("../.gen/providers/aws/iam-role");
const iam_role_policy_1 = require("../.gen/providers/aws/iam-role-policy");
const iam_role_policy_attachment_1 = require("../.gen/providers/aws/iam-role-policy-attachment");
const lambda_function_1 = require("../.gen/providers/aws/lambda-function");
const lambda_permission_1 = require("../.gen/providers/aws/lambda-permission");
const s3_object_1 = require("../.gen/providers/aws/s3-object");
const security_group_1 = require("../.gen/providers/aws/security-group");
const cloud = __importStar(require("../cloud"));
const core = __importStar(require("../core"));
const errors_1 = require("../core/errors");
const bundling_1 = require("../shared/bundling");
const function_1 = require("../shared/function");
const resource_names_1 = require("../shared/resource-names");
const shared_aws_1 = require("../shared-aws");
const function_util_1 = require("../shared-aws/function-util");
const duration_1 = require("../std/duration");
/**
 * Function names are limited to 64 characters.
 * You can use alphanumeric characters, hyphens (-), and underscores (_).
 */
const FUNCTION_NAME_OPTS = {
    maxLen: 64,
    disallowedRegex: /[^a-zA-Z0-9\_\-]+/g,
};
/**
 * AWS implementation of `cloud.Function`.
 *
 * @inflight `@winglang/sdk.cloud.IFunctionClient`
 */
class Function extends cloud.Function {
    constructor(scope, id, inflight, props = {}) {
        super(scope, id, inflight, props);
        this.vpcPermissionsAdded = false;
        if (props.concurrency != null) {
            throw new errors_1.NotImplementedError("Function concurrency isn't implemented yet on the current target.");
        }
        // Create unique S3 bucket for hosting Lambda code
        const app = app_1.App.of(this);
        const bucket = app.codeBucket;
        // Choose an object name so that:
        // - whenever code changes, the object name changes
        // - even if two functions have the same code, they get different names
        //   (separation of concerns)
        let bundleHashToken = cdktf_1.Lazy.stringValue({
            produce: () => {
                if (!this.bundleHash) {
                    throw new Error("bundleHash was not set");
                }
                return this.bundleHash;
            },
        });
        const objectKey = `asset.${this.node.addr}.${bundleHashToken}.zip`;
        // Upload Lambda zip file to newly created S3 bucket
        const lambdaArchive = new s3_object_1.S3Object(this, "S3Object", {
            bucket: bucket.bucket,
            key: objectKey,
            source: cdktf_1.Lazy.stringValue({
                produce: () => {
                    if (!this.assetPath) {
                        throw new Error("assetPath was not set");
                    }
                    return this.assetPath;
                },
            }),
        });
        // Create Lambda role
        this.role = new iam_role_1.IamRole(this, "IamRole", {
            assumeRolePolicy: JSON.stringify({
                Version: "2012-10-17",
                Statement: [
                    {
                        Action: "sts:AssumeRole",
                        Principal: {
                            Service: "lambda.amazonaws.com",
                        },
                        Effect: "Allow",
                    },
                ],
            }),
        });
        // Add policy to Lambda role for any custom policy statements, such as
        // those needed by bound resources
        new iam_role_policy_1.IamRolePolicy(this, "IamRolePolicy", {
            role: this.role.name,
            policy: cdktf_1.Lazy.stringValue({
                produce: () => {
                    this.policyStatements = this.policyStatements ?? [];
                    if (this.policyStatements.length !== 0) {
                        return JSON.stringify({
                            Version: "2012-10-17",
                            Statement: this.policyStatements,
                        });
                    }
                    // policy must contain at least one statement, so include a no-op statement
                    return JSON.stringify({
                        Version: "2012-10-17",
                        Statement: [
                            {
                                Effect: "Allow",
                                Action: "none:null",
                                Resource: "*",
                            },
                        ],
                    });
                },
            }),
        });
        // Add execution role for lambda to write to CloudWatch logs
        new iam_role_policy_attachment_1.IamRolePolicyAttachment(this, "IamRolePolicyAttachment", {
            policyArn: "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
            role: this.role.name,
        });
        this.name = resource_names_1.ResourceNames.generateName(this, FUNCTION_NAME_OPTS);
        // validate memory size
        if (props.memory && (props.memory < 128 || props.memory > 10240)) {
            throw new Error("Memory for AWS Lambda function should be in between 128 and 10240");
        }
        if (!props.logRetentionDays || props.logRetentionDays >= 0) {
            new cloudwatch_log_group_1.CloudwatchLogGroup(this, "CloudwatchLogGroup", {
                name: `/aws/lambda/${this.name}`,
                retentionInDays: props.logRetentionDays ?? 30,
            });
        }
        else {
            // Negative value means Infinite retention
        }
        // Create Lambda function
        this.function = new lambda_function_1.LambdaFunction(this, "Default", {
            functionName: this.name,
            s3Bucket: bucket.bucket,
            s3Key: lambdaArchive.key,
            handler: "index.handler",
            runtime: "nodejs20.x",
            role: this.role.arn,
            publish: true,
            vpcConfig: {
                subnetIds: cdktf_1.Lazy.listValue({
                    produce: () => this.subnets ? Array.from(this.subnets.values()) : [],
                }),
                securityGroupIds: cdktf_1.Lazy.listValue({
                    produce: () => this.securityGroups ? Array.from(this.securityGroups.values()) : [],
                }),
            },
            environment: {
                variables: cdktf_1.Lazy.anyValue({
                    produce: () => ({
                        ...this.env,
                        // enable source maps
                        NODE_OPTIONS: [
                            ...(this.env.NODE_OPTIONS === undefined
                                ? []
                                : this.env.NODE_OPTIONS.split(" ")),
                            "--enable-source-maps",
                        ].join(" "),
                    }),
                }),
            },
            timeout: props.timeout
                ? props.timeout.seconds
                : duration_1.Duration.fromMinutes(1).seconds,
            memorySize: props.memory ?? function_1.DEFAULT_MEMORY_SIZE,
            architectures: ["arm64"],
        });
        if (app.parameters.value("tf-aws/vpc_lambda") === true) {
            const sg = new security_group_1.SecurityGroup(this, `${id}SecurityGroup`, {
                vpcId: app.vpc.id,
                egress: [
                    {
                        cidrBlocks: ["0.0.0.0/0"],
                        fromPort: 0,
                        toPort: 0,
                        protocol: "-1",
                    },
                ],
            });
            this.addNetwork({
                subnetIds: [...app.subnets.private.map((s) => s.id)],
                securityGroupIds: [sg.id],
            });
        }
        this.qualifiedArn = this.function.qualifiedArn;
        this.invokeArn = this.function.invokeArn;
        // terraform rejects templates with zero environment variables
        this.addEnvironment("WING_FUNCTION_NAME", this.name);
    }
    /** @internal */
    _preSynthesize() {
        super._preSynthesize();
        // write the entrypoint next to the partial inflight code emitted by the compiler, so that
        // `require` resolves naturally.
        const bundle = (0, bundling_1.createBundle)(this.entrypoint, shared_aws_1.externalLibraries);
        // would prefer to create TerraformAsset in the constructor, but using a CDKTF token for
        // the "path" argument isn't supported
        const asset = new cdktf_1.TerraformAsset(this, "Asset", {
            path: bundle.directory,
            type: cdktf_1.AssetType.ARCHIVE,
        });
        this.bundleHash = bundle.hash;
        this.assetPath = asset.path;
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud.FunctionInflightMethods.INVOKE]: [[this.handler, ["handle"]]],
            [cloud.FunctionInflightMethods.INVOKE_ASYNC]: [
                [this.handler, ["handle"]],
            ],
        };
    }
    onLift(host, ops) {
        if (!shared_aws_1.AwsInflightHost.isAwsInflightHost(host)) {
            throw new Error("Host is expected to implement `IAwsInfightHost`");
        }
        if (ops.includes(cloud.FunctionInflightMethods.INVOKE) ||
            ops.includes(cloud.FunctionInflightMethods.INVOKE_ASYNC)) {
            host.addPolicyStatements({
                actions: ["lambda:InvokeFunction"],
                resources: [`${this.function.arn}`],
            });
        }
        // The function name needs to be passed through an environment variable since
        // it may not be resolved until deployment time.
        host.addEnvironment(this.envName(), this.function.arn);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core.InflightClient.for(__dirname.replace("target-tf-aws", "shared-aws"), __filename, "FunctionClient", [`process.env["${this.envName()}"], "${this.node.path}"`]);
    }
    /**
     * Add VPC configurations to lambda function
     */
    addNetwork(vpcConfig) {
        if (!this.subnets || !this.securityGroups) {
            this.subnets = new Set();
            this.securityGroups = new Set();
        }
        vpcConfig.subnetIds.forEach((subnet) => this.subnets.add(subnet));
        vpcConfig.securityGroupIds.forEach((sg) => this.securityGroups.add(sg));
        if (!this.vpcPermissionsAdded) {
            this.addPolicyStatements({
                effect: shared_aws_1.Effect.ALLOW,
                actions: [
                    "ec2:CreateNetworkInterface",
                    "ec2:DescribeNetworkInterfaces",
                    "ec2:DeleteNetworkInterface",
                    "ec2:DescribeSubnets",
                    "ec2:DescribeSecurityGroups",
                ],
                resources: ["*"],
            });
            this.vpcPermissionsAdded = true;
        }
    }
    /**
     * Add a policy statement to the Lambda role.
     */
    addPolicyStatements(...statements) {
        // we do lazy initialization here because addPolicyStatements() might be called through the
        // constructor chain of the Function base class which means that our constructor might not have
        // been called yet... yes, ugly.
        if (!this.policyStatements) {
            this.policyStatements = [];
        }
        for (const statement of statements) {
            this.policyStatements.push({
                Action: statement.actions,
                Resource: statement.resources,
                Effect: statement.effect ?? "Allow",
            });
        }
    }
    /**
     * Grants the given identity permissions to invoke this function.
     * @param principal The AWS principal to grant invoke permissions to (e.g. "s3.amazonaws.com", "events.amazonaws.com", "sns.amazonaws.com")
     */
    addPermissionToInvoke(source, principal, sourceArn, options = { qualifier: this.function.version }) {
        this.permissions = new lambda_permission_1.LambdaPermission(this, `InvokePermission-${source.node.addr}`, {
            functionName: this.functionName,
            action: "lambda:InvokeFunction",
            principal: principal,
            sourceArn: sourceArn,
            ...options,
        });
    }
    envName() {
        return `FUNCTION_NAME_${this.node.addr.slice(-8)}`;
    }
    /**
     * Unqualified Function ARN
     * @returns Unqualified ARN of the function
     */
    get functionArn() {
        return this.function.arn;
    }
    get functionName() {
        return this.function.functionName;
    }
    /**
     * @internal
     */
    _getCodeLines(handler) {
        return (0, function_util_1.makeAwsLambdaHandler)(handler);
    }
}
exports.Function = Function;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXRmLWF3cy9mdW5jdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGlDQUF3RDtBQUV4RCwrQkFBNEI7QUFDNUIscUZBQWdGO0FBQ2hGLDZEQUF5RDtBQUN6RCwyRUFBc0U7QUFDdEUsaUdBQTJGO0FBQzNGLDJFQUF1RTtBQUN2RSwrRUFBMkU7QUFDM0UsK0RBQTJEO0FBQzNELHlFQUFxRTtBQUNyRSxnREFBa0M7QUFDbEMsOENBQWdDO0FBQ2hDLDJDQUFxRDtBQUNyRCxpREFBa0Q7QUFDbEQsaURBQXlEO0FBQ3pELDZEQUFzRTtBQUN0RSw4Q0FPdUI7QUFDdkIsK0RBQW1FO0FBRW5FLDhDQUEyQztBQUUzQzs7O0dBR0c7QUFDSCxNQUFNLGtCQUFrQixHQUFnQjtJQUN0QyxNQUFNLEVBQUUsRUFBRTtJQUNWLGVBQWUsRUFBRSxvQkFBb0I7Q0FDdEMsQ0FBQztBQVlGOzs7O0dBSUc7QUFDSCxNQUFhLFFBQVMsU0FBUSxLQUFLLENBQUMsUUFBUTtJQXdCMUMsWUFDRSxLQUFnQixFQUNoQixFQUFVLEVBQ1YsUUFBZ0MsRUFDaEMsUUFBNkIsRUFBRTtRQUUvQixLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7UUF6QjVCLHdCQUFtQixHQUFHLEtBQUssQ0FBQztRQTJCbEMsSUFBSSxLQUFLLENBQUMsV0FBVyxJQUFJLElBQUksRUFBRSxDQUFDO1lBQzlCLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsbUVBQW1FLENBQ3BFLENBQUM7UUFDSixDQUFDO1FBRUQsa0RBQWtEO1FBQ2xELE1BQU0sR0FBRyxHQUFHLFNBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFRLENBQUM7UUFDaEMsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQztRQUU5Qixp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QUFPO1FBQ2IsT0FBTyxpQkFBaUIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUNyRCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsSUFBVyxXQUFXO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7SUFDM0IsQ0FBQztJQUVELElBQVcsWUFBWTtRQUNyQixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDO0lBQ3BDLENBQUM7SUFFRDs7T0FFRztJQUNPLGFBQWEsQ0FBQyxPQUErQjtRQUNyRCxPQUFPLElBQUEsb0NBQW9CLEVBQUMsT0FBTyxDQUFDLENBQUM7SUFDdkMsQ0FBQztDQUNGO0FBeldELDRCQXlXQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFzc2V0VHlwZSwgTGF6eSwgVGVycmFmb3JtQXNzZXQgfSBmcm9tIFwiY2RrdGZcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9hcHBcIjtcbmltcG9ydCB7IENsb3Vkd2F0Y2hMb2dHcm91cCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvY2xvdWR3YXRjaC1sb2ctZ3JvdXBcIjtcbmltcG9ydCB7IElhbVJvbGUgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL2lhbS1yb2xlXCI7XG5pbXBvcnQgeyBJYW1Sb2xlUG9saWN5IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9pYW0tcm9sZS1wb2xpY3lcIjtcbmltcG9ydCB7IElhbVJvbGVQb2xpY3lBdHRhY2htZW50IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9pYW0tcm9sZS1wb2xpY3ktYXR0YWNobWVudFwiO1xuaW1wb3J0IHsgTGFtYmRhRnVuY3Rpb24gfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL2xhbWJkYS1mdW5jdGlvblwiO1xuaW1wb3J0IHsgTGFtYmRhUGVybWlzc2lvbiB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvbGFtYmRhLXBlcm1pc3Npb25cIjtcbmltcG9ydCB7IFMzT2JqZWN0IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9zMy1vYmplY3RcIjtcbmltcG9ydCB7IFNlY3VyaXR5R3JvdXAgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL3NlY3VyaXR5LWdyb3VwXCI7XG5pbXBvcnQgKiBhcyBjbG91ZCBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCAqIGFzIGNvcmUgZnJvbSBcIi4uL2NvcmVcIjtcbmltcG9ydCB7IE5vdEltcGxlbWVudGVkRXJyb3IgfSBmcm9tIFwiLi4vY29yZS9lcnJvcnNcIjtcbmltcG9ydCB7IGNyZWF0ZUJ1bmRsZSB9IGZyb20gXCIuLi9zaGFyZWQvYnVuZGxpbmdcIjtcbmltcG9ydCB7IERFRkFVTFRfTUVNT1JZX1NJWkUgfSBmcm9tIFwiLi4vc2hhcmVkL2Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBOYW1lT3B0aW9ucywgUmVzb3VyY2VOYW1lcyB9IGZyb20gXCIuLi9zaGFyZWQvcmVzb3VyY2UtbmFtZXNcIjtcbmltcG9ydCB7XG4gIEF3c0luZmxpZ2h0SG9zdCxcbiAgRWZmZWN0LFxuICBJQXdzRnVuY3Rpb24sXG4gIE5ldHdvcmtDb25maWcsXG4gIFBvbGljeVN0YXRlbWVudCxcbiAgZXh0ZXJuYWxMaWJyYXJpZXMsXG59IGZyb20gXCIuLi9zaGFyZWQtYXdzXCI7XG5pbXBvcnQgeyBtYWtlQXdzTGFtYmRhSGFuZGxlciB9IGZyb20gXCIuLi9zaGFyZWQtYXdzL2Z1bmN0aW9uLXV0aWxcIjtcbmltcG9ydCB7IElJbmZsaWdodEhvc3QsIFJlc291cmNlIH0gZnJvbSBcIi4uL3N0ZFwiO1xuaW1wb3J0IHsgRHVyYXRpb24gfSBmcm9tIFwiLi4vc3RkL2R1cmF0aW9uXCI7XG5cbi8qKlxuICogRnVuY3Rpb24gbmFtZXMgYXJlIGxpbWl0ZWQgdG8gNjQgY2hhcmFjdGVycy5cbiAqIFlvdSBjYW4gdXNlIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzLCBoeXBoZW5zICgtKSwgYW5kIHVuZGVyc2NvcmVzIChfKS5cbiAqL1xuY29uc3QgRlVOQ1RJT05fTkFNRV9PUFRTOiBOYW1lT3B0aW9ucyA9IHtcbiAgbWF4TGVuOiA2NCxcbiAgZGlzYWxsb3dlZFJlZ2V4OiAvW15hLXpBLVowLTlcXF9cXC1dKy9nLFxufTtcblxuLyoqXG4gKiBPcHRpb25zIGZvciBncmFudGluZyBpbnZva2UgcGVybWlzc2lvbnMgdG8gdGhlIGN1cnJlbnQgZnVuY3Rpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBGdW5jdGlvblBlcm1pc3Npb25zT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBVc2VkIGZvciBrZWVwaW5nIGZ1bmN0aW9uJ3MgdmVyc2lvbmluZy5cbiAgICovXG4gIHJlYWRvbmx5IHF1YWxpZmllcj86IHN0cmluZztcbn1cblxuLyoqXG4gKiBBV1MgaW1wbGVtZW50YXRpb24gb2YgYGNsb3VkLkZ1bmN0aW9uYC5cbiAqXG4gKiBAaW5mbGlnaHQgYEB3aW5nbGFuZy9zZGsuY2xvdWQuSUZ1bmN0aW9uQ2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgRnVuY3Rpb24gZXh0ZW5kcyBjbG91ZC5GdW5jdGlvbiBpbXBsZW1lbnRzIElBd3NGdW5jdGlvbiB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb246IExhbWJkYUZ1bmN0aW9uO1xuICBwcml2YXRlIHJlYWRvbmx5IHJvbGU6IElhbVJvbGU7XG4gIHByaXZhdGUgcG9saWN5U3RhdGVtZW50cz86IGFueVtdO1xuICBwcml2YXRlIHN1Ym5ldHM/OiBTZXQ8c3RyaW5nPjtcbiAgcHJpdmF0ZSB2cGNQZXJtaXNzaW9uc0FkZGVkID0gZmFsc2U7XG4gIHByaXZhdGUgc2VjdXJpdHlHcm91cHM/OiBTZXQ8c3RyaW5nPjtcblxuICAvKipcbiAgICogUXVhbGlmaWVkIEZ1bmN0aW9uIEFSTlxuICAgKiBAcmV0dXJucyBRdWFsaWZpZWQgQVJOIG9mIHRoZSBmdW5jdGlvblxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHF1YWxpZmllZEFybjogc3RyaW5nO1xuICAvKiogRnVuY3Rpb24gSU5WT0tFX0FSTiAqL1xuICBwdWJsaWMgcmVhZG9ubHkgaW52b2tlQXJuOiBzdHJpbmc7XG4gIC8qKiBQZXJtaXNzaW9ucyAgKi9cbiAgcHVibGljIHBlcm1pc3Npb25zITogTGFtYmRhUGVybWlzc2lvbjtcblxuICAvKiogTmFtZSBvZiB0aGUgQVdTIExhbWJkYSBmdW5jdGlvbiBpbiB0aGUgYWNjb3VudC9yZWdpb24gKi9cbiAgcHVibGljIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICBwcml2YXRlIGFzc2V0UGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkOyAvLyBwb3NpeCBwYXRoXG4gIHByaXZhdGUgYnVuZGxlSGFzaDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBpbmZsaWdodDogY2xvdWQuSUZ1bmN0aW9uSGFuZGxlcixcbiAgICBwcm9wczogY2xvdWQuRnVuY3Rpb25Qcm9wcyA9IHt9XG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgaW5mbGlnaHQsIHByb3BzKTtcblxuICAgIGlmIChwcm9wcy5jb25jdXJyZW5jeSAhPSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcihcbiAgICAgICAgXCJGdW5jdGlvbiBjb25jdXJyZW5jeSBpc24ndCBpbXBsZW1lbnRlZCB5ZXQgb24gdGhlIGN1cnJlbnQgdGFyZ2V0LlwiXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSB1bmlxdWUgUzMgYnVja2V0IGZvciBob3N0aW5nIExhbWJkYSBjb2RlXG4gICAgY29uc3QgYXBwID0gQXBwLm9mKHRoaXMpIGFzIEFwcDtcbiAgICBjb25zdCBidWNrZXQgPSBhcHAuY29kZUJ1Y2tldDtcblxuICAgIC8vIENob29zZSBhbiBvYmplY3QgbmFtZSBzbyB0aGF0OlxuICAgIC8vIC0gd2hlbmV2ZXIgY29kZSBjaGFuZ2VzLCB0aGUgb2JqZWN0IG5hbWUgY2hhbmdlc1xuICAgIC8vIC0gZXZlbiBpZiB0d28gZnVuY3Rpb25zIGhhdmUgdGhlIHNhbWUgY29kZSwgdGhleSBnZXQgZGlmZmVyZW50IG5hbWVzXG4gICAgLy8gICAoc2VwYXJhdGlvbiBvZiBjb25jZXJucylcbiAgICBsZXQgYnVuZGxlSGFzaFRva2VuID0gTGF6eS5zdHJpbmdWYWx1ZSh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5idW5kbGVIYXNoKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYnVuZGxlSGFzaCB3YXMgbm90IHNldFwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5idW5kbGVIYXNoO1xuICAgICAgfSxcbiAgICB9KTtcbiAgICBjb25zdCBvYmplY3RLZXkgPSBgYXNzZXQuJHt0aGlzLm5vZGUuYWRkcn0uJHtidW5kbGVIYXNoVG9rZW59LnppcGA7XG5cbiAgICAvLyBVcGxvYWQgTGFtYmRhIHppcCBmaWxlIHRvIG5ld2x5IGNyZWF0ZWQgUzMgYnVja2V0XG4gICAgY29uc3QgbGFtYmRhQXJjaGl2ZSA9IG5ldyBTM09iamVjdCh0aGlzLCBcIlMzT2JqZWN0XCIsIHtcbiAgICAgIGJ1Y2tldDogYnVja2V0LmJ1Y2tldCxcbiAgICAgIGtleTogb2JqZWN0S2V5LFxuICAgICAgc291cmNlOiBMYXp5LnN0cmluZ1ZhbHVlKHtcbiAgICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICAgIGlmICghdGhpcy5hc3NldFBhdGgpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcImFzc2V0UGF0aCB3YXMgbm90IHNldFwiKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYXNzZXRQYXRoO1xuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgTGFtYmRhIHJvbGVcbiAgICB0aGlzLnJvbGUgPSBuZXcgSWFtUm9sZSh0aGlzLCBcIklhbVJvbGVcIiwge1xuICAgICAgYXNzdW1lUm9sZVBvbGljeTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBWZXJzaW9uOiBcIjIwMTItMTAtMTdcIixcbiAgICAgICAgU3RhdGVtZW50OiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgQWN0aW9uOiBcInN0czpBc3N1bWVSb2xlXCIsXG4gICAgICAgICAgICBQcmluY2lwYWw6IHtcbiAgICAgICAgICAgICAgU2VydmljZTogXCJsYW1iZGEuYW1hem9uYXdzLmNvbVwiLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIEVmZmVjdDogXCJBbGxvd1wiLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9KSxcbiAgICB9KTtcblxuICAgIC8vIEFkZCBwb2xpY3kgdG8gTGFtYmRhIHJvbGUgZm9yIGFueSBjdXN0b20gcG9saWN5IHN0YXRlbWVudHMsIHN1Y2ggYXNcbiAgICAvLyB0aG9zZSBuZWVkZWQgYnkgYm91bmQgcmVzb3VyY2VzXG4gICAgbmV3IElhbVJvbGVQb2xpY3kodGhpcywgXCJJYW1Sb2xlUG9saWN5XCIsIHtcbiAgICAgIHJvbGU6IHRoaXMucm9sZS5uYW1lLFxuICAgICAgcG9saWN5OiBMYXp5LnN0cmluZ1ZhbHVlKHtcbiAgICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICAgIHRoaXMucG9saWN5U3RhdGVtZW50cyA9IHRoaXMucG9saWN5U3RhdGVtZW50cyA/PyBbXTtcblxuICAgICAgICAgIGlmICh0aGlzLnBvbGljeVN0YXRlbWVudHMubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICBWZXJzaW9uOiBcIjIwMTItMTAtMTdcIixcbiAgICAgICAgICAgICAgU3RhdGVtZW50OiB0aGlzLnBvbGljeVN0YXRlbWVudHMsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBwb2xpY3kgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBzdGF0ZW1lbnQsIHNvIGluY2x1ZGUgYSBuby1vcCBzdGF0ZW1lbnRcbiAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgVmVyc2lvbjogXCIyMDEyLTEwLTE3XCIsXG4gICAgICAgICAgICBTdGF0ZW1lbnQ6IFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIEVmZmVjdDogXCJBbGxvd1wiLFxuICAgICAgICAgICAgICAgIEFjdGlvbjogXCJub25lOm51bGxcIixcbiAgICAgICAgICAgICAgICBSZXNvdXJjZTogXCIqXCIsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgfSk7XG5cbiAgICAvLyBBZGQgZXhlY3V0aW9uIHJvbGUgZm9yIGxhbWJkYSB0byB3cml0ZSB0byBDbG91ZFdhdGNoIGxvZ3NcbiAgICBuZXcgSWFtUm9sZVBvbGljeUF0dGFjaG1lbnQodGhpcywgXCJJYW1Sb2xlUG9saWN5QXR0YWNobWVudFwiLCB7XG4gICAgICBwb2xpY3lBcm46XG4gICAgICAgIFwiYXJuOmF3czppYW06OmF3czpwb2xpY3kvc2VydmljZS1yb2xlL0FXU0xhbWJkYUJhc2ljRXhlY3V0aW9uUm9sZVwiLFxuICAgICAgcm9sZTogdGhpcy5yb2xlLm5hbWUsXG4gICAgfSk7XG5cbiAgICB0aGlzLm5hbWUgPSBSZXNvdXJjZU5hbWVzLmdlbmVyYXRlTmFtZSh0aGlzLCBGVU5DVElPTl9OQU1FX09QVFMpO1xuXG4gICAgLy8gdmFsaWRhdGUgbWVtb3J5IHNpemVcbiAgICBpZiAocHJvcHMubWVtb3J5ICYmIChwcm9wcy5tZW1vcnkgPCAxMjggfHwgcHJvcHMubWVtb3J5ID4gMTAyNDApKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiTWVtb3J5IGZvciBBV1MgTGFtYmRhIGZ1bmN0aW9uIHNob3VsZCBiZSBpbiBiZXR3ZWVuIDEyOCBhbmQgMTAyNDBcIlxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoIXByb3BzLmxvZ1JldGVudGlvbkRheXMgfHwgcHJvcHMubG9nUmV0ZW50aW9uRGF5cyA+PSAwKSB7XG4gICAgICBuZXcgQ2xvdWR3YXRjaExvZ0dyb3VwKHRoaXMsIFwiQ2xvdWR3YXRjaExvZ0dyb3VwXCIsIHtcbiAgICAgICAgbmFtZTogYC9hd3MvbGFtYmRhLyR7dGhpcy5uYW1lfWAsXG4gICAgICAgIHJldGVudGlvbkluRGF5czogcHJvcHMubG9nUmV0ZW50aW9uRGF5cyA/PyAzMCxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBOZWdhdGl2ZSB2YWx1ZSBtZWFucyBJbmZpbml0ZSByZXRlbnRpb25cbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgTGFtYmRhIGZ1bmN0aW9uXG4gICAgdGhpcy5mdW5jdGlvbiA9IG5ldyBMYW1iZGFGdW5jdGlvbih0aGlzLCBcIkRlZmF1bHRcIiwge1xuICAgICAgZnVuY3Rpb25OYW1lOiB0aGlzLm5hbWUsXG4gICAgICBzM0J1Y2tldDogYnVja2V0LmJ1Y2tldCxcbiAgICAgIHMzS2V5OiBsYW1iZGFBcmNoaXZlLmtleSxcbiAgICAgIGhhbmRsZXI6IFwiaW5kZXguaGFuZGxlclwiLFxuICAgICAgcnVudGltZTogXCJub2RlanMyMC54XCIsXG4gICAgICByb2xlOiB0aGlzLnJvbGUuYXJuLFxuICAgICAgcHVibGlzaDogdHJ1ZSxcbiAgICAgIHZwY0NvbmZpZzoge1xuICAgICAgICBzdWJuZXRJZHM6IExhenkubGlzdFZhbHVlKHtcbiAgICAgICAgICBwcm9kdWNlOiAoKSA9PlxuICAgICAgICAgICAgdGhpcy5zdWJuZXRzID8gQXJyYXkuZnJvbSh0aGlzLnN1Ym5ldHMudmFsdWVzKCkpIDogW10sXG4gICAgICAgIH0pLFxuICAgICAgICBzZWN1cml0eUdyb3VwSWRzOiBMYXp5Lmxpc3RWYWx1ZSh7XG4gICAgICAgICAgcHJvZHVjZTogKCkgPT5cbiAgICAgICAgICAgIHRoaXMuc2VjdXJpdHlHcm91cHMgPyBBcnJheS5mcm9tKHRoaXMuc2VjdXJpdHlHcm91cHMudmFsdWVzKCkpIDogW10sXG4gICAgICAgIH0pLFxuICAgICAgfSxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIHZhcmlhYmxlczogTGF6eS5hbnlWYWx1ZSh7XG4gICAgICAgICAgcHJvZHVjZTogKCkgPT4gKHtcbiAgICAgICAgICAgIC4uLnRoaXMuZW52LFxuICAgICAgICAgICAgLy8gZW5hYmxlIHNvdXJjZSBtYXBzXG4gICAgICAgICAgICBOT0RFX09QVElPTlM6IFtcbiAgICAgICAgICAgICAgLi4uKHRoaXMuZW52Lk5PREVfT1BUSU9OUyA9PT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgPyBbXVxuICAgICAgICAgICAgICAgIDogdGhpcy5lbnYuTk9ERV9PUFRJT05TLnNwbGl0KFwiIFwiKSksXG4gICAgICAgICAgICAgIFwiLS1lbmFibGUtc291cmNlLW1hcHNcIixcbiAgICAgICAgICAgIF0uam9pbihcIiBcIiksXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pIGFzIGFueSxcbiAgICAgIH0sXG4gICAgICB0aW1lb3V0OiBwcm9wcy50aW1lb3V0XG4gICAgICAgID8gcHJvcHMudGltZW91dC5zZWNvbmRzXG4gICAgICAgIDogRHVyYXRpb24uZnJvbU1pbnV0ZXMoMSkuc2Vjb25kcyxcbiAgICAgIG1lbW9yeVNpemU6IHByb3BzLm1lbW9yeSA/PyBERUZBVUxUX01FTU9SWV9TSVpFLFxuICAgICAgYXJjaGl0ZWN0dXJlczogW1wiYXJtNjRcIl0sXG4gICAgfSk7XG5cbiAgICBpZiAoYXBwLnBhcmFtZXRlcnMudmFsdWUoXCJ0Zi1hd3MvdnBjX2xhbWJkYVwiKSA9PT0gdHJ1ZSkge1xuICAgICAgY29uc3Qgc2cgPSBuZXcgU2VjdXJpdHlHcm91cCh0aGlzLCBgJHtpZH1TZWN1cml0eUdyb3VwYCwge1xuICAgICAgICB2cGNJZDogYXBwLnZwYy5pZCxcbiAgICAgICAgZWdyZXNzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgY2lkckJsb2NrczogW1wiMC4wLjAuMC8wXCJdLFxuICAgICAgICAgICAgZnJvbVBvcnQ6IDAsXG4gICAgICAgICAgICB0b1BvcnQ6IDAsXG4gICAgICAgICAgICBwcm90b2NvbDogXCItMVwiLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9KTtcbiAgICAgIHRoaXMuYWRkTmV0d29yayh7XG4gICAgICAgIHN1Ym5ldElkczogWy4uLmFwcC5zdWJuZXRzLnByaXZhdGUubWFwKChzKSA9PiBzLmlkKV0sXG4gICAgICAgIHNlY3VyaXR5R3JvdXBJZHM6IFtzZy5pZF0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLnF1YWxpZmllZEFybiA9IHRoaXMuZnVuY3Rpb24ucXVhbGlmaWVkQXJuO1xuICAgIHRoaXMuaW52b2tlQXJuID0gdGhpcy5mdW5jdGlvbi5pbnZva2VBcm47XG5cbiAgICAvLyB0ZXJyYWZvcm0gcmVqZWN0cyB0ZW1wbGF0ZXMgd2l0aCB6ZXJvIGVudmlyb25tZW50IHZhcmlhYmxlc1xuICAgIHRoaXMuYWRkRW52aXJvbm1lbnQoXCJXSU5HX0ZVTkNUSU9OX05BTUVcIiwgdGhpcy5uYW1lKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIF9wcmVTeW50aGVzaXplKCk6IHZvaWQge1xuICAgIHN1cGVyLl9wcmVTeW50aGVzaXplKCk7XG5cbiAgICAvLyB3cml0ZSB0aGUgZW50cnlwb2ludCBuZXh0IHRvIHRoZSBwYXJ0aWFsIGluZmxpZ2h0IGNvZGUgZW1pdHRlZCBieSB0aGUgY29tcGlsZXIsIHNvIHRoYXRcbiAgICAvLyBgcmVxdWlyZWAgcmVzb2x2ZXMgbmF0dXJhbGx5LlxuXG4gICAgY29uc3QgYnVuZGxlID0gY3JlYXRlQnVuZGxlKHRoaXMuZW50cnlwb2ludCwgZXh0ZXJuYWxMaWJyYXJpZXMpO1xuXG4gICAgLy8gd291bGQgcHJlZmVyIHRvIGNyZWF0ZSBUZXJyYWZvcm1Bc3NldCBpbiB0aGUgY29uc3RydWN0b3IsIGJ1dCB1c2luZyBhIENES1RGIHRva2VuIGZvclxuICAgIC8vIHRoZSBcInBhdGhcIiBhcmd1bWVudCBpc24ndCBzdXBwb3J0ZWRcbiAgICBjb25zdCBhc3NldCA9IG5ldyBUZXJyYWZvcm1Bc3NldCh0aGlzLCBcIkFzc2V0XCIsIHtcbiAgICAgIHBhdGg6IGJ1bmRsZS5kaXJlY3RvcnksXG4gICAgICB0eXBlOiBBc3NldFR5cGUuQVJDSElWRSxcbiAgICB9KTtcblxuICAgIHRoaXMuYnVuZGxlSGFzaCA9IGJ1bmRsZS5oYXNoO1xuICAgIHRoaXMuYXNzZXRQYXRoID0gYXNzZXQucGF0aDtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIGdldCBfbGlmdE1hcCgpOiBjb3JlLkxpZnRNYXAge1xuICAgIHJldHVybiB7XG4gICAgICBbY2xvdWQuRnVuY3Rpb25JbmZsaWdodE1ldGhvZHMuSU5WT0tFXTogW1t0aGlzLmhhbmRsZXIsIFtcImhhbmRsZVwiXV1dLFxuICAgICAgW2Nsb3VkLkZ1bmN0aW9uSW5mbGlnaHRNZXRob2RzLklOVk9LRV9BU1lOQ106IFtcbiAgICAgICAgW3RoaXMuaGFuZGxlciwgW1wiaGFuZGxlXCJdXSxcbiAgICAgIF0sXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBvbkxpZnQoaG9zdDogSUluZmxpZ2h0SG9zdCwgb3BzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIGlmICghQXdzSW5mbGlnaHRIb3N0LmlzQXdzSW5mbGlnaHRIb3N0KGhvc3QpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJIb3N0IGlzIGV4cGVjdGVkIHRvIGltcGxlbWVudCBgSUF3c0luZmlnaHRIb3N0YFwiKTtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICBvcHMuaW5jbHVkZXMoY2xvdWQuRnVuY3Rpb25JbmZsaWdodE1ldGhvZHMuSU5WT0tFKSB8fFxuICAgICAgb3BzLmluY2x1ZGVzKGNsb3VkLkZ1bmN0aW9uSW5mbGlnaHRNZXRob2RzLklOVk9LRV9BU1lOQylcbiAgICApIHtcbiAgICAgIGhvc3QuYWRkUG9saWN5U3RhdGVtZW50cyh7XG4gICAgICAgIGFjdGlvbnM6IFtcImxhbWJkYTpJbnZva2VGdW5jdGlvblwiXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbYCR7dGhpcy5mdW5jdGlvbi5hcm59YF0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBUaGUgZnVuY3Rpb24gbmFtZSBuZWVkcyB0byBiZSBwYXNzZWQgdGhyb3VnaCBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSBzaW5jZVxuICAgIC8vIGl0IG1heSBub3QgYmUgcmVzb2x2ZWQgdW50aWwgZGVwbG95bWVudCB0aW1lLlxuICAgIGhvc3QuYWRkRW52aXJvbm1lbnQodGhpcy5lbnZOYW1lKCksIHRoaXMuZnVuY3Rpb24uYXJuKTtcblxuICAgIHN1cGVyLm9uTGlmdChob3N0LCBvcHMpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3RvSW5mbGlnaHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY29yZS5JbmZsaWdodENsaWVudC5mb3IoXG4gICAgICBfX2Rpcm5hbWUucmVwbGFjZShcInRhcmdldC10Zi1hd3NcIiwgXCJzaGFyZWQtYXdzXCIpLFxuICAgICAgX19maWxlbmFtZSxcbiAgICAgIFwiRnVuY3Rpb25DbGllbnRcIixcbiAgICAgIFtgcHJvY2Vzcy5lbnZbXCIke3RoaXMuZW52TmFtZSgpfVwiXSwgXCIke3RoaXMubm9kZS5wYXRofVwiYF1cbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBWUEMgY29uZmlndXJhdGlvbnMgdG8gbGFtYmRhIGZ1bmN0aW9uXG4gICAqL1xuICBwdWJsaWMgYWRkTmV0d29yayh2cGNDb25maWc6IE5ldHdvcmtDb25maWcpIHtcbiAgICBpZiAoIXRoaXMuc3VibmV0cyB8fCAhdGhpcy5zZWN1cml0eUdyb3Vwcykge1xuICAgICAgdGhpcy5zdWJuZXRzID0gbmV3IFNldCgpO1xuICAgICAgdGhpcy5zZWN1cml0eUdyb3VwcyA9IG5ldyBTZXQoKTtcbiAgICB9XG4gICAgdnBjQ29uZmlnLnN1Ym5ldElkcy5mb3JFYWNoKChzdWJuZXQpID0+IHRoaXMuc3VibmV0cyEuYWRkKHN1Ym5ldCkpO1xuICAgIHZwY0NvbmZpZy5zZWN1cml0eUdyb3VwSWRzLmZvckVhY2goKHNnKSA9PiB0aGlzLnNlY3VyaXR5R3JvdXBzIS5hZGQoc2cpKTtcblxuICAgIGlmICghdGhpcy52cGNQZXJtaXNzaW9uc0FkZGVkKSB7XG4gICAgICB0aGlzLmFkZFBvbGljeVN0YXRlbWVudHMoe1xuICAgICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgIFwiZWMyOkNyZWF0ZU5ldHdvcmtJbnRlcmZhY2VcIixcbiAgICAgICAgICBcImVjMjpEZXNjcmliZU5ldHdvcmtJbnRlcmZhY2VzXCIsXG4gICAgICAgICAgXCJlYzI6RGVsZXRlTmV0d29ya0ludGVyZmFjZVwiLFxuICAgICAgICAgIFwiZWMyOkRlc2NyaWJlU3VibmV0c1wiLFxuICAgICAgICAgIFwiZWMyOkRlc2NyaWJlU2VjdXJpdHlHcm91cHNcIixcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMudnBjUGVybWlzc2lvbnNBZGRlZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIHBvbGljeSBzdGF0ZW1lbnQgdG8gdGhlIExhbWJkYSByb2xlLlxuICAgKi9cbiAgcHVibGljIGFkZFBvbGljeVN0YXRlbWVudHMoLi4uc3RhdGVtZW50czogUG9saWN5U3RhdGVtZW50W10pIHtcbiAgICAvLyB3ZSBkbyBsYXp5IGluaXRpYWxpemF0aW9uIGhlcmUgYmVjYXVzZSBhZGRQb2xpY3lTdGF0ZW1lbnRzKCkgbWlnaHQgYmUgY2FsbGVkIHRocm91Z2ggdGhlXG4gICAgLy8gY29uc3RydWN0b3IgY2hhaW4gb2YgdGhlIEZ1bmN0aW9uIGJhc2UgY2xhc3Mgd2hpY2ggbWVhbnMgdGhhdCBvdXIgY29uc3RydWN0b3IgbWlnaHQgbm90IGhhdmVcbiAgICAvLyBiZWVuIGNhbGxlZCB5ZXQuLi4geWVzLCB1Z2x5LlxuICAgIGlmICghdGhpcy5wb2xpY3lTdGF0ZW1lbnRzKSB7XG4gICAgICB0aGlzLnBvbGljeVN0YXRlbWVudHMgPSBbXTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHN0YXRlbWVudCBvZiBzdGF0ZW1lbnRzKSB7XG4gICAgICB0aGlzLnBvbGljeVN0YXRlbWVudHMucHVzaCh7XG4gICAgICAgIEFjdGlvbjogc3RhdGVtZW50LmFjdGlvbnMsXG4gICAgICAgIFJlc291cmNlOiBzdGF0ZW1lbnQucmVzb3VyY2VzLFxuICAgICAgICBFZmZlY3Q6IHN0YXRlbWVudC5lZmZlY3QgPz8gXCJBbGxvd1wiLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdyYW50cyB0aGUgZ2l2ZW4gaWRlbnRpdHkgcGVybWlzc2lvbnMgdG8gaW52b2tlIHRoaXMgZnVuY3Rpb24uXG4gICAqIEBwYXJhbSBwcmluY2lwYWwgVGhlIEFXUyBwcmluY2lwYWwgdG8gZ3JhbnQgaW52b2tlIHBlcm1pc3Npb25zIHRvIChlLmcuIFwiczMuYW1hem9uYXdzLmNvbVwiLCBcImV2ZW50cy5hbWF6b25hd3MuY29tXCIsIFwic25zLmFtYXpvbmF3cy5jb21cIilcbiAgICovXG4gIHB1YmxpYyBhZGRQZXJtaXNzaW9uVG9JbnZva2UoXG4gICAgc291cmNlOiBSZXNvdXJjZSxcbiAgICBwcmluY2lwYWw6IHN0cmluZyxcbiAgICBzb3VyY2VBcm46IHN0cmluZyxcbiAgICBvcHRpb25zOiBGdW5jdGlvblBlcm1pc3Npb25zT3B0aW9ucyA9IHsgcXVhbGlmaWVyOiB0aGlzLmZ1bmN0aW9uLnZlcnNpb24gfVxuICApOiB2b2lkIHtcbiAgICB0aGlzLnBlcm1pc3Npb25zID0gbmV3IExhbWJkYVBlcm1pc3Npb24oXG4gICAgICB0aGlzLFxuICAgICAgYEludm9rZVBlcm1pc3Npb24tJHtzb3VyY2Uubm9kZS5hZGRyfWAsXG4gICAgICB7XG4gICAgICAgIGZ1bmN0aW9uTmFtZTogdGhpcy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIGFjdGlvbjogXCJsYW1iZGE6SW52b2tlRnVuY3Rpb25cIixcbiAgICAgICAgcHJpbmNpcGFsOiBwcmluY2lwYWwsXG4gICAgICAgIHNvdXJjZUFybjogc291cmNlQXJuLFxuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGVudk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYEZVTkNUSU9OX05BTUVfJHt0aGlzLm5vZGUuYWRkci5zbGljZSgtOCl9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBVbnF1YWxpZmllZCBGdW5jdGlvbiBBUk5cbiAgICogQHJldHVybnMgVW5xdWFsaWZpZWQgQVJOIG9mIHRoZSBmdW5jdGlvblxuICAgKi9cbiAgcHVibGljIGdldCBmdW5jdGlvbkFybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmZ1bmN0aW9uLmFybjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZnVuY3Rpb25OYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuZnVuY3Rpb24uZnVuY3Rpb25OYW1lO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHJvdGVjdGVkIF9nZXRDb2RlTGluZXMoaGFuZGxlcjogY2xvdWQuSUZ1bmN0aW9uSGFuZGxlcik6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gbWFrZUF3c0xhbWJkYUhhbmRsZXIoaGFuZGxlcik7XG4gIH1cbn1cbiJdfQ==