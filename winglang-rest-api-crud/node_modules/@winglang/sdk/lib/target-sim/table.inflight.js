"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Table = void 0;
const table_utils_1 = require("../shared/table-utils");
const simulator_1 = require("../simulator/simulator");
class Table {
    constructor(props) {
        this.name = props.name;
        this.columns = props.columns;
        this.primaryKey = props.primaryKey;
        this.table = new Map();
        this.initialRows = props.initialRows ?? {};
    }
    get context() {
        if (!this._context) {
            throw new Error("Cannot access context during class construction");
        }
        return this._context;
    }
    async init(context) {
        this._context = context;
        for (const [key, row] of Object.entries(this.initialRows)) {
            await this.context.withTrace({
                message: `Adding initial row (key=${key}).`,
                activity: async () => {
                    return this.table.set(key, row);
                },
            });
        }
        return {};
    }
    async cleanup() { }
    async save() { }
    async plan() {
        return simulator_1.UpdatePlan.AUTO;
    }
    async insert(key, row) {
        (0, table_utils_1.validateRow)(row, this.columns);
        const anyRow = row;
        return this.context.withTrace({
            message: `insert row ${key} into the table ${this.name}.`,
            activity: async () => {
                if (await this.tryGet(key)) {
                    throw new Error(`The primary key "${key}" already exists in the "${this.name}" table.`);
                }
                let item = {};
                item[this.primaryKey] = key;
                for (const column of Object.keys(this.columns)) {
                    item[column] = anyRow[column];
                }
                this.table.set(key, item);
            },
        });
    }
    async upsert(key, row) {
        (0, table_utils_1.validateRow)(row, this.columns);
        const anyRow = row;
        return this.context.withTrace({
            message: `upsert row ${key} into the table ${this.name}.`,
            activity: async () => {
                let item = {};
                item[this.primaryKey] = key;
                for (const column of Object.keys(this.columns)) {
                    item[column] = anyRow[column];
                }
                this.table.set(key, item);
            },
        });
    }
    async update(key, row) {
        (0, table_utils_1.validateRow)(row, this.columns);
        const anyRow = row;
        return this.context.withTrace({
            message: `update row ${key} in table ${this.name}.`,
            activity: async () => {
                try {
                    let item = await this.get(key);
                    for (const column of Object.keys(this.columns)) {
                        if (anyRow[column]) {
                            item[column] = anyRow[column];
                        }
                    }
                    this.table.set(key, item);
                }
                catch {
                    throw new Error(`The primary key "${key}" was not found in the "${this.name}" table.`);
                }
            },
        });
    }
    async delete(key) {
        return this.context.withTrace({
            message: `remove row ${key} from table ${this.name}.`,
            activity: async () => {
                if (!this.table.delete(key)) {
                    throw new Error(`The primary key "${key}" not found in the "${this.name}" table.`);
                }
            },
        });
    }
    async get(key) {
        return this.context.withTrace({
            message: `get row ${key} from table ${this.name}.`,
            activity: async () => {
                let item = this.table.get(key);
                if (item) {
                    return item;
                }
                throw new Error(`Row does not exist (key=${key})`);
            },
        });
    }
    async tryGet(key) {
        if (this.table.has(key)) {
            return this.get(key);
        }
        return undefined;
    }
    async list() {
        return this.context.withTrace({
            message: `list all rows from table ${this.name}.`,
            activity: async () => {
                return Array.from(this.table.values());
            },
        });
    }
}
exports.Table = Table;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuaW5mbGlnaHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXNpbS90YWJsZS5pbmZsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSx1REFBb0Q7QUFDcEQsc0RBSWdDO0FBR2hDLE1BQWEsS0FBSztJQVFoQixZQUFtQixLQUFrQjtRQUNuQyxJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQztRQUNuQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksR0FBRyxFQUFlLENBQUM7UUFDcEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztJQUM3QyxDQUFDO0lBRUQsSUFBWSxPQUFPO1FBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxpREFBaUQsQ0FBQyxDQUFDO1FBQ3JFLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBMEI7UUFDMUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUM7WUFDMUQsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztnQkFDM0IsT0FBTyxFQUFFLDJCQUEyQixHQUFHLElBQUk7Z0JBQzNDLFFBQVEsRUFBRSxLQUFLLElBQUksRUFBRTtvQkFDbkIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdB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LFdBQVcsR0FBRyxlQUFlLElBQUksQ0FBQyxJQUFJLEdBQUc7WUFDbEQsUUFBUSxFQUFFLEtBQUssSUFBSSxFQUFFO2dCQUNuQixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDL0IsSUFBSSxJQUFJLEVBQUUsQ0FBQztvQkFDVCxPQUFPLElBQUksQ0FBQztnQkFDZCxDQUFDO2dCQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDckQsQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQVc7UUFDN0IsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3hCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2QixDQUFDO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJO1FBQ2YsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztZQUM1QixPQUFPLEVBQUUsNEJBQTRCLElBQUksQ0FBQyxJQUFJLEdBQUc7WUFDakQsUUFBUSxFQUFFLEtBQUssSUFBSSxFQUFFO2dCQUNuQixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQ3pDLENBQUM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUE5SUQsc0JBOElDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGFibGVBdHRyaWJ1dGVzLCBUYWJsZVNjaGVtYSB9IGZyb20gXCIuL3NjaGVtYS1yZXNvdXJjZXNcIjtcbmltcG9ydCB7IENvbHVtblR5cGUsIElUYWJsZUNsaWVudCB9IGZyb20gXCIuLi9leFwiO1xuaW1wb3J0IHsgdmFsaWRhdGVSb3cgfSBmcm9tIFwiLi4vc2hhcmVkL3RhYmxlLXV0aWxzXCI7XG5pbXBvcnQge1xuICBJU2ltdWxhdG9yQ29udGV4dCxcbiAgSVNpbXVsYXRvclJlc291cmNlSW5zdGFuY2UsXG4gIFVwZGF0ZVBsYW4sXG59IGZyb20gXCIuLi9zaW11bGF0b3Ivc2ltdWxhdG9yXCI7XG5pbXBvcnQgeyBKc29uIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG5leHBvcnQgY2xhc3MgVGFibGUgaW1wbGVtZW50cyBJVGFibGVDbGllbnQsIElTaW11bGF0b3JSZXNvdXJjZUluc3RhbmNlIHtcbiAgcHJpdmF0ZSBuYW1lOiBzdHJpbmc7XG4gIHByaXZhdGUgY29sdW1uczogeyBba2V5OiBzdHJpbmddOiBDb2x1bW5UeXBlIH07XG4gIHByaXZhdGUgcHJpbWFyeUtleTogc3RyaW5nO1xuICBwcml2YXRlIHRhYmxlOiBNYXA8c3RyaW5nLCBhbnk+O1xuICBwcml2YXRlIF9jb250ZXh0OiBJU2ltdWxhdG9yQ29udGV4dCB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSByZWFkb25seSBpbml0aWFsUm93czogUmVjb3JkPHN0cmluZywgSnNvbj47XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKHByb3BzOiBUYWJsZVNjaGVtYSkge1xuICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWU7XG4gICAgdGhpcy5jb2x1bW5zID0gcHJvcHMuY29sdW1ucztcbiAgICB0aGlzLnByaW1hcnlLZXkgPSBwcm9wcy5wcmltYXJ5S2V5O1xuICAgIHRoaXMudGFibGUgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xuICAgIHRoaXMuaW5pdGlhbFJvd3MgPSBwcm9wcy5pbml0aWFsUm93cyA/PyB7fTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGNvbnRleHQoKTogSVNpbXVsYXRvckNvbnRleHQge1xuICAgIGlmICghdGhpcy5fY29udGV4dCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGFjY2VzcyBjb250ZXh0IGR1cmluZyBjbGFzcyBjb25zdHJ1Y3Rpb25cIik7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9jb250ZXh0O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGluaXQoY29udGV4dDogSVNpbXVsYXRvckNvbnRleHQpOiBQcm9taXNlPFRhYmxlQXR0cmlidXRlcz4ge1xuICAgIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0O1xuICAgIGZvciAoY29uc3QgW2tleSwgcm93XSBvZiBPYmplY3QuZW50cmllcyh0aGlzLmluaXRpYWxSb3dzKSkge1xuICAgICAgYXdhaXQgdGhpcy5jb250ZXh0LndpdGhUcmFjZSh7XG4gICAgICAgIG1lc3NhZ2U6IGBBZGRpbmcgaW5pdGlhbCByb3cgKGtleT0ke2tleX0pLmAsXG4gICAgICAgIGFjdGl2aXR5OiBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMudGFibGUuc2V0KGtleSwgcm93KTtcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4ge307XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY2xlYW51cCgpOiBQcm9taXNlPHZvaWQ+IHt9XG5cbiAgcHVibGljIGFzeW5jIHNhdmUoKTogUHJvbWlzZTx2b2lkPiB7fVxuXG4gIHB1YmxpYyBhc3luYyBwbGFuKCkge1xuICAgIHJldHVybiBVcGRhdGVQbGFuLkFVVE87XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5zZXJ0KGtleTogc3RyaW5nLCByb3c6IEpzb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB2YWxpZGF0ZVJvdyhyb3csIHRoaXMuY29sdW1ucyk7XG4gICAgY29uc3QgYW55Um93ID0gcm93IGFzIGFueTtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0LndpdGhUcmFjZSh7XG4gICAgICBtZXNzYWdlOiBgaW5zZXJ0IHJvdyAke2tleX0gaW50byB0aGUgdGFibGUgJHt0aGlzLm5hbWV9LmAsXG4gICAgICBhY3Rpdml0eTogYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAoYXdhaXQgdGhpcy50cnlHZXQoa2V5KSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBUaGUgcHJpbWFyeSBrZXkgXCIke2tleX1cIiBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgXCIke3RoaXMubmFtZX1cIiB0YWJsZS5gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgaXRlbTogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xuICAgICAgICBpdGVtW3RoaXMucHJpbWFyeUtleV0gPSBrZXk7XG4gICAgICAgIGZvciAoY29uc3QgY29sdW1uIG9mIE9iamVjdC5rZXlzKHRoaXMuY29sdW1ucykpIHtcbiAgICAgICAgICBpdGVtW2NvbHVtbl0gPSBhbnlSb3dbY29sdW1uXTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRhYmxlLnNldChrZXksIGl0ZW0pO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgYXN5bmMgdXBzZXJ0KGtleTogc3RyaW5nLCByb3c6IEpzb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB2YWxpZGF0ZVJvdyhyb3csIHRoaXMuY29sdW1ucyk7XG4gICAgY29uc3QgYW55Um93ID0gcm93IGFzIGFueTtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0LndpdGhUcmFjZSh7XG4gICAgICBtZXNzYWdlOiBgdXBzZXJ0IHJvdyAke2tleX0gaW50byB0aGUgdGFibGUgJHt0aGlzLm5hbWV9LmAsXG4gICAgICBhY3Rpdml0eTogYXN5bmMgKCkgPT4ge1xuICAgICAgICBsZXQgaXRlbTogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xuICAgICAgICBpdGVtW3RoaXMucHJpbWFyeUtleV0gPSBrZXk7XG4gICAgICAgIGZvciAoY29uc3QgY29sdW1uIG9mIE9iamVjdC5rZXlzKHRoaXMuY29sdW1ucykpIHtcbiAgICAgICAgICBpdGVtW2NvbHVtbl0gPSBhbnlSb3dbY29sdW1uXTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnRhYmxlLnNldChrZXksIGl0ZW0pO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKGtleTogc3RyaW5nLCByb3c6IEpzb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB2YWxpZGF0ZVJvdyhyb3csIHRoaXMuY29sdW1ucyk7XG4gICAgY29uc3QgYW55Um93ID0gcm93IGFzIGFueTtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0LndpdGhUcmFjZSh7XG4gICAgICBtZXNzYWdlOiBgdXBkYXRlIHJvdyAke2tleX0gaW4gdGFibGUgJHt0aGlzLm5hbWV9LmAsXG4gICAgICBhY3Rpdml0eTogYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGxldCBpdGVtOiBhbnkgPSBhd2FpdCB0aGlzLmdldChrZXkpO1xuXG4gICAgICAgICAgZm9yIChjb25zdCBjb2x1bW4gb2YgT2JqZWN0LmtleXModGhpcy5jb2x1bW5zKSkge1xuICAgICAgICAgICAgaWYgKGFueVJvd1tjb2x1bW5dKSB7XG4gICAgICAgICAgICAgIGl0ZW1bY29sdW1uXSA9IGFueVJvd1tjb2x1bW5dO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnRhYmxlLnNldChrZXksIGl0ZW0pO1xuICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgVGhlIHByaW1hcnkga2V5IFwiJHtrZXl9XCIgd2FzIG5vdCBmb3VuZCBpbiB0aGUgXCIke3RoaXMubmFtZX1cIiB0YWJsZS5gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuICBwdWJsaWMgYXN5bmMgZGVsZXRlKGtleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgbWVzc2FnZTogYHJlbW92ZSByb3cgJHtrZXl9IGZyb20gdGFibGUgJHt0aGlzLm5hbWV9LmAsXG4gICAgICBhY3Rpdml0eTogYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMudGFibGUuZGVsZXRlKGtleSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgVGhlIHByaW1hcnkga2V5IFwiJHtrZXl9XCIgbm90IGZvdW5kIGluIHRoZSBcIiR7dGhpcy5uYW1lfVwiIHRhYmxlLmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG4gIHB1YmxpYyBhc3luYyBnZXQoa2V5OiBzdHJpbmcpOiBQcm9taXNlPEpzb24+IHtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0LndpdGhUcmFjZSh7XG4gICAgICBtZXNzYWdlOiBgZ2V0IHJvdyAke2tleX0gZnJvbSB0YWJsZSAke3RoaXMubmFtZX0uYCxcbiAgICAgIGFjdGl2aXR5OiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCBpdGVtID0gdGhpcy50YWJsZS5nZXQoa2V5KTtcbiAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJvdyBkb2VzIG5vdCBleGlzdCAoa2V5PSR7a2V5fSlgKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdHJ5R2V0KGtleTogc3RyaW5nKTogUHJvbWlzZTxKc29uIHwgdW5kZWZpbmVkPiB7XG4gICAgaWYgKHRoaXMudGFibGUuaGFzKGtleSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldChrZXkpO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxpc3QoKTogUHJvbWlzZTxBcnJheTxKc29uPj4ge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHQud2l0aFRyYWNlKHtcbiAgICAgIG1lc3NhZ2U6IGBsaXN0IGFsbCByb3dzIGZyb20gdGFibGUgJHt0aGlzLm5hbWV9LmAsXG4gICAgICBhY3Rpdml0eTogYXN5bmMgKCkgPT4ge1xuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLnRhYmxlLnZhbHVlcygpKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==