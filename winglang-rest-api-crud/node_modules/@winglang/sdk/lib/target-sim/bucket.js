"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BucketEventHandler = exports.Bucket = void 0;
const policy_1 = require("./policy");
const tokens_1 = require("./tokens");
const util_1 = require("./util");
const cloud = __importStar(require("../cloud"));
const core_1 = require("../core");
/**
 * Simulator implementation of `cloud.Bucket`.
 *
 * @inflight `@winglang/sdk.cloud.IBucketClient`
 */
class Bucket extends cloud.Bucket {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        this.initialObjects = {};
        this.public = props.public ?? false;
        this.policy = new policy_1.Policy(this, "Policy", { principal: this });
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud.BucketInflightMethods.DELETE]: [],
            [cloud.BucketInflightMethods.GET]: [],
            [cloud.BucketInflightMethods.GET_JSON]: [],
            [cloud.BucketInflightMethods.LIST]: [],
            [cloud.BucketInflightMethods.PUT]: [],
            [cloud.BucketInflightMethods.PUT_JSON]: [],
            [cloud.BucketInflightMethods.PUBLIC_URL]: [],
            [cloud.BucketInflightMethods.EXISTS]: [],
            [cloud.BucketInflightMethods.TRY_GET]: [],
            [cloud.BucketInflightMethods.TRY_GET_JSON]: [],
            [cloud.BucketInflightMethods.TRY_DELETE]: [],
            [cloud.BucketInflightMethods.METADATA]: [],
            [cloud.BucketInflightMethods.COPY]: [],
            [cloud.BucketInflightMethods.RENAME]: [],
        };
    }
    /**
     * Iterates over the topics and supply their sim handler
     * @returns an object of Bucket event types (keys) and their topic handlers (values)
     */
    convertTopicsToHandles() {
        const topicMap = {};
        this._topics.forEach((value, key) => {
            topicMap[key] = (0, tokens_1.simulatorHandleToken)(value);
        });
        return topicMap;
    }
    addObject(key, body) {
        this.initialObjects[key] = body;
    }
    createTopicHandler(eventType, inflight) {
        return BucketEventHandler.toTopicOnMessageHandler(inflight, eventType);
    }
    onCreate(fn, opts) {
        super.onCreate(fn, opts);
        const topic = this.getTopic(cloud.BucketEventType.CREATE);
        this.policy.addStatement(topic, cloud.TopicInflightMethods.PUBLISH);
    }
    onDelete(fn, opts) {
        super.onDelete(fn, opts);
        const topic = this.getTopic(cloud.BucketEventType.DELETE);
        this.policy.addStatement(topic, cloud.TopicInflightMethods.PUBLISH);
    }
    onUpdate(fn, opts) {
        super.onUpdate(fn, opts);
        const topic = this.getTopic(cloud.BucketEventType.UPDATE);
        this.policy.addStatement(topic, cloud.TopicInflightMethods.PUBLISH);
    }
    onEvent(fn, opts) {
        super.onEvent(fn, opts);
        const createTopic = this.getTopic(cloud.BucketEventType.CREATE);
        this.policy.addStatement(createTopic, cloud.TopicInflightMethods.PUBLISH);
        const deleteTopic = this.getTopic(cloud.BucketEventType.DELETE);
        this.policy.addStatement(deleteTopic, cloud.TopicInflightMethods.PUBLISH);
        const updateTopic = this.getTopic(cloud.BucketEventType.UPDATE);
        this.policy.addStatement(updateTopic, cloud.TopicInflightMethods.PUBLISH);
    }
    toSimulator() {
        const props = {
            public: this.public,
            initialObjects: this.initialObjects,
            topics: this.convertTopicsToHandles(),
        };
        return {
            type: cloud.BUCKET_FQN,
            props,
        };
    }
    onLift(host, ops) {
        (0, util_1.bindSimulatorResource)(__filename, this, host, ops);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return (0, util_1.makeSimulatorJsClient)(__filename, this);
    }
}
exports.Bucket = Bucket;
/**
 * Utility class to work with bucket event handlers.
 */
class BucketEventHandler {
    /**
     * Converts a `cloud.IBucketEventHandler` to a `cloud.ITopicOnMessageHandler`.
     * @param handler the handler to convert
     * @param eventType the event type
     * @returns the on message handler.
     */
    static toTopicOnMessageHandler(handler, eventType) {
        return (0, core_1.lift)({ handler, eventType }).inflight(async (ctx, event) => {
            return ctx.handler(event, ctx.eventType);
        });
    }
}
exports.BucketEventHandler = BucketEventHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC1zaW0vYnVja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EscUNBQWtDO0FBR2xDLHFDQUFnRDtBQUNoRCxpQ0FBc0U7QUFDdEUsZ0RBQWtDO0FBQ2xDLGtDQUF3QztBQUl4Qzs7OztHQUlHO0FBQ0gsTUFBYSxNQUFPLFNBQVEsS0FBSyxDQUFDLE1BQU07SUFLdEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxRQUEyQixFQUFFO1FBQ3JFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBSlQsbUJBQWMsR0FBMkIsRUFBRSxDQUFDO1FBTTNELElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sSUFBSSxLQUFLLENBQUM7UUFDcEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVELGdCQUFnQjtJQUNoQixJQUFXLFFBQVE7UUFDakIsT0FBTztZQUNMLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUU7WUFDeEMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRTtZQUNyQyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFO1lBQzFDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDdEMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRTtZQUNyQyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFO1lBQzFD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QUFDSCxNQUFhLGtCQUFrQjtJQUM3Qjs7Ozs7T0FLRztJQUNJLE1BQU0sQ0FBQyx1QkFBdUIsQ0FDbkMsT0FBa0MsRUFDbEMsU0FBZ0M7UUFFaEMsT0FBTyxJQUFBLFdBQUksRUFBQyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ2hFLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBZkQsZ0RBZUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgUG9saWN5IH0gZnJvbSBcIi4vcG9saWN5XCI7XG5pbXBvcnQgeyBJU2ltdWxhdG9yUmVzb3VyY2UgfSBmcm9tIFwiLi9yZXNvdXJjZVwiO1xuaW1wb3J0IHsgQnVja2V0U2NoZW1hIH0gZnJvbSBcIi4vc2NoZW1hLXJlc291cmNlc1wiO1xuaW1wb3J0IHsgc2ltdWxhdG9ySGFuZGxlVG9rZW4gfSBmcm9tIFwiLi90b2tlbnNcIjtcbmltcG9ydCB7IGJpbmRTaW11bGF0b3JSZXNvdXJjZSwgbWFrZVNpbXVsYXRvckpzQ2xpZW50IH0gZnJvbSBcIi4vdXRpbFwiO1xuaW1wb3J0ICogYXMgY2xvdWQgZnJvbSBcIi4uL2Nsb3VkXCI7XG5pbXBvcnQgeyBMaWZ0TWFwLCBsaWZ0IH0gZnJvbSBcIi4uL2NvcmVcIjtcbmltcG9ydCB7IFRvU2ltdWxhdG9yT3V0cHV0IH0gZnJvbSBcIi4uL3NpbXVsYXRvci9zaW11bGF0b3JcIjtcbmltcG9ydCB7IElJbmZsaWdodEhvc3QgfSBmcm9tIFwiLi4vc3RkXCI7XG5cbi8qKlxuICogU2ltdWxhdG9yIGltcGxlbWVudGF0aW9uIG9mIGBjbG91ZC5CdWNrZXRgLlxuICpcbiAqIEBpbmZsaWdodCBgQHdpbmdsYW5nL3Nkay5jbG91ZC5JQnVja2V0Q2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgQnVja2V0IGV4dGVuZHMgY2xvdWQuQnVja2V0IGltcGxlbWVudHMgSVNpbXVsYXRvclJlc291cmNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBwdWJsaWM6IGJvb2xlYW47XG4gIHByaXZhdGUgcmVhZG9ubHkgaW5pdGlhbE9iamVjdHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgcHJpdmF0ZSByZWFkb25seSBwb2xpY3k6IFBvbGljeTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogY2xvdWQuQnVja2V0UHJvcHMgPSB7fSkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgdGhpcy5wdWJsaWMgPSBwcm9wcy5wdWJsaWMgPz8gZmFsc2U7XG4gICAgdGhpcy5wb2xpY3kgPSBuZXcgUG9saWN5KHRoaXMsIFwiUG9saWN5XCIsIHsgcHJpbmNpcGFsOiB0aGlzIH0pO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgZ2V0IF9saWZ0TWFwKCk6IExpZnRNYXAge1xuICAgIHJldHVybiB7XG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkRFTEVURV06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5HRVRdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuR0VUX0pTT05dOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuTElTVF06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5QVVRdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuUFVUX0pTT05dOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuUFVCTElDX1VSTF06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5FWElTVFNdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0dFVF06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5UUllfR0VUX0pTT05dOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0RFTEVURV06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5NRVRBREFUQV06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5DT1BZXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlJFTkFNRV06IFtdLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogSXRlcmF0ZXMgb3ZlciB0aGUgdG9waWNzIGFuZCBzdXBwbHkgdGhlaXIgc2ltIGhhbmRsZXJcbiAgICogQHJldHVybnMgYW4gb2JqZWN0IG9mIEJ1Y2tldCBldmVudCB0eXBlcyAoa2V5cykgYW5kIHRoZWlyIHRvcGljIGhhbmRsZXJzICh2YWx1ZXMpXG4gICAqL1xuICBwcm90ZWN0ZWQgY29udmVydFRvcGljc1RvSGFuZGxlcygpIHtcbiAgICBjb25zdCB0b3BpY01hcDogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG4gICAgdGhpcy5fdG9waWNzLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgIHRvcGljTWFwW2tleV0gPSBzaW11bGF0b3JIYW5kbGVUb2tlbih2YWx1ZSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdG9waWNNYXA7XG4gIH1cblxuICBwdWJsaWMgYWRkT2JqZWN0KGtleTogc3RyaW5nLCBib2R5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmluaXRpYWxPYmplY3RzW2tleV0gPSBib2R5O1xuICB9XG5cbiAgcHJvdGVjdGVkIGNyZWF0ZVRvcGljSGFuZGxlcihcbiAgICBldmVudFR5cGU6IGNsb3VkLkJ1Y2tldEV2ZW50VHlwZSxcbiAgICBpbmZsaWdodDogY2xvdWQuSUJ1Y2tldEV2ZW50SGFuZGxlclxuICApOiBjbG91ZC5JVG9waWNPbk1lc3NhZ2VIYW5kbGVyIHtcbiAgICByZXR1cm4gQnVja2V0RXZlbnRIYW5kbGVyLnRvVG9waWNPbk1lc3NhZ2VIYW5kbGVyKGluZmxpZ2h0LCBldmVudFR5cGUpO1xuICB9XG5cbiAgcHVibGljIG9uQ3JlYXRlKFxuICAgIGZuOiBjbG91ZC5JQnVja2V0RXZlbnRIYW5kbGVyLFxuICAgIG9wdHM/OiBjbG91ZC5CdWNrZXRPbkNyZWF0ZU9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgc3VwZXIub25DcmVhdGUoZm4sIG9wdHMpO1xuICAgIGNvbnN0IHRvcGljID0gdGhpcy5nZXRUb3BpYyhjbG91ZC5CdWNrZXRFdmVudFR5cGUuQ1JFQVRFKTtcbiAgICB0aGlzLnBvbGljeS5hZGRTdGF0ZW1lbnQodG9waWMsIGNsb3VkLlRvcGljSW5mbGlnaHRNZXRob2RzLlBVQkxJU0gpO1xuICB9XG5cbiAgcHVibGljIG9uRGVsZXRlKFxuICAgIGZuOiBjbG91ZC5JQnVja2V0RXZlbnRIYW5kbGVyLFxuICAgIG9wdHM/OiBjbG91ZC5CdWNrZXRPbkRlbGV0ZU9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgc3VwZXIub25EZWxldGUoZm4sIG9wdHMpO1xuICAgIGNvbnN0IHRvcGljID0gdGhpcy5nZXRUb3BpYyhjbG91ZC5CdWNrZXRFdmVudFR5cGUuREVMRVRFKTtcbiAgICB0aGlzLnBvbGljeS5hZGRTdGF0ZW1lbnQodG9waWMsIGNsb3VkLlRvcGljSW5mbGlnaHRNZXRob2RzLlBVQkxJU0gpO1xuICB9XG5cbiAgcHVibGljIG9uVXBkYXRlKFxuICAgIGZuOiBjbG91ZC5JQnVja2V0RXZlbnRIYW5kbGVyLFxuICAgIG9wdHM/OiBjbG91ZC5CdWNrZXRPblVwZGF0ZU9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgc3VwZXIub25VcGRhdGUoZm4sIG9wdHMpO1xuICAgIGNvbnN0IHRvcGljID0gdGhpcy5nZXRUb3BpYyhjbG91ZC5CdWNrZXRFdmVudFR5cGUuVVBEQVRFKTtcbiAgICB0aGlzLnBvbGljeS5hZGRTdGF0ZW1lbnQodG9waWMsIGNsb3VkLlRvcGljSW5mbGlnaHRNZXRob2RzLlBVQkxJU0gpO1xuICB9XG5cbiAgcHVibGljIG9uRXZlbnQoXG4gICAgZm46IGNsb3VkLklCdWNrZXRFdmVudEhhbmRsZXIsXG4gICAgb3B0cz86IGNsb3VkLkJ1Y2tldE9uRXZlbnRPcHRpb25zXG4gICk6IHZvaWQge1xuICAgIHN1cGVyLm9uRXZlbnQoZm4sIG9wdHMpO1xuICAgIGNvbnN0IGNyZWF0ZVRvcGljID0gdGhpcy5nZXRUb3BpYyhjbG91ZC5CdWNrZXRFdmVudFR5cGUuQ1JFQVRFKTtcbiAgICB0aGlzLnBvbGljeS5hZGRTdGF0ZW1lbnQoY3JlYXRlVG9waWMsIGNsb3VkLlRvcGljSW5mbGlnaHRNZXRob2RzLlBVQkxJU0gpO1xuICAgIGNvbnN0IGRlbGV0ZVRvcGljID0gdGhpcy5nZXRUb3BpYyhjbG91ZC5CdWNrZXRFdmVudFR5cGUuREVMRVRFKTtcbiAgICB0aGlzLnBvbGljeS5hZGRTdGF0ZW1lbnQoZGVsZXRlVG9waWMsIGNsb3VkLlRvcGljSW5mbGlnaHRNZXRob2RzLlBVQkxJU0gpO1xuICAgIGNvbnN0IHVwZGF0ZVRvcGljID0gdGhpcy5nZXRUb3BpYyhjbG91ZC5CdWNrZXRFdmVudFR5cGUuVVBEQVRFKTtcbiAgICB0aGlzLnBvbGljeS5hZGRTdGF0ZW1lbnQodXBkYXRlVG9waWMsIGNsb3VkLlRvcGljSW5mbGlnaHRNZXRob2RzLlBVQkxJU0gpO1xuICB9XG5cbiAgcHVibGljIHRvU2ltdWxhdG9yKCk6IFRvU2ltdWxhdG9yT3V0cHV0IHtcbiAgICBjb25zdCBwcm9wczogQnVja2V0U2NoZW1hID0ge1xuICAgICAgcHVibGljOiB0aGlzLnB1YmxpYyxcbiAgICAgIGluaXRpYWxPYmplY3RzOiB0aGlzLmluaXRpYWxPYmplY3RzLFxuICAgICAgdG9waWNzOiB0aGlzLmNvbnZlcnRUb3BpY3NUb0hhbmRsZXMoKSxcbiAgICB9O1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBjbG91ZC5CVUNLRVRfRlFOLFxuICAgICAgcHJvcHMsXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBvbkxpZnQoaG9zdDogSUluZmxpZ2h0SG9zdCwgb3BzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIGJpbmRTaW11bGF0b3JSZXNvdXJjZShfX2ZpbGVuYW1lLCB0aGlzLCBob3N0LCBvcHMpO1xuICAgIHN1cGVyLm9uTGlmdChob3N0LCBvcHMpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3RvSW5mbGlnaHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gbWFrZVNpbXVsYXRvckpzQ2xpZW50KF9fZmlsZW5hbWUsIHRoaXMpO1xuICB9XG59XG5cbi8qKlxuICogVXRpbGl0eSBjbGFzcyB0byB3b3JrIHdpdGggYnVja2V0IGV2ZW50IGhhbmRsZXJzLlxuICovXG5leHBvcnQgY2xhc3MgQnVja2V0RXZlbnRIYW5kbGVyIHtcbiAgLyoqXG4gICAqIENvbnZlcnRzIGEgYGNsb3VkLklCdWNrZXRFdmVudEhhbmRsZXJgIHRvIGEgYGNsb3VkLklUb3BpY09uTWVzc2FnZUhhbmRsZXJgLlxuICAgKiBAcGFyYW0gaGFuZGxlciB0aGUgaGFuZGxlciB0byBjb252ZXJ0XG4gICAqIEBwYXJhbSBldmVudFR5cGUgdGhlIGV2ZW50IHR5cGVcbiAgICogQHJldHVybnMgdGhlIG9uIG1lc3NhZ2UgaGFuZGxlci5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgdG9Ub3BpY09uTWVzc2FnZUhhbmRsZXIoXG4gICAgaGFuZGxlcjogY2xvdWQuSUJ1Y2tldEV2ZW50SGFuZGxlcixcbiAgICBldmVudFR5cGU6IGNsb3VkLkJ1Y2tldEV2ZW50VHlwZVxuICApOiBjbG91ZC5JVG9waWNPbk1lc3NhZ2VIYW5kbGVyIHtcbiAgICByZXR1cm4gbGlmdCh7IGhhbmRsZXIsIGV2ZW50VHlwZSB9KS5pbmZsaWdodChhc3luYyAoY3R4LCBldmVudCkgPT4ge1xuICAgICAgcmV0dXJuIGN0eC5oYW5kbGVyKGV2ZW50LCBjdHguZXZlbnRUeXBlKTtcbiAgICB9KTtcbiAgfVxufVxuIl19