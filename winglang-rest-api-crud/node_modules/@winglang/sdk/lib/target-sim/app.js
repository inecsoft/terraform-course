"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.App = exports.SIMULATOR_FILE_PATH = void 0;
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const api_1 = require("./api");
const bucket_1 = require("./bucket");
const container_1 = require("./container");
const counter_1 = require("./counter");
const domain_1 = require("./domain");
const endpoint_1 = require("./endpoint");
const event_mapping_1 = require("./event-mapping");
const function_1 = require("./function");
const on_deploy_1 = require("./on-deploy");
const policy_1 = require("./policy");
const queue_1 = require("./queue");
const redis_1 = require("./redis");
const resource_1 = require("./resource");
const schedule_1 = require("./schedule");
const secret_1 = require("./secret");
const service_1 = require("./service");
const state_1 = require("./state");
const table_1 = require("./table");
const test_runner_1 = require("./test-runner");
const tokens_1 = require("./tokens");
const topic_1 = require("./topic");
const website_1 = require("./website");
const cloud_1 = require("../cloud");
const constants_1 = require("../constants");
const core = __importStar(require("../core"));
const app_1 = require("../core/app");
const tokens_2 = require("../core/tokens");
const ex_1 = require("../ex");
const std_1 = require("../std");
/**
 * Path of the simulator configuration file in every .wsim tarball.
 */
exports.SIMULATOR_FILE_PATH = "simulator.json";
const SIMULATOR_CLASS_DATA = {
    [cloud_1.API_FQN]: "Api",
    [cloud_1.BUCKET_FQN]: "Bucket",
    [cloud_1.DOMAIN_FQN]: "Domain",
    [cloud_1.ENDPOINT_FQN]: "Endpoint",
    [event_mapping_1.EVENT_MAPPING_FQN]: "EventMapping",
    [cloud_1.FUNCTION_FQN]: "Function",
    [cloud_1.ON_DEPLOY_FQN]: "OnDeploy",
    [policy_1.POLICY_FQN]: "Policy",
    [cloud_1.QUEUE_FQN]: "Queue",
    [ex_1.REDIS_FQN]: "Redis",
    [cloud_1.SCHEDULE_FQN]: "Schedule",
    [cloud_1.SECRET_FQN]: "Secret",
    [cloud_1.SERVICE_FQN]: "Service",
    [state_1.STATE_FQN]: "State",
    [container_1.SIM_CONTAINER_FQN]: "Container",
    [resource_1.SIM_RESOURCE_FQN]: "Resource",
    [ex_1.TABLE_FQN]: "Table",
    [std_1.TEST_RUNNER_FQN]: "TestRunner",
    [cloud_1.TOPIC_FQN]: "Topic",
    [cloud_1.WEBSITE_FQN]: "Website",
};
/**
 * A construct that knows how to synthesize simulator resources into a
 * Wing simulator (.wsim) file.
 */
class App extends core.App {
    constructor(props) {
        // doesn't allow customize the root id- as used hardcoded in the code
        super(undefined, "root", props);
        this._target = "sim";
        this.synthed = false;
        this.outdir = props.outdir ?? ".";
        (0, tokens_2.registerTokenResolver)(new tokens_1.SimTokens());
        test_runner_1.TestRunner._createTree(this, props.rootConstruct);
    }
    /** @internal */
    _inflightClientForFqn(fqn) {
        switch (fqn) {
            case cloud_1.API_FQN:
                return require.resolve("./api.inflight");
            case cloud_1.BUCKET_FQN:
                return require.resolve("./bucket.inflight");
            case cloud_1.DOMAIN_FQN:
                return require.resolve("./domain.inflight");
            case cloud_1.ENDPOINT_FQN:
                return require.resolve("./endpoint.inflight");
            case event_mapping_1.EVENT_MAPPING_FQN:
                return require.resolve("./event-mapping.inflight");
            case cloud_1.FUNCTION_FQN:
                return require.resolve("./function.inflight");
            case cloud_1.ON_DEPLOY_FQN:
                return require.resolve("./on-deploy.inflight");
            case policy_1.POLICY_FQN:
                return require.resolve("./policy.inflight");
            case cloud_1.QUEUE_FQN:
                return require.resolve("./queue.inflight");
            case ex_1.REDIS_FQN:
                return require.resolve("./redis.inflight");
            case cloud_1.SCHEDULE_FQN:
                return require.resolve("./schedule.inflight");
            case cloud_1.SECRET_FQN:
                return require.resolve("./secret.inflight");
            case cloud_1.SERVICE_FQN:
                return require.resolve("./service.inflight");
            case state_1.STATE_FQN:
                return require.resolve("./state.inflight");
            case ex_1.TABLE_FQN:
                return require.resolve("./table.inflight");
            case std_1.TEST_RUNNER_FQN:
                return require.resolve("./test-runner.inflight");
            case cloud_1.TOPIC_FQN:
                return require.resolve("./topic.inflight");
            case cloud_1.WEBSITE_FQN:
                return require.resolve("./website.inflight");
            case container_1.SIM_CONTAINER_FQN:
                return require.resolve("./container.inflight");
            case resource_1.SIM_RESOURCE_FQN:
                return require.resolve("./resource.inflight");
        }
        return undefined;
    }
    typeForFqn(fqn) {
        switch (fqn) {
            case cloud_1.API_FQN:
                return api_1.Api;
            case cloud_1.BUCKET_FQN:
                return bucket_1.Bucket;
            case cloud_1.COUNTER_FQN:
                return counter_1.Counter;
            case cloud_1.DOMAIN_FQN:
                return domain_1.Domain;
            case cloud_1.ENDPOINT_FQN:
                return endpoint_1.Endpoint;
            // EVENT_MAPPING_FQN skipped - it's not a multi-target construct
            case cloud_1.FUNCTION_FQN:
                return function_1.Function;
            case cloud_1.ON_DEPLOY_FQN:
                return on_deploy_1.OnDeploy;
            case policy_1.POLICY_FQN:
                return policy_1.Policy;
            case cloud_1.QUEUE_FQN:
                return queue_1.Queue;
            case ex_1.REDIS_FQN:
                return redis_1.Redis;
            case cloud_1.SCHEDULE_FQN:
                return schedule_1.Schedule;
            case cloud_1.SECRET_FQN:
                return secret_1.Secret;
            case cloud_1.SERVICE_FQN:
                return service_1.Service;
            case state_1.STATE_FQN:
                return state_1.State;
            case ex_1.TABLE_FQN:
                return table_1.Table;
            case std_1.TEST_RUNNER_FQN:
                return test_runner_1.TestRunner;
            case cloud_1.TOPIC_FQN:
                return topic_1.Topic;
            case cloud_1.WEBSITE_FQN:
                return website_1.Website;
            // SIM_CONTAINER_FQN skipped - it's not a multi-target construct
            // SIM_RESOURCE_FQN skipped - it's not a multi-target construct
        }
        return undefined;
    }
    /**
     * Synthesize the app. This creates a tree.json file and a .wsim file in the
     * app's outdir, and returns a path to the .wsim directory.
     */
    synth() {
        if (this.synthed) {
            return this.outdir;
        }
        fs.mkdirSync(this.outdir, { recursive: true });
        // call preSynthesize() on every construct in the tree
        (0, app_1.preSynthesizeAllConstructs)(this);
        if (this._synthHooks?.preSynthesize) {
            this._synthHooks.preSynthesize.forEach((hook) => hook(this));
        }
        // write simulator.json file into workdir
        this.synthSimulatorFile(this.outdir);
        // write tree.json file into workdir
        core.synthesizeTree(this, this.outdir);
        // write `outdir/connections.json`
        core.Connections.of(this).synth(this.outdir);
        this.synthed = true;
        if (this._synthHooks?.postSynthesize) {
            this._synthHooks.postSynthesize.forEach((hook) => hook(this));
        }
        return this.outdir;
    }
    synthSimulatorFile(outdir) {
        const resources = {};
        for (const r of new core.DependencyGraph(this.node).topology()) {
            if ((0, resource_1.isSimulatorResource)(r)) {
                const deps = r.node.dependencies.map((d) => d.node.path);
                resources[r.node.path] = {
                    ...r.toSimulator(),
                    path: r.node.path,
                    addr: r.node.addr,
                    deps: deps.length === 0 ? undefined : deps,
                    attrs: undefined,
                };
            }
        }
        const types = {};
        for (const [fqn, className] of Object.entries(SIMULATOR_CLASS_DATA)) {
            const sourcePath = this._inflightClientForFqn(fqn);
            if (!sourcePath) {
                throw new Error(`No source path for ${fqn}`);
            }
            types[fqn] = {
                className,
                sourcePath,
            };
        }
        const contents = {
            types,
            resources,
            sdkVersion: constants_1.SDK_VERSION,
        };
        // write simulator.json file
        fs.writeFileSync(path.join(outdir, exports.SIMULATOR_FILE_PATH), JSON.stringify(contents, undefined, 2), { encoding: "utf8" });
    }
}
exports.App = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC1zaW0vYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsdUNBQXlCO0FBQ3pCLDJDQUE2QjtBQUM3QiwrQkFBNEI7QUFDNUIscUNBQWtDO0FBQ2xDLDJDQUFnRDtBQUNoRCx1Q0FBb0M7QUFDcEMscUNBQWtDO0FBQ2xDLHlDQUFzQztBQUN0QyxtREFBb0Q7QUFDcEQseUNBQXNDO0FBQ3RDLDJDQUF1QztBQUN2QyxxQ0FBOEM7QUFDOUMsbUNBQWdDO0FBQ2hDLG1DQUFnQztBQUNoQyx5Q0FBbUU7QUFDbkUseUNBQXNDO0FBQ3RDLHFDQUFrQztBQUNsQyx1Q0FBb0M7QUFDcEMsbUNBQTJDO0FBQzNDLG1DQUFnQztBQUNoQywrQ0FBMkM7QUFDM0MscUNBQXFDO0FBQ3JDLG1DQUFnQztBQUNoQyx1Q0FBb0M7QUFDcEMsb0NBY2tCO0FBQ2xCLDRDQUEyQztBQUMzQyw4Q0FBZ0M7QUFDaEMscUNBQXlEO0FBQ3pELDJDQUF1RDtBQUN2RCw4QkFBNkM7QUFNN0MsZ0NBQXlDO0FBRXpDOztHQUVHO0FBQ1UsUUFBQSxtQkFBbUIsR0FBRyxnQkFBZ0IsQ0FBQztBQUVwRCxNQUFNLG9CQUFvQixHQUFHO0lBQzNCLENBQUMsZUFBTyxDQUFDLEVBQUUsS0FBSztJQUNoQixDQUFDLGtCQUFVLENBQUMsRUFBRSxRQUFRO0lBQ3RCLENBQUMsa0JBQVUsQ0FBQyxFQUFFLFFBQVE7SUFDdEIsQ0FBQyxvQkFBWSxDQUFDLEVBQUUsVUFBVTtJQUMxQixDQUFDLGlDQUFpQixDQUFDLEVBQUUsY0FBYztJQUNuQyxDQUFDLG9CQUFZLENBQUMsRUFBRSxVQUFVO0lBQzFCLENBQUMscUJBQWEsQ0FBQyxFQUFFLFVBQVU7SUFDM0IsQ0FBQyxtQkFBVSxDQUFDLEVBQUUsUUFBUTtJQUN0QixDQUFDLGlCQUFTLENBQUMsRUFBRSxPQUFPO0lBQ3BC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TSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUM7WUFDcEUsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUMvQyxDQUFDO1lBQ0QsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHO2dCQUNYLFNBQVM7Z0JBQ1QsVUFBVTthQUNYLENBQUM7UUFDSixDQUFDO1FBRUQsTUFBTSxRQUFRLEdBQXdCO1lBQ3BDLEtBQUs7WUFDTCxTQUFTO1lBQ1QsVUFBVSxFQUFFLHVCQUFXO1NBQ3hCLENBQUM7UUFFRiw0QkFBNEI7UUFDNUIsRUFBRSxDQUFDLGFBQWEsQ0FDZCxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSwyQkFBbUIsQ0FBQyxFQUN0QyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQ3RDLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxDQUNyQixDQUFDO0lBQ0osQ0FBQztDQUNGO0FBaE9ELGtCQWdPQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgQXBpIH0gZnJvbSBcIi4vYXBpXCI7XG5pbXBvcnQgeyBCdWNrZXQgfSBmcm9tIFwiLi9idWNrZXRcIjtcbmltcG9ydCB7IFNJTV9DT05UQUlORVJfRlFOIH0gZnJvbSBcIi4vY29udGFpbmVyXCI7XG5pbXBvcnQgeyBDb3VudGVyIH0gZnJvbSBcIi4vY291bnRlclwiO1xuaW1wb3J0IHsgRG9tYWluIH0gZnJvbSBcIi4vZG9tYWluXCI7XG5pbXBvcnQgeyBFbmRwb2ludCB9IGZyb20gXCIuL2VuZHBvaW50XCI7XG5pbXBvcnQgeyBFVkVOVF9NQVBQSU5HX0ZRTiB9IGZyb20gXCIuL2V2ZW50LW1hcHBpbmdcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIH0gZnJvbSBcIi4vZnVuY3Rpb25cIjtcbmltcG9ydCB7IE9uRGVwbG95IH0gZnJvbSBcIi4vb24tZGVwbG95XCI7XG5pbXBvcnQgeyBQT0xJQ1lfRlFOLCBQb2xpY3kgfSBmcm9tIFwiLi9wb2xpY3lcIjtcbmltcG9ydCB7IFF1ZXVlIH0gZnJvbSBcIi4vcXVldWVcIjtcbmltcG9ydCB7IFJlZGlzIH0gZnJvbSBcIi4vcmVkaXNcIjtcbmltcG9ydCB7IFNJTV9SRVNPVVJDRV9GUU4sIGlzU2ltdWxhdG9yUmVzb3VyY2UgfSBmcm9tIFwiLi9yZXNvdXJjZVwiO1xuaW1wb3J0IHsgU2NoZWR1bGUgfSBmcm9tIFwiLi9zY2hlZHVsZVwiO1xuaW1wb3J0IHsgU2VjcmV0IH0gZnJvbSBcIi4vc2VjcmV0XCI7XG5pbXBvcnQgeyBTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZVwiO1xuaW1wb3J0IHsgU1RBVEVfRlFOLCBTdGF0ZSB9IGZyb20gXCIuL3N0YXRlXCI7XG5pbXBvcnQgeyBUYWJsZSB9IGZyb20gXCIuL3RhYmxlXCI7XG5pbXBvcnQgeyBUZXN0UnVubmVyIH0gZnJvbSBcIi4vdGVzdC1ydW5uZXJcIjtcbmltcG9ydCB7IFNpbVRva2VucyB9IGZyb20gXCIuL3Rva2Vuc1wiO1xuaW1wb3J0IHsgVG9waWMgfSBmcm9tIFwiLi90b3BpY1wiO1xuaW1wb3J0IHsgV2Vic2l0ZSB9IGZyb20gXCIuL3dlYnNpdGVcIjtcbmltcG9ydCB7XG4gIEFQSV9GUU4sXG4gIEJVQ0tFVF9GUU4sXG4gIENPVU5URVJfRlFOLFxuICBET01BSU5fRlFOLFxuICBFTkRQT0lOVF9GUU4sXG4gIEZVTkNUSU9OX0ZRTixcbiAgT05fREVQTE9ZX0ZRTixcbiAgUVVFVUVfRlFOLFxuICBTQ0hFRFVMRV9GUU4sXG4gIFNFQ1JFVF9GUU4sXG4gIFNFUlZJQ0VfRlFOLFxuICBUT1BJQ19GUU4sXG4gIFdFQlNJVEVfRlFOLFxufSBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCB7IFNES19WRVJTSU9OIH0gZnJvbSBcIi4uL2NvbnN0YW50c1wiO1xuaW1wb3J0ICogYXMgY29yZSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgcHJlU3ludGhlc2l6ZUFsbENvbnN0cnVjdHMgfSBmcm9tIFwiLi4vY29yZS9hcHBcIjtcbmltcG9ydCB7IHJlZ2lzdGVyVG9rZW5SZXNvbHZlciB9IGZyb20gXCIuLi9jb3JlL3Rva2Vuc1wiO1xuaW1wb3J0IHsgUkVESVNfRlFOLCBUQUJMRV9GUU4gfSBmcm9tIFwiLi4vZXhcIjtcbmltcG9ydCB7XG4gIEJhc2VSZXNvdXJjZVNjaGVtYSxcbiAgVHlwZVNjaGVtYSxcbiAgV2luZ1NpbXVsYXRvclNjaGVtYSxcbn0gZnJvbSBcIi4uL3NpbXVsYXRvclwiO1xuaW1wb3J0IHsgVEVTVF9SVU5ORVJfRlFOIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG4vKipcbiAqIFBhdGggb2YgdGhlIHNpbXVsYXRvciBjb25maWd1cmF0aW9uIGZpbGUgaW4gZXZlcnkgLndzaW0gdGFyYmFsbC5cbiAqL1xuZXhwb3J0IGNvbnN0IFNJTVVMQVRPUl9GSUxFX1BBVEggPSBcInNpbXVsYXRvci5qc29uXCI7XG5cbmNvbnN0IFNJTVVMQVRPUl9DTEFTU19EQVRBID0ge1xuICBbQVBJX0ZRTl06IFwiQXBpXCIsXG4gIFtCVUNLRVRfRlFOXTogXCJCdWNrZXRcIixcbiAgW0RPTUFJTl9GUU5dOiBcIkRvbWFpblwiLFxuICBbRU5EUE9JTlRfRlFOXTogXCJFbmRwb2ludFwiLFxuICBbRVZFTlRfTUFQUElOR19GUU5dOiBcIkV2ZW50TWFwcGluZ1wiLFxuICBbRlVOQ1RJT05fRlFOXTogXCJGdW5jdGlvblwiLFxuICBbT05fREVQTE9ZX0ZRTl06IFwiT25EZXBsb3lcIixcbiAgW1BPTElDWV9GUU5dOiBcIlBvbGljeVwiLFxuICBbUVVFVUVfRlFOXTogXCJRdWV1ZVwiLFxuICBbUkVESVNfRlFOXTogXCJSZWRpc1wiLFxuICBbU0NIRURVTEVfRlFOXTogXCJTY2hlZHVsZVwiLFxuICBbU0VDUkVUX0ZRTl06IFwiU2VjcmV0XCIsXG4gIFtTRVJWSUNFX0ZRTl06IFwiU2VydmljZVwiLFxuICBbU1RBVEVfRlFOXTogXCJTdGF0ZVwiLFxuICBbU0lNX0NPTlRBSU5FUl9GUU5dOiBcIkNvbnRhaW5lclwiLFxuICBbU0lNX1JFU09VUkNFX0ZRTl06IFwiUmVzb3VyY2VcIixcbiAgW1RBQkxFX0ZRTl06IFwiVGFibGVcIixcbiAgW1RFU1RfUlVOTkVSX0ZRTl06IFwiVGVzdFJ1bm5lclwiLFxuICBbVE9QSUNfRlFOXTogXCJUb3BpY1wiLFxuICBbV0VCU0lURV9GUU5dOiBcIldlYnNpdGVcIixcbn07XG5cbi8qKlxuICogQSBjb25zdHJ1Y3QgdGhhdCBrbm93cyBob3cgdG8gc3ludGhlc2l6ZSBzaW11bGF0b3IgcmVzb3VyY2VzIGludG8gYVxuICogV2luZyBzaW11bGF0b3IgKC53c2ltKSBmaWxlLlxuICovXG5leHBvcnQgY2xhc3MgQXBwIGV4dGVuZHMgY29yZS5BcHAge1xuICBwdWJsaWMgcmVhZG9ubHkgb3V0ZGlyOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBfdGFyZ2V0ID0gXCJzaW1cIjtcblxuICBwcml2YXRlIHN5bnRoZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogY29yZS5BcHBQcm9wcykge1xuICAgIC8vIGRvZXNuJ3QgYWxsb3cgY3VzdG9taXplIHRoZSByb290IGlkLSBhcyB1c2VkIGhhcmRjb2RlZCBpbiB0aGUgY29kZVxuICAgIHN1cGVyKHVuZGVmaW5lZCBhcyBhbnksIFwicm9vdFwiLCBwcm9wcyk7XG4gICAgdGhpcy5vdXRkaXIgPSBwcm9wcy5vdXRkaXIgPz8gXCIuXCI7XG4gICAgcmVnaXN0ZXJUb2tlblJlc29sdmVyKG5ldyBTaW1Ub2tlbnMoKSk7XG5cbiAgICBUZXN0UnVubmVyLl9jcmVhdGVUcmVlKHRoaXMsIHByb3BzLnJvb3RDb25zdHJ1Y3QpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX2luZmxpZ2h0Q2xpZW50Rm9yRnFuKGZxbjogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBzd2l0Y2ggKGZxbikge1xuICAgICAgY2FzZSBBUElfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi9hcGkuaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgQlVDS0VUX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vYnVja2V0LmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIERPTUFJTl9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL2RvbWFpbi5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBFTkRQT0lOVF9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL2VuZHBvaW50LmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIEVWRU5UX01BUFBJTkdfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi9ldmVudC1tYXBwaW5nLmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIEZVTkNUSU9OX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vZnVuY3Rpb24uaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgT05fREVQTE9ZX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vb24tZGVwbG95LmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIFBPTElDWV9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL3BvbGljeS5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBRVUVVRV9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL3F1ZXVlLmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIFJFRElTX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vcmVkaXMuaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgU0NIRURVTEVfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi9zY2hlZHVsZS5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBTRUNSRVRfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi9zZWNyZXQuaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgU0VSVklDRV9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL3NlcnZpY2UuaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgU1RBVEVfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi9zdGF0ZS5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBUQUJMRV9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL3RhYmxlLmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIFRFU1RfUlVOTkVSX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vdGVzdC1ydW5uZXIuaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgVE9QSUNfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi90b3BpYy5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBXRUJTSVRFX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vd2Vic2l0ZS5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBTSU1fQ09OVEFJTkVSX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vY29udGFpbmVyLmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIFNJTV9SRVNPVVJDRV9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL3Jlc291cmNlLmluZmxpZ2h0XCIpO1xuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgdHlwZUZvckZxbihmcW46IHN0cmluZyk6IGFueSB7XG4gICAgc3dpdGNoIChmcW4pIHtcbiAgICAgIGNhc2UgQVBJX0ZRTjpcbiAgICAgICAgcmV0dXJuIEFwaTtcblxuICAgICAgY2FzZSBCVUNLRVRfRlFOOlxuICAgICAgICByZXR1cm4gQnVja2V0O1xuXG4gICAgICBjYXNlIENPVU5URVJfRlFOOlxuICAgICAgICByZXR1cm4gQ291bnRlcjtcblxuICAgICAgY2FzZSBET01BSU5fRlFOOlxuICAgICAgICByZXR1cm4gRG9tYWluO1xuXG4gICAgICBjYXNlIEVORFBPSU5UX0ZRTjpcbiAgICAgICAgcmV0dXJuIEVuZHBvaW50O1xuXG4gICAgICAvLyBFVkVOVF9NQVBQSU5HX0ZRTiBza2lwcGVkIC0gaXQncyBub3QgYSBtdWx0aS10YXJnZXQgY29uc3RydWN0XG5cbiAgICAgIGNhc2UgRlVOQ1RJT05fRlFOOlxuICAgICAgICByZXR1cm4gRnVuY3Rpb247XG5cbiAgICAgIGNhc2UgT05fREVQTE9ZX0ZRTjpcbiAgICAgICAgcmV0dXJuIE9uRGVwbG95O1xuXG4gICAgICBjYXNlIFBPTElDWV9GUU46XG4gICAgICAgIHJldHVybiBQb2xpY3k7XG5cbiAgICAgIGNhc2UgUVVFVUVfRlFOOlxuICAgICAgICByZXR1cm4gUXVldWU7XG5cbiAgICAgIGNhc2UgUkVESVNfRlFOOlxuICAgICAgICByZXR1cm4gUmVkaXM7XG5cbiAgICAgIGNhc2UgU0NIRURVTEVfRlFOOlxuICAgICAgICByZXR1cm4gU2NoZWR1bGU7XG5cbiAgICAgIGNhc2UgU0VDUkVUX0ZRTjpcbiAgICAgICAgcmV0dXJuIFNlY3JldDtcblxuICAgICAgY2FzZSBTRVJWSUNFX0ZRTjpcbiAgICAgICAgcmV0dXJuIFNlcnZpY2U7XG5cbiAgICAgIGNhc2UgU1RBVEVfRlFOOlxuICAgICAgICByZXR1cm4gU3RhdGU7XG5cbiAgICAgIGNhc2UgVEFCTEVfRlFOOlxuICAgICAgICByZXR1cm4gVGFibGU7XG5cbiAgICAgIGNhc2UgVEVTVF9SVU5ORVJfRlFOOlxuICAgICAgICByZXR1cm4gVGVzdFJ1bm5lcjtcblxuICAgICAgY2FzZSBUT1BJQ19GUU46XG4gICAgICAgIHJldHVybiBUb3BpYztcblxuICAgICAgY2FzZSBXRUJTSVRFX0ZRTjpcbiAgICAgICAgcmV0dXJuIFdlYnNpdGU7XG5cbiAgICAgIC8vIFNJTV9DT05UQUlORVJfRlFOIHNraXBwZWQgLSBpdCdzIG5vdCBhIG11bHRpLXRhcmdldCBjb25zdHJ1Y3RcblxuICAgICAgLy8gU0lNX1JFU09VUkNFX0ZRTiBza2lwcGVkIC0gaXQncyBub3QgYSBtdWx0aS10YXJnZXQgY29uc3RydWN0XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTeW50aGVzaXplIHRoZSBhcHAuIFRoaXMgY3JlYXRlcyBhIHRyZWUuanNvbiBmaWxlIGFuZCBhIC53c2ltIGZpbGUgaW4gdGhlXG4gICAqIGFwcCdzIG91dGRpciwgYW5kIHJldHVybnMgYSBwYXRoIHRvIHRoZSAud3NpbSBkaXJlY3RvcnkuXG4gICAqL1xuICBwdWJsaWMgc3ludGgoKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy5zeW50aGVkKSB7XG4gICAgICByZXR1cm4gdGhpcy5vdXRkaXI7XG4gICAgfVxuXG4gICAgZnMubWtkaXJTeW5jKHRoaXMub3V0ZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcblxuICAgIC8vIGNhbGwgcHJlU3ludGhlc2l6ZSgpIG9uIGV2ZXJ5IGNvbnN0cnVjdCBpbiB0aGUgdHJlZVxuICAgIHByZVN5bnRoZXNpemVBbGxDb25zdHJ1Y3RzKHRoaXMpO1xuXG4gICAgaWYgKHRoaXMuX3N5bnRoSG9va3M/LnByZVN5bnRoZXNpemUpIHtcbiAgICAgIHRoaXMuX3N5bnRoSG9va3MucHJlU3ludGhlc2l6ZS5mb3JFYWNoKChob29rKSA9PiBob29rKHRoaXMpKTtcbiAgICB9XG5cbiAgICAvLyB3cml0ZSBzaW11bGF0b3IuanNvbiBmaWxlIGludG8gd29ya2RpclxuICAgIHRoaXMuc3ludGhTaW11bGF0b3JGaWxlKHRoaXMub3V0ZGlyKTtcblxuICAgIC8vIHdyaXRlIHRyZWUuanNvbiBmaWxlIGludG8gd29ya2RpclxuICAgIGNvcmUuc3ludGhlc2l6ZVRyZWUodGhpcywgdGhpcy5vdXRkaXIpO1xuXG4gICAgLy8gd3JpdGUgYG91dGRpci9jb25uZWN0aW9ucy5qc29uYFxuICAgIGNvcmUuQ29ubmVjdGlvbnMub2YodGhpcykuc3ludGgodGhpcy5vdXRkaXIpO1xuXG4gICAgdGhpcy5zeW50aGVkID0gdHJ1ZTtcblxuICAgIGlmICh0aGlzLl9zeW50aEhvb2tzPy5wb3N0U3ludGhlc2l6ZSkge1xuICAgICAgdGhpcy5fc3ludGhIb29rcy5wb3N0U3ludGhlc2l6ZS5mb3JFYWNoKChob29rKSA9PiBob29rKHRoaXMpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5vdXRkaXI7XG4gIH1cblxuICBwcml2YXRlIHN5bnRoU2ltdWxhdG9yRmlsZShvdXRkaXI6IHN0cmluZykge1xuICAgIGNvbnN0IHJlc291cmNlczogUmVjb3JkPHN0cmluZywgQmFzZVJlc291cmNlU2NoZW1hPiA9IHt9O1xuICAgIGZvciAoY29uc3QgciBvZiBuZXcgY29yZS5EZXBlbmRlbmN5R3JhcGgodGhpcy5ub2RlKS50b3BvbG9neSgpKSB7XG4gICAgICBpZiAoaXNTaW11bGF0b3JSZXNvdXJjZShyKSkge1xuICAgICAgICBjb25zdCBkZXBzID0gci5ub2RlLmRlcGVuZGVuY2llcy5tYXAoKGQpID0+IGQubm9kZS5wYXRoKTtcbiAgICAgICAgcmVzb3VyY2VzW3Iubm9kZS5wYXRoXSA9IHtcbiAgICAgICAgICAuLi5yLnRvU2ltdWxhdG9yKCksXG4gICAgICAgICAgcGF0aDogci5ub2RlLnBhdGgsXG4gICAgICAgICAgYWRkcjogci5ub2RlLmFkZHIsXG4gICAgICAgICAgZGVwczogZGVwcy5sZW5ndGggPT09IDAgPyB1bmRlZmluZWQgOiBkZXBzLFxuICAgICAgICAgIGF0dHJzOiB1bmRlZmluZWQgYXMgYW55LFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHR5cGVzOiB7IFtmcW46IHN0cmluZ106IFR5cGVTY2hlbWEgfSA9IHt9O1xuICAgIGZvciAoY29uc3QgW2ZxbiwgY2xhc3NOYW1lXSBvZiBPYmplY3QuZW50cmllcyhTSU1VTEFUT1JfQ0xBU1NfREFUQSkpIHtcbiAgICAgIGNvbnN0IHNvdXJjZVBhdGggPSB0aGlzLl9pbmZsaWdodENsaWVudEZvckZxbihmcW4pO1xuICAgICAgaWYgKCFzb3VyY2VQYXRoKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gc291cmNlIHBhdGggZm9yICR7ZnFufWApO1xuICAgICAgfVxuICAgICAgdHlwZXNbZnFuXSA9IHtcbiAgICAgICAgY2xhc3NOYW1lLFxuICAgICAgICBzb3VyY2VQYXRoLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBjb250ZW50czogV2luZ1NpbXVsYXRvclNjaGVtYSA9IHtcbiAgICAgIHR5cGVzLFxuICAgICAgcmVzb3VyY2VzLFxuICAgICAgc2RrVmVyc2lvbjogU0RLX1ZFUlNJT04sXG4gICAgfTtcblxuICAgIC8vIHdyaXRlIHNpbXVsYXRvci5qc29uIGZpbGVcbiAgICBmcy53cml0ZUZpbGVTeW5jKFxuICAgICAgcGF0aC5qb2luKG91dGRpciwgU0lNVUxBVE9SX0ZJTEVfUEFUSCksXG4gICAgICBKU09OLnN0cmluZ2lmeShjb250ZW50cywgdW5kZWZpbmVkLCAyKSxcbiAgICAgIHsgZW5jb2Rpbmc6IFwidXRmOFwiIH1cbiAgICApO1xuICB9XG59XG4iXX0=