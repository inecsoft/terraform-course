"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Container = void 0;
const child_process_1 = require("child_process");
const fs = __importStar(require("fs/promises"));
const path_1 = require("path");
const container_1 = require("./container");
const util_1 = require("./util");
const fs_1 = require("../fs");
const misc_1 = require("../shared/misc");
const simulator_1 = require("../simulator/simulator");
const std_1 = require("../std");
const util_2 = require("../util");
const STATE_FILENAME = "state.json";
class Container {
    constructor(props) {
        this.props = props;
        this.imageTag = props.imageTag;
        this.containerName = `wing-${util_2.Util.ulid()}`.toLocaleLowerCase();
        this.managedVolumes = {};
    }
    get context() {
        if (!this._context) {
            throw new Error("Cannot access context during class construction");
        }
        return this._context;
    }
    async init(context) {
        try {
            return await this.start(context);
        }
        catch (e) {
            this.addTrace(`Failed to start container: ${e.message}`, std_1.TraceType.RESOURCE, std_1.LogLevel.ERROR);
            return {};
        }
    }
    async start(context) {
        this._context = context;
        // Check for a previous state file to see if there was a port that was previously being used
        // if so, try to use it out of convenience
        const state = await this.loadState();
        if (state.managedVolumes) {
            this.managedVolumes = state.managedVolumes;
        }
        await this.prepareImage();
        // start the new container
        const dockerRun = [];
        dockerRun.push("-i");
        dockerRun.push("--rm");
        dockerRun.push("--name", this.containerName);
        if (this.props.containerPort) {
            dockerRun.push("-p", this.props.containerPort.toString());
        }
        const envFile = await this.createEnvFile();
        if (envFile) {
            dockerRun.push("--env-file", envFile);
        }
        for (const volume of this.props.volumes ?? []) {
            dockerRun.push("-v");
            // if the user specified an anonymous volume
            if (volume.startsWith("/") && !volume.includes(":")) {
                // check if we have a managed volume for this path from a previous run
                if (this.managedVolumes[volume]) {
                    const volumeName = this.managedVolumes[volume];
                    dockerRun.push(`${volumeName}:${volume}`);
                }
                else {
                    const volumeName = `wing-volume-${util_2.Util.ulid()}`;
                    dockerRun.push(`${volumeName}:${volume}`);
                    this.managedVolumes[volume] = volumeName;
                }
            }
            else {
                dockerRun.push(volume);
            }
        }
        dockerRun.push(this.imageTag);
        for (const a of this.props.args ?? []) {
            dockerRun.push(a);
        }
        this.addTrace(`Starting container from ${this.imageTag}`, std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
        this.child = this.dockerSpawn("run", dockerRun, {
            logLevel: std_1.LogLevel.INFO,
        });
        this.addTrace(`Waiting for container to ${this.props.containerPort
            ? `listen to ${this.props.containerPort}`
            : "start"}`, std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
        let hostPort;
        await waitUntil(async () => {
            if (!this.child?.running) {
                throw new Error(`Container ${this.imageTag} stopped unexpectedly`);
            }
            const container = await this.tryInspect(this.containerName);
            // if we are waiting for a port, check if the container is listening to it
            if (this.props.containerPort) {
                hostPort =
                    container?.[0]?.NetworkSettings?.Ports?.[`${this.props.containerPort}/tcp`]?.[0]?.HostPort;
                return hostPort !== undefined;
            }
            // if we are not waiting for a port, just check if the container is running
            return container?.[0]?.State?.Running;
        });
        this.addTrace(`Container ${this.imageTag} started`, std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
        return {
            [container_1.HOST_PORT_ATTR]: hostPort,
        };
    }
    /**
     * Builds or pulls the docker image used by this container.
     */
    async prepareImage() {
        // if this image is already here, we don't need to do anything
        if (await this.tryInspect(this.imageTag)) {
            this.addTrace(`Image ${this.imageTag} found, No need to build or pull.`, std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
            return;
        }
        // if this a reference to a local directory, build the image from a docker file
        if ((0, misc_1.isPath)(this.props.image)) {
            this.addTrace(`Building ${this.imageTag} from ${this.props.image}...`, std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
            await this.docker("build", ["-t", this.imageTag, this.props.image], {
                logLevel: std_1.LogLevel.VERBOSE,
            });
        }
        else {
            this.addTrace(`Pulling ${this.imageTag}...`, std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
            await this.docker("pull", [this.imageTag], {
                logLevel: std_1.LogLevel.VERBOSE,
            });
        }
    }
    async createEnvFile() {
        const env = this.props.env ?? {};
        if (Object.keys(env).length === 0) {
            return undefined;
        }
        const envFile = (0, path_1.join)(fs_1.Util.mkdtemp(), "env.json");
        const envLines = [];
        for (const k of Object.keys(env)) {
            envLines.push(`${k}=${env[k]}`);
        }
        await fs.writeFile(envFile, envLines.join("\n"));
        return envFile;
    }
    async tryInspect(name) {
        try {
            return JSON.parse(await this.docker("inspect", [name], {
                quiet: true,
            }));
        }
        catch {
            return undefined;
        }
    }
    async cleanup() {
        this.addTrace(`Stopping container ${this.containerName}`, std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
        await this.child?.kill();
    }
    async save() {
        await this.saveState({ managedVolumes: this.managedVolumes });
    }
    async loadState() {
        const stateFileExists = await (0, util_1.exists)((0, path_1.join)(this.context.statedir, STATE_FILENAME));
        if (stateFileExists) {
            const stateFileContents = await fs.readFile((0, path_1.join)(this.context.statedir, STATE_FILENAME), "utf-8");
            return JSON.parse(stateFileContents);
        }
        else {
            return {};
        }
    }
    async docker(command, args, options = {}) {
        const child = this.dockerSpawn(command, args, options);
        return child.join();
    }
    dockerSpawn(command, args, options = {}) {
        let quiet = options.quiet ?? false;
        const level = options.logLevel ?? std_1.LogLevel.INFO;
        const logErrors = !quiet;
        // can be used to hide container logs (used in our end to end tests). yes, ugly bit pragmatic.
        // otherwise, test output will include lots of non deterministic stuff and that's really hard to
        // snapshot.
        if (process.env.WING_HIDE_CONTAINER_LOGS) {
            quiet = true;
        }
        const commandDesc = `docker ${command}`;
        this.addTrace(`$ ${commandDesc} ${args.join(" ")}`, std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
        const child = (0, child_process_1.spawn)("docker", [command, ...args], {
            cwd: this.props.cwd,
            stdio: "pipe",
        });
        let started = true;
        child.once("exit", () => {
            started = false;
        });
        const stdout = [];
        const allOutput = [];
        child.stdout.on("data", (data) => {
            stdout.push(data);
            allOutput.push(data);
        });
        child.stderr.on("data", (data) => {
            allOutput.push(data);
        });
        if (!quiet) {
            child.stdout.on("data", (data) => this.addTrace(data.toString(), std_1.TraceType.LOG, level));
            child.stderr.on("data", (data) => this.addTrace(data.toString(), std_1.TraceType.LOG, level));
        }
        child.once("error", (err) => {
            started = false;
            if (logErrors) {
                this.addTrace(err.stack ?? err.message, std_1.TraceType.LOG, std_1.LogLevel.ERROR);
            }
        });
        const self = this;
        return {
            get running() {
                return started;
            },
            async kill() {
                return new Promise((resolve, reject) => {
                    if (!started) {
                        return resolve();
                    }
                    self.addTrace("Sending SIGTERM to container", std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
                    child.kill("SIGTERM");
                    // if the process doesn't exit in 2 seconds, kill it
                    const timeout = setTimeout(() => {
                        self.addTrace(`Timeout waiting for container ${self._context?.resourcePath} to shutdown, removing forcefully`, std_1.TraceType.RESOURCE, std_1.LogLevel.WARNING);
                        self
                            .docker("rm", ["-f", self.containerName], { quiet: true })
                            .catch(() => { });
                    }, 2000);
                    child.once("error", (err) => {
                        self.addTrace(`Error when shutting down container: ${err.stack ?? err.message}`, std_1.TraceType.RESOURCE, std_1.LogLevel.ERROR);
                        clearTimeout(timeout);
                        reject(err);
                    });
                    child.once("exit", () => {
                        self.addTrace("Container shutdown successfully", std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
                        clearTimeout(timeout);
                        resolve();
                    });
                });
            },
            async join() {
                return new Promise((ok, ko) => {
                    if (!started) {
                        return ok(stdout.join(""));
                    }
                    child.once("error", ko);
                    child.once("exit", (code) => {
                        if (code === 0) {
                            return ok(stdout.join(""));
                        }
                        else {
                            const message = `Command "${commandDesc}" exited with non-zero code ${code}`;
                            if (logErrors) {
                                self.addTrace(`${message}}\n${allOutput.join("")}`, std_1.TraceType.RESOURCE, std_1.LogLevel.VERBOSE);
                            }
                            return ko(new Error(`${message} (see verbose logs)`));
                        }
                    });
                });
            },
        };
    }
    async saveState(state) {
        await fs.writeFile((0, path_1.join)(this.context.statedir, STATE_FILENAME), JSON.stringify(state));
    }
    async plan() {
        return simulator_1.UpdatePlan.AUTO;
    }
    addTrace(message, type, level) {
        this.context.addTrace({
            data: { message: message.trim() },
            sourcePath: this.context.resourcePath,
            sourceType: "container",
            timestamp: new Date().toISOString(),
            type,
            level,
        });
    }
}
exports.Container = Container;
async function waitUntil(predicate) {
    const timeout = std_1.Duration.fromSeconds(30);
    const interval = std_1.Duration.fromSeconds(0.1);
    let elapsed = 0;
    while (elapsed < timeout.seconds) {
        if (await predicate()) {
            return true;
        }
        elapsed += interval.seconds;
        await util_2.Util.sleep(interval);
    }
    throw new Error("Timeout elapsed");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGFpbmVyLmluZmxpZ2h0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC1zaW0vY29udGFpbmVyLmluZmxpZ2h0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsaURBQXNDO0FBQ3RDLGdEQUFrQztBQUNsQywrQkFBNEI7QUFDNUIsMkNBQStEO0FBRS9ELGlDQUFnQztBQUNoQyw4QkFBbUM7QUFDbkMseUNBQXdDO0FBQ3hDLHNEQUlnQztBQUNoQyxnQ0FBdUQ7QUFDdkQsa0NBQStCO0FBRS9CLE1BQU0sY0FBYyxHQUFHLFlBQVksQ0FBQztBQWFwQyxNQUFhLFNBQVM7SUFPcEIsWUFBb0MsS0FBc0I7UUFBdEIsVUFBSyxHQUFMLEtBQUssQ0FBaUI7UUFDeEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBQy9CLElBQUksQ0FBQyxhQUFhLEdBQUcsUUFBUSxXQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQy9ELElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRCxJQUFZLE9BQU87UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBRU0sS0FBSyxDQUFDLElBQUksQ0FBQyxPQUEwQjtRQUMxQyxJQUFJLENBQUM7WUFDSCxPQUFPLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNuQyxDQUFDO1FBQUMsT0FBTyxDQUFNLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsUUFBUSxDQUNYLDhCQUE4QixDQUFDLENBQUMsT0FBTyxFQUFFLEVBQ3pD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QUN0QixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFDRCxPQUFPLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQztRQUM1QixNQUFNLFdBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVELE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUNyQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3Bhd24gfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzL3Byb21pc2VzXCI7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IElDb250YWluZXJDbGllbnQsIEhPU1RfUE9SVF9BVFRSIH0gZnJvbSBcIi4vY29udGFpbmVyXCI7XG5pbXBvcnQgeyBDb250YWluZXJBdHRyaWJ1dGVzLCBDb250YWluZXJTY2hlbWEgfSBmcm9tIFwiLi9zY2hlbWEtcmVzb3VyY2VzXCI7XG5pbXBvcnQgeyBleGlzdHMgfSBmcm9tIFwiLi91dGlsXCI7XG5pbXBvcnQgeyBVdGlsIGFzIEZzIH0gZnJvbSBcIi4uL2ZzXCI7XG5pbXBvcnQgeyBpc1BhdGggfSBmcm9tIFwiLi4vc2hhcmVkL21pc2NcIjtcbmltcG9ydCB7XG4gIElTaW11bGF0b3JDb250ZXh0LFxuICBJU2ltdWxhdG9yUmVzb3VyY2VJbnN0YW5jZSxcbiAgVXBkYXRlUGxhbixcbn0gZnJvbSBcIi4uL3NpbXVsYXRvci9zaW11bGF0b3JcIjtcbmltcG9ydCB7IER1cmF0aW9uLCBMb2dMZXZlbCwgVHJhY2VUeXBlIH0gZnJvbSBcIi4uL3N0ZFwiO1xuaW1wb3J0IHsgVXRpbCB9IGZyb20gXCIuLi91dGlsXCI7XG5cbmNvbnN0IFNUQVRFX0ZJTEVOQU1FID0gXCJzdGF0ZS5qc29uXCI7XG5cbi8qKlxuICogQ29udGVudHMgb2YgdGhlIHN0YXRlIGZpbGUgZm9yIHRoaXMgcmVzb3VyY2UuXG4gKi9cbmludGVyZmFjZSBTdGF0ZUZpbGVDb250ZW50cyB7XG4gIC8qKlxuICAgKiBBIG1hcHBpbmcgb2Ygdm9sdW1lIHBhdGhzIHRvIHRoZSBXaW5nLW1hbmFnZWQgdm9sdW1lIG5hbWVzLCB3aGljaCB3aWxsIGJlIHJldXNlZFxuICAgKiBhY3Jvc3Mgc2ltdWxhdG9yIHJ1bnMuXG4gICAqL1xuICByZWFkb25seSBtYW5hZ2VkVm9sdW1lcz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG59XG5cbmV4cG9ydCBjbGFzcyBDb250YWluZXIgaW1wbGVtZW50cyBJQ29udGFpbmVyQ2xpZW50LCBJU2ltdWxhdG9yUmVzb3VyY2VJbnN0YW5jZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgaW1hZ2VUYWc6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBjb250YWluZXJOYW1lOiBzdHJpbmc7XG4gIHByaXZhdGUgX2NvbnRleHQ6IElTaW11bGF0b3JDb250ZXh0IHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIG1hbmFnZWRWb2x1bWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICBwcml2YXRlIGNoaWxkOiBEb2NrZXJQcm9jZXNzIHwgdW5kZWZpbmVkO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBDb250YWluZXJTY2hlbWEpIHtcbiAgICB0aGlzLmltYWdlVGFnID0gcHJvcHMuaW1hZ2VUYWc7XG4gICAgdGhpcy5jb250YWluZXJOYW1lID0gYHdpbmctJHtVdGlsLnVsaWQoKX1gLnRvTG9jYWxlTG93ZXJDYXNlKCk7XG4gICAgdGhpcy5tYW5hZ2VkVm9sdW1lcyA9IHt9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgY29udGV4dCgpOiBJU2ltdWxhdG9yQ29udGV4dCB7XG4gICAgaWYgKCF0aGlzLl9jb250ZXh0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgYWNjZXNzIGNvbnRleHQgZHVyaW5nIGNsYXNzIGNvbnN0cnVjdGlvblwiKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2NvbnRleHQ7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5pdChjb250ZXh0OiBJU2ltdWxhdG9yQ29udGV4dCk6IFByb21pc2U8Q29udGFpbmVyQXR0cmlidXRlcz4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zdGFydChjb250ZXh0KTtcbiAgICB9IGNhdGNoIChlOiBhbnkpIHtcbiAgICAgIHRoaXMuYWRkVHJhY2UoXG4gICAgICAgIGBGYWlsZWQgdG8gc3RhcnQgY29udGFpbmVyOiAke2UubWVzc2FnZX1gLFxuICAgICAgICBUcmFjZVR5cGUuUkVTT1VSQ0UsXG4gICAgICAgIExvZ0xldmVsLkVSUk9SXG4gICAgICApO1xuXG4gICAgICByZXR1cm4ge307XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHN0YXJ0KGNvbnRleHQ6IElTaW11bGF0b3JDb250ZXh0KTogUHJvbWlzZTxDb250YWluZXJBdHRyaWJ1dGVzPiB7XG4gICAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7XG5cbiAgICAvLyBDaGVjayBmb3IgYSBwcmV2aW91cyBzdGF0ZSBmaWxlIHRvIHNlZSBpZiB0aGVyZSB3YXMgYSBwb3J0IHRoYXQgd2FzIHByZXZpb3VzbHkgYmVpbmcgdXNlZFxuICAgIC8vIGlmIHNvLCB0cnkgdG8gdXNlIGl0IG91dCBvZiBjb252ZW5pZW5jZVxuICAgIGNvbnN0IHN0YXRlOiBTdGF0ZUZpbGVDb250ZW50cyA9IGF3YWl0IHRoaXMubG9hZFN0YXRlKCk7XG4gICAgaWYgKHN0YXRlLm1hbmFnZWRWb2x1bWVzKSB7XG4gICAgICB0aGlzLm1hbmFnZWRWb2x1bWVzID0gc3RhdGUubWFuYWdlZFZvbHVtZXM7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5wcmVwYXJlSW1hZ2UoKTtcblxuICAgIC8vIHN0YXJ0IHRoZSBuZXcgY29udGFpbmVyXG4gICAgY29uc3QgZG9ja2VyUnVuOiBzdHJpbmdbXSA9IFtdO1xuICAgIGRvY2tlclJ1bi5wdXNoKFwiLWlcIik7XG4gICAgZG9ja2VyUnVuLnB1c2goXCItLXJtXCIpO1xuICAgIGRvY2tlclJ1bi5wdXNoKFwiLS1uYW1lXCIsIHRoaXMuY29udGFpbmVyTmFtZSk7XG5cbiAgICBpZiAodGhpcy5wcm9wcy5jb250YWluZXJQb3J0KSB7XG4gICAgICBkb2NrZXJSdW4ucHVzaChcIi1wXCIsIHRoaXMucHJvcHMuY29udGFpbmVyUG9ydC50b1N0cmluZygpKTtcbiAgICB9XG5cbiAgICBjb25zdCBlbnZGaWxlID0gYXdhaXQgdGhpcy5jcmVhdGVFbnZGaWxlKCk7XG4gICAgaWYgKGVudkZpbGUpIHtcbiAgICAgIGRvY2tlclJ1bi5wdXNoKFwiLS1lbnYtZmlsZVwiLCBlbnZGaWxlKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHZvbHVtZSBvZiB0aGlzLnByb3BzLnZvbHVtZXMgPz8gW10pIHtcbiAgICAgIGRvY2tlclJ1bi5wdXNoKFwiLXZcIik7XG5cbiAgICAgIC8vIGlmIHRoZSB1c2VyIHNwZWNpZmllZCBhbiBhbm9ueW1vdXMgdm9sdW1lXG4gICAgICBpZiAodm9sdW1lLnN0YXJ0c1dpdGgoXCIvXCIpICYmICF2b2x1bWUuaW5jbHVkZXMoXCI6XCIpKSB7XG4gICAgICAgIC8vIGNoZWNrIGlmIHdlIGhhdmUgYSBtYW5hZ2VkIHZvbHVtZSBmb3IgdGhpcyBwYXRoIGZyb20gYSBwcmV2aW91cyBydW5cbiAgICAgICAgaWYgKHRoaXMubWFuYWdlZFZvbHVtZXNbdm9sdW1lXSkge1xuICAgICAgICAgIGNvbnN0IHZvbHVtZU5hbWUgPSB0aGlzLm1hbmFnZWRWb2x1bWVzW3ZvbHVtZV07XG4gICAgICAgICAgZG9ja2VyUnVuLnB1c2goYCR7dm9sdW1lTmFtZX06JHt2b2x1bWV9YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3Qgdm9sdW1lTmFtZSA9IGB3aW5nLXZvbHVtZS0ke1V0aWwudWxpZCgpfWA7XG4gICAgICAgICAgZG9ja2VyUnVuLnB1c2goYCR7dm9sdW1lTmFtZX06JHt2b2x1bWV9YCk7XG4gICAgICAgICAgdGhpcy5tYW5hZ2VkVm9sdW1lc1t2b2x1bWVdID0gdm9sdW1lTmFtZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZG9ja2VyUnVuLnB1c2godm9sdW1lKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBkb2NrZXJSdW4ucHVzaCh0aGlzLmltYWdlVGFnKTtcblxuICAgIGZvciAoY29uc3QgYSBvZiB0aGlzLnByb3BzLmFyZ3MgPz8gW10pIHtcbiAgICAgIGRvY2tlclJ1bi5wdXNoKGEpO1xuICAgIH1cblxuICAgIHRoaXMuYWRkVHJhY2UoXG4gICAgICBgU3RhcnRpbmcgY29udGFpbmVyIGZyb20gJHt0aGlzLmltYWdlVGFnfWAsXG4gICAgICBUcmFjZVR5cGUuUkVTT1VSQ0UsXG4gICAgICBMb2dMZXZlbC5WRVJCT1NFXG4gICAgKTtcblxuICAgIHRoaXMuY2hpbGQgPSB0aGlzLmRvY2tlclNwYXduKFwicnVuXCIsIGRvY2tlclJ1biwge1xuICAgICAgbG9nTGV2ZWw6IExvZ0xldmVsLklORk8sXG4gICAgfSk7XG5cbiAgICB0aGlzLmFkZFRyYWNlKFxuICAgICAgYFdhaXRpbmcgZm9yIGNvbnRhaW5lciB0byAke1xuICAgICAgICB0aGlzLnByb3BzLmNvbnRhaW5lclBvcnRcbiAgICAgICAgICA/IGBsaXN0ZW4gdG8gJHt0aGlzLnByb3BzLmNvbnRhaW5lclBvcnR9YFxuICAgICAgICAgIDogXCJzdGFydFwiXG4gICAgICB9YCxcbiAgICAgIFRyYWNlVHlwZS5SRVNPVVJDRSxcbiAgICAgIExvZ0xldmVsLlZFUkJPU0VcbiAgICApO1xuXG4gICAgbGV0IGhvc3RQb3J0OiBudW1iZXIgfCB1bmRlZmluZWQ7XG4gICAgYXdhaXQgd2FpdFVudGlsKGFzeW5jICgpID0+IHtcbiAgICAgIGlmICghdGhpcy5jaGlsZD8ucnVubmluZykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbnRhaW5lciAke3RoaXMuaW1hZ2VUYWd9IHN0b3BwZWQgdW5leHBlY3RlZGx5YCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGF3YWl0IHRoaXMudHJ5SW5zcGVjdCh0aGlzLmNvbnRhaW5lck5hbWUpO1xuXG4gICAgICAvLyBpZiB3ZSBhcmUgd2FpdGluZyBmb3IgYSBwb3J0LCBjaGVjayBpZiB0aGUgY29udGFpbmVyIGlzIGxpc3RlbmluZyB0byBpdFxuICAgICAgaWYgKHRoaXMucHJvcHMuY29udGFpbmVyUG9ydCkge1xuICAgICAgICBob3N0UG9ydCA9XG4gICAgICAgICAgY29udGFpbmVyPy5bMF0/Lk5ldHdvcmtTZXR0aW5ncz8uUG9ydHM/LltcbiAgICAgICAgICAgIGAke3RoaXMucHJvcHMuY29udGFpbmVyUG9ydH0vdGNwYFxuICAgICAgICAgIF0/LlswXT8uSG9zdFBvcnQ7XG5cbiAgICAgICAgcmV0dXJuIGhvc3RQb3J0ICE9PSB1bmRlZmluZWQ7XG4gICAgICB9XG5cbiAgICAgIC8vIGlmIHdlIGFyZSBub3Qgd2FpdGluZyBmb3IgYSBwb3J0LCBqdXN0IGNoZWNrIGlmIHRoZSBjb250YWluZXIgaXMgcnVubmluZ1xuICAgICAgcmV0dXJuIGNvbnRhaW5lcj8uWzBdPy5TdGF0ZT8uUnVubmluZztcbiAgICB9KTtcblxuICAgIHRoaXMuYWRkVHJhY2UoXG4gICAgICBgQ29udGFpbmVyICR7dGhpcy5pbWFnZVRhZ30gc3RhcnRlZGAsXG4gICAgICBUcmFjZVR5cGUuUkVTT1VSQ0UsXG4gICAgICBMb2dMZXZlbC5WRVJCT1NFXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICBbSE9TVF9QT1JUX0FUVFJdOiBob3N0UG9ydCxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1aWxkcyBvciBwdWxscyB0aGUgZG9ja2VyIGltYWdlIHVzZWQgYnkgdGhpcyBjb250YWluZXIuXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHByZXBhcmVJbWFnZSgpIHtcbiAgICAvLyBpZiB0aGlzIGltYWdlIGlzIGFscmVhZHkgaGVyZSwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgIGlmIChhd2FpdCB0aGlzLnRyeUluc3BlY3QodGhpcy5pbWFnZVRhZykpIHtcbiAgICAgIHRoaXMuYWRkVHJhY2UoXG4gICAgICAgIGBJbWFnZSAke3RoaXMuaW1hZ2VUYWd9IGZvdW5kLCBObyBuZWVkIHRvIGJ1aWxkIG9yIHB1bGwuYCxcbiAgICAgICAgVHJhY2VUeXBlLlJFU09VUkNFLFxuICAgICAgICBMb2dMZXZlbC5WRVJCT1NFXG4gICAgICApO1xuXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gaWYgdGhpcyBhIHJlZmVyZW5jZSB0byBhIGxvY2FsIGRpcmVjdG9yeSwgYnVpbGQgdGhlIGltYWdlIGZyb20gYSBkb2NrZXIgZmlsZVxuICAgIGlmIChpc1BhdGgodGhpcy5wcm9wcy5pbWFnZSkpIHtcbiAgICAgIHRoaXMuYWRkVHJhY2UoXG4gICAgICAgIGBCdWlsZGluZyAke3RoaXMuaW1hZ2VUYWd9IGZyb20gJHt0aGlzLnByb3BzLmltYWdlfS4uLmAsXG4gICAgICAgIFRyYWNlVHlwZS5SRVNPVVJDRSxcbiAgICAgICAgTG9nTGV2ZWwuVkVSQk9TRVxuICAgICAgKTtcbiAgICAgIGF3YWl0IHRoaXMuZG9ja2VyKFwiYnVpbGRcIiwgW1wiLXRcIiwgdGhpcy5pbWFnZVRhZywgdGhpcy5wcm9wcy5pbWFnZV0sIHtcbiAgICAgICAgbG9nTGV2ZWw6IExvZ0xldmVsLlZFUkJPU0UsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hZGRUcmFjZShcbiAgICAgICAgYFB1bGxpbmcgJHt0aGlzLmltYWdlVGFnfS4uLmAsXG4gICAgICAgIFRyYWNlVHlwZS5SRVNPVVJDRSxcbiAgICAgICAgTG9nTGV2ZWwuVkVSQk9TRVxuICAgICAgKTtcbiAgICAgIGF3YWl0IHRoaXMuZG9ja2VyKFwicHVsbFwiLCBbdGhpcy5pbWFnZVRhZ10sIHtcbiAgICAgICAgbG9nTGV2ZWw6IExvZ0xldmVsLlZFUkJPU0UsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNyZWF0ZUVudkZpbGUoKSB7XG4gICAgY29uc3QgZW52ID0gdGhpcy5wcm9wcy5lbnYgPz8ge307XG4gICAgaWYgKE9iamVjdC5rZXlzKGVudikubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGNvbnN0IGVudkZpbGUgPSBqb2luKEZzLm1rZHRlbXAoKSwgXCJlbnYuanNvblwiKTtcbiAgICBjb25zdCBlbnZMaW5lcyA9IFtdO1xuICAgIGZvciAoY29uc3QgayBvZiBPYmplY3Qua2V5cyhlbnYpKSB7XG4gICAgICBlbnZMaW5lcy5wdXNoKGAke2t9PSR7ZW52W2tdfWApO1xuICAgIH1cblxuICAgIGF3YWl0IGZzLndyaXRlRmlsZShlbnZGaWxlLCBlbnZMaW5lcy5qb2luKFwiXFxuXCIpKTtcbiAgICByZXR1cm4gZW52RmlsZTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdHJ5SW5zcGVjdChuYW1lOiBzdHJpbmcpOiBQcm9taXNlPGFueSB8IHVuZGVmaW5lZD4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShcbiAgICAgICAgYXdhaXQgdGhpcy5kb2NrZXIoXCJpbnNwZWN0XCIsIFtuYW1lXSwge1xuICAgICAgICAgIHF1aWV0OiB0cnVlLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGNsZWFudXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5hZGRUcmFjZShcbiAgICAgIGBTdG9wcGluZyBjb250YWluZXIgJHt0aGlzLmNvbnRhaW5lck5hbWV9YCxcbiAgICAgIFRyYWNlVHlwZS5SRVNPVVJDRSxcbiAgICAgIExvZ0xldmVsLlZFUkJPU0VcbiAgICApO1xuXG4gICAgYXdhaXQgdGhpcy5jaGlsZD8ua2lsbCgpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHNhdmUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5zYXZlU3RhdGUoeyBtYW5hZ2VkVm9sdW1lczogdGhpcy5tYW5hZ2VkVm9sdW1lcyB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZFN0YXRlKCk6IFByb21pc2U8U3RhdGVGaWxlQ29udGVudHM+IHtcbiAgICBjb25zdCBzdGF0ZUZpbGVFeGlzdHMgPSBhd2FpdCBleGlzdHMoXG4gICAgICBqb2luKHRoaXMuY29udGV4dC5zdGF0ZWRpciwgU1RBVEVfRklMRU5BTUUpXG4gICAgKTtcbiAgICBpZiAoc3RhdGVGaWxlRXhpc3RzKSB7XG4gICAgICBjb25zdCBzdGF0ZUZpbGVDb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKFxuICAgICAgICBqb2luKHRoaXMuY29udGV4dC5zdGF0ZWRpciwgU1RBVEVfRklMRU5BTUUpLFxuICAgICAgICBcInV0Zi04XCJcbiAgICAgICk7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShzdGF0ZUZpbGVDb250ZW50cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGRvY2tlcihcbiAgICBjb21tYW5kOiBzdHJpbmcsXG4gICAgYXJnczogc3RyaW5nW10sXG4gICAgb3B0aW9uczogRG9ja2VyT3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgY2hpbGQgPSB0aGlzLmRvY2tlclNwYXduKGNvbW1hbmQsIGFyZ3MsIG9wdGlvbnMpO1xuICAgIHJldHVybiBjaGlsZC5qb2luKCk7XG4gIH1cblxuICBwcml2YXRlIGRvY2tlclNwYXduKFxuICAgIGNvbW1hbmQ6IHN0cmluZyxcbiAgICBhcmdzOiBzdHJpbmdbXSxcbiAgICBvcHRpb25zOiBEb2NrZXJPcHRpb25zID0ge31cbiAgKTogRG9ja2VyUHJvY2VzcyB7XG4gICAgbGV0IHF1aWV0ID0gb3B0aW9ucy5xdWlldCA/PyBmYWxzZTtcbiAgICBjb25zdCBsZXZlbCA9IG9wdGlvbnMubG9nTGV2ZWwgPz8gTG9nTGV2ZWwuSU5GTztcbiAgICBjb25zdCBsb2dFcnJvcnMgPSAhcXVpZXQ7XG5cbiAgICAvLyBjYW4gYmUgdXNlZCB0byBoaWRlIGNvbnRhaW5lciBsb2dzICh1c2VkIGluIG91ciBlbmQgdG8gZW5kIHRlc3RzKS4geWVzLCB1Z2x5IGJpdCBwcmFnbWF0aWMuXG4gICAgLy8gb3RoZXJ3aXNlLCB0ZXN0IG91dHB1dCB3aWxsIGluY2x1ZGUgbG90cyBvZiBub24gZGV0ZXJtaW5pc3RpYyBzdHVmZiBhbmQgdGhhdCdzIHJlYWxseSBoYXJkIHRvXG4gICAgLy8gc25hcHNob3QuXG4gICAgaWYgKHByb2Nlc3MuZW52LldJTkdfSElERV9DT05UQUlORVJfTE9HUykge1xuICAgICAgcXVpZXQgPSB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbW1hbmREZXNjID0gYGRvY2tlciAke2NvbW1hbmR9YDtcblxuICAgIHRoaXMuYWRkVHJhY2UoXG4gICAgICBgJCAke2NvbW1hbmREZXNjfSAke2FyZ3Muam9pbihcIiBcIil9YCxcbiAgICAgIFRyYWNlVHlwZS5SRVNPVVJDRSxcbiAgICAgIExvZ0xldmVsLlZFUkJPU0VcbiAgICApO1xuXG4gICAgY29uc3QgY2hpbGQgPSBzcGF3bihcImRvY2tlclwiLCBbY29tbWFuZCwgLi4uYXJnc10sIHtcbiAgICAgIGN3ZDogdGhpcy5wcm9wcy5jd2QsXG4gICAgICBzdGRpbzogXCJwaXBlXCIsXG4gICAgfSk7XG5cbiAgICBsZXQgc3RhcnRlZCA9IHRydWU7XG5cbiAgICBjaGlsZC5vbmNlKFwiZXhpdFwiLCAoKSA9PiB7XG4gICAgICBzdGFydGVkID0gZmFsc2U7XG4gICAgfSk7XG5cbiAgICBjb25zdCBzdGRvdXQ6IEJ1ZmZlcltdID0gW107XG4gICAgY29uc3QgYWxsT3V0cHV0OiBCdWZmZXJbXSA9IFtdO1xuICAgIGNoaWxkLnN0ZG91dC5vbihcImRhdGFcIiwgKGRhdGEpID0+IHtcbiAgICAgIHN0ZG91dC5wdXNoKGRhdGEpO1xuICAgICAgYWxsT3V0cHV0LnB1c2goZGF0YSk7XG4gICAgfSk7XG5cbiAgICBjaGlsZC5zdGRlcnIub24oXCJkYXRhXCIsIChkYXRhKSA9PiB7XG4gICAgICBhbGxPdXRwdXQucHVzaChkYXRhKTtcbiAgICB9KTtcblxuICAgIGlmICghcXVpZXQpIHtcbiAgICAgIGNoaWxkLnN0ZG91dC5vbihcImRhdGFcIiwgKGRhdGEpID0+XG4gICAgICAgIHRoaXMuYWRkVHJhY2UoZGF0YS50b1N0cmluZygpLCBUcmFjZVR5cGUuTE9HLCBsZXZlbClcbiAgICAgICk7XG5cbiAgICAgIGNoaWxkLnN0ZGVyci5vbihcImRhdGFcIiwgKGRhdGEpID0+XG4gICAgICAgIHRoaXMuYWRkVHJhY2UoZGF0YS50b1N0cmluZygpLCBUcmFjZVR5cGUuTE9HLCBsZXZlbClcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY2hpbGQub25jZShcImVycm9yXCIsIChlcnIpID0+IHtcbiAgICAgIHN0YXJ0ZWQgPSBmYWxzZTtcblxuICAgICAgaWYgKGxvZ0Vycm9ycykge1xuICAgICAgICB0aGlzLmFkZFRyYWNlKGVyci5zdGFjayA/PyBlcnIubWVzc2FnZSwgVHJhY2VUeXBlLkxPRywgTG9nTGV2ZWwuRVJST1IpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICByZXR1cm4ge1xuICAgICAgZ2V0IHJ1bm5pbmcoKSB7XG4gICAgICAgIHJldHVybiBzdGFydGVkO1xuICAgICAgfSxcbiAgICAgIGFzeW5jIGtpbGwoKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgaWYgKCFzdGFydGVkKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHNlbGYuYWRkVHJhY2UoXG4gICAgICAgICAgICBcIlNlbmRpbmcgU0lHVEVSTSB0byBjb250YWluZXJcIixcbiAgICAgICAgICAgIFRyYWNlVHlwZS5SRVNPVVJDRSxcbiAgICAgICAgICAgIExvZ0xldmVsLlZFUkJPU0VcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgY2hpbGQua2lsbChcIlNJR1RFUk1cIik7XG5cbiAgICAgICAgICAvLyBpZiB0aGUgcHJvY2VzcyBkb2Vzbid0IGV4aXQgaW4gMiBzZWNvbmRzLCBraWxsIGl0XG4gICAgICAgICAgY29uc3QgdGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgc2VsZi5hZGRUcmFjZShcbiAgICAgICAgICAgICAgYFRpbWVvdXQgd2FpdGluZyBmb3IgY29udGFpbmVyICR7c2VsZi5fY29udGV4dD8ucmVzb3VyY2VQYXRofSB0byBzaHV0ZG93biwgcmVtb3ZpbmcgZm9yY2VmdWxseWAsXG4gICAgICAgICAgICAgIFRyYWNlVHlwZS5SRVNPVVJDRSxcbiAgICAgICAgICAgICAgTG9nTGV2ZWwuV0FSTklOR1xuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgc2VsZlxuICAgICAgICAgICAgICAuZG9ja2VyKFwicm1cIiwgW1wiLWZcIiwgc2VsZi5jb250YWluZXJOYW1lXSwgeyBxdWlldDogdHJ1ZSB9KVxuICAgICAgICAgICAgICAuY2F0Y2goKCkgPT4ge30pO1xuICAgICAgICAgIH0sIDIwMDApO1xuXG4gICAgICAgICAgY2hpbGQub25jZShcImVycm9yXCIsIChlcnIpID0+IHtcbiAgICAgICAgICAgIHNlbGYuYWRkVHJhY2UoXG4gICAgICAgICAgICAgIGBFcnJvciB3aGVuIHNodXR0aW5nIGRvd24gY29udGFpbmVyOiAke2Vyci5zdGFjayA/PyBlcnIubWVzc2FnZX1gLFxuICAgICAgICAgICAgICBUcmFjZVR5cGUuUkVTT1VSQ0UsXG4gICAgICAgICAgICAgIExvZ0xldmVsLkVSUk9SXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIGNoaWxkLm9uY2UoXCJleGl0XCIsICgpID0+IHtcbiAgICAgICAgICAgIHNlbGYuYWRkVHJhY2UoXG4gICAgICAgICAgICAgIFwiQ29udGFpbmVyIHNodXRkb3duIHN1Y2Nlc3NmdWxseVwiLFxuICAgICAgICAgICAgICBUcmFjZVR5cGUuUkVTT1VSQ0UsXG4gICAgICAgICAgICAgIExvZ0xldmVsLlZFUkJPU0VcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGFzeW5jIGpvaW4oKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgob2ssIGtvKSA9PiB7XG4gICAgICAgICAgaWYgKCFzdGFydGVkKSB7XG4gICAgICAgICAgICByZXR1cm4gb2soc3Rkb3V0LmpvaW4oXCJcIikpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNoaWxkLm9uY2UoXCJlcnJvclwiLCBrbyk7XG4gICAgICAgICAgY2hpbGQub25jZShcImV4aXRcIiwgKGNvZGUpID0+IHtcbiAgICAgICAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgICAgICAgIHJldHVybiBvayhzdGRvdXQuam9pbihcIlwiKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYENvbW1hbmQgXCIke2NvbW1hbmREZXNjfVwiIGV4aXRlZCB3aXRoIG5vbi16ZXJvIGNvZGUgJHtjb2RlfWA7XG4gICAgICAgICAgICAgIGlmIChsb2dFcnJvcnMpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmFkZFRyYWNlKFxuICAgICAgICAgICAgICAgICAgYCR7bWVzc2FnZX19XFxuJHthbGxPdXRwdXQuam9pbihcIlwiKX1gLFxuICAgICAgICAgICAgICAgICAgVHJhY2VUeXBlLlJFU09VUkNFLFxuICAgICAgICAgICAgICAgICAgTG9nTGV2ZWwuVkVSQk9TRVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICByZXR1cm4ga28obmV3IEVycm9yKGAke21lc3NhZ2V9IChzZWUgdmVyYm9zZSBsb2dzKWApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNhdmVTdGF0ZShzdGF0ZTogU3RhdGVGaWxlQ29udGVudHMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoXG4gICAgICBqb2luKHRoaXMuY29udGV4dC5zdGF0ZWRpciwgU1RBVEVfRklMRU5BTUUpLFxuICAgICAgSlNPTi5zdHJpbmdpZnkoc3RhdGUpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBwbGFuKCkge1xuICAgIHJldHVybiBVcGRhdGVQbGFuLkFVVE87XG4gIH1cblxuICBwcml2YXRlIGFkZFRyYWNlKG1lc3NhZ2U6IHN0cmluZywgdHlwZTogVHJhY2VUeXBlLCBsZXZlbDogTG9nTGV2ZWwpIHtcbiAgICB0aGlzLmNvbnRleHQuYWRkVHJhY2Uoe1xuICAgICAgZGF0YTogeyBtZXNzYWdlOiBtZXNzYWdlLnRyaW0oKSB9LFxuICAgICAgc291cmNlUGF0aDogdGhpcy5jb250ZXh0LnJlc291cmNlUGF0aCxcbiAgICAgIHNvdXJjZVR5cGU6IFwiY29udGFpbmVyXCIsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIHR5cGUsXG4gICAgICBsZXZlbCxcbiAgICB9KTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB3YWl0VW50aWwocHJlZGljYXRlOiAoKSA9PiBQcm9taXNlPGJvb2xlYW4+KSB7XG4gIGNvbnN0IHRpbWVvdXQgPSBEdXJhdGlvbi5mcm9tU2Vjb25kcygzMCk7XG4gIGNvbnN0IGludGVydmFsID0gRHVyYXRpb24uZnJvbVNlY29uZHMoMC4xKTtcbiAgbGV0IGVsYXBzZWQgPSAwO1xuICB3aGlsZSAoZWxhcHNlZCA8IHRpbWVvdXQuc2Vjb25kcykge1xuICAgIGlmIChhd2FpdCBwcmVkaWNhdGUoKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGVsYXBzZWQgKz0gaW50ZXJ2YWwuc2Vjb25kcztcbiAgICBhd2FpdCBVdGlsLnNsZWVwKGludGVydmFsKTtcbiAgfVxuXG4gIHRocm93IG5ldyBFcnJvcihcIlRpbWVvdXQgZWxhcHNlZFwiKTtcbn1cblxuLyoqXG4gKiBSZXByZXNlbnRzIHRoZSBkb2NrZXIgY2hpbGQgcHJvY2Vzcy5cbiAqL1xuaW50ZXJmYWNlIERvY2tlclByb2Nlc3Mge1xuICAvKipcbiAgICogV2hldGhlciB0aGUgcHJvY2VzcyBpcyBydW5uaW5nIG9yIG5vdC5cbiAgICovXG4gIHJlYWRvbmx5IHJ1bm5pbmc6IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFdhaXRzIGZvciB0aGUgcHJvY2VzcyB0byBleGl0IGFuZCByZXR1cm5zIHRoZSBvdXRwdXQuXG4gICAqIEByZXR1cm5zIFRoZSBvdXRwdXQgb2YgdGhlIHByb2Nlc3MuXG4gICAqL1xuICBqb2luOiAoKSA9PiBQcm9taXNlPHN0cmluZz47XG5cbiAgLyoqXG4gICAqIEtpbGxzIHRoZSBwcm9jZXNzLlxuICAgKi9cbiAga2lsbDogKCkgPT4gUHJvbWlzZTx2b2lkPjtcbn1cblxuaW50ZXJmYWNlIERvY2tlck9wdGlvbnMge1xuICAvKipcbiAgICogQ2FuIGJlIHVzZWQgdG8gc3VycHJlc3MgYWxsIGxvZ2dpbmcgZnJvbSB0aGUgY29tbWFuZC5cbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IHF1aWV0PzogYm9vbGVhbjtcblxuICAvKipcbiAgICogVGhlIGxvZyBsZXZlbCB0byB1c2UgZm9yIGNvbnRhaW5lciBvdXRwdXQgKGJvdGggU1RET1VUIGFuZCBTVERFUlIgd2lsbCB1c2UgdGhlIHNhbWUgbG9nIGxldmVsKS5cbiAgICogQGRlZmF1bHQgTG9nTGV2ZWwuSU5GT1xuICAgKi9cbiAgcmVhZG9ubHkgbG9nTGV2ZWw/OiBMb2dMZXZlbDtcbn1cbiJdfQ==