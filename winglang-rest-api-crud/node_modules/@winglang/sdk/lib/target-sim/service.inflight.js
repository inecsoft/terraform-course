"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Service = void 0;
const path_1 = require("path");
const cloud_1 = require("../cloud");
const sandbox_1 = require("../shared/sandbox");
const simulator_1 = require("../simulator");
const std_1 = require("../std");
class Service {
    constructor(props) {
        this.running = false;
        this.sourceCodeFile = props.sourceCodeFile;
        this.autoStart = props.autoStart;
        this.environmentVariables = props.environmentVariables ?? {};
    }
    get context() {
        if (!this._context) {
            throw new Error("Cannot access context during class construction");
        }
        return this._context;
    }
    async createBundle() {
        this.bundle = await sandbox_1.Sandbox.createBundle(this.resolvedSourceCodeFile, (msg, level) => {
            this.addTrace(msg, std_1.TraceType.RESOURCE, level);
        });
    }
    async init(context) {
        this._context = context;
        this.resolvedSourceCodeFile = (0, path_1.resolve)(context.simdir, this.sourceCodeFile);
        this.createBundlePromise = this.createBundle();
        if (this.autoStart) {
            await this.start();
        }
        return {};
    }
    async cleanup() {
        await this.createBundlePromise;
        await this.stop();
    }
    async save() { }
    async plan() {
        // for now, always replace because we can't determine if the function code
        // has changed since the last update. see https://github.com/winglang/wing/issues/6116
        return simulator_1.UpdatePlan.REPLACE;
    }
    async start() {
        // Do nothing if service is already running.
        if (this.running) {
            return;
        }
        await this.createBundlePromise;
        if (!this.bundle) {
            this.addTrace("Failed to start service: bundle is not created", std_1.TraceType.RESOURCE, std_1.LogLevel.ERROR);
            return;
        }
        this.sandbox = new sandbox_1.Sandbox(this.bundle.outfilePath, {
            env: {
                ...this.environmentVariables,
                WING_SIMULATOR_URL: this.context.serverUrl,
                WING_SIMULATOR_CALLER: this.context.resourceHandle,
            },
            log: (internal, level, message) => {
                this.addTrace(message, internal ? std_1.TraceType.SIMULATOR : std_1.TraceType.LOG, level);
            },
        });
        try {
            await this.sandbox.call("start");
            this.running = true;
        }
        catch (e) {
            this.addTrace(`Failed to start service: ${e.message}`, std_1.TraceType.RESOURCE, std_1.LogLevel.ERROR);
        }
    }
    async stop() {
        // Do nothing if service is already stopped.
        if (!this.running || !this.sandbox) {
            return;
        }
        try {
            this.running = false;
            await this.createBundlePromise;
            await this.sandbox.call("stop");
            await this.sandbox.cleanup();
        }
        catch (e) {
            this.addTrace(`Failed to stop service: ${e.message} ${e.stack}`, std_1.TraceType.RESOURCE, std_1.LogLevel.ERROR);
        }
    }
    async started() {
        return this.running;
    }
    addTrace(message, type, level) {
        this.context.addTrace({
            data: { message },
            type,
            sourcePath: this.context.resourcePath,
            sourceType: cloud_1.SERVICE_FQN,
            timestamp: new Date().toISOString(),
            level,
        });
    }
}
exports.Service = Service;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5pbmZsaWdodC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90YXJnZXQtc2ltL3NlcnZpY2UuaW5mbGlnaHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQStCO0FBRS9CLG9DQUF1RDtBQUV2RCwrQ0FBNEM7QUFDNUMsNENBSXNCO0FBQ3RCLGdDQUE2QztBQUU3QyxNQUFhLE9BQU87SUFXbEIsWUFBWSxLQUFvQjtRQUp4QixZQUFPLEdBQVksS0FBSyxDQUFDO1FBSy9CLElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQztRQUMzQyxJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDakMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEtBQUssQ0FBQyxvQkFBb0IsSUFBSSxFQUFFLENBQUM7SUFDL0QsQ0FBQztJQUVELElBQVksT0FBTztRQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsaURBQWlELENBQUMsQ0FBQztRQUNyRSxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyxLQUFLLENBQUMsWUFBWTtRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxZQUFZLENBQ3RDLElBQUksQ0FBQyxzQkFBc0IsRUFDM0IsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDYixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxlQUFTLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2hELENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBMEI7UUFDMUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxDQUFDLHNCQUFzQixHQUFHLElB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QUFFLEVBQ2pELGVBQVMsQ0FBQyxRQUFRLEVBQ2xCLGNBQVEsQ0FBQyxLQUFLLENBQ2YsQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0lBRU0sS0FBSyxDQUFDLE9BQU87UUFDbEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFFTyxRQUFRLENBQUMsT0FBZSxFQUFFLElBQWUsRUFBRSxLQUFlO1FBQ2hFLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDO1lBQ3BCLElBQUksRUFBRSxFQUFFLE9BQU8sRUFBRTtZQUNqQixJQUFJO1lBQ0osVUFBVSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWTtZQUNyQyxVQUFVLEVBQUUsbUJBQVc7WUFDdkIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1lBQ25DLEtBQUs7U0FDTixDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUF0SUQsMEJBc0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVzb2x2ZSB9IGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBTZXJ2aWNlQXR0cmlidXRlcywgU2VydmljZVNjaGVtYSB9IGZyb20gXCIuL3NjaGVtYS1yZXNvdXJjZXNcIjtcbmltcG9ydCB7IElTZXJ2aWNlQ2xpZW50LCBTRVJWSUNFX0ZRTiB9IGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0IHsgQnVuZGxlIH0gZnJvbSBcIi4uL3NoYXJlZC9idW5kbGluZ1wiO1xuaW1wb3J0IHsgU2FuZGJveCB9IGZyb20gXCIuLi9zaGFyZWQvc2FuZGJveFwiO1xuaW1wb3J0IHtcbiAgSVNpbXVsYXRvckNvbnRleHQsXG4gIElTaW11bGF0b3JSZXNvdXJjZUluc3RhbmNlLFxuICBVcGRhdGVQbGFuLFxufSBmcm9tIFwiLi4vc2ltdWxhdG9yXCI7XG5pbXBvcnQgeyBMb2dMZXZlbCwgVHJhY2VUeXBlIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG5leHBvcnQgY2xhc3MgU2VydmljZSBpbXBsZW1lbnRzIElTZXJ2aWNlQ2xpZW50LCBJU2ltdWxhdG9yUmVzb3VyY2VJbnN0YW5jZSB7XG4gIHByaXZhdGUgX2NvbnRleHQ6IElTaW11bGF0b3JDb250ZXh0IHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIHJlYWRvbmx5IHNvdXJjZUNvZGVGaWxlOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgYXV0b1N0YXJ0OiBib29sZWFuO1xuICBwcml2YXRlIHJlc29sdmVkU291cmNlQ29kZUZpbGUhOiBzdHJpbmc7XG4gIHByaXZhdGUgc2FuZGJveDogU2FuZGJveCB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBidW5kbGU6IEJ1bmRsZSB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBydW5uaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgZW52aXJvbm1lbnRWYXJpYWJsZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIHByaXZhdGUgY3JlYXRlQnVuZGxlUHJvbWlzZSE6IFByb21pc2U8dm9pZD47XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IFNlcnZpY2VTY2hlbWEpIHtcbiAgICB0aGlzLnNvdXJjZUNvZGVGaWxlID0gcHJvcHMuc291cmNlQ29kZUZpbGU7XG4gICAgdGhpcy5hdXRvU3RhcnQgPSBwcm9wcy5hdXRvU3RhcnQ7XG4gICAgdGhpcy5lbnZpcm9ubWVudFZhcmlhYmxlcyA9IHByb3BzLmVudmlyb25tZW50VmFyaWFibGVzID8/IHt9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgY29udGV4dCgpOiBJU2ltdWxhdG9yQ29udGV4dCB7XG4gICAgaWYgKCF0aGlzLl9jb250ZXh0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgYWNjZXNzIGNvbnRleHQgZHVyaW5nIGNsYXNzIGNvbnN0cnVjdGlvblwiKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2NvbnRleHQ7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNyZWF0ZUJ1bmRsZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmJ1bmRsZSA9IGF3YWl0IFNhbmRib3guY3JlYXRlQnVuZGxlKFxuICAgICAgdGhpcy5yZXNvbHZlZFNvdXJjZUNvZGVGaWxlLFxuICAgICAgKG1zZywgbGV2ZWwpID0+IHtcbiAgICAgICAgdGhpcy5hZGRUcmFjZShtc2csIFRyYWNlVHlwZS5SRVNPVVJDRSwgbGV2ZWwpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5pdChjb250ZXh0OiBJU2ltdWxhdG9yQ29udGV4dCk6IFByb21pc2U8U2VydmljZUF0dHJpYnV0ZXM+IHtcbiAgICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDtcbiAgICB0aGlzLnJlc29sdmVkU291cmNlQ29kZUZpbGUgPSByZXNvbHZlKGNvbnRleHQuc2ltZGlyLCB0aGlzLnNvdXJjZUNvZGVGaWxlKTtcbiAgICB0aGlzLmNyZWF0ZUJ1bmRsZVByb21pc2UgPSB0aGlzLmNyZWF0ZUJ1bmRsZSgpO1xuICAgIGlmICh0aGlzLmF1dG9TdGFydCkge1xuICAgICAgYXdhaXQgdGhpcy5zdGFydCgpO1xuICAgIH1cbiAgICByZXR1cm4ge307XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY2xlYW51cCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUJ1bmRsZVByb21pc2U7XG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2F2ZSgpOiBQcm9taXNlPHZvaWQ+IHt9XG5cbiAgcHVibGljIGFzeW5jIHBsYW4oKTogUHJvbWlzZTxVcGRhdGVQbGFuPiB7XG4gICAgLy8gZm9yIG5vdywgYWx3YXlzIHJlcGxhY2UgYmVjYXVzZSB3ZSBjYW4ndCBkZXRlcm1pbmUgaWYgdGhlIGZ1bmN0aW9uIGNvZGVcbiAgICAvLyBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCB1cGRhdGUuIHNlZSBodHRwczovL2dpdGh1Yi5jb20vd2luZ2xhbmcvd2luZy9pc3N1ZXMvNjExNlxuICAgIHJldHVybiBVcGRhdGVQbGFuLlJFUExBQ0U7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RhcnQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gRG8gbm90aGluZyBpZiBzZXJ2aWNlIGlzIGFscmVhZHkgcnVubmluZy5cbiAgICBpZiAodGhpcy5ydW5uaW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5jcmVhdGVCdW5kbGVQcm9taXNlO1xuXG4gICAgaWYgKCF0aGlzLmJ1bmRsZSkge1xuICAgICAgdGhpcy5hZGRUcmFjZShcbiAgICAgICAgXCJGYWlsZWQgdG8gc3RhcnQgc2VydmljZTogYnVuZGxlIGlzIG5vdCBjcmVhdGVkXCIsXG4gICAgICAgIFRyYWNlVHlwZS5SRVNPVVJDRSxcbiAgICAgICAgTG9nTGV2ZWwuRVJST1JcbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5zYW5kYm94ID0gbmV3IFNhbmRib3godGhpcy5idW5kbGUub3V0ZmlsZVBhdGgsIHtcbiAgICAgIGVudjoge1xuICAgICAgICAuLi50aGlzLmVudmlyb25tZW50VmFyaWFibGVzLFxuICAgICAgICBXSU5HX1NJTVVMQVRPUl9VUkw6IHRoaXMuY29udGV4dC5zZXJ2ZXJVcmwsXG4gICAgICAgIFdJTkdfU0lNVUxBVE9SX0NBTExFUjogdGhpcy5jb250ZXh0LnJlc291cmNlSGFuZGxlLFxuICAgICAgfSxcbiAgICAgIGxvZzogKGludGVybmFsLCBsZXZlbCwgbWVzc2FnZSkgPT4ge1xuICAgICAgICB0aGlzLmFkZFRyYWNlKFxuICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgaW50ZXJuYWwgPyBUcmFjZVR5cGUuU0lNVUxBVE9SIDogVHJhY2VUeXBlLkxPRyxcbiAgICAgICAgICBsZXZlbFxuICAgICAgICApO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnNhbmRib3guY2FsbChcInN0YXJ0XCIpO1xuICAgICAgdGhpcy5ydW5uaW5nID0gdHJ1ZTtcbiAgICB9IGNhdGNoIChlOiBhbnkpIHtcbiAgICAgIHRoaXMuYWRkVHJhY2UoXG4gICAgICAgIGBGYWlsZWQgdG8gc3RhcnQgc2VydmljZTogJHtlLm1lc3NhZ2V9YCxcbiAgICAgICAgVHJhY2VUeXBlLlJFU09VUkNFLFxuICAgICAgICBMb2dMZXZlbC5FUlJPUlxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RvcCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBEbyBub3RoaW5nIGlmIHNlcnZpY2UgaXMgYWxyZWFkeSBzdG9wcGVkLlxuICAgIGlmICghdGhpcy5ydW5uaW5nIHx8ICF0aGlzLnNhbmRib3gpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7XG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZUJ1bmRsZVByb21pc2U7XG4gICAgICBhd2FpdCB0aGlzLnNhbmRib3guY2FsbChcInN0b3BcIik7XG4gICAgICBhd2FpdCB0aGlzLnNhbmRib3guY2xlYW51cCgpO1xuICAgIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgICAgdGhpcy5hZGRUcmFjZShcbiAgICAgICAgYEZhaWxlZCB0byBzdG9wIHNlcnZpY2U6ICR7ZS5tZXNzYWdlfSAke2Uuc3RhY2t9YCxcbiAgICAgICAgVHJhY2VUeXBlLlJFU09VUkNFLFxuICAgICAgICBMb2dMZXZlbC5FUlJPUlxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RhcnRlZCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5ydW5uaW5nO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRUcmFjZShtZXNzYWdlOiBzdHJpbmcsIHR5cGU6IFRyYWNlVHlwZSwgbGV2ZWw6IExvZ0xldmVsKSB7XG4gICAgdGhpcy5jb250ZXh0LmFkZFRyYWNlKHtcbiAgICAgIGRhdGE6IHsgbWVzc2FnZSB9LFxuICAgICAgdHlwZSxcbiAgICAgIHNvdXJjZVBhdGg6IHRoaXMuY29udGV4dC5yZXNvdXJjZVBhdGgsXG4gICAgICBzb3VyY2VUeXBlOiBTRVJWSUNFX0ZRTixcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgbGV2ZWwsXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==