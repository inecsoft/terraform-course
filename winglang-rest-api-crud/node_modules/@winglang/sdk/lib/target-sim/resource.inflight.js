"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Resource = void 0;
const path = __importStar(require("path"));
const resource_1 = require("./resource");
const sandbox_1 = require("../shared/sandbox");
const simulator_1 = require("../simulator");
const std_1 = require("../std");
class Resource {
    constructor(props) {
        this.timeout = 30000;
        this.sourceCodeFile = props.sourceCodeFile;
    }
    get context() {
        if (!this._context) {
            throw new Error("Cannot access context during class construction");
        }
        return this._context;
    }
    async createBundle() {
        this.bundle = await sandbox_1.Sandbox.createBundle(this.resolvedSourceCodeFile, (msg, level) => {
            this.addTrace(msg, std_1.TraceType.RESOURCE, level);
        });
    }
    async init(context) {
        this._context = context;
        this.resolvedSourceCodeFile = path.resolve(context.simdir, this.sourceCodeFile);
        await this.createBundle();
        this.sandbox = new sandbox_1.Sandbox(this.bundle.outfilePath, {
            env: {
                WING_SIMULATOR_URL: this.context.serverUrl,
                WING_SIMULATOR_CALLER: this.context.resourceHandle,
            },
            log: (internal, level, message) => {
                this.addTrace(message, internal ? std_1.TraceType.SIMULATOR : std_1.TraceType.LOG, level);
            },
            // A resource needs to respond to method calls in a timely manner since
            // the simulator server will wait for a response before responding to
            // the caller. The default timeout is 30 seconds.
            timeout: this.timeout,
        });
        // We're communicating with the sandbox via IPC. It's not possible to pass
        // an IResourceContext object directly because methods like `resolveToken`
        // are not serializable. So instead, a fake ctx object is created within the
        // inflight wrapper code - see `resource.ts`.
        try {
            const attrs = await this.sandbox.call("start", this.context.statedir);
            return attrs;
        }
        catch (err) {
            this.context.addTrace({
                data: {
                    message: "Error initializing resource",
                    status: "failure",
                    error: err,
                },
                type: std_1.TraceType.LOG,
                level: std_1.LogLevel.ERROR,
                sourcePath: this.context.resourcePath,
                sourceType: resource_1.SIM_RESOURCE_FQN,
                timestamp: new Date().toISOString(),
            });
            return {};
        }
    }
    async cleanup() {
        try {
            // TODO: set a timeout for the stop call
            while (true) {
                try {
                    return await this.sandbox.call("stop");
                }
                catch (err) {
                    if (err instanceof sandbox_1.SandboxMultipleConcurrentCallsError) {
                        // If the sandbox is busy, wait and try again
                        this.addTrace("Sandbox is busy, waiting and retrying...", std_1.TraceType.SIMULATOR, std_1.LogLevel.VERBOSE);
                        await new Promise((resolve) => setTimeout(resolve, 100));
                    }
                    else {
                        throw err;
                    }
                }
            }
        }
        catch (err) {
            this.context.addTrace({
                data: {
                    message: "Error calling onStop",
                    status: "failure",
                    error: err,
                },
                type: std_1.TraceType.LOG,
                level: std_1.LogLevel.ERROR,
                sourcePath: this.context.resourcePath,
                sourceType: resource_1.SIM_RESOURCE_FQN,
                timestamp: new Date().toISOString(),
            });
        }
        finally {
            await this.sandbox.cleanup();
        }
    }
    async save() { }
    async plan() {
        // TODO: support other update plans
        return simulator_1.UpdatePlan.REPLACE;
    }
    async call(method, args = []) {
        return this.context.withTrace({
            activity: async () => {
                // TODO: If requests take a long time for a resource to process,
                // we may end up passing requests to the sandbox after they have
                // timed out. We should consider adding a timeout to the call method
                // here or track the request's response deadline in some way.
                while (true) {
                    try {
                        return await this.sandbox.call("call", method, ...args);
                    }
                    catch (err) {
                        if (err instanceof sandbox_1.SandboxMultipleConcurrentCallsError) {
                            // If the sandbox is busy, wait and try again
                            this.addTrace("Sandbox is busy, waiting and retrying...", std_1.TraceType.SIMULATOR, std_1.LogLevel.VERBOSE);
                            await new Promise((resolve) => setTimeout(resolve, 100));
                        }
                        else if (err instanceof sandbox_1.SandboxTimeoutError) {
                            throw new Error(`Call to resource "${this.context.resourcePath}" timed out after ${this.timeout}ms`);
                        }
                        else {
                            throw err;
                        }
                    }
                }
            },
            message: this.formatCallMessage(method, args),
        });
    }
    formatCallMessage(method, args) {
        let message = method.toString();
        message += "(";
        for (let i = 0; i < args.length; i++) {
            let arg = args[i];
            if (arg === null || arg === undefined) {
                message += "nil";
            }
            else {
                message += JSON.stringify(args[i]);
            }
            if (i < args.length - 1) {
                message += ", ";
            }
        }
        message += ")";
        return message;
    }
    addTrace(message, type, level) {
        this.context.addTrace({
            data: { message, level },
            type,
            level: level ?? std_1.LogLevel.INFO,
            sourcePath: this.context.resourcePath,
            sourceType: resource_1.SIM_RESOURCE_FQN,
            timestamp: new Date().toISOString(),
        });
    }
}
exports.Resource = Resource;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UuaW5mbGlnaHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXNpbS9yZXNvdXJjZS5pbmZsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE2QjtBQUM3Qix5Q0FBK0Q7QUFHL0QsK0NBSTJCO0FBQzNCLDRDQUlzQjtBQUN0QixnQ0FBbUQ7QUFFbkQsTUFBYSxRQUFRO0lBUW5CLFlBQVksS0FBd0I7UUFGbkIsWUFBTyxHQUFHLEtBQU0sQ0FBQztRQUdoQyxJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUM7SUFDN0MsQ0FBQztJQUVELElBQVksT0FBTztRQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMsaURBQWlELENBQUMsQ0FBQztRQUNyRSxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyxLQUFLLENBQUMsWUFBWTtRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxZQUFZLENBQ3RDLElBQUksQ0FBQyxzQkFBc0IsRUFDM0IsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDYixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxlQUFTLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2hELENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJLENBQ2YsT0FBMEI7UUFFMUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQyxPQUFPLENBQ3hDLE9BQU8sQ0FBQyxNQUFNLEVBQ2QsSUFBSSxDQUFDLGNBQWMsQ0FDcEIsQ0FBQztRQUNGLE1BQU0sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxpQkFBTyxDQUFDLElBQUksQ0FBQyxNQUFPLENBQUMsV0FBVyxFQUFFO1lBQ25ELEdBQUcsRUFBRTtnQkFDSCxrQkFBa0IsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVM7Z0JBQzFDLHFCQUFxQixFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYzthQUNuRDtZQUNELEdBQUcsRUFBRSxDQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEVBQUU7Z0JBQ2hDLElBQUksQ0FBQyxRQUFRLENBQ1gsT0FBTyxFQUNQLFFBQVEsQ0FBQyxDQUFDLENBQUMsZUFBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsZUFBUyxDQUFDLEdBQUcsRUFDOUMsS0FBSyxDQUNOLENBQUM7WUFDSixDQUFDO1lBQ0QsdUVBQXVFO1lBQ3ZFLHFFQUFxRTtZQUNyRSxpREFBaUQ7WUFDakQsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO1NBQ3RCLENBQUMsQ0FBQztRQUVILDBFQUEwRTtRQUMxRSwwRUFBMEU7UUFDMUUsNEVBQTRFO1FBQzVFLDZDQUE2QztRQUM3QyxJQUFJLENBQUM7WUFDSCxNQUFNLEtBQUssR0FBMkIsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FDM0QsT0FBTyxFQUNQLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUN0QixDQUFDO1lBQ0YsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNiLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDO2dCQUNwQixJQUFJLEVBQUU7b0JBQ0osT0FBTyxFQUFFLDZCQUE2QjtvQkFDdEMsTUFBTSxFQUFFLFNBQVM7b0JBQ2pCLEtBQUssRUFBRSxHQUFHO2lCQUNYO2dCQUNELElBQUksRUFBRSxlQUFTLENBQUMsR0FBRztnQkFDbkIsS0FBSyxFQUFFLGNBQVEsQ0FBQyxLQUFLO2dCQUNyQixVQUFVLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZO2dCQUNyQyxVQUFVLEVBQUUsMkJBQWdCO2dCQUM1QixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7YUFDcEMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO0lBQ0gsQ0FBQztJQUVNLEtBQUssQ0FBQyxPQUFPO1FBQ2xCLElBQUksQ0FBQztZQUNILHdDQUF3QztZQUN4QyxPQUFPLElBQUksRUFBRSxDQUFDO2dCQUNaLElBQUksQ0FBQztvQkFDSCxPQUFPLE1BQU0sSUFBSSxDQUFDLE9BQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQzFDLENBQUM7Z0JBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztvQkFDYixJQUFJLEdBQUcsWUFBWSw2Q0FBbUMsRUFBRSxDQUFDO3dCQUN2RCw2Q0FBNkM7d0JBQzdDLElBQUksQ0FBQyxRQUFRLENBQ1gsMENBQTBDLEVBQzFDLGVBQVMsQ0FBQyxTQUFTLEVBQ25CLGNBQVEsQ0FBQyxPQUFPLENBQ2pCLENBQUM7d0JBQ0YsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUMzRCxDQUFDO3lCQUFNLENBQUM7d0JBQ04sTUFBTSxHQUFHLENBQUM7b0JBQ1osQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ2IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUM7Z0JBQ3BCLElBQUksRUFBRTtvQkFDSixPQUFPLEVBQUUsc0JBQXNCO29CQUMvQixNQUFNLEVBQUUsU0FBUztvQkFDakIsS0FBSyxFQUFFLEdBQUc7aUJBQ1g7Z0JBQ0QsSUFBSSxFQUFFLGVBQVMsQ0FBQyxHQUFHO2dCQUNuQixLQUFLLEVBQUUsY0FBUSxDQUFDLEtBQUs7Z0JBQ3JCLFVBQVUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVk7Z0JBQ3JDLFVBQVUsRUFBRSwyQkFBZ0I7Z0JBQzVCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTthQUNwQyxDQUFDLENBQUM7UUFDTCxDQUFDO2dCQUFTLENBQUM7WUFDVCxNQUFNLElBQUksQ0FBQyxPQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDaEMsQ0FBQztJQUNILENBQUM7SUFFTSxLQUFLLENBQUMsSUFBSSxLQUFtQixDQUFDO0lBRTlCLEtBQUssQ0FBQyxJQUFJO1FBQ2YsbUNBQW1DO1FBQ25DLE9BQU8sc0JBQVUsQ0FBQyxPQUFPLENBQUM7SUFDNUIsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBYyxFQUFFLE9BQW9CLEVBQUU7UUFDdEQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztZQUM1QixRQUFRLEVBQUUsS0FBSyxJQUFJLEVBQUU7Z0JBQ25CLGdFQUFnRTtnQkFDaEUsZ0VBQWdFO2dCQUNoRSxvRUFBb0U7Z0JBQ3BFLDZEQUE2RDtnQkFDN0QsT0FBTyxJQUFJLEVBQUUsQ0FBQztvQkFDWixJQUFJLENBQUM7d0JBQ0gsT0FBTyxNQUFNLElBQUksQ0FBQyxPQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztvQkFDM0QsQ0FBQztvQkFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO3dCQUNiLElBQUksR0FBRyxZQUFZLDZDQUFtQyxFQUFFLENBQUM7NEJBQ3ZELDZDQUE2Qzs0QkFDN0MsSUFBSSxDQUFDLFFBQVEsQ0FDWCwwQ0FBMEMsRUFDMUMsZUFBUyxDQUFDLFNBQVMsRUFDbkIsY0FBUSxDQUFDLE9BQU8sQ0FDakIsQ0FBQzs0QkFDRixNQUFNLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7d0JBQzNELENBQUM7NkJBQU0sSUFBSSxHQUFHLFlBQVksNkJBQW1CLEVBQUUsQ0FBQzs0QkFDOUMsTUFBTSxJQUFJLEtBQUssQ0FDYixxQkFBcUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLHFCQUFxQixJQUFJLENBQUMsT0FBTyxJQUFJLENBQ3BGLENBQUM7d0JBQ0osQ0FBQzs2QkFBTSxDQUFDOzRCQUNOLE1BQU0sR0FBRyxDQUFDO3dCQUNaLENBQUM7b0JBQ0gsQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQztZQUNELE9BQU8sRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQztTQUM5QyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8saUJBQWlCLENBQUMsTUFBYyxFQUFFLElBQWlCO1FBQ3pELElBQUksT0FBTyxHQUFHLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQyxPQUFPLElBQUksR0FBRyxDQUFDO1FBQ2YsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNyQyxJQUFJLEdBQUcsR0FBRyxJQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxHQUFHLEtBQUssSUFBSSxJQUFJLEdBQUcsS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDdEMsT0FBTyxJQUFJLEtBQUssQ0FBQztZQUNuQixDQUFDO2lCQUFNLENBQUM7Z0JBQ04sT0FBTyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEMsQ0FBQztZQUNELElBQUksQ0FBQyxHQUFHLElBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3pCLE9BQU8sSUFBSSxJQUFJLENBQUM7WUFDbEIsQ0FBQztRQUNILENBQUM7UUFDRCxPQUFPLElBQUksR0FBRyxDQUFDO1FBQ2YsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVPLFFBQVEsQ0FBQyxPQUFlLEVBQUUsSUFBZSxFQUFFLEtBQWdCO1FBQ2pFLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDO1lBQ3BCLElBQUksRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUU7WUFDeEIsSUFBSTtZQUNKLEtBQUssRUFBRSxLQUFLLElBQUksY0FBUSxDQUFDLElBQUk7WUFDN0IsVUFBVSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWTtZQUNyQyxVQUFVLEVBQUUsMkJBQWdCO1lBQzVCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUNwQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUE1TEQsNEJBNExDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgSVJlc291cmNlQ2xpZW50LCBTSU1fUkVTT1VSQ0VfRlFOIH0gZnJvbSBcIi4vcmVzb3VyY2VcIjtcbmltcG9ydCB7IFNpbVJlc291cmNlQXR0cmlidXRlcywgU2ltUmVzb3VyY2VTY2hlbWEgfSBmcm9tIFwiLi9zY2hlbWEtcmVzb3VyY2VzXCI7XG5pbXBvcnQgeyBCdW5kbGUgfSBmcm9tIFwiLi4vc2hhcmVkL2J1bmRsaW5nXCI7XG5pbXBvcnQge1xuICBTYW5kYm94TXVsdGlwbGVDb25jdXJyZW50Q2FsbHNFcnJvcixcbiAgU2FuZGJveCxcbiAgU2FuZGJveFRpbWVvdXRFcnJvcixcbn0gZnJvbSBcIi4uL3NoYXJlZC9zYW5kYm94XCI7XG5pbXBvcnQge1xuICBJU2ltdWxhdG9yQ29udGV4dCxcbiAgSVNpbXVsYXRvclJlc291cmNlSW5zdGFuY2UsXG4gIFVwZGF0ZVBsYW4sXG59IGZyb20gXCIuLi9zaW11bGF0b3JcIjtcbmltcG9ydCB7IEpzb24sIExvZ0xldmVsLCBUcmFjZVR5cGUgfSBmcm9tIFwiLi4vc3RkXCI7XG5cbmV4cG9ydCBjbGFzcyBSZXNvdXJjZSBpbXBsZW1lbnRzIElSZXNvdXJjZUNsaWVudCwgSVNpbXVsYXRvclJlc291cmNlSW5zdGFuY2Uge1xuICBwcml2YXRlIF9jb250ZXh0OiBJU2ltdWxhdG9yQ29udGV4dCB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSByZWFkb25seSBzb3VyY2VDb2RlRmlsZTogc3RyaW5nO1xuICBwcml2YXRlIHJlc29sdmVkU291cmNlQ29kZUZpbGUhOiBzdHJpbmc7XG4gIHByaXZhdGUgc2FuZGJveDogU2FuZGJveCB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBidW5kbGU6IEJ1bmRsZSB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSByZWFkb25seSB0aW1lb3V0ID0gMzBfMDAwO1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBTaW1SZXNvdXJjZVNjaGVtYSkge1xuICAgIHRoaXMuc291cmNlQ29kZUZpbGUgPSBwcm9wcy5zb3VyY2VDb2RlRmlsZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGNvbnRleHQoKTogSVNpbXVsYXRvckNvbnRleHQge1xuICAgIGlmICghdGhpcy5fY29udGV4dCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGFjY2VzcyBjb250ZXh0IGR1cmluZyBjbGFzcyBjb25zdHJ1Y3Rpb25cIik7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9jb250ZXh0O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVCdW5kbGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5idW5kbGUgPSBhd2FpdCBTYW5kYm94LmNyZWF0ZUJ1bmRsZShcbiAgICAgIHRoaXMucmVzb2x2ZWRTb3VyY2VDb2RlRmlsZSxcbiAgICAgIChtc2csIGxldmVsKSA9PiB7XG4gICAgICAgIHRoaXMuYWRkVHJhY2UobXNnLCBUcmFjZVR5cGUuUkVTT1VSQ0UsIGxldmVsKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGluaXQoXG4gICAgY29udGV4dDogSVNpbXVsYXRvckNvbnRleHRcbiAgKTogUHJvbWlzZTxTaW1SZXNvdXJjZUF0dHJpYnV0ZXM+IHtcbiAgICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDtcbiAgICB0aGlzLnJlc29sdmVkU291cmNlQ29kZUZpbGUgPSBwYXRoLnJlc29sdmUoXG4gICAgICBjb250ZXh0LnNpbWRpcixcbiAgICAgIHRoaXMuc291cmNlQ29kZUZpbGVcbiAgICApO1xuICAgIGF3YWl0IHRoaXMuY3JlYXRlQnVuZGxlKCk7XG4gICAgdGhpcy5zYW5kYm94ID0gbmV3IFNhbmRib3godGhpcy5idW5kbGUhLm91dGZpbGVQYXRoLCB7XG4gICAgICBlbnY6IHtcbiAgICAgICAgV0lOR19TSU1VTEFUT1JfVVJMOiB0aGlzLmNvbnRleHQuc2VydmVyVXJsLFxuICAgICAgICBXSU5HX1NJTVVMQVRPUl9DQUxMRVI6IHRoaXMuY29udGV4dC5yZXNvdXJjZUhhbmRsZSxcbiAgICAgIH0sXG4gICAgICBsb2c6IChpbnRlcm5hbCwgbGV2ZWwsIG1lc3NhZ2UpID0+IHtcbiAgICAgICAgdGhpcy5hZGRUcmFjZShcbiAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgIGludGVybmFsID8gVHJhY2VUeXBlLlNJTVVMQVRPUiA6IFRyYWNlVHlwZS5MT0csXG4gICAgICAgICAgbGV2ZWxcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgICAvLyBBIHJlc291cmNlIG5lZWRzIHRvIHJlc3BvbmQgdG8gbWV0aG9kIGNhbGxzIGluIGEgdGltZWx5IG1hbm5lciBzaW5jZVxuICAgICAgLy8gdGhlIHNpbXVsYXRvciBzZXJ2ZXIgd2lsbCB3YWl0IGZvciBhIHJlc3BvbnNlIGJlZm9yZSByZXNwb25kaW5nIHRvXG4gICAgICAvLyB0aGUgY2FsbGVyLiBUaGUgZGVmYXVsdCB0aW1lb3V0IGlzIDMwIHNlY29uZHMuXG4gICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgfSk7XG5cbiAgICAvLyBXZSdyZSBjb21tdW5pY2F0aW5nIHdpdGggdGhlIHNhbmRib3ggdmlhIElQQy4gSXQncyBub3QgcG9zc2libGUgdG8gcGFzc1xuICAgIC8vIGFuIElSZXNvdXJjZUNvbnRleHQgb2JqZWN0IGRpcmVjdGx5IGJlY2F1c2UgbWV0aG9kcyBsaWtlIGByZXNvbHZlVG9rZW5gXG4gICAgLy8gYXJlIG5vdCBzZXJpYWxpemFibGUuIFNvIGluc3RlYWQsIGEgZmFrZSBjdHggb2JqZWN0IGlzIGNyZWF0ZWQgd2l0aGluIHRoZVxuICAgIC8vIGluZmxpZ2h0IHdyYXBwZXIgY29kZSAtIHNlZSBgcmVzb3VyY2UudHNgLlxuICAgIHRyeSB7XG4gICAgICBjb25zdCBhdHRyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IGF3YWl0IHRoaXMuc2FuZGJveC5jYWxsKFxuICAgICAgICBcInN0YXJ0XCIsXG4gICAgICAgIHRoaXMuY29udGV4dC5zdGF0ZWRpclxuICAgICAgKTtcbiAgICAgIHJldHVybiBhdHRycztcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuY29udGV4dC5hZGRUcmFjZSh7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICBtZXNzYWdlOiBcIkVycm9yIGluaXRpYWxpemluZyByZXNvdXJjZVwiLFxuICAgICAgICAgIHN0YXR1czogXCJmYWlsdXJlXCIsXG4gICAgICAgICAgZXJyb3I6IGVycixcbiAgICAgICAgfSxcbiAgICAgICAgdHlwZTogVHJhY2VUeXBlLkxPRyxcbiAgICAgICAgbGV2ZWw6IExvZ0xldmVsLkVSUk9SLFxuICAgICAgICBzb3VyY2VQYXRoOiB0aGlzLmNvbnRleHQucmVzb3VyY2VQYXRoLFxuICAgICAgICBzb3VyY2VUeXBlOiBTSU1fUkVTT1VSQ0VfRlFOLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjbGVhbnVwKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBUT0RPOiBzZXQgYSB0aW1lb3V0IGZvciB0aGUgc3RvcCBjYWxsXG4gICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnNhbmRib3ghLmNhbGwoXCJzdG9wXCIpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgU2FuZGJveE11bHRpcGxlQ29uY3VycmVudENhbGxzRXJyb3IpIHtcbiAgICAgICAgICAgIC8vIElmIHRoZSBzYW5kYm94IGlzIGJ1c3ksIHdhaXQgYW5kIHRyeSBhZ2FpblxuICAgICAgICAgICAgdGhpcy5hZGRUcmFjZShcbiAgICAgICAgICAgICAgXCJTYW5kYm94IGlzIGJ1c3ksIHdhaXRpbmcgYW5kIHJldHJ5aW5nLi4uXCIsXG4gICAgICAgICAgICAgIFRyYWNlVHlwZS5TSU1VTEFUT1IsXG4gICAgICAgICAgICAgIExvZ0xldmVsLlZFUkJPU0VcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy5jb250ZXh0LmFkZFRyYWNlKHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIG1lc3NhZ2U6IFwiRXJyb3IgY2FsbGluZyBvblN0b3BcIixcbiAgICAgICAgICBzdGF0dXM6IFwiZmFpbHVyZVwiLFxuICAgICAgICAgIGVycm9yOiBlcnIsXG4gICAgICAgIH0sXG4gICAgICAgIHR5cGU6IFRyYWNlVHlwZS5MT0csXG4gICAgICAgIGxldmVsOiBMb2dMZXZlbC5FUlJPUixcbiAgICAgICAgc291cmNlUGF0aDogdGhpcy5jb250ZXh0LnJlc291cmNlUGF0aCxcbiAgICAgICAgc291cmNlVHlwZTogU0lNX1JFU09VUkNFX0ZRTixcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICB9KTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYXdhaXQgdGhpcy5zYW5kYm94IS5jbGVhbnVwKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNhdmUoKTogUHJvbWlzZTx2b2lkPiB7fVxuXG4gIHB1YmxpYyBhc3luYyBwbGFuKCk6IFByb21pc2U8VXBkYXRlUGxhbj4ge1xuICAgIC8vIFRPRE86IHN1cHBvcnQgb3RoZXIgdXBkYXRlIHBsYW5zXG4gICAgcmV0dXJuIFVwZGF0ZVBsYW4uUkVQTEFDRTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjYWxsKG1ldGhvZDogc3RyaW5nLCBhcmdzOiBBcnJheTxKc29uPiA9IFtdKTogUHJvbWlzZTxKc29uPiB7XG4gICAgcmV0dXJuIHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgYWN0aXZpdHk6IGFzeW5jICgpID0+IHtcbiAgICAgICAgLy8gVE9ETzogSWYgcmVxdWVzdHMgdGFrZSBhIGxvbmcgdGltZSBmb3IgYSByZXNvdXJjZSB0byBwcm9jZXNzLFxuICAgICAgICAvLyB3ZSBtYXkgZW5kIHVwIHBhc3NpbmcgcmVxdWVzdHMgdG8gdGhlIHNhbmRib3ggYWZ0ZXIgdGhleSBoYXZlXG4gICAgICAgIC8vIHRpbWVkIG91dC4gV2Ugc2hvdWxkIGNvbnNpZGVyIGFkZGluZyBhIHRpbWVvdXQgdG8gdGhlIGNhbGwgbWV0aG9kXG4gICAgICAgIC8vIGhlcmUgb3IgdHJhY2sgdGhlIHJlcXVlc3QncyByZXNwb25zZSBkZWFkbGluZSBpbiBzb21lIHdheS5cbiAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2FuZGJveCEuY2FsbChcImNhbGxcIiwgbWV0aG9kLCAuLi5hcmdzKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTYW5kYm94TXVsdGlwbGVDb25jdXJyZW50Q2FsbHNFcnJvcikge1xuICAgICAgICAgICAgICAvLyBJZiB0aGUgc2FuZGJveCBpcyBidXN5LCB3YWl0IGFuZCB0cnkgYWdhaW5cbiAgICAgICAgICAgICAgdGhpcy5hZGRUcmFjZShcbiAgICAgICAgICAgICAgICBcIlNhbmRib3ggaXMgYnVzeSwgd2FpdGluZyBhbmQgcmV0cnlpbmcuLi5cIixcbiAgICAgICAgICAgICAgICBUcmFjZVR5cGUuU0lNVUxBVE9SLFxuICAgICAgICAgICAgICAgIExvZ0xldmVsLlZFUkJPU0VcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwKSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGVyciBpbnN0YW5jZW9mIFNhbmRib3hUaW1lb3V0RXJyb3IpIHtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIGBDYWxsIHRvIHJlc291cmNlIFwiJHt0aGlzLmNvbnRleHQucmVzb3VyY2VQYXRofVwiIHRpbWVkIG91dCBhZnRlciAke3RoaXMudGltZW91dH1tc2BcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBtZXNzYWdlOiB0aGlzLmZvcm1hdENhbGxNZXNzYWdlKG1ldGhvZCwgYXJncyksXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGZvcm1hdENhbGxNZXNzYWdlKG1ldGhvZDogc3RyaW5nLCBhcmdzOiBBcnJheTxKc29uPik6IHN0cmluZyB7XG4gICAgbGV0IG1lc3NhZ2UgPSBtZXRob2QudG9TdHJpbmcoKTtcbiAgICBtZXNzYWdlICs9IFwiKFwiO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IGFyZyA9IGFyZ3MhW2ldO1xuICAgICAgaWYgKGFyZyA9PT0gbnVsbCB8fCBhcmcgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBtZXNzYWdlICs9IFwibmlsXCI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtZXNzYWdlICs9IEpTT04uc3RyaW5naWZ5KGFyZ3MhW2ldKTtcbiAgICAgIH1cbiAgICAgIGlmIChpIDwgYXJncyEubGVuZ3RoIC0gMSkge1xuICAgICAgICBtZXNzYWdlICs9IFwiLCBcIjtcbiAgICAgIH1cbiAgICB9XG4gICAgbWVzc2FnZSArPSBcIilcIjtcbiAgICByZXR1cm4gbWVzc2FnZTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVHJhY2UobWVzc2FnZTogc3RyaW5nLCB0eXBlOiBUcmFjZVR5cGUsIGxldmVsPzogTG9nTGV2ZWwpIHtcbiAgICB0aGlzLmNvbnRleHQuYWRkVHJhY2Uoe1xuICAgICAgZGF0YTogeyBtZXNzYWdlLCBsZXZlbCB9LFxuICAgICAgdHlwZSxcbiAgICAgIGxldmVsOiBsZXZlbCA/PyBMb2dMZXZlbC5JTkZPLFxuICAgICAgc291cmNlUGF0aDogdGhpcy5jb250ZXh0LnJlc291cmNlUGF0aCxcbiAgICAgIHNvdXJjZVR5cGU6IFNJTV9SRVNPVVJDRV9GUU4sXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICB9KTtcbiAgfVxufVxuIl19