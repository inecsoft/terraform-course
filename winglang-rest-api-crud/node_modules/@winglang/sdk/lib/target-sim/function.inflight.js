"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Function = void 0;
const promises_1 = require("fs/promises");
const path = __importStar(require("path"));
const cloud_1 = require("../cloud");
const sandbox_1 = require("../shared/sandbox");
const simulator_1 = require("../simulator/simulator");
const std_1 = require("../std");
class Function {
    constructor(props) {
        this.workers = new Array();
        this.sourceCodeFile = props.sourceCodeFile;
        if (props.sourceCodeLanguage !== "javascript") {
            throw new Error("Only JavaScript is supported");
        }
        this.env = props.environmentVariables ?? {};
        this.timeout = props.timeout;
        this.maxWorkers = props.concurrency;
    }
    get context() {
        if (!this._context) {
            throw new Error("Cannot access context during class construction");
        }
        return this._context;
    }
    async init(context) {
        this._context = context;
        this.originalFile = path.resolve(context.simdir, this.sourceCodeFile);
        this.createBundlePromise = this.createBundle();
        return {};
    }
    async cleanup() {
        // We wait for the bundle to be created since there's no way to otherwise cancel the work.
        // If the simulator runs for a short time (and cloud.Function is created and then deleted)
        // and the bundling code is allowed to run after the simulator has stopped, it might fail
        // and throw an error to the user because the files the simulator was using may no longer be there there.
        await this.createBundlePromise;
        await Promise.allSettled(this.workers.map((w) => w.cleanup()));
    }
    async save() { }
    async plan(invalidated) {
        // If our function config changed, always replace
        if (invalidated) {
            return simulator_1.UpdatePlan.REPLACE;
        }
        // Make sure that we don't have an ongoing bundle operation
        await this.ensureBundled();
        // Check if any of the bundled files have changed since the last bundling
        const inputFiles = this.bundle.inputFiles;
        const modifiedFiles = await filesModifiedSince(inputFiles, process.cwd(), this.bundle.time);
        if (modifiedFiles.length > 0) {
            this.addTrace(`Files modified since last bundling: [${modifiedFiles
                .map((x) => `"${x}"`)
                .join(", ")}]`, std_1.TraceType.SIMULATOR, std_1.LogLevel.VERBOSE);
            return simulator_1.UpdatePlan.REPLACE;
        }
        return simulator_1.UpdatePlan.SKIP;
    }
    async invoke(payload) {
        return this.context.withTrace({
            message: `Invoke (payload=${JSON.stringify(payload)}).`,
            activity: async () => {
                const worker = await this.findAvailableWorker();
                if (!worker) {
                    throw new Error("Too many requests, the function has reached its concurrency limit.");
                }
                try {
                    return await worker.call("handler", payload);
                }
                catch (err) {
                    if (err instanceof sandbox_1.SandboxTimeoutError) {
                        throw new Error(`Function timed out (it was configured with a timeout of ${this.timeout}ms).`);
                    }
                    else {
                        throw err;
                    }
                }
            },
        });
    }
    async invokeAsync(payload) {
        await this.context.withTrace({
            message: `InvokeAsync (payload=${JSON.stringify(payload)}).`,
            activity: async () => {
                const worker = await this.findAvailableWorker();
                if (!worker) {
                    throw new Error("Too many requests, the function has reached its concurrency limit.");
                }
                process.nextTick(() => {
                    void worker.call("handler", payload).catch((e) => {
                        // If the call fails, we log the error and continue since we've already
                        // handed control back to the caller.
                        this.context.addTrace({
                            data: {
                                message: `InvokeAsync (payload=${JSON.stringify(payload)}) failure.`,
                                status: "failure",
                                error: e,
                            },
                            type: std_1.TraceType.LOG,
                            level: std_1.LogLevel.ERROR,
                            sourcePath: this.context.resourcePath,
                            sourceType: cloud_1.FUNCTION_FQN,
                            timestamp: new Date().toISOString(),
                        });
                    });
                });
            },
        });
    }
    async createBundle() {
        this.bundle = await sandbox_1.Sandbox.createBundle(this.originalFile, (msg, level) => {
            this.addTrace(msg, std_1.TraceType.RESOURCE, level);
        });
    }
    async ensureBundled() {
        await this.createBundlePromise;
        if (!this.bundle) {
            throw new Error("Bundle not created");
        }
    }
    // Used internally by cloud.Queue to apply backpressure
    async hasAvailableWorkers() {
        return (this.workers.length < this.maxWorkers ||
            this.workers.some((w) => w.isAvailable()));
    }
    async findAvailableWorker() {
        const worker = this.workers.find((w) => w.isAvailable());
        if (worker) {
            return worker;
        }
        if (this.workers.length < this.maxWorkers) {
            const newWorker = await this.initWorker();
            this.workers.push(newWorker);
            return newWorker;
        }
        return undefined;
    }
    async initWorker() {
        // ensure inflight code is bundled before we create any workers
        await this.ensureBundled();
        return new sandbox_1.Sandbox(this.bundle.outfilePath, {
            env: {
                ...this.env,
                WING_SIMULATOR_CALLER: this.context.resourceHandle,
                WING_SIMULATOR_URL: this.context.serverUrl,
            },
            timeout: this.timeout,
            log: (internal, level, message) => {
                this.addTrace(message, internal ? std_1.TraceType.SIMULATOR : std_1.TraceType.LOG, level);
            },
        });
    }
    addTrace(message, type, level) {
        this.context.addTrace({
            data: { message },
            type,
            level,
            sourcePath: this.context.resourcePath,
            sourceType: cloud_1.FUNCTION_FQN,
            timestamp: new Date().toISOString(),
        });
    }
}
exports.Function = Function;
async function filesModifiedSince(filePaths, directory, dateTime) {
    const absolutePaths = filePaths.map((filePath) => path.resolve(directory, filePath));
    try {
        const statsPromises = absolutePaths.map((filePath) => (0, promises_1.stat)(filePath));
        const stats = await Promise.all(statsPromises);
        const changedFiles = new Array();
        for (let i = 0; i < absolutePaths.length; i++) {
            if (stats[i].mtime > dateTime) {
                changedFiles.push(absolutePaths[i]);
            }
        }
        return changedFiles;
    }
    catch (error) {
        console.error("Error checking file modification times:", error);
        throw error;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb24uaW5mbGlnaHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXNpbS9mdW5jdGlvbi5pbmZsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDBDQUFtQztBQUNuQywyQ0FBNkI7QUFFN0Isb0NBQXlEO0FBRXpELCtDQUFpRTtBQUNqRSxzREFJZ0M7QUFDaEMsZ0NBQTZDO0FBRTdDLE1BQWEsUUFBUTtJQVduQixZQUFZLEtBQXFCO1FBSGhCLFlBQU8sR0FBRyxJQUFJLEtBQUssRUFBVyxDQUFDO1FBSTlDLElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQztRQUMzQyxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsS0FBSyxZQUFZLEVBQUUsQ0FBQztZQUM5QyxNQUFNLElBQUksS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUM7UUFDbEQsQ0FBQztRQUNELElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLG9CQUFvQixJQUFJLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDN0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxJQUFZLE9BQU87UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBRU0sS0FBSyxDQUFDLElBQUksQ0FBQyxPQUEwQjtRQUMxQyxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFB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LENBQUM7UUFDSCxNQUFNLGFBQWEsR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxJQUFBLGVBQUksRUFBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sS0FBSyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMvQyxNQUFNLFlBQVksR0FBRyxJQUFJLEtBQUssRUFBVSxDQUFDO1FBRXpDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDOUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLFFBQVEsRUFBRSxDQUFDO2dCQUM5QixZQUFZLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHlDQUF5QyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sS0FBSyxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzdGF0IH0gZnJvbSBcImZzL3Byb21pc2VzXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBGdW5jdGlvbkF0dHJpYnV0ZXMsIEZ1bmN0aW9uU2NoZW1hIH0gZnJvbSBcIi4vc2NoZW1hLXJlc291cmNlc1wiO1xuaW1wb3J0IHsgRlVOQ1RJT05fRlFOLCBJRnVuY3Rpb25DbGllbnQgfSBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCB7IEJ1bmRsZSB9IGZyb20gXCIuLi9zaGFyZWQvYnVuZGxpbmdcIjtcbmltcG9ydCB7IFNhbmRib3gsIFNhbmRib3hUaW1lb3V0RXJyb3IgfSBmcm9tIFwiLi4vc2hhcmVkL3NhbmRib3hcIjtcbmltcG9ydCB7XG4gIElTaW11bGF0b3JDb250ZXh0LFxuICBJU2ltdWxhdG9yUmVzb3VyY2VJbnN0YW5jZSxcbiAgVXBkYXRlUGxhbixcbn0gZnJvbSBcIi4uL3NpbXVsYXRvci9zaW11bGF0b3JcIjtcbmltcG9ydCB7IExvZ0xldmVsLCBUcmFjZVR5cGUgfSBmcm9tIFwiLi4vc3RkXCI7XG5cbmV4cG9ydCBjbGFzcyBGdW5jdGlvbiBpbXBsZW1lbnRzIElGdW5jdGlvbkNsaWVudCwgSVNpbXVsYXRvclJlc291cmNlSW5zdGFuY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IHNvdXJjZUNvZGVGaWxlOiBzdHJpbmc7XG4gIHByaXZhdGUgb3JpZ2luYWxGaWxlITogc3RyaW5nO1xuICBwcml2YXRlIGJ1bmRsZTogQnVuZGxlIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIHJlYWRvbmx5IGVudjogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgcHJpdmF0ZSBfY29udGV4dDogSVNpbXVsYXRvckNvbnRleHQgfCB1bmRlZmluZWQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgdGltZW91dDogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IG1heFdvcmtlcnM6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSB3b3JrZXJzID0gbmV3IEFycmF5PFNhbmRib3g+KCk7XG4gIHByaXZhdGUgY3JlYXRlQnVuZGxlUHJvbWlzZSE6IFByb21pc2U8dm9pZD47XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IEZ1bmN0aW9uU2NoZW1hKSB7XG4gICAgdGhpcy5zb3VyY2VDb2RlRmlsZSA9IHByb3BzLnNvdXJjZUNvZGVGaWxlO1xuICAgIGlmIChwcm9wcy5zb3VyY2VDb2RlTGFuZ3VhZ2UgIT09IFwiamF2YXNjcmlwdFwiKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJPbmx5IEphdmFTY3JpcHQgaXMgc3VwcG9ydGVkXCIpO1xuICAgIH1cbiAgICB0aGlzLmVudiA9IHByb3BzLmVudmlyb25tZW50VmFyaWFibGVzID8/IHt9O1xuICAgIHRoaXMudGltZW91dCA9IHByb3BzLnRpbWVvdXQ7XG4gICAgdGhpcy5tYXhXb3JrZXJzID0gcHJvcHMuY29uY3VycmVuY3k7XG4gIH1cblxuICBwcml2YXRlIGdldCBjb250ZXh0KCk6IElTaW11bGF0b3JDb250ZXh0IHtcbiAgICBpZiAoIXRoaXMuX2NvbnRleHQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBhY2Nlc3MgY29udGV4dCBkdXJpbmcgY2xhc3MgY29uc3RydWN0aW9uXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fY29udGV4dDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBpbml0KGNvbnRleHQ6IElTaW11bGF0b3JDb250ZXh0KTogUHJvbWlzZTxGdW5jdGlvbkF0dHJpYnV0ZXM+IHtcbiAgICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDtcbiAgICB0aGlzLm9yaWdpbmFsRmlsZSA9IHBhdGgucmVzb2x2ZShjb250ZXh0LnNpbWRpciwgdGhpcy5zb3VyY2VDb2RlRmlsZSk7XG4gICAgdGhpcy5jcmVhdGVCdW5kbGVQcm9taXNlID0gdGhpcy5jcmVhdGVCdW5kbGUoKTtcbiAgICByZXR1cm4ge307XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY2xlYW51cCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBXZSB3YWl0IGZvciB0aGUgYnVuZGxlIHRvIGJlIGNyZWF0ZWQgc2luY2UgdGhlcmUncyBubyB3YXkgdG8gb3RoZXJ3aXNlIGNhbmNlbCB0aGUgd29yay5cbiAgICAvLyBJZiB0aGUgc2ltdWxhdG9yIHJ1bnMgZm9yIGEgc2hvcnQgdGltZSAoYW5kIGNsb3VkLkZ1bmN0aW9uIGlzIGNyZWF0ZWQgYW5kIHRoZW4gZGVsZXRlZClcbiAgICAvLyBhbmQgdGhlIGJ1bmRsaW5nIGNvZGUgaXMgYWxsb3dlZCB0byBydW4gYWZ0ZXIgdGhlIHNpbXVsYXRvciBoYXMgc3RvcHBlZCwgaXQgbWlnaHQgZmFpbFxuICAgIC8vIGFuZCB0aHJvdyBhbiBlcnJvciB0byB0aGUgdXNlciBiZWNhdXNlIHRoZSBmaWxlcyB0aGUgc2ltdWxhdG9yIHdhcyB1c2luZyBtYXkgbm8gbG9uZ2VyIGJlIHRoZXJlIHRoZXJlLlxuICAgIGF3YWl0IHRoaXMuY3JlYXRlQnVuZGxlUHJvbWlzZTtcbiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQodGhpcy53b3JrZXJzLm1hcCgodykgPT4gdy5jbGVhbnVwKCkpKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzYXZlKCk6IFByb21pc2U8dm9pZD4ge31cblxuICBwdWJsaWMgYXN5bmMgcGxhbihpbnZhbGlkYXRlZDogYm9vbGVhbik6IFByb21pc2U8VXBkYXRlUGxhbj4ge1xuICAgIC8vIElmIG91ciBmdW5jdGlvbiBjb25maWcgY2hhbmdlZCwgYWx3YXlzIHJlcGxhY2VcbiAgICBpZiAoaW52YWxpZGF0ZWQpIHtcbiAgICAgIHJldHVybiBVcGRhdGVQbGFuLlJFUExBQ0U7XG4gICAgfVxuXG4gICAgLy8gTWFrZSBzdXJlIHRoYXQgd2UgZG9uJ3QgaGF2ZSBhbiBvbmdvaW5nIGJ1bmRsZSBvcGVyYXRpb25cbiAgICBhd2FpdCB0aGlzLmVuc3VyZUJ1bmRsZWQoKTtcblxuICAgIC8vIENoZWNrIGlmIGFueSBvZiB0aGUgYnVuZGxlZCBmaWxlcyBoYXZlIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYnVuZGxpbmdcbiAgICBjb25zdCBpbnB1dEZpbGVzID0gdGhpcy5idW5kbGUhLmlucHV0RmlsZXM7XG4gICAgY29uc3QgbW9kaWZpZWRGaWxlcyA9IGF3YWl0IGZpbGVzTW9kaWZpZWRTaW5jZShcbiAgICAgIGlucHV0RmlsZXMsXG4gICAgICBwcm9jZXNzLmN3ZCgpLFxuICAgICAgdGhpcy5idW5kbGUhLnRpbWVcbiAgICApO1xuICAgIGlmIChtb2RpZmllZEZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuYWRkVHJhY2UoXG4gICAgICAgIGBGaWxlcyBtb2RpZmllZCBzaW5jZSBsYXN0IGJ1bmRsaW5nOiBbJHttb2RpZmllZEZpbGVzXG4gICAgICAgICAgLm1hcCgoeCkgPT4gYFwiJHt4fVwiYClcbiAgICAgICAgICAuam9pbihcIiwgXCIpfV1gLFxuICAgICAgICBUcmFjZVR5cGUuU0lNVUxBVE9SLFxuICAgICAgICBMb2dMZXZlbC5WRVJCT1NFXG4gICAgICApO1xuICAgICAgcmV0dXJuIFVwZGF0ZVBsYW4uUkVQTEFDRTtcbiAgICB9XG5cbiAgICByZXR1cm4gVXBkYXRlUGxhbi5TS0lQO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGludm9rZShwYXlsb2FkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHQud2l0aFRyYWNlKHtcbiAgICAgIG1lc3NhZ2U6IGBJbnZva2UgKHBheWxvYWQ9JHtKU09OLnN0cmluZ2lmeShwYXlsb2FkKX0pLmAsXG4gICAgICBhY3Rpdml0eTogYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCB3b3JrZXIgPSBhd2FpdCB0aGlzLmZpbmRBdmFpbGFibGVXb3JrZXIoKTtcbiAgICAgICAgaWYgKCF3b3JrZXIpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBcIlRvbyBtYW55IHJlcXVlc3RzLCB0aGUgZnVuY3Rpb24gaGFzIHJlYWNoZWQgaXRzIGNvbmN1cnJlbmN5IGxpbWl0LlwiXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgIHJldHVybiBhd2FpdCB3b3JrZXIuY2FsbChcImhhbmRsZXJcIiwgcGF5bG9hZCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTYW5kYm94VGltZW91dEVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgIGBGdW5jdGlvbiB0aW1lZCBvdXQgKGl0IHdhcyBjb25maWd1cmVkIHdpdGggYSB0aW1lb3V0IG9mICR7dGhpcy50aW1lb3V0fW1zKS5gXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGludm9rZUFzeW5jKHBheWxvYWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgbWVzc2FnZTogYEludm9rZUFzeW5jIChwYXlsb2FkPSR7SlNPTi5zdHJpbmdpZnkocGF5bG9hZCl9KS5gLFxuICAgICAgYWN0aXZpdHk6IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgd29ya2VyID0gYXdhaXQgdGhpcy5maW5kQXZhaWxhYmxlV29ya2VyKCk7XG4gICAgICAgIGlmICghd29ya2VyKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgXCJUb28gbWFueSByZXF1ZXN0cywgdGhlIGZ1bmN0aW9uIGhhcyByZWFjaGVkIGl0cyBjb25jdXJyZW5jeSBsaW1pdC5cIlxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgICAgdm9pZCB3b3JrZXIuY2FsbChcImhhbmRsZXJcIiwgcGF5bG9hZCkuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgIC8vIElmIHRoZSBjYWxsIGZhaWxzLCB3ZSBsb2cgdGhlIGVycm9yIGFuZCBjb250aW51ZSBzaW5jZSB3ZSd2ZSBhbHJlYWR5XG4gICAgICAgICAgICAvLyBoYW5kZWQgY29udHJvbCBiYWNrIHRvIHRoZSBjYWxsZXIuXG4gICAgICAgICAgICB0aGlzLmNvbnRleHQuYWRkVHJhY2Uoe1xuICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYEludm9rZUFzeW5jIChwYXlsb2FkPSR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgICAgICAgICBwYXlsb2FkXG4gICAgICAgICAgICAgICAgKX0pIGZhaWx1cmUuYCxcbiAgICAgICAgICAgICAgICBzdGF0dXM6IFwiZmFpbHVyZVwiLFxuICAgICAgICAgICAgICAgIGVycm9yOiBlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB0eXBlOiBUcmFjZVR5cGUuTE9HLFxuICAgICAgICAgICAgICBsZXZlbDogTG9nTGV2ZWwuRVJST1IsXG4gICAgICAgICAgICAgIHNvdXJjZVBhdGg6IHRoaXMuY29udGV4dC5yZXNvdXJjZVBhdGgsXG4gICAgICAgICAgICAgIHNvdXJjZVR5cGU6IEZVTkNUSU9OX0ZRTixcbiAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVCdW5kbGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5idW5kbGUgPSBhd2FpdCBTYW5kYm94LmNyZWF0ZUJ1bmRsZShcbiAgICAgIHRoaXMub3JpZ2luYWxGaWxlLFxuICAgICAgKG1zZywgbGV2ZWwpID0+IHtcbiAgICAgICAgdGhpcy5hZGRUcmFjZShtc2csIFRyYWNlVHlwZS5SRVNPVVJDRSwgbGV2ZWwpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGVuc3VyZUJ1bmRsZWQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5jcmVhdGVCdW5kbGVQcm9taXNlO1xuICAgIGlmICghdGhpcy5idW5kbGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkJ1bmRsZSBub3QgY3JlYXRlZFwiKTtcbiAgICB9XG4gIH1cblxuICAvLyBVc2VkIGludGVybmFsbHkgYnkgY2xvdWQuUXVldWUgdG8gYXBwbHkgYmFja3ByZXNzdXJlXG4gIHB1YmxpYyBhc3luYyBoYXNBdmFpbGFibGVXb3JrZXJzKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLndvcmtlcnMubGVuZ3RoIDwgdGhpcy5tYXhXb3JrZXJzIHx8XG4gICAgICB0aGlzLndvcmtlcnMuc29tZSgodykgPT4gdy5pc0F2YWlsYWJsZSgpKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZpbmRBdmFpbGFibGVXb3JrZXIoKTogUHJvbWlzZTxTYW5kYm94IHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3Qgd29ya2VyID0gdGhpcy53b3JrZXJzLmZpbmQoKHcpID0+IHcuaXNBdmFpbGFibGUoKSk7XG4gICAgaWYgKHdvcmtlcikge1xuICAgICAgcmV0dXJuIHdvcmtlcjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy53b3JrZXJzLmxlbmd0aCA8IHRoaXMubWF4V29ya2Vycykge1xuICAgICAgY29uc3QgbmV3V29ya2VyID0gYXdhaXQgdGhpcy5pbml0V29ya2VyKCk7XG4gICAgICB0aGlzLndvcmtlcnMucHVzaChuZXdXb3JrZXIpO1xuICAgICAgcmV0dXJuIG5ld1dvcmtlcjtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBpbml0V29ya2VyKCk6IFByb21pc2U8U2FuZGJveD4ge1xuICAgIC8vIGVuc3VyZSBpbmZsaWdodCBjb2RlIGlzIGJ1bmRsZWQgYmVmb3JlIHdlIGNyZWF0ZSBhbnkgd29ya2Vyc1xuICAgIGF3YWl0IHRoaXMuZW5zdXJlQnVuZGxlZCgpO1xuXG4gICAgcmV0dXJuIG5ldyBTYW5kYm94KHRoaXMuYnVuZGxlIS5vdXRmaWxlUGF0aCwge1xuICAgICAgZW52OiB7XG4gICAgICAgIC4uLnRoaXMuZW52LFxuICAgICAgICBXSU5HX1NJTVVMQVRPUl9DQUxMRVI6IHRoaXMuY29udGV4dC5yZXNvdXJjZUhhbmRsZSxcbiAgICAgICAgV0lOR19TSU1VTEFUT1JfVVJMOiB0aGlzLmNvbnRleHQuc2VydmVyVXJsLFxuICAgICAgfSxcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICAgIGxvZzogKGludGVybmFsLCBsZXZlbCwgbWVzc2FnZSkgPT4ge1xuICAgICAgICB0aGlzLmFkZFRyYWNlKFxuICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgaW50ZXJuYWwgPyBUcmFjZVR5cGUuU0lNVUxBVE9SIDogVHJhY2VUeXBlLkxPRyxcbiAgICAgICAgICBsZXZlbFxuICAgICAgICApO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVHJhY2UobWVzc2FnZTogc3RyaW5nLCB0eXBlOiBUcmFjZVR5cGUsIGxldmVsOiBMb2dMZXZlbCkge1xuICAgIHRoaXMuY29udGV4dC5hZGRUcmFjZSh7XG4gICAgICBkYXRhOiB7IG1lc3NhZ2UgfSxcbiAgICAgIHR5cGUsXG4gICAgICBsZXZlbCxcbiAgICAgIHNvdXJjZVBhdGg6IHRoaXMuY29udGV4dC5yZXNvdXJjZVBhdGgsXG4gICAgICBzb3VyY2VUeXBlOiBGVU5DVElPTl9GUU4sXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICB9KTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBmaWxlc01vZGlmaWVkU2luY2UoXG4gIGZpbGVQYXRoczogc3RyaW5nW10sXG4gIGRpcmVjdG9yeTogc3RyaW5nLFxuICBkYXRlVGltZTogRGF0ZVxuKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICBjb25zdCBhYnNvbHV0ZVBhdGhzID0gZmlsZVBhdGhzLm1hcCgoZmlsZVBhdGgpID0+XG4gICAgcGF0aC5yZXNvbHZlKGRpcmVjdG9yeSwgZmlsZVBhdGgpXG4gICk7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBzdGF0c1Byb21pc2VzID0gYWJzb2x1dGVQYXRocy5tYXAoKGZpbGVQYXRoKSA9PiBzdGF0KGZpbGVQYXRoKSk7XG4gICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBQcm9taXNlLmFsbChzdGF0c1Byb21pc2VzKTtcbiAgICBjb25zdCBjaGFuZ2VkRmlsZXMgPSBuZXcgQXJyYXk8c3RyaW5nPigpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhYnNvbHV0ZVBhdGhzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoc3RhdHNbaV0ubXRpbWUgPiBkYXRlVGltZSkge1xuICAgICAgICBjaGFuZ2VkRmlsZXMucHVzaChhYnNvbHV0ZVBhdGhzW2ldKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY2hhbmdlZEZpbGVzO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBjaGVja2luZyBmaWxlIG1vZGlmaWNhdGlvbiB0aW1lczpcIiwgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59XG4iXX0=