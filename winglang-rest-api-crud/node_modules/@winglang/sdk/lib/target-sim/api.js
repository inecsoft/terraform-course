"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Api = void 0;
const app_1 = require("./app");
const event_mapping_1 = require("./event-mapping");
const policy_1 = require("./policy");
const tokens_1 = require("./tokens");
const util_1 = require("./util");
const cloud_1 = require("../cloud");
const cloud = __importStar(require("../cloud"));
const core_1 = require("../core");
const std_1 = require("../std");
/**
 * Simulator implementation of `cloud.Api`.
 *
 * @inflight `@winglang/sdk.cloud.IApiClient`
 */
class Api extends cloud.Api {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        this.handlers = {};
        this.endpoint = new cloud.Endpoint(this, "Endpoint", (0, tokens_1.simulatorAttrToken)(this, "url"), { label: `Api ${this.node.path}` });
        std_1.Node.of(this.endpoint).hidden = true;
        this.policy = new policy_1.Policy(this, "Policy", { principal: this });
    }
    get _endpoint() {
        return this.endpoint;
    }
    createOrGetFunction(inflight, props, pathPattern, method) {
        let handler = this.handlers[inflight._id];
        if (handler) {
            const routes = handler.mapping.eventProps.subscriptionProps
                .routes;
            routes.push({
                pathPattern,
                method,
            });
            return handler.func;
        }
        const functionHandler = (0, core_1.lift)({ handler: inflight }).inflight(async (ctx, event) => {
            if (!event) {
                throw new Error("invalid API request event");
            }
            let req = JSON.parse(event);
            const response = await ctx.handler(req);
            if (!response) {
                return undefined;
            }
            else {
                return JSON.stringify(response);
            }
        });
        const fn = new cloud_1.Function(this, app_1.App.of(this).makeId(this, "OnRequestHandler"), functionHandler, props);
        std_1.Node.of(fn).sourceModule = std_1.SDK_SOURCE_MODULE;
        std_1.Node.of(fn).title = `${method.toUpperCase()} ${pathPattern}`;
        std_1.Node.of(fn).hidden = true;
        const eventMapping = new event_mapping_1.EventMapping(this, app_1.App.of(this).makeId(this, "ApiEventMapping"), {
            publisher: this,
            subscriber: fn,
            subscriptionProps: {
                routes: [
                    {
                        pathPattern,
                        method,
                    },
                ],
            },
        });
        this.handlers[inflight._id] = {
            func: fn,
            mapping: eventMapping,
        };
        return fn;
    }
    addEndpoint(path, method, inflight, props) {
        this._validatePath(path);
        this._addToSpec(path, method, undefined, this.corsOptions);
        const fn = this.createOrGetFunction(inflight, props, path, method);
        std_1.Node.of(this).addConnection({
            source: this,
            sourceOp: cloud.ApiInflightMethods.REQUEST,
            target: fn,
            targetOp: cloud.FunctionInflightMethods.INVOKE,
            name: `${method.toLowerCase()} ${path}`,
        });
        this.policy.addStatement(fn, cloud.FunctionInflightMethods.INVOKE);
    }
    /**
     * Add a inflight to handle GET requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    get(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.GET, inflight, props);
    }
    /**
     * Add a inflight to handle POST requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    post(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.POST, inflight, props);
    }
    /**
     * Add a inflight to handle PUT requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    put(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.PUT, inflight, props);
    }
    /**
     * Add a inflight to handle DELETE requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    delete(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.DELETE, inflight, props);
    }
    /**
     * Add a inflight to handle PATCH requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    patch(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.PATCH, inflight, props);
    }
    /**
     * Add a inflight to handle OPTIONS requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    options(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.OPTIONS, inflight, props);
    }
    /**
     * Add a inflight to handle HEAD requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    head(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.HEAD, inflight, props);
    }
    /**
     * Add a inflight to handle CONNECT requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    connect(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.CONNECT, inflight, props);
    }
    toSimulator() {
        const props = {
            openApiSpec: this._getOpenApiSpec(),
            corsHeaders: cloud.Api.renderCorsHeaders(this.corsOptions),
        };
        return {
            type: cloud.API_FQN,
            props,
        };
    }
    onLift(host, ops) {
        (0, util_1.bindSimulatorResource)(__filename, this, host, ops);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return (0, util_1.makeSimulatorJsClient)(__filename, this);
    }
}
exports.Api = Api;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC1zaW0vYXBpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsK0JBQTRCO0FBQzVCLG1EQUErQztBQUMvQyxxQ0FBa0M7QUFHbEMscUNBQThDO0FBQzlDLGlDQUFzRTtBQUN0RSxvQ0FBb0M7QUFDcEMsZ0RBQWtDO0FBQ2xDLGtDQUErQjtBQUUvQixnQ0FBZ0U7QUFFaEU7Ozs7R0FJRztBQUNILE1BQWEsR0FBSSxTQUFRLEtBQUssQ0FBQyxHQUFHO0lBU2hDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBd0IsRUFBRTtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQVRULGFBQVEsR0FHckIsRUFBRSxDQUFDO1FBUUwsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQ2hDLElBQUksRUFDSixVQUFVLEVBQ1YsSUFBQSwyQkFBa0IsRUFBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQy9CLEVBQUUsS0FBSyxFQUFFLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUNuQyxDQUFDO1FBRUYsVUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztRQUVyQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRUQsSUFBYyxTQUFTO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBRU8sbUJBQW1CLENBQ3pCLFFBQW1DLEVBQ25DLEtBQTBCLEVBQzFCLFdBQW1CLEVBQ25CLE1BQXdCO1FBRXhC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QixFQUFFLEdBQWE7UUFDOUMsSUFBQSw0QkFBcUIsRUFBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNuRCxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsZ0JBQWdCO0lBQ1QsV0FBVztRQUNoQixPQUFPLElBQUEsNEJBQXFCLEVBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pELENBQUM7Q0FDRjtBQXpQRCxrQkF5UEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vYXBwXCI7XG5pbXBvcnQgeyBFdmVudE1hcHBpbmcgfSBmcm9tIFwiLi9ldmVudC1tYXBwaW5nXCI7XG5pbXBvcnQgeyBQb2xpY3kgfSBmcm9tIFwiLi9wb2xpY3lcIjtcbmltcG9ydCB7IElTaW11bGF0b3JSZXNvdXJjZSB9IGZyb20gXCIuL3Jlc291cmNlXCI7XG5pbXBvcnQgeyBBcGlSb3V0ZSwgQXBpU2NoZW1hIH0gZnJvbSBcIi4vc2NoZW1hLXJlc291cmNlc1wiO1xuaW1wb3J0IHsgc2ltdWxhdG9yQXR0clRva2VuIH0gZnJvbSBcIi4vdG9rZW5zXCI7XG5pbXBvcnQgeyBiaW5kU2ltdWxhdG9yUmVzb3VyY2UsIG1ha2VTaW11bGF0b3JKc0NsaWVudCB9IGZyb20gXCIuL3V0aWxcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIH0gZnJvbSBcIi4uL2Nsb3VkXCI7XG5pbXBvcnQgKiBhcyBjbG91ZCBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCB7IGxpZnQgfSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgVG9TaW11bGF0b3JPdXRwdXQgfSBmcm9tIFwiLi4vc2ltdWxhdG9yL3NpbXVsYXRvclwiO1xuaW1wb3J0IHsgSUluZmxpZ2h0SG9zdCwgTm9kZSwgU0RLX1NPVVJDRV9NT0RVTEUgfSBmcm9tIFwiLi4vc3RkXCI7XG5cbi8qKlxuICogU2ltdWxhdG9yIGltcGxlbWVudGF0aW9uIG9mIGBjbG91ZC5BcGlgLlxuICpcbiAqIEBpbmZsaWdodCBgQHdpbmdsYW5nL3Nkay5jbG91ZC5JQXBpQ2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgQXBpIGV4dGVuZHMgY2xvdWQuQXBpIGltcGxlbWVudHMgSVNpbXVsYXRvclJlc291cmNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBoYW5kbGVyczogUmVjb3JkPFxuICAgIHN0cmluZyxcbiAgICB7IGZ1bmM6IEZ1bmN0aW9uOyBtYXBwaW5nOiBFdmVudE1hcHBpbmcgfVxuICA+ID0ge307XG5cbiAgcHJpdmF0ZSByZWFkb25seSBlbmRwb2ludDogY2xvdWQuRW5kcG9pbnQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgcG9saWN5OiBQb2xpY3k7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IGNsb3VkLkFwaVByb3BzID0ge30pIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIHRoaXMuZW5kcG9pbnQgPSBuZXcgY2xvdWQuRW5kcG9pbnQoXG4gICAgICB0aGlzLFxuICAgICAgXCJFbmRwb2ludFwiLFxuICAgICAgc2ltdWxhdG9yQXR0clRva2VuKHRoaXMsIFwidXJsXCIpLFxuICAgICAgeyBsYWJlbDogYEFwaSAke3RoaXMubm9kZS5wYXRofWAgfVxuICAgICk7XG5cbiAgICBOb2RlLm9mKHRoaXMuZW5kcG9pbnQpLmhpZGRlbiA9IHRydWU7XG5cbiAgICB0aGlzLnBvbGljeSA9IG5ldyBQb2xpY3kodGhpcywgXCJQb2xpY3lcIiwgeyBwcmluY2lwYWw6IHRoaXMgfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0IF9lbmRwb2ludCgpOiBjbG91ZC5FbmRwb2ludCB7XG4gICAgcmV0dXJuIHRoaXMuZW5kcG9pbnQ7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZU9yR2V0RnVuY3Rpb24oXG4gICAgaW5mbGlnaHQ6IGNsb3VkLklBcGlFbmRwb2ludEhhbmRsZXIsXG4gICAgcHJvcHM6IGNsb3VkLkZ1bmN0aW9uUHJvcHMsXG4gICAgcGF0aFBhdHRlcm46IHN0cmluZyxcbiAgICBtZXRob2Q6IGNsb3VkLkh0dHBNZXRob2RcbiAgKTogRnVuY3Rpb24ge1xuICAgIGxldCBoYW5kbGVyID0gdGhpcy5oYW5kbGVyc1tpbmZsaWdodC5faWRdO1xuXG4gICAgaWYgKGhhbmRsZXIpIHtcbiAgICAgIGNvbnN0IHJvdXRlcyA9IChoYW5kbGVyLm1hcHBpbmcuZXZlbnRQcm9wcy5zdWJzY3JpcHRpb25Qcm9wcyBhcyBhbnkpXG4gICAgICAgIC5yb3V0ZXMgYXMgQXBpUm91dGVbXTtcbiAgICAgIHJvdXRlcy5wdXNoKHtcbiAgICAgICAgcGF0aFBhdHRlcm4sXG4gICAgICAgIG1ldGhvZCxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gaGFuZGxlci5mdW5jO1xuICAgIH1cblxuICAgIGNvbnN0IGZ1bmN0aW9uSGFuZGxlciA9IGxpZnQoeyBoYW5kbGVyOiBpbmZsaWdodCB9KS5pbmZsaWdodChcbiAgICAgIGFzeW5jIChjdHgsIGV2ZW50KSA9PiB7XG4gICAgICAgIGlmICghZXZlbnQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpbnZhbGlkIEFQSSByZXF1ZXN0IGV2ZW50XCIpO1xuICAgICAgICB9XG4gICAgICAgIGxldCByZXEgPSBKU09OLnBhcnNlKGV2ZW50KSBhcyBjbG91ZC5BcGlSZXF1ZXN0O1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGN0eC5oYW5kbGVyKHJlcSk7XG4gICAgICAgIGlmICghcmVzcG9uc2UpIHtcbiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShyZXNwb25zZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApO1xuXG4gICAgY29uc3QgZm4gPSBuZXcgRnVuY3Rpb24oXG4gICAgICB0aGlzLFxuICAgICAgQXBwLm9mKHRoaXMpLm1ha2VJZCh0aGlzLCBcIk9uUmVxdWVzdEhhbmRsZXJcIiksXG4gICAgICBmdW5jdGlvbkhhbmRsZXIsXG4gICAgICBwcm9wc1xuICAgICkgYXMgRnVuY3Rpb247XG4gICAgTm9kZS5vZihmbikuc291cmNlTW9kdWxlID0gU0RLX1NPVVJDRV9NT0RVTEU7XG4gICAgTm9kZS5vZihmbikudGl0bGUgPSBgJHttZXRob2QudG9VcHBlckNhc2UoKX0gJHtwYXRoUGF0dGVybn1gO1xuICAgIE5vZGUub2YoZm4pLmhpZGRlbiA9IHRydWU7XG5cbiAgICBjb25zdCBldmVudE1hcHBpbmcgPSBuZXcgRXZlbnRNYXBwaW5nKFxuICAgICAgdGhpcyxcbiAgICAgIEFwcC5vZih0aGlzKS5tYWtlSWQodGhpcywgXCJBcGlFdmVudE1hcHBpbmdcIiksXG4gICAgICB7XG4gICAgICAgIHB1Ymxpc2hlcjogdGhpcyxcbiAgICAgICAgc3Vic2NyaWJlcjogZm4sXG4gICAgICAgIHN1YnNjcmlwdGlvblByb3BzOiB7XG4gICAgICAgICAgcm91dGVzOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIHBhdGhQYXR0ZXJuLFxuICAgICAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcbiAgICB0aGlzLmhhbmRsZXJzW2luZmxpZ2h0Ll9pZF0gPSB7XG4gICAgICBmdW5jOiBmbixcbiAgICAgIG1hcHBpbmc6IGV2ZW50TWFwcGluZyxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRFbmRwb2ludChcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgbWV0aG9kOiBjbG91ZC5IdHRwTWV0aG9kLFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JQXBpRW5kcG9pbnRIYW5kbGVyLFxuICAgIHByb3BzOiBhbnlcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5fdmFsaWRhdGVQYXRoKHBhdGgpO1xuXG4gICAgdGhpcy5fYWRkVG9TcGVjKHBhdGgsIG1ldGhvZCwgdW5kZWZpbmVkLCB0aGlzLmNvcnNPcHRpb25zKTtcblxuICAgIGNvbnN0IGZuID0gdGhpcy5jcmVhdGVPckdldEZ1bmN0aW9uKGluZmxpZ2h0LCBwcm9wcywgcGF0aCwgbWV0aG9kKTtcbiAgICBOb2RlLm9mKHRoaXMpLmFkZENvbm5lY3Rpb24oe1xuICAgICAgc291cmNlOiB0aGlzLFxuICAgICAgc291cmNlT3A6IGNsb3VkLkFwaUluZmxpZ2h0TWV0aG9kcy5SRVFVRVNULFxuICAgICAgdGFyZ2V0OiBmbixcbiAgICAgIHRhcmdldE9wOiBjbG91ZC5GdW5jdGlvbkluZmxpZ2h0TWV0aG9kcy5JTlZPS0UsXG4gICAgICBuYW1lOiBgJHttZXRob2QudG9Mb3dlckNhc2UoKX0gJHtwYXRofWAsXG4gICAgfSk7XG4gICAgdGhpcy5wb2xpY3kuYWRkU3RhdGVtZW50KGZuLCBjbG91ZC5GdW5jdGlvbkluZmxpZ2h0TWV0aG9kcy5JTlZPS0UpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIGluZmxpZ2h0IHRvIGhhbmRsZSBHRVQgcmVxdWVzdHMgdG8gYSBwYXRoLlxuICAgKiBAcGFyYW0gcGF0aCBwYXRoIHRvIGFkZFxuICAgKiBAcGFyYW0gaW5mbGlnaHQgSW5mbGlnaHQgdG8gaGFuZGxlIHJlcXVlc3RcbiAgICogQHBhcmFtIHByb3BzIEFkZGl0aW9uYWwgcHJvcHNcbiAgICovXG4gIHB1YmxpYyBnZXQoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JQXBpRW5kcG9pbnRIYW5kbGVyLFxuICAgIHByb3BzPzogY2xvdWQuQXBpR2V0T3B0aW9ucyB8IHVuZGVmaW5lZFxuICApOiB2b2lkIHtcbiAgICB0aGlzLmFkZEVuZHBvaW50KHBhdGgsIGNsb3VkLkh0dHBNZXRob2QuR0VULCBpbmZsaWdodCwgcHJvcHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIGluZmxpZ2h0IHRvIGhhbmRsZSBQT1NUIHJlcXVlc3RzIHRvIGEgcGF0aC5cbiAgICogQHBhcmFtIHBhdGggcGF0aCB0byBhZGRcbiAgICogQHBhcmFtIGluZmxpZ2h0IEluZmxpZ2h0IHRvIGhhbmRsZSByZXF1ZXN0XG4gICAqIEBwYXJhbSBwcm9wcyBBZGRpdGlvbmFsIHByb3BzXG4gICAqL1xuICBwdWJsaWMgcG9zdChcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgaW5mbGlnaHQ6IGNsb3VkLklBcGlFbmRwb2ludEhhbmRsZXIsXG4gICAgcHJvcHM/OiBjbG91ZC5BcGlQb3N0T3B0aW9ucyB8IHVuZGVmaW5lZFxuICApOiB2b2lkIHtcbiAgICB0aGlzLmFkZEVuZHBvaW50KHBhdGgsIGNsb3VkLkh0dHBNZXRob2QuUE9TVCwgaW5mbGlnaHQsIHByb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBpbmZsaWdodCB0byBoYW5kbGUgUFVUIHJlcXVlc3RzIHRvIGEgcGF0aC5cbiAgICogQHBhcmFtIHBhdGggcGF0aCB0byBhZGRcbiAgICogQHBhcmFtIGluZmxpZ2h0IEluZmxpZ2h0IHRvIGhhbmRsZSByZXF1ZXN0XG4gICAqIEBwYXJhbSBwcm9wcyBBZGRpdGlvbmFsIHByb3BzXG4gICAqL1xuICBwdWJsaWMgcHV0KFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBpbmZsaWdodDogY2xvdWQuSUFwaUVuZHBvaW50SGFuZGxlcixcbiAgICBwcm9wcz86IGNsb3VkLkFwaVB1dE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5hZGRFbmRwb2ludChwYXRoLCBjbG91ZC5IdHRwTWV0aG9kLlBVVCwgaW5mbGlnaHQsIHByb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBpbmZsaWdodCB0byBoYW5kbGUgREVMRVRFIHJlcXVlc3RzIHRvIGEgcGF0aC5cbiAgICogQHBhcmFtIHBhdGggcGF0aCB0byBhZGRcbiAgICogQHBhcmFtIGluZmxpZ2h0IEluZmxpZ2h0IHRvIGhhbmRsZSByZXF1ZXN0XG4gICAqIEBwYXJhbSBwcm9wcyBBZGRpdGlvbmFsIHByb3BzXG4gICAqL1xuICBwdWJsaWMgZGVsZXRlKFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBpbmZsaWdodDogY2xvdWQuSUFwaUVuZHBvaW50SGFuZGxlcixcbiAgICBwcm9wcz86IGNsb3VkLkFwaURlbGV0ZU9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5hZGRFbmRwb2ludChwYXRoLCBjbG91ZC5IdHRwTWV0aG9kLkRFTEVURSwgaW5mbGlnaHQsIHByb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBpbmZsaWdodCB0byBoYW5kbGUgUEFUQ0ggcmVxdWVzdHMgdG8gYSBwYXRoLlxuICAgKiBAcGFyYW0gcGF0aCBwYXRoIHRvIGFkZFxuICAgKiBAcGFyYW0gaW5mbGlnaHQgSW5mbGlnaHQgdG8gaGFuZGxlIHJlcXVlc3RcbiAgICogQHBhcmFtIHByb3BzIEFkZGl0aW9uYWwgcHJvcHNcbiAgICovXG4gIHB1YmxpYyBwYXRjaChcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgaW5mbGlnaHQ6IGNsb3VkLklBcGlFbmRwb2ludEhhbmRsZXIsXG4gICAgcHJvcHM/OiBjbG91ZC5BcGlQYXRjaE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5hZGRFbmRwb2ludChwYXRoLCBjbG91ZC5IdHRwTWV0aG9kLlBBVENILCBpbmZsaWdodCwgcHJvcHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIGluZmxpZ2h0IHRvIGhhbmRsZSBPUFRJT05TIHJlcXVlc3RzIHRvIGEgcGF0aC5cbiAgICogQHBhcmFtIHBhdGggcGF0aCB0byBhZGRcbiAgICogQHBhcmFtIGluZmxpZ2h0IEluZmxpZ2h0IHRvIGhhbmRsZSByZXF1ZXN0XG4gICAqIEBwYXJhbSBwcm9wcyBBZGRpdGlvbmFsIHByb3BzXG4gICAqL1xuICBwdWJsaWMgb3B0aW9ucyhcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgaW5mbGlnaHQ6IGNsb3VkLklBcGlFbmRwb2ludEhhbmRsZXIsXG4gICAgcHJvcHM/OiBjbG91ZC5BcGlPcHRpb25zT3B0aW9ucyB8IHVuZGVmaW5lZFxuICApOiB2b2lkIHtcbiAgICB0aGlzLmFkZEVuZHBvaW50KHBhdGgsIGNsb3VkLkh0dHBNZXRob2QuT1BUSU9OUywgaW5mbGlnaHQsIHByb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBpbmZsaWdodCB0byBoYW5kbGUgSEVBRCByZXF1ZXN0cyB0byBhIHBhdGguXG4gICAqIEBwYXJhbSBwYXRoIHBhdGggdG8gYWRkXG4gICAqIEBwYXJhbSBpbmZsaWdodCBJbmZsaWdodCB0byBoYW5kbGUgcmVxdWVzdFxuICAgKiBAcGFyYW0gcHJvcHMgQWRkaXRpb25hbCBwcm9wc1xuICAgKi9cbiAgcHVibGljIGhlYWQoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JQXBpRW5kcG9pbnRIYW5kbGVyLFxuICAgIHByb3BzPzogY2xvdWQuQXBpSGVhZE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5hZGRFbmRwb2ludChwYXRoLCBjbG91ZC5IdHRwTWV0aG9kLkhFQUQsIGluZmxpZ2h0LCBwcm9wcyk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgaW5mbGlnaHQgdG8gaGFuZGxlIENPTk5FQ1QgcmVxdWVzdHMgdG8gYSBwYXRoLlxuICAgKiBAcGFyYW0gcGF0aCBwYXRoIHRvIGFkZFxuICAgKiBAcGFyYW0gaW5mbGlnaHQgSW5mbGlnaHQgdG8gaGFuZGxlIHJlcXVlc3RcbiAgICogQHBhcmFtIHByb3BzIEFkZGl0aW9uYWwgcHJvcHNcbiAgICovXG4gIHB1YmxpYyBjb25uZWN0KFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBpbmZsaWdodDogY2xvdWQuSUFwaUVuZHBvaW50SGFuZGxlcixcbiAgICBwcm9wcz86IGNsb3VkLkFwaUNvbm5lY3RPcHRpb25zIHwgdW5kZWZpbmVkXG4gICk6IHZvaWQge1xuICAgIHRoaXMuYWRkRW5kcG9pbnQocGF0aCwgY2xvdWQuSHR0cE1ldGhvZC5DT05ORUNULCBpbmZsaWdodCwgcHJvcHMpO1xuICB9XG5cbiAgcHVibGljIHRvU2ltdWxhdG9yKCk6IFRvU2ltdWxhdG9yT3V0cHV0IHtcbiAgICBjb25zdCBwcm9wczogQXBpU2NoZW1hID0ge1xuICAgICAgb3BlbkFwaVNwZWM6IHRoaXMuX2dldE9wZW5BcGlTcGVjKCksXG4gICAgICBjb3JzSGVhZGVyczogY2xvdWQuQXBpLnJlbmRlckNvcnNIZWFkZXJzKHRoaXMuY29yc09wdGlvbnMpLFxuICAgIH07XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IGNsb3VkLkFQSV9GUU4sXG4gICAgICBwcm9wcyxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIG9uTGlmdChob3N0OiBJSW5mbGlnaHRIb3N0LCBvcHM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgYmluZFNpbXVsYXRvclJlc291cmNlKF9fZmlsZW5hbWUsIHRoaXMsIGhvc3QsIG9wcyk7XG4gICAgc3VwZXIub25MaWZ0KGhvc3QsIG9wcyk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyBfdG9JbmZsaWdodCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBtYWtlU2ltdWxhdG9ySnNDbGllbnQoX19maWxlbmFtZSwgdGhpcyk7XG4gIH1cbn1cbiJdfQ==