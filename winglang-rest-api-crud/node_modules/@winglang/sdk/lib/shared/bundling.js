"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.fixSourcemaps = exports.createBundle = void 0;
const crypto = __importStar(require("crypto"));
const fs_1 = require("fs");
const path_1 = require("path");
const vlq_1 = require("vlq");
const misc_1 = require("./misc");
const SDK_PATH = (0, misc_1.normalPath)((0, path_1.resolve)(__dirname, "..", ".."));
/**
 * Bundles a javascript entrypoint into a single file.
 * @param entrypoint The javascript entrypoint
 * @param outputDir Defaults to `${entrypoint}.bundle`
 * @param external external packages
 * @returns Bundle information
 */
function createBundle(entrypoint, external = [], outputDir) {
    const normalEntrypoint = (0, misc_1.normalPath)((0, fs_1.realpathSync)(entrypoint));
    const outdir = outputDir
        ? (0, misc_1.normalPath)((0, fs_1.realpathSync)(outputDir))
        : `${normalEntrypoint}.bundle`;
    (0, fs_1.mkdirSync)(outdir, { recursive: true });
    const outfileName = "index.cjs";
    const soucemapFilename = `${outfileName}.map`;
    const outfile = path_1.posix.join(outdir, outfileName);
    const outfileMap = path_1.posix.join(outdir, soucemapFilename);
    // eslint-disable-next-line import/no-extraneous-dependencies,@typescript-eslint/no-require-imports
    const esbuilder = require("esbuild");
    let esbuild = esbuilder.buildSync({
        bundle: true,
        entryPoints: [normalEntrypoint],
        outfile,
        // otherwise there are problems with running azure cloud functions:
        // https://stackoverflow.com/questions/70332883/webpack-azure-storage-blob-node-fetch-abortsignal-issue
        keepNames: true,
        // if the user has specified a node_modules directory to resolve from
        nodePaths: process.env.WING_NODE_MODULES
            ? [(0, misc_1.normalPath)(process.env.WING_NODE_MODULES)]
            : undefined,
        alias: {
            "@winglang/sdk": SDK_PATH,
        },
        minify: false,
        sourcemap: "linked",
        platform: "node",
        target: "node20",
        format: "cjs",
        external,
        metafile: true,
        write: false,
    });
    if (esbuild.errors.length > 0) {
        const errors = esbuild.errors.map((e) => e.text).join("\n");
        throw new Error(`Failed to bundle function: ${errors}`);
    }
    const bundleOutput = esbuild.outputFiles[1];
    // ensure source paths have posix path separators
    const sourcemapData = JSON.parse(new TextDecoder().decode(esbuild.outputFiles[0].contents));
    fixSourcemaps(sourcemapData);
    (0, fs_1.writeFileSync)(outfile, bundleOutput.contents);
    (0, fs_1.writeFileSync)(outfileMap, JSON.stringify(sourcemapData));
    // calculate a md5 hash of the contents of asset.path
    const codeHash = crypto
        .createHash("md5")
        .update(bundleOutput.contents)
        .digest("hex");
    const outKeys = Object.keys(esbuild.metafile?.outputs ?? {});
    const outKey = outKeys.find((k) => k.endsWith(outfileName));
    if (!outKey) {
        throw new Error(`Couldn't find metadata for ${outfileName} from esbuild.`);
    }
    const inputFiles = Object.keys(esbuild.metafile?.outputs[outKey].inputs);
    return {
        directory: outdir,
        hash: codeHash,
        outfilePath: outfile,
        sourcemapPath: outfileMap,
        inputFiles,
        time: new Date(),
    };
}
exports.createBundle = createBundle;
/**
 * Takes a bundled sourcemap and does the following fixes:
 * - Normalizes paths in sources and sourceRoot
 * - Removes duplicate sources and sourcesContent
 * - Updates mappings to reflect the new source indices
 *
 * The duplicate sources come from esbuild's strange handling of multiple files being bundled that point to the same source (e.g. inflights that point to one .w file)
 * See https://github.com/evanw/esbuild/issues/933
 */
function fixSourcemaps(sourcemapData) {
    // normalize sourceRoot
    if (sourcemapData.sourceRoot) {
        sourcemapData.sourceRoot = (0, misc_1.normalPath)(sourcemapData.sourceRoot);
    }
    // normalize sources and remove duplicates
    const sourceSet = [];
    const newSourceContents = [];
    const sourceIndexMap = {};
    let hasSourceDupes = false;
    sourcemapData.sources.forEach((source, idx) => {
        const newPath = (0, misc_1.normalPath)(source);
        sourcemapData.sources[idx] = newPath;
        const existingIndex = sourceSet.indexOf(newPath);
        if (existingIndex === -1) {
            sourceSet.push(newPath);
            newSourceContents.push(sourcemapData.sourcesContent[idx]);
            sourceIndexMap[idx] = sourceSet.length - 1;
        }
        else {
            hasSourceDupes = true;
            sourceIndexMap[idx] = existingIndex;
        }
    });
    sourcemapData.sources = sourceSet;
    sourcemapData.sourcesContent = newSourceContents;
    // fast path: No source duplicates so no need to update mappings
    if (!hasSourceDupes) {
        return;
    }
    // update mappings
    let newMapping = "";
    let characterIndex = 0;
    let lastFile = 0;
    let lastTrueFile = 0;
    while (characterIndex < sourcemapData.mappings.length) {
        const char = sourcemapData.mappings[characterIndex];
        // `;` and `,` are separators between the segments of interest
        if (char === ";" || char === ",") {
            newMapping += char;
            characterIndex++;
            continue;
        }
        // get next slice of segment data
        let segment = "";
        let nextChar = char;
        while (nextChar !== undefined && nextChar !== "," && nextChar !== ";") {
            segment += nextChar;
            nextChar = sourcemapData.mappings[++characterIndex];
        }
        const decoded = (0, vlq_1.decode)(segment);
        if (decoded.length === 1) {
            newMapping += segment;
            continue;
        }
        const sourceRelative = decoded[1];
        const originalSource = lastTrueFile + sourceRelative;
        const newSourceIndex = sourceIndexMap[originalSource];
        lastTrueFile = originalSource;
        const newRelativeValue = newSourceIndex - lastFile;
        lastFile = newSourceIndex;
        if (newRelativeValue === decoded[1]) {
            // no change was made, avoid re-encoding
            newMapping += segment;
        }
        else {
            decoded[1] = newRelativeValue;
            newMapping += (0, vlq_1.encode)(decoded);
        }
    }
    sourcemapData.mappings = newMapping;
}
exports.fixSourcemaps = fixSourcemaps;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVuZGxpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2hhcmVkL2J1bmRsaW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsK0NBQWlDO0FBQ2pDLDJCQUE0RDtBQUM1RCwrQkFBc0M7QUFDdEMsNkJBQXFDO0FBQ3JDLGlDQUFvQztBQUVwQyxNQUFNLFFBQVEsR0FBRyxJQUFBLGlCQUFVLEVBQUMsSUFBQSxjQUFPLEVBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBa0I1RDs7Ozs7O0dBTUc7QUFDSCxTQUFnQixZQUFZLENBQzFCLFVBQWtCLEVBQ2xCLFdBQXFCLEVBQUUsRUFDdkIsU0FBa0I7SUFFbEIsTUFBTSxnQkFBZ0IsR0FBRyxJQUFBLGlCQUFVLEVBQUMsSUFBQSxpQkFBWSxFQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDOUQsTUFBTSxNQUFNLEdBQUcsU0FBUztRQUN0QixDQUFDLENBQUMsSUFBQSxpQkFBVSxFQUFDLElBQUEsaUJBQVksRUFBQyxTQUFTLENBQUMsQ0FBQztRQUNyQyxDQUFDLENBQUMsR0FBRyxnQkFBZ0IsU0FBUyxDQUFDO0lBQ2pDLElBQUEsY0FBUyxFQUFDLE1BQU0sRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBRXZDLE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQztJQUNoQyxNQUFNLGdCQUFnQixHQUFHLEdBQUcsV0FBVyxNQUFNLENBQUM7SUFFOUMsTUFBTSxPQUFPLEdBQUcsWUFBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDaEQsTUFBTSxVQUFVLEdBQUcsWUFBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztJQUV4RCxtR0FBbUc7SUFDbkcsTUFBTSxTQUFTLEdBQTZCLE9BQU8sQ0FBQyxTQUFTLENB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QUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEMsTUFBTSxjQUFjLEdBQUcsWUFBWSxHQUFHLGNBQWMsQ0FBQztRQUNyRCxNQUFNLGNBQWMsR0FBRyxjQUFjLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDdEQsWUFBWSxHQUFHLGNBQWMsQ0FBQztRQUU5QixNQUFNLGdCQUFnQixHQUFHLGNBQWMsR0FBRyxRQUFRLENBQUM7UUFDbkQsUUFBUSxHQUFHLGNBQWMsQ0FBQztRQUUxQixJQUFJLGdCQUFnQixLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ3BDLHdDQUF3QztZQUN4QyxVQUFVLElBQUksT0FBTyxDQUFDO1FBQ3hCLENBQUM7YUFBTSxDQUFDO1lBQ04sT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLGdCQUFnQixDQUFDO1lBQzlCLFVBQVUsSUFBSSxJQUFBLFlBQU0sRUFBQyxPQUFPLENBQUMsQ0FBQztRQUNoQyxDQUFDO0lBQ0gsQ0FBQztJQUVELGFBQWEsQ0FBQyxRQUFRLEdBQUcsVUFBVSxDQUFDO0FBQ3RDLENBQUM7QUEvRUQsc0NBK0VDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY3J5cHRvIGZyb20gXCJjcnlwdG9cIjtcbmltcG9ydCB7IG1rZGlyU3luYywgcmVhbHBhdGhTeW5jLCB3cml0ZUZpbGVTeW5jIH0gZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBwb3NpeCwgcmVzb2x2ZSB9IGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBkZWNvZGUsIGVuY29kZSB9IGZyb20gXCJ2bHFcIjtcbmltcG9ydCB7IG5vcm1hbFBhdGggfSBmcm9tIFwiLi9taXNjXCI7XG5cbmNvbnN0IFNES19QQVRIID0gbm9ybWFsUGF0aChyZXNvbHZlKF9fZGlybmFtZSwgXCIuLlwiLCBcIi4uXCIpKTtcblxuZXhwb3J0IGludGVyZmFjZSBCdW5kbGUge1xuICBkaXJlY3Rvcnk6IHN0cmluZztcbiAgaGFzaDogc3RyaW5nO1xuICBvdXRmaWxlUGF0aDogc3RyaW5nO1xuICBzb3VyY2VtYXBQYXRoOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBBIGxpc3Qgb2YgZmlsZXMgdGhhdCB3ZXJlIHVzZWQgdG8gY3JlYXRlIHRoZSBidW5kbGUgKGRpcmVjdGx5IG9yIGluZGlyZWN0bHkpLlxuICAgKiBJZiBub25lIG9mIHRoZSBsaXN0ZWQgZmlsZXMgaGF2ZSBiZWVuIG1vZGlmaWVkIHNpbmNlIHRoZSBsYXN0IGJ1bmRsZSwgaXQncyAqcHJvYmFibHkqIHNhZmUgdG8gcmV1c2UgdGhlIGJ1bmRsZS5cbiAgICpcbiAgICogTm90ZTogdGhpcyBpc24ndCBmdWxseSByZWxpYWJsZSBzaW5jZSB0aGVyZSBjYW4gYmUgZWRnZSBjYXNlcyB3aGVyZSBub25lIG9mIHRoZSBmaWxlcyBoYXZlIGJlZW4gbW9kaWZpZWRcbiAgICogYnV0IGEgZGlmZmVyZW50IGJ1bmRsZSB3b3VsZCBiZSBnZW5lcmF0ZWQgYnkgZXNidWlsZC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9ldmFudy9lc2J1aWxkL2lzc3Vlcy82NzNcbiAgICovXG4gIGlucHV0RmlsZXM6IHN0cmluZ1tdO1xuICB0aW1lOiBEYXRlO1xufVxuXG4vKipcbiAqIEJ1bmRsZXMgYSBqYXZhc2NyaXB0IGVudHJ5cG9pbnQgaW50byBhIHNpbmdsZSBmaWxlLlxuICogQHBhcmFtIGVudHJ5cG9pbnQgVGhlIGphdmFzY3JpcHQgZW50cnlwb2ludFxuICogQHBhcmFtIG91dHB1dERpciBEZWZhdWx0cyB0byBgJHtlbnRyeXBvaW50fS5idW5kbGVgXG4gKiBAcGFyYW0gZXh0ZXJuYWwgZXh0ZXJuYWwgcGFja2FnZXNcbiAqIEByZXR1cm5zIEJ1bmRsZSBpbmZvcm1hdGlvblxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQnVuZGxlKFxuICBlbnRyeXBvaW50OiBzdHJpbmcsXG4gIGV4dGVybmFsOiBzdHJpbmdbXSA9IFtdLFxuICBvdXRwdXREaXI/OiBzdHJpbmdcbik6IEJ1bmRsZSB7XG4gIGNvbnN0IG5vcm1hbEVudHJ5cG9pbnQgPSBub3JtYWxQYXRoKHJlYWxwYXRoU3luYyhlbnRyeXBvaW50KSk7XG4gIGNvbnN0IG91dGRpciA9IG91dHB1dERpclxuICAgID8gbm9ybWFsUGF0aChyZWFscGF0aFN5bmMob3V0cHV0RGlyKSlcbiAgICA6IGAke25vcm1hbEVudHJ5cG9pbnR9LmJ1bmRsZWA7XG4gIG1rZGlyU3luYyhvdXRkaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuXG4gIGNvbnN0IG91dGZpbGVOYW1lID0gXCJpbmRleC5janNcIjtcbiAgY29uc3Qgc291Y2VtYXBGaWxlbmFtZSA9IGAke291dGZpbGVOYW1lfS5tYXBgO1xuXG4gIGNvbnN0IG91dGZpbGUgPSBwb3NpeC5qb2luKG91dGRpciwgb3V0ZmlsZU5hbWUpO1xuICBjb25zdCBvdXRmaWxlTWFwID0gcG9zaXguam9pbihvdXRkaXIsIHNvdWNlbWFwRmlsZW5hbWUpO1xuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tZXh0cmFuZW91cy1kZXBlbmRlbmNpZXMsQHR5cGVzY3JpcHQtZXNsaW50L25vLXJlcXVpcmUtaW1wb3J0c1xuICBjb25zdCBlc2J1aWxkZXI6IHR5cGVvZiBpbXBvcnQoXCJlc2J1aWxkXCIpID0gcmVxdWlyZShcImVzYnVpbGRcIik7XG5cbiAgbGV0IGVzYnVpbGQgPSBlc2J1aWxkZXIuYnVpbGRTeW5jKHtcbiAgICBidW5kbGU6IHRydWUsXG4gICAgZW50cnlQb2ludHM6IFtub3JtYWxFbnRyeXBvaW50XSxcbiAgICBvdXRmaWxlLFxuICAgIC8vIG90aGVyd2lzZSB0aGVyZSBhcmUgcHJvYmxlbXMgd2l0aCBydW5uaW5nIGF6dXJlIGNsb3VkIGZ1bmN0aW9uczpcbiAgICAvLyBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy83MDMzMjg4My93ZWJwYWNrLWF6dXJlLXN0b3JhZ2UtYmxvYi1ub2RlLWZldGNoLWFib3J0c2lnbmFsLWlzc3VlXG4gICAga2VlcE5hbWVzOiB0cnVlLFxuICAgIC8vIGlmIHRoZSB1c2VyIGhhcyBzcGVjaWZpZWQgYSBub2RlX21vZHVsZXMgZGlyZWN0b3J5IHRvIHJlc29sdmUgZnJvbVxuICAgIG5vZGVQYXRoczogcHJvY2Vzcy5lbnYuV0lOR19OT0RFX01PRFVMRVNcbiAgICAgID8gW25vcm1hbFBhdGgocHJvY2Vzcy5lbnYuV0lOR19OT0RFX01PRFVMRVMgYXMgc3RyaW5nKV1cbiAgICAgIDogdW5kZWZpbmVkLFxuICAgIGFsaWFzOiB7XG4gICAgICBcIkB3aW5nbGFuZy9zZGtcIjogU0RLX1BBVEgsXG4gICAgfSxcbiAgICBtaW5pZnk6IGZhbHNlLFxuICAgIHNvdXJjZW1hcDogXCJsaW5rZWRcIixcbiAgICBwbGF0Zm9ybTogXCJub2RlXCIsXG4gICAgdGFyZ2V0OiBcIm5vZGUyMFwiLFxuICAgIGZvcm1hdDogXCJjanNcIixcbiAgICBleHRlcm5hbCxcbiAgICBtZXRhZmlsZTogdHJ1ZSxcbiAgICB3cml0ZTogZmFsc2UsXG4gIH0pO1xuXG4gIGlmIChlc2J1aWxkLmVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgY29uc3QgZXJyb3JzID0gZXNidWlsZC5lcnJvcnMubWFwKChlKSA9PiBlLnRleHQpLmpvaW4oXCJcXG5cIik7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gYnVuZGxlIGZ1bmN0aW9uOiAke2Vycm9yc31gKTtcbiAgfVxuXG4gIGNvbnN0IGJ1bmRsZU91dHB1dCA9IGVzYnVpbGQub3V0cHV0RmlsZXNbMV07XG5cbiAgLy8gZW5zdXJlIHNvdXJjZSBwYXRocyBoYXZlIHBvc2l4IHBhdGggc2VwYXJhdG9yc1xuICBjb25zdCBzb3VyY2VtYXBEYXRhID0gSlNPTi5wYXJzZShcbiAgICBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoZXNidWlsZC5vdXRwdXRGaWxlc1swXS5jb250ZW50cylcbiAgKTtcbiAgZml4U291cmNlbWFwcyhzb3VyY2VtYXBEYXRhKTtcblxuICB3cml0ZUZpbGVTeW5jKG91dGZpbGUsIGJ1bmRsZU91dHB1dC5jb250ZW50cyk7XG4gIHdyaXRlRmlsZVN5bmMob3V0ZmlsZU1hcCwgSlNPTi5zdHJpbmdpZnkoc291cmNlbWFwRGF0YSkpO1xuXG4gIC8vIGNhbGN1bGF0ZSBhIG1kNSBoYXNoIG9mIHRoZSBjb250ZW50cyBvZiBhc3NldC5wYXRoXG4gIGNvbnN0IGNvZGVIYXNoID0gY3J5cHRvXG4gICAgLmNyZWF0ZUhhc2goXCJtZDVcIilcbiAgICAudXBkYXRlKGJ1bmRsZU91dHB1dC5jb250ZW50cylcbiAgICAuZGlnZXN0KFwiaGV4XCIpO1xuXG4gIGNvbnN0IG91dEtleXMgPSBPYmplY3Qua2V5cyhlc2J1aWxkLm1ldGFmaWxlPy5vdXRwdXRzID8/IHt9KTtcbiAgY29uc3Qgb3V0S2V5ID0gb3V0S2V5cy5maW5kKChrKSA9PiBrLmVuZHNXaXRoKG91dGZpbGVOYW1lKSk7XG4gIGlmICghb3V0S2V5KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZG4ndCBmaW5kIG1ldGFkYXRhIGZvciAke291dGZpbGVOYW1lfSBmcm9tIGVzYnVpbGQuYCk7XG4gIH1cblxuICBjb25zdCBpbnB1dEZpbGVzID0gT2JqZWN0LmtleXMoZXNidWlsZC5tZXRhZmlsZT8ub3V0cHV0c1tvdXRLZXldLmlucHV0cyk7XG5cbiAgcmV0dXJuIHtcbiAgICBkaXJlY3Rvcnk6IG91dGRpcixcbiAgICBoYXNoOiBjb2RlSGFzaCxcbiAgICBvdXRmaWxlUGF0aDogb3V0ZmlsZSxcbiAgICBzb3VyY2VtYXBQYXRoOiBvdXRmaWxlTWFwLFxuICAgIGlucHV0RmlsZXMsXG4gICAgdGltZTogbmV3IERhdGUoKSxcbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTb3VyY2VNYXAge1xuICBzb3VyY2VSb290Pzogc3RyaW5nO1xuICBzb3VyY2VzOiBzdHJpbmdbXTtcbiAgc291cmNlc0NvbnRlbnQ6IHN0cmluZ1tdO1xuICBtYXBwaW5nczogc3RyaW5nO1xufVxuXG4vKipcbiAqIFRha2VzIGEgYnVuZGxlZCBzb3VyY2VtYXAgYW5kIGRvZXMgdGhlIGZvbGxvd2luZyBmaXhlczpcbiAqIC0gTm9ybWFsaXplcyBwYXRocyBpbiBzb3VyY2VzIGFuZCBzb3VyY2VSb290XG4gKiAtIFJlbW92ZXMgZHVwbGljYXRlIHNvdXJjZXMgYW5kIHNvdXJjZXNDb250ZW50XG4gKiAtIFVwZGF0ZXMgbWFwcGluZ3MgdG8gcmVmbGVjdCB0aGUgbmV3IHNvdXJjZSBpbmRpY2VzXG4gKlxuICogVGhlIGR1cGxpY2F0ZSBzb3VyY2VzIGNvbWUgZnJvbSBlc2J1aWxkJ3Mgc3RyYW5nZSBoYW5kbGluZyBvZiBtdWx0aXBsZSBmaWxlcyBiZWluZyBidW5kbGVkIHRoYXQgcG9pbnQgdG8gdGhlIHNhbWUgc291cmNlIChlLmcuIGluZmxpZ2h0cyB0aGF0IHBvaW50IHRvIG9uZSAudyBmaWxlKVxuICogU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9ldmFudy9lc2J1aWxkL2lzc3Vlcy85MzNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZpeFNvdXJjZW1hcHMoc291cmNlbWFwRGF0YTogU291cmNlTWFwKTogdm9pZCB7XG4gIC8vIG5vcm1hbGl6ZSBzb3VyY2VSb290XG4gIGlmIChzb3VyY2VtYXBEYXRhLnNvdXJjZVJvb3QpIHtcbiAgICBzb3VyY2VtYXBEYXRhLnNvdXJjZVJvb3QgPSBub3JtYWxQYXRoKHNvdXJjZW1hcERhdGEuc291cmNlUm9vdCk7XG4gIH1cblxuICAvLyBub3JtYWxpemUgc291cmNlcyBhbmQgcmVtb3ZlIGR1cGxpY2F0ZXNcbiAgY29uc3Qgc291cmNlU2V0OiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCBuZXdTb3VyY2VDb250ZW50czogc3RyaW5nW10gPSBbXTtcbiAgY29uc3Qgc291cmNlSW5kZXhNYXA6IFJlY29yZDxudW1iZXIsIG51bWJlcj4gPSB7fTtcbiAgbGV0IGhhc1NvdXJjZUR1cGVzID0gZmFsc2U7XG4gIHNvdXJjZW1hcERhdGEuc291cmNlcy5mb3JFYWNoKChzb3VyY2UsIGlkeCkgPT4ge1xuICAgIGNvbnN0IG5ld1BhdGggPSBub3JtYWxQYXRoKHNvdXJjZSk7XG4gICAgc291cmNlbWFwRGF0YS5zb3VyY2VzW2lkeF0gPSBuZXdQYXRoO1xuXG4gICAgY29uc3QgZXhpc3RpbmdJbmRleCA9IHNvdXJjZVNldC5pbmRleE9mKG5ld1BhdGgpO1xuICAgIGlmIChleGlzdGluZ0luZGV4ID09PSAtMSkge1xuICAgICAgc291cmNlU2V0LnB1c2gobmV3UGF0aCk7XG4gICAgICBuZXdTb3VyY2VDb250ZW50cy5wdXNoKHNvdXJjZW1hcERhdGEuc291cmNlc0NvbnRlbnRbaWR4XSk7XG4gICAgICBzb3VyY2VJbmRleE1hcFtpZHhdID0gc291cmNlU2V0Lmxlbmd0aCAtIDE7XG4gICAgfSBlbHNlIHtcbiAgICAgIGhhc1NvdXJjZUR1cGVzID0gdHJ1ZTtcbiAgICAgIHNvdXJjZUluZGV4TWFwW2lkeF0gPSBleGlzdGluZ0luZGV4O1xuICAgIH1cbiAgfSk7XG5cbiAgc291cmNlbWFwRGF0YS5zb3VyY2VzID0gc291cmNlU2V0O1xuICBzb3VyY2VtYXBEYXRhLnNvdXJjZXNDb250ZW50ID0gbmV3U291cmNlQ29udGVudHM7XG5cbiAgLy8gZmFzdCBwYXRoOiBObyBzb3VyY2UgZHVwbGljYXRlcyBzbyBubyBuZWVkIHRvIHVwZGF0ZSBtYXBwaW5nc1xuICBpZiAoIWhhc1NvdXJjZUR1cGVzKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gdXBkYXRlIG1hcHBpbmdzXG4gIGxldCBuZXdNYXBwaW5nID0gXCJcIjtcbiAgbGV0IGNoYXJhY3RlckluZGV4ID0gMDtcbiAgbGV0IGxhc3RGaWxlID0gMDtcbiAgbGV0IGxhc3RUcnVlRmlsZSA9IDA7XG4gIHdoaWxlIChjaGFyYWN0ZXJJbmRleCA8IHNvdXJjZW1hcERhdGEubWFwcGluZ3MubGVuZ3RoKSB7XG4gICAgY29uc3QgY2hhciA9IHNvdXJjZW1hcERhdGEubWFwcGluZ3NbY2hhcmFjdGVySW5kZXhdO1xuICAgIC8vIGA7YCBhbmQgYCxgIGFyZSBzZXBhcmF0b3JzIGJldHdlZW4gdGhlIHNlZ21lbnRzIG9mIGludGVyZXN0XG4gICAgaWYgKGNoYXIgPT09IFwiO1wiIHx8IGNoYXIgPT09IFwiLFwiKSB7XG4gICAgICBuZXdNYXBwaW5nICs9IGNoYXI7XG4gICAgICBjaGFyYWN0ZXJJbmRleCsrO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgLy8gZ2V0IG5leHQgc2xpY2Ugb2Ygc2VnbWVudCBkYXRhXG4gICAgbGV0IHNlZ21lbnQgPSBcIlwiO1xuICAgIGxldCBuZXh0Q2hhciA9IGNoYXI7XG4gICAgd2hpbGUgKG5leHRDaGFyICE9PSB1bmRlZmluZWQgJiYgbmV4dENoYXIgIT09IFwiLFwiICYmIG5leHRDaGFyICE9PSBcIjtcIikge1xuICAgICAgc2VnbWVudCArPSBuZXh0Q2hhcjtcbiAgICAgIG5leHRDaGFyID0gc291cmNlbWFwRGF0YS5tYXBwaW5nc1srK2NoYXJhY3RlckluZGV4XTtcbiAgICB9XG4gICAgY29uc3QgZGVjb2RlZCA9IGRlY29kZShzZWdtZW50KTtcbiAgICBpZiAoZGVjb2RlZC5sZW5ndGggPT09IDEpIHtcbiAgICAgIG5ld01hcHBpbmcgKz0gc2VnbWVudDtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGNvbnN0IHNvdXJjZVJlbGF0aXZlID0gZGVjb2RlZFsxXTtcbiAgICBjb25zdCBvcmlnaW5hbFNvdXJjZSA9IGxhc3RUcnVlRmlsZSArIHNvdXJjZVJlbGF0aXZlO1xuICAgIGNvbnN0IG5ld1NvdXJjZUluZGV4ID0gc291cmNlSW5kZXhNYXBbb3JpZ2luYWxTb3VyY2VdO1xuICAgIGxhc3RUcnVlRmlsZSA9IG9yaWdpbmFsU291cmNlO1xuXG4gICAgY29uc3QgbmV3UmVsYXRpdmVWYWx1ZSA9IG5ld1NvdXJjZUluZGV4IC0gbGFzdEZpbGU7XG4gICAgbGFzdEZpbGUgPSBuZXdTb3VyY2VJbmRleDtcblxuICAgIGlmIChuZXdSZWxhdGl2ZVZhbHVlID09PSBkZWNvZGVkWzFdKSB7XG4gICAgICAvLyBubyBjaGFuZ2Ugd2FzIG1hZGUsIGF2b2lkIHJlLWVuY29kaW5nXG4gICAgICBuZXdNYXBwaW5nICs9IHNlZ21lbnQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRlY29kZWRbMV0gPSBuZXdSZWxhdGl2ZVZhbHVlO1xuICAgICAgbmV3TWFwcGluZyArPSBlbmNvZGUoZGVjb2RlZCk7XG4gICAgfVxuICB9XG5cbiAgc291cmNlbWFwRGF0YS5tYXBwaW5ncyA9IG5ld01hcHBpbmc7XG59XG4iXX0=