"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Api = void 0;
const app_1 = require("./app");
const event_mapping_1 = require("./event-mapping");
const policy_1 = require("./policy");
const tokens_1 = require("./tokens");
const util_1 = require("./util");
const cloud_1 = require("../cloud");
const cloud = __importStar(require("../cloud"));
const core_1 = require("../core");
const std_1 = require("../std");
/**
 * Simulator implementation of `cloud.Api`.
 *
 * @inflight `@winglang/sdk.cloud.IApiClient`
 */
class Api extends cloud.Api {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        this.handlers = {};
        this.endpoint = new cloud.Endpoint(this, "Endpoint", (0, tokens_1.simulatorAttrToken)(this, "url"), { label: `Api ${this.node.path}` });
        std_1.Node.of(this.endpoint).hidden = true;
        this.policy = new policy_1.Policy(this, "Policy", { principal: this });
    }
    get _endpoint() {
        return this.endpoint;
    }
    createOrGetFunction(inflight, props, pathPattern, method) {
        let handler = this.handlers[inflight._id];
        if (handler) {
            const routes = handler.mapping.eventProps.subscriptionProps
                .routes;
            routes.push({
                pathPattern,
                method,
            });
            return handler.func;
        }
        const functionHandler = (0, core_1.lift)({ handler: inflight }).inflight(async (ctx, event) => {
            if (!event) {
                throw new Error("invalid API request event");
            }
            let req = JSON.parse(event);
            const response = await ctx.handler(req);
            if (!response) {
                return undefined;
            }
            else {
                return JSON.stringify(response);
            }
        });
        const fn = new cloud_1.Function(this, app_1.App.of(this).makeId(this, "OnRequestHandler"), functionHandler, props);
        std_1.Node.of(fn).sourceModule = std_1.SDK_SOURCE_MODULE;
        std_1.Node.of(fn).title = `${method.toUpperCase()} ${pathPattern}`;
        const eventMapping = new event_mapping_1.EventMapping(this, app_1.App.of(this).makeId(this, "ApiEventMapping"), {
            publisher: this,
            subscriber: fn,
            subscriptionProps: {
                routes: [
                    {
                        pathPattern,
                        method,
                    },
                ],
            },
        });
        this.handlers[inflight._id] = {
            func: fn,
            mapping: eventMapping,
        };
        return fn;
    }
    addEndpoint(path, method, inflight, props) {
        this._validatePath(path);
        this._addToSpec(path, method, undefined, this.corsOptions);
        const fn = this.createOrGetFunction(inflight, props, path, method);
        std_1.Node.of(this).addConnection({
            source: this,
            sourceOp: cloud.ApiInflightMethods.REQUEST,
            target: fn,
            targetOp: cloud.FunctionInflightMethods.INVOKE,
            name: `${method.toLowerCase()} ${path}`,
        });
        this.policy.addStatement(fn, cloud.FunctionInflightMethods.INVOKE);
    }
    /**
     * Add a inflight to handle GET requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    get(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.GET, inflight, props);
    }
    /**
     * Add a inflight to handle POST requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    post(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.POST, inflight, props);
    }
    /**
     * Add a inflight to handle PUT requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    put(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.PUT, inflight, props);
    }
    /**
     * Add a inflight to handle DELETE requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    delete(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.DELETE, inflight, props);
    }
    /**
     * Add a inflight to handle PATCH requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    patch(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.PATCH, inflight, props);
    }
    /**
     * Add a inflight to handle OPTIONS requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    options(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.OPTIONS, inflight, props);
    }
    /**
     * Add a inflight to handle HEAD requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    head(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.HEAD, inflight, props);
    }
    /**
     * Add a inflight to handle CONNECT requests to a path.
     * @param path path to add
     * @param inflight Inflight to handle request
     * @param props Additional props
     */
    connect(path, inflight, props) {
        this.addEndpoint(path, cloud.HttpMethod.CONNECT, inflight, props);
    }
    toSimulator() {
        const props = {
            openApiSpec: this._getOpenApiSpec(),
            corsHeaders: cloud.Api.renderCorsHeaders(this.corsOptions),
        };
        return {
            type: cloud.API_FQN,
            props,
        };
    }
    onLift(host, ops) {
        (0, util_1.bindSimulatorResource)(__filename, this, host, ops);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return (0, util_1.makeSimulatorJsClient)(__filename, this);
    }
}
exports.Api = Api;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC1zaW0vYXBpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsK0JBQTRCO0FBQzVCLG1EQUErQztBQUMvQyxxQ0FBa0M7QUFHbEMscUNBQThDO0FBQzlDLGlDQUFzRTtBQUN0RSxvQ0FBb0M7QUFDcEMsZ0RBQWtDO0FBQ2xDLGtDQUErQjtBQUUvQixnQ0FBZ0U7QUFFaEU7Ozs7R0FJRztBQUNILE1BQWEsR0FBSSxTQUFRLEtBQUssQ0FBQyxHQUFHO0lBU2hDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBd0IsRUFBRTtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQVRULGFBQVEsR0FHckIsRUFBRSxDQUFDO1FBUUwsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQ2hDLElBQUksRUFDSixVQUFVLEVBQ1YsSUFBQSwyQkFBa0IsRUFBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQy9CLEVBQUUsS0FBSyxFQUFFLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUNuQyxDQUFDO1FBRUYsVUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztRQUVyQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRUQsSUFBYyxTQUFTO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBRU8sbUJBQW1CLENBQ3pCLFFBQW1DLEVBQ25DLEtBQTBCLEVBQzFCLFdBQW1CLEVBQ25CLE1BQXdCO1FBRXhC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QUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ25ELEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRCxnQkFBZ0I7SUFDVCxXQUFXO1FBQ2hCLE9BQU8sSUFBQSw0QkFBcUIsRUFBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztDQUNGO0FBeFBELGtCQXdQQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9hcHBcIjtcbmltcG9ydCB7IEV2ZW50TWFwcGluZyB9IGZyb20gXCIuL2V2ZW50LW1hcHBpbmdcIjtcbmltcG9ydCB7IFBvbGljeSB9IGZyb20gXCIuL3BvbGljeVwiO1xuaW1wb3J0IHsgSVNpbXVsYXRvclJlc291cmNlIH0gZnJvbSBcIi4vcmVzb3VyY2VcIjtcbmltcG9ydCB7IEFwaVJvdXRlLCBBcGlTY2hlbWEgfSBmcm9tIFwiLi9zY2hlbWEtcmVzb3VyY2VzXCI7XG5pbXBvcnQgeyBzaW11bGF0b3JBdHRyVG9rZW4gfSBmcm9tIFwiLi90b2tlbnNcIjtcbmltcG9ydCB7IGJpbmRTaW11bGF0b3JSZXNvdXJjZSwgbWFrZVNpbXVsYXRvckpzQ2xpZW50IH0gZnJvbSBcIi4vdXRpbFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gfSBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCAqIGFzIGNsb3VkIGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0IHsgbGlmdCB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBUb1NpbXVsYXRvck91dHB1dCB9IGZyb20gXCIuLi9zaW11bGF0b3Ivc2ltdWxhdG9yXCI7XG5pbXBvcnQgeyBJSW5mbGlnaHRIb3N0LCBOb2RlLCBTREtfU09VUkNFX01PRFVMRSB9IGZyb20gXCIuLi9zdGRcIjtcblxuLyoqXG4gKiBTaW11bGF0b3IgaW1wbGVtZW50YXRpb24gb2YgYGNsb3VkLkFwaWAuXG4gKlxuICogQGluZmxpZ2h0IGBAd2luZ2xhbmcvc2RrLmNsb3VkLklBcGlDbGllbnRgXG4gKi9cbmV4cG9ydCBjbGFzcyBBcGkgZXh0ZW5kcyBjbG91ZC5BcGkgaW1wbGVtZW50cyBJU2ltdWxhdG9yUmVzb3VyY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IGhhbmRsZXJzOiBSZWNvcmQ8XG4gICAgc3RyaW5nLFxuICAgIHsgZnVuYzogRnVuY3Rpb247IG1hcHBpbmc6IEV2ZW50TWFwcGluZyB9XG4gID4gPSB7fTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGVuZHBvaW50OiBjbG91ZC5FbmRwb2ludDtcbiAgcHJpdmF0ZSByZWFkb25seSBwb2xpY3k6IFBvbGljeTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogY2xvdWQuQXBpUHJvcHMgPSB7fSkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgdGhpcy5lbmRwb2ludCA9IG5ldyBjbG91ZC5FbmRwb2ludChcbiAgICAgIHRoaXMsXG4gICAgICBcIkVuZHBvaW50XCIsXG4gICAgICBzaW11bGF0b3JBdHRyVG9rZW4odGhpcywgXCJ1cmxcIiksXG4gICAgICB7IGxhYmVsOiBgQXBpICR7dGhpcy5ub2RlLnBhdGh9YCB9XG4gICAgKTtcblxuICAgIE5vZGUub2YodGhpcy5lbmRwb2ludCkuaGlkZGVuID0gdHJ1ZTtcblxuICAgIHRoaXMucG9saWN5ID0gbmV3IFBvbGljeSh0aGlzLCBcIlBvbGljeVwiLCB7IHByaW5jaXBhbDogdGhpcyB9KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXQgX2VuZHBvaW50KCk6IGNsb3VkLkVuZHBvaW50IHtcbiAgICByZXR1cm4gdGhpcy5lbmRwb2ludDtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlT3JHZXRGdW5jdGlvbihcbiAgICBpbmZsaWdodDogY2xvdWQuSUFwaUVuZHBvaW50SGFuZGxlcixcbiAgICBwcm9wczogY2xvdWQuRnVuY3Rpb25Qcm9wcyxcbiAgICBwYXRoUGF0dGVybjogc3RyaW5nLFxuICAgIG1ldGhvZDogY2xvdWQuSHR0cE1ldGhvZFxuICApOiBGdW5jdGlvbiB7XG4gICAgbGV0IGhhbmRsZXIgPSB0aGlzLmhhbmRsZXJzW2luZmxpZ2h0Ll9pZF07XG5cbiAgICBpZiAoaGFuZGxlcikge1xuICAgICAgY29uc3Qgcm91dGVzID0gKGhhbmRsZXIubWFwcGluZy5ldmVudFByb3BzLnN1YnNjcmlwdGlvblByb3BzIGFzIGFueSlcbiAgICAgICAgLnJvdXRlcyBhcyBBcGlSb3V0ZVtdO1xuICAgICAgcm91dGVzLnB1c2goe1xuICAgICAgICBwYXRoUGF0dGVybixcbiAgICAgICAgbWV0aG9kLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBoYW5kbGVyLmZ1bmM7XG4gICAgfVxuXG4gICAgY29uc3QgZnVuY3Rpb25IYW5kbGVyID0gbGlmdCh7IGhhbmRsZXI6IGluZmxpZ2h0IH0pLmluZmxpZ2h0KFxuICAgICAgYXN5bmMgKGN0eCwgZXZlbnQpID0+IHtcbiAgICAgICAgaWYgKCFldmVudCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcImludmFsaWQgQVBJIHJlcXVlc3QgZXZlbnRcIik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlcSA9IEpTT04ucGFyc2UoZXZlbnQpIGFzIGNsb3VkLkFwaVJlcXVlc3Q7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY3R4LmhhbmRsZXIocmVxKTtcbiAgICAgICAgaWYgKCFyZXNwb25zZSkge1xuICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG5cbiAgICBjb25zdCBmbiA9IG5ldyBGdW5jdGlvbihcbiAgICAgIHRoaXMsXG4gICAgICBBcHAub2YodGhpcykubWFrZUlkKHRoaXMsIFwiT25SZXF1ZXN0SGFuZGxlclwiKSxcbiAgICAgIGZ1bmN0aW9uSGFuZGxlcixcbiAgICAgIHByb3BzXG4gICAgKSBhcyBGdW5jdGlvbjtcbiAgICBOb2RlLm9mKGZuKS5zb3VyY2VNb2R1bGUgPSBTREtfU09VUkNFX01PRFVMRTtcbiAgICBOb2RlLm9mKGZuKS50aXRsZSA9IGAke21ldGhvZC50b1VwcGVyQ2FzZSgpfSAke3BhdGhQYXR0ZXJufWA7XG5cbiAgICBjb25zdCBldmVudE1hcHBpbmcgPSBuZXcgRXZlbnRNYXBwaW5nKFxuICAgICAgdGhpcyxcbiAgICAgIEFwcC5vZih0aGlzKS5tYWtlSWQodGhpcywgXCJBcGlFdmVudE1hcHBpbmdcIiksXG4gICAgICB7XG4gICAgICAgIHB1Ymxpc2hlcjogdGhpcyxcbiAgICAgICAgc3Vic2NyaWJlcjogZm4sXG4gICAgICAgIHN1YnNjcmlwdGlvblByb3BzOiB7XG4gICAgICAgICAgcm91dGVzOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIHBhdGhQYXR0ZXJuLFxuICAgICAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcbiAgICB0aGlzLmhhbmRsZXJzW2luZmxpZ2h0Ll9pZF0gPSB7XG4gICAgICBmdW5jOiBmbixcbiAgICAgIG1hcHBpbmc6IGV2ZW50TWFwcGluZyxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRFbmRwb2ludChcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgbWV0aG9kOiBjbG91ZC5IdHRwTWV0aG9kLFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JQXBpRW5kcG9pbnRIYW5kbGVyLFxuICAgIHByb3BzOiBhbnlcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5fdmFsaWRhdGVQYXRoKHBhdGgpO1xuXG4gICAgdGhpcy5fYWRkVG9TcGVjKHBhdGgsIG1ldGhvZCwgdW5kZWZpbmVkLCB0aGlzLmNvcnNPcHRpb25zKTtcblxuICAgIGNvbnN0IGZuID0gdGhpcy5jcmVhdGVPckdldEZ1bmN0aW9uKGluZmxpZ2h0LCBwcm9wcywgcGF0aCwgbWV0aG9kKTtcbiAgICBOb2RlLm9mKHRoaXMpLmFkZENvbm5lY3Rpb24oe1xuICAgICAgc291cmNlOiB0aGlzLFxuICAgICAgc291cmNlT3A6IGNsb3VkLkFwaUluZmxpZ2h0TWV0aG9kcy5SRVFVRVNULFxuICAgICAgdGFyZ2V0OiBmbixcbiAgICAgIHRhcmdldE9wOiBjbG91ZC5GdW5jdGlvbkluZmxpZ2h0TWV0aG9kcy5JTlZPS0UsXG4gICAgICBuYW1lOiBgJHttZXRob2QudG9Mb3dlckNhc2UoKX0gJHtwYXRofWAsXG4gICAgfSk7XG4gICAgdGhpcy5wb2xpY3kuYWRkU3RhdGVtZW50KGZuLCBjbG91ZC5GdW5jdGlvbkluZmxpZ2h0TWV0aG9kcy5JTlZPS0UpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIGluZmxpZ2h0IHRvIGhhbmRsZSBHRVQgcmVxdWVzdHMgdG8gYSBwYXRoLlxuICAgKiBAcGFyYW0gcGF0aCBwYXRoIHRvIGFkZFxuICAgKiBAcGFyYW0gaW5mbGlnaHQgSW5mbGlnaHQgdG8gaGFuZGxlIHJlcXVlc3RcbiAgICogQHBhcmFtIHByb3BzIEFkZGl0aW9uYWwgcHJvcHNcbiAgICovXG4gIHB1YmxpYyBnZXQoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JQXBpRW5kcG9pbnRIYW5kbGVyLFxuICAgIHByb3BzPzogY2xvdWQuQXBpR2V0T3B0aW9ucyB8IHVuZGVmaW5lZFxuICApOiB2b2lkIHtcbiAgICB0aGlzLmFkZEVuZHBvaW50KHBhdGgsIGNsb3VkLkh0dHBNZXRob2QuR0VULCBpbmZsaWdodCwgcHJvcHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIGluZmxpZ2h0IHRvIGhhbmRsZSBQT1NUIHJlcXVlc3RzIHRvIGEgcGF0aC5cbiAgICogQHBhcmFtIHBhdGggcGF0aCB0byBhZGRcbiAgICogQHBhcmFtIGluZmxpZ2h0IEluZmxpZ2h0IHRvIGhhbmRsZSByZXF1ZXN0XG4gICAqIEBwYXJhbSBwcm9wcyBBZGRpdGlvbmFsIHByb3BzXG4gICAqL1xuICBwdWJsaWMgcG9zdChcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgaW5mbGlnaHQ6IGNsb3VkLklBcGlFbmRwb2ludEhhbmRsZXIsXG4gICAgcHJvcHM/OiBjbG91ZC5BcGlQb3N0T3B0aW9ucyB8IHVuZGVmaW5lZFxuICApOiB2b2lkIHtcbiAgICB0aGlzLmFkZEVuZHBvaW50KHBhdGgsIGNsb3VkLkh0dHBNZXRob2QuUE9TVCwgaW5mbGlnaHQsIHByb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBpbmZsaWdodCB0byBoYW5kbGUgUFVUIHJlcXVlc3RzIHRvIGEgcGF0aC5cbiAgICogQHBhcmFtIHBhdGggcGF0aCB0byBhZGRcbiAgICogQHBhcmFtIGluZmxpZ2h0IEluZmxpZ2h0IHRvIGhhbmRsZSByZXF1ZXN0XG4gICAqIEBwYXJhbSBwcm9wcyBBZGRpdGlvbmFsIHByb3BzXG4gICAqL1xuICBwdWJsaWMgcHV0KFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBpbmZsaWdodDogY2xvdWQuSUFwaUVuZHBvaW50SGFuZGxlcixcbiAgICBwcm9wcz86IGNsb3VkLkFwaVB1dE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5hZGRFbmRwb2ludChwYXRoLCBjbG91ZC5IdHRwTWV0aG9kLlBVVCwgaW5mbGlnaHQsIHByb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBpbmZsaWdodCB0byBoYW5kbGUgREVMRVRFIHJlcXVlc3RzIHRvIGEgcGF0aC5cbiAgICogQHBhcmFtIHBhdGggcGF0aCB0byBhZGRcbiAgICogQHBhcmFtIGluZmxpZ2h0IEluZmxpZ2h0IHRvIGhhbmRsZSByZXF1ZXN0XG4gICAqIEBwYXJhbSBwcm9wcyBBZGRpdGlvbmFsIHByb3BzXG4gICAqL1xuICBwdWJsaWMgZGVsZXRlKFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBpbmZsaWdodDogY2xvdWQuSUFwaUVuZHBvaW50SGFuZGxlcixcbiAgICBwcm9wcz86IGNsb3VkLkFwaURlbGV0ZU9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5hZGRFbmRwb2ludChwYXRoLCBjbG91ZC5IdHRwTWV0aG9kLkRFTEVURSwgaW5mbGlnaHQsIHByb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBpbmZsaWdodCB0byBoYW5kbGUgUEFUQ0ggcmVxdWVzdHMgdG8gYSBwYXRoLlxuICAgKiBAcGFyYW0gcGF0aCBwYXRoIHRvIGFkZFxuICAgKiBAcGFyYW0gaW5mbGlnaHQgSW5mbGlnaHQgdG8gaGFuZGxlIHJlcXVlc3RcbiAgICogQHBhcmFtIHByb3BzIEFkZGl0aW9uYWwgcHJvcHNcbiAgICovXG4gIHB1YmxpYyBwYXRjaChcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgaW5mbGlnaHQ6IGNsb3VkLklBcGlFbmRwb2ludEhhbmRsZXIsXG4gICAgcHJvcHM/OiBjbG91ZC5BcGlQYXRjaE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5hZGRFbmRwb2ludChwYXRoLCBjbG91ZC5IdHRwTWV0aG9kLlBBVENILCBpbmZsaWdodCwgcHJvcHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIGluZmxpZ2h0IHRvIGhhbmRsZSBPUFRJT05TIHJlcXVlc3RzIHRvIGEgcGF0aC5cbiAgICogQHBhcmFtIHBhdGggcGF0aCB0byBhZGRcbiAgICogQHBhcmFtIGluZmxpZ2h0IEluZmxpZ2h0IHRvIGhhbmRsZSByZXF1ZXN0XG4gICAqIEBwYXJhbSBwcm9wcyBBZGRpdGlvbmFsIHByb3BzXG4gICAqL1xuICBwdWJsaWMgb3B0aW9ucyhcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgaW5mbGlnaHQ6IGNsb3VkLklBcGlFbmRwb2ludEhhbmRsZXIsXG4gICAgcHJvcHM/OiBjbG91ZC5BcGlPcHRpb25zT3B0aW9ucyB8IHVuZGVmaW5lZFxuICApOiB2b2lkIHtcbiAgICB0aGlzLmFkZEVuZHBvaW50KHBhdGgsIGNsb3VkLkh0dHBNZXRob2QuT1BUSU9OUywgaW5mbGlnaHQsIHByb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBpbmZsaWdodCB0byBoYW5kbGUgSEVBRCByZXF1ZXN0cyB0byBhIHBhdGguXG4gICAqIEBwYXJhbSBwYXRoIHBhdGggdG8gYWRkXG4gICAqIEBwYXJhbSBpbmZsaWdodCBJbmZsaWdodCB0byBoYW5kbGUgcmVxdWVzdFxuICAgKiBAcGFyYW0gcHJvcHMgQWRkaXRpb25hbCBwcm9wc1xuICAgKi9cbiAgcHVibGljIGhlYWQoXG4gICAgcGF0aDogc3RyaW5nLFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JQXBpRW5kcG9pbnRIYW5kbGVyLFxuICAgIHByb3BzPzogY2xvdWQuQXBpSGVhZE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5hZGRFbmRwb2ludChwYXRoLCBjbG91ZC5IdHRwTWV0aG9kLkhFQUQsIGluZmxpZ2h0LCBwcm9wcyk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgaW5mbGlnaHQgdG8gaGFuZGxlIENPTk5FQ1QgcmVxdWVzdHMgdG8gYSBwYXRoLlxuICAgKiBAcGFyYW0gcGF0aCBwYXRoIHRvIGFkZFxuICAgKiBAcGFyYW0gaW5mbGlnaHQgSW5mbGlnaHQgdG8gaGFuZGxlIHJlcXVlc3RcbiAgICogQHBhcmFtIHByb3BzIEFkZGl0aW9uYWwgcHJvcHNcbiAgICovXG4gIHB1YmxpYyBjb25uZWN0KFxuICAgIHBhdGg6IHN0cmluZyxcbiAgICBpbmZsaWdodDogY2xvdWQuSUFwaUVuZHBvaW50SGFuZGxlcixcbiAgICBwcm9wcz86IGNsb3VkLkFwaUNvbm5lY3RPcHRpb25zIHwgdW5kZWZpbmVkXG4gICk6IHZvaWQge1xuICAgIHRoaXMuYWRkRW5kcG9pbnQocGF0aCwgY2xvdWQuSHR0cE1ldGhvZC5DT05ORUNULCBpbmZsaWdodCwgcHJvcHMpO1xuICB9XG5cbiAgcHVibGljIHRvU2ltdWxhdG9yKCk6IFRvU2ltdWxhdG9yT3V0cHV0IHtcbiAgICBjb25zdCBwcm9wczogQXBpU2NoZW1hID0ge1xuICAgICAgb3BlbkFwaVNwZWM6IHRoaXMuX2dldE9wZW5BcGlTcGVjKCksXG4gICAgICBjb3JzSGVhZGVyczogY2xvdWQuQXBpLnJlbmRlckNvcnNIZWFkZXJzKHRoaXMuY29yc09wdGlvbnMpLFxuICAgIH07XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IGNsb3VkLkFQSV9GUU4sXG4gICAgICBwcm9wcyxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIG9uTGlmdChob3N0OiBJSW5mbGlnaHRIb3N0LCBvcHM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgYmluZFNpbXVsYXRvclJlc291cmNlKF9fZmlsZW5hbWUsIHRoaXMsIGhvc3QsIG9wcyk7XG4gICAgc3VwZXIub25MaWZ0KGhvc3QsIG9wcyk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyBfdG9JbmZsaWdodCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBtYWtlU2ltdWxhdG9ySnNDbGllbnQoX19maWxlbmFtZSwgdGhpcyk7XG4gIH1cbn1cbiJdfQ==