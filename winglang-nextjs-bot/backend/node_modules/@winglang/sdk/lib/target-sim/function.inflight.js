"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Function = void 0;
const path = __importStar(require("path"));
const cloud_1 = require("../cloud");
const bundling_1 = require("../shared/bundling");
const sandbox_1 = require("../shared/sandbox");
const simulator_1 = require("../simulator/simulator");
const std_1 = require("../std");
class Function {
    constructor(props) {
        this.workers = new Array();
        this.sourceCodeFile = props.sourceCodeFile;
        if (props.sourceCodeLanguage !== "javascript") {
            throw new Error("Only JavaScript is supported");
        }
        this.env = props.environmentVariables ?? {};
        this.timeout = props.timeout;
        this.maxWorkers = props.concurrency;
    }
    get context() {
        if (!this._context) {
            throw new Error("Cannot access context during class construction");
        }
        return this._context;
    }
    async init(context) {
        this._context = context;
        this.originalFile = path.resolve(context.simdir, this.sourceCodeFile);
        this.createBundlePromise = this.createBundle();
        return {};
    }
    async cleanup() {
        // We wait for the bundle to be created since there's no way to otherwise cancel the work.
        // If the simulator runs for a short time (and cloud.Function is created and then deleted)
        // and the bundling code is allowed to run after the simulator has stopped, it might fail
        // and throw an error to the user because the files the simulator was using may no longer be there there.
        await this.createBundlePromise;
        await Promise.allSettled(this.workers.map((w) => w.cleanup()));
    }
    async save() { }
    async plan(invalidated) {
        // If our function config changed, always replace
        if (invalidated) {
            return simulator_1.UpdatePlan.REPLACE;
        }
        // Make sure that we don't have an ongoing bundle operation
        await this.ensureBundled();
        // Check if any of the bundled files have changed since the last bundling
        const bundleInvalidated = await (0, bundling_1.isBundleInvalidated)(this.originalFile, this.bundle, (msg) => this.addTrace(msg, std_1.TraceType.SIMULATOR, std_1.LogLevel.VERBOSE));
        if (bundleInvalidated) {
            return simulator_1.UpdatePlan.REPLACE;
        }
        return simulator_1.UpdatePlan.SKIP;
    }
    async invoke(payload) {
        return this.context.withTrace({
            message: `Invoke (payload=${JSON.stringify(payload)}).`,
            activity: async () => {
                const worker = await this.findAvailableWorker();
                if (!worker) {
                    throw new Error("Too many requests, the function has reached its concurrency limit.");
                }
                try {
                    return await worker.call("handler", payload);
                }
                catch (err) {
                    if (err instanceof sandbox_1.SandboxTimeoutError) {
                        throw new Error(`Function timed out (it was configured with a timeout of ${this.timeout}ms).`);
                    }
                    else {
                        throw err;
                    }
                }
            },
        });
    }
    async invokeAsync(payload) {
        await this.context.withTrace({
            message: `InvokeAsync (payload=${JSON.stringify(payload)}).`,
            activity: async () => {
                const worker = await this.findAvailableWorker();
                if (!worker) {
                    throw new Error("Too many requests, the function has reached its concurrency limit.");
                }
                process.nextTick(() => {
                    void worker.call("handler", payload).catch((e) => {
                        // If the call fails, we log the error and continue since we've already
                        // handed control back to the caller.
                        this.context.addTrace({
                            data: {
                                message: `InvokeAsync (payload=${JSON.stringify(payload)}) failure.`,
                                status: "failure",
                                error: e,
                            },
                            type: std_1.TraceType.LOG,
                            level: std_1.LogLevel.ERROR,
                            sourcePath: this.context.resourcePath,
                            sourceType: cloud_1.FUNCTION_FQN,
                            timestamp: new Date().toISOString(),
                        });
                    });
                });
            },
        });
    }
    async createBundle() {
        this.bundle = await sandbox_1.Sandbox.createBundle(this.originalFile, (msg, level) => {
            this.addTrace(msg, std_1.TraceType.RESOURCE, level);
        });
    }
    async ensureBundled() {
        await this.createBundlePromise;
        if (!this.bundle) {
            throw new Error("Bundle not created");
        }
    }
    // Used internally by cloud.Queue to apply backpressure
    async hasAvailableWorkers() {
        return (this.workers.length < this.maxWorkers ||
            this.workers.some((w) => w.isAvailable()));
    }
    async findAvailableWorker() {
        const worker = this.workers.find((w) => w.isAvailable());
        if (worker) {
            return worker;
        }
        if (this.workers.length < this.maxWorkers) {
            const newWorker = await this.initWorker();
            this.workers.push(newWorker);
            return newWorker;
        }
        return undefined;
    }
    async initWorker() {
        // ensure inflight code is bundled before we create any workers
        await this.ensureBundled();
        return new sandbox_1.Sandbox(this.bundle.outfilePath, {
            env: {
                ...this.env,
                WING_SIMULATOR_CALLER: this.context.resourceHandle,
                WING_SIMULATOR_URL: this.context.serverUrl,
            },
            timeout: this.timeout,
            log: (internal, level, message) => {
                this.addTrace(message, internal ? std_1.TraceType.SIMULATOR : std_1.TraceType.LOG, level);
            },
        });
    }
    addTrace(message, type, level) {
        this.context.addTrace({
            data: { message },
            type,
            level,
            sourcePath: this.context.resourcePath,
            sourceType: cloud_1.FUNCTION_FQN,
            timestamp: new Date().toISOString(),
        });
    }
}
exports.Function = Function;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb24uaW5mbGlnaHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXNpbS9mdW5jdGlvbi5pbmZsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUE2QjtBQUU3QixvQ0FBeUQ7QUFDekQsaURBQWlFO0FBQ2pFLCtDQUFpRTtBQUNqRSxzREFJZ0M7QUFDaEMsZ0NBQTZDO0FBRTdDLE1BQWEsUUFBUTtJQVduQixZQUFZLEtBQXFCO1FBSGhCLFlBQU8sR0FBRyxJQUFJLEtBQUssRUFBVyxDQUFDO1FBSTlDLElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQztRQUMzQyxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsS0FBSyxZQUFZLEVBQUUsQ0FBQztZQUM5QyxNQUFNLElBQUksS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUM7UUFDbEQsQ0FBQztRQUNELElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLG9CQUFvQixJQUFJLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDN0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxJQUFZLE9BQU87UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBRU0sS0FBSyxDQUFDLElBQUksQ0FBQyxPQUEwQjtRQUMxQyxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFB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QyxPQUFPLENBQUMsU0FBUzthQUMzQztZQUNELE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztZQUNyQixHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxFQUFFO2dCQUNoQyxJQUFJLENBQUMsUUFBUSxDQUNYLE9BQU8sRUFDUCxRQUFRLENBQUMsQ0FBQyxDQUFDLGVBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLGVBQVMsQ0FBQyxHQUFHLEVBQzlDLEtBQUssQ0FDTixDQUFDO1lBQ0osQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxRQUFRLENBQUMsT0FBZSxFQUFFLElBQWUsRUFBRSxLQUFlO1FBQ2hFLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDO1lBQ3BCLElBQUksRUFBRSxFQUFFLE9BQU8sRUFBRTtZQUNqQixJQUFJO1lBQ0osS0FBSztZQUNMLFVBQVUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVk7WUFDckMsVUFBVSxFQUFFLG9CQUFZO1lBQ3hCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUNwQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFyTUQsNEJBcU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgRnVuY3Rpb25BdHRyaWJ1dGVzLCBGdW5jdGlvblNjaGVtYSB9IGZyb20gXCIuL3NjaGVtYS1yZXNvdXJjZXNcIjtcbmltcG9ydCB7IEZVTkNUSU9OX0ZRTiwgSUZ1bmN0aW9uQ2xpZW50IH0gZnJvbSBcIi4uL2Nsb3VkXCI7XG5pbXBvcnQgeyBCdW5kbGUsIGlzQnVuZGxlSW52YWxpZGF0ZWQgfSBmcm9tIFwiLi4vc2hhcmVkL2J1bmRsaW5nXCI7XG5pbXBvcnQgeyBTYW5kYm94LCBTYW5kYm94VGltZW91dEVycm9yIH0gZnJvbSBcIi4uL3NoYXJlZC9zYW5kYm94XCI7XG5pbXBvcnQge1xuICBJU2ltdWxhdG9yQ29udGV4dCxcbiAgSVNpbXVsYXRvclJlc291cmNlSW5zdGFuY2UsXG4gIFVwZGF0ZVBsYW4sXG59IGZyb20gXCIuLi9zaW11bGF0b3Ivc2ltdWxhdG9yXCI7XG5pbXBvcnQgeyBMb2dMZXZlbCwgVHJhY2VUeXBlIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG5leHBvcnQgY2xhc3MgRnVuY3Rpb24gaW1wbGVtZW50cyBJRnVuY3Rpb25DbGllbnQsIElTaW11bGF0b3JSZXNvdXJjZUluc3RhbmNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzb3VyY2VDb2RlRmlsZTogc3RyaW5nO1xuICBwcml2YXRlIG9yaWdpbmFsRmlsZSE6IHN0cmluZztcbiAgcHJpdmF0ZSBidW5kbGU6IEJ1bmRsZSB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSByZWFkb25seSBlbnY6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIHByaXZhdGUgX2NvbnRleHQ6IElTaW11bGF0b3JDb250ZXh0IHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIHJlYWRvbmx5IHRpbWVvdXQ6IG51bWJlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBtYXhXb3JrZXJzOiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgd29ya2VycyA9IG5ldyBBcnJheTxTYW5kYm94PigpO1xuICBwcml2YXRlIGNyZWF0ZUJ1bmRsZVByb21pc2UhOiBQcm9taXNlPHZvaWQ+O1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBGdW5jdGlvblNjaGVtYSkge1xuICAgIHRoaXMuc291cmNlQ29kZUZpbGUgPSBwcm9wcy5zb3VyY2VDb2RlRmlsZTtcbiAgICBpZiAocHJvcHMuc291cmNlQ29kZUxhbmd1YWdlICE9PSBcImphdmFzY3JpcHRcIikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT25seSBKYXZhU2NyaXB0IGlzIHN1cHBvcnRlZFwiKTtcbiAgICB9XG4gICAgdGhpcy5lbnYgPSBwcm9wcy5lbnZpcm9ubWVudFZhcmlhYmxlcyA/PyB7fTtcbiAgICB0aGlzLnRpbWVvdXQgPSBwcm9wcy50aW1lb3V0O1xuICAgIHRoaXMubWF4V29ya2VycyA9IHByb3BzLmNvbmN1cnJlbmN5O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgY29udGV4dCgpOiBJU2ltdWxhdG9yQ29udGV4dCB7XG4gICAgaWYgKCF0aGlzLl9jb250ZXh0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgYWNjZXNzIGNvbnRleHQgZHVyaW5nIGNsYXNzIGNvbnN0cnVjdGlvblwiKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2NvbnRleHQ7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5pdChjb250ZXh0OiBJU2ltdWxhdG9yQ29udGV4dCk6IFByb21pc2U8RnVuY3Rpb25BdHRyaWJ1dGVzPiB7XG4gICAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7XG4gICAgdGhpcy5vcmlnaW5hbEZpbGUgPSBwYXRoLnJlc29sdmUoY29udGV4dC5zaW1kaXIsIHRoaXMuc291cmNlQ29kZUZpbGUpO1xuICAgIHRoaXMuY3JlYXRlQnVuZGxlUHJvbWlzZSA9IHRoaXMuY3JlYXRlQnVuZGxlKCk7XG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNsZWFudXAoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gV2Ugd2FpdCBmb3IgdGhlIGJ1bmRsZSB0byBiZSBjcmVhdGVkIHNpbmNlIHRoZXJlJ3Mgbm8gd2F5IHRvIG90aGVyd2lzZSBjYW5jZWwgdGhlIHdvcmsuXG4gICAgLy8gSWYgdGhlIHNpbXVsYXRvciBydW5zIGZvciBhIHNob3J0IHRpbWUgKGFuZCBjbG91ZC5GdW5jdGlvbiBpcyBjcmVhdGVkIGFuZCB0aGVuIGRlbGV0ZWQpXG4gICAgLy8gYW5kIHRoZSBidW5kbGluZyBjb2RlIGlzIGFsbG93ZWQgdG8gcnVuIGFmdGVyIHRoZSBzaW11bGF0b3IgaGFzIHN0b3BwZWQsIGl0IG1pZ2h0IGZhaWxcbiAgICAvLyBhbmQgdGhyb3cgYW4gZXJyb3IgdG8gdGhlIHVzZXIgYmVjYXVzZSB0aGUgZmlsZXMgdGhlIHNpbXVsYXRvciB3YXMgdXNpbmcgbWF5IG5vIGxvbmdlciBiZSB0aGVyZSB0aGVyZS5cbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUJ1bmRsZVByb21pc2U7XG4gICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHRoaXMud29ya2Vycy5tYXAoKHcpID0+IHcuY2xlYW51cCgpKSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2F2ZSgpOiBQcm9taXNlPHZvaWQ+IHt9XG5cbiAgcHVibGljIGFzeW5jIHBsYW4oaW52YWxpZGF0ZWQ6IGJvb2xlYW4pOiBQcm9taXNlPFVwZGF0ZVBsYW4+IHtcbiAgICAvLyBJZiBvdXIgZnVuY3Rpb24gY29uZmlnIGNoYW5nZWQsIGFsd2F5cyByZXBsYWNlXG4gICAgaWYgKGludmFsaWRhdGVkKSB7XG4gICAgICByZXR1cm4gVXBkYXRlUGxhbi5SRVBMQUNFO1xuICAgIH1cblxuICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlIGRvbid0IGhhdmUgYW4gb25nb2luZyBidW5kbGUgb3BlcmF0aW9uXG4gICAgYXdhaXQgdGhpcy5lbnN1cmVCdW5kbGVkKCk7XG5cbiAgICAvLyBDaGVjayBpZiBhbnkgb2YgdGhlIGJ1bmRsZWQgZmlsZXMgaGF2ZSBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGJ1bmRsaW5nXG4gICAgY29uc3QgYnVuZGxlSW52YWxpZGF0ZWQgPSBhd2FpdCBpc0J1bmRsZUludmFsaWRhdGVkKFxuICAgICAgdGhpcy5vcmlnaW5hbEZpbGUsXG4gICAgICB0aGlzLmJ1bmRsZSEsXG4gICAgICAobXNnKSA9PiB0aGlzLmFkZFRyYWNlKG1zZywgVHJhY2VUeXBlLlNJTVVMQVRPUiwgTG9nTGV2ZWwuVkVSQk9TRSlcbiAgICApO1xuICAgIGlmIChidW5kbGVJbnZhbGlkYXRlZCkge1xuICAgICAgcmV0dXJuIFVwZGF0ZVBsYW4uUkVQTEFDRTtcbiAgICB9XG5cbiAgICByZXR1cm4gVXBkYXRlUGxhbi5TS0lQO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGludm9rZShwYXlsb2FkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHQud2l0aFRyYWNlKHtcbiAgICAgIG1lc3NhZ2U6IGBJbnZva2UgKHBheWxvYWQ9JHtKU09OLnN0cmluZ2lmeShwYXlsb2FkKX0pLmAsXG4gICAgICBhY3Rpdml0eTogYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCB3b3JrZXIgPSBhd2FpdCB0aGlzLmZpbmRBdmFpbGFibGVXb3JrZXIoKTtcbiAgICAgICAgaWYgKCF3b3JrZXIpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBcIlRvbyBtYW55IHJlcXVlc3RzLCB0aGUgZnVuY3Rpb24gaGFzIHJlYWNoZWQgaXRzIGNvbmN1cnJlbmN5IGxpbWl0LlwiXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgIHJldHVybiBhd2FpdCB3b3JrZXIuY2FsbChcImhhbmRsZXJcIiwgcGF5bG9hZCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBTYW5kYm94VGltZW91dEVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgIGBGdW5jdGlvbiB0aW1lZCBvdXQgKGl0IHdhcyBjb25maWd1cmVkIHdpdGggYSB0aW1lb3V0IG9mICR7dGhpcy50aW1lb3V0fW1zKS5gXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGludm9rZUFzeW5jKHBheWxvYWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgbWVzc2FnZTogYEludm9rZUFzeW5jIChwYXlsb2FkPSR7SlNPTi5zdHJpbmdpZnkocGF5bG9hZCl9KS5gLFxuICAgICAgYWN0aXZpdHk6IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgd29ya2VyID0gYXdhaXQgdGhpcy5maW5kQXZhaWxhYmxlV29ya2VyKCk7XG4gICAgICAgIGlmICghd29ya2VyKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgXCJUb28gbWFueSByZXF1ZXN0cywgdGhlIGZ1bmN0aW9uIGhhcyByZWFjaGVkIGl0cyBjb25jdXJyZW5jeSBsaW1pdC5cIlxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgICAgdm9pZCB3b3JrZXIuY2FsbChcImhhbmRsZXJcIiwgcGF5bG9hZCkuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgIC8vIElmIHRoZSBjYWxsIGZhaWxzLCB3ZSBsb2cgdGhlIGVycm9yIGFuZCBjb250aW51ZSBzaW5jZSB3ZSd2ZSBhbHJlYWR5XG4gICAgICAgICAgICAvLyBoYW5kZWQgY29udHJvbCBiYWNrIHRvIHRoZSBjYWxsZXIuXG4gICAgICAgICAgICB0aGlzLmNvbnRleHQuYWRkVHJhY2Uoe1xuICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYEludm9rZUFzeW5jIChwYXlsb2FkPSR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgICAgICAgICBwYXlsb2FkXG4gICAgICAgICAgICAgICAgKX0pIGZhaWx1cmUuYCxcbiAgICAgICAgICAgICAgICBzdGF0dXM6IFwiZmFpbHVyZVwiLFxuICAgICAgICAgICAgICAgIGVycm9yOiBlLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB0eXBlOiBUcmFjZVR5cGUuTE9HLFxuICAgICAgICAgICAgICBsZXZlbDogTG9nTGV2ZWwuRVJST1IsXG4gICAgICAgICAgICAgIHNvdXJjZVBhdGg6IHRoaXMuY29udGV4dC5yZXNvdXJjZVBhdGgsXG4gICAgICAgICAgICAgIHNvdXJjZVR5cGU6IEZVTkNUSU9OX0ZRTixcbiAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVCdW5kbGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5idW5kbGUgPSBhd2FpdCBTYW5kYm94LmNyZWF0ZUJ1bmRsZShcbiAgICAgIHRoaXMub3JpZ2luYWxGaWxlLFxuICAgICAgKG1zZywgbGV2ZWwpID0+IHtcbiAgICAgICAgdGhpcy5hZGRUcmFjZShtc2csIFRyYWNlVHlwZS5SRVNPVVJDRSwgbGV2ZWwpO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGVuc3VyZUJ1bmRsZWQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5jcmVhdGVCdW5kbGVQcm9taXNlO1xuICAgIGlmICghdGhpcy5idW5kbGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkJ1bmRsZSBub3QgY3JlYXRlZFwiKTtcbiAgICB9XG4gIH1cblxuICAvLyBVc2VkIGludGVybmFsbHkgYnkgY2xvdWQuUXVldWUgdG8gYXBwbHkgYmFja3ByZXNzdXJlXG4gIHB1YmxpYyBhc3luYyBoYXNBdmFpbGFibGVXb3JrZXJzKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLndvcmtlcnMubGVuZ3RoIDwgdGhpcy5tYXhXb3JrZXJzIHx8XG4gICAgICB0aGlzLndvcmtlcnMuc29tZSgodykgPT4gdy5pc0F2YWlsYWJsZSgpKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZpbmRBdmFpbGFibGVXb3JrZXIoKTogUHJvbWlzZTxTYW5kYm94IHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3Qgd29ya2VyID0gdGhpcy53b3JrZXJzLmZpbmQoKHcpID0+IHcuaXNBdmFpbGFibGUoKSk7XG4gICAgaWYgKHdvcmtlcikge1xuICAgICAgcmV0dXJuIHdvcmtlcjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy53b3JrZXJzLmxlbmd0aCA8IHRoaXMubWF4V29ya2Vycykge1xuICAgICAgY29uc3QgbmV3V29ya2VyID0gYXdhaXQgdGhpcy5pbml0V29ya2VyKCk7XG4gICAgICB0aGlzLndvcmtlcnMucHVzaChuZXdXb3JrZXIpO1xuICAgICAgcmV0dXJuIG5ld1dvcmtlcjtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBpbml0V29ya2VyKCk6IFByb21pc2U8U2FuZGJveD4ge1xuICAgIC8vIGVuc3VyZSBpbmZsaWdodCBjb2RlIGlzIGJ1bmRsZWQgYmVmb3JlIHdlIGNyZWF0ZSBhbnkgd29ya2Vyc1xuICAgIGF3YWl0IHRoaXMuZW5zdXJlQnVuZGxlZCgpO1xuXG4gICAgcmV0dXJuIG5ldyBTYW5kYm94KHRoaXMuYnVuZGxlIS5vdXRmaWxlUGF0aCwge1xuICAgICAgZW52OiB7XG4gICAgICAgIC4uLnRoaXMuZW52LFxuICAgICAgICBXSU5HX1NJTVVMQVRPUl9DQUxMRVI6IHRoaXMuY29udGV4dC5yZXNvdXJjZUhhbmRsZSxcbiAgICAgICAgV0lOR19TSU1VTEFUT1JfVVJMOiB0aGlzLmNvbnRleHQuc2VydmVyVXJsLFxuICAgICAgfSxcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICAgIGxvZzogKGludGVybmFsLCBsZXZlbCwgbWVzc2FnZSkgPT4ge1xuICAgICAgICB0aGlzLmFkZFRyYWNlKFxuICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgaW50ZXJuYWwgPyBUcmFjZVR5cGUuU0lNVUxBVE9SIDogVHJhY2VUeXBlLkxPRyxcbiAgICAgICAgICBsZXZlbFxuICAgICAgICApO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVHJhY2UobWVzc2FnZTogc3RyaW5nLCB0eXBlOiBUcmFjZVR5cGUsIGxldmVsOiBMb2dMZXZlbCkge1xuICAgIHRoaXMuY29udGV4dC5hZGRUcmFjZSh7XG4gICAgICBkYXRhOiB7IG1lc3NhZ2UgfSxcbiAgICAgIHR5cGUsXG4gICAgICBsZXZlbCxcbiAgICAgIHNvdXJjZVBhdGg6IHRoaXMuY29udGV4dC5yZXNvdXJjZVBhdGgsXG4gICAgICBzb3VyY2VUeXBlOiBGVU5DVElPTl9GUU4sXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICB9KTtcbiAgfVxufVxuIl19