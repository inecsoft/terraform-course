"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.App = exports.SIMULATOR_FILE_PATH = void 0;
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const api_1 = require("./api");
const bucket_1 = require("./bucket");
const container_1 = require("./container");
const counter_1 = require("./counter");
const domain_1 = require("./domain");
const endpoint_1 = require("./endpoint");
const event_mapping_1 = require("./event-mapping");
const function_1 = require("./function");
const on_deploy_1 = require("./on-deploy");
const policy_1 = require("./policy");
const queue_1 = require("./queue");
const redis_1 = require("./redis");
const resource_1 = require("./resource");
const schedule_1 = require("./schedule");
const secret_1 = require("./secret");
const service_1 = require("./service");
const state_1 = require("./state");
const table_1 = require("./table");
const test_runner_1 = require("./test-runner");
const tokens_1 = require("./tokens");
const topic_1 = require("./topic");
const website_1 = require("./website");
const cloud_1 = require("../cloud");
const constants_1 = require("../constants");
const core = __importStar(require("../core"));
const app_1 = require("../core/app");
const tokens_2 = require("../core/tokens");
const ex_1 = require("../ex");
const tokens_3 = require("../simulator/tokens");
const std_1 = require("../std");
/**
 * Path of the simulator configuration file in every .wsim tarball.
 */
exports.SIMULATOR_FILE_PATH = "simulator.json";
const SIMULATOR_CLASS_DATA = {
    [cloud_1.API_FQN]: "Api",
    [cloud_1.BUCKET_FQN]: "Bucket",
    [cloud_1.DOMAIN_FQN]: "Domain",
    [cloud_1.ENDPOINT_FQN]: "Endpoint",
    [event_mapping_1.EVENT_MAPPING_FQN]: "EventMapping",
    [cloud_1.FUNCTION_FQN]: "Function",
    [cloud_1.ON_DEPLOY_FQN]: "OnDeploy",
    [policy_1.POLICY_FQN]: "Policy",
    [cloud_1.QUEUE_FQN]: "Queue",
    [ex_1.REDIS_FQN]: "Redis",
    [cloud_1.SCHEDULE_FQN]: "Schedule",
    [cloud_1.SECRET_FQN]: "Secret",
    [cloud_1.SERVICE_FQN]: "Service",
    [state_1.STATE_FQN]: "State",
    [container_1.SIM_CONTAINER_FQN]: "Container",
    [resource_1.SIM_RESOURCE_FQN]: "Resource",
    [ex_1.TABLE_FQN]: "Table",
    [std_1.TEST_RUNNER_FQN]: "TestRunner",
    [cloud_1.TOPIC_FQN]: "Topic",
    [cloud_1.WEBSITE_FQN]: "Website",
};
/**
 * A construct that knows how to synthesize simulator resources into a
 * Wing simulator (.wsim) file.
 */
class App extends core.App {
    constructor(props) {
        // doesn't allow customize the root id- as used hardcoded in the code
        super(undefined, "root", props);
        this._target = "sim";
        this.synthed = false;
        this.outdir = props.outdir ?? ".";
        (0, tokens_2.registerTokenResolver)(new tokens_1.SimTokens());
        test_runner_1.TestRunner._createTree(this, props.rootConstruct);
    }
    /** @internal */
    _inflightClientForFqn(fqn) {
        switch (fqn) {
            case cloud_1.API_FQN:
                return require.resolve("./api.inflight");
            case cloud_1.BUCKET_FQN:
                return require.resolve("./bucket.inflight");
            case cloud_1.DOMAIN_FQN:
                return require.resolve("./domain.inflight");
            case cloud_1.ENDPOINT_FQN:
                return require.resolve("./endpoint.inflight");
            case event_mapping_1.EVENT_MAPPING_FQN:
                return require.resolve("./event-mapping.inflight");
            case cloud_1.FUNCTION_FQN:
                return require.resolve("./function.inflight");
            case cloud_1.ON_DEPLOY_FQN:
                return require.resolve("./on-deploy.inflight");
            case policy_1.POLICY_FQN:
                return require.resolve("./policy.inflight");
            case cloud_1.QUEUE_FQN:
                return require.resolve("./queue.inflight");
            case ex_1.REDIS_FQN:
                return require.resolve("./redis.inflight");
            case cloud_1.SCHEDULE_FQN:
                return require.resolve("./schedule.inflight");
            case cloud_1.SECRET_FQN:
                return require.resolve("./secret.inflight");
            case cloud_1.SERVICE_FQN:
                return require.resolve("./service.inflight");
            case state_1.STATE_FQN:
                return require.resolve("./state.inflight");
            case ex_1.TABLE_FQN:
                return require.resolve("./table.inflight");
            case std_1.TEST_RUNNER_FQN:
                return require.resolve("./test-runner.inflight");
            case cloud_1.TOPIC_FQN:
                return require.resolve("./topic.inflight");
            case cloud_1.WEBSITE_FQN:
                return require.resolve("./website.inflight");
            case container_1.SIM_CONTAINER_FQN:
                return require.resolve("./container.inflight");
            case resource_1.SIM_RESOURCE_FQN:
                return require.resolve("./resource.inflight");
        }
        return undefined;
    }
    typeForFqn(fqn) {
        switch (fqn) {
            case cloud_1.API_FQN:
                return api_1.Api;
            case cloud_1.BUCKET_FQN:
                return bucket_1.Bucket;
            case cloud_1.COUNTER_FQN:
                return counter_1.Counter;
            case cloud_1.DOMAIN_FQN:
                return domain_1.Domain;
            case cloud_1.ENDPOINT_FQN:
                return endpoint_1.Endpoint;
            // EVENT_MAPPING_FQN skipped - it's not a multi-target construct
            case cloud_1.FUNCTION_FQN:
                return function_1.Function;
            case cloud_1.ON_DEPLOY_FQN:
                return on_deploy_1.OnDeploy;
            case policy_1.POLICY_FQN:
                return policy_1.Policy;
            case cloud_1.QUEUE_FQN:
                return queue_1.Queue;
            case ex_1.REDIS_FQN:
                return redis_1.Redis;
            case cloud_1.SCHEDULE_FQN:
                return schedule_1.Schedule;
            case cloud_1.SECRET_FQN:
                return secret_1.Secret;
            case cloud_1.SERVICE_FQN:
                return service_1.Service;
            case state_1.STATE_FQN:
                return state_1.State;
            case ex_1.TABLE_FQN:
                return table_1.Table;
            case std_1.TEST_RUNNER_FQN:
                return test_runner_1.TestRunner;
            case cloud_1.TOPIC_FQN:
                return topic_1.Topic;
            case cloud_1.WEBSITE_FQN:
                return website_1.Website;
            // SIM_CONTAINER_FQN skipped - it's not a multi-target construct
            // SIM_RESOURCE_FQN skipped - it's not a multi-target construct
        }
        return undefined;
    }
    /**
     * Synthesize the app. This creates a tree.json file and a .wsim file in the
     * app's outdir, and returns a path to the .wsim directory.
     */
    synth() {
        if (this.synthed) {
            return this.outdir;
        }
        fs.mkdirSync(this.outdir, { recursive: true });
        // call preSynthesize() on every construct in the tree
        (0, app_1.preSynthesizeAllConstructs)(this);
        if (this._synthHooks?.preSynthesize) {
            this._synthHooks.preSynthesize.forEach((hook) => hook(this));
        }
        // write simulator.json file into workdir
        const spec = this.synthSimulatorFile(this.outdir);
        this.addTokenConnections(spec);
        // write tree.json file into workdir
        core.synthesizeTree(this, this.outdir);
        // write `outdir/connections.json`
        core.Connections.of(this).synth(this.outdir);
        this.synthed = true;
        if (this._synthHooks?.postSynthesize) {
            this._synthHooks.postSynthesize.forEach((hook) => hook(this));
        }
        return this.outdir;
    }
    /**
     * Scans the app spec for token references and adds connections to reflect
     * this relationship.
     *
     * @param spec The simulator spec
     */
    addTokenConnections(spec) {
        const map = {};
        for (const c of this.node.findAll()) {
            map[c.node.path] = c;
        }
        for (const [from, resource] of Object.entries(spec.resources)) {
            (0, tokens_3.resolveTokens)(resource.props, (to) => {
                // skip references to the "handle" of the target resource because it would be reflected by
                // the connections created by inflight method calls.
                if (to.attr !== "handle") {
                    core.Connections.of(this).add({
                        source: map[from],
                        target: map[to.path],
                        targetOp: to.attr,
                        name: "<ref>",
                    });
                }
                return "<TOKEN>"; // <-- not used
            });
        }
    }
    synthSimulatorFile(outdir) {
        const resources = {};
        for (const r of new core.DependencyGraph(this.node).topology()) {
            if ((0, resource_1.isSimulatorResource)(r)) {
                const deps = r.node.dependencies.map((d) => d.node.path);
                resources[r.node.path] = {
                    ...r.toSimulator(),
                    path: r.node.path,
                    addr: r.node.addr,
                    deps: deps.length === 0 ? undefined : deps,
                    attrs: undefined,
                };
            }
        }
        const types = {};
        for (const [fqn, className] of Object.entries(SIMULATOR_CLASS_DATA)) {
            const sourcePath = this._inflightClientForFqn(fqn);
            if (!sourcePath) {
                throw new Error(`No source path for ${fqn}`);
            }
            types[fqn] = {
                className,
                sourcePath,
            };
        }
        const contents = {
            types,
            resources,
            sdkVersion: constants_1.SDK_VERSION,
        };
        // write simulator.json file
        fs.writeFileSync(path.join(outdir, exports.SIMULATOR_FILE_PATH), JSON.stringify(contents, undefined, 2), { encoding: "utf8" });
        return contents;
    }
}
exports.App = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC1zaW0vYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsdUNBQXlCO0FBQ3pCLDJDQUE2QjtBQUU3QiwrQkFBNEI7QUFDNUIscUNBQWtDO0FBQ2xDLDJDQUFnRDtBQUNoRCx1Q0FBb0M7QUFDcEMscUNBQWtDO0FBQ2xDLHlDQUFzQztBQUN0QyxtREFBb0Q7QUFDcEQseUNBQXNDO0FBQ3RDLDJDQUF1QztBQUN2QyxxQ0FBOEM7QUFDOUMsbUNBQWdDO0FBQ2hDLG1DQUFnQztBQUNoQyx5Q0FBbUU7QUFDbkUseUNBQXNDO0FBQ3RDLHFDQUFrQztBQUNsQyx1Q0FBb0M7QUFDcEMsbUNBQTJDO0FBQzNDLG1DQUFnQztBQUNoQywrQ0FBMkM7QUFDM0MscUNBQXFDO0FBQ3JDLG1DQUFnQztBQUNoQyx1Q0FBb0M7QUFDcEMsb0NBY2tCO0FBQ2xCLDRDQUEyQztBQUMzQyw4Q0FBZ0M7QUFDaEMscUNBQXlEO0FBQ3pELDJDQUF1RDtBQUN2RCw4QkFBNkM7QUFNN0MsZ0RBQW9EO0FBQ3BELGdDQUF5QztBQUV6Qzs7R0FFRztBQUNVLFFBQUEsbUJBQW1CLEdBQUcsZ0JBQWdCLENBQUM7QUFFcEQsTUFBTSxvQkFBb0IsR0FBRztJQUMzQixDQUFDLGVBQU8sQ0FBQyxFQUFFLEtBQUs7SUFDaEIsQ0FBQyxrQkFBVSxDQUFDLEVBQUUsUUFBUTtJQUN0QixDQUFDLGtCQUFVLENBQUMsRUFBRSxRQUFRO0lBQ3RCLENBQUMsb0JBQVksQ0FBQyxFQUFFLFVBQVU7SUFDMUIsQ0FBQyxpQ0FBaUIsQ0FBQyxFQUFFLGNBQWM7SUFDbkMsQ0FBQyxvQkFBWSxDQUFDLEVBQUUsVUFBVTtJQUMxQixDQUFDLHFCQUFhLENBQUMsRUFBRSxVQUFVO0lBQzNCLENBQUMsbUJBQVUsQ0FBQyxFQUFFLFFBQVE7SUFDdEIsQ0FBQyxpQkFBUyxDQUFDLEVB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LENBQUM7WUFDbkQsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUNoQixNQUFNLElBQUksS0FBSyxDQUFDLHNCQUFzQixHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQy9DLENBQUM7WUFDRCxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUc7Z0JBQ1gsU0FBUztnQkFDVCxVQUFVO2FBQ1gsQ0FBQztRQUNKLENBQUM7UUFFRCxNQUFNLFFBQVEsR0FBd0I7WUFDcEMsS0FBSztZQUNMLFNBQVM7WUFDVCxVQUFVLEVBQUUsdUJBQVc7U0FDeEIsQ0FBQztRQUVGLDRCQUE0QjtRQUM1QixFQUFFLENBQUMsYUFBYSxDQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLDJCQUFtQixDQUFDLEVBQ3RDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsRUFDdEMsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQ3JCLENBQUM7UUFFRixPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0NBQ0Y7QUFqUUQsa0JBaVFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBJQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IEFwaSB9IGZyb20gXCIuL2FwaVwiO1xuaW1wb3J0IHsgQnVja2V0IH0gZnJvbSBcIi4vYnVja2V0XCI7XG5pbXBvcnQgeyBTSU1fQ09OVEFJTkVSX0ZRTiB9IGZyb20gXCIuL2NvbnRhaW5lclwiO1xuaW1wb3J0IHsgQ291bnRlciB9IGZyb20gXCIuL2NvdW50ZXJcIjtcbmltcG9ydCB7IERvbWFpbiB9IGZyb20gXCIuL2RvbWFpblwiO1xuaW1wb3J0IHsgRW5kcG9pbnQgfSBmcm9tIFwiLi9lbmRwb2ludFwiO1xuaW1wb3J0IHsgRVZFTlRfTUFQUElOR19GUU4gfSBmcm9tIFwiLi9ldmVudC1tYXBwaW5nXCI7XG5pbXBvcnQgeyBGdW5jdGlvbiB9IGZyb20gXCIuL2Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBPbkRlcGxveSB9IGZyb20gXCIuL29uLWRlcGxveVwiO1xuaW1wb3J0IHsgUE9MSUNZX0ZRTiwgUG9saWN5IH0gZnJvbSBcIi4vcG9saWN5XCI7XG5pbXBvcnQgeyBRdWV1ZSB9IGZyb20gXCIuL3F1ZXVlXCI7XG5pbXBvcnQgeyBSZWRpcyB9IGZyb20gXCIuL3JlZGlzXCI7XG5pbXBvcnQgeyBTSU1fUkVTT1VSQ0VfRlFOLCBpc1NpbXVsYXRvclJlc291cmNlIH0gZnJvbSBcIi4vcmVzb3VyY2VcIjtcbmltcG9ydCB7IFNjaGVkdWxlIH0gZnJvbSBcIi4vc2NoZWR1bGVcIjtcbmltcG9ydCB7IFNlY3JldCB9IGZyb20gXCIuL3NlY3JldFwiO1xuaW1wb3J0IHsgU2VydmljZSB9IGZyb20gXCIuL3NlcnZpY2VcIjtcbmltcG9ydCB7IFNUQVRFX0ZRTiwgU3RhdGUgfSBmcm9tIFwiLi9zdGF0ZVwiO1xuaW1wb3J0IHsgVGFibGUgfSBmcm9tIFwiLi90YWJsZVwiO1xuaW1wb3J0IHsgVGVzdFJ1bm5lciB9IGZyb20gXCIuL3Rlc3QtcnVubmVyXCI7XG5pbXBvcnQgeyBTaW1Ub2tlbnMgfSBmcm9tIFwiLi90b2tlbnNcIjtcbmltcG9ydCB7IFRvcGljIH0gZnJvbSBcIi4vdG9waWNcIjtcbmltcG9ydCB7IFdlYnNpdGUgfSBmcm9tIFwiLi93ZWJzaXRlXCI7XG5pbXBvcnQge1xuICBBUElfRlFOLFxuICBCVUNLRVRfRlFOLFxuICBDT1VOVEVSX0ZRTixcbiAgRE9NQUlOX0ZRTixcbiAgRU5EUE9JTlRfRlFOLFxuICBGVU5DVElPTl9GUU4sXG4gIE9OX0RFUExPWV9GUU4sXG4gIFFVRVVFX0ZRTixcbiAgU0NIRURVTEVfRlFOLFxuICBTRUNSRVRfRlFOLFxuICBTRVJWSUNFX0ZRTixcbiAgVE9QSUNfRlFOLFxuICBXRUJTSVRFX0ZRTixcbn0gZnJvbSBcIi4uL2Nsb3VkXCI7XG5pbXBvcnQgeyBTREtfVkVSU0lPTiB9IGZyb20gXCIuLi9jb25zdGFudHNcIjtcbmltcG9ydCAqIGFzIGNvcmUgZnJvbSBcIi4uL2NvcmVcIjtcbmltcG9ydCB7IHByZVN5bnRoZXNpemVBbGxDb25zdHJ1Y3RzIH0gZnJvbSBcIi4uL2NvcmUvYXBwXCI7XG5pbXBvcnQgeyByZWdpc3RlclRva2VuUmVzb2x2ZXIgfSBmcm9tIFwiLi4vY29yZS90b2tlbnNcIjtcbmltcG9ydCB7IFJFRElTX0ZRTiwgVEFCTEVfRlFOIH0gZnJvbSBcIi4uL2V4XCI7XG5pbXBvcnQge1xuICBCYXNlUmVzb3VyY2VTY2hlbWEsXG4gIFR5cGVTY2hlbWEsXG4gIFdpbmdTaW11bGF0b3JTY2hlbWEsXG59IGZyb20gXCIuLi9zaW11bGF0b3JcIjtcbmltcG9ydCB7IHJlc29sdmVUb2tlbnMgfSBmcm9tIFwiLi4vc2ltdWxhdG9yL3Rva2Vuc1wiO1xuaW1wb3J0IHsgVEVTVF9SVU5ORVJfRlFOIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG4vKipcbiAqIFBhdGggb2YgdGhlIHNpbXVsYXRvciBjb25maWd1cmF0aW9uIGZpbGUgaW4gZXZlcnkgLndzaW0gdGFyYmFsbC5cbiAqL1xuZXhwb3J0IGNvbnN0IFNJTVVMQVRPUl9GSUxFX1BBVEggPSBcInNpbXVsYXRvci5qc29uXCI7XG5cbmNvbnN0IFNJTVVMQVRPUl9DTEFTU19EQVRBID0ge1xuICBbQVBJX0ZRTl06IFwiQXBpXCIsXG4gIFtCVUNLRVRfRlFOXTogXCJCdWNrZXRcIixcbiAgW0RPTUFJTl9GUU5dOiBcIkRvbWFpblwiLFxuICBbRU5EUE9JTlRfRlFOXTogXCJFbmRwb2ludFwiLFxuICBbRVZFTlRfTUFQUElOR19GUU5dOiBcIkV2ZW50TWFwcGluZ1wiLFxuICBbRlVOQ1RJT05fRlFOXTogXCJGdW5jdGlvblwiLFxuICBbT05fREVQTE9ZX0ZRTl06IFwiT25EZXBsb3lcIixcbiAgW1BPTElDWV9GUU5dOiBcIlBvbGljeVwiLFxuICBbUVVFVUVfRlFOXTogXCJRdWV1ZVwiLFxuICBbUkVESVNfRlFOXTogXCJSZWRpc1wiLFxuICBbU0NIRURVTEVfRlFOXTogXCJTY2hlZHVsZVwiLFxuICBbU0VDUkVUX0ZRTl06IFwiU2VjcmV0XCIsXG4gIFtTRVJWSUNFX0ZRTl06IFwiU2VydmljZVwiLFxuICBbU1RBVEVfRlFOXTogXCJTdGF0ZVwiLFxuICBbU0lNX0NPTlRBSU5FUl9GUU5dOiBcIkNvbnRhaW5lclwiLFxuICBbU0lNX1JFU09VUkNFX0ZRTl06IFwiUmVzb3VyY2VcIixcbiAgW1RBQkxFX0ZRTl06IFwiVGFibGVcIixcbiAgW1RFU1RfUlVOTkVSX0ZRTl06IFwiVGVzdFJ1bm5lclwiLFxuICBbVE9QSUNfRlFOXTogXCJUb3BpY1wiLFxuICBbV0VCU0lURV9GUU5dOiBcIldlYnNpdGVcIixcbn07XG5cbi8qKlxuICogQSBjb25zdHJ1Y3QgdGhhdCBrbm93cyBob3cgdG8gc3ludGhlc2l6ZSBzaW11bGF0b3IgcmVzb3VyY2VzIGludG8gYVxuICogV2luZyBzaW11bGF0b3IgKC53c2ltKSBmaWxlLlxuICovXG5leHBvcnQgY2xhc3MgQXBwIGV4dGVuZHMgY29yZS5BcHAge1xuICBwdWJsaWMgcmVhZG9ubHkgb3V0ZGlyOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBfdGFyZ2V0ID0gXCJzaW1cIjtcblxuICBwcml2YXRlIHN5bnRoZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogY29yZS5BcHBQcm9wcykge1xuICAgIC8vIGRvZXNuJ3QgYWxsb3cgY3VzdG9taXplIHRoZSByb290IGlkLSBhcyB1c2VkIGhhcmRjb2RlZCBpbiB0aGUgY29kZVxuICAgIHN1cGVyKHVuZGVmaW5lZCBhcyBhbnksIFwicm9vdFwiLCBwcm9wcyk7XG4gICAgdGhpcy5vdXRkaXIgPSBwcm9wcy5vdXRkaXIgPz8gXCIuXCI7XG4gICAgcmVnaXN0ZXJUb2tlblJlc29sdmVyKG5ldyBTaW1Ub2tlbnMoKSk7XG5cbiAgICBUZXN0UnVubmVyLl9jcmVhdGVUcmVlKHRoaXMsIHByb3BzLnJvb3RDb25zdHJ1Y3QpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX2luZmxpZ2h0Q2xpZW50Rm9yRnFuKGZxbjogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBzd2l0Y2ggKGZxbikge1xuICAgICAgY2FzZSBBUElfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi9hcGkuaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgQlVDS0VUX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vYnVja2V0LmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIERPTUFJTl9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL2RvbWFpbi5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBFTkRQT0lOVF9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL2VuZHBvaW50LmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIEVWRU5UX01BUFBJTkdfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi9ldmVudC1tYXBwaW5nLmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIEZVTkNUSU9OX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vZnVuY3Rpb24uaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgT05fREVQTE9ZX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vb24tZGVwbG95LmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIFBPTElDWV9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL3BvbGljeS5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBRVUVVRV9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL3F1ZXVlLmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIFJFRElTX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vcmVkaXMuaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgU0NIRURVTEVfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi9zY2hlZHVsZS5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBTRUNSRVRfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi9zZWNyZXQuaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgU0VSVklDRV9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL3NlcnZpY2UuaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgU1RBVEVfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi9zdGF0ZS5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBUQUJMRV9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL3RhYmxlLmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIFRFU1RfUlVOTkVSX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vdGVzdC1ydW5uZXIuaW5mbGlnaHRcIik7XG5cbiAgICAgIGNhc2UgVE9QSUNfRlFOOlxuICAgICAgICByZXR1cm4gcmVxdWlyZS5yZXNvbHZlKFwiLi90b3BpYy5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBXRUJTSVRFX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vd2Vic2l0ZS5pbmZsaWdodFwiKTtcblxuICAgICAgY2FzZSBTSU1fQ09OVEFJTkVSX0ZRTjpcbiAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShcIi4vY29udGFpbmVyLmluZmxpZ2h0XCIpO1xuXG4gICAgICBjYXNlIFNJTV9SRVNPVVJDRV9GUU46XG4gICAgICAgIHJldHVybiByZXF1aXJlLnJlc29sdmUoXCIuL3Jlc291cmNlLmluZmxpZ2h0XCIpO1xuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgdHlwZUZvckZxbihmcW46IHN0cmluZyk6IGFueSB7XG4gICAgc3dpdGNoIChmcW4pIHtcbiAgICAgIGNhc2UgQVBJX0ZRTjpcbiAgICAgICAgcmV0dXJuIEFwaTtcblxuICAgICAgY2FzZSBCVUNLRVRfRlFOOlxuICAgICAgICByZXR1cm4gQnVja2V0O1xuXG4gICAgICBjYXNlIENPVU5URVJfRlFOOlxuICAgICAgICByZXR1cm4gQ291bnRlcjtcblxuICAgICAgY2FzZSBET01BSU5fRlFOOlxuICAgICAgICByZXR1cm4gRG9tYWluO1xuXG4gICAgICBjYXNlIEVORFBPSU5UX0ZRTjpcbiAgICAgICAgcmV0dXJuIEVuZHBvaW50O1xuXG4gICAgICAvLyBFVkVOVF9NQVBQSU5HX0ZRTiBza2lwcGVkIC0gaXQncyBub3QgYSBtdWx0aS10YXJnZXQgY29uc3RydWN0XG5cbiAgICAgIGNhc2UgRlVOQ1RJT05fRlFOOlxuICAgICAgICByZXR1cm4gRnVuY3Rpb247XG5cbiAgICAgIGNhc2UgT05fREVQTE9ZX0ZRTjpcbiAgICAgICAgcmV0dXJuIE9uRGVwbG95O1xuXG4gICAgICBjYXNlIFBPTElDWV9GUU46XG4gICAgICAgIHJldHVybiBQb2xpY3k7XG5cbiAgICAgIGNhc2UgUVVFVUVfRlFOOlxuICAgICAgICByZXR1cm4gUXVldWU7XG5cbiAgICAgIGNhc2UgUkVESVNfRlFOOlxuICAgICAgICByZXR1cm4gUmVkaXM7XG5cbiAgICAgIGNhc2UgU0NIRURVTEVfRlFOOlxuICAgICAgICByZXR1cm4gU2NoZWR1bGU7XG5cbiAgICAgIGNhc2UgU0VDUkVUX0ZRTjpcbiAgICAgICAgcmV0dXJuIFNlY3JldDtcblxuICAgICAgY2FzZSBTRVJWSUNFX0ZRTjpcbiAgICAgICAgcmV0dXJuIFNlcnZpY2U7XG5cbiAgICAgIGNhc2UgU1RBVEVfRlFOOlxuICAgICAgICByZXR1cm4gU3RhdGU7XG5cbiAgICAgIGNhc2UgVEFCTEVfRlFOOlxuICAgICAgICByZXR1cm4gVGFibGU7XG5cbiAgICAgIGNhc2UgVEVTVF9SVU5ORVJfRlFOOlxuICAgICAgICByZXR1cm4gVGVzdFJ1bm5lcjtcblxuICAgICAgY2FzZSBUT1BJQ19GUU46XG4gICAgICAgIHJldHVybiBUb3BpYztcblxuICAgICAgY2FzZSBXRUJTSVRFX0ZRTjpcbiAgICAgICAgcmV0dXJuIFdlYnNpdGU7XG5cbiAgICAgIC8vIFNJTV9DT05UQUlORVJfRlFOIHNraXBwZWQgLSBpdCdzIG5vdCBhIG11bHRpLXRhcmdldCBjb25zdHJ1Y3RcblxuICAgICAgLy8gU0lNX1JFU09VUkNFX0ZRTiBza2lwcGVkIC0gaXQncyBub3QgYSBtdWx0aS10YXJnZXQgY29uc3RydWN0XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTeW50aGVzaXplIHRoZSBhcHAuIFRoaXMgY3JlYXRlcyBhIHRyZWUuanNvbiBmaWxlIGFuZCBhIC53c2ltIGZpbGUgaW4gdGhlXG4gICAqIGFwcCdzIG91dGRpciwgYW5kIHJldHVybnMgYSBwYXRoIHRvIHRoZSAud3NpbSBkaXJlY3RvcnkuXG4gICAqL1xuICBwdWJsaWMgc3ludGgoKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy5zeW50aGVkKSB7XG4gICAgICByZXR1cm4gdGhpcy5vdXRkaXI7XG4gICAgfVxuXG4gICAgZnMubWtkaXJTeW5jKHRoaXMub3V0ZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcblxuICAgIC8vIGNhbGwgcHJlU3ludGhlc2l6ZSgpIG9uIGV2ZXJ5IGNvbnN0cnVjdCBpbiB0aGUgdHJlZVxuICAgIHByZVN5bnRoZXNpemVBbGxDb25zdHJ1Y3RzKHRoaXMpO1xuXG4gICAgaWYgKHRoaXMuX3N5bnRoSG9va3M/LnByZVN5bnRoZXNpemUpIHtcbiAgICAgIHRoaXMuX3N5bnRoSG9va3MucHJlU3ludGhlc2l6ZS5mb3JFYWNoKChob29rKSA9PiBob29rKHRoaXMpKTtcbiAgICB9XG5cbiAgICAvLyB3cml0ZSBzaW11bGF0b3IuanNvbiBmaWxlIGludG8gd29ya2RpclxuICAgIGNvbnN0IHNwZWMgPSB0aGlzLnN5bnRoU2ltdWxhdG9yRmlsZSh0aGlzLm91dGRpcik7XG5cbiAgICB0aGlzLmFkZFRva2VuQ29ubmVjdGlvbnMoc3BlYyk7XG5cbiAgICAvLyB3cml0ZSB0cmVlLmpzb24gZmlsZSBpbnRvIHdvcmtkaXJcbiAgICBjb3JlLnN5bnRoZXNpemVUcmVlKHRoaXMsIHRoaXMub3V0ZGlyKTtcblxuICAgIC8vIHdyaXRlIGBvdXRkaXIvY29ubmVjdGlvbnMuanNvbmBcbiAgICBjb3JlLkNvbm5lY3Rpb25zLm9mKHRoaXMpLnN5bnRoKHRoaXMub3V0ZGlyKTtcblxuICAgIHRoaXMuc3ludGhlZCA9IHRydWU7XG5cbiAgICBpZiAodGhpcy5fc3ludGhIb29rcz8ucG9zdFN5bnRoZXNpemUpIHtcbiAgICAgIHRoaXMuX3N5bnRoSG9va3MucG9zdFN5bnRoZXNpemUuZm9yRWFjaCgoaG9vaykgPT4gaG9vayh0aGlzKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMub3V0ZGlyO1xuICB9XG5cbiAgLyoqXG4gICAqIFNjYW5zIHRoZSBhcHAgc3BlYyBmb3IgdG9rZW4gcmVmZXJlbmNlcyBhbmQgYWRkcyBjb25uZWN0aW9ucyB0byByZWZsZWN0XG4gICAqIHRoaXMgcmVsYXRpb25zaGlwLlxuICAgKlxuICAgKiBAcGFyYW0gc3BlYyBUaGUgc2ltdWxhdG9yIHNwZWNcbiAgICovXG4gIHByaXZhdGUgYWRkVG9rZW5Db25uZWN0aW9ucyhzcGVjOiBXaW5nU2ltdWxhdG9yU2NoZW1hKSB7XG4gICAgY29uc3QgbWFwOiBSZWNvcmQ8c3RyaW5nLCBJQ29uc3RydWN0PiA9IHt9O1xuICAgIGZvciAoY29uc3QgYyBvZiB0aGlzLm5vZGUuZmluZEFsbCgpKSB7XG4gICAgICBtYXBbYy5ub2RlLnBhdGhdID0gYztcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IFtmcm9tLCByZXNvdXJjZV0gb2YgT2JqZWN0LmVudHJpZXMoc3BlYy5yZXNvdXJjZXMpKSB7XG4gICAgICByZXNvbHZlVG9rZW5zKHJlc291cmNlLnByb3BzLCAodG8pID0+IHtcbiAgICAgICAgLy8gc2tpcCByZWZlcmVuY2VzIHRvIHRoZSBcImhhbmRsZVwiIG9mIHRoZSB0YXJnZXQgcmVzb3VyY2UgYmVjYXVzZSBpdCB3b3VsZCBiZSByZWZsZWN0ZWQgYnlcbiAgICAgICAgLy8gdGhlIGNvbm5lY3Rpb25zIGNyZWF0ZWQgYnkgaW5mbGlnaHQgbWV0aG9kIGNhbGxzLlxuICAgICAgICBpZiAodG8uYXR0ciAhPT0gXCJoYW5kbGVcIikge1xuICAgICAgICAgIGNvcmUuQ29ubmVjdGlvbnMub2YodGhpcykuYWRkKHtcbiAgICAgICAgICAgIHNvdXJjZTogbWFwW2Zyb21dLFxuICAgICAgICAgICAgdGFyZ2V0OiBtYXBbdG8ucGF0aF0sXG4gICAgICAgICAgICB0YXJnZXRPcDogdG8uYXR0cixcbiAgICAgICAgICAgIG5hbWU6IFwiPHJlZj5cIixcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gXCI8VE9LRU4+XCI7IC8vIDwtLSBub3QgdXNlZFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzeW50aFNpbXVsYXRvckZpbGUob3V0ZGlyOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXNvdXJjZXM6IFJlY29yZDxzdHJpbmcsIEJhc2VSZXNvdXJjZVNjaGVtYT4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IHIgb2YgbmV3IGNvcmUuRGVwZW5kZW5jeUdyYXBoKHRoaXMubm9kZSkudG9wb2xvZ3koKSkge1xuICAgICAgaWYgKGlzU2ltdWxhdG9yUmVzb3VyY2UocikpIHtcbiAgICAgICAgY29uc3QgZGVwcyA9IHIubm9kZS5kZXBlbmRlbmNpZXMubWFwKChkKSA9PiBkLm5vZGUucGF0aCk7XG4gICAgICAgIHJlc291cmNlc1tyLm5vZGUucGF0aF0gPSB7XG4gICAgICAgICAgLi4uci50b1NpbXVsYXRvcigpLFxuICAgICAgICAgIHBhdGg6IHIubm9kZS5wYXRoLFxuICAgICAgICAgIGFkZHI6IHIubm9kZS5hZGRyLFxuICAgICAgICAgIGRlcHM6IGRlcHMubGVuZ3RoID09PSAwID8gdW5kZWZpbmVkIDogZGVwcyxcbiAgICAgICAgICBhdHRyczogdW5kZWZpbmVkIGFzIGFueSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB0eXBlczogeyBbZnFuOiBzdHJpbmddOiBUeXBlU2NoZW1hIH0gPSB7fTtcbiAgICBmb3IgKGNvbnN0IFtmcW4sIGNsYXNzTmFtZV0gb2YgT2JqZWN0LmVudHJpZXMoU0lNVUxBVE9SX0NMQVNTX0RBVEEpKSB7XG4gICAgICBjb25zdCBzb3VyY2VQYXRoID0gdGhpcy5faW5mbGlnaHRDbGllbnRGb3JGcW4oZnFuKTtcbiAgICAgIGlmICghc291cmNlUGF0aCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIHNvdXJjZSBwYXRoIGZvciAke2Zxbn1gKTtcbiAgICAgIH1cbiAgICAgIHR5cGVzW2Zxbl0gPSB7XG4gICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAgc291cmNlUGF0aCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgY29udGVudHM6IFdpbmdTaW11bGF0b3JTY2hlbWEgPSB7XG4gICAgICB0eXBlcyxcbiAgICAgIHJlc291cmNlcyxcbiAgICAgIHNka1ZlcnNpb246IFNES19WRVJTSU9OLFxuICAgIH07XG5cbiAgICAvLyB3cml0ZSBzaW11bGF0b3IuanNvbiBmaWxlXG4gICAgZnMud3JpdGVGaWxlU3luYyhcbiAgICAgIHBhdGguam9pbihvdXRkaXIsIFNJTVVMQVRPUl9GSUxFX1BBVEgpLFxuICAgICAgSlNPTi5zdHJpbmdpZnkoY29udGVudHMsIHVuZGVmaW5lZCwgMiksXG4gICAgICB7IGVuY29kaW5nOiBcInV0ZjhcIiB9XG4gICAgKTtcblxuICAgIHJldHVybiBjb250ZW50cztcbiAgfVxufVxuIl19