"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TopicOnMessageHandler = exports.Topic = void 0;
const app_1 = require("./app");
const event_mapping_1 = require("./event-mapping");
const policy_1 = require("./policy");
const util_1 = require("./util");
const cloud_1 = require("../cloud");
const cloud = __importStar(require("../cloud"));
const core_1 = require("../core");
const std_1 = require("../std");
/**
 * Simulator implementation of `cloud.Topic`
 *
 * @inflight `@winglang/sdk.cloud.ITopicClient`
 */
class Topic extends cloud.Topic {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        this.policy = new policy_1.Policy(this, "Policy", { principal: this });
    }
    onMessage(inflight, props = {}) {
        const functionHandler = TopicOnMessageHandler.toFunctionHandler(inflight);
        const fn = new cloud_1.Function(this, app_1.App.of(this).makeId(this, "OnMessage"), functionHandler, props);
        std_1.Node.of(fn).sourceModule = std_1.SDK_SOURCE_MODULE;
        std_1.Node.of(fn).title = "Subscriber";
        new event_mapping_1.EventMapping(this, app_1.App.of(this).makeId(this, "TopicEventMapping"), {
            subscriber: fn,
            publisher: this,
            subscriptionProps: {},
        });
        std_1.Node.of(this).addConnection({
            source: this,
            sourceOp: cloud.TopicInflightMethods.PUBLISH,
            target: fn,
            targetOp: cloud.FunctionInflightMethods.INVOKE,
            name: "subscriber",
        });
        this.policy.addStatement(fn, cloud.FunctionInflightMethods.INVOKE_ASYNC);
        return fn;
    }
    subscribeQueue(queue) {
        const fn = new cloud_1.Function(this, app_1.App.of(this).makeId(this, "subscribeQueue"), (0, core_1.lift)({ queue })
            .grant({ queue: ["push"] })
            .inflight(async (ctx, event) => {
            await ctx.queue.push(event);
            return undefined;
        }), {});
        std_1.Node.of(fn).sourceModule = std_1.SDK_SOURCE_MODULE;
        std_1.Node.of(fn).title = "QueueSubscriber";
        std_1.Node.of(fn).hidden = true;
        new event_mapping_1.EventMapping(this, app_1.App.of(this).makeId(this, "TopicEventMapping"), {
            subscriber: fn,
            publisher: this,
            subscriptionProps: {},
        });
        std_1.Node.of(this).addConnection({
            source: this,
            sourceOp: cloud.TopicInflightMethods.PUBLISH,
            target: fn,
            targetOp: cloud.FunctionInflightMethods.INVOKE_ASYNC,
            name: "push",
        });
        this.policy.addStatement(fn, cloud.FunctionInflightMethods.INVOKE_ASYNC);
    }
    onLift(host, ops) {
        (0, util_1.bindSimulatorResource)(__filename, this, host, ops);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return (0, util_1.makeSimulatorJsClient)(__filename, this);
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud.QueueInflightMethods.PUSH]: [],
            [cloud.TopicInflightMethods.PUBLISH]: [],
        };
    }
    toSimulator() {
        const props = {};
        return {
            type: cloud.TOPIC_FQN,
            props,
        };
    }
}
exports.Topic = Topic;
/**
 * Utility class to work with topic message handlers.
 */
class TopicOnMessageHandler {
    /**
     * Converts a `cloud.ITopicOnMessageHandler` to a `cloud.IFunctionHandler`
     * @param handler the handler to convert
     * @returns the function handler
     */
    static toFunctionHandler(handler) {
        return (0, core_1.lift)({ handler }).inflight(async (ctx, event) => {
            await ctx.handler(event);
            return undefined;
        });
    }
}
exports.TopicOnMessageHandler = TopicOnMessageHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9waWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXNpbS90b3BpYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLCtCQUE0QjtBQUM1QixtREFBK0M7QUFDL0MscUNBQWtDO0FBR2xDLGlDQUFzRTtBQUN0RSxvQ0FBb0M7QUFDcEMsZ0RBQWtDO0FBQ2xDLGtDQUF3QztBQUV4QyxnQ0FBZ0U7QUFFaEU7Ozs7R0FJRztBQUNILE1BQWEsS0FBTSxTQUFRLEtBQUssQ0FBQyxLQUFLO0lBRXBDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBMEIsRUFBRTtRQUNwRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRU0sU0FBUyxDQUNkLFFBQXNDLEVBQ3RDLFFBQXFDLEVBQUU7UUFFdkMsTUFBTSxlQUFlLEdBQUcscUJBQXFCLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxnQkFBUSxDQUNyQixJQUFJLEVBQ0osU0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxFQUN0QyxlQUFlLEVBQ2YsS0FBSyxDQUNOLENBQUM7UUFDRixVQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFlBQVksR0FBRyx1QkFBaUIsQ0FBQztRQUM3QyxVQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxZQUFZLENBQUM7UUFFakMsSUFBSSw0QkFBWSxDQUFDLElBQUksRUFBRSxTQUFHLENBQUMs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QixJQUFXLFFBQVE7UUFDakIsT0FBTztZQUNMLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDckMsQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRTtTQUN6QyxDQUFDO0lBQ0osQ0FBQztJQUVNLFdBQVc7UUFDaEIsTUFBTSxLQUFLLEdBQWdCLEVBQUUsQ0FBQztRQUM5QixPQUFPO1lBQ0wsSUFBSSxFQUFFLEtBQUssQ0FBQyxTQUFTO1lBQ3JCLEtBQUs7U0FDTixDQUFDO0lBQ0osQ0FBQztDQUNGO0FBbEdELHNCQWtHQztBQUVEOztHQUVHO0FBQ0gsTUFBYSxxQkFBcUI7SUFDaEM7Ozs7T0FJRztJQUNJLE1BQU0sQ0FBQyxpQkFBaUIsQ0FDN0IsT0FBcUM7UUFFckMsT0FBTyxJQUFBLFdBQUksRUFBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDckQsTUFBTSxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQWUsQ0FBQyxDQUFDO1lBQ25DLE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBZEQsc0RBY0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vYXBwXCI7XG5pbXBvcnQgeyBFdmVudE1hcHBpbmcgfSBmcm9tIFwiLi9ldmVudC1tYXBwaW5nXCI7XG5pbXBvcnQgeyBQb2xpY3kgfSBmcm9tIFwiLi9wb2xpY3lcIjtcbmltcG9ydCB7IElTaW11bGF0b3JSZXNvdXJjZSB9IGZyb20gXCIuL3Jlc291cmNlXCI7XG5pbXBvcnQgeyBUb3BpY1NjaGVtYSB9IGZyb20gXCIuL3NjaGVtYS1yZXNvdXJjZXNcIjtcbmltcG9ydCB7IGJpbmRTaW11bGF0b3JSZXNvdXJjZSwgbWFrZVNpbXVsYXRvckpzQ2xpZW50IH0gZnJvbSBcIi4vdXRpbFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gfSBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCAqIGFzIGNsb3VkIGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0IHsgbGlmdCwgTGlmdE1hcCB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBUb1NpbXVsYXRvck91dHB1dCB9IGZyb20gXCIuLi9zaW11bGF0b3JcIjtcbmltcG9ydCB7IElJbmZsaWdodEhvc3QsIE5vZGUsIFNES19TT1VSQ0VfTU9EVUxFIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG4vKipcbiAqIFNpbXVsYXRvciBpbXBsZW1lbnRhdGlvbiBvZiBgY2xvdWQuVG9waWNgXG4gKlxuICogQGluZmxpZ2h0IGBAd2luZ2xhbmcvc2RrLmNsb3VkLklUb3BpY0NsaWVudGBcbiAqL1xuZXhwb3J0IGNsYXNzIFRvcGljIGV4dGVuZHMgY2xvdWQuVG9waWMgaW1wbGVtZW50cyBJU2ltdWxhdG9yUmVzb3VyY2Uge1xuICBwdWJsaWMgcmVhZG9ubHkgcG9saWN5OiBQb2xpY3k7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBjbG91ZC5Ub3BpY1Byb3BzID0ge30pIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICB0aGlzLnBvbGljeSA9IG5ldyBQb2xpY3kodGhpcywgXCJQb2xpY3lcIiwgeyBwcmluY2lwYWw6IHRoaXMgfSk7XG4gIH1cblxuICBwdWJsaWMgb25NZXNzYWdlKFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JVG9waWNPbk1lc3NhZ2VIYW5kbGVyLFxuICAgIHByb3BzOiBjbG91ZC5Ub3BpY09uTWVzc2FnZU9wdGlvbnMgPSB7fVxuICApOiBjbG91ZC5GdW5jdGlvbiB7XG4gICAgY29uc3QgZnVuY3Rpb25IYW5kbGVyID0gVG9waWNPbk1lc3NhZ2VIYW5kbGVyLnRvRnVuY3Rpb25IYW5kbGVyKGluZmxpZ2h0KTtcbiAgICBjb25zdCBmbiA9IG5ldyBGdW5jdGlvbihcbiAgICAgIHRoaXMsXG4gICAgICBBcHAub2YodGhpcykubWFrZUlkKHRoaXMsIFwiT25NZXNzYWdlXCIpLFxuICAgICAgZnVuY3Rpb25IYW5kbGVyLFxuICAgICAgcHJvcHNcbiAgICApO1xuICAgIE5vZGUub2YoZm4pLnNvdXJjZU1vZHVsZSA9IFNES19TT1VSQ0VfTU9EVUxFO1xuICAgIE5vZGUub2YoZm4pLnRpdGxlID0gXCJTdWJzY3JpYmVyXCI7XG5cbiAgICBuZXcgRXZlbnRNYXBwaW5nKHRoaXMsIEFwcC5vZih0aGlzKS5tYWtlSWQodGhpcywgXCJUb3BpY0V2ZW50TWFwcGluZ1wiKSwge1xuICAgICAgc3Vic2NyaWJlcjogZm4sXG4gICAgICBwdWJsaXNoZXI6IHRoaXMsXG4gICAgICBzdWJzY3JpcHRpb25Qcm9wczoge30sXG4gICAgfSk7XG5cbiAgICBOb2RlLm9mKHRoaXMpLmFkZENvbm5lY3Rpb24oe1xuICAgICAgc291cmNlOiB0aGlzLFxuICAgICAgc291cmNlT3A6IGNsb3VkLlRvcGljSW5mbGlnaHRNZXRob2RzLlBVQkxJU0gsXG4gICAgICB0YXJnZXQ6IGZuLFxuICAgICAgdGFyZ2V0T3A6IGNsb3VkLkZ1bmN0aW9uSW5mbGlnaHRNZXRob2RzLklOVk9LRSxcbiAgICAgIG5hbWU6IFwic3Vic2NyaWJlclwiLFxuICAgIH0pO1xuXG4gICAgdGhpcy5wb2xpY3kuYWRkU3RhdGVtZW50KGZuLCBjbG91ZC5GdW5jdGlvbkluZmxpZ2h0TWV0aG9kcy5JTlZPS0VfQVNZTkMpO1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHVibGljIHN1YnNjcmliZVF1ZXVlKHF1ZXVlOiBjbG91ZC5RdWV1ZSk6IHZvaWQge1xuICAgIGNvbnN0IGZuID0gbmV3IEZ1bmN0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIEFwcC5vZih0aGlzKS5tYWtlSWQodGhpcywgXCJzdWJzY3JpYmVRdWV1ZVwiKSxcbiAgICAgIGxpZnQoeyBxdWV1ZSB9KVxuICAgICAgICAuZ3JhbnQoeyBxdWV1ZTogW1wicHVzaFwiXSB9KVxuICAgICAgICAuaW5mbGlnaHQoYXN5bmMgKGN0eCwgZXZlbnQpID0+IHtcbiAgICAgICAgICBhd2FpdCBjdHgucXVldWUucHVzaChldmVudCBhcyBzdHJpbmcpO1xuICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH0pLFxuICAgICAge31cbiAgICApO1xuICAgIE5vZGUub2YoZm4pLnNvdXJjZU1vZHVsZSA9IFNES19TT1VSQ0VfTU9EVUxFO1xuICAgIE5vZGUub2YoZm4pLnRpdGxlID0gXCJRdWV1ZVN1YnNjcmliZXJcIjtcbiAgICBOb2RlLm9mKGZuKS5oaWRkZW4gPSB0cnVlO1xuXG4gICAgbmV3IEV2ZW50TWFwcGluZyh0aGlzLCBBcHAub2YodGhpcykubWFrZUlkKHRoaXMsIFwiVG9waWNFdmVudE1hcHBpbmdcIiksIHtcbiAgICAgIHN1YnNjcmliZXI6IGZuLFxuICAgICAgcHVibGlzaGVyOiB0aGlzLFxuICAgICAgc3Vic2NyaXB0aW9uUHJvcHM6IHt9LFxuICAgIH0pO1xuXG4gICAgTm9kZS5vZih0aGlzKS5hZGRDb25uZWN0aW9uKHtcbiAgICAgIHNvdXJjZTogdGhpcyxcbiAgICAgIHNvdXJjZU9wOiBjbG91ZC5Ub3BpY0luZmxpZ2h0TWV0aG9kcy5QVUJMSVNILFxuICAgICAgdGFyZ2V0OiBmbixcbiAgICAgIHRhcmdldE9wOiBjbG91ZC5GdW5jdGlvbkluZmxpZ2h0TWV0aG9kcy5JTlZPS0VfQVNZTkMsXG4gICAgICBuYW1lOiBcInB1c2hcIixcbiAgICB9KTtcblxuICAgIHRoaXMucG9saWN5LmFkZFN0YXRlbWVudChmbiwgY2xvdWQuRnVuY3Rpb25JbmZsaWdodE1ldGhvZHMuSU5WT0tFX0FTWU5DKTtcbiAgfVxuXG4gIHB1YmxpYyBvbkxpZnQoaG9zdDogSUluZmxpZ2h0SG9zdCwgb3BzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIGJpbmRTaW11bGF0b3JSZXNvdXJjZShfX2ZpbGVuYW1lLCB0aGlzLCBob3N0LCBvcHMpO1xuICAgIHN1cGVyLm9uTGlmdChob3N0LCBvcHMpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3RvSW5mbGlnaHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gbWFrZVNpbXVsYXRvckpzQ2xpZW50KF9fZmlsZW5hbWUsIHRoaXMpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgZ2V0IF9saWZ0TWFwKCk6IExpZnRNYXAge1xuICAgIHJldHVybiB7XG4gICAgICBbY2xvdWQuUXVldWVJbmZsaWdodE1ldGhvZHMuUFVTSF06IFtdLFxuICAgICAgW2Nsb3VkLlRvcGljSW5mbGlnaHRNZXRob2RzLlBVQkxJU0hdOiBbXSxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIHRvU2ltdWxhdG9yKCk6IFRvU2ltdWxhdG9yT3V0cHV0IHtcbiAgICBjb25zdCBwcm9wczogVG9waWNTY2hlbWEgPSB7fTtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogY2xvdWQuVE9QSUNfRlFOLFxuICAgICAgcHJvcHMsXG4gICAgfTtcbiAgfVxufVxuXG4vKipcbiAqIFV0aWxpdHkgY2xhc3MgdG8gd29yayB3aXRoIHRvcGljIG1lc3NhZ2UgaGFuZGxlcnMuXG4gKi9cbmV4cG9ydCBjbGFzcyBUb3BpY09uTWVzc2FnZUhhbmRsZXIge1xuICAvKipcbiAgICogQ29udmVydHMgYSBgY2xvdWQuSVRvcGljT25NZXNzYWdlSGFuZGxlcmAgdG8gYSBgY2xvdWQuSUZ1bmN0aW9uSGFuZGxlcmBcbiAgICogQHBhcmFtIGhhbmRsZXIgdGhlIGhhbmRsZXIgdG8gY29udmVydFxuICAgKiBAcmV0dXJucyB0aGUgZnVuY3Rpb24gaGFuZGxlclxuICAgKi9cbiAgcHVibGljIHN0YXRpYyB0b0Z1bmN0aW9uSGFuZGxlcihcbiAgICBoYW5kbGVyOiBjbG91ZC5JVG9waWNPbk1lc3NhZ2VIYW5kbGVyXG4gICk6IGNsb3VkLklGdW5jdGlvbkhhbmRsZXIge1xuICAgIHJldHVybiBsaWZ0KHsgaGFuZGxlciB9KS5pbmZsaWdodChhc3luYyAoY3R4LCBldmVudCkgPT4ge1xuICAgICAgYXdhaXQgY3R4LmhhbmRsZXIoZXZlbnQgYXMgc3RyaW5nKTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==