"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Endpoint = void 0;
const fs_1 = require("fs");
const promises_1 = require("node:fs/promises");
const node_path_1 = require("node:path");
const wingtunnels_1 = require("@winglang/wingtunnels");
const util_1 = require("./util");
const simulator_1 = require("../simulator");
const STATE_FILENAME = "state.json";
class Endpoint {
    constructor(_props) {
        this._props = _props;
        this.status = "disconnected";
    }
    get context() {
        if (!this._context) {
            throw new Error("Cannot access context during class construction");
        }
        return this._context;
    }
    async init(context) {
        this._context = context;
        const state = await this.loadState();
        if (state.subdomain) {
            await this.connect(state.subdomain);
        }
        return {
            inputUrl: this._props.inputUrl,
            url: this.connectResponse?.url ?? this._props.url,
            label: this._props.label,
            browserSupport: this._props.browserSupport,
        };
    }
    async cleanup() {
        this.connectResponse?.close();
    }
    async save() {
        return this.saveState({
            ...(this.lastSubdomain && { subdomain: this.lastSubdomain }),
        });
    }
    async plan() {
        return simulator_1.UpdatePlan.AUTO;
    }
    async expose() {
        if (this.status === "connecting" || this.status === "connected") {
            throw new Error("Can only expose when status is disconnected.");
        }
        return this.connect();
    }
    async hide() {
        this.connectResponse?.close();
        this.connectResponse = undefined;
        this.lastSubdomain = undefined;
        this.status = "disconnected";
    }
    async exposeStatus() {
        return this.status;
    }
    async loadState() {
        const stateFileExists = await (0, util_1.exists)((0, node_path_1.join)(this.context.statedir, STATE_FILENAME));
        if (stateFileExists) {
            const stateFileContents = await (0, promises_1.readFile)((0, node_path_1.join)(this.context.statedir, STATE_FILENAME), "utf-8");
            return JSON.parse(stateFileContents);
        }
        else {
            return {};
        }
    }
    async saveState(state) {
        (0, fs_1.writeFileSync)((0, node_path_1.join)(this.context.statedir, STATE_FILENAME), JSON.stringify(state));
    }
    async connect(subdomain) {
        try {
            await this.context.withTrace({
                message: `Creating tunnel for endpoint. ${subdomain ? `Using subdomain: ${subdomain}` : ""}`,
                activity: async () => {
                    this.status = "connecting";
                    this.connectResponse = await (0, wingtunnels_1.connect)(this._props.inputUrl, {
                        subdomain,
                    });
                    this.lastSubdomain = new URL(this.connectResponse.url).hostname.split(".")[0];
                    this.status = "connected";
                },
            });
        }
        catch {
            this.status = "disconnected";
        }
    }
}
exports.Endpoint = Endpoint;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5kcG9pbnQuaW5mbGlnaHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXNpbS9lbmRwb2ludC5pbmZsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQkFBbUM7QUFDbkMsK0NBQTRDO0FBQzVDLHlDQUFpQztBQUNqQyx1REFBaUU7QUFFakUsaUNBQWdDO0FBRWhDLDRDQUlzQjtBQUV0QixNQUFNLGNBQWMsR0FBRyxZQUFZLENBQUM7QUFjcEMsTUFBYSxRQUFRO0lBTW5CLFlBQTZCLE1BQXNCO1FBQXRCLFdBQU0sR0FBTixNQUFNLENBQWdCO1FBSDNDLFdBQU0sR0FBeUIsY0FBYyxDQUFDO0lBR0EsQ0FBQztJQUV2RCxJQUFZLE9BQU87UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBRU0sS0FBSyxDQUFDLElBQUksQ0FBQyxPQUEwQjtRQUMxQyxJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN4QixNQUFNLEtBQUssR0FBc0IsTUFBTSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDeEQsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDcEIsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN0QyxDQUFDO1FBRUQsT0FBTztZQUNMLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVE7WUFDOUIsR0FBRyxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUUsR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRztZQUNqRCxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLO1lBQ3hCLGNBQWMsRUFBRSxJ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QUksQ0FBQyxNQUFNLEdBQUcsV0FBVyxDQUFDO2dCQUM1QixDQUFDO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE1BQU0sQ0FBQztZQUNQLElBQUksQ0FBQyxNQUFNLEdBQUcsY0FBYyxDQUFDO1FBQy9CLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUF6R0QsNEJBeUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgd3JpdGVGaWxlU3luYyB9IGZyb20gXCJmc1wiO1xuaW1wb3J0IHsgcmVhZEZpbGUgfSBmcm9tIFwibm9kZTpmcy9wcm9taXNlc1wiO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gXCJub2RlOnBhdGhcIjtcbmltcG9ydCB7IGNvbm5lY3QsIENvbm5lY3RSZXNwb25zZSB9IGZyb20gXCJAd2luZ2xhbmcvd2luZ3R1bm5lbHNcIjtcbmltcG9ydCB7IEVuZHBvaW50QXR0cmlidXRlcywgRW5kcG9pbnRTY2hlbWEgfSBmcm9tIFwiLi9zY2hlbWEtcmVzb3VyY2VzXCI7XG5pbXBvcnQgeyBleGlzdHMgfSBmcm9tIFwiLi91dGlsXCI7XG5pbXBvcnQgeyBJRW5kcG9pbnRDbGllbnQgfSBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCB7XG4gIElTaW11bGF0b3JDb250ZXh0LFxuICBJU2ltdWxhdG9yUmVzb3VyY2VJbnN0YW5jZSxcbiAgVXBkYXRlUGxhbixcbn0gZnJvbSBcIi4uL3NpbXVsYXRvclwiO1xuXG5jb25zdCBTVEFURV9GSUxFTkFNRSA9IFwic3RhdGUuanNvblwiO1xuXG4vKipcbiAqIENvbnRlbnRzIG9mIHRoZSBzdGF0ZSBmaWxlIGZvciB0aGlzIHJlc291cmNlLlxuICovXG5pbnRlcmZhY2UgU3RhdGVGaWxlQ29udGVudHMge1xuICAvKipcbiAgICogVGhlIGxhc3Qgc3ViZG9tYWluIHVzZWQgYnkgdGhlIHR1bm5lbCBvbiBhIHByZXZpb3VzIHNpbXVsYXRvciBydW4uXG4gICAqL1xuICByZWFkb25seSBzdWJkb21haW4/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIEVuZHBvaW50RXhwb3NlU3RhdHVzID0gXCJjb25uZWN0ZWRcIiB8IFwiZGlzY29ubmVjdGVkXCIgfCBcImNvbm5lY3RpbmdcIjtcblxuZXhwb3J0IGNsYXNzIEVuZHBvaW50IGltcGxlbWVudHMgSUVuZHBvaW50Q2xpZW50LCBJU2ltdWxhdG9yUmVzb3VyY2VJbnN0YW5jZSB7XG4gIHByaXZhdGUgY29ubmVjdFJlc3BvbnNlPzogQ29ubmVjdFJlc3BvbnNlO1xuICBwcml2YXRlIGxhc3RTdWJkb21haW4/OiBzdHJpbmc7XG4gIHByaXZhdGUgc3RhdHVzOiBFbmRwb2ludEV4cG9zZVN0YXR1cyA9IFwiZGlzY29ubmVjdGVkXCI7XG4gIHByaXZhdGUgX2NvbnRleHQ6IElTaW11bGF0b3JDb250ZXh0IHwgdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgX3Byb3BzOiBFbmRwb2ludFNjaGVtYSkge31cblxuICBwcml2YXRlIGdldCBjb250ZXh0KCk6IElTaW11bGF0b3JDb250ZXh0IHtcbiAgICBpZiAoIXRoaXMuX2NvbnRleHQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBhY2Nlc3MgY29udGV4dCBkdXJpbmcgY2xhc3MgY29uc3RydWN0aW9uXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fY29udGV4dDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBpbml0KGNvbnRleHQ6IElTaW11bGF0b3JDb250ZXh0KTogUHJvbWlzZTxFbmRwb2ludEF0dHJpYnV0ZXM+IHtcbiAgICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDtcbiAgICBjb25zdCBzdGF0ZTogU3RhdGVGaWxlQ29udGVudHMgPSBhd2FpdCB0aGlzLmxvYWRTdGF0ZSgpO1xuICAgIGlmIChzdGF0ZS5zdWJkb21haW4pIHtcbiAgICAgIGF3YWl0IHRoaXMuY29ubmVjdChzdGF0ZS5zdWJkb21haW4pO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBpbnB1dFVybDogdGhpcy5fcHJvcHMuaW5wdXRVcmwsXG4gICAgICB1cmw6IHRoaXMuY29ubmVjdFJlc3BvbnNlPy51cmwgPz8gdGhpcy5fcHJvcHMudXJsLFxuICAgICAgbGFiZWw6IHRoaXMuX3Byb3BzLmxhYmVsLFxuICAgICAgYnJvd3NlclN1cHBvcnQ6IHRoaXMuX3Byb3BzLmJyb3dzZXJTdXBwb3J0LFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY2xlYW51cCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmNvbm5lY3RSZXNwb25zZT8uY2xvc2UoKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzYXZlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLnNhdmVTdGF0ZSh7XG4gICAgICAuLi4odGhpcy5sYXN0U3ViZG9tYWluICYmIHsgc3ViZG9tYWluOiB0aGlzLmxhc3RTdWJkb21haW4gfSksXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcGxhbigpIHtcbiAgICByZXR1cm4gVXBkYXRlUGxhbi5BVVRPO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGV4cG9zZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5zdGF0dXMgPT09IFwiY29ubmVjdGluZ1wiIHx8IHRoaXMuc3RhdHVzID09PSBcImNvbm5lY3RlZFwiKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW4gb25seSBleHBvc2Ugd2hlbiBzdGF0dXMgaXMgZGlzY29ubmVjdGVkLlwiKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdCgpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGhpZGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5jb25uZWN0UmVzcG9uc2U/LmNsb3NlKCk7XG4gICAgdGhpcy5jb25uZWN0UmVzcG9uc2UgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5sYXN0U3ViZG9tYWluID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuc3RhdHVzID0gXCJkaXNjb25uZWN0ZWRcIjtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBleHBvc2VTdGF0dXMoKTogUHJvbWlzZTxFbmRwb2ludEV4cG9zZVN0YXR1cz4ge1xuICAgIHJldHVybiB0aGlzLnN0YXR1cztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZFN0YXRlKCk6IFByb21pc2U8U3RhdGVGaWxlQ29udGVudHM+IHtcbiAgICBjb25zdCBzdGF0ZUZpbGVFeGlzdHMgPSBhd2FpdCBleGlzdHMoXG4gICAgICBqb2luKHRoaXMuY29udGV4dC5zdGF0ZWRpciwgU1RBVEVfRklMRU5BTUUpXG4gICAgKTtcbiAgICBpZiAoc3RhdGVGaWxlRXhpc3RzKSB7XG4gICAgICBjb25zdCBzdGF0ZUZpbGVDb250ZW50cyA9IGF3YWl0IHJlYWRGaWxlKFxuICAgICAgICBqb2luKHRoaXMuY29udGV4dC5zdGF0ZWRpciwgU1RBVEVfRklMRU5BTUUpLFxuICAgICAgICBcInV0Zi04XCJcbiAgICAgICk7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShzdGF0ZUZpbGVDb250ZW50cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNhdmVTdGF0ZShzdGF0ZTogU3RhdGVGaWxlQ29udGVudHMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB3cml0ZUZpbGVTeW5jKFxuICAgICAgam9pbih0aGlzLmNvbnRleHQuc3RhdGVkaXIsIFNUQVRFX0ZJTEVOQU1FKSxcbiAgICAgIEpTT04uc3RyaW5naWZ5KHN0YXRlKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNvbm5lY3Qoc3ViZG9tYWluPzogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgICBtZXNzYWdlOiBgQ3JlYXRpbmcgdHVubmVsIGZvciBlbmRwb2ludC4gJHtcbiAgICAgICAgICBzdWJkb21haW4gPyBgVXNpbmcgc3ViZG9tYWluOiAke3N1YmRvbWFpbn1gIDogXCJcIlxuICAgICAgICB9YCxcbiAgICAgICAgYWN0aXZpdHk6IGFzeW5jICgpID0+IHtcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9IFwiY29ubmVjdGluZ1wiO1xuICAgICAgICAgIHRoaXMuY29ubmVjdFJlc3BvbnNlID0gYXdhaXQgY29ubmVjdCh0aGlzLl9wcm9wcy5pbnB1dFVybCwge1xuICAgICAgICAgICAgc3ViZG9tYWluLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMubGFzdFN1YmRvbWFpbiA9IG5ldyBVUkwodGhpcy5jb25uZWN0UmVzcG9uc2UudXJsKS5ob3N0bmFtZS5zcGxpdChcbiAgICAgICAgICAgIFwiLlwiXG4gICAgICAgICAgKVswXTtcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9IFwiY29ubmVjdGVkXCI7XG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIHtcbiAgICAgIHRoaXMuc3RhdHVzID0gXCJkaXNjb25uZWN0ZWRcIjtcbiAgICB9XG4gIH1cbn1cbiJdfQ==