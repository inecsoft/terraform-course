"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Bucket = exports.METADATA_FILENAME = void 0;
const crypto = __importStar(require("crypto"));
const fs = __importStar(require("fs"));
const path_1 = require("path");
const url = __importStar(require("url"));
const mime_types_1 = __importDefault(require("mime-types"));
const util_1 = require("./util");
const cloud_1 = require("../cloud");
const serialization_1 = require("../simulator/serialization");
const simulator_1 = require("../simulator/simulator");
const std_1 = require("../std");
exports.METADATA_FILENAME = "metadata.json";
class Bucket {
    constructor(props) {
        this.initialObjects = props.initialObjects ?? {};
        this._public = props.public ?? false;
        this.topicHandlers = props.topics;
        this._metadata = new Map();
    }
    get context() {
        if (!this._context) {
            throw new Error("Cannot access context during class construction");
        }
        return this._context;
    }
    async init(context) {
        this._context = context;
        this._fileDir = (0, path_1.join)(context.statedir, "files");
        const fileDirExists = await (0, util_1.exists)(this._fileDir);
        if (!fileDirExists) {
            await fs.promises.mkdir(this._fileDir, { recursive: true });
        }
        const metadataFileExists = await (0, util_1.exists)((0, path_1.join)(this.context.statedir, exports.METADATA_FILENAME));
        if (metadataFileExists) {
            const metadataContents = await fs.promises.readFile((0, path_1.join)(this.context.statedir, exports.METADATA_FILENAME), "utf-8");
            try {
                const metadata = (0, serialization_1.deserialize)(metadataContents);
                this._metadata = new Map(metadata);
            }
            catch (e) {
                this.addTrace(`Failed to deserialize metadata: ${e.stack}`, std_1.LogLevel.ERROR);
            }
        }
        for (const [key, value] of Object.entries(this.initialObjects)) {
            await this.context.withTrace({
                message: `Adding object from preflight (key=${key}).`,
                activity: async () => {
                    return this.addFile(key, value);
                },
            });
        }
        return {};
    }
    async cleanup() { }
    async plan() {
        return simulator_1.UpdatePlan.AUTO;
    }
    async save() {
        // no need to save individual files, since they are already persisted in the state dir
        // during the bucket's lifecycle
        fs.writeFileSync((0, path_1.join)(this.context.statedir, exports.METADATA_FILENAME), (0, serialization_1.serialize)(Array.from(this._metadata.entries())) // metadata contains Datetime values, so we need to serialize it
        );
    }
    async notifyListeners(actionType, key) {
        if (!this.topicHandlers[actionType]) {
            return;
        }
        const topicClient = this.context.getClient(this.topicHandlers[actionType]);
        return topicClient.publish(key);
    }
    async exists(key) {
        return this.context.withTrace({
            message: `Exists (key=${key}).`,
            activity: async () => {
                return this._metadata.has(key);
            },
        });
    }
    async put(key, value, opts) {
        return this.context.withTrace({
            message: `Put (key=${key}).`,
            activity: async () => {
                await this.addFile(key, value, opts?.contentType);
            },
        });
    }
    async putJson(key, body) {
        return this.context.withTrace({
            message: `Put Json (key=${key}).`,
            activity: async () => {
                await this.addFile(key, JSON.stringify(body, null, 2), "application/json");
            },
        });
    }
    async get(key, options) {
        return this.context.withTrace({
            message: `Get (key=${key}).`,
            activity: async () => {
                const hash = this.hashKey(key);
                const filename = (0, path_1.join)(this._fileDir, hash);
                let buffer;
                try {
                    const file = await fs.promises.open(filename, "r");
                    const stat = await file.stat();
                    let start = 0;
                    if (options?.startByte !== undefined) {
                        start = options.startByte;
                    }
                    let length = stat.size;
                    if (options?.endByte !== undefined) {
                        length = options.endByte + 1;
                    }
                    buffer = Buffer.alloc(length - start);
                    await file.read(buffer, 0, length - start, start);
                    await file.close();
                }
                catch (e) {
                    buffer = undefined;
                }
                if (!buffer) {
                    throw new Error(`Object does not exist (key=${key}).`);
                }
                try {
                    return new TextDecoder("utf8", { fatal: true }).decode(buffer);
                }
                catch (e) {
                    throw new Error(`Object content could not be read as text (key=${key}): ${e.stack})}`);
                }
            },
        });
    }
    async tryGet(key, options) {
        if (await this.exists(key)) {
            return this.get(key, options);
        }
        return undefined;
    }
    async getJson(key) {
        return this.context.withTrace({
            message: `Get Json (key=${key}).`,
            activity: async () => {
                const hash = this.hashKey(key);
                const filename = (0, path_1.join)(this._fileDir, hash);
                return JSON.parse(await fs.promises.readFile(filename, "utf8"));
            },
        });
    }
    async tryGetJson(key) {
        if (await this.exists(key)) {
            return this.getJson(key);
        }
        return undefined;
    }
    async delete(key, opts) {
        return this.context.withTrace({
            message: `Delete (key=${key}).`,
            activity: async () => {
                const mustExist = opts?.mustExist ?? false;
                if (!this._metadata.has(key) && mustExist) {
                    throw new Error(`Object does not exist (key=${key}).`);
                }
                if (!this._metadata.has(key)) {
                    return;
                }
                const hash = this.hashKey(key);
                const filename = (0, path_1.join)(this._fileDir, hash);
                await fs.promises.unlink(filename);
                this._metadata.delete(key);
                await this.notifyListeners(cloud_1.BucketEventType.DELETE, key);
            },
        });
    }
    async tryDelete(key) {
        if (await this.exists(key)) {
            await this.delete(key);
            return true;
        }
        return false;
    }
    async list(prefix) {
        return this.context.withTrace({
            message: `List (prefix=${prefix ?? "null"}).`,
            activity: async () => {
                return Array.from(this._metadata.keys()).filter((key) => {
                    if (prefix) {
                        return key.startsWith(prefix);
                    }
                    else {
                        return true;
                    }
                });
            },
        });
    }
    async publicUrl(key) {
        if (!this._public) {
            throw new Error("Cannot provide public url for a non-public bucket");
        }
        return this.context.withTrace({
            message: `Public URL (key=${key}).`,
            activity: async () => {
                const filePath = (0, path_1.join)(this._fileDir, key);
                if (!this._metadata.has(key)) {
                    throw new Error(`Cannot provide public url for an non-existent key (key=${key})`);
                }
                return url.pathToFileURL(filePath).href;
            },
        });
    }
    async signedUrl(key, options) {
        options;
        return this.context.withTrace({
            message: `Signed URL (key=${key})`,
            activity: async () => {
                throw new Error(`signedUrl is not implemented yet for sim (key=${key})`);
            },
        });
    }
    /**
     * Get the metadata of an object in the bucket.
     * @param key Key of the object.
     * @throws if the object does not exist.
     */
    async metadata(key) {
        return this.context.withTrace({
            message: `Metadata (key=${key}).`,
            activity: async () => {
                if (!this._metadata.has(key)) {
                    throw new Error(`Object does not exist (key=${key}).`);
                }
                return this._metadata.get(key);
            },
        });
    }
    async copy(srcKey, dstKey) {
        return this.context.withTrace({
            message: `Copy (srcKey=${srcKey} to dstKey=${dstKey}).`,
            activity: async () => {
                if (!this._metadata.has(srcKey)) {
                    throw new Error(`Source object does not exist (srcKey=${srcKey}).`);
                }
                const dstValue = await this.get(srcKey);
                const dstMetadata = await this.metadata(srcKey);
                await this.put(dstKey, dstValue, {
                    contentType: dstMetadata.contentType ?? "application/octet-stream",
                });
            },
        });
    }
    async rename(srcKey, dstKey) {
        if (srcKey === dstKey) {
            throw new Error(`Renaming an object to its current name is not a valid operation (srcKey=${srcKey}, dstKey=${dstKey}).`);
        }
        await this.copy(srcKey, dstKey);
        await this.delete(srcKey);
    }
    async addFile(key, value, contentType) {
        const actionType = this._metadata.has(key)
            ? cloud_1.BucketEventType.UPDATE
            : cloud_1.BucketEventType.CREATE;
        const hash = this.hashKey(key);
        const filename = (0, path_1.join)(this._fileDir, hash);
        const dirName = (0, path_1.dirname)(filename);
        await fs.promises.mkdir(dirName, { recursive: true });
        await fs.promises.writeFile(filename, value);
        const filestat = await fs.promises.stat(filename);
        const determinedContentType = (contentType ?? mime_types_1.default.lookup(key)) || "application/octet-stream";
        this._metadata.set(key, {
            size: filestat.size,
            lastModified: std_1.Datetime.fromDate(filestat.mtime),
            contentType: determinedContentType,
        });
        await this.notifyListeners(actionType, key);
    }
    hashKey(key) {
        return crypto.createHash("sha512").update(key).digest("hex").slice(-32);
    }
    addTrace(message, level) {
        this.context.addTrace({
            data: { message },
            level,
            type: std_1.TraceType.RESOURCE,
            sourcePath: this.context.resourcePath,
            sourceType: cloud_1.BUCKET_FQN,
            timestamp: new Date().toISOString(),
        });
    }
}
exports.Bucket = Bucket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmluZmxpZ2h0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC1zaW0vYnVja2V0LmluZmxpZ2h0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsK0NBQWlDO0FBQ2pDLHVDQUF5QjtBQUN6QiwrQkFBcUM7QUFDckMseUNBQTJCO0FBQzNCLDREQUE4QjtBQUU5QixpQ0FBZ0M7QUFDaEMsb0NBV2tCO0FBQ2xCLDhEQUFvRTtBQUNwRSxzREFJZ0M7QUFDaEMsZ0NBQTZEO0FBRWhELFFBQUEsaUJBQWlCLEdBQUcsZUFBZSxDQUFDO0FBRWpELE1BQWEsTUFBTTtJQVFqQixZQUFtQixLQUFtQjtRQUNwQyxJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxjQUFjLElBQUksRUFBRSxDQUFDO1FBQ2pELElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE1BQU0sSUFBSSxLQUFLLENBQUM7UUFDckMsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lBRUQsSUFBWSxPQUFPO1FBQ2pCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxpREFBaUQsQ0FBQyxDQUFDO1FBQ3JFLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBMEI7UUFDMUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFBLFdBQUksRUFBQyxPQUFPLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRWhELE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBQSxh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LEVBQUUsS0FBZTtRQUMvQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUNwQixJQUFJLEVBQUUsRUFBRSxPQUFPLEVBQUU7WUFDakIsS0FBSztZQUNMLElBQUksRUFBRSxlQUFTLENBQUMsUUFBUTtZQUN4QixVQUFVLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZO1lBQ3JDLFVBQVUsRUFBRSxrQkFBVTtZQUN0QixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7U0FDcEMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBbFhELHdCQWtYQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNyeXB0byBmcm9tIFwiY3J5cHRvXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IGRpcm5hbWUsIGpvaW4gfSBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgdXJsIGZyb20gXCJ1cmxcIjtcbmltcG9ydCBtaW1lIGZyb20gXCJtaW1lLXR5cGVzXCI7XG5pbXBvcnQgeyBCdWNrZXRBdHRyaWJ1dGVzLCBCdWNrZXRTY2hlbWEgfSBmcm9tIFwiLi9zY2hlbWEtcmVzb3VyY2VzXCI7XG5pbXBvcnQgeyBleGlzdHMgfSBmcm9tIFwiLi91dGlsXCI7XG5pbXBvcnQge1xuICBJVG9waWNDbGllbnQsXG4gIEJ1Y2tldFNpZ25lZFVybE9wdGlvbnMsXG4gIEJ1Y2tldEV2ZW50VHlwZSxcbiAgSUJ1Y2tldENsaWVudCxcbiAgT2JqZWN0TWV0YWRhdGEsXG4gIEJ1Y2tldFB1dE9wdGlvbnMsXG4gIEJ1Y2tldERlbGV0ZU9wdGlvbnMsXG4gIEJ1Y2tldEdldE9wdGlvbnMsXG4gIEJ1Y2tldFRyeUdldE9wdGlvbnMsXG4gIEJVQ0tFVF9GUU4sXG59IGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0IHsgZGVzZXJpYWxpemUsIHNlcmlhbGl6ZSB9IGZyb20gXCIuLi9zaW11bGF0b3Ivc2VyaWFsaXphdGlvblwiO1xuaW1wb3J0IHtcbiAgSVNpbXVsYXRvckNvbnRleHQsXG4gIElTaW11bGF0b3JSZXNvdXJjZUluc3RhbmNlLFxuICBVcGRhdGVQbGFuLFxufSBmcm9tIFwiLi4vc2ltdWxhdG9yL3NpbXVsYXRvclwiO1xuaW1wb3J0IHsgRGF0ZXRpbWUsIEpzb24sIExvZ0xldmVsLCBUcmFjZVR5cGUgfSBmcm9tIFwiLi4vc3RkXCI7XG5cbmV4cG9ydCBjb25zdCBNRVRBREFUQV9GSUxFTkFNRSA9IFwibWV0YWRhdGEuanNvblwiO1xuXG5leHBvcnQgY2xhc3MgQnVja2V0IGltcGxlbWVudHMgSUJ1Y2tldENsaWVudCwgSVNpbXVsYXRvclJlc291cmNlSW5zdGFuY2Uge1xuICBwcml2YXRlIF9maWxlRGlyITogc3RyaW5nO1xuICBwcml2YXRlIF9jb250ZXh0OiBJU2ltdWxhdG9yQ29udGV4dCB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSByZWFkb25seSBpbml0aWFsT2JqZWN0czogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgcHJpdmF0ZSByZWFkb25seSBfcHVibGljOiBib29sZWFuO1xuICBwcml2YXRlIHJlYWRvbmx5IHRvcGljSGFuZGxlcnM6IFBhcnRpYWw8UmVjb3JkPEJ1Y2tldEV2ZW50VHlwZSwgc3RyaW5nPj47XG4gIHByaXZhdGUgX21ldGFkYXRhOiBNYXA8c3RyaW5nLCBPYmplY3RNZXRhZGF0YT47XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKHByb3BzOiBCdWNrZXRTY2hlbWEpIHtcbiAgICB0aGlzLmluaXRpYWxPYmplY3RzID0gcHJvcHMuaW5pdGlhbE9iamVjdHMgPz8ge307XG4gICAgdGhpcy5fcHVibGljID0gcHJvcHMucHVibGljID8/IGZhbHNlO1xuICAgIHRoaXMudG9waWNIYW5kbGVycyA9IHByb3BzLnRvcGljcztcbiAgICB0aGlzLl9tZXRhZGF0YSA9IG5ldyBNYXAoKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGNvbnRleHQoKTogSVNpbXVsYXRvckNvbnRleHQge1xuICAgIGlmICghdGhpcy5fY29udGV4dCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGFjY2VzcyBjb250ZXh0IGR1cmluZyBjbGFzcyBjb25zdHJ1Y3Rpb25cIik7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9jb250ZXh0O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGluaXQoY29udGV4dDogSVNpbXVsYXRvckNvbnRleHQpOiBQcm9taXNlPEJ1Y2tldEF0dHJpYnV0ZXM+IHtcbiAgICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDtcbiAgICB0aGlzLl9maWxlRGlyID0gam9pbihjb250ZXh0LnN0YXRlZGlyLCBcImZpbGVzXCIpO1xuXG4gICAgY29uc3QgZmlsZURpckV4aXN0cyA9IGF3YWl0IGV4aXN0cyh0aGlzLl9maWxlRGlyKTtcbiAgICBpZiAoIWZpbGVEaXJFeGlzdHMpIHtcbiAgICAgIGF3YWl0IGZzLnByb21pc2VzLm1rZGlyKHRoaXMuX2ZpbGVEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IG1ldGFkYXRhRmlsZUV4aXN0cyA9IGF3YWl0IGV4aXN0cyhcbiAgICAgIGpvaW4odGhpcy5jb250ZXh0LnN0YXRlZGlyLCBNRVRBREFUQV9GSUxFTkFNRSlcbiAgICApO1xuICAgIGlmIChtZXRhZGF0YUZpbGVFeGlzdHMpIHtcbiAgICAgIGNvbnN0IG1ldGFkYXRhQ29udGVudHMgPSBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShcbiAgICAgICAgam9pbih0aGlzLmNvbnRleHQuc3RhdGVkaXIsIE1FVEFEQVRBX0ZJTEVOQU1FKSxcbiAgICAgICAgXCJ1dGYtOFwiXG4gICAgICApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBkZXNlcmlhbGl6ZShtZXRhZGF0YUNvbnRlbnRzKTtcbiAgICAgICAgdGhpcy5fbWV0YWRhdGEgPSBuZXcgTWFwKG1ldGFkYXRhKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhpcy5hZGRUcmFjZShcbiAgICAgICAgICBgRmFpbGVkIHRvIGRlc2VyaWFsaXplIG1ldGFkYXRhOiAkeyhlIGFzIEVycm9yKS5zdGFja31gLFxuICAgICAgICAgIExvZ0xldmVsLkVSUk9SXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModGhpcy5pbml0aWFsT2JqZWN0cykpIHtcbiAgICAgIGF3YWl0IHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgICBtZXNzYWdlOiBgQWRkaW5nIG9iamVjdCBmcm9tIHByZWZsaWdodCAoa2V5PSR7a2V5fSkuYCxcbiAgICAgICAgYWN0aXZpdHk6IGFzeW5jICgpID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hZGRGaWxlKGtleSwgdmFsdWUpO1xuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNsZWFudXAoKTogUHJvbWlzZTx2b2lkPiB7fVxuXG4gIHB1YmxpYyBhc3luYyBwbGFuKCkge1xuICAgIHJldHVybiBVcGRhdGVQbGFuLkFVVE87XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2F2ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBubyBuZWVkIHRvIHNhdmUgaW5kaXZpZHVhbCBmaWxlcywgc2luY2UgdGhleSBhcmUgYWxyZWFkeSBwZXJzaXN0ZWQgaW4gdGhlIHN0YXRlIGRpclxuICAgIC8vIGR1cmluZyB0aGUgYnVja2V0J3MgbGlmZWN5Y2xlXG4gICAgZnMud3JpdGVGaWxlU3luYyhcbiAgICAgIGpvaW4odGhpcy5jb250ZXh0LnN0YXRlZGlyLCBNRVRBREFUQV9GSUxFTkFNRSksXG4gICAgICBzZXJpYWxpemUoQXJyYXkuZnJvbSh0aGlzLl9tZXRhZGF0YS5lbnRyaWVzKCkpKSAvLyBtZXRhZGF0YSBjb250YWlucyBEYXRldGltZSB2YWx1ZXMsIHNvIHdlIG5lZWQgdG8gc2VyaWFsaXplIGl0XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbm90aWZ5TGlzdGVuZXJzKFxuICAgIGFjdGlvblR5cGU6IEJ1Y2tldEV2ZW50VHlwZSxcbiAgICBrZXk6IHN0cmluZ1xuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMudG9waWNIYW5kbGVyc1thY3Rpb25UeXBlXSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHRvcGljQ2xpZW50ID0gdGhpcy5jb250ZXh0LmdldENsaWVudChcbiAgICAgIHRoaXMudG9waWNIYW5kbGVyc1thY3Rpb25UeXBlXSFcbiAgICApIGFzIElUb3BpY0NsaWVudDtcblxuICAgIHJldHVybiB0b3BpY0NsaWVudC5wdWJsaXNoKGtleSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZXhpc3RzKGtleTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgbWVzc2FnZTogYEV4aXN0cyAoa2V5PSR7a2V5fSkuYCxcbiAgICAgIGFjdGl2aXR5OiBhc3luYyAoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9tZXRhZGF0YS5oYXMoa2V5KTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcHV0KFxuICAgIGtleTogc3RyaW5nLFxuICAgIHZhbHVlOiBzdHJpbmcsXG4gICAgb3B0cz86IEJ1Y2tldFB1dE9wdGlvbnNcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgbWVzc2FnZTogYFB1dCAoa2V5PSR7a2V5fSkuYCxcbiAgICAgIGFjdGl2aXR5OiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRkRmlsZShrZXksIHZhbHVlLCBvcHRzPy5jb250ZW50VHlwZSk7XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHB1dEpzb24oa2V5OiBzdHJpbmcsIGJvZHk6IEpzb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0LndpdGhUcmFjZSh7XG4gICAgICBtZXNzYWdlOiBgUHV0IEpzb24gKGtleT0ke2tleX0pLmAsXG4gICAgICBhY3Rpdml0eTogYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmFkZEZpbGUoXG4gICAgICAgICAga2V5LFxuICAgICAgICAgIEpTT04uc3RyaW5naWZ5KGJvZHksIG51bGwsIDIpLFxuICAgICAgICAgIFwiYXBwbGljYXRpb24vanNvblwiXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldChrZXk6IHN0cmluZywgb3B0aW9ucz86IEJ1Y2tldEdldE9wdGlvbnMpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHQud2l0aFRyYWNlKHtcbiAgICAgIG1lc3NhZ2U6IGBHZXQgKGtleT0ke2tleX0pLmAsXG4gICAgICBhY3Rpdml0eTogYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBoYXNoID0gdGhpcy5oYXNoS2V5KGtleSk7XG4gICAgICAgIGNvbnN0IGZpbGVuYW1lID0gam9pbih0aGlzLl9maWxlRGlyLCBoYXNoKTtcbiAgICAgICAgbGV0IGJ1ZmZlcjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBmaWxlID0gYXdhaXQgZnMucHJvbWlzZXMub3BlbihmaWxlbmFtZSwgXCJyXCIpO1xuICAgICAgICAgIGNvbnN0IHN0YXQgPSBhd2FpdCBmaWxlLnN0YXQoKTtcblxuICAgICAgICAgIGxldCBzdGFydCA9IDA7XG4gICAgICAgICAgaWYgKG9wdGlvbnM/LnN0YXJ0Qnl0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBzdGFydCA9IG9wdGlvbnMuc3RhcnRCeXRlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGxldCBsZW5ndGggPSBzdGF0LnNpemU7XG4gICAgICAgICAgaWYgKG9wdGlvbnM/LmVuZEJ5dGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgbGVuZ3RoID0gb3B0aW9ucy5lbmRCeXRlICsgMTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBidWZmZXIgPSBCdWZmZXIuYWxsb2MobGVuZ3RoIC0gc3RhcnQpO1xuICAgICAgICAgIGF3YWl0IGZpbGUucmVhZChidWZmZXIsIDAsIGxlbmd0aCAtIHN0YXJ0LCBzdGFydCk7XG4gICAgICAgICAgYXdhaXQgZmlsZS5jbG9zZSgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgYnVmZmVyID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFidWZmZXIpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9iamVjdCBkb2VzIG5vdCBleGlzdCAoa2V5PSR7a2V5fSkuYCk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgIHJldHVybiBuZXcgVGV4dERlY29kZXIoXCJ1dGY4XCIsIHsgZmF0YWw6IHRydWUgfSkuZGVjb2RlKGJ1ZmZlcik7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgT2JqZWN0IGNvbnRlbnQgY291bGQgbm90IGJlIHJlYWQgYXMgdGV4dCAoa2V5PSR7a2V5fSk6ICR7XG4gICAgICAgICAgICAgIChlIGFzIEVycm9yKS5zdGFja1xuICAgICAgICAgICAgfSl9YFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdHJ5R2V0KFxuICAgIGtleTogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBCdWNrZXRUcnlHZXRPcHRpb25zXG4gICk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gICAgaWYgKGF3YWl0IHRoaXMuZXhpc3RzKGtleSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldChrZXksIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0SnNvbihrZXk6IHN0cmluZyk6IFByb21pc2U8SnNvbj4ge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHQud2l0aFRyYWNlKHtcbiAgICAgIG1lc3NhZ2U6IGBHZXQgSnNvbiAoa2V5PSR7a2V5fSkuYCxcbiAgICAgIGFjdGl2aXR5OiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGhhc2ggPSB0aGlzLmhhc2hLZXkoa2V5KTtcbiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBqb2luKHRoaXMuX2ZpbGVEaXIsIGhhc2gpO1xuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShmaWxlbmFtZSwgXCJ1dGY4XCIpKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdHJ5R2V0SnNvbihrZXk6IHN0cmluZyk6IFByb21pc2U8SnNvbiB8IHVuZGVmaW5lZD4ge1xuICAgIGlmIChhd2FpdCB0aGlzLmV4aXN0cyhrZXkpKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRKc29uKGtleSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZWxldGUoa2V5OiBzdHJpbmcsIG9wdHM/OiBCdWNrZXREZWxldGVPcHRpb25zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgbWVzc2FnZTogYERlbGV0ZSAoa2V5PSR7a2V5fSkuYCxcbiAgICAgIGFjdGl2aXR5OiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG11c3RFeGlzdCA9IG9wdHM/Lm11c3RFeGlzdCA/PyBmYWxzZTtcblxuICAgICAgICBpZiAoIXRoaXMuX21ldGFkYXRhLmhhcyhrZXkpICYmIG11c3RFeGlzdCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgT2JqZWN0IGRvZXMgbm90IGV4aXN0IChrZXk9JHtrZXl9KS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5fbWV0YWRhdGEuaGFzKGtleSkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBoYXNoID0gdGhpcy5oYXNoS2V5KGtleSk7XG4gICAgICAgIGNvbnN0IGZpbGVuYW1lID0gam9pbih0aGlzLl9maWxlRGlyLCBoYXNoKTtcbiAgICAgICAgYXdhaXQgZnMucHJvbWlzZXMudW5saW5rKGZpbGVuYW1lKTtcbiAgICAgICAgdGhpcy5fbWV0YWRhdGEuZGVsZXRlKGtleSk7XG4gICAgICAgIGF3YWl0IHRoaXMubm90aWZ5TGlzdGVuZXJzKEJ1Y2tldEV2ZW50VHlwZS5ERUxFVEUsIGtleSk7XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHRyeURlbGV0ZShrZXk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGlmIChhd2FpdCB0aGlzLmV4aXN0cyhrZXkpKSB7XG4gICAgICBhd2FpdCB0aGlzLmRlbGV0ZShrZXkpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxpc3QocHJlZml4Pzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHQud2l0aFRyYWNlKHtcbiAgICAgIG1lc3NhZ2U6IGBMaXN0IChwcmVmaXg9JHtwcmVmaXggPz8gXCJudWxsXCJ9KS5gLFxuICAgICAgYWN0aXZpdHk6IGFzeW5jICgpID0+IHtcbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5fbWV0YWRhdGEua2V5cygpKS5maWx0ZXIoKGtleSkgPT4ge1xuICAgICAgICAgIGlmIChwcmVmaXgpIHtcbiAgICAgICAgICAgIHJldHVybiBrZXkuc3RhcnRzV2l0aChwcmVmaXgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBwdWJsaWNVcmwoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICghdGhpcy5fcHVibGljKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgcHJvdmlkZSBwdWJsaWMgdXJsIGZvciBhIG5vbi1wdWJsaWMgYnVja2V0XCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jb250ZXh0LndpdGhUcmFjZSh7XG4gICAgICBtZXNzYWdlOiBgUHVibGljIFVSTCAoa2V5PSR7a2V5fSkuYCxcbiAgICAgIGFjdGl2aXR5OiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0gam9pbih0aGlzLl9maWxlRGlyLCBrZXkpO1xuXG4gICAgICAgIGlmICghdGhpcy5fbWV0YWRhdGEuaGFzKGtleSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgQ2Fubm90IHByb3ZpZGUgcHVibGljIHVybCBmb3IgYW4gbm9uLWV4aXN0ZW50IGtleSAoa2V5PSR7a2V5fSlgXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB1cmwucGF0aFRvRmlsZVVSTChmaWxlUGF0aCkuaHJlZjtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2lnbmVkVXJsKGtleTogc3RyaW5nLCBvcHRpb25zPzogQnVja2V0U2lnbmVkVXJsT3B0aW9ucykge1xuICAgIG9wdGlvbnM7XG4gICAgcmV0dXJuIHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgbWVzc2FnZTogYFNpZ25lZCBVUkwgKGtleT0ke2tleX0pYCxcbiAgICAgIGFjdGl2aXR5OiBhc3luYyAoKSA9PiB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgc2lnbmVkVXJsIGlzIG5vdCBpbXBsZW1lbnRlZCB5ZXQgZm9yIHNpbSAoa2V5PSR7a2V5fSlgXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgbWV0YWRhdGEgb2YgYW4gb2JqZWN0IGluIHRoZSBidWNrZXQuXG4gICAqIEBwYXJhbSBrZXkgS2V5IG9mIHRoZSBvYmplY3QuXG4gICAqIEB0aHJvd3MgaWYgdGhlIG9iamVjdCBkb2VzIG5vdCBleGlzdC5cbiAgICovXG4gIHB1YmxpYyBhc3luYyBtZXRhZGF0YShrZXk6IHN0cmluZyk6IFByb21pc2U8T2JqZWN0TWV0YWRhdGE+IHtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0LndpdGhUcmFjZSh7XG4gICAgICBtZXNzYWdlOiBgTWV0YWRhdGEgKGtleT0ke2tleX0pLmAsXG4gICAgICBhY3Rpdml0eTogYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuX21ldGFkYXRhLmhhcyhrZXkpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPYmplY3QgZG9lcyBub3QgZXhpc3QgKGtleT0ke2tleX0pLmApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9tZXRhZGF0YS5nZXQoa2V5KSE7XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNvcHkoc3JjS2V5OiBzdHJpbmcsIGRzdEtleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuY29udGV4dC53aXRoVHJhY2Uoe1xuICAgICAgbWVzc2FnZTogYENvcHkgKHNyY0tleT0ke3NyY0tleX0gdG8gZHN0S2V5PSR7ZHN0S2V5fSkuYCxcbiAgICAgIGFjdGl2aXR5OiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5fbWV0YWRhdGEuaGFzKHNyY0tleSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFNvdXJjZSBvYmplY3QgZG9lcyBub3QgZXhpc3QgKHNyY0tleT0ke3NyY0tleX0pLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZHN0VmFsdWUgPSBhd2FpdCB0aGlzLmdldChzcmNLZXkpO1xuICAgICAgICBjb25zdCBkc3RNZXRhZGF0YSA9IGF3YWl0IHRoaXMubWV0YWRhdGEoc3JjS2V5KTtcblxuICAgICAgICBhd2FpdCB0aGlzLnB1dChkc3RLZXksIGRzdFZhbHVlLCB7XG4gICAgICAgICAgY29udGVudFR5cGU6IGRzdE1ldGFkYXRhLmNvbnRlbnRUeXBlID8/IFwiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtXCIsXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZW5hbWUoc3JjS2V5OiBzdHJpbmcsIGRzdEtleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHNyY0tleSA9PT0gZHN0S2V5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBSZW5hbWluZyBhbiBvYmplY3QgdG8gaXRzIGN1cnJlbnQgbmFtZSBpcyBub3QgYSB2YWxpZCBvcGVyYXRpb24gKHNyY0tleT0ke3NyY0tleX0sIGRzdEtleT0ke2RzdEtleX0pLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5jb3B5KHNyY0tleSwgZHN0S2V5KTtcbiAgICBhd2FpdCB0aGlzLmRlbGV0ZShzcmNLZXkpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBhZGRGaWxlKFxuICAgIGtleTogc3RyaW5nLFxuICAgIHZhbHVlOiBzdHJpbmcsXG4gICAgY29udGVudFR5cGU/OiBzdHJpbmdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgYWN0aW9uVHlwZTogQnVja2V0RXZlbnRUeXBlID0gdGhpcy5fbWV0YWRhdGEuaGFzKGtleSlcbiAgICAgID8gQnVja2V0RXZlbnRUeXBlLlVQREFURVxuICAgICAgOiBCdWNrZXRFdmVudFR5cGUuQ1JFQVRFO1xuXG4gICAgY29uc3QgaGFzaCA9IHRoaXMuaGFzaEtleShrZXkpO1xuICAgIGNvbnN0IGZpbGVuYW1lID0gam9pbih0aGlzLl9maWxlRGlyLCBoYXNoKTtcbiAgICBjb25zdCBkaXJOYW1lID0gZGlybmFtZShmaWxlbmFtZSk7XG5cbiAgICBhd2FpdCBmcy5wcm9taXNlcy5ta2RpcihkaXJOYW1lLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICBhd2FpdCBmcy5wcm9taXNlcy53cml0ZUZpbGUoZmlsZW5hbWUsIHZhbHVlKTtcblxuICAgIGNvbnN0IGZpbGVzdGF0ID0gYXdhaXQgZnMucHJvbWlzZXMuc3RhdChmaWxlbmFtZSk7XG4gICAgY29uc3QgZGV0ZXJtaW5lZENvbnRlbnRUeXBlID1cbiAgICAgIChjb250ZW50VHlwZSA/PyBtaW1lLmxvb2t1cChrZXkpKSB8fCBcImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbVwiO1xuXG4gICAgdGhpcy5fbWV0YWRhdGEuc2V0KGtleSwge1xuICAgICAgc2l6ZTogZmlsZXN0YXQuc2l6ZSxcbiAgICAgIGxhc3RNb2RpZmllZDogRGF0ZXRpbWUuZnJvbURhdGUoZmlsZXN0YXQubXRpbWUpLFxuICAgICAgY29udGVudFR5cGU6IGRldGVybWluZWRDb250ZW50VHlwZSxcbiAgICB9KTtcblxuICAgIGF3YWl0IHRoaXMubm90aWZ5TGlzdGVuZXJzKGFjdGlvblR5cGUsIGtleSk7XG4gIH1cblxuICBwcml2YXRlIGhhc2hLZXkoa2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBjcnlwdG8uY3JlYXRlSGFzaChcInNoYTUxMlwiKS51cGRhdGUoa2V5KS5kaWdlc3QoXCJoZXhcIikuc2xpY2UoLTMyKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVHJhY2UobWVzc2FnZTogc3RyaW5nLCBsZXZlbDogTG9nTGV2ZWwpOiB2b2lkIHtcbiAgICB0aGlzLmNvbnRleHQuYWRkVHJhY2Uoe1xuICAgICAgZGF0YTogeyBtZXNzYWdlIH0sXG4gICAgICBsZXZlbCxcbiAgICAgIHR5cGU6IFRyYWNlVHlwZS5SRVNPVVJDRSxcbiAgICAgIHNvdXJjZVBhdGg6IHRoaXMuY29udGV4dC5yZXNvdXJjZVBhdGgsXG4gICAgICBzb3VyY2VUeXBlOiBCVUNLRVRfRlFOLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==