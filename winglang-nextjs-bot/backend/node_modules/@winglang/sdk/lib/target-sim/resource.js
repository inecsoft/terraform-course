"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.isSimulatorResource = exports.isSimulatorInflightHost = exports.ResourceInflightMethods = exports.Resource = exports.SIM_RESOURCE_FQN = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const fs_1 = require("fs");
const path_1 = require("path");
const tokens_1 = require("./tokens");
const util_1 = require("./util");
const core_1 = require("../core");
const resource_names_1 = require("../shared/resource-names");
const std_1 = require("../std");
/**
 * Global identifier for `sim.Resource`.
 */
exports.SIM_RESOURCE_FQN = "@winglang/sdk.sim.Resource";
/**
 * A backend for a simulated resource.
 * @inflight `@winglang/sdk.sim.IResourceClient`
 */
class Resource extends std_1.Resource {
    constructor(scope, id, factory) {
        super(scope, id);
        this.permissions = [];
        this._env = {};
        std_1.Node.of(this).title = "Resource";
        std_1.Node.of(this).description = "A simulated resource";
        std_1.Node.of(this).color = "emerald";
        const assetName = resource_names_1.ResourceNames.generateName(this, {
            disallowedRegex: /[><:"/\\|?*\s]/g, // avoid characters that may cause path issues
            case: resource_names_1.CaseConventions.LOWERCASE,
            sep: "_",
        });
        const workdir = core_1.App.of(this).workdir;
        (0, fs_1.mkdirSync)(workdir, { recursive: true });
        const entrypoint = (0, path_1.join)(workdir, `${assetName}.cjs`);
        this.entrypoint = entrypoint;
        if (process.env.WING_TARGET) {
            this.addEnvironment("WING_TARGET", process.env.WING_TARGET);
        }
        this.factory = factory;
    }
    addPermission(resource, op) {
        this.permissions.push([resource, op]);
    }
    /** @internal */
    get _liftMap() {
        return {
            [ResourceInflightMethods.CALL]: [],
        };
    }
    /**
     * Obtain a token that can be used to reference an attribute of this
     * resource that is only resolved once the resource is started in the simulator.
     *
     * If the token is used in inflight code or in the configuration of a simulated
     * resource (e.g. as an environment variable), the relevant resource will
     * automatically take a dependency on the resource the token belongs to.
     *
     * @param name The name of the token.
     * @returns A string token.
     */
    createToken(name) {
        return (0, tokens_1.simulatorAttrToken)(this, name);
    }
    /** @internal */
    _preSynthesize() {
        super._preSynthesize();
        const onStopMethod = "onStop";
        const inflightClient = this.factory._toInflight();
        const code = `\
        "use strict";
        let $klass;
        exports.start = async function(statedir) {
          if ($klass) {
            throw Error('resource already started');
          }
          const attrs = {};
          const ctx = {};
          ctx.statedir = async () => statedir;
          ctx.resolveToken = async (name, value) => attrs[name] = value;
          ctx.log = async (message, level) => {
            if (!level) level = 'info';
            console.log(level + ':' + message);
          };
          const client = ${inflightClient};
          const noop = { ${onStopMethod}: () => {} };
          const klass = (await client.handle(ctx)) ?? noop;
          ctx.resolveToken = () => {
            throw Error('cannot resolve attributes outside of onStop method');
          };
          $klass = klass;
          return attrs;
        };

        exports.call = async function(propName, ...args) {
          if (!$klass) {
            throw Error('Resource is not running (it may have crashed or stopped)');
          }
          if (propName === '${onStopMethod}') {
            throw Error('Cannot call "${onStopMethod}"');
          }
          const prop = $klass[propName];
          if (!prop) {
            throw Error('Method or property "' + propName + '" not found');
          }
          if (typeof prop !== 'function') {
            if (args.length > 0) {
              throw Error('Property "' + propName + '" is not a function');
            }
            return prop;
          }
          return await prop.call($klass, ...args);
        };

        exports.stop = async function() {
          if (!$klass) {
            throw Error('Resource is not running (it may have crashed or stopped)');
          }
          await $klass.${onStopMethod}();
          $klass = undefined;
        };
        `;
        (0, fs_1.writeFileSync)(this.entrypoint, code);
        // indicates that we are calling the inflight constructor and the
        // inflight "handle" method on the handler resource.
        core_1.Lifting.lift(this.factory, this, ["handle"]);
    }
    /**
     * Add an environment variable to make available to the inflight code.
     */
    addEnvironment(name, value) {
        if (this._env[name] !== undefined && this._env[name] !== value) {
            throw new Error(`Environment variable "${name}" already set with a different value.`);
        }
        this._env[name] = value;
    }
    toSimulator() {
        const policy = [];
        for (const [resource, operation] of this.permissions) {
            policy.push({
                operation,
                resourceHandle: (0, tokens_1.simulatorHandleToken)(resource),
            });
        }
        const props = {
            environmentVariables: this._env,
            sourceCodeFile: (0, path_1.relative)(core_1.App.of(this).outdir, this.entrypoint),
            sourceCodeLanguage: "javascript",
        };
        return {
            type: exports.SIM_RESOURCE_FQN,
            props,
            policy,
        };
    }
    onLift(host, ops) {
        (0, util_1.bindSimulatorResource)(__filename, this, host, ops);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return (0, util_1.makeSimulatorJsClient)(__filename, this);
    }
}
exports.Resource = Resource;
_a = JSII_RTTI_SYMBOL_1;
Resource[_a] = { fqn: "@winglang/sdk.sim.Resource", version: "0.0.0" };
/**
 * List of inflight operations available for `Resource`.
 * @internal
 */
var ResourceInflightMethods;
(function (ResourceInflightMethods) {
    ResourceInflightMethods["CALL"] = "call";
})(ResourceInflightMethods || (exports.ResourceInflightMethods = ResourceInflightMethods = {}));
function isSimulatorInflightHost(obj) {
    return (typeof obj == "object" &&
        typeof obj.addPermission === "function");
}
exports.isSimulatorInflightHost = isSimulatorInflightHost;
function isSimulatorResource(obj) {
    return (typeof obj == "object" &&
        typeof obj.toSimulator === "function");
}
exports.isSimulatorResource = isSimulatorResource;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXNpbS9yZXNvdXJjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLDJCQUE4QztBQUM5QywrQkFBc0M7QUFHdEMscUNBQW9FO0FBQ3BFLGlDQUFzRTtBQUN0RSxrQ0FBZ0Q7QUFDaEQsNkRBQTBFO0FBRTFFLGdDQVFnQjtBQTZDaEI7O0dBRUc7QUFDVSxRQUFBLGdCQUFnQixHQUFHLDRCQUE0QixDQUFDO0FBRTdEOzs7R0FHRztBQUNILE1BQWEsUUFDWCxTQUFRLGNBQVc7SUFZbkIsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxPQUF5QjtRQUNqRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBTkYsZ0JBQVcsR0FBa0MsRUFBRSxDQUFDO1FBQ2hELFNBQUksR0FBMkIsRUFBRSxDQUFDO1FBT2pELFVBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxHQUFHLFVBQVUsQ0FBQztRQUNqQyxVQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLFdBQVcsR0FBRyxzQkFBc0IsQ0FBQztRQUNuRCxVQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUM7UUFFaEMsTUFBTSxTQUFTLEdBQUcsOEJBQWEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFO1lBQ2pELGVBQWUsRUFBRSxpQkFBaUIsRUFBRSw4Q0FBOEM7WUFDbEYsSUFBSSxFQUFFLGdDQUFlLENBQUMsU0FBUztZQUMvQixHQUFHLEVBQUUsR0FBRztTQUNULENBQUMsQ0FBQztRQUVILE1BQU0sT0FBTyxHQUFHLFVBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQ3JDLElBQUEsY0FBUyxFQUFDLE9BQU8sRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxD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QztJQUVNLE1BQU0sQ0FBQyxJQUFtQixFQUFFLEdBQWE7UUFDOUMsSUFBQSw0QkFBcUIsRUFBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNuRCxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsZ0JBQWdCO0lBQ1QsV0FBVztRQUNoQixPQUFPLElBQUEsNEJBQXFCLEVBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pELENBQUM7O0FBMUtILDRCQTJLQzs7O0FBYUQ7OztHQUdHO0FBQ0gsSUFBWSx1QkFFWDtBQUZELFdBQVksdUJBQXVCO0lBQ2pDLHdDQUFhLENBQUE7QUFDZixDQUFDLEVBRlcsdUJBQXVCLHVDQUF2Qix1QkFBdUIsUUFFbEM7QUFvQ0QsU0FBZ0IsdUJBQXVCLENBQ3JDLEdBQVE7SUFFUixPQUFPLENBQ0wsT0FBTyxHQUFHLElBQUksUUFBUTtRQUN0QixPQUFRLEdBQThCLENBQUMsYUFBYSxLQUFLLFVBQVUsQ0FDcEUsQ0FBQztBQUNKLENBQUM7QUFQRCwwREFPQztBQVlELFNBQWdCLG1CQUFtQixDQUFDLEdBQVE7SUFDMUMsT0FBTyxDQUNMLE9BQU8sR0FBRyxJQUFJLFFBQVE7UUFDdEIsT0FBUSxHQUEwQixDQUFDLFdBQVcsS0FBSyxVQUFVLENBQzlELENBQUM7QUFDSixDQUFDO0FBTEQsa0RBS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBta2RpclN5bmMsIHdyaXRlRmlsZVN5bmMgfSBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IGpvaW4sIHJlbGF0aXZlIH0gZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBTaW1SZXNvdXJjZVNjaGVtYSB9IGZyb20gXCIuL3NjaGVtYS1yZXNvdXJjZXNcIjtcbmltcG9ydCB7IHNpbXVsYXRvckF0dHJUb2tlbiwgc2ltdWxhdG9ySGFuZGxlVG9rZW4gfSBmcm9tIFwiLi90b2tlbnNcIjtcbmltcG9ydCB7IGJpbmRTaW11bGF0b3JSZXNvdXJjZSwgbWFrZVNpbXVsYXRvckpzQ2xpZW50IH0gZnJvbSBcIi4vdXRpbFwiO1xuaW1wb3J0IHsgQXBwLCBMaWZ0TWFwLCBMaWZ0aW5nIH0gZnJvbSBcIi4uL2NvcmVcIjtcbmltcG9ydCB7IENhc2VDb252ZW50aW9ucywgUmVzb3VyY2VOYW1lcyB9IGZyb20gXCIuLi9zaGFyZWQvcmVzb3VyY2UtbmFtZXNcIjtcbmltcG9ydCB7IFBvbGljeVN0YXRlbWVudCwgVG9TaW11bGF0b3JPdXRwdXQgfSBmcm9tIFwiLi4vc2ltdWxhdG9yXCI7XG5pbXBvcnQge1xuICBJSW5mbGlnaHQsXG4gIElJbmZsaWdodEhvc3QsXG4gIElSZXNvdXJjZSBhcyBJU3RkUmVzb3VyY2UsXG4gIFJlc291cmNlIGFzIFN0ZFJlc291cmNlLFxuICBOb2RlLFxuICBKc29uLFxuICBMb2dMZXZlbCxcbn0gZnJvbSBcIi4uL3N0ZFwiO1xuXG4vKipcbiAqIENvbnRyYWN0IHRoYXQgYSByZXNvdXJjZSBiYWNrZW5kIG11c3QgaW1wbGVtZW50LlxuICogQGluZmxpZ2h0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSVJlc291cmNlIHtcbiAgLyoqXG4gICAqIFJ1bnMgd2hlbiB0aGUgcmVzb3VyY2UgaXMgc3RvcHBlZC5cbiAgICovXG4gIG9uU3RvcCgpOiBQcm9taXNlPHZvaWQ+O1xufVxuXG4vLyBUT0RPOiBtYWtlIHN0YXRlZGlyIGEgcHJvcGVydHkgb25jZSBXaW5nIHN1cHBvcnRzIHByb3BlcnRpZXMgb24gaW50ZXJmYWNlc1xuXG4vKipcbiAqIENvbnRleHQgZm9yIGltcGxlbWVudGluZyBhIHNpbXVsYXRvciByZXNvdXJjZS5cbiAqIEBpbmZsaWdodFxuICovXG5leHBvcnQgaW50ZXJmYWNlIElSZXNvdXJjZUNvbnRleHQge1xuICAvKipcbiAgICogVGhlIGRpcmVjdG9yeSBmb3IgdGhlIHJlc291cmNlJ3Mgc3RhdGUuXG4gICAqL1xuICBzdGF0ZWRpcigpOiBQcm9taXNlPHN0cmluZz47XG5cbiAgLyoqXG4gICAqIFJlc29sdmVzIGEgdG9rZW4gdmFsdWUuIEFsbCB0b2tlbnMgbXVzdCBiZSByZXNvbHZlZCBkdXJpbmcgdGhlXG4gICAqIGNvbnN0cnVjdG9yIG9mIHRoZSByZXNvdXJjZS5cbiAgICpcbiAgICogQHBhcmFtIG5hbWUgVGhlIG5hbWUgb2YgdGhlIHRva2VuLlxuICAgKiBAcGFyYW0gdmFsdWUgVGhlIHZhbHVlIG9mIHRoZSB0b2tlbi5cbiAgICogQGluZmxpZ2h0XG4gICAqL1xuICByZXNvbHZlVG9rZW4obmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPjtcblxuICAvKipcbiAgICogTG9nIGEgbWVzc2FnZSBhdCB0aGUgY3VycmVudCBwb2ludCBpbiB0aW1lLiBEZWZhdWx0cyB0byBgaW5mb2AgbGV2ZWwuXG4gICAqXG4gICAqIEBwYXJhbSBtZXNzYWdlIFRoZSBtZXNzYWdlIHRvIGxvZy5cbiAgICogQHBhcmFtIGxldmVsIFRoZSBzZXZlcml0eSBvZiB0aGUgbWVzc2FnZS5cbiAgICogQGluZmxpZ2h0XG4gICAqL1xuICBsb2cobWVzc2FnZTogc3RyaW5nLCBsZXZlbDogTG9nTGV2ZWwgfCB1bmRlZmluZWQpOiBQcm9taXNlPHZvaWQ+O1xufVxuXG4vKipcbiAqIEdsb2JhbCBpZGVudGlmaWVyIGZvciBgc2ltLlJlc291cmNlYC5cbiAqL1xuZXhwb3J0IGNvbnN0IFNJTV9SRVNPVVJDRV9GUU4gPSBcIkB3aW5nbGFuZy9zZGsuc2ltLlJlc291cmNlXCI7XG5cbi8qKlxuICogQSBiYWNrZW5kIGZvciBhIHNpbXVsYXRlZCByZXNvdXJjZS5cbiAqIEBpbmZsaWdodCBgQHdpbmdsYW5nL3Nkay5zaW0uSVJlc291cmNlQ2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgUmVzb3VyY2VcbiAgZXh0ZW5kcyBTdGRSZXNvdXJjZVxuICBpbXBsZW1lbnRzXG4gICAgSVN0ZFJlc291cmNlLFxuICAgIElTaW11bGF0b3JSZXNvdXJjZSxcbiAgICBJSW5mbGlnaHRIb3N0LFxuICAgIElTaW11bGF0b3JJbmZsaWdodEhvc3RcbntcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uczogQXJyYXk8W0lTdGRSZXNvdXJjZSwgc3RyaW5nXT4gPSBbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBfZW52OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gIHByaXZhdGUgcmVhZG9ubHkgZmFjdG9yeTogSVJlc291cmNlRmFjdG9yeTtcbiAgcHJpdmF0ZSByZWFkb25seSBlbnRyeXBvaW50OiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgZmFjdG9yeTogSVJlc291cmNlRmFjdG9yeSkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBOb2RlLm9mKHRoaXMpLnRpdGxlID0gXCJSZXNvdXJjZVwiO1xuICAgIE5vZGUub2YodGhpcykuZGVzY3JpcHRpb24gPSBcIkEgc2ltdWxhdGVkIHJlc291cmNlXCI7XG4gICAgTm9kZS5vZih0aGlzKS5jb2xvciA9IFwiZW1lcmFsZFwiO1xuXG4gICAgY29uc3QgYXNzZXROYW1lID0gUmVzb3VyY2VOYW1lcy5nZW5lcmF0ZU5hbWUodGhpcywge1xuICAgICAgZGlzYWxsb3dlZFJlZ2V4OiAvWz48OlwiL1xcXFx8PypcXHNdL2csIC8vIGF2b2lkIGNoYXJhY3RlcnMgdGhhdCBtYXkgY2F1c2UgcGF0aCBpc3N1ZXNcbiAgICAgIGNhc2U6IENhc2VDb252ZW50aW9ucy5MT1dFUkNBU0UsXG4gICAgICBzZXA6IFwiX1wiLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgd29ya2RpciA9IEFwcC5vZih0aGlzKS53b3JrZGlyO1xuICAgIG1rZGlyU3luYyh3b3JrZGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICBjb25zdCBlbnRyeXBvaW50ID0gam9pbih3b3JrZGlyLCBgJHthc3NldE5hbWV9LmNqc2ApO1xuICAgIHRoaXMuZW50cnlwb2ludCA9IGVudHJ5cG9pbnQ7XG5cbiAgICBpZiAocHJvY2Vzcy5lbnYuV0lOR19UQVJHRVQpIHtcbiAgICAgIHRoaXMuYWRkRW52aXJvbm1lbnQoXCJXSU5HX1RBUkdFVFwiLCBwcm9jZXNzLmVudi5XSU5HX1RBUkdFVCk7XG4gICAgfVxuXG4gICAgdGhpcy5mYWN0b3J5ID0gZmFjdG9yeTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRQZXJtaXNzaW9uKHJlc291cmNlOiBJU3RkUmVzb3VyY2UsIG9wOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnBlcm1pc3Npb25zLnB1c2goW3Jlc291cmNlLCBvcF0pO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgZ2V0IF9saWZ0TWFwKCk6IExpZnRNYXAge1xuICAgIHJldHVybiB7XG4gICAgICBbUmVzb3VyY2VJbmZsaWdodE1ldGhvZHMuQ0FMTF06IFtdLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogT2J0YWluIGEgdG9rZW4gdGhhdCBjYW4gYmUgdXNlZCB0byByZWZlcmVuY2UgYW4gYXR0cmlidXRlIG9mIHRoaXNcbiAgICogcmVzb3VyY2UgdGhhdCBpcyBvbmx5IHJlc29sdmVkIG9uY2UgdGhlIHJlc291cmNlIGlzIHN0YXJ0ZWQgaW4gdGhlIHNpbXVsYXRvci5cbiAgICpcbiAgICogSWYgdGhlIHRva2VuIGlzIHVzZWQgaW4gaW5mbGlnaHQgY29kZSBvciBpbiB0aGUgY29uZmlndXJhdGlvbiBvZiBhIHNpbXVsYXRlZFxuICAgKiByZXNvdXJjZSAoZS5nLiBhcyBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSksIHRoZSByZWxldmFudCByZXNvdXJjZSB3aWxsXG4gICAqIGF1dG9tYXRpY2FsbHkgdGFrZSBhIGRlcGVuZGVuY3kgb24gdGhlIHJlc291cmNlIHRoZSB0b2tlbiBiZWxvbmdzIHRvLlxuICAgKlxuICAgKiBAcGFyYW0gbmFtZSBUaGUgbmFtZSBvZiB0aGUgdG9rZW4uXG4gICAqIEByZXR1cm5zIEEgc3RyaW5nIHRva2VuLlxuICAgKi9cbiAgcHVibGljIGNyZWF0ZVRva2VuKG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHNpbXVsYXRvckF0dHJUb2tlbih0aGlzLCBuYW1lKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIF9wcmVTeW50aGVzaXplKCk6IHZvaWQge1xuICAgIHN1cGVyLl9wcmVTeW50aGVzaXplKCk7XG4gICAgY29uc3Qgb25TdG9wTWV0aG9kID0gXCJvblN0b3BcIjtcbiAgICBjb25zdCBpbmZsaWdodENsaWVudCA9IHRoaXMuZmFjdG9yeS5fdG9JbmZsaWdodCgpO1xuICAgIGNvbnN0IGNvZGUgPSBgXFxcbiAgICAgICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgICAgIGxldCAka2xhc3M7XG4gICAgICAgIGV4cG9ydHMuc3RhcnQgPSBhc3luYyBmdW5jdGlvbihzdGF0ZWRpcikge1xuICAgICAgICAgIGlmICgka2xhc3MpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdyZXNvdXJjZSBhbHJlYWR5IHN0YXJ0ZWQnKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgYXR0cnMgPSB7fTtcbiAgICAgICAgICBjb25zdCBjdHggPSB7fTtcbiAgICAgICAgICBjdHguc3RhdGVkaXIgPSBhc3luYyAoKSA9PiBzdGF0ZWRpcjtcbiAgICAgICAgICBjdHgucmVzb2x2ZVRva2VuID0gYXN5bmMgKG5hbWUsIHZhbHVlKSA9PiBhdHRyc1tuYW1lXSA9IHZhbHVlO1xuICAgICAgICAgIGN0eC5sb2cgPSBhc3luYyAobWVzc2FnZSwgbGV2ZWwpID0+IHtcbiAgICAgICAgICAgIGlmICghbGV2ZWwpIGxldmVsID0gJ2luZm8nO1xuICAgICAgICAgICAgY29uc29sZS5sb2cobGV2ZWwgKyAnOicgKyBtZXNzYWdlKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGNvbnN0IGNsaWVudCA9ICR7aW5mbGlnaHRDbGllbnR9O1xuICAgICAgICAgIGNvbnN0IG5vb3AgPSB7ICR7b25TdG9wTWV0aG9kfTogKCkgPT4ge30gfTtcbiAgICAgICAgICBjb25zdCBrbGFzcyA9IChhd2FpdCBjbGllbnQuaGFuZGxlKGN0eCkpID8/IG5vb3A7XG4gICAgICAgICAgY3R4LnJlc29sdmVUb2tlbiA9ICgpID0+IHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdjYW5ub3QgcmVzb2x2ZSBhdHRyaWJ1dGVzIG91dHNpZGUgb2Ygb25TdG9wIG1ldGhvZCcpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgJGtsYXNzID0ga2xhc3M7XG4gICAgICAgICAgcmV0dXJuIGF0dHJzO1xuICAgICAgICB9O1xuXG4gICAgICAgIGV4cG9ydHMuY2FsbCA9IGFzeW5jIGZ1bmN0aW9uKHByb3BOYW1lLCAuLi5hcmdzKSB7XG4gICAgICAgICAgaWYgKCEka2xhc3MpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdSZXNvdXJjZSBpcyBub3QgcnVubmluZyAoaXQgbWF5IGhhdmUgY3Jhc2hlZCBvciBzdG9wcGVkKScpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocHJvcE5hbWUgPT09ICcke29uU3RvcE1ldGhvZH0nKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcignQ2Fubm90IGNhbGwgXCIke29uU3RvcE1ldGhvZH1cIicpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBwcm9wID0gJGtsYXNzW3Byb3BOYW1lXTtcbiAgICAgICAgICBpZiAoIXByb3ApIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdNZXRob2Qgb3IgcHJvcGVydHkgXCInICsgcHJvcE5hbWUgKyAnXCIgbm90IGZvdW5kJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0eXBlb2YgcHJvcCAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICB0aHJvdyBFcnJvcignUHJvcGVydHkgXCInICsgcHJvcE5hbWUgKyAnXCIgaXMgbm90IGEgZnVuY3Rpb24nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcm9wO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gYXdhaXQgcHJvcC5jYWxsKCRrbGFzcywgLi4uYXJncyk7XG4gICAgICAgIH07XG5cbiAgICAgICAgZXhwb3J0cy5zdG9wID0gYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgaWYgKCEka2xhc3MpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdSZXNvdXJjZSBpcyBub3QgcnVubmluZyAoaXQgbWF5IGhhdmUgY3Jhc2hlZCBvciBzdG9wcGVkKScpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBhd2FpdCAka2xhc3MuJHtvblN0b3BNZXRob2R9KCk7XG4gICAgICAgICAgJGtsYXNzID0gdW5kZWZpbmVkO1xuICAgICAgICB9O1xuICAgICAgICBgO1xuXG4gICAgd3JpdGVGaWxlU3luYyh0aGlzLmVudHJ5cG9pbnQsIGNvZGUpO1xuXG4gICAgLy8gaW5kaWNhdGVzIHRoYXQgd2UgYXJlIGNhbGxpbmcgdGhlIGluZmxpZ2h0IGNvbnN0cnVjdG9yIGFuZCB0aGVcbiAgICAvLyBpbmZsaWdodCBcImhhbmRsZVwiIG1ldGhvZCBvbiB0aGUgaGFuZGxlciByZXNvdXJjZS5cbiAgICBMaWZ0aW5nLmxpZnQodGhpcy5mYWN0b3J5LCB0aGlzLCBbXCJoYW5kbGVcIl0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSB0byBtYWtlIGF2YWlsYWJsZSB0byB0aGUgaW5mbGlnaHQgY29kZS5cbiAgICovXG4gIHB1YmxpYyBhZGRFbnZpcm9ubWVudChuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5fZW52W25hbWVdICE9PSB1bmRlZmluZWQgJiYgdGhpcy5fZW52W25hbWVdICE9PSB2YWx1ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRW52aXJvbm1lbnQgdmFyaWFibGUgXCIke25hbWV9XCIgYWxyZWFkeSBzZXQgd2l0aCBhIGRpZmZlcmVudCB2YWx1ZS5gXG4gICAgICApO1xuICAgIH1cbiAgICB0aGlzLl9lbnZbbmFtZV0gPSB2YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyB0b1NpbXVsYXRvcigpOiBUb1NpbXVsYXRvck91dHB1dCB7XG4gICAgY29uc3QgcG9saWN5OiBBcnJheTxQb2xpY3lTdGF0ZW1lbnQ+ID0gW107XG4gICAgZm9yIChjb25zdCBbcmVzb3VyY2UsIG9wZXJhdGlvbl0gb2YgdGhpcy5wZXJtaXNzaW9ucykge1xuICAgICAgcG9saWN5LnB1c2goe1xuICAgICAgICBvcGVyYXRpb24sXG4gICAgICAgIHJlc291cmNlSGFuZGxlOiBzaW11bGF0b3JIYW5kbGVUb2tlbihyZXNvdXJjZSksXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgcHJvcHM6IFNpbVJlc291cmNlU2NoZW1hID0ge1xuICAgICAgZW52aXJvbm1lbnRWYXJpYWJsZXM6IHRoaXMuX2VudixcbiAgICAgIHNvdXJjZUNvZGVGaWxlOiByZWxhdGl2ZShBcHAub2YodGhpcykub3V0ZGlyLCB0aGlzLmVudHJ5cG9pbnQpLFxuICAgICAgc291cmNlQ29kZUxhbmd1YWdlOiBcImphdmFzY3JpcHRcIixcbiAgICB9O1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBTSU1fUkVTT1VSQ0VfRlFOLFxuICAgICAgcHJvcHMsXG4gICAgICBwb2xpY3ksXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBvbkxpZnQoaG9zdDogSUluZmxpZ2h0SG9zdCwgb3BzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIGJpbmRTaW11bGF0b3JSZXNvdXJjZShfX2ZpbGVuYW1lLCB0aGlzLCBob3N0LCBvcHMpO1xuICAgIHN1cGVyLm9uTGlmdChob3N0LCBvcHMpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3RvSW5mbGlnaHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gbWFrZVNpbXVsYXRvckpzQ2xpZW50KF9fZmlsZW5hbWUsIHRoaXMpO1xuICB9XG59XG5cbi8qKlxuICogSW5mbGlnaHQgaW50ZXJmYWNlIGZvciBgc2ltLlJlc291cmNlYC5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJUmVzb3VyY2VDbGllbnQge1xuICAvKipcbiAgICogQ2FsbCBhIG1ldGhvZCBvbiB0aGUgcmVzb3VyY2UuXG4gICAqIEBpbmZsaWdodFxuICAgKi9cbiAgY2FsbChtZXRob2Q6IHN0cmluZywgYXJncz86IEFycmF5PEpzb24+KTogUHJvbWlzZTxKc29uPjtcbn1cblxuLyoqXG4gKiBMaXN0IG9mIGluZmxpZ2h0IG9wZXJhdGlvbnMgYXZhaWxhYmxlIGZvciBgUmVzb3VyY2VgLlxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBlbnVtIFJlc291cmNlSW5mbGlnaHRNZXRob2RzIHtcbiAgQ0FMTCA9IFwiY2FsbFwiLFxufVxuXG4vKipcbiAqIEEgcmVzb3VyY2Ugd2l0aCBhbiBpbmZsaWdodCBcImhhbmRsZVwiIG1ldGhvZCB0aGF0IGNhbiBiZSBwYXNzZWQgdG8gdGhlXG4gKiBgc2ltLlJlc291cmNlYCBjb25zdHJ1Y3Rvci5cbiAqIEBpbmZsaWdodCBgQHdpbmdsYW5nL3Nkay5zaW0uSVJlc291cmNlRmFjdG9yeUNsaWVudGBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJUmVzb3VyY2VGYWN0b3J5IGV4dGVuZHMgSUluZmxpZ2h0IHt9XG5cbi8qKlxuICogQSByZXNvdXJjZSB3aXRoIGFuIGluZmxpZ2h0IFwiaGFuZGxlXCIgbWV0aG9kIHRoYXQgY2FuIGJlIHBhc3NlZCB0byB0aGVcbiAqIGBzaW0uUmVzb3VyY2VgIGNvbnN0cnVjdG9yLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIElSZXNvdXJjZUZhY3RvcnlDbGllbnQge1xuICAvKipcbiAgICogRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB0byBpbml0aWFsaXplIHRoZSBzaW11bGF0b3IgcmVzb3VyY2UuXG4gICAqXG4gICAqIFRvIGltcGxlbWVudCBhIHNodXRkb3duIHNlcXVlbmNlLCByZXR1cm4gYW4gb2JqZWN0IHRoYXQgaW1wbGVtZW50cyB0aGUgYElSZXNvdXJjZWAgaW5mbGlnaHQgaW50ZXJmYWNlIHdpdGggYW4gYG9uU3RvcCgpYCBtZXRob2QuXG4gICAqXG4gICAqIEBpbmZsaWdodFxuICAgKi9cbiAgaGFuZGxlKGNvbnRleHQ6IElSZXNvdXJjZUNvbnRleHQpOiBQcm9taXNlPElSZXNvdXJjZSB8IHVuZGVmaW5lZD47XG59XG5cbi8qKlxuICogSW50ZXJmYWNlcyBzaGFyZWQgYnkgYWxsIHByZWZsaWdodCBjbGFzc2VzIHRoYXQgaG9zdCBpbmZsaWdodCBjb2RlLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIElTaW11bGF0b3JJbmZsaWdodEhvc3QgZXh0ZW5kcyBJSW5mbGlnaHRIb3N0IHtcbiAgLyoqXG4gICAqIEFkZCBhIHNpbXVsYXRlZCBwZXJtaXNzaW9uIHRvIHRoaXMgaW5mbGlnaHQgaG9zdC5cbiAgICogQHBhcmFtIHJlc291cmNlIFRoZSByZXNvdXJjZSB0byBhZGRcbiAgICogQHBhcmFtIG9wIFRoZSBhY3Rpb24gdG8gYWRkXG4gICAqL1xuICBhZGRQZXJtaXNzaW9uKHJlc291cmNlOiBJU3RkUmVzb3VyY2UsIG9wOiBzdHJpbmcpOiB2b2lkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNTaW11bGF0b3JJbmZsaWdodEhvc3QoXG4gIG9iajogYW55XG4pOiBvYmogaXMgSVNpbXVsYXRvckluZmxpZ2h0SG9zdCB7XG4gIHJldHVybiAoXG4gICAgdHlwZW9mIG9iaiA9PSBcIm9iamVjdFwiICYmXG4gICAgdHlwZW9mIChvYmogYXMgSVNpbXVsYXRvckluZmxpZ2h0SG9zdCkuYWRkUGVybWlzc2lvbiA9PT0gXCJmdW5jdGlvblwiXG4gICk7XG59XG5cbi8qKlxuICogSW50ZXJmYWNlcyBzaGFyZWQgYnkgYWxsIHByZWZsaWdodCBjbGFzc2VzIHRhcmdldGluZyB0aGUgc2ltdWxhdG9yLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIElTaW11bGF0b3JSZXNvdXJjZSBleHRlbmRzIElTdGRSZXNvdXJjZSB7XG4gIC8qKlxuICAgKiBDb252ZXJ0IHRoaXMgcmVzb3VyY2UgdG8gYSByZXNvdXJjZSBzY2hlbWEgZm9yIHRoZSBzaW11bGF0b3IuXG4gICAqL1xuICB0b1NpbXVsYXRvcigpOiBUb1NpbXVsYXRvck91dHB1dDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzU2ltdWxhdG9yUmVzb3VyY2Uob2JqOiBhbnkpOiBvYmogaXMgSVNpbXVsYXRvclJlc291cmNlIHtcbiAgcmV0dXJuIChcbiAgICB0eXBlb2Ygb2JqID09IFwib2JqZWN0XCIgJiZcbiAgICB0eXBlb2YgKG9iaiBhcyBJU2ltdWxhdG9yUmVzb3VyY2UpLnRvU2ltdWxhdG9yID09PSBcImZ1bmN0aW9uXCJcbiAgKTtcbn1cbiJdfQ==