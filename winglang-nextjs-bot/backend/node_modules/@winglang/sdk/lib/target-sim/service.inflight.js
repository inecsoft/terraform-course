"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Service = void 0;
const path_1 = require("path");
const cloud_1 = require("../cloud");
const bundling_1 = require("../shared/bundling");
const sandbox_1 = require("../shared/sandbox");
const simulator_1 = require("../simulator");
const std_1 = require("../std");
class Service {
    constructor(props) {
        this.running = false;
        this.sourceCodeFile = props.sourceCodeFile;
        this.autoStart = props.autoStart;
        this.environmentVariables = props.environmentVariables ?? {};
    }
    get context() {
        if (!this._context) {
            throw new Error("Cannot access context during class construction");
        }
        return this._context;
    }
    async ensureBundled() {
        await this.createBundlePromise;
        if (!this.bundle) {
            throw new Error("Bundle not created");
        }
    }
    async createBundle() {
        this.bundle = await sandbox_1.Sandbox.createBundle(this.resolvedSourceCodeFile, (msg, level) => {
            this.addTrace(msg, std_1.TraceType.RESOURCE, level);
        });
    }
    async init(context) {
        this._context = context;
        this.resolvedSourceCodeFile = (0, path_1.resolve)(context.simdir, this.sourceCodeFile);
        this.createBundlePromise = this.createBundle();
        if (this.autoStart) {
            await this.start();
        }
        return {};
    }
    async cleanup() {
        await this.createBundlePromise;
        await this.stop();
    }
    async save() { }
    async plan(invalidated) {
        if (invalidated) {
            return simulator_1.UpdatePlan.REPLACE;
        }
        // Make sure that we don't have an ongoing bundle operation
        await this.ensureBundled();
        // Check if any of the bundled files have changed since the last bundling
        const bundleInvalidated = await (0, bundling_1.isBundleInvalidated)(this.resolvedSourceCodeFile, this.bundle, (msg) => this.addTrace(msg, std_1.TraceType.SIMULATOR, std_1.LogLevel.VERBOSE));
        if (bundleInvalidated) {
            return simulator_1.UpdatePlan.REPLACE;
        }
        return simulator_1.UpdatePlan.SKIP;
    }
    async start() {
        // Do nothing if service is already running.
        if (this.running) {
            return;
        }
        await this.createBundlePromise;
        if (!this.bundle) {
            this.addTrace("Failed to start service: bundle is not created", std_1.TraceType.RESOURCE, std_1.LogLevel.ERROR);
            return;
        }
        this.sandbox = new sandbox_1.Sandbox(this.bundle.outfilePath, {
            env: {
                ...this.environmentVariables,
                WING_SIMULATOR_URL: this.context.serverUrl,
                WING_SIMULATOR_CALLER: this.context.resourceHandle,
            },
            log: (internal, level, message) => {
                this.addTrace(message, internal ? std_1.TraceType.SIMULATOR : std_1.TraceType.LOG, level);
            },
        });
        try {
            await this.sandbox.call("start");
            this.running = true;
        }
        catch (e) {
            this.addTrace(`Failed to start service: ${e.message}`, std_1.TraceType.RESOURCE, std_1.LogLevel.ERROR);
        }
    }
    async stop() {
        // Do nothing if service is already stopped.
        if (!this.running || !this.sandbox) {
            return;
        }
        try {
            this.running = false;
            await this.createBundlePromise;
            await this.sandbox.call("stop");
            await this.sandbox.cleanup();
        }
        catch (e) {
            this.addTrace(`Failed to stop service: ${e.message} ${e.stack}`, std_1.TraceType.RESOURCE, std_1.LogLevel.ERROR);
        }
    }
    async started() {
        return this.running;
    }
    addTrace(message, type, level) {
        this.context.addTrace({
            data: { message },
            type,
            sourcePath: this.context.resourcePath,
            sourceType: cloud_1.SERVICE_FQN,
            timestamp: new Date().toISOString(),
            level,
        });
    }
}
exports.Service = Service;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5pbmZsaWdodC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90YXJnZXQtc2ltL3NlcnZpY2UuaW5mbGlnaHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQStCO0FBRS9CLG9DQUF1RDtBQUN2RCxpREFBaUU7QUFDakUsK0NBQTRDO0FBQzVDLDRDQUlzQjtBQUN0QixnQ0FBNkM7QUFFN0MsTUFBYSxPQUFPO0lBV2xCLFlBQVksS0FBb0I7UUFKeEIsWUFBTyxHQUFZLEtBQUssQ0FBQztRQUsvQixJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUM7UUFDM0MsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxLQUFLLENBQUMsb0JBQW9CLElBQUksRUFBRSxDQUFDO0lBQy9ELENBQUM7SUFFRCxJQUFZLE9BQU87UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBRU8sS0FBSyxDQUFDLGFBQWE7UUFDekIsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUM7UUFDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDeEMsQ0FBQztJQUNILENBQUM7SUFFTyxLQUFLLENBQUMsWUFBWTtRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxZQUFZLENBQ3RDLElBQUksQ0FBQyxzQkFBc0IsRUFDM0IsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDYixJQUFJLENBQUMsUUFBUSxDQUFDLEdB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Q0FBQyxXQUFXLEVBQUU7WUFDbkMsS0FBSztTQUNOLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQTVKRCwwQkE0SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZXNvbHZlIH0gZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IFNlcnZpY2VBdHRyaWJ1dGVzLCBTZXJ2aWNlU2NoZW1hIH0gZnJvbSBcIi4vc2NoZW1hLXJlc291cmNlc1wiO1xuaW1wb3J0IHsgSVNlcnZpY2VDbGllbnQsIFNFUlZJQ0VfRlFOIH0gZnJvbSBcIi4uL2Nsb3VkXCI7XG5pbXBvcnQgeyBCdW5kbGUsIGlzQnVuZGxlSW52YWxpZGF0ZWQgfSBmcm9tIFwiLi4vc2hhcmVkL2J1bmRsaW5nXCI7XG5pbXBvcnQgeyBTYW5kYm94IH0gZnJvbSBcIi4uL3NoYXJlZC9zYW5kYm94XCI7XG5pbXBvcnQge1xuICBJU2ltdWxhdG9yQ29udGV4dCxcbiAgSVNpbXVsYXRvclJlc291cmNlSW5zdGFuY2UsXG4gIFVwZGF0ZVBsYW4sXG59IGZyb20gXCIuLi9zaW11bGF0b3JcIjtcbmltcG9ydCB7IExvZ0xldmVsLCBUcmFjZVR5cGUgfSBmcm9tIFwiLi4vc3RkXCI7XG5cbmV4cG9ydCBjbGFzcyBTZXJ2aWNlIGltcGxlbWVudHMgSVNlcnZpY2VDbGllbnQsIElTaW11bGF0b3JSZXNvdXJjZUluc3RhbmNlIHtcbiAgcHJpdmF0ZSBfY29udGV4dDogSVNpbXVsYXRvckNvbnRleHQgfCB1bmRlZmluZWQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgc291cmNlQ29kZUZpbGU6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBhdXRvU3RhcnQ6IGJvb2xlYW47XG4gIHByaXZhdGUgcmVzb2x2ZWRTb3VyY2VDb2RlRmlsZSE6IHN0cmluZztcbiAgcHJpdmF0ZSBzYW5kYm94OiBTYW5kYm94IHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIGJ1bmRsZTogQnVuZGxlIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIHJ1bm5pbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBlbnZpcm9ubWVudFZhcmlhYmxlczogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgcHJpdmF0ZSBjcmVhdGVCdW5kbGVQcm9taXNlITogUHJvbWlzZTx2b2lkPjtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogU2VydmljZVNjaGVtYSkge1xuICAgIHRoaXMuc291cmNlQ29kZUZpbGUgPSBwcm9wcy5zb3VyY2VDb2RlRmlsZTtcbiAgICB0aGlzLmF1dG9TdGFydCA9IHByb3BzLmF1dG9TdGFydDtcbiAgICB0aGlzLmVudmlyb25tZW50VmFyaWFibGVzID0gcHJvcHMuZW52aXJvbm1lbnRWYXJpYWJsZXMgPz8ge307XG4gIH1cblxuICBwcml2YXRlIGdldCBjb250ZXh0KCk6IElTaW11bGF0b3JDb250ZXh0IHtcbiAgICBpZiAoIXRoaXMuX2NvbnRleHQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBhY2Nlc3MgY29udGV4dCBkdXJpbmcgY2xhc3MgY29uc3RydWN0aW9uXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fY29udGV4dDtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZW5zdXJlQnVuZGxlZCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUJ1bmRsZVByb21pc2U7XG4gICAgaWYgKCF0aGlzLmJ1bmRsZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQnVuZGxlIG5vdCBjcmVhdGVkXCIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlQnVuZGxlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuYnVuZGxlID0gYXdhaXQgU2FuZGJveC5jcmVhdGVCdW5kbGUoXG4gICAgICB0aGlzLnJlc29sdmVkU291cmNlQ29kZUZpbGUsXG4gICAgICAobXNnLCBsZXZlbCkgPT4ge1xuICAgICAgICB0aGlzLmFkZFRyYWNlKG1zZywgVHJhY2VUeXBlLlJFU09VUkNFLCBsZXZlbCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBpbml0KGNvbnRleHQ6IElTaW11bGF0b3JDb250ZXh0KTogUHJvbWlzZTxTZXJ2aWNlQXR0cmlidXRlcz4ge1xuICAgIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0O1xuICAgIHRoaXMucmVzb2x2ZWRTb3VyY2VDb2RlRmlsZSA9IHJlc29sdmUoY29udGV4dC5zaW1kaXIsIHRoaXMuc291cmNlQ29kZUZpbGUpO1xuICAgIHRoaXMuY3JlYXRlQnVuZGxlUHJvbWlzZSA9IHRoaXMuY3JlYXRlQnVuZGxlKCk7XG4gICAgaWYgKHRoaXMuYXV0b1N0YXJ0KSB7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0KCk7XG4gICAgfVxuICAgIHJldHVybiB7fTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBjbGVhbnVwKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuY3JlYXRlQnVuZGxlUHJvbWlzZTtcbiAgICBhd2FpdCB0aGlzLnN0b3AoKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzYXZlKCk6IFByb21pc2U8dm9pZD4ge31cblxuICBwdWJsaWMgYXN5bmMgcGxhbihpbnZhbGlkYXRlZDogYm9vbGVhbik6IFByb21pc2U8VXBkYXRlUGxhbj4ge1xuICAgIGlmIChpbnZhbGlkYXRlZCkge1xuICAgICAgcmV0dXJuIFVwZGF0ZVBsYW4uUkVQTEFDRTtcbiAgICB9XG5cbiAgICAvLyBNYWtlIHN1cmUgdGhhdCB3ZSBkb24ndCBoYXZlIGFuIG9uZ29pbmcgYnVuZGxlIG9wZXJhdGlvblxuICAgIGF3YWl0IHRoaXMuZW5zdXJlQnVuZGxlZCgpO1xuXG4gICAgLy8gQ2hlY2sgaWYgYW55IG9mIHRoZSBidW5kbGVkIGZpbGVzIGhhdmUgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBidW5kbGluZ1xuICAgIGNvbnN0IGJ1bmRsZUludmFsaWRhdGVkID0gYXdhaXQgaXNCdW5kbGVJbnZhbGlkYXRlZChcbiAgICAgIHRoaXMucmVzb2x2ZWRTb3VyY2VDb2RlRmlsZSxcbiAgICAgIHRoaXMuYnVuZGxlISxcbiAgICAgIChtc2cpID0+IHRoaXMuYWRkVHJhY2UobXNnLCBUcmFjZVR5cGUuU0lNVUxBVE9SLCBMb2dMZXZlbC5WRVJCT1NFKVxuICAgICk7XG4gICAgaWYgKGJ1bmRsZUludmFsaWRhdGVkKSB7XG4gICAgICByZXR1cm4gVXBkYXRlUGxhbi5SRVBMQUNFO1xuICAgIH1cblxuICAgIHJldHVybiBVcGRhdGVQbGFuLlNLSVA7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RhcnQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gRG8gbm90aGluZyBpZiBzZXJ2aWNlIGlzIGFscmVhZHkgcnVubmluZy5cbiAgICBpZiAodGhpcy5ydW5uaW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5jcmVhdGVCdW5kbGVQcm9taXNlO1xuXG4gICAgaWYgKCF0aGlzLmJ1bmRsZSkge1xuICAgICAgdGhpcy5hZGRUcmFjZShcbiAgICAgICAgXCJGYWlsZWQgdG8gc3RhcnQgc2VydmljZTogYnVuZGxlIGlzIG5vdCBjcmVhdGVkXCIsXG4gICAgICAgIFRyYWNlVHlwZS5SRVNPVVJDRSxcbiAgICAgICAgTG9nTGV2ZWwuRVJST1JcbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5zYW5kYm94ID0gbmV3IFNhbmRib3godGhpcy5idW5kbGUub3V0ZmlsZVBhdGgsIHtcbiAgICAgIGVudjoge1xuICAgICAgICAuLi50aGlzLmVudmlyb25tZW50VmFyaWFibGVzLFxuICAgICAgICBXSU5HX1NJTVVMQVRPUl9VUkw6IHRoaXMuY29udGV4dC5zZXJ2ZXJVcmwsXG4gICAgICAgIFdJTkdfU0lNVUxBVE9SX0NBTExFUjogdGhpcy5jb250ZXh0LnJlc291cmNlSGFuZGxlLFxuICAgICAgfSxcbiAgICAgIGxvZzogKGludGVybmFsLCBsZXZlbCwgbWVzc2FnZSkgPT4ge1xuICAgICAgICB0aGlzLmFkZFRyYWNlKFxuICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgaW50ZXJuYWwgPyBUcmFjZVR5cGUuU0lNVUxBVE9SIDogVHJhY2VUeXBlLkxPRyxcbiAgICAgICAgICBsZXZlbFxuICAgICAgICApO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnNhbmRib3guY2FsbChcInN0YXJ0XCIpO1xuICAgICAgdGhpcy5ydW5uaW5nID0gdHJ1ZTtcbiAgICB9IGNhdGNoIChlOiBhbnkpIHtcbiAgICAgIHRoaXMuYWRkVHJhY2UoXG4gICAgICAgIGBGYWlsZWQgdG8gc3RhcnQgc2VydmljZTogJHtlLm1lc3NhZ2V9YCxcbiAgICAgICAgVHJhY2VUeXBlLlJFU09VUkNFLFxuICAgICAgICBMb2dMZXZlbC5FUlJPUlxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RvcCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBEbyBub3RoaW5nIGlmIHNlcnZpY2UgaXMgYWxyZWFkeSBzdG9wcGVkLlxuICAgIGlmICghdGhpcy5ydW5uaW5nIHx8ICF0aGlzLnNhbmRib3gpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7XG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZUJ1bmRsZVByb21pc2U7XG4gICAgICBhd2FpdCB0aGlzLnNhbmRib3guY2FsbChcInN0b3BcIik7XG4gICAgICBhd2FpdCB0aGlzLnNhbmRib3guY2xlYW51cCgpO1xuICAgIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgICAgdGhpcy5hZGRUcmFjZShcbiAgICAgICAgYEZhaWxlZCB0byBzdG9wIHNlcnZpY2U6ICR7ZS5tZXNzYWdlfSAke2Uuc3RhY2t9YCxcbiAgICAgICAgVHJhY2VUeXBlLlJFU09VUkNFLFxuICAgICAgICBMb2dMZXZlbC5FUlJPUlxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RhcnRlZCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5ydW5uaW5nO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRUcmFjZShtZXNzYWdlOiBzdHJpbmcsIHR5cGU6IFRyYWNlVHlwZSwgbGV2ZWw6IExvZ0xldmVsKSB7XG4gICAgdGhpcy5jb250ZXh0LmFkZFRyYWNlKHtcbiAgICAgIGRhdGE6IHsgbWVzc2FnZSB9LFxuICAgICAgdHlwZSxcbiAgICAgIHNvdXJjZVBhdGg6IHRoaXMuY29udGV4dC5yZXNvdXJjZVBhdGgsXG4gICAgICBzb3VyY2VUeXBlOiBTRVJWSUNFX0ZRTixcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgbGV2ZWwsXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==