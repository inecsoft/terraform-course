"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.dedent = exports.rewriteCommonError = exports.prettyPrintError = void 0;
const promises_1 = require("node:fs/promises");
const posix_1 = require("node:path/posix");
const misc_1 = require("../shared/misc");
/**
 * Pretty print an error, rewrites stack traces with sourcemaps, shows line that caused the error, and add general formatting.
 * This function has some special handling for winglang-based errors, but can be used whether winglang is used or not.
 * @param error An error object or a simple error string. If the string contains a stacktrace, it will be rewritten.
 * @param options Display options
 * @returns a pretty printed error, containing ANSI formatting if color is enabled
 */
async function prettyPrintError(error, options) {
    const StackTracey = await Promise.resolve().then(() => __importStar(require("stacktracey"))).then((m) => m.default);
    const chalk = options?.chalk;
    const fRed = (s) => (chalk ? chalk.red(s) : s);
    const fBold = (s) => (chalk ? chalk.bold(s) : s);
    const fDim = (s) => (chalk ? chalk.dim(s) : s);
    if (options?.resetCache) {
        StackTracey.resetCache();
    }
    let st;
    let originalMessage = "";
    if (typeof error === "string") {
        if (error === "") {
            return "";
        }
        st = new StackTracey(error);
        if (st.items.length > 0) {
            // we have a stack trace! extract the message (everything before a line that starts with "    at")
            const lines = error.split("\n");
            const idx = lines.findIndex((line) => line.startsWith("    at"));
            if (idx !== -1) {
                originalMessage = lines.slice(0, idx).join("\n");
            }
            else {
                originalMessage = error;
            }
        }
        else {
            originalMessage = error;
        }
        // stringy errors commonly start with "Error: ", we can just remove it
        originalMessage = originalMessage.replace(/^Error: /, "");
    }
    else {
        error = rewriteCommonError(error);
        st = new StackTracey(error.stack);
        originalMessage = error.message;
    }
    const message = fBold(fRed("Error: ")) + fRed(originalMessage);
    st = await st
        .clean()
        .filter((item) => !item.native)
        // strip node internals
        .filter((item) => !item.file.startsWith("node:"))
        // strip wingsdk
        .filter((item) => !(0, misc_1.normalPath)(item.file).includes("/libs/wingsdk/src/") &&
        !(0, misc_1.normalPath)(item.file).includes("/@winglang/sdk/"))
        // special: remove the handler wrapper (See `cloud.Function` entrypoint for where this comes from)
        .filter((item) => !(0, misc_1.normalPath)(item.file).match(/\.wing\/\w+(\.sandbox)?\.cjs$/))
        .withSourcesAsync();
    let traceWithSources = st.items;
    if (traceWithSources.length === 0) {
        return message;
    }
    let interestingRoot = options?.sourceEntrypoint;
    if (interestingRoot !== undefined) {
        interestingRoot = (0, misc_1.normalPath)(interestingRoot);
    }
    if (interestingRoot !== undefined &&
        (await (0, promises_1.stat)(interestingRoot)
            .then((s) => !s.isDirectory())
            .catch(() => true))) {
        interestingRoot = (0, posix_1.dirname)(interestingRoot);
    }
    if (interestingRoot !== undefined) {
        interestingRoot = (0, posix_1.join)(interestingRoot, "/");
    }
    if (interestingRoot !== undefined) {
        traceWithSources = traceWithSources.filter((item) => (item.sourceFile?.path ?? item.file).startsWith(interestingRoot));
        const targetDir = (0, posix_1.join)(interestingRoot, "target", "/");
        traceWithSources = traceWithSources.filter((item) => !(item.sourceFile?.path ?? item.file).startsWith(targetDir));
    }
    let output = [];
    // use only the first item with a source
    const firstGoodItem = traceWithSources.find((item) => item.sourceFile !== undefined &&
        item.sourceFile.lines.length > 0 &&
        !item.native &&
        !item.thirdParty);
    if (firstGoodItem) {
        const sourceFile = firstGoodItem.sourceFile;
        const originLines = sourceFile.lines;
        const originLine = firstGoodItem.line ?? 1;
        const originColumn = firstGoodItem.column ?? 1;
        let startLine = Math.max(originLine - 3, 1);
        let finishLine = originLine;
        const maxDigits = finishLine.toString().length;
        // print line and its surrounding lines
        output.push(" ".repeat(maxDigits + 1) +
            `--> ${(0, misc_1.normalPath)(firstGoodItem.fileRelative)}:${originLine}:${originColumn}`);
        let linesOfInterest = originLines;
        if (linesOfInterest.length > 1) {
            linesOfInterest = originLines.slice(startLine - 1, finishLine);
        }
        linesOfInterest.push(" ".repeat(originColumn) + "^");
        linesOfInterest = dedent(linesOfInterest);
        let x = 0;
        for (let i = startLine; i <= finishLine; i++) {
            const interestingLine = i === originLine;
            let lineNumber = interestingLine
                ? `${i} | `
                : " ".repeat(maxDigits) + " | ";
            if (interestingLine) {
                lineNumber = fBold(fRed(lineNumber));
            }
            let lineText = linesOfInterest[x++];
            output.push(lineNumber + lineText);
            if (interestingLine) {
                // last line is the caret
                output.push(" ".repeat(maxDigits) + " |" + fRed(linesOfInterest[x]));
            }
        }
    }
    const outputText = output.length > 0 ? "\n" + output.join("\n") : "";
    const extraStack = traceWithSources.length > 0
        ? "\n" + fDim(traceWithSources.map(printItem).join("\n"))
        : "";
    // add the rest of the stack trace from the same file
    return message + outputText + extraStack;
}
exports.prettyPrintError = prettyPrintError;
function printItem(item) {
    let calleeShort = `${item.calleeShort} `;
    // These are typically useless
    // TODO These can possibly be removed when sourcemaps support "names" mappings
    if (item.calleeShort === "$Root" ||
        item.calleeShort === "new $Root" ||
        item.calleeShort.includes("<anonymous>")) {
        calleeShort = "";
    }
    if (item.callee.match(/\$Closure\d+\.handle$/)) {
        // inflight closures use "handle" as a way to represent calling the inflight itself
        calleeShort = "";
    }
    if (item.fileName.endsWith(".w") && calleeShort.startsWith("async ")) {
        // In userland wing traces, async = inflight and is currently redundant to mention
        calleeShort = calleeShort.replace("async ", "");
    }
    const file = item.file;
    const line = item.line;
    const column = item.column;
    return `at ${calleeShort}${file}:${line}:${column}`;
}
function rewriteCommonError(error) {
    if (error.message.startsWith("There is already a Construct with name")) {
        const newMessage = [];
        newMessage.push(error.message);
        newMessage.push("hint: Every preflight object needs a unique identifier within its scope. You can assign one as shown:");
        newMessage.push('> new cloud.Bucket() as "MyBucket";');
        newMessage.push("For more information, see https://www.winglang.io/docs/concepts/application-tree");
        error.message = newMessage.join("\n\n");
    }
    else if (error.constructor.name === "NotImplementedError") {
        error.name = "NotImplementedError";
    }
    return error;
}
exports.rewriteCommonError = rewriteCommonError;
function dedent(lines) {
    // first, replace all tabs with 2 spaces
    lines = lines.map((line) => line.replace(/\t/g, "  "));
    // find the smallest indentation
    let minIndent = Infinity;
    for (const line of lines) {
        const match = line.match(/^ */);
        if (match && match[0].length !== line.length) {
            minIndent = Math.min(minIndent, match[0].length);
        }
    }
    // remove the indentation
    return lines.map((line) => line.substring(minIndent));
}
exports.dedent = dedent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5oYW5jZWQtZXJyb3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbC9lbmhhbmNlZC1lcnJvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLCtDQUF3QztBQUN4QywyQ0FBZ0Q7QUFHaEQseUNBQTRDO0FBcUI1Qzs7Ozs7O0dBTUc7QUFDSSxLQUFLLFVBQVUsZ0JBQWdCLENBQ3BDLEtBQXFCLEVBQ3JCLE9BQWlDO0lBRWpDLE1BQU0sV0FBVyxHQUFHLE1BQU0sa0RBQU8sYUFBYSxJQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXZFLE1BQU0sS0FBSyxHQUFHLE9BQU8sRUFBRSxLQUFLLENBQUM7SUFDN0IsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2RCxNQUFNLEtBQUssR0FBRyxDQUFDLENBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFdkQsSUFBSSxPQUFPLEVBQUUsVUFBVSxFQUFFLENBQUM7UUFDeEIsV0FBVyxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRCxJQUFJLEVBQTJCLENBQUM7SUFDaEMsSUFBSSxl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O1lBQzdDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbkQsQ0FBQztJQUNILENBQUM7SUFFRCx5QkFBeUI7SUFDekIsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7QUFDeEQsQ0FBQztBQWZELHdCQWVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3RhdCB9IGZyb20gXCJub2RlOmZzL3Byb21pc2VzXCI7XG5pbXBvcnQgeyBqb2luLCBkaXJuYW1lIH0gZnJvbSBcIm5vZGU6cGF0aC9wb3NpeFwiO1xuaW1wb3J0IHR5cGUgQ2hhbGsgZnJvbSBcImNoYWxrXCI7XG5pbXBvcnQgdHlwZSBTdGFja1RyYWNleSBmcm9tIFwic3RhY2t0cmFjZXlcIjtcbmltcG9ydCB7IG5vcm1hbFBhdGggfSBmcm9tIFwiLi4vc2hhcmVkL21pc2NcIjtcblxuZXhwb3J0IGludGVyZmFjZSBQcmV0dHlQcmludEVycm9yT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBUaGUgc291cmNlIGVudHJ5cG9pbnQuIElmIHByb3ZpZGVkLCB0aGUgc3RhY2sgdHJhY2Ugd2lsbCBvbmx5IHNob3cgc291cmNlIGZpbGVzIHRoYXQgYXJlIGluIHRoZSBzYW1lIGRpcmVjdG9yeSBvciBpdHMgc3ViZGlyZWN0b3JpZXMuXG4gICAqIEl0IHdpbGwgYWxzbyBleGNsdWRlIGZpbGVzIGluIGEgYHRhcmdldGAgc3ViZGlyZWN0b3J5LlxuICAgKi9cbiAgc291cmNlRW50cnlwb2ludD86IHN0cmluZztcblxuICAvKipcbiAgICogXCJjaGFsa1wiIGluc3RhbmNlIHRvIGZvcm1hdCBvdXRwdXQuXG4gICAqIElmIHByb3ZpZGVkLCBBTlNJIGNvbG9yIGFuZCBmb3JtYXQgd2lsbCBiZSB1c2VkLlxuICAgKi9cbiAgY2hhbGs/OiB0eXBlb2YgQ2hhbGs7XG5cbiAgLyoqXG4gICAqIElmIHRydWUsIHdpbGwgZm9yY2UgcmVsb2FkIGFsbCBzb3VyY2VzLlxuICAgKi9cbiAgcmVzZXRDYWNoZT86IGJvb2xlYW47XG59XG5cbi8qKlxuICogUHJldHR5IHByaW50IGFuIGVycm9yLCByZXdyaXRlcyBzdGFjayB0cmFjZXMgd2l0aCBzb3VyY2VtYXBzLCBzaG93cyBsaW5lIHRoYXQgY2F1c2VkIHRoZSBlcnJvciwgYW5kIGFkZCBnZW5lcmFsIGZvcm1hdHRpbmcuXG4gKiBUaGlzIGZ1bmN0aW9uIGhhcyBzb21lIHNwZWNpYWwgaGFuZGxpbmcgZm9yIHdpbmdsYW5nLWJhc2VkIGVycm9ycywgYnV0IGNhbiBiZSB1c2VkIHdoZXRoZXIgd2luZ2xhbmcgaXMgdXNlZCBvciBub3QuXG4gKiBAcGFyYW0gZXJyb3IgQW4gZXJyb3Igb2JqZWN0IG9yIGEgc2ltcGxlIGVycm9yIHN0cmluZy4gSWYgdGhlIHN0cmluZyBjb250YWlucyBhIHN0YWNrdHJhY2UsIGl0IHdpbGwgYmUgcmV3cml0dGVuLlxuICogQHBhcmFtIG9wdGlvbnMgRGlzcGxheSBvcHRpb25zXG4gKiBAcmV0dXJucyBhIHByZXR0eSBwcmludGVkIGVycm9yLCBjb250YWluaW5nIEFOU0kgZm9ybWF0dGluZyBpZiBjb2xvciBpcyBlbmFibGVkXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcmV0dHlQcmludEVycm9yKFxuICBlcnJvcjogRXJyb3IgfCBzdHJpbmcsXG4gIG9wdGlvbnM/OiBQcmV0dHlQcmludEVycm9yT3B0aW9uc1xuKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3QgU3RhY2tUcmFjZXkgPSBhd2FpdCBpbXBvcnQoXCJzdGFja3RyYWNleVwiKS50aGVuKChtKSA9PiBtLmRlZmF1bHQpO1xuXG4gIGNvbnN0IGNoYWxrID0gb3B0aW9ucz8uY2hhbGs7XG4gIGNvbnN0IGZSZWQgPSAoczogc3RyaW5nKSA9PiAoY2hhbGsgPyBjaGFsay5yZWQocykgOiBzKTtcbiAgY29uc3QgZkJvbGQgPSAoczogc3RyaW5nKSA9PiAoY2hhbGsgPyBjaGFsay5ib2xkKHMpIDogcyk7XG4gIGNvbnN0IGZEaW0gPSAoczogc3RyaW5nKSA9PiAoY2hhbGsgPyBjaGFsay5kaW0ocykgOiBzKTtcblxuICBpZiAob3B0aW9ucz8ucmVzZXRDYWNoZSkge1xuICAgIFN0YWNrVHJhY2V5LnJlc2V0Q2FjaGUoKTtcbiAgfVxuXG4gIGxldCBzdDogU3RhY2tUcmFjZXkgfCB1bmRlZmluZWQ7XG4gIGxldCBvcmlnaW5hbE1lc3NhZ2UgPSBcIlwiO1xuICBpZiAodHlwZW9mIGVycm9yID09PSBcInN0cmluZ1wiKSB7XG4gICAgaWYgKGVycm9yID09PSBcIlwiKSB7XG4gICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG4gICAgc3QgPSBuZXcgU3RhY2tUcmFjZXkoZXJyb3IpO1xuICAgIGlmIChzdC5pdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICAvLyB3ZSBoYXZlIGEgc3RhY2sgdHJhY2UhIGV4dHJhY3QgdGhlIG1lc3NhZ2UgKGV2ZXJ5dGhpbmcgYmVmb3JlIGEgbGluZSB0aGF0IHN0YXJ0cyB3aXRoIFwiICAgIGF0XCIpXG4gICAgICBjb25zdCBsaW5lcyA9IGVycm9yLnNwbGl0KFwiXFxuXCIpO1xuICAgICAgY29uc3QgaWR4ID0gbGluZXMuZmluZEluZGV4KChsaW5lKSA9PiBsaW5lLnN0YXJ0c1dpdGgoXCIgICAgYXRcIikpO1xuICAgICAgaWYgKGlkeCAhPT0gLTEpIHtcbiAgICAgICAgb3JpZ2luYWxNZXNzYWdlID0gbGluZXMuc2xpY2UoMCwgaWR4KS5qb2luKFwiXFxuXCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3JpZ2luYWxNZXNzYWdlID0gZXJyb3I7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIG9yaWdpbmFsTWVzc2FnZSA9IGVycm9yO1xuICAgIH1cblxuICAgIC8vIHN0cmluZ3kgZXJyb3JzIGNvbW1vbmx5IHN0YXJ0IHdpdGggXCJFcnJvcjogXCIsIHdlIGNhbiBqdXN0IHJlbW92ZSBpdFxuICAgIG9yaWdpbmFsTWVzc2FnZSA9IG9yaWdpbmFsTWVzc2FnZS5yZXBsYWNlKC9eRXJyb3I6IC8sIFwiXCIpO1xuICB9IGVsc2Uge1xuICAgIGVycm9yID0gcmV3cml0ZUNvbW1vbkVycm9yKGVycm9yKTtcbiAgICBzdCA9IG5ldyBTdGFja1RyYWNleShlcnJvci5zdGFjayk7XG4gICAgb3JpZ2luYWxNZXNzYWdlID0gZXJyb3IubWVzc2FnZTtcbiAgfVxuXG4gIGNvbnN0IG1lc3NhZ2UgPSBmQm9sZChmUmVkKFwiRXJyb3I6IFwiKSkgKyBmUmVkKG9yaWdpbmFsTWVzc2FnZSk7XG5cbiAgc3QgPSBhd2FpdCBzdFxuICAgIC5jbGVhbigpXG4gICAgLmZpbHRlcigoaXRlbSkgPT4gIWl0ZW0ubmF0aXZlKVxuICAgIC8vIHN0cmlwIG5vZGUgaW50ZXJuYWxzXG4gICAgLmZpbHRlcigoaXRlbSkgPT4gIWl0ZW0uZmlsZS5zdGFydHNXaXRoKFwibm9kZTpcIikpXG4gICAgLy8gc3RyaXAgd2luZ3Nka1xuICAgIC5maWx0ZXIoXG4gICAgICAoaXRlbSkgPT5cbiAgICAgICAgIW5vcm1hbFBhdGgoaXRlbS5maWxlKS5pbmNsdWRlcyhcIi9saWJzL3dpbmdzZGsvc3JjL1wiKSAmJlxuICAgICAgICAhbm9ybWFsUGF0aChpdGVtLmZpbGUpLmluY2x1ZGVzKFwiL0B3aW5nbGFuZy9zZGsvXCIpXG4gICAgKVxuICAgIC8vIHNwZWNpYWw6IHJlbW92ZSB0aGUgaGFuZGxlciB3cmFwcGVyIChTZWUgYGNsb3VkLkZ1bmN0aW9uYCBlbnRyeXBvaW50IGZvciB3aGVyZSB0aGlzIGNvbWVzIGZyb20pXG4gICAgLmZpbHRlcihcbiAgICAgIChpdGVtKSA9PiAhbm9ybWFsUGF0aChpdGVtLmZpbGUpLm1hdGNoKC9cXC53aW5nXFwvXFx3KyhcXC5zYW5kYm94KT9cXC5janMkLylcbiAgICApXG4gICAgLndpdGhTb3VyY2VzQXN5bmMoKTtcblxuICBsZXQgdHJhY2VXaXRoU291cmNlcyA9IHN0Lml0ZW1zO1xuXG4gIGlmICh0cmFjZVdpdGhTb3VyY2VzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBtZXNzYWdlO1xuICB9XG5cbiAgbGV0IGludGVyZXN0aW5nUm9vdCA9IG9wdGlvbnM/LnNvdXJjZUVudHJ5cG9pbnQ7XG4gIGlmIChpbnRlcmVzdGluZ1Jvb3QgIT09IHVuZGVmaW5lZCkge1xuICAgIGludGVyZXN0aW5nUm9vdCA9IG5vcm1hbFBhdGgoaW50ZXJlc3RpbmdSb290KTtcbiAgfVxuXG4gIGlmIChcbiAgICBpbnRlcmVzdGluZ1Jvb3QgIT09IHVuZGVmaW5lZCAmJlxuICAgIChhd2FpdCBzdGF0KGludGVyZXN0aW5nUm9vdClcbiAgICAgIC50aGVuKChzKSA9PiAhcy5pc0RpcmVjdG9yeSgpKVxuICAgICAgLmNhdGNoKCgpID0+IHRydWUpKVxuICApIHtcbiAgICBpbnRlcmVzdGluZ1Jvb3QgPSBkaXJuYW1lKGludGVyZXN0aW5nUm9vdCk7XG4gIH1cblxuICBpZiAoaW50ZXJlc3RpbmdSb290ICE9PSB1bmRlZmluZWQpIHtcbiAgICBpbnRlcmVzdGluZ1Jvb3QgPSBqb2luKGludGVyZXN0aW5nUm9vdCwgXCIvXCIpO1xuICB9XG5cbiAgaWYgKGludGVyZXN0aW5nUm9vdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgdHJhY2VXaXRoU291cmNlcyA9IHRyYWNlV2l0aFNvdXJjZXMuZmlsdGVyKChpdGVtKSA9PlxuICAgICAgKGl0ZW0uc291cmNlRmlsZT8ucGF0aCA/PyBpdGVtLmZpbGUpLnN0YXJ0c1dpdGgoaW50ZXJlc3RpbmdSb290ISlcbiAgICApO1xuICAgIGNvbnN0IHRhcmdldERpciA9IGpvaW4oaW50ZXJlc3RpbmdSb290LCBcInRhcmdldFwiLCBcIi9cIik7XG4gICAgdHJhY2VXaXRoU291cmNlcyA9IHRyYWNlV2l0aFNvdXJjZXMuZmlsdGVyKFxuICAgICAgKGl0ZW0pID0+ICEoaXRlbS5zb3VyY2VGaWxlPy5wYXRoID8/IGl0ZW0uZmlsZSkuc3RhcnRzV2l0aCh0YXJnZXREaXIpXG4gICAgKTtcbiAgfVxuXG4gIGxldCBvdXRwdXQgPSBbXTtcblxuICAvLyB1c2Ugb25seSB0aGUgZmlyc3QgaXRlbSB3aXRoIGEgc291cmNlXG4gIGNvbnN0IGZpcnN0R29vZEl0ZW0gPSB0cmFjZVdpdGhTb3VyY2VzLmZpbmQoXG4gICAgKGl0ZW0pID0+XG4gICAgICBpdGVtLnNvdXJjZUZpbGUgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgaXRlbS5zb3VyY2VGaWxlLmxpbmVzLmxlbmd0aCA+IDAgJiZcbiAgICAgICFpdGVtLm5hdGl2ZSAmJlxuICAgICAgIWl0ZW0udGhpcmRQYXJ0eVxuICApO1xuXG4gIGlmIChmaXJzdEdvb2RJdGVtKSB7XG4gICAgY29uc3Qgc291cmNlRmlsZSA9IGZpcnN0R29vZEl0ZW0uc291cmNlRmlsZSE7XG4gICAgY29uc3Qgb3JpZ2luTGluZXMgPSBzb3VyY2VGaWxlLmxpbmVzO1xuICAgIGNvbnN0IG9yaWdpbkxpbmUgPSBmaXJzdEdvb2RJdGVtLmxpbmUgPz8gMTtcbiAgICBjb25zdCBvcmlnaW5Db2x1bW4gPSBmaXJzdEdvb2RJdGVtLmNvbHVtbiA/PyAxO1xuXG4gICAgbGV0IHN0YXJ0TGluZSA9IE1hdGgubWF4KG9yaWdpbkxpbmUgLSAzLCAxKTtcbiAgICBsZXQgZmluaXNoTGluZSA9IG9yaWdpbkxpbmU7XG4gICAgY29uc3QgbWF4RGlnaXRzID0gZmluaXNoTGluZS50b1N0cmluZygpLmxlbmd0aDtcblxuICAgIC8vIHByaW50IGxpbmUgYW5kIGl0cyBzdXJyb3VuZGluZyBsaW5lc1xuICAgIG91dHB1dC5wdXNoKFxuICAgICAgXCIgXCIucmVwZWF0KG1heERpZ2l0cyArIDEpICtcbiAgICAgICAgYC0tPiAke25vcm1hbFBhdGgoXG4gICAgICAgICAgZmlyc3RHb29kSXRlbS5maWxlUmVsYXRpdmVcbiAgICAgICAgKX06JHtvcmlnaW5MaW5lfToke29yaWdpbkNvbHVtbn1gXG4gICAgKTtcblxuICAgIGxldCBsaW5lc09mSW50ZXJlc3QgPSBvcmlnaW5MaW5lcztcbiAgICBpZiAobGluZXNPZkludGVyZXN0Lmxlbmd0aCA+IDEpIHtcbiAgICAgIGxpbmVzT2ZJbnRlcmVzdCA9IG9yaWdpbkxpbmVzLnNsaWNlKHN0YXJ0TGluZSAtIDEsIGZpbmlzaExpbmUpO1xuICAgIH1cbiAgICBsaW5lc09mSW50ZXJlc3QucHVzaChcIiBcIi5yZXBlYXQob3JpZ2luQ29sdW1uKSArIFwiXlwiKTtcbiAgICBsaW5lc09mSW50ZXJlc3QgPSBkZWRlbnQobGluZXNPZkludGVyZXN0KTtcblxuICAgIGxldCB4ID0gMDtcbiAgICBmb3IgKGxldCBpID0gc3RhcnRMaW5lOyBpIDw9IGZpbmlzaExpbmU7IGkrKykge1xuICAgICAgY29uc3QgaW50ZXJlc3RpbmdMaW5lID0gaSA9PT0gb3JpZ2luTGluZTtcbiAgICAgIGxldCBsaW5lTnVtYmVyID0gaW50ZXJlc3RpbmdMaW5lXG4gICAgICAgID8gYCR7aX0gfCBgXG4gICAgICAgIDogXCIgXCIucmVwZWF0KG1heERpZ2l0cykgKyBcIiB8IFwiO1xuXG4gICAgICBpZiAoaW50ZXJlc3RpbmdMaW5lKSB7XG4gICAgICAgIGxpbmVOdW1iZXIgPSBmQm9sZChmUmVkKGxpbmVOdW1iZXIpKTtcbiAgICAgIH1cblxuICAgICAgbGV0IGxpbmVUZXh0ID0gbGluZXNPZkludGVyZXN0W3grK107XG4gICAgICBvdXRwdXQucHVzaChsaW5lTnVtYmVyICsgbGluZVRleHQpO1xuXG4gICAgICBpZiAoaW50ZXJlc3RpbmdMaW5lKSB7XG4gICAgICAgIC8vIGxhc3QgbGluZSBpcyB0aGUgY2FyZXRcbiAgICAgICAgb3V0cHV0LnB1c2goXCIgXCIucmVwZWF0KG1heERpZ2l0cykgKyBcIiB8XCIgKyBmUmVkKGxpbmVzT2ZJbnRlcmVzdFt4XSkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IG91dHB1dFRleHQgPSBvdXRwdXQubGVuZ3RoID4gMCA/IFwiXFxuXCIgKyBvdXRwdXQuam9pbihcIlxcblwiKSA6IFwiXCI7XG4gIGNvbnN0IGV4dHJhU3RhY2sgPVxuICAgIHRyYWNlV2l0aFNvdXJjZXMubGVuZ3RoID4gMFxuICAgICAgPyBcIlxcblwiICsgZkRpbSh0cmFjZVdpdGhTb3VyY2VzLm1hcChwcmludEl0ZW0pLmpvaW4oXCJcXG5cIikpXG4gICAgICA6IFwiXCI7XG5cbiAgLy8gYWRkIHRoZSByZXN0IG9mIHRoZSBzdGFjayB0cmFjZSBmcm9tIHRoZSBzYW1lIGZpbGVcbiAgcmV0dXJuIG1lc3NhZ2UgKyBvdXRwdXRUZXh0ICsgZXh0cmFTdGFjaztcbn1cblxuZnVuY3Rpb24gcHJpbnRJdGVtKGl0ZW06IFN0YWNrVHJhY2V5LkVudHJ5KSB7XG4gIGxldCBjYWxsZWVTaG9ydCA9IGAke2l0ZW0uY2FsbGVlU2hvcnR9IGA7XG5cbiAgLy8gVGhlc2UgYXJlIHR5cGljYWxseSB1c2VsZXNzXG4gIC8vIFRPRE8gVGhlc2UgY2FuIHBvc3NpYmx5IGJlIHJlbW92ZWQgd2hlbiBzb3VyY2VtYXBzIHN1cHBvcnQgXCJuYW1lc1wiIG1hcHBpbmdzXG4gIGlmIChcbiAgICBpdGVtLmNhbGxlZVNob3J0ID09PSBcIiRSb290XCIgfHxcbiAgICBpdGVtLmNhbGxlZVNob3J0ID09PSBcIm5ldyAkUm9vdFwiIHx8XG4gICAgaXRlbS5jYWxsZWVTaG9ydC5pbmNsdWRlcyhcIjxhbm9ueW1vdXM+XCIpXG4gICkge1xuICAgIGNhbGxlZVNob3J0ID0gXCJcIjtcbiAgfVxuXG4gIGlmIChpdGVtLmNhbGxlZS5tYXRjaCgvXFwkQ2xvc3VyZVxcZCtcXC5oYW5kbGUkLykpIHtcbiAgICAvLyBpbmZsaWdodCBjbG9zdXJlcyB1c2UgXCJoYW5kbGVcIiBhcyBhIHdheSB0byByZXByZXNlbnQgY2FsbGluZyB0aGUgaW5mbGlnaHQgaXRzZWxmXG4gICAgY2FsbGVlU2hvcnQgPSBcIlwiO1xuICB9XG5cbiAgaWYgKGl0ZW0uZmlsZU5hbWUuZW5kc1dpdGgoXCIud1wiKSAmJiBjYWxsZWVTaG9ydC5zdGFydHNXaXRoKFwiYXN5bmMgXCIpKSB7XG4gICAgLy8gSW4gdXNlcmxhbmQgd2luZyB0cmFjZXMsIGFzeW5jID0gaW5mbGlnaHQgYW5kIGlzIGN1cnJlbnRseSByZWR1bmRhbnQgdG8gbWVudGlvblxuICAgIGNhbGxlZVNob3J0ID0gY2FsbGVlU2hvcnQucmVwbGFjZShcImFzeW5jIFwiLCBcIlwiKTtcbiAgfVxuXG4gIGNvbnN0IGZpbGUgPSBpdGVtLmZpbGU7XG4gIGNvbnN0IGxpbmUgPSBpdGVtLmxpbmU7XG4gIGNvbnN0IGNvbHVtbiA9IGl0ZW0uY29sdW1uO1xuXG4gIHJldHVybiBgYXQgJHtjYWxsZWVTaG9ydH0ke2ZpbGV9OiR7bGluZX06JHtjb2x1bW59YDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJld3JpdGVDb21tb25FcnJvcihlcnJvcjogRXJyb3IpOiBFcnJvciB7XG4gIGlmIChlcnJvci5tZXNzYWdlLnN0YXJ0c1dpdGgoXCJUaGVyZSBpcyBhbHJlYWR5IGEgQ29uc3RydWN0IHdpdGggbmFtZVwiKSkge1xuICAgIGNvbnN0IG5ld01lc3NhZ2UgPSBbXTtcbiAgICBuZXdNZXNzYWdlLnB1c2goZXJyb3IubWVzc2FnZSk7XG4gICAgbmV3TWVzc2FnZS5wdXNoKFxuICAgICAgXCJoaW50OiBFdmVyeSBwcmVmbGlnaHQgb2JqZWN0IG5lZWRzIGEgdW5pcXVlIGlkZW50aWZpZXIgd2l0aGluIGl0cyBzY29wZS4gWW91IGNhbiBhc3NpZ24gb25lIGFzIHNob3duOlwiXG4gICAgKTtcbiAgICBuZXdNZXNzYWdlLnB1c2goJz4gbmV3IGNsb3VkLkJ1Y2tldCgpIGFzIFwiTXlCdWNrZXRcIjsnKTtcbiAgICBuZXdNZXNzYWdlLnB1c2goXG4gICAgICBcIkZvciBtb3JlIGluZm9ybWF0aW9uLCBzZWUgaHR0cHM6Ly93d3cud2luZ2xhbmcuaW8vZG9jcy9jb25jZXB0cy9hcHBsaWNhdGlvbi10cmVlXCJcbiAgICApO1xuICAgIGVycm9yLm1lc3NhZ2UgPSBuZXdNZXNzYWdlLmpvaW4oXCJcXG5cXG5cIik7XG4gIH0gZWxzZSBpZiAoZXJyb3IuY29uc3RydWN0b3IubmFtZSA9PT0gXCJOb3RJbXBsZW1lbnRlZEVycm9yXCIpIHtcbiAgICBlcnJvci5uYW1lID0gXCJOb3RJbXBsZW1lbnRlZEVycm9yXCI7XG4gIH1cblxuICByZXR1cm4gZXJyb3I7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWRlbnQobGluZXM6IHN0cmluZ1tdKSB7XG4gIC8vIGZpcnN0LCByZXBsYWNlIGFsbCB0YWJzIHdpdGggMiBzcGFjZXNcbiAgbGluZXMgPSBsaW5lcy5tYXAoKGxpbmUpID0+IGxpbmUucmVwbGFjZSgvXFx0L2csIFwiICBcIikpO1xuXG4gIC8vIGZpbmQgdGhlIHNtYWxsZXN0IGluZGVudGF0aW9uXG4gIGxldCBtaW5JbmRlbnQgPSBJbmZpbml0eTtcbiAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgY29uc3QgbWF0Y2ggPSBsaW5lLm1hdGNoKC9eICovKTtcbiAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMF0ubGVuZ3RoICE9PSBsaW5lLmxlbmd0aCkge1xuICAgICAgbWluSW5kZW50ID0gTWF0aC5taW4obWluSW5kZW50LCBtYXRjaFswXS5sZW5ndGgpO1xuICAgIH1cbiAgfVxuXG4gIC8vIHJlbW92ZSB0aGUgaW5kZW50YXRpb25cbiAgcmV0dXJuIGxpbmVzLm1hcCgobGluZSkgPT4gbGluZS5zdWJzdHJpbmcobWluSW5kZW50KSk7XG59XG4iXX0=