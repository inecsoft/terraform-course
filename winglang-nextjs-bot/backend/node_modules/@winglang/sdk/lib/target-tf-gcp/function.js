"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Function = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const cdktf_1 = require("cdktf");
const app_1 = require("./app");
const bucket_1 = require("./bucket");
const __1 = require("..");
const cloudfunctions_function_1 = require("../.gen/providers/google/cloudfunctions-function");
const cloudfunctions_function_iam_member_1 = require("../.gen/providers/google/cloudfunctions-function-iam-member");
const project_iam_custom_role_1 = require("../.gen/providers/google/project-iam-custom-role");
const project_iam_member_1 = require("../.gen/providers/google/project-iam-member");
const service_account_1 = require("../.gen/providers/google/service-account");
const storage_bucket_object_1 = require("../.gen/providers/google/storage-bucket-object");
const cloud = __importStar(require("../cloud"));
const errors_1 = require("../core/errors");
const bundling_1 = require("../shared/bundling");
const function_1 = require("../shared/function");
const resource_names_1 = require("../shared/resource-names");
const FUNCTION_NAME_OPTS = {
    maxLen: 32,
    disallowedRegex: /[^a-z0-9]+/g,
    case: resource_names_1.CaseConventions.LOWERCASE,
};
/**
 * GCP implementation of `cloud.Function`.
 *
 * @inflight `@winglang/sdk.cloud.IFunctionClient`
 */
class Function extends cloud.Function {
    /**
     * Attempts to cast an IInflightHost to an IGcpFunction if it is one.
     * @param host The IInflightHost instance to check and cast.
     * @returns An IGcpFunction if the host is a GCP function, undefined otherwise.
     */
    static from(host) {
        if (this.isGcpFunction(host)) {
            return host;
        }
        return undefined;
    }
    /**
     * Checks if the given object is an instance of IGcpFunction.
     * @param obj The object to check.
     * @returns true if the object is an IGcpFunction, false otherwise.
     */
    static isGcpFunction(obj) {
        return (typeof obj.name === "string" && typeof obj.httpsTriggerUrl === "string");
    }
    constructor(scope, id, inflight, props = {}) {
        super(scope, id, inflight, props);
        this.permissions = new Set([
            "cloudfunctions.functions.get",
        ]);
        // app is a property of the `cloud.Function` class
        const app = app_1.App.of(this);
        if (props.concurrency != null) {
            throw new errors_1.NotImplementedError("Function concurrency isn't implemented yet on the current target.");
        }
        // memory limits must be between 128 and 8192 MB
        if (props?.memory && (props.memory < 128 || props.memory > 8192)) {
            throw new Error("Memory must be between 128 and 8192 MB for GCP Cloud Functions");
        }
        // timeout must be between 1 and 540 seconds
        if (props?.timeout &&
            (props.timeout.seconds < 1 || props.timeout.seconds > 540)) {
            throw new Error("Timeout must be between 1 and 540 seconds for GCP Cloud Functions");
        }
        // create a bucket to store the function executable
        const FunctionBucket = new bucket_1.Bucket(this, "FunctionBucket");
        // put the executable in the bucket as an object
        const FunctionObjectBucket = new storage_bucket_object_1.StorageBucketObject(this, "FunctionObjectBucket", {
            name: "objects",
            bucket: FunctionBucket.bucket.name,
            source: cdktf_1.Lazy.stringValue({
                produce: () => {
                    if (!this.assetPath) {
                        throw new Error("assetPath was not set");
                    }
                    return this.assetPath;
                },
            }),
        });
        // Step 1: Create Custom Service Account
        this.functionServiceAccount = new service_account_1.ServiceAccount(this, `ServiceAccount${this.node.addr.substring(-8)}`, {
            accountId: resource_names_1.ResourceNames.generateName(this, FUNCTION_NAME_OPTS),
            displayName: `Custom Service Account for Cloud Function ${this.node.addr.substring(-8)}`,
        });
        // Step 2: Create Custom Role
        this.functionCustomRole = new project_iam_custom_role_1.ProjectIamCustomRole(this, `CustomRole${this.node.addr.substring(-8)}`, {
            roleId: `cloudfunctions.custom${this.node.addr.substring(-8)}`,
            title: `Custom Role for Cloud Function ${this.node.addr.substring(-8)}`,
            permissions: cdktf_1.Lazy.listValue({
                produce: () => Array.from(this.permissions),
            }),
        });
        // Step 3: Grant Custom Role to Custom Service Account on the Project
        new project_iam_member_1.ProjectIamMember(this, "ProjectIamMember", {
            project: app.projectId,
            role: `projects/${app.projectId}/roles/${this.functionCustomRole.roleId}`,
            member: `serviceAccount:${this.functionServiceAccount.email}`,
        });
        // Step 4: Create the Cloud Function with Custom Service Account
        this.function = new cloudfunctions_function_1.CloudfunctionsFunction(this, "DefaultFunction", {
            name: resource_names_1.ResourceNames.generateName(this, FUNCTION_NAME_OPTS),
            description: "This function was created by Wing",
            project: app.projectId,
            region: app.region,
            runtime: "nodejs20",
            availableMemoryMb: props.memory ?? function_1.DEFAULT_MEMORY_SIZE,
            sourceArchiveBucket: FunctionBucket.bucket.name,
            sourceArchiveObject: FunctionObjectBucket.name,
            entryPoint: "handler",
            triggerHttp: true,
            httpsTriggerSecurityLevel: "SECURE_ALWAYS",
            // It takes around 1 minutes to the function invocation permissions to be established -
            // therefore, the timeout is higher than in other targets
            timeout: props.timeout?.seconds ?? 120,
            serviceAccountEmail: this.functionServiceAccount.email,
            environmentVariables: cdktf_1.Lazy.anyValue({
                produce: () => this.env ?? {},
            }),
        });
    }
    /**
     * @internal
     * @param handler IFunctionHandler
     * @returns the function code lines as strings
     */
    _getCodeLines(handler) {
        const inflightClient = handler._toInflight();
        const lines = new Array();
        lines.push('"use strict";');
        inflightClient;
        lines.push("const functions = require('@google-cloud/functions-framework');\n");
        lines.push(`functions.http('handler', async (req, res) => {`);
        lines.push("  res.set('Access-Control-Allow-Origin', '*')");
        lines.push("  res.set('Access-Control-Allow-Methods', 'GET, POST')");
        lines.push("  try {");
        lines.push(`  const result = await (${inflightClient}).handle(req.body ?? "")`);
        lines.push(`  res.send(result);`);
        lines.push(`  } catch (error) {`);
        lines.push(`  res.status(500).send(error.message);`);
        lines.push("}});");
        return lines;
    }
    /** @internal */
    _preSynthesize() {
        super._preSynthesize();
        // bundled code is guaranteed to be in a fresh directory
        const bundle = (0, bundling_1.createBundle)(this.entrypoint, [
            "@google-cloud/functions-framework",
            "@google-cloud/datastore",
        ]);
        const packageJson = (0, path_1.join)(bundle.directory, "package.json");
        (0, fs_1.writeFileSync)(packageJson, JSON.stringify({
            main: (0, path_1.basename)(bundle.outfilePath),
            dependencies: {
                "@google-cloud/functions-framework": "^3.0.0",
                "@google-cloud/datastore": "8.4.0",
            },
        }, null, 2));
        const asset = new cdktf_1.TerraformAsset(this, "Asset", {
            path: bundle.directory,
            type: cdktf_1.AssetType.ARCHIVE,
        });
        this.assetPath = asset.path;
    }
    get functionName() {
        return this.function.name;
    }
    get serviceAccountEmail() {
        return this.function.serviceAccountEmail;
    }
    get project() {
        return this.function.project;
    }
    get region() {
        return this.function.region;
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud.FunctionInflightMethods.INVOKE]: [[this.handler, ["handle"]]],
        };
    }
    /** @internal */
    _toInflight() {
        return __1.core.InflightClient.for(__dirname.replace("target-tf-gcp", "shared-gcp"), __filename, "FunctionClient", [
            `process.env["${this.envName()}"]`,
            `process.env["${this.projectEnv()}"]`,
            `process.env["${this.regionEnv()}"]`,
        ]);
    }
    addPermissions(permissions) {
        permissions.forEach((permission) => {
            this.permissions.add(permission);
        });
    }
    onLift(host, ops) {
        if (!(host instanceof Function)) {
            throw new Error("tfgcp.Function can only be bound by tfgcp.Function for now");
        }
        if (ops.includes(cloud.FunctionInflightMethods.INVOKE)) {
            host.addPermissions(["cloudfunctions.functions.invoke"]);
        }
        const { region, projectId } = app_1.App.of(this);
        host.addEnvironment(this.envName(), this.function.name);
        host.addEnvironment(this.projectEnv(), projectId);
        host.addEnvironment(this.regionEnv(), region);
        super.onLift(host, ops);
    }
    /**
     * Grants the given service account permission to invoke this function.
     * @param serviceAccount The service account to grant invoke permissions to.
     * @internal
     */
    _addPermissionToInvoke(serviceAccount) {
        const hash = cdktf_1.Fn.sha256(serviceAccount.email).slice(-8);
        new cloudfunctions_function_iam_member_1.CloudfunctionsFunctionIamMember(this, `invoker-permission-${hash}`, {
            project: this.function.project,
            region: this.function.region,
            cloudFunction: this.function.name,
            role: "roles/cloudfunctions.invoker",
            member: `serviceAccount:${serviceAccount.email}`,
        });
    }
    /** @internal */
    _getHttpsTriggerUrl() {
        return this.function.httpsTriggerUrl;
    }
    envName() {
        return `FUNCTION_NAME_${this.node.addr.slice(-8)}`;
    }
    regionEnv() {
        return `REGION_${this.node.addr.slice(-8)}`;
    }
    projectEnv() {
        return `PROJECT_${this.node.addr.slice(-8)}`;
    }
}
exports.Function = Function;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXRmLWdjcC9mdW5jdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJCQUFtQztBQUNuQywrQkFBc0M7QUFDdEMsaUNBQTREO0FBRTVELCtCQUE0QjtBQUM1QixxQ0FBa0M7QUFDbEMsMEJBQTBCO0FBQzFCLDhGQUEwRjtBQUMxRixvSEFBOEc7QUFDOUcsOEZBQXdGO0FBQ3hGLG9GQUErRTtBQUMvRSw4RUFBMEU7QUFDMUUsMEZBQXFGO0FBQ3JGLGdEQUFrQztBQUVsQywyQ0FBcUQ7QUFDckQsaURBQWtEO0FBQ2xELGlEQUF5RDtBQUN6RCw2REFJa0M7QUFHbEMsTUFBTSxrQkFBa0IsR0FBZ0I7SUFDdEMsTUFBTSxFQUFFLEVBQUU7SUFDVixlQUFlLEVBQUUsYUFBYTtJQUM5QixJQUFJLEVBQUUsZ0NBQWUsQ0FBQyxTQUFTO0NBQ2hDLENBQUM7QUFnQkY7Ozs7R0FJRztBQUNILE1BQWEsUUFBUyxTQUFRLEtBQUssQ0FBQyxRQUFRO0lBQzFDOzs7O09BSUc7SUFDSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQW1CO1FBQ3BDLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzdCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssTUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUFRO1FBQ25DLE9BQU8sQ0FDTCxPQUFPLEdBQUcsQ0FBQyxJQUFJLEtBQUssUUFBUSxJQUFJLE9BQU8sR0FBRyxDQUFDLGVBQWUsS0FBSyxRQUFRLENBQ3hFLENBQUM7SUFDSixDQUFDO0lBV0QsWUFDRSxLQUFnQixFQUNoQixFQUFVLEVBQ1YsUUFBZ0MsRUFDaEMsUUFBNkIsRUFBRTtRQUUvQixLQUFLLENBQUMs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c291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgd3JpdGVGaWxlU3luYyB9IGZyb20gXCJmc1wiO1xuaW1wb3J0IHsgam9pbiwgYmFzZW5hbWUgfSBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgQXNzZXRUeXBlLCBMYXp5LCBUZXJyYWZvcm1Bc3NldCwgRm4gfSBmcm9tIFwiY2RrdGZcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9hcHBcIjtcbmltcG9ydCB7IEJ1Y2tldCB9IGZyb20gXCIuL2J1Y2tldFwiO1xuaW1wb3J0IHsgY29yZSB9IGZyb20gXCIuLlwiO1xuaW1wb3J0IHsgQ2xvdWRmdW5jdGlvbnNGdW5jdGlvbiB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9nb29nbGUvY2xvdWRmdW5jdGlvbnMtZnVuY3Rpb25cIjtcbmltcG9ydCB7IENsb3VkZnVuY3Rpb25zRnVuY3Rpb25JYW1NZW1iZXIgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvZ29vZ2xlL2Nsb3VkZnVuY3Rpb25zLWZ1bmN0aW9uLWlhbS1tZW1iZXJcIjtcbmltcG9ydCB7IFByb2plY3RJYW1DdXN0b21Sb2xlIH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2dvb2dsZS9wcm9qZWN0LWlhbS1jdXN0b20tcm9sZVwiO1xuaW1wb3J0IHsgUHJvamVjdElhbU1lbWJlciB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9nb29nbGUvcHJvamVjdC1pYW0tbWVtYmVyXCI7XG5pbXBvcnQgeyBTZXJ2aWNlQWNjb3VudCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9nb29nbGUvc2VydmljZS1hY2NvdW50XCI7XG5pbXBvcnQgeyBTdG9yYWdlQnVja2V0T2JqZWN0IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2dvb2dsZS9zdG9yYWdlLWJ1Y2tldC1vYmplY3RcIjtcbmltcG9ydCAqIGFzIGNsb3VkIGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0IHsgTGlmdE1hcCB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBOb3RJbXBsZW1lbnRlZEVycm9yIH0gZnJvbSBcIi4uL2NvcmUvZXJyb3JzXCI7XG5pbXBvcnQgeyBjcmVhdGVCdW5kbGUgfSBmcm9tIFwiLi4vc2hhcmVkL2J1bmRsaW5nXCI7XG5pbXBvcnQgeyBERUZBVUxUX01FTU9SWV9TSVpFIH0gZnJvbSBcIi4uL3NoYXJlZC9mdW5jdGlvblwiO1xuaW1wb3J0IHtcbiAgQ2FzZUNvbnZlbnRpb25zLFxuICBOYW1lT3B0aW9ucyxcbiAgUmVzb3VyY2VOYW1lcyxcbn0gZnJvbSBcIi4uL3NoYXJlZC9yZXNvdXJjZS1uYW1lc1wiO1xuaW1wb3J0IHsgSUluZmxpZ2h0SG9zdCB9IGZyb20gXCIuLi9zdGRcIjtcblxuY29uc3QgRlVOQ1RJT05fTkFNRV9PUFRTOiBOYW1lT3B0aW9ucyA9IHtcbiAgbWF4TGVuOiAzMixcbiAgZGlzYWxsb3dlZFJlZ2V4OiAvW15hLXowLTldKy9nLFxuICBjYXNlOiBDYXNlQ29udmVudGlvbnMuTE9XRVJDQVNFLFxufTtcblxuLyoqXG4gKiBJbnRlcmZhY2UgZm9yIEdDUCBDbG91ZCBGdW5jdGlvblxuICovXG5leHBvcnQgaW50ZXJmYWNlIElHY3BGdW5jdGlvbiB7XG4gIC8qKlxuICAgKiBHQ1AgRnVuY3Rpb24gTmFtZVxuICAgKi9cbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICAvKipcbiAgICogR0NQIEhUVFBTIFRyaWdnZXIgVVJMXG4gICAqL1xuICByZWFkb25seSBodHRwc1RyaWdnZXJVcmw6IHN0cmluZztcbn1cblxuLyoqXG4gKiBHQ1AgaW1wbGVtZW50YXRpb24gb2YgYGNsb3VkLkZ1bmN0aW9uYC5cbiAqXG4gKiBAaW5mbGlnaHQgYEB3aW5nbGFuZy9zZGsuY2xvdWQuSUZ1bmN0aW9uQ2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgRnVuY3Rpb24gZXh0ZW5kcyBjbG91ZC5GdW5jdGlvbiB7XG4gIC8qKlxuICAgKiBBdHRlbXB0cyB0byBjYXN0IGFuIElJbmZsaWdodEhvc3QgdG8gYW4gSUdjcEZ1bmN0aW9uIGlmIGl0IGlzIG9uZS5cbiAgICogQHBhcmFtIGhvc3QgVGhlIElJbmZsaWdodEhvc3QgaW5zdGFuY2UgdG8gY2hlY2sgYW5kIGNhc3QuXG4gICAqIEByZXR1cm5zIEFuIElHY3BGdW5jdGlvbiBpZiB0aGUgaG9zdCBpcyBhIEdDUCBmdW5jdGlvbiwgdW5kZWZpbmVkIG90aGVyd2lzZS5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZnJvbShob3N0OiBJSW5mbGlnaHRIb3N0KTogSUdjcEZ1bmN0aW9uIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAodGhpcy5pc0djcEZ1bmN0aW9uKGhvc3QpKSB7XG4gICAgICByZXR1cm4gaG9zdDtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhbiBpbnN0YW5jZSBvZiBJR2NwRnVuY3Rpb24uXG4gICAqIEBwYXJhbSBvYmogVGhlIG9iamVjdCB0byBjaGVjay5cbiAgICogQHJldHVybnMgdHJ1ZSBpZiB0aGUgb2JqZWN0IGlzIGFuIElHY3BGdW5jdGlvbiwgZmFsc2Ugb3RoZXJ3aXNlLlxuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgaXNHY3BGdW5jdGlvbihvYmo6IGFueSk6IG9iaiBpcyBJR2NwRnVuY3Rpb24ge1xuICAgIHJldHVybiAoXG4gICAgICB0eXBlb2Ygb2JqLm5hbWUgPT09IFwic3RyaW5nXCIgJiYgdHlwZW9mIG9iai5odHRwc1RyaWdnZXJVcmwgPT09IFwic3RyaW5nXCJcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbjogQ2xvdWRmdW5jdGlvbnNGdW5jdGlvbjtcbiAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvblNlcnZpY2VBY2NvdW50OiBTZXJ2aWNlQWNjb3VudDtcbiAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbkN1c3RvbVJvbGU6IFByb2plY3RJYW1DdXN0b21Sb2xlO1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoW1xuICAgIFwiY2xvdWRmdW5jdGlvbnMuZnVuY3Rpb25zLmdldFwiLFxuICBdKTtcblxuICBwcml2YXRlIGFzc2V0UGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkOyAvLyBwb3NpeCBwYXRoXG5cbiAgY29uc3RydWN0b3IoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBpZDogc3RyaW5nLFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JRnVuY3Rpb25IYW5kbGVyLFxuICAgIHByb3BzOiBjbG91ZC5GdW5jdGlvblByb3BzID0ge31cbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBpbmZsaWdodCwgcHJvcHMpO1xuXG4gICAgLy8gYXBwIGlzIGEgcHJvcGVydHkgb2YgdGhlIGBjbG91ZC5GdW5jdGlvbmAgY2xhc3NcbiAgICBjb25zdCBhcHAgPSBBcHAub2YodGhpcykgYXMgQXBwO1xuXG4gICAgaWYgKHByb3BzLmNvbmN1cnJlbmN5ICE9IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKFxuICAgICAgICBcIkZ1bmN0aW9uIGNvbmN1cnJlbmN5IGlzbid0IGltcGxlbWVudGVkIHlldCBvbiB0aGUgY3VycmVudCB0YXJnZXQuXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gbWVtb3J5IGxpbWl0cyBtdXN0IGJlIGJldHdlZW4gMTI4IGFuZCA4MTkyIE1CXG4gICAgaWYgKHByb3BzPy5tZW1vcnkgJiYgKHByb3BzLm1lbW9yeSA8IDEyOCB8fCBwcm9wcy5tZW1vcnkgPiA4MTkyKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIk1lbW9yeSBtdXN0IGJlIGJldHdlZW4gMTI4IGFuZCA4MTkyIE1CIGZvciBHQ1AgQ2xvdWQgRnVuY3Rpb25zXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gdGltZW91dCBtdXN0IGJlIGJldHdlZW4gMSBhbmQgNTQwIHNlY29uZHNcbiAgICBpZiAoXG4gICAgICBwcm9wcz8udGltZW91dCAmJlxuICAgICAgKHByb3BzLnRpbWVvdXQuc2Vjb25kcyA8IDEgfHwgcHJvcHMudGltZW91dC5zZWNvbmRzID4gNTQwKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIlRpbWVvdXQgbXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDU0MCBzZWNvbmRzIGZvciBHQ1AgQ2xvdWQgRnVuY3Rpb25zXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gY3JlYXRlIGEgYnVja2V0IHRvIHN0b3JlIHRoZSBmdW5jdGlvbiBleGVjdXRhYmxlXG4gICAgY29uc3QgRnVuY3Rpb25CdWNrZXQgPSBuZXcgQnVja2V0KHRoaXMsIFwiRnVuY3Rpb25CdWNrZXRcIik7XG5cbiAgICAvLyBwdXQgdGhlIGV4ZWN1dGFibGUgaW4gdGhlIGJ1Y2tldCBhcyBhbiBvYmplY3RcbiAgICBjb25zdCBGdW5jdGlvbk9iamVjdEJ1Y2tldCA9IG5ldyBTdG9yYWdlQnVja2V0T2JqZWN0KFxuICAgICAgdGhpcyxcbiAgICAgIFwiRnVuY3Rpb25PYmplY3RCdWNrZXRcIixcbiAgICAgIHtcbiAgICAgICAgbmFtZTogXCJvYmplY3RzXCIsXG4gICAgICAgIGJ1Y2tldDogRnVuY3Rpb25CdWNrZXQuYnVja2V0Lm5hbWUsXG4gICAgICAgIHNvdXJjZTogTGF6eS5zdHJpbmdWYWx1ZSh7XG4gICAgICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmFzc2V0UGF0aCkge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJhc3NldFBhdGggd2FzIG5vdCBzZXRcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hc3NldFBhdGg7XG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICB9XG4gICAgKTtcblxuICAgIC8vIFN0ZXAgMTogQ3JlYXRlIEN1c3RvbSBTZXJ2aWNlIEFjY291bnRcbiAgICB0aGlzLmZ1bmN0aW9uU2VydmljZUFjY291bnQgPSBuZXcgU2VydmljZUFjY291bnQoXG4gICAgICB0aGlzLFxuICAgICAgYFNlcnZpY2VBY2NvdW50JHt0aGlzLm5vZGUuYWRkci5zdWJzdHJpbmcoLTgpfWAsXG4gICAgICB7XG4gICAgICAgIGFjY291bnRJZDogUmVzb3VyY2VOYW1lcy5nZW5lcmF0ZU5hbWUodGhpcywgRlVOQ1RJT05fTkFNRV9PUFRTKSxcbiAgICAgICAgZGlzcGxheU5hbWU6IGBDdXN0b20gU2VydmljZSBBY2NvdW50IGZvciBDbG91ZCBGdW5jdGlvbiAke3RoaXMubm9kZS5hZGRyLnN1YnN0cmluZyhcbiAgICAgICAgICAtOFxuICAgICAgICApfWAsXG4gICAgICB9XG4gICAgKTtcbiAgICAvLyBTdGVwIDI6IENyZWF0ZSBDdXN0b20gUm9sZVxuICAgIHRoaXMuZnVuY3Rpb25DdXN0b21Sb2xlID0gbmV3IFByb2plY3RJYW1DdXN0b21Sb2xlKFxuICAgICAgdGhpcyxcbiAgICAgIGBDdXN0b21Sb2xlJHt0aGlzLm5vZGUuYWRkci5zdWJzdHJpbmcoLTgpfWAsXG4gICAgICB7XG4gICAgICAgIHJvbGVJZDogYGNsb3VkZnVuY3Rpb25zLmN1c3RvbSR7dGhpcy5ub2RlLmFkZHIuc3Vic3RyaW5nKC04KX1gLFxuICAgICAgICB0aXRsZTogYEN1c3RvbSBSb2xlIGZvciBDbG91ZCBGdW5jdGlvbiAke3RoaXMubm9kZS5hZGRyLnN1YnN0cmluZygtOCl9YCxcbiAgICAgICAgcGVybWlzc2lvbnM6IExhenkubGlzdFZhbHVlKHtcbiAgICAgICAgICBwcm9kdWNlOiAoKSA9PiBBcnJheS5mcm9tKHRoaXMucGVybWlzc2lvbnMpLFxuICAgICAgICB9KSxcbiAgICAgIH1cbiAgICApO1xuICAgIC8vIFN0ZXAgMzogR3JhbnQgQ3VzdG9tIFJvbGUgdG8gQ3VzdG9tIFNlcnZpY2UgQWNjb3VudCBvbiB0aGUgUHJvamVjdFxuICAgIG5ldyBQcm9qZWN0SWFtTWVtYmVyKHRoaXMsIFwiUHJvamVjdElhbU1lbWJlclwiLCB7XG4gICAgICBwcm9qZWN0OiBhcHAucHJvamVjdElkLFxuICAgICAgcm9sZTogYHByb2plY3RzLyR7YXBwLnByb2plY3RJZH0vcm9sZXMvJHt0aGlzLmZ1bmN0aW9uQ3VzdG9tUm9sZS5yb2xlSWR9YCxcbiAgICAgIG1lbWJlcjogYHNlcnZpY2VBY2NvdW50OiR7dGhpcy5mdW5jdGlvblNlcnZpY2VBY2NvdW50LmVtYWlsfWAsXG4gICAgfSk7XG4gICAgLy8gU3RlcCA0OiBDcmVhdGUgdGhlIENsb3VkIEZ1bmN0aW9uIHdpdGggQ3VzdG9tIFNlcnZpY2UgQWNjb3VudFxuICAgIHRoaXMuZnVuY3Rpb24gPSBuZXcgQ2xvdWRmdW5jdGlvbnNGdW5jdGlvbih0aGlzLCBcIkRlZmF1bHRGdW5jdGlvblwiLCB7XG4gICAgICBuYW1lOiBSZXNvdXJjZU5hbWVzLmdlbmVyYXRlTmFtZSh0aGlzLCBGVU5DVElPTl9OQU1FX09QVFMpLFxuICAgICAgZGVzY3JpcHRpb246IFwiVGhpcyBmdW5jdGlvbiB3YXMgY3JlYXRlZCBieSBXaW5nXCIsXG4gICAgICBwcm9qZWN0OiBhcHAucHJvamVjdElkLFxuICAgICAgcmVnaW9uOiBhcHAucmVnaW9uLFxuICAgICAgcnVudGltZTogXCJub2RlanMyMFwiLFxuICAgICAgYXZhaWxhYmxlTWVtb3J5TWI6IHByb3BzLm1lbW9yeSA/PyBERUZBVUxUX01FTU9SWV9TSVpFLFxuICAgICAgc291cmNlQXJjaGl2ZUJ1Y2tldDogRnVuY3Rpb25CdWNrZXQuYnVja2V0Lm5hbWUsXG4gICAgICBzb3VyY2VBcmNoaXZlT2JqZWN0OiBGdW5jdGlvbk9iamVjdEJ1Y2tldC5uYW1lLFxuICAgICAgZW50cnlQb2ludDogXCJoYW5kbGVyXCIsXG4gICAgICB0cmlnZ2VySHR0cDogdHJ1ZSxcbiAgICAgIGh0dHBzVHJpZ2dlclNlY3VyaXR5TGV2ZWw6IFwiU0VDVVJFX0FMV0FZU1wiLFxuICAgICAgLy8gSXQgdGFrZXMgYXJvdW5kIDEgbWludXRlcyB0byB0aGUgZnVuY3Rpb24gaW52b2NhdGlvbiBwZXJtaXNzaW9ucyB0byBiZSBlc3RhYmxpc2hlZCAtXG4gICAgICAvLyB0aGVyZWZvcmUsIHRoZSB0aW1lb3V0IGlzIGhpZ2hlciB0aGFuIGluIG90aGVyIHRhcmdldHNcbiAgICAgIHRpbWVvdXQ6IHByb3BzLnRpbWVvdXQ/LnNlY29uZHMgPz8gMTIwLFxuICAgICAgc2VydmljZUFjY291bnRFbWFpbDogdGhpcy5mdW5jdGlvblNlcnZpY2VBY2NvdW50LmVtYWlsLFxuICAgICAgZW52aXJvbm1lbnRWYXJpYWJsZXM6IExhenkuYW55VmFsdWUoe1xuICAgICAgICBwcm9kdWNlOiAoKSA9PiB0aGlzLmVudiA/PyB7fSxcbiAgICAgIH0pIGFzIGFueSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW50ZXJuYWxcbiAgICogQHBhcmFtIGhhbmRsZXIgSUZ1bmN0aW9uSGFuZGxlclxuICAgKiBAcmV0dXJucyB0aGUgZnVuY3Rpb24gY29kZSBsaW5lcyBhcyBzdHJpbmdzXG4gICAqL1xuICBwcm90ZWN0ZWQgX2dldENvZGVMaW5lcyhoYW5kbGVyOiBjbG91ZC5JRnVuY3Rpb25IYW5kbGVyKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGluZmxpZ2h0Q2xpZW50ID0gaGFuZGxlci5fdG9JbmZsaWdodCgpO1xuICAgIGNvbnN0IGxpbmVzID0gbmV3IEFycmF5PHN0cmluZz4oKTtcblxuICAgIGxpbmVzLnB1c2goJ1widXNlIHN0cmljdFwiOycpO1xuXG4gICAgaW5mbGlnaHRDbGllbnQ7XG4gICAgbGluZXMucHVzaChcbiAgICAgIFwiY29uc3QgZnVuY3Rpb25zID0gcmVxdWlyZSgnQGdvb2dsZS1jbG91ZC9mdW5jdGlvbnMtZnJhbWV3b3JrJyk7XFxuXCJcbiAgICApO1xuICAgIGxpbmVzLnB1c2goYGZ1bmN0aW9ucy5odHRwKCdoYW5kbGVyJywgYXN5bmMgKHJlcSwgcmVzKSA9PiB7YCk7XG4gICAgbGluZXMucHVzaChcIiAgcmVzLnNldCgnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKVwiKTtcbiAgICBsaW5lcy5wdXNoKFwiICByZXMuc2V0KCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJywgJ0dFVCwgUE9TVCcpXCIpO1xuXG4gICAgbGluZXMucHVzaChcIiAgdHJ5IHtcIik7XG4gICAgbGluZXMucHVzaChcbiAgICAgIGAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0ICgke2luZmxpZ2h0Q2xpZW50fSkuaGFuZGxlKHJlcS5ib2R5ID8/IFwiXCIpYFxuICAgICk7XG4gICAgbGluZXMucHVzaChgICByZXMuc2VuZChyZXN1bHQpO2ApO1xuICAgIGxpbmVzLnB1c2goYCAgfSBjYXRjaCAoZXJyb3IpIHtgKTtcbiAgICBsaW5lcy5wdXNoKGAgIHJlcy5zdGF0dXMoNTAwKS5zZW5kKGVycm9yLm1lc3NhZ2UpO2ApO1xuICAgIGxpbmVzLnB1c2goXCJ9fSk7XCIpO1xuXG4gICAgcmV0dXJuIGxpbmVzO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3ByZVN5bnRoZXNpemUoKTogdm9pZCB7XG4gICAgc3VwZXIuX3ByZVN5bnRoZXNpemUoKTtcblxuICAgIC8vIGJ1bmRsZWQgY29kZSBpcyBndWFyYW50ZWVkIHRvIGJlIGluIGEgZnJlc2ggZGlyZWN0b3J5XG4gICAgY29uc3QgYnVuZGxlID0gY3JlYXRlQnVuZGxlKHRoaXMuZW50cnlwb2ludCwgW1xuICAgICAgXCJAZ29vZ2xlLWNsb3VkL2Z1bmN0aW9ucy1mcmFtZXdvcmtcIixcbiAgICAgIFwiQGdvb2dsZS1jbG91ZC9kYXRhc3RvcmVcIixcbiAgICBdKTtcblxuICAgIGNvbnN0IHBhY2thZ2VKc29uID0gam9pbihidW5kbGUuZGlyZWN0b3J5LCBcInBhY2thZ2UuanNvblwiKTtcblxuICAgIHdyaXRlRmlsZVN5bmMoXG4gICAgICBwYWNrYWdlSnNvbixcbiAgICAgIEpTT04uc3RyaW5naWZ5KFxuICAgICAgICB7XG4gICAgICAgICAgbWFpbjogYmFzZW5hbWUoYnVuZGxlLm91dGZpbGVQYXRoKSxcbiAgICAgICAgICBkZXBlbmRlbmNpZXM6IHtcbiAgICAgICAgICAgIFwiQGdvb2dsZS1jbG91ZC9mdW5jdGlvbnMtZnJhbWV3b3JrXCI6IFwiXjMuMC4wXCIsXG4gICAgICAgICAgICBcIkBnb29nbGUtY2xvdWQvZGF0YXN0b3JlXCI6IFwiOC40LjBcIixcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBudWxsLFxuICAgICAgICAyXG4gICAgICApXG4gICAgKTtcblxuICAgIGNvbnN0IGFzc2V0ID0gbmV3IFRlcnJhZm9ybUFzc2V0KHRoaXMsIFwiQXNzZXRcIiwge1xuICAgICAgcGF0aDogYnVuZGxlLmRpcmVjdG9yeSxcbiAgICAgIHR5cGU6IEFzc2V0VHlwZS5BUkNISVZFLFxuICAgIH0pO1xuXG4gICAgdGhpcy5hc3NldFBhdGggPSBhc3NldC5wYXRoO1xuICB9XG5cbiAgcHVibGljIGdldCBmdW5jdGlvbk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbi5uYW1lO1xuICB9XG5cbiAgcHVibGljIGdldCBzZXJ2aWNlQWNjb3VudEVtYWlsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuZnVuY3Rpb24uc2VydmljZUFjY291bnRFbWFpbDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcHJvamVjdCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmZ1bmN0aW9uLnByb2plY3Q7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHJlZ2lvbigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmZ1bmN0aW9uLnJlZ2lvbjtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIGdldCBfbGlmdE1hcCgpOiBMaWZ0TWFwIHtcbiAgICByZXR1cm4ge1xuICAgICAgW2Nsb3VkLkZ1bmN0aW9uSW5mbGlnaHRNZXRob2RzLklOVk9LRV06IFtbdGhpcy5oYW5kbGVyLCBbXCJoYW5kbGVcIl1dXSxcbiAgICB9O1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3RvSW5mbGlnaHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY29yZS5JbmZsaWdodENsaWVudC5mb3IoXG4gICAgICBfX2Rpcm5hbWUucmVwbGFjZShcInRhcmdldC10Zi1nY3BcIiwgXCJzaGFyZWQtZ2NwXCIpLFxuICAgICAgX19maWxlbmFtZSxcbiAgICAgIFwiRnVuY3Rpb25DbGllbnRcIixcbiAgICAgIFtcbiAgICAgICAgYHByb2Nlc3MuZW52W1wiJHt0aGlzLmVudk5hbWUoKX1cIl1gLFxuICAgICAgICBgcHJvY2Vzcy5lbnZbXCIke3RoaXMucHJvamVjdEVudigpfVwiXWAsXG4gICAgICAgIGBwcm9jZXNzLmVudltcIiR7dGhpcy5yZWdpb25FbnYoKX1cIl1gLFxuICAgICAgXVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYWRkUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgcGVybWlzc2lvbnMuZm9yRWFjaCgocGVybWlzc2lvbikgPT4ge1xuICAgICAgdGhpcy5wZXJtaXNzaW9ucy5hZGQocGVybWlzc2lvbik7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgb25MaWZ0KGhvc3Q6IElJbmZsaWdodEhvc3QsIG9wczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICBpZiAoIShob3N0IGluc3RhbmNlb2YgRnVuY3Rpb24pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwidGZnY3AuRnVuY3Rpb24gY2FuIG9ubHkgYmUgYm91bmQgYnkgdGZnY3AuRnVuY3Rpb24gZm9yIG5vd1wiXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChvcHMuaW5jbHVkZXMoY2xvdWQuRnVuY3Rpb25JbmZsaWdodE1ldGhvZHMuSU5WT0tFKSkge1xuICAgICAgaG9zdC5hZGRQZXJtaXNzaW9ucyhbXCJjbG91ZGZ1bmN0aW9ucy5mdW5jdGlvbnMuaW52b2tlXCJdKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHJlZ2lvbiwgcHJvamVjdElkIH0gPSBBcHAub2YodGhpcykgYXMgQXBwO1xuICAgIGhvc3QuYWRkRW52aXJvbm1lbnQodGhpcy5lbnZOYW1lKCksIHRoaXMuZnVuY3Rpb24ubmFtZSk7XG4gICAgaG9zdC5hZGRFbnZpcm9ubWVudCh0aGlzLnByb2plY3RFbnYoKSwgcHJvamVjdElkKTtcbiAgICBob3N0LmFkZEVudmlyb25tZW50KHRoaXMucmVnaW9uRW52KCksIHJlZ2lvbik7XG5cbiAgICBzdXBlci5vbkxpZnQoaG9zdCwgb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHcmFudHMgdGhlIGdpdmVuIHNlcnZpY2UgYWNjb3VudCBwZXJtaXNzaW9uIHRvIGludm9rZSB0aGlzIGZ1bmN0aW9uLlxuICAgKiBAcGFyYW0gc2VydmljZUFjY291bnQgVGhlIHNlcnZpY2UgYWNjb3VudCB0byBncmFudCBpbnZva2UgcGVybWlzc2lvbnMgdG8uXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIF9hZGRQZXJtaXNzaW9uVG9JbnZva2Uoc2VydmljZUFjY291bnQ6IFNlcnZpY2VBY2NvdW50KTogdm9pZCB7XG4gICAgY29uc3QgaGFzaCA9IEZuLnNoYTI1NihzZXJ2aWNlQWNjb3VudC5lbWFpbCkuc2xpY2UoLTgpO1xuXG4gICAgbmV3IENsb3VkZnVuY3Rpb25zRnVuY3Rpb25JYW1NZW1iZXIodGhpcywgYGludm9rZXItcGVybWlzc2lvbi0ke2hhc2h9YCwge1xuICAgICAgcHJvamVjdDogdGhpcy5mdW5jdGlvbi5wcm9qZWN0LFxuICAgICAgcmVnaW9uOiB0aGlzLmZ1bmN0aW9uLnJlZ2lvbixcbiAgICAgIGNsb3VkRnVuY3Rpb246IHRoaXMuZnVuY3Rpb24ubmFtZSxcbiAgICAgIHJvbGU6IFwicm9sZXMvY2xvdWRmdW5jdGlvbnMuaW52b2tlclwiLFxuICAgICAgbWVtYmVyOiBgc2VydmljZUFjY291bnQ6JHtzZXJ2aWNlQWNjb3VudC5lbWFpbH1gLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX2dldEh0dHBzVHJpZ2dlclVybCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmZ1bmN0aW9uLmh0dHBzVHJpZ2dlclVybDtcbiAgfVxuXG4gIHByaXZhdGUgZW52TmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgRlVOQ1RJT05fTkFNRV8ke3RoaXMubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG5cbiAgcHJpdmF0ZSByZWdpb25FbnYoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFJFR0lPTl8ke3RoaXMubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG5cbiAgcHJpdmF0ZSBwcm9qZWN0RW52KCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBQUk9KRUNUXyR7dGhpcy5ub2RlLmFkZHIuc2xpY2UoLTgpfWA7XG4gIH1cbn1cbiJdfQ==