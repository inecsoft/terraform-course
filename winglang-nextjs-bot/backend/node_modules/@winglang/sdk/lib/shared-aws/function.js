"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.FunctionRef = exports.Function = exports.externalLibraries = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const inflight_host_1 = require("./inflight-host");
const util_1 = require("./util");
const cloud_1 = require("../cloud");
const core_1 = require("../core");
const types_1 = require("../core/types");
const std_1 = require("../std");
const ui = __importStar(require("../ui"));
exports.externalLibraries = [
    "@aws-sdk/client-sso",
    "@aws-sdk/client-sso-oidc",
    "@aws-sdk/credential-provider-ini",
    "@aws-sdk/credential-provider-process",
    "@aws-sdk/credential-provider-sso",
    "@aws-sdk/credential-provider-web-identity",
    "@aws-sdk/token-providers",
];
/**
 * A helper class for working with AWS functions.
 */
class Function {
    /** @internal */
    static _toInflightType() {
        return core_1.InflightClient.forType(__filename.replace("function", "function.inflight"), "FunctionClient");
    }
    /**
     * Returns the current Lambda invocation context, if the host is an AWS Lambda.
     * @see https://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-context.html
     * @inflight
     * @returns The current Lambda invocation context.
     */
    static async context() {
        // The implementation of this method is in function.inflight.ts
        throw new Error("Not implemented");
    }
    /**
     * If the inflight host is an AWS Lambda, return a helper interface for
     * working with it.
     * @param host The inflight host.
     */
    static from(host) {
        if (this.isAwsFunction(host)) {
            return host;
        }
        return undefined;
    }
    static isAwsFunction(obj) {
        return (typeof obj.functionArn === "string" &&
            typeof obj.functionName === "string");
    }
}
exports.Function = Function;
_a = JSII_RTTI_SYMBOL_1;
Function[_a] = { fqn: "@winglang/sdk.aws.Function", version: "0.0.0" };
/**
 * A reference to an external Lambda function.
 *
 * @inflight `@winglang/sdk.cloud.IFunctionClient`
 */
class FunctionRef extends std_1.Resource {
    constructor(scope, id, functionArn) {
        super(scope, id);
        if (!(0, util_1.isValidArn)(functionArn, "lambda")) {
            throw new Error(`"${functionArn}" is not a valid Amazon Lambda ARN`);
        }
        this.functionArn = functionArn;
        this.addUserInterface();
    }
    onLift(host, ops) {
        if (inflight_host_1.AwsInflightHost.isAwsInflightHost(host)) {
            if (ops.includes(cloud_1.FunctionInflightMethods.INVOKE) ||
                ops.includes(cloud_1.FunctionInflightMethods.INVOKE_ASYNC)) {
                host.addPolicyStatements({
                    actions: ["lambda:InvokeFunction"],
                    resources: [this.functionArn],
                });
            }
        }
        host.addEnvironment(this.envName(), this.functionArn);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core_1.InflightClient.for(__dirname, __filename, "FunctionClient", [
            `process.env["${this.envName()}"]`,
        ]);
    }
    envName() {
        return `FUNCTION_NAME_${this.node.addr.slice(-8)}`;
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud_1.FunctionInflightMethods.INVOKE]: [],
            [cloud_1.FunctionInflightMethods.INVOKE_ASYNC]: [],
        };
    }
    addUserInterface() {
        std_1.Node.of(this).color = "pink";
        const functionArn = this.functionArn;
        const awsConsoleHandler = (0, core_1.lift)({ functionArn }).inflight(async (ctx) => {
            try {
                const parts = ctx.functionArn.split(":");
                const region = parts[3];
                const name = parts[6];
                return ("https://" +
                    region +
                    ".console.aws.amazon.com/lambda/home?region=" +
                    region +
                    "#/functions/" +
                    name);
            }
            catch (e) {
                return e.message;
            }
        });
        new ui.Field(this, "AwsConsoleField", "AWS Console", awsConsoleHandler, {
            link: true,
        });
        new ui.ValueField(this, "FunctionArnField", "Function ARN", this.functionArn);
    }
}
exports.FunctionRef = FunctionRef;
_b = JSII_RTTI_SYMBOL_1;
FunctionRef[_b] = { fqn: "@winglang/sdk.aws.FunctionRef", version: "0.0.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2hhcmVkLWF3cy9mdW5jdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsbURBQW9FO0FBQ3BFLGlDQUFvQztBQUNwQyxvQ0FBb0U7QUFDcEUsa0NBQXdEO0FBQ3hELHlDQUFnRDtBQUNoRCxnQ0FBdUQ7QUFDdkQsMENBQTRCO0FBRWYsUUFBQSxpQkFBaUIsR0FBRztJQUMvQixxQkFBcUI7SUFDckIsMEJBQTBCO0lBQzFCLGtDQUFrQztJQUNsQyxzQ0FBc0M7SUFDdEMsa0NBQWtDO0lBQ2xDLDJDQUEyQztJQUMzQywwQkFBMEI7Q0FDM0IsQ0FBQztBQWlCRjs7R0FFRztBQUNILE1BQWEsUUFBUTtJQUNuQixnQkFBZ0I7SUFDVCxNQUFNLENBQUMsZUFBZTtRQUMzQixPQUFPLHFCQUFjLENBQUMsT0FBTyxDQUMzQixVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxtQkFBbUIsQ0FBQyxFQUNuRCxnQkFBZ0IsQ0FDakIsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTztRQUN6QiwrREFBK0Q7UUFDL0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFtQjtRQUNwQyxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUM3QixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRU8sTUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUFRO1FBQ25DLE9BQU8sQ0FDTCxPQUFPLEdBQUcsQ0FBQyxXQUFXLEtBQUssUUFBUTtZQUNuQyxPQUFPLEdBQUcsQ0FBQyxZQUFZ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O1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFLGFBQWEsRUFBRSxpQkFBaUIsRUFBRTtZQUN0RSxJQUFJLEVBQUUsSUFBSTtTQUNYLENBQUMsQ0FBQztRQUVILElBQUksRUFBRSxDQUFDLFVBQVUsQ0FDZixJQUFJLEVBQ0osa0JBQWtCLEVBQ2xCLGNBQWMsRUFDZCxJQUFJLENBQUMsV0FBVyxDQUNqQixDQUFDO0lBQ0osQ0FBQzs7QUExRkgsa0NBMkZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IEF3c0luZmxpZ2h0SG9zdCwgSUF3c0luZmxpZ2h0SG9zdCB9IGZyb20gXCIuL2luZmxpZ2h0LWhvc3RcIjtcbmltcG9ydCB7IGlzVmFsaWRBcm4gfSBmcm9tIFwiLi91dGlsXCI7XG5pbXBvcnQgeyBGdW5jdGlvbkluZmxpZ2h0TWV0aG9kcywgSUZ1bmN0aW9uQ2xpZW50IH0gZnJvbSBcIi4uL2Nsb3VkXCI7XG5pbXBvcnQgeyBJbmZsaWdodENsaWVudCwgbGlmdCwgTGlmdE1hcCB9IGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQgeyBJTkZMSUdIVF9TWU1CT0wgfSBmcm9tIFwiLi4vY29yZS90eXBlc1wiO1xuaW1wb3J0IHsgSUluZmxpZ2h0SG9zdCwgTm9kZSwgUmVzb3VyY2UgfSBmcm9tIFwiLi4vc3RkXCI7XG5pbXBvcnQgKiBhcyB1aSBmcm9tIFwiLi4vdWlcIjtcblxuZXhwb3J0IGNvbnN0IGV4dGVybmFsTGlicmFyaWVzID0gW1xuICBcIkBhd3Mtc2RrL2NsaWVudC1zc29cIixcbiAgXCJAYXdzLXNkay9jbGllbnQtc3NvLW9pZGNcIixcbiAgXCJAYXdzLXNkay9jcmVkZW50aWFsLXByb3ZpZGVyLWluaVwiLFxuICBcIkBhd3Mtc2RrL2NyZWRlbnRpYWwtcHJvdmlkZXItcHJvY2Vzc1wiLFxuICBcIkBhd3Mtc2RrL2NyZWRlbnRpYWwtcHJvdmlkZXItc3NvXCIsXG4gIFwiQGF3cy1zZGsvY3JlZGVudGlhbC1wcm92aWRlci13ZWItaWRlbnRpdHlcIixcbiAgXCJAYXdzLXNkay90b2tlbi1wcm92aWRlcnNcIixcbl07XG5cbi8qKlxuICogQSBzaGFyZWQgaW50ZXJmYWNlIGZvciBBV1MgZnVuY3Rpb25zLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIElBd3NGdW5jdGlvbiBleHRlbmRzIElBd3NJbmZsaWdodEhvc3Qge1xuICAvKipcbiAgICogQVdTIEZ1bmN0aW9uIGFyblxuICAgKi9cbiAgcmVhZG9ubHkgZnVuY3Rpb25Bcm46IHN0cmluZztcblxuICAvKipcbiAgICogQVdTIEZ1bmN0aW9uIG5hbWVcbiAgICovXG4gIHJlYWRvbmx5IGZ1bmN0aW9uTmFtZTogc3RyaW5nO1xufVxuXG4vKipcbiAqIEEgaGVscGVyIGNsYXNzIGZvciB3b3JraW5nIHdpdGggQVdTIGZ1bmN0aW9ucy5cbiAqL1xuZXhwb3J0IGNsYXNzIEZ1bmN0aW9uIHtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgc3RhdGljIF90b0luZmxpZ2h0VHlwZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBJbmZsaWdodENsaWVudC5mb3JUeXBlKFxuICAgICAgX19maWxlbmFtZS5yZXBsYWNlKFwiZnVuY3Rpb25cIiwgXCJmdW5jdGlvbi5pbmZsaWdodFwiKSxcbiAgICAgIFwiRnVuY3Rpb25DbGllbnRcIlxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgY3VycmVudCBMYW1iZGEgaW52b2NhdGlvbiBjb250ZXh0LCBpZiB0aGUgaG9zdCBpcyBhbiBBV1MgTGFtYmRhLlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9sYW1iZGEvbGF0ZXN0L2RnL25vZGVqcy1wcm9nLW1vZGVsLWNvbnRleHQuaHRtbFxuICAgKiBAaW5mbGlnaHRcbiAgICogQHJldHVybnMgVGhlIGN1cnJlbnQgTGFtYmRhIGludm9jYXRpb24gY29udGV4dC5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgYXN5bmMgY29udGV4dCgpOiBQcm9taXNlPElMYW1iZGFDb250ZXh0IHwgdW5kZWZpbmVkPiB7XG4gICAgLy8gVGhlIGltcGxlbWVudGF0aW9uIG9mIHRoaXMgbWV0aG9kIGlzIGluIGZ1bmN0aW9uLmluZmxpZ2h0LnRzXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTm90IGltcGxlbWVudGVkXCIpO1xuICB9XG5cbiAgLyoqXG4gICAqIElmIHRoZSBpbmZsaWdodCBob3N0IGlzIGFuIEFXUyBMYW1iZGEsIHJldHVybiBhIGhlbHBlciBpbnRlcmZhY2UgZm9yXG4gICAqIHdvcmtpbmcgd2l0aCBpdC5cbiAgICogQHBhcmFtIGhvc3QgVGhlIGluZmxpZ2h0IGhvc3QuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGZyb20oaG9zdDogSUluZmxpZ2h0SG9zdCk6IElBd3NGdW5jdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKHRoaXMuaXNBd3NGdW5jdGlvbihob3N0KSkge1xuICAgICAgcmV0dXJuIGhvc3Q7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBpc0F3c0Z1bmN0aW9uKG9iajogYW55KTogb2JqIGlzIElBd3NGdW5jdGlvbiB7XG4gICAgcmV0dXJuIChcbiAgICAgIHR5cGVvZiBvYmouZnVuY3Rpb25Bcm4gPT09IFwic3RyaW5nXCIgJiZcbiAgICAgIHR5cGVvZiBvYmouZnVuY3Rpb25OYW1lID09PSBcInN0cmluZ1wiXG4gICAgKTtcbiAgfVxufVxuXG4vKipcbiAqIFRoZSBBV1MgTGFtYmRhIGNvbnRleHQgb2JqZWN0LlxuICogQGluZmxpZ2h0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUxhbWJkYUNvbnRleHQge1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIExhbWJkYSBmdW5jdGlvbi5cbiAgICovXG4gIHJlYWRvbmx5IGZ1bmN0aW9uTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgdmVyc2lvbiBvZiB0aGUgZnVuY3Rpb24uXG4gICAqL1xuICByZWFkb25seSBmdW5jdGlvblZlcnNpb246IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIEFtYXpvbiBSZXNvdXJjZSBOYW1lIChBUk4pIHRoYXQncyB1c2VkIHRvIGludm9rZSB0aGUgZnVuY3Rpb24uXG4gICAqIEluZGljYXRlcyBpZiB0aGUgaW52b2tlciBzcGVjaWZpZWQgYSB2ZXJzaW9uIG51bWJlciBvciBhbGlhcy5cbiAgICovXG4gIHJlYWRvbmx5IGludm9rZWRGdW5jdGlvbkFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgYW1vdW50IG9mIG1lbW9yeSB0aGF0J3MgYWxsb2NhdGVkIGZvciB0aGUgZnVuY3Rpb24uXG4gICAqL1xuICByZWFkb25seSBtZW1vcnlMaW1pdEluTUI6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIGlkZW50aWZpZXIgb2YgdGhlIGludm9jYXRpb24gcmVxdWVzdC5cbiAgICovXG4gIHJlYWRvbmx5IGF3c1JlcXVlc3RJZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgbG9nIGdyb3VwIGZvciB0aGUgZnVuY3Rpb24uXG4gICAqL1xuICByZWFkb25seSBsb2dHcm91cE5hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIGxvZyBzdHJlYW0gZm9yIHRoZSBmdW5jdGlvbiBpbnN0YW5jZS5cbiAgICovXG4gIHJlYWRvbmx5IGxvZ1N0cmVhbU5hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBsZWZ0IGJlZm9yZSB0aGUgZXhlY3V0aW9uIHRpbWVzIG91dC5cbiAgICovXG4gIHJlbWFpbmluZ1RpbWVJbk1pbGxpcygpOiBudW1iZXI7XG59XG5cbi8qKlxuICogQSByZWZlcmVuY2UgdG8gYW4gZXh0ZXJuYWwgTGFtYmRhIGZ1bmN0aW9uLlxuICpcbiAqIEBpbmZsaWdodCBgQHdpbmdsYW5nL3Nkay5jbG91ZC5JRnVuY3Rpb25DbGllbnRgXG4gKi9cbmV4cG9ydCBjbGFzcyBGdW5jdGlvblJlZiBleHRlbmRzIFJlc291cmNlIHtcbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgW0lORkxJR0hUX1NZTUJPTF0/OiBJRnVuY3Rpb25DbGllbnQ7XG5cbiAgLyoqXG4gICAqIFRoZSBBUk4gb2YgdGhpcyBmdW5jdGlvbi5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBmdW5jdGlvbkFybjogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIGZ1bmN0aW9uQXJuOiBzdHJpbmcpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgaWYgKCFpc1ZhbGlkQXJuKGZ1bmN0aW9uQXJuLCBcImxhbWJkYVwiKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBcIiR7ZnVuY3Rpb25Bcm59XCIgaXMgbm90IGEgdmFsaWQgQW1hem9uIExhbWJkYSBBUk5gKTtcbiAgICB9XG5cbiAgICB0aGlzLmZ1bmN0aW9uQXJuID0gZnVuY3Rpb25Bcm47XG5cbiAgICB0aGlzLmFkZFVzZXJJbnRlcmZhY2UoKTtcbiAgfVxuXG4gIHB1YmxpYyBvbkxpZnQoaG9zdDogSUluZmxpZ2h0SG9zdCwgb3BzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIGlmIChBd3NJbmZsaWdodEhvc3QuaXNBd3NJbmZsaWdodEhvc3QoaG9zdCkpIHtcbiAgICAgIGlmIChcbiAgICAgICAgb3BzLmluY2x1ZGVzKEZ1bmN0aW9uSW5mbGlnaHRNZXRob2RzLklOVk9LRSkgfHxcbiAgICAgICAgb3BzLmluY2x1ZGVzKEZ1bmN0aW9uSW5mbGlnaHRNZXRob2RzLklOVk9LRV9BU1lOQylcbiAgICAgICkge1xuICAgICAgICBob3N0LmFkZFBvbGljeVN0YXRlbWVudHMoe1xuICAgICAgICAgIGFjdGlvbnM6IFtcImxhbWJkYTpJbnZva2VGdW5jdGlvblwiXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFt0aGlzLmZ1bmN0aW9uQXJuXSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaG9zdC5hZGRFbnZpcm9ubWVudCh0aGlzLmVudk5hbWUoKSwgdGhpcy5mdW5jdGlvbkFybik7XG4gICAgc3VwZXIub25MaWZ0KGhvc3QsIG9wcyk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyBfdG9JbmZsaWdodCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBJbmZsaWdodENsaWVudC5mb3IoX19kaXJuYW1lLCBfX2ZpbGVuYW1lLCBcIkZ1bmN0aW9uQ2xpZW50XCIsIFtcbiAgICAgIGBwcm9jZXNzLmVudltcIiR7dGhpcy5lbnZOYW1lKCl9XCJdYCxcbiAgICBdKTtcbiAgfVxuXG4gIHByaXZhdGUgZW52TmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgRlVOQ1RJT05fTkFNRV8ke3RoaXMubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgZ2V0IF9saWZ0TWFwKCk6IExpZnRNYXAge1xuICAgIHJldHVybiB7XG4gICAgICBbRnVuY3Rpb25JbmZsaWdodE1ldGhvZHMuSU5WT0tFXTogW10sXG4gICAgICBbRnVuY3Rpb25JbmZsaWdodE1ldGhvZHMuSU5WT0tFX0FTWU5DXTogW10sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVXNlckludGVyZmFjZSgpIHtcbiAgICBOb2RlLm9mKHRoaXMpLmNvbG9yID0gXCJwaW5rXCI7XG5cbiAgICBjb25zdCBmdW5jdGlvbkFybiA9IHRoaXMuZnVuY3Rpb25Bcm47XG5cbiAgICBjb25zdCBhd3NDb25zb2xlSGFuZGxlciA9IGxpZnQoeyBmdW5jdGlvbkFybiB9KS5pbmZsaWdodChhc3luYyAoY3R4KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwYXJ0cyA9IGN0eC5mdW5jdGlvbkFybi5zcGxpdChcIjpcIik7XG4gICAgICAgIGNvbnN0IHJlZ2lvbiA9IHBhcnRzWzNdO1xuICAgICAgICBjb25zdCBuYW1lID0gcGFydHNbNl07XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgXCJodHRwczovL1wiICtcbiAgICAgICAgICByZWdpb24gK1xuICAgICAgICAgIFwiLmNvbnNvbGUuYXdzLmFtYXpvbi5jb20vbGFtYmRhL2hvbWU/cmVnaW9uPVwiICtcbiAgICAgICAgICByZWdpb24gK1xuICAgICAgICAgIFwiIy9mdW5jdGlvbnMvXCIgK1xuICAgICAgICAgIG5hbWVcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgICAgICByZXR1cm4gZS5tZXNzYWdlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgbmV3IHVpLkZpZWxkKHRoaXMsIFwiQXdzQ29uc29sZUZpZWxkXCIsIFwiQVdTIENvbnNvbGVcIiwgYXdzQ29uc29sZUhhbmRsZXIsIHtcbiAgICAgIGxpbms6IHRydWUsXG4gICAgfSk7XG5cbiAgICBuZXcgdWkuVmFsdWVGaWVsZChcbiAgICAgIHRoaXMsXG4gICAgICBcIkZ1bmN0aW9uQXJuRmllbGRcIixcbiAgICAgIFwiRnVuY3Rpb24gQVJOXCIsXG4gICAgICB0aGlzLmZ1bmN0aW9uQXJuXG4gICAgKTtcbiAgfVxufVxuIl19