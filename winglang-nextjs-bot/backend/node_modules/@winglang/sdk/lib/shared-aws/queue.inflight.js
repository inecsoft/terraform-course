"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.QueueClient = void 0;
const client_sqs_1 = require("@aws-sdk/client-sqs");
class QueueClient {
    constructor(_queueUrlOrArn, client = new client_sqs_1.SQSClient({})) {
        this._queueUrlOrArn = _queueUrlOrArn;
        this.client = client;
    }
    async push(...messages) {
        if (messages.includes("")) {
            throw new Error("Empty messages are not allowed");
        }
        const messagePromises = messages.map(async (message) => {
            try {
                const command = new client_sqs_1.SendMessageCommand({
                    QueueUrl: await this.queueUrl(),
                    MessageBody: message,
                });
                await this.client.send(command);
            }
            catch (e) {
                if (e instanceof client_sqs_1.InvalidMessageContents) {
                    throw new Error(`The message contains characters outside the allowed set (message=${message}): ${e.stack})}`);
                }
                throw new Error(e.stack);
            }
        });
        await Promise.all(messagePromises);
    }
    async queueUrl() {
        if (!this._queueUrl) {
            // if we have the queue name instead of the url, then we need to resolve it first
            if (this._queueUrlOrArn.startsWith("https://")) {
                this._queueUrl = this._queueUrlOrArn;
            }
            else {
                // extract the queue name from its ARN
                const arnParts = this._queueUrlOrArn.split(":");
                const queueName = arnParts[arnParts.length - 1].split("/").pop();
                if (!queueName) {
                    throw new Error(`Unable to extract queue name from ARN: ${this._queueUrlOrArn}`);
                }
                const command = new client_sqs_1.GetQueueUrlCommand({ QueueName: queueName });
                const data = await this.client.send(command);
                if (!data.QueueUrl) {
                    throw new Error(`Unable to resolve queue URL from SQS queue ARN: ${this._queueUrlOrArn}`);
                }
                this._queueUrl = data.QueueUrl;
            }
        }
        return this._queueUrl;
    }
    async purge() {
        const command = new client_sqs_1.PurgeQueueCommand({
            QueueUrl: await this.queueUrl(),
        });
        await this.client.send(command);
    }
    async approxSize() {
        const command = new client_sqs_1.GetQueueAttributesCommand({
            QueueUrl: await this.queueUrl(),
            AttributeNames: ["ApproximateNumberOfMessages"],
        });
        const data = await this.client.send(command);
        return Number.parseInt(data.Attributes?.ApproximateNumberOfMessages ?? "0");
    }
    async pop() {
        const receiveCommand = new client_sqs_1.ReceiveMessageCommand({
            QueueUrl: await this.queueUrl(),
            MaxNumberOfMessages: 1,
        });
        const data = await this.client.send(receiveCommand);
        if (!data.Messages || data.Messages.length === 0) {
            return undefined;
        }
        const message = data.Messages[0];
        if (message.ReceiptHandle) {
            const deleteCommand = new client_sqs_1.DeleteMessageCommand({
                QueueUrl: await this.queueUrl(),
                ReceiptHandle: message.ReceiptHandle,
            });
            await this.client.send(deleteCommand);
        }
        else {
            console.warn(`No receipt handle found, message not deleted. Message: ${JSON.stringify(message)}`);
        }
        return message.Body;
    }
}
exports.QueueClient = QueueClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVldWUuaW5mbGlnaHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2hhcmVkLWF3cy9xdWV1ZS5pbmZsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxvREFTNkI7QUFHN0IsTUFBYSxXQUFXO0lBR3RCLFlBQ21CLGNBQXNCLEVBQ3RCLFNBQW9CLElBQUksc0JBQVMsQ0FBQyxFQUFFLENBQUM7UUFEckMsbUJBQWMsR0FBZCxjQUFjLENBQVE7UUFDdEIsV0FBTSxHQUFOLE1BQU0sQ0FBK0I7SUFDckQsQ0FBQztJQUVHLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFrQjtRQUNyQyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUMxQixNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7UUFDcEQsQ0FBQztRQUVELE1BQU0sZUFBZSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxFQUFFO1lBQ3JELElBQUksQ0FBQztnQkFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLCtCQUFrQixDQUFDO29CQUNyQyxRQUFRLEVBQUUsTUFBTSxJQUFJLENBQUMsUUFBUSxFQUFFO29CQUMvQixXQUFXLEVBQUUsT0FBTztpQkFDckIsQ0FBQyxDQUFDO2dCQUNILE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbEMsQ0FBQztZQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7Z0JBQ1gsSUFBSSxDQUFDLFlBQVksbUNBQXNCLEVBQUUsQ0FBQztvQkFDeEMsTUFBTSxJQUFJLEtBQUssQ0FDYixvRUFBb0UsT0FBTyxNQUN4RSxDQUFXLENBQUMsS0FDZixJQUFJLENBQ0wsQ0FBQztnQkFDSixDQUFDO2dCQUNELE1BQU0sSUFBSSxLQUFLLENBQUUsQ0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3RDLENB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LENBQUMsQ0FBQztRQUVqQyxJQUFJLE9BQU8sQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUMxQixNQUFNLGFBQWEsR0FBRyxJQUFJLGlDQUFvQixDQUFDO2dCQUM3QyxRQUFRLEVBQUUsTUFBTSxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUMvQixhQUFhLEVBQUUsT0FBTyxDQUFDLGFBQWE7YUFDckMsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN4QyxDQUFDO2FBQU0sQ0FBQztZQUNOLE9BQU8sQ0FBQyxJQUFJLENBQ1YsMERBQTBELElBQUksQ0FBQyxTQUFTLENBQ3RFLE9BQU8sQ0FDUixFQUFFLENBQ0osQ0FBQztRQUNKLENBQUM7UUFFRCxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBN0dELGtDQTZHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFNRU0NsaWVudCxcbiAgU2VuZE1lc3NhZ2VDb21tYW5kLFxuICBQdXJnZVF1ZXVlQ29tbWFuZCxcbiAgR2V0UXVldWVBdHRyaWJ1dGVzQ29tbWFuZCxcbiAgUmVjZWl2ZU1lc3NhZ2VDb21tYW5kLFxuICBJbnZhbGlkTWVzc2FnZUNvbnRlbnRzLFxuICBEZWxldGVNZXNzYWdlQ29tbWFuZCxcbiAgR2V0UXVldWVVcmxDb21tYW5kLFxufSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LXNxc1wiO1xuaW1wb3J0IHsgSUF3c1F1ZXVlQ2xpZW50IH0gZnJvbSBcIi4vcXVldWVcIjtcblxuZXhwb3J0IGNsYXNzIFF1ZXVlQ2xpZW50IGltcGxlbWVudHMgSUF3c1F1ZXVlQ2xpZW50IHtcbiAgcHJpdmF0ZSBfcXVldWVVcmw/OiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBfcXVldWVVcmxPckFybjogc3RyaW5nLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2xpZW50OiBTUVNDbGllbnQgPSBuZXcgU1FTQ2xpZW50KHt9KVxuICApIHt9XG5cbiAgcHVibGljIGFzeW5jIHB1c2goLi4ubWVzc2FnZXM6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKG1lc3NhZ2VzLmluY2x1ZGVzKFwiXCIpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFbXB0eSBtZXNzYWdlcyBhcmUgbm90IGFsbG93ZWRcIik7XG4gICAgfVxuXG4gICAgY29uc3QgbWVzc2FnZVByb21pc2VzID0gbWVzc2FnZXMubWFwKGFzeW5jIChtZXNzYWdlKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBjb21tYW5kID0gbmV3IFNlbmRNZXNzYWdlQ29tbWFuZCh7XG4gICAgICAgICAgUXVldWVVcmw6IGF3YWl0IHRoaXMucXVldWVVcmwoKSxcbiAgICAgICAgICBNZXNzYWdlQm9keTogbWVzc2FnZSxcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGlmIChlIGluc3RhbmNlb2YgSW52YWxpZE1lc3NhZ2VDb250ZW50cykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBUaGUgbWVzc2FnZSBjb250YWlucyBjaGFyYWN0ZXJzIG91dHNpZGUgdGhlIGFsbG93ZWQgc2V0IChtZXNzYWdlPSR7bWVzc2FnZX0pOiAke1xuICAgICAgICAgICAgICAoZSBhcyBFcnJvcikuc3RhY2tcbiAgICAgICAgICAgIH0pfWBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcigoZSBhcyBFcnJvcikuc3RhY2spO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwobWVzc2FnZVByb21pc2VzKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBxdWV1ZVVybCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICghdGhpcy5fcXVldWVVcmwpIHtcbiAgICAgIC8vIGlmIHdlIGhhdmUgdGhlIHF1ZXVlIG5hbWUgaW5zdGVhZCBvZiB0aGUgdXJsLCB0aGVuIHdlIG5lZWQgdG8gcmVzb2x2ZSBpdCBmaXJzdFxuICAgICAgaWYgKHRoaXMuX3F1ZXVlVXJsT3JBcm4uc3RhcnRzV2l0aChcImh0dHBzOi8vXCIpKSB7XG4gICAgICAgIHRoaXMuX3F1ZXVlVXJsID0gdGhpcy5fcXVldWVVcmxPckFybjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGV4dHJhY3QgdGhlIHF1ZXVlIG5hbWUgZnJvbSBpdHMgQVJOXG4gICAgICAgIGNvbnN0IGFyblBhcnRzID0gdGhpcy5fcXVldWVVcmxPckFybi5zcGxpdChcIjpcIik7XG4gICAgICAgIGNvbnN0IHF1ZXVlTmFtZSA9IGFyblBhcnRzW2FyblBhcnRzLmxlbmd0aCAtIDFdLnNwbGl0KFwiL1wiKS5wb3AoKTtcbiAgICAgICAgaWYgKCFxdWV1ZU5hbWUpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgVW5hYmxlIHRvIGV4dHJhY3QgcXVldWUgbmFtZSBmcm9tIEFSTjogJHt0aGlzLl9xdWV1ZVVybE9yQXJufWBcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRRdWV1ZVVybENvbW1hbmQoeyBRdWV1ZU5hbWU6IHF1ZXVlTmFtZSB9KTtcbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgICAgIGlmICghZGF0YS5RdWV1ZVVybCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBVbmFibGUgdG8gcmVzb2x2ZSBxdWV1ZSBVUkwgZnJvbSBTUVMgcXVldWUgQVJOOiAke3RoaXMuX3F1ZXVlVXJsT3JBcm59YFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9xdWV1ZVVybCA9IGRhdGEuUXVldWVVcmw7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX3F1ZXVlVXJsO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHB1cmdlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHVyZ2VRdWV1ZUNvbW1hbmQoe1xuICAgICAgUXVldWVVcmw6IGF3YWl0IHRoaXMucXVldWVVcmwoKSxcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLmNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGFwcHJveFNpemUoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IEdldFF1ZXVlQXR0cmlidXRlc0NvbW1hbmQoe1xuICAgICAgUXVldWVVcmw6IGF3YWl0IHRoaXMucXVldWVVcmwoKSxcbiAgICAgIEF0dHJpYnV0ZU5hbWVzOiBbXCJBcHByb3hpbWF0ZU51bWJlck9mTWVzc2FnZXNcIl0sXG4gICAgfSk7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuY2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgcmV0dXJuIE51bWJlci5wYXJzZUludChkYXRhLkF0dHJpYnV0ZXM/LkFwcHJveGltYXRlTnVtYmVyT2ZNZXNzYWdlcyA/PyBcIjBcIik7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcG9wKCk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgcmVjZWl2ZUNvbW1hbmQgPSBuZXcgUmVjZWl2ZU1lc3NhZ2VDb21tYW5kKHtcbiAgICAgIFF1ZXVlVXJsOiBhd2FpdCB0aGlzLnF1ZXVlVXJsKCksXG4gICAgICBNYXhOdW1iZXJPZk1lc3NhZ2VzOiAxLFxuICAgIH0pO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmNsaWVudC5zZW5kKHJlY2VpdmVDb21tYW5kKTtcbiAgICBpZiAoIWRhdGEuTWVzc2FnZXMgfHwgZGF0YS5NZXNzYWdlcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgY29uc3QgbWVzc2FnZSA9IGRhdGEuTWVzc2FnZXNbMF07XG5cbiAgICBpZiAobWVzc2FnZS5SZWNlaXB0SGFuZGxlKSB7XG4gICAgICBjb25zdCBkZWxldGVDb21tYW5kID0gbmV3IERlbGV0ZU1lc3NhZ2VDb21tYW5kKHtcbiAgICAgICAgUXVldWVVcmw6IGF3YWl0IHRoaXMucXVldWVVcmwoKSxcbiAgICAgICAgUmVjZWlwdEhhbmRsZTogbWVzc2FnZS5SZWNlaXB0SGFuZGxlLFxuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLmNsaWVudC5zZW5kKGRlbGV0ZUNvbW1hbmQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBObyByZWNlaXB0IGhhbmRsZSBmb3VuZCwgbWVzc2FnZSBub3QgZGVsZXRlZC4gTWVzc2FnZTogJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICBtZXNzYWdlXG4gICAgICAgICl9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbWVzc2FnZS5Cb2R5O1xuICB9XG59XG4iXX0=