"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BucketClient = void 0;
const storage_1 = require("@google-cloud/storage");
const mime_types_1 = __importDefault(require("mime-types"));
const cloud_1 = require("../cloud");
const std_1 = require("../std");
class BucketClient {
    constructor(bucketName, storage, projectId = process.env.GCP_PROJECT_ID ?? "wingsdk-test") {
        this.bucketName = bucketName;
        this.storage = storage ? storage : new storage_1.Storage({ projectId });
        this.bucket = this.storage.bucket(this.bucketName);
    }
    async metadata(key) {
        try {
            const [metadata] = await this.bucket.file(key).getMetadata();
            return {
                contentType: metadata.contentType,
                lastModified: std_1.Datetime.fromIso(metadata.updated),
                size: Number(metadata.size),
            };
        }
        catch (error) {
            throw new Error(`Object does not exist (key=${key}).`);
        }
    }
    async copy(srcKey, dstKey) {
        try {
            const srcFile = this.bucket.file(srcKey);
            await srcFile.copy(this.bucket.file(dstKey));
        }
        catch (error) {
            throw new Error(`Source object does not exist (srcKey=${srcKey}).`);
        }
    }
    /**
     * Move object within the bucket
     *
     * @param srcKey The key of the source object you wish to rename.
     * @param dstKey The key of the destination object after rename.
     * @throws if `srcKey` object doesn't exist or if it matches `dstKey`.
     */
    async rename(srcKey, dstKey) {
        if (srcKey === dstKey) {
            throw new Error(`Renaming an object to its current name is not a valid operation (srcKey=${srcKey}, dstKey=${dstKey}).`);
        }
        await this.copy(srcKey, dstKey);
        await this.delete(srcKey);
    }
    // check if bucket is public or not from bucket metadata
    async isPublic() {
        try {
            const [metadata] = await this.bucket.getMetadata();
            return metadata.iamConfiguration?.publicAccessPrevention === "inherited";
        }
        catch (error) {
            throw new Error(`Failed to check if bucket is public. (bucket=${this.bucketName})`);
        }
    }
    async exists(key) {
        try {
            const [exists] = await this.bucket.file(key).exists();
            return exists;
        }
        catch (err) {
            throw new Error(`Failed to check if object exists. (key=${key})`);
        }
    }
    /**
     * Put object into bucket with given body contents
     *
     * @param key Key of the object
     * @param body string contents of the object
     */
    async put(key, body, opts) {
        const options = {
            contentType: (opts?.contentType ?? mime_types_1.default.lookup(key)) || "application/octet-stream",
        };
        await this.bucket.file(key).save(body, options);
    }
    /**
     * Put Json object into bucket with given body contents
     *
     * @param key Key of the object
     * @param body Json object
     */
    async putJson(key, body) {
        await this.put(key, JSON.stringify(body, null, 2), {
            contentType: "application/json",
        });
    }
    async get(key, options) {
        const body = await this.bucket
            .file(key)
            .download({ start: options?.startByte, end: options?.endByte })
            .catch((e) => {
            throw new Error(`Failed to get object (key=${key}): ${e.stack})}`);
        });
        try {
            return new TextDecoder("utf8", { fatal: true }).decode(body[0]);
        }
        catch (e) {
            throw new Error(`Object content could not be read as text (key=${key}): ${e.stack})}`);
        }
    }
    async tryGet(key, options) {
        try {
            if (await this.exists(key)) {
                return await this.get(key, options);
            }
            return undefined;
        }
        catch (error) {
            throw new Error(`Failed to tryGet object. (key=${key}) ${error.stack}`);
        }
    }
    async getJson(key) {
        try {
            if (!(await this.exists(key))) {
                throw new Error(`Cannot get JSON object that does not exist. (key=${key})`);
            }
            return JSON.parse(await this.get(key));
        }
        catch (error) {
            throw new Error(`Failed to get JSON object. (key=${key})`);
        }
    }
    async tryGetJson(key) {
        try {
            if (await this.exists(key)) {
                return await this.getJson(key);
            }
            return undefined;
        }
        catch (error) {
            throw new Error(`Failed to tryGet JSON object. (key=${key})`);
        }
    }
    async delete(key, opts = {}) {
        const mustExist = opts?.mustExist ?? false;
        if (mustExist && !(await this.exists(key))) {
            throw new Error(`Object does not exist (key=${key}).`);
        }
        try {
            await this.bucket.file(key).delete();
        }
        catch (error) {
            if (!mustExist && error.code === 404) {
                return;
            }
            throw new Error(`Failed to delete object (key=${key}).`);
        }
    }
    async tryDelete(key) {
        if (await this.exists(key)) {
            await this.delete(key);
            return true;
        }
        return false;
    }
    async list(prefix) {
        try {
            const [files] = await this.bucket.getFiles({ prefix });
            return files.map((file) => file.name);
        }
        catch (error) {
            throw new Error(`Failed to list objects. (prefix=${prefix})`);
        }
    }
    async publicUrl(key) {
        if (!(await this.isPublic())) {
            throw new Error("Cannot provide public url for a non-public bucket");
        }
        if (!(await this.exists(key))) {
            throw new Error(`Cannot provide public url for a non-existent key (key=${key})`);
        }
        return `https://storage.googleapis.com/${this.bucketName}/${key}`;
    }
    /**
     * Returns a presigned URL for the specified key in the bucket.
     * @param key The key of the object in the bucket.
     * @param opts The options including the action and the duration for the signed URL.
     * @returns The presigned URL string.
     * @inflight
     */
    async signedUrl(key, opts) {
        const gcsFile = this.bucket.file(key);
        let gcsAction;
        // Set default action to DOWNLOAD if not provided
        const action = opts?.action ?? cloud_1.BucketSignedUrlAction.DOWNLOAD;
        // Set the GCS action
        switch (action) {
            case cloud_1.BucketSignedUrlAction.DOWNLOAD:
                if (!(await this.exists(key))) {
                    throw new Error(`Cannot provide signed url for a non-existent key (key=${key})`);
                }
                gcsAction = "read";
                break;
            case cloud_1.BucketSignedUrlAction.UPLOAD:
                gcsAction = "write";
                break;
            default:
                throw new Error(`Invalid action: ${opts?.action}`);
        }
        // Generate the presigned URL
        const [signedUrl] = await gcsFile.getSignedUrl({
            version: "v4",
            action: gcsAction,
            expires: Date.now() + (opts?.duration?.seconds ?? 900) * 1000,
        });
        return signedUrl;
    }
}
exports.BucketClient = BucketClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmluZmxpZ2h0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NoYXJlZC1nY3AvYnVja2V0LmluZmxpZ2h0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG1EQUF3RDtBQUN4RCw0REFBOEI7QUFDOUIsb0NBU2tCO0FBQ2xCLGdDQUF3QztBQUV4QyxNQUFhLFlBQVk7SUFLdkIsWUFDRSxVQUFrQixFQUNsQixPQUFnQixFQUNoQixZQUFvQixPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxjQUFjO1FBRWhFLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksaUJBQU8sQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVNLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBVztRQUMvQixJQUFJLENBQUM7WUFDSCxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUM3RCxPQUFPO2dCQUNMLFdBQVcsRUFBRSxRQUFRLENBQUMsV0FBVztnQkFDakMsWUFBWSxFQUFFLGNBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztnQkFDaEQsSUFBSSxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO2FBQzVCLENBQUM7UUFDSixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE1BQU0sSUFBSSxLQUFLLENBQUMsOEJBQThCLEdBQUcsSUFBSSxDQUFDLENB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QUFJLEdBQUcsQ0FBQyxHQUFHLElBQUk7U0FDOUQsQ0FBQyxDQUFDO1FBRUgsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQUNGO0FBdFFELG9DQXNRQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0b3JhZ2UsIEJ1Y2tldCB9IGZyb20gXCJAZ29vZ2xlLWNsb3VkL3N0b3JhZ2VcIjtcbmltcG9ydCBtaW1lIGZyb20gXCJtaW1lLXR5cGVzXCI7XG5pbXBvcnQge1xuICBCdWNrZXREZWxldGVPcHRpb25zLFxuICBCdWNrZXRTaWduZWRVcmxPcHRpb25zLFxuICBCdWNrZXRTaWduZWRVcmxBY3Rpb24sXG4gIEJ1Y2tldFB1dE9wdGlvbnMsXG4gIElCdWNrZXRDbGllbnQsXG4gIE9iamVjdE1ldGFkYXRhLFxuICBCdWNrZXRHZXRPcHRpb25zLFxuICBCdWNrZXRUcnlHZXRPcHRpb25zLFxufSBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCB7IERhdGV0aW1lLCBKc29uIH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG5leHBvcnQgY2xhc3MgQnVja2V0Q2xpZW50IGltcGxlbWVudHMgSUJ1Y2tldENsaWVudCB7XG4gIHByaXZhdGUgYnVja2V0TmFtZTogc3RyaW5nO1xuICBwcml2YXRlIHN0b3JhZ2U6IFN0b3JhZ2U7XG4gIHByaXZhdGUgYnVja2V0OiBCdWNrZXQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgYnVja2V0TmFtZTogc3RyaW5nLFxuICAgIHN0b3JhZ2U6IFN0b3JhZ2UsXG4gICAgcHJvamVjdElkOiBzdHJpbmcgPSBwcm9jZXNzLmVudi5HQ1BfUFJPSkVDVF9JRCA/PyBcIndpbmdzZGstdGVzdFwiXG4gICkge1xuICAgIHRoaXMuYnVja2V0TmFtZSA9IGJ1Y2tldE5hbWU7XG4gICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZSA/IHN0b3JhZ2UgOiBuZXcgU3RvcmFnZSh7IHByb2plY3RJZCB9KTtcbiAgICB0aGlzLmJ1Y2tldCA9IHRoaXMuc3RvcmFnZS5idWNrZXQodGhpcy5idWNrZXROYW1lKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBtZXRhZGF0YShrZXk6IHN0cmluZyk6IFByb21pc2U8T2JqZWN0TWV0YWRhdGE+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgW21ldGFkYXRhXSA9IGF3YWl0IHRoaXMuYnVja2V0LmZpbGUoa2V5KS5nZXRNZXRhZGF0YSgpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgY29udGVudFR5cGU6IG1ldGFkYXRhLmNvbnRlbnRUeXBlLFxuICAgICAgICBsYXN0TW9kaWZpZWQ6IERhdGV0aW1lLmZyb21Jc28obWV0YWRhdGEudXBkYXRlZCksXG4gICAgICAgIHNpemU6IE51bWJlcihtZXRhZGF0YS5zaXplKSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgT2JqZWN0IGRvZXMgbm90IGV4aXN0IChrZXk9JHtrZXl9KS5gKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY29weShzcmNLZXk6IHN0cmluZywgZHN0S2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3JjRmlsZSA9IHRoaXMuYnVja2V0LmZpbGUoc3JjS2V5KTtcbiAgICAgIGF3YWl0IHNyY0ZpbGUuY29weSh0aGlzLmJ1Y2tldC5maWxlKGRzdEtleSkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNvdXJjZSBvYmplY3QgZG9lcyBub3QgZXhpc3QgKHNyY0tleT0ke3NyY0tleX0pLmApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNb3ZlIG9iamVjdCB3aXRoaW4gdGhlIGJ1Y2tldFxuICAgKlxuICAgKiBAcGFyYW0gc3JjS2V5IFRoZSBrZXkgb2YgdGhlIHNvdXJjZSBvYmplY3QgeW91IHdpc2ggdG8gcmVuYW1lLlxuICAgKiBAcGFyYW0gZHN0S2V5IFRoZSBrZXkgb2YgdGhlIGRlc3RpbmF0aW9uIG9iamVjdCBhZnRlciByZW5hbWUuXG4gICAqIEB0aHJvd3MgaWYgYHNyY0tleWAgb2JqZWN0IGRvZXNuJ3QgZXhpc3Qgb3IgaWYgaXQgbWF0Y2hlcyBgZHN0S2V5YC5cbiAgICovXG4gIHB1YmxpYyBhc3luYyByZW5hbWUoc3JjS2V5OiBzdHJpbmcsIGRzdEtleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHNyY0tleSA9PT0gZHN0S2V5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBSZW5hbWluZyBhbiBvYmplY3QgdG8gaXRzIGN1cnJlbnQgbmFtZSBpcyBub3QgYSB2YWxpZCBvcGVyYXRpb24gKHNyY0tleT0ke3NyY0tleX0sIGRzdEtleT0ke2RzdEtleX0pLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5jb3B5KHNyY0tleSwgZHN0S2V5KTtcbiAgICBhd2FpdCB0aGlzLmRlbGV0ZShzcmNLZXkpO1xuICB9XG5cbiAgLy8gY2hlY2sgaWYgYnVja2V0IGlzIHB1YmxpYyBvciBub3QgZnJvbSBidWNrZXQgbWV0YWRhdGFcbiAgcHJpdmF0ZSBhc3luYyBpc1B1YmxpYygpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgW21ldGFkYXRhXSA9IGF3YWl0IHRoaXMuYnVja2V0LmdldE1ldGFkYXRhKCk7XG4gICAgICByZXR1cm4gbWV0YWRhdGEuaWFtQ29uZmlndXJhdGlvbj8ucHVibGljQWNjZXNzUHJldmVudGlvbiA9PT0gXCJpbmhlcml0ZWRcIjtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGNoZWNrIGlmIGJ1Y2tldCBpcyBwdWJsaWMuIChidWNrZXQ9JHt0aGlzLmJ1Y2tldE5hbWV9KWBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGV4aXN0cyhrZXk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBbZXhpc3RzXSA9IGF3YWl0IHRoaXMuYnVja2V0LmZpbGUoa2V5KS5leGlzdHMoKTtcbiAgICAgIHJldHVybiBleGlzdHM7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBjaGVjayBpZiBvYmplY3QgZXhpc3RzLiAoa2V5PSR7a2V5fSlgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUHV0IG9iamVjdCBpbnRvIGJ1Y2tldCB3aXRoIGdpdmVuIGJvZHkgY29udGVudHNcbiAgICpcbiAgICogQHBhcmFtIGtleSBLZXkgb2YgdGhlIG9iamVjdFxuICAgKiBAcGFyYW0gYm9keSBzdHJpbmcgY29udGVudHMgb2YgdGhlIG9iamVjdFxuICAgKi9cbiAgcHVibGljIGFzeW5jIHB1dChcbiAgICBrZXk6IHN0cmluZyxcbiAgICBib2R5OiBzdHJpbmcsXG4gICAgb3B0cz86IEJ1Y2tldFB1dE9wdGlvbnNcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGNvbnRlbnRUeXBlOlxuICAgICAgICAob3B0cz8uY29udGVudFR5cGUgPz8gbWltZS5sb29rdXAoa2V5KSkgfHwgXCJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW1cIixcbiAgICB9O1xuICAgIGF3YWl0IHRoaXMuYnVja2V0LmZpbGUoa2V5KS5zYXZlKGJvZHksIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFB1dCBKc29uIG9iamVjdCBpbnRvIGJ1Y2tldCB3aXRoIGdpdmVuIGJvZHkgY29udGVudHNcbiAgICpcbiAgICogQHBhcmFtIGtleSBLZXkgb2YgdGhlIG9iamVjdFxuICAgKiBAcGFyYW0gYm9keSBKc29uIG9iamVjdFxuICAgKi9cbiAgcHVibGljIGFzeW5jIHB1dEpzb24oa2V5OiBzdHJpbmcsIGJvZHk6IEpzb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnB1dChrZXksIEpTT04uc3RyaW5naWZ5KGJvZHksIG51bGwsIDIpLCB7XG4gICAgICBjb250ZW50VHlwZTogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0KGtleTogc3RyaW5nLCBvcHRpb25zPzogQnVja2V0R2V0T3B0aW9ucyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgYm9keSA9IGF3YWl0IHRoaXMuYnVja2V0XG4gICAgICAuZmlsZShrZXkpXG4gICAgICAuZG93bmxvYWQoeyBzdGFydDogb3B0aW9ucz8uc3RhcnRCeXRlLCBlbmQ6IG9wdGlvbnM/LmVuZEJ5dGUgfSlcbiAgICAgIC5jYXRjaCgoZSkgPT4ge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEZhaWxlZCB0byBnZXQgb2JqZWN0IChrZXk9JHtrZXl9KTogJHsoZSBhcyBFcnJvcikuc3RhY2t9KX1gXG4gICAgICAgICk7XG4gICAgICB9KTtcblxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gbmV3IFRleHREZWNvZGVyKFwidXRmOFwiLCB7IGZhdGFsOiB0cnVlIH0pLmRlY29kZShib2R5WzBdKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBPYmplY3QgY29udGVudCBjb3VsZCBub3QgYmUgcmVhZCBhcyB0ZXh0IChrZXk9JHtrZXl9KTogJHtcbiAgICAgICAgICAoZSBhcyBFcnJvcikuc3RhY2tcbiAgICAgICAgfSl9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdHJ5R2V0KFxuICAgIGtleTogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBCdWNrZXRUcnlHZXRPcHRpb25zXG4gICk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChhd2FpdCB0aGlzLmV4aXN0cyhrZXkpKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldChrZXksIG9wdGlvbnMpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIHRyeUdldCBvYmplY3QuIChrZXk9JHtrZXl9KSAkeyhlcnJvciBhcyBFcnJvcikuc3RhY2t9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0SnNvbihrZXk6IHN0cmluZyk6IFByb21pc2U8SnNvbj4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoIShhd2FpdCB0aGlzLmV4aXN0cyhrZXkpKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBnZXQgSlNPTiBvYmplY3QgdGhhdCBkb2VzIG5vdCBleGlzdC4gKGtleT0ke2tleX0pYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIEpTT04ucGFyc2UoYXdhaXQgdGhpcy5nZXQoa2V5KSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGdldCBKU09OIG9iamVjdC4gKGtleT0ke2tleX0pYCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHRyeUdldEpzb24oa2V5OiBzdHJpbmcpOiBQcm9taXNlPEpzb24gfCB1bmRlZmluZWQ+IHtcbiAgICB0cnkge1xuICAgICAgaWYgKGF3YWl0IHRoaXMuZXhpc3RzKGtleSkpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0SnNvbihrZXkpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gdHJ5R2V0IEpTT04gb2JqZWN0LiAoa2V5PSR7a2V5fSlgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlKFxuICAgIGtleTogc3RyaW5nLFxuICAgIG9wdHM6IEJ1Y2tldERlbGV0ZU9wdGlvbnMgPSB7fVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBtdXN0RXhpc3QgPSBvcHRzPy5tdXN0RXhpc3QgPz8gZmFsc2U7XG5cbiAgICBpZiAobXVzdEV4aXN0ICYmICEoYXdhaXQgdGhpcy5leGlzdHMoa2V5KSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgT2JqZWN0IGRvZXMgbm90IGV4aXN0IChrZXk9JHtrZXl9KS5gKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5idWNrZXQuZmlsZShrZXkpLmRlbGV0ZSgpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGlmICghbXVzdEV4aXN0ICYmIGVycm9yLmNvZGUgPT09IDQwNCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBkZWxldGUgb2JqZWN0IChrZXk9JHtrZXl9KS5gKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdHJ5RGVsZXRlKGtleTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKGF3YWl0IHRoaXMuZXhpc3RzKGtleSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlKGtleSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbGlzdChwcmVmaXg/OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IFtmaWxlc10gPSBhd2FpdCB0aGlzLmJ1Y2tldC5nZXRGaWxlcyh7IHByZWZpeCB9KTtcbiAgICAgIHJldHVybiBmaWxlcy5tYXAoKGZpbGUpID0+IGZpbGUubmFtZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGxpc3Qgb2JqZWN0cy4gKHByZWZpeD0ke3ByZWZpeH0pYCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHB1YmxpY1VybChrZXk6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgaWYgKCEoYXdhaXQgdGhpcy5pc1B1YmxpYygpKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IHByb3ZpZGUgcHVibGljIHVybCBmb3IgYSBub24tcHVibGljIGJ1Y2tldFwiKTtcbiAgICB9XG5cbiAgICBpZiAoIShhd2FpdCB0aGlzLmV4aXN0cyhrZXkpKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2Fubm90IHByb3ZpZGUgcHVibGljIHVybCBmb3IgYSBub24tZXhpc3RlbnQga2V5IChrZXk9JHtrZXl9KWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGBodHRwczovL3N0b3JhZ2UuZ29vZ2xlYXBpcy5jb20vJHt0aGlzLmJ1Y2tldE5hbWV9LyR7a2V5fWA7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIHByZXNpZ25lZCBVUkwgZm9yIHRoZSBzcGVjaWZpZWQga2V5IGluIHRoZSBidWNrZXQuXG4gICAqIEBwYXJhbSBrZXkgVGhlIGtleSBvZiB0aGUgb2JqZWN0IGluIHRoZSBidWNrZXQuXG4gICAqIEBwYXJhbSBvcHRzIFRoZSBvcHRpb25zIGluY2x1ZGluZyB0aGUgYWN0aW9uIGFuZCB0aGUgZHVyYXRpb24gZm9yIHRoZSBzaWduZWQgVVJMLlxuICAgKiBAcmV0dXJucyBUaGUgcHJlc2lnbmVkIFVSTCBzdHJpbmcuXG4gICAqIEBpbmZsaWdodFxuICAgKi9cbiAgcHVibGljIGFzeW5jIHNpZ25lZFVybChcbiAgICBrZXk6IHN0cmluZyxcbiAgICBvcHRzOiBCdWNrZXRTaWduZWRVcmxPcHRpb25zXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgZ2NzRmlsZSA9IHRoaXMuYnVja2V0LmZpbGUoa2V5KTtcbiAgICBsZXQgZ2NzQWN0aW9uOiBcInJlYWRcIiB8IFwid3JpdGVcIiB8IFwiZGVsZXRlXCIgfCBcInJlc3VtYWJsZVwiO1xuXG4gICAgLy8gU2V0IGRlZmF1bHQgYWN0aW9uIHRvIERPV05MT0FEIGlmIG5vdCBwcm92aWRlZFxuICAgIGNvbnN0IGFjdGlvbiA9IG9wdHM/LmFjdGlvbiA/PyBCdWNrZXRTaWduZWRVcmxBY3Rpb24uRE9XTkxPQUQ7XG5cbiAgICAvLyBTZXQgdGhlIEdDUyBhY3Rpb25cbiAgICBzd2l0Y2ggKGFjdGlvbikge1xuICAgICAgY2FzZSBCdWNrZXRTaWduZWRVcmxBY3Rpb24uRE9XTkxPQUQ6XG4gICAgICAgIGlmICghKGF3YWl0IHRoaXMuZXhpc3RzKGtleSkpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYENhbm5vdCBwcm92aWRlIHNpZ25lZCB1cmwgZm9yIGEgbm9uLWV4aXN0ZW50IGtleSAoa2V5PSR7a2V5fSlgXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBnY3NBY3Rpb24gPSBcInJlYWRcIjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEJ1Y2tldFNpZ25lZFVybEFjdGlvbi5VUExPQUQ6XG4gICAgICAgIGdjc0FjdGlvbiA9IFwid3JpdGVcIjtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYWN0aW9uOiAke29wdHM/LmFjdGlvbn1gKTtcbiAgICB9XG5cbiAgICAvLyBHZW5lcmF0ZSB0aGUgcHJlc2lnbmVkIFVSTFxuICAgIGNvbnN0IFtzaWduZWRVcmxdID0gYXdhaXQgZ2NzRmlsZS5nZXRTaWduZWRVcmwoe1xuICAgICAgdmVyc2lvbjogXCJ2NFwiLFxuICAgICAgYWN0aW9uOiBnY3NBY3Rpb24sXG4gICAgICBleHBpcmVzOiBEYXRlLm5vdygpICsgKG9wdHM/LmR1cmF0aW9uPy5zZWNvbmRzID8/IDkwMCkgKiAxMDAwLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHNpZ25lZFVybDtcbiAgfVxufVxuIl19