"use strict";
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.preSynthesizeAllConstructs = exports.App = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const constructs_1 = require("constructs");
const errors_1 = require("./errors");
const constants_1 = require("../constants");
const platform_1 = require("../platform");
const node_1 = require("../std/node");
/**
 * A Wing application.
 */
class App extends constructs_1.Construct {
    /**
     * Returns the root app.
     */
    static of(scope) {
        return node_1.Node.of(scope).app;
    }
    constructor(scope, id, props) {
        super(scope, id);
        /** @internal */
        this[_b] = true;
        /**
         * Used in `makeId` to keep track of known IDs
         */
        this._idCounters = {};
        if (!props.entrypointDir) {
            throw new Error("Missing environment variable: WING_SOURCE_DIR");
        }
        // the app is also marked as root in the case where there is no root construct
        if (!props.rootConstruct) {
            node_1.Node._markRoot(this.constructor);
        }
        this.entrypointDir = props.entrypointDir;
        this._newInstanceOverrides = props.newInstanceOverrides ?? [];
        this._synthHooks = props.synthHooks;
        this.isTestEnvironment = props.isTestEnvironment ?? false;
    }
    /**
     * The ".wing" directory, which is where the compiler emits its output. We are taking an implicit
     * assumption here that it is always set to be `$outdir/.wing` which is currently hard coded into
     * the `cli/compile.ts` file.
     */
    get workdir() {
        return `${this.outdir}/.wing`;
    }
    /**
     * The parameter registrar for the app, can be used to find and register
     * parameter values that were provided to the wing application.
     */
    get parameters() {
        if (!this._parameters) {
            this._parameters = new platform_1.ParameterRegistrar(this, "ParameterRegistrar");
        }
        return this._parameters;
    }
    /**
     * Creates a new object of the given FQN.
     * @param fqn the fqn of the class to instantiate
     * @param ctor the constructor of the class to instantiate (undefined for abstract classes)
     * @param scope the scope of the resource
     * @param id the id of the resource
     * @param args the arguments to pass to the resource
     * @returns the new instance
     * @throws if the FQN is not supported
     */
    new(fqn, ctor, scope, id, ...args) {
        // delegate to "tryNew" first, which will allow derived classes to inject
        const instance = this.tryNew(fqn, scope, id, ...args);
        if (instance) {
            return instance;
        }
        // no injection, so we'll just create a new instance
        return new ctor(scope, id, ...args);
    }
    /**
     * Creates a new object of the given abstract class FQN.
     */
    newAbstract(fqn, scope, id, ...args) {
        // next delegate to "tryNew", which will allow derived classes to inject
        const instance = this.tryNew(fqn, scope, id, ...args);
        if (!instance) {
            const typeName = fqn.replace(`${constants_1.SDK_PACKAGE_NAME}.`, "");
            const typeNameParts = typeName.split(".");
            throw new errors_1.NotImplementedError(`Resource "${fqn}" is not yet implemented for "${this._target}" target. Please refer to the roadmap https://github.com/orgs/winglang/projects/3/views/1?filterQuery=${typeName}`, { resource: typeNameParts[typeNameParts.length - 1] });
        }
        return instance;
    }
    makeId(scope, prefix = "") {
        const key = `${scope.node.addr}|${prefix}`;
        this._idCounters[key] = this._idCounters[key] ?? 0;
        return `${prefix}${this._idCounters[key]++}`;
    }
    /**
     * Can be overridden by derived classes to inject dependencies.
     *
     * @param fqn The fully qualified name of the class we want the type for (jsii).
     *
     * @returns The dependency injected specific target type for the given FQN, or undefined if not found.
     */
    typeForFqn(fqn) {
        fqn;
        return undefined;
    }
    /**
     * Can be overridden by derived classes to inject dependencies.
     *
     * @param fqn The fully qualified name of the class to instantiate (jsii).
     * @param scope The construct scope.
     * @param id The construct id.
     * @param args The arguments to pass to the constructor.
     */
    tryNew(fqn, scope, id, ...args) {
        // first check if overrides have been provided
        for (const override of this._newInstanceOverrides) {
            const instance = override(fqn, scope, id, ...args);
            if (instance) {
                return instance;
            }
        }
        const type = this.typeForFqn(fqn);
        if (!type) {
            return undefined;
        }
        return new type(scope, id, ...args);
    }
}
exports.App = App;
_a = JSII_RTTI_SYMBOL_1, _b = node_1.APP_SYMBOL;
App[_a] = { fqn: "@winglang/sdk.core.App", version: "0.0.0" };
function preSynthesizeAllConstructs(app) {
    for (const c of app.node.findAll()) {
        if (typeof c._preSynthesize === "function") {
            c._preSynthesize();
        }
    }
}
exports.preSynthesizeAllConstructs = preSynthesizeAllConstructs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvcmUvYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsMkNBQW1EO0FBQ25ELHFDQUErQztBQUMvQyw0Q0FBZ0Q7QUFDaEQsMENBQWlEO0FBQ2pELHNDQUFxRDtBQXNGckQ7O0dBRUc7QUFDSCxNQUFzQixHQUFJLFNBQVEsc0JBQVM7SUFDekM7O09BRUc7SUFDSSxNQUFNLENBQUMsRUFBRSxDQUFDLEtBQWdCO1FBQy9CLE9BQU8sV0FBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFVLENBQUM7SUFDbkMsQ0FBQztJQTRERCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWU7UUFDdkQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQTNEbkIsZ0JBQWdCO1FBQ0EsUUFBWSxHQUFHLElBQUksQ0FBQztRQWtCcEM7O1dBRUc7UUFDYyxnQkFBVyxHQUEyQixFQUFFLENBQUM7UUFzQ3hELElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDekIsTUFBTSxJQUFJLEtBQUssQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO1FBQ25FLENBQUM7UUFFRCw4RUFBOEU7UUFDOUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUN6QixXQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNuQyxDQUFDO1FBRUQsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxLQUFLLENBQUMsb0JBQW9CLElBQUksRUFBRSxDQUFDO1FBQzlELElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQztRQUNwQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDLGlCQUFpQixJQUFJLEtBQUssQ0FB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QUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNWLE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUM7UUFFRCxPQUFPLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDOztBQTlNSCxrQkErTUM7OEJBdE1rQixpQkFBVTs7QUF3TTdCLFNBQWdCLDBCQUEwQixDQUFDLEdBQVE7SUFDakQsS0FBSyxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7UUFDbkMsSUFBSSxPQUFRLENBQWUsQ0FBQyxjQUFjLEtBQUssVUFBVSxFQUFFLENBQUM7WUFDekQsQ0FBZSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3BDLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQU5ELGdFQU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0LCBJQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IE5vdEltcGxlbWVudGVkRXJyb3IgfSBmcm9tIFwiLi9lcnJvcnNcIjtcbmltcG9ydCB7IFNES19QQUNLQUdFX05BTUUgfSBmcm9tIFwiLi4vY29uc3RhbnRzXCI7XG5pbXBvcnQgeyBQYXJhbWV0ZXJSZWdpc3RyYXIgfSBmcm9tIFwiLi4vcGxhdGZvcm1cIjtcbmltcG9ydCB7IEFQUF9TWU1CT0wsIElBcHAsIE5vZGUgfSBmcm9tIFwiLi4vc3RkL25vZGVcIjtcbmltcG9ydCB7IHR5cGUgSVJlc291cmNlIH0gZnJvbSBcIi4uL3N0ZC9yZXNvdXJjZVwiO1xuaW1wb3J0IHsgVGVzdFJ1bm5lciB9IGZyb20gXCIuLi9zdGQvdGVzdC1ydW5uZXJcIjtcblxuLyoqXG4gKiBQcm9wcyBmb3IgYWxsIGBBcHBgIGNsYXNzZXMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQXBwUHJvcHMge1xuICAvKipcbiAgICogRGlyZWN0b3J5IHdoZXJlIGFydGlmYWN0cyBhcmUgc3ludGhlc2l6ZWQgdG8uXG4gICAqIEBkZWZhdWx0IC0gY3VycmVudCB3b3JraW5nIGRpcmVjdG9yeVxuICAgKi9cbiAgcmVhZG9ubHkgb3V0ZGlyPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgYXBwLlxuICAgKiBAZGVmYXVsdCBcImFwcFwiXG4gICAqL1xuICByZWFkb25seSBuYW1lPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgcm9vdCBjb25zdHJ1Y3QgY2xhc3MgdGhhdCBzaG91bGQgYmUgaW5zdGFudGlhdGVkIHdpdGggYSBzY29wZSBhbmQgaWQuXG4gICAqIElmIHByb3ZpZGVkLCB0aGVuIGl0IHdpbGwgYmUgaW5zdGFudGlhdGVkIG9uIHRoZSB1c2VyJ3MgYmVoYWxmLlxuICAgKiBXaGVuIHRoZSBhcHAgaXMgc3ludGhlc2l6ZWQgd2l0aCBgaXNUZXN0RW52aXJvbm1lbnRgIHNldCB0byBgdHJ1ZWAsIHRoZW5cbiAgICogb25lIGluc3RhbmNlIG9mIHRoZSByb290IGNvbnN0cnVjdCB3aWxsIGJlIGNyZWF0ZWQgcGVyIHRlc3Q7IG90aGVyd2lzZSxcbiAgICogaXQgd2lsbCBiZSBjcmVhdGVkIGV4YWN0bHkgb25jZS5cbiAgICogQGRlZmF1bHQgLSBubyByb290IGNvbnN0cnVjdFxuICAgKi9cbiAgcmVhZG9ubHkgcm9vdENvbnN0cnVjdD86IGFueTtcblxuICAvKipcbiAgICogV2hldGhlciBvciBub3QgdGhpcyBhcHAgaXMgYmVpbmcgc3ludGhlc2l6ZWQgaW50byBhIHRlc3QgZW52aXJvbm1lbnQuXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBpc1Rlc3RFbnZpcm9ubWVudD86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqICBUaGUgYWJzb2x1dGUgZGlyZWN0b3J5IGxvY2F0aW9uIGZvciB0aGUgd2luZyBlbnRyeSBwb2ludCBmaWxlXG4gICAqL1xuICByZWFkb25seSBlbnRyeXBvaW50RGlyOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqICBUaGUgQXBwIHJvb3QgaWRcbiAgICogQGRlZmF1bHQgRGVmYXVsdFxuICAgKi9cbiAgcmVhZG9ubHkgcm9vdElkPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBIb29rcyB0byBiZSBjYWxsZWQgYXQgdmFyaW91cyBzdGFnZXMgb2YgdGhlIHN5bnRoZXNpcyBwcm9jZXNzLlxuICAgKiBAZGVmYXVsdCAtIG5vIGhvb2tzXG4gICAqL1xuICByZWFkb25seSBzeW50aEhvb2tzPzogU3ludGhIb29rcztcblxuICAvKipcbiAgICogSG9va3MgZm9yIG92ZXJyaWRpbmcgbmV3SW5zdGFuY2UgY2FsbHNcbiAgICogQGRlZmF1bHQgLSBbXVxuICAgKi9cbiAgcmVhZG9ubHkgbmV3SW5zdGFuY2VPdmVycmlkZXM/OiBhbnlbXTtcblxuICAvKipcbiAgICogUGFyYW1ldGVyUmVnaXN0cmFyIG9mIGNvbXBvc2VkIHBsYXRmb3Jtc1xuICAgKiBAZGVmYXVsdCAtIHVuZGVmaW5lZFxuICAgKi9cbiAgcmVhZG9ubHkgcGxhdGZvcm1QYXJhbWV0ZXJSZWdpc3RyYXI/OiBQYXJhbWV0ZXJSZWdpc3RyYXI7XG59XG5cbi8qKlxuICogSG9va3MgZm9yIHRoZSBzeW50aGVzaXMgcHJvY2Vzcy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTeW50aEhvb2tzIHtcbiAgLyoqXG4gICAqIEhvb2tzIHRvIGJlIGNhbGxlZCBiZWZvcmUgc3ludGhlc2l6aW5nIHRoZSBhcHAuXG4gICAqL1xuICByZWFkb25seSBwcmVTeW50aGVzaXplPzogYW55W107XG5cbiAgLyoqXG4gICAqIEhvb2tzIHRvIGJlIGNhbGxlZCBhZnRlciBzeW50aGVzaXppbmcgdGhlIGFwcC5cbiAgICovXG4gIHJlYWRvbmx5IHBvc3RTeW50aGVzaXplPzogYW55W107XG5cbiAgLyoqXG4gICAqIEhvb2tzIHRvIGJlIGNhbGxlZCBmb3IgdmFsaWRhdGluZyB0aGUgc3ludGhlc2l6ZWQgY29uZmlndXJhdGlvbi5cbiAgICovXG4gIHJlYWRvbmx5IHZhbGlkYXRlPzogYW55W107XG59XG5cbi8qKlxuICogQSBXaW5nIGFwcGxpY2F0aW9uLlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQXBwIGV4dGVuZHMgQ29uc3RydWN0IGltcGxlbWVudHMgSUFwcCB7XG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSByb290IGFwcC5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgb2Yoc2NvcGU6IENvbnN0cnVjdCk6IEFwcCB7XG4gICAgcmV0dXJuIE5vZGUub2Yoc2NvcGUpLmFwcCBhcyBBcHA7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyByZWFkb25seSBbQVBQX1NZTUJPTF0gPSB0cnVlO1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgY29tcGlsYXRpb24gdGFyZ2V0LlxuICAgKiBAaW50ZXJuYWxcbiAgICovXG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSBfdGFyZ2V0OlxuICAgIHwgXCJzaW1cIlxuICAgIHwgXCJ0Zi1hd3NcIlxuICAgIHwgXCJ0Zi1henVyZVwiXG4gICAgfCBcInRmLWdjcFwiXG4gICAgfCBcImF3c2Nka1wiO1xuXG4gIC8qKlxuICAgKiBXaW5nIHNvdXJjZSBmaWxlcyBkaXJlY3RvcnkgYWJzb2x1dGUgcGF0aFxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGVudHJ5cG9pbnREaXI6IHN0cmluZztcblxuICAvKipcbiAgICogVXNlZCBpbiBgbWFrZUlkYCB0byBrZWVwIHRyYWNrIG9mIGtub3duIElEc1xuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfaWRDb3VudGVyczogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHt9O1xuXG4gIC8qKlxuICAgKiBUaGUgb3V0cHV0IGRpcmVjdG9yeS5cbiAgICovXG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSBvdXRkaXI6IHN0cmluZztcblxuICAvKipcbiAgICogV2hldGhlciBvciBub3QgdGhpcyBhcHAgaXMgYmVpbmcgc3ludGhlc2l6ZWQgaW50byBhIHRlc3QgZW52aXJvbm1lbnQuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgaXNUZXN0RW52aXJvbm1lbnQ6IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIE5ld0luc3RhbmNlIGhvb2tzIGZvciBkZWZpbmluZyByZXNvdXJjZSBpbXBsZW1lbnRhdGlvbnMuXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IF9uZXdJbnN0YW5jZU92ZXJyaWRlczogYW55W107XG5cbiAgLyoqXG4gICAqIFRoZSB0ZXN0IHJ1bm5lciBmb3IgdGhpcyBhcHAuIE9ubHkgY3JlYXRlZCBpZiBgaXNUZXN0RW52aXJvbm1lbnRgIGlzIHRydWUuXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIF90ZXN0UnVubmVyOiBUZXN0UnVubmVyIHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBTeW50aEhvb2tzIGhvb2tzIG9mIGRlcGVuZGVudCBwbGF0Zm9ybXNcbiAgICogQGludGVybmFsXG4gICAqL1xuICBwcm90ZWN0ZWQgX3N5bnRoSG9va3M/OiBTeW50aEhvb2tzO1xuXG4gIC8qKlxuICAgKiBQYXJhbWV0ZXIgcmVnaXN0cmFyIG9mIGNvbXBvc2VkIHBsYXRmb3Jtc1xuICAgKiBAaW50ZXJuYWxcbiAgICovXG4gIHByb3RlY3RlZCBfcGFyYW1ldGVycz86IFBhcmFtZXRlclJlZ2lzdHJhcjtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQXBwUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuICAgIGlmICghcHJvcHMuZW50cnlwb2ludERpcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWlzc2luZyBlbnZpcm9ubWVudCB2YXJpYWJsZTogV0lOR19TT1VSQ0VfRElSXCIpO1xuICAgIH1cblxuICAgIC8vIHRoZSBhcHAgaXMgYWxzbyBtYXJrZWQgYXMgcm9vdCBpbiB0aGUgY2FzZSB3aGVyZSB0aGVyZSBpcyBubyByb290IGNvbnN0cnVjdFxuICAgIGlmICghcHJvcHMucm9vdENvbnN0cnVjdCkge1xuICAgICAgTm9kZS5fbWFya1Jvb3QodGhpcy5jb25zdHJ1Y3Rvcik7XG4gICAgfVxuXG4gICAgdGhpcy5lbnRyeXBvaW50RGlyID0gcHJvcHMuZW50cnlwb2ludERpcjtcbiAgICB0aGlzLl9uZXdJbnN0YW5jZU92ZXJyaWRlcyA9IHByb3BzLm5ld0luc3RhbmNlT3ZlcnJpZGVzID8/IFtdO1xuICAgIHRoaXMuX3N5bnRoSG9va3MgPSBwcm9wcy5zeW50aEhvb2tzO1xuICAgIHRoaXMuaXNUZXN0RW52aXJvbm1lbnQgPSBwcm9wcy5pc1Rlc3RFbnZpcm9ubWVudCA/PyBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgXCIud2luZ1wiIGRpcmVjdG9yeSwgd2hpY2ggaXMgd2hlcmUgdGhlIGNvbXBpbGVyIGVtaXRzIGl0cyBvdXRwdXQuIFdlIGFyZSB0YWtpbmcgYW4gaW1wbGljaXRcbiAgICogYXNzdW1wdGlvbiBoZXJlIHRoYXQgaXQgaXMgYWx3YXlzIHNldCB0byBiZSBgJG91dGRpci8ud2luZ2Agd2hpY2ggaXMgY3VycmVudGx5IGhhcmQgY29kZWQgaW50b1xuICAgKiB0aGUgYGNsaS9jb21waWxlLnRzYCBmaWxlLlxuICAgKi9cbiAgcHVibGljIGdldCB3b3JrZGlyKCkge1xuICAgIHJldHVybiBgJHt0aGlzLm91dGRpcn0vLndpbmdgO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBwYXJhbWV0ZXIgcmVnaXN0cmFyIGZvciB0aGUgYXBwLCBjYW4gYmUgdXNlZCB0byBmaW5kIGFuZCByZWdpc3RlclxuICAgKiBwYXJhbWV0ZXIgdmFsdWVzIHRoYXQgd2VyZSBwcm92aWRlZCB0byB0aGUgd2luZyBhcHBsaWNhdGlvbi5cbiAgICovXG4gIHB1YmxpYyBnZXQgcGFyYW1ldGVycygpIHtcbiAgICBpZiAoIXRoaXMuX3BhcmFtZXRlcnMpIHtcbiAgICAgIHRoaXMuX3BhcmFtZXRlcnMgPSBuZXcgUGFyYW1ldGVyUmVnaXN0cmFyKHRoaXMsIFwiUGFyYW1ldGVyUmVnaXN0cmFyXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fcGFyYW1ldGVycyE7XG4gIH1cblxuICAvKipcbiAgICogU3ludGhlc2l6ZSB0aGUgYXBwIGludG8gYW4gYXJ0aWZhY3QuXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3Qgc3ludGgoKTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgbmV3IG9iamVjdCBvZiB0aGUgZ2l2ZW4gRlFOLlxuICAgKiBAcGFyYW0gZnFuIHRoZSBmcW4gb2YgdGhlIGNsYXNzIHRvIGluc3RhbnRpYXRlXG4gICAqIEBwYXJhbSBjdG9yIHRoZSBjb25zdHJ1Y3RvciBvZiB0aGUgY2xhc3MgdG8gaW5zdGFudGlhdGUgKHVuZGVmaW5lZCBmb3IgYWJzdHJhY3QgY2xhc3NlcylcbiAgICogQHBhcmFtIHNjb3BlIHRoZSBzY29wZSBvZiB0aGUgcmVzb3VyY2VcbiAgICogQHBhcmFtIGlkIHRoZSBpZCBvZiB0aGUgcmVzb3VyY2VcbiAgICogQHBhcmFtIGFyZ3MgdGhlIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSByZXNvdXJjZVxuICAgKiBAcmV0dXJucyB0aGUgbmV3IGluc3RhbmNlXG4gICAqIEB0aHJvd3MgaWYgdGhlIEZRTiBpcyBub3Qgc3VwcG9ydGVkXG4gICAqL1xuICBwdWJsaWMgbmV3KFxuICAgIGZxbjogc3RyaW5nLFxuICAgIGN0b3I6IGFueSxcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgLi4uYXJnczogYW55W11cbiAgKTogYW55IHtcbiAgICAvLyBkZWxlZ2F0ZSB0byBcInRyeU5ld1wiIGZpcnN0LCB3aGljaCB3aWxsIGFsbG93IGRlcml2ZWQgY2xhc3NlcyB0byBpbmplY3RcbiAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMudHJ5TmV3KGZxbiwgc2NvcGUsIGlkLCAuLi5hcmdzKTtcbiAgICBpZiAoaW5zdGFuY2UpIHtcbiAgICAgIHJldHVybiBpbnN0YW5jZTtcbiAgICB9XG5cbiAgICAvLyBubyBpbmplY3Rpb24sIHNvIHdlJ2xsIGp1c3QgY3JlYXRlIGEgbmV3IGluc3RhbmNlXG4gICAgcmV0dXJuIG5ldyBjdG9yKHNjb3BlLCBpZCwgLi4uYXJncyk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhIG5ldyBvYmplY3Qgb2YgdGhlIGdpdmVuIGFic3RyYWN0IGNsYXNzIEZRTi5cbiAgICovXG4gIHB1YmxpYyBuZXdBYnN0cmFjdChcbiAgICBmcW46IHN0cmluZyxcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgLi4uYXJnczogYW55W11cbiAgKTogYW55IHtcbiAgICAvLyBuZXh0IGRlbGVnYXRlIHRvIFwidHJ5TmV3XCIsIHdoaWNoIHdpbGwgYWxsb3cgZGVyaXZlZCBjbGFzc2VzIHRvIGluamVjdFxuICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy50cnlOZXcoZnFuLCBzY29wZSwgaWQsIC4uLmFyZ3MpO1xuICAgIGlmICghaW5zdGFuY2UpIHtcbiAgICAgIGNvbnN0IHR5cGVOYW1lID0gZnFuLnJlcGxhY2UoYCR7U0RLX1BBQ0tBR0VfTkFNRX0uYCwgXCJcIik7XG4gICAgICBjb25zdCB0eXBlTmFtZVBhcnRzID0gdHlwZU5hbWUuc3BsaXQoXCIuXCIpO1xuICAgICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoXG4gICAgICAgIGBSZXNvdXJjZSBcIiR7ZnFufVwiIGlzIG5vdCB5ZXQgaW1wbGVtZW50ZWQgZm9yIFwiJHt0aGlzLl90YXJnZXR9XCIgdGFyZ2V0LiBQbGVhc2UgcmVmZXIgdG8gdGhlIHJvYWRtYXAgaHR0cHM6Ly9naXRodWIuY29tL29yZ3Mvd2luZ2xhbmcvcHJvamVjdHMvMy92aWV3cy8xP2ZpbHRlclF1ZXJ5PSR7dHlwZU5hbWV9YCxcbiAgICAgICAgeyByZXNvdXJjZTogdHlwZU5hbWVQYXJ0c1t0eXBlTmFtZVBhcnRzLmxlbmd0aCAtIDFdIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGluc3RhbmNlO1xuICB9XG5cbiAgcHVibGljIG1ha2VJZChzY29wZTogSUNvbnN0cnVjdCwgcHJlZml4OiBzdHJpbmcgPSBcIlwiKSB7XG4gICAgY29uc3Qga2V5ID0gYCR7c2NvcGUubm9kZS5hZGRyfXwke3ByZWZpeH1gO1xuXG4gICAgdGhpcy5faWRDb3VudGVyc1trZXldID0gdGhpcy5faWRDb3VudGVyc1trZXldID8/IDA7XG5cbiAgICByZXR1cm4gYCR7cHJlZml4fSR7dGhpcy5faWRDb3VudGVyc1trZXldKyt9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYW4gYmUgb3ZlcnJpZGRlbiBieSBkZXJpdmVkIGNsYXNzZXMgdG8gaW5qZWN0IGRlcGVuZGVuY2llcy5cbiAgICpcbiAgICogQHBhcmFtIGZxbiBUaGUgZnVsbHkgcXVhbGlmaWVkIG5hbWUgb2YgdGhlIGNsYXNzIHdlIHdhbnQgdGhlIHR5cGUgZm9yIChqc2lpKS5cbiAgICpcbiAgICogQHJldHVybnMgVGhlIGRlcGVuZGVuY3kgaW5qZWN0ZWQgc3BlY2lmaWMgdGFyZ2V0IHR5cGUgZm9yIHRoZSBnaXZlbiBGUU4sIG9yIHVuZGVmaW5lZCBpZiBub3QgZm91bmQuXG4gICAqL1xuICBwcm90ZWN0ZWQgdHlwZUZvckZxbihmcW46IHN0cmluZyk6IGFueSB7XG4gICAgZnFuO1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICAvKipcbiAgICogQ2FuIGJlIG92ZXJyaWRkZW4gYnkgZGVyaXZlZCBjbGFzc2VzIHRvIGluamVjdCBkZXBlbmRlbmNpZXMuXG4gICAqXG4gICAqIEBwYXJhbSBmcW4gVGhlIGZ1bGx5IHF1YWxpZmllZCBuYW1lIG9mIHRoZSBjbGFzcyB0byBpbnN0YW50aWF0ZSAoanNpaSkuXG4gICAqIEBwYXJhbSBzY29wZSBUaGUgY29uc3RydWN0IHNjb3BlLlxuICAgKiBAcGFyYW0gaWQgVGhlIGNvbnN0cnVjdCBpZC5cbiAgICogQHBhcmFtIGFyZ3MgVGhlIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSBjb25zdHJ1Y3Rvci5cbiAgICovXG4gIHByaXZhdGUgdHJ5TmV3KFxuICAgIGZxbjogc3RyaW5nLFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICAuLi5hcmdzOiBhbnlbXVxuICApOiBhbnkge1xuICAgIC8vIGZpcnN0IGNoZWNrIGlmIG92ZXJyaWRlcyBoYXZlIGJlZW4gcHJvdmlkZWRcbiAgICBmb3IgKGNvbnN0IG92ZXJyaWRlIG9mIHRoaXMuX25ld0luc3RhbmNlT3ZlcnJpZGVzKSB7XG4gICAgICBjb25zdCBpbnN0YW5jZSA9IG92ZXJyaWRlKGZxbiwgc2NvcGUsIGlkLCAuLi5hcmdzKTtcbiAgICAgIGlmIChpbnN0YW5jZSkge1xuICAgICAgICByZXR1cm4gaW5zdGFuY2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgdHlwZSA9IHRoaXMudHlwZUZvckZxbihmcW4pO1xuICAgIGlmICghdHlwZSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IHR5cGUoc2NvcGUsIGlkLCAuLi5hcmdzKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJlU3ludGhlc2l6ZUFsbENvbnN0cnVjdHMoYXBwOiBBcHApOiB2b2lkIHtcbiAgZm9yIChjb25zdCBjIG9mIGFwcC5ub2RlLmZpbmRBbGwoKSkge1xuICAgIGlmICh0eXBlb2YgKGMgYXMgSVJlc291cmNlKS5fcHJlU3ludGhlc2l6ZSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAoYyBhcyBJUmVzb3VyY2UpLl9wcmVTeW50aGVzaXplKCk7XG4gICAgfVxuICB9XG59XG4iXX0=