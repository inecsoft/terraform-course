"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.synthesizeTree = exports.TREE_FILE_PATH = void 0;
const fs = __importStar(require("fs"));
const path = __importStar(require("path"));
const std_1 = require("../std");
const base_1 = require("../ui/base");
const colors_1 = require("../ui/colors");
exports.TREE_FILE_PATH = "tree.json";
/**
 * Symbol for accessing jsii runtime information.
 */
const JSII_RUNTIME_SYMBOL = Symbol.for("jsii.rtti");
function constructInfoFromConstruct(construct) {
    const jsiiRuntimeInfo = Object.getPrototypeOf(construct).constructor[JSII_RUNTIME_SYMBOL];
    if (typeof jsiiRuntimeInfo === "object" &&
        jsiiRuntimeInfo !== null &&
        typeof jsiiRuntimeInfo.fqn === "string" &&
        typeof jsiiRuntimeInfo.version === "string") {
        return { fqn: jsiiRuntimeInfo.fqn, version: jsiiRuntimeInfo.version };
    }
    return undefined;
}
function synthesizeTree(app, outdir) {
    const visit = (construct) => {
        const children = construct.node.children.map((c) => visit(c));
        const childrenMap = children
            .filter((child) => child !== undefined)
            .reduce((map, child) => Object.assign(map, { [child.id]: child }), {});
        const node = {
            id: construct.node.id || "App",
            path: construct.node.path,
            children: Object.keys(childrenMap).length === 0 ? undefined : childrenMap,
            constructInfo: constructInfoFromConstruct(construct),
            display: synthDisplay(construct),
        };
        return node;
    };
    const tree = {
        version: "tree-0.1",
        tree: visit(app.node.root),
    };
    fs.writeFileSync(path.join(outdir, exports.TREE_FILE_PATH), JSON.stringify(tree, undefined, 2), { encoding: "utf8" });
}
exports.synthesizeTree = synthesizeTree;
function synthDisplay(construct) {
    const display = std_1.Node.of(construct);
    const ui = [];
    // generate ui data only based on direct children
    for (const child of construct.node.children) {
        if (base_1.VisualComponent.isVisualComponent(child) &&
            child._newParent === undefined) {
            ui.push(child._toUIComponent());
        }
    }
    if (display.description ||
        display.title ||
        display.hidden ||
        ui ||
        display.color ||
        display.icon ||
        display.expanded) {
        return {
            title: display.title,
            description: display.description,
            hidden: display.hidden,
            sourceModule: display.sourceModule,
            ui: ui.length > 0 ? ui : undefined,
            color: (0, colors_1.isOfTypeColors)(display.color) ? display.color : undefined,
            icon: display.icon,
            expanded: display.expanded,
        };
    }
    return;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb3JlL3RyZWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx1Q0FBeUI7QUFDekIsMkNBQTZCO0FBRzdCLGdDQUE4QjtBQUM5QixxQ0FBNkM7QUFDN0MseUNBQXNEO0FBRXpDLFFBQUEsY0FBYyxHQUFHLFdBQVcsQ0FBQztBQTRKMUM7O0dBRUc7QUFDSCxNQUFNLG1CQUFtQixHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7QUFpQnBELFNBQVMsMEJBQTBCLENBQ2pDLFNBQXFCO0lBRXJCLE1BQU0sZUFBZSxHQUNuQixNQUFNLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQ3BFLElBQ0UsT0FBTyxlQUFlLEtBQUssUUFBUTtRQUNuQyxlQUFlLEtBQUssSUFBSTtRQUN4QixPQUFPLGVBQWUsQ0FBQyxHQUFHLEtBQUssUUFBUTtRQUN2QyxPQUFPLGVBQWUsQ0FBQyxPQUFPLEtBQUssUUFBUSxFQUMzQyxDQUFDO1FBQ0QsT0FBTyxFQUFFLEdBQUcsRUFBRSxlQUFlLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxlQUFlLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDeEUsQ0FBQztJQUNELE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUM7QUFFRCxTQUFnQixjQUFjLENBQUMsR0FBUSxFQUFFLE1BQWM7SUFDckQsTUFBTSxLQUFLLEdBQUcsQ0FBQyxTQUFxQixFQUFxQixFQUFFO1FBQ3pELE1BQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUQsTUFBTSxXQUFXLEdBQUcsUUFBUTthQUN6QixNQUFN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O1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgSUNvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9hcHBcIjtcbmltcG9ydCB7IE5vZGUgfSBmcm9tIFwiLi4vc3RkXCI7XG5pbXBvcnQgeyBWaXN1YWxDb21wb25lbnQgfSBmcm9tIFwiLi4vdWkvYmFzZVwiO1xuaW1wb3J0IHsgQ29sb3JzLCBpc09mVHlwZUNvbG9ycyB9IGZyb20gXCIuLi91aS9jb2xvcnNcIjtcblxuZXhwb3J0IGNvbnN0IFRSRUVfRklMRV9QQVRIID0gXCJ0cmVlLmpzb25cIjtcblxuLyoqXG4gKiBBIG5vZGUgaW4gdGhlIGNvbnN0cnVjdCB0cmVlLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbnN0cnVjdFRyZWVOb2RlIHtcbiAgLyoqXG4gICAqIFRoZSBJRCBvZiB0aGUgbm9kZS4gSXMgcGFydCBvZiB0aGUgYHBhdGhgLlxuICAgKi9cbiAgcmVhZG9ubHkgaWQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHBhdGggb2YgdGhlIG5vZGUuXG4gICAqL1xuICByZWFkb25seSBwYXRoOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBjaGlsZCBub2Rlcy5cbiAgICovXG4gIHJlYWRvbmx5IGNoaWxkcmVuPzogeyBba2V5OiBzdHJpbmddOiBDb25zdHJ1Y3RUcmVlTm9kZSB9O1xuXG4gIC8qKlxuICAgKiBUaGUgbm9kZSBhdHRyaWJ1dGVzLlxuICAgKi9cbiAgcmVhZG9ubHkgYXR0cmlidXRlcz86IHsgW2tleTogc3RyaW5nXTogYW55IH07XG5cbiAgLyoqXG4gICAqIEluZm9ybWF0aW9uIG9uIHRoZSBjb25zdHJ1Y3QgY2xhc3MgdGhhdCBsZWQgdG8gdGhpcyBub2RlLCBpZiBhdmFpbGFibGUuXG4gICAqL1xuICByZWFkb25seSBjb25zdHJ1Y3RJbmZvPzogQ29uc3RydWN0SW5mbztcblxuICAvKipcbiAgICogSW5mb3JtYXRpb24gb24gaG93IHRvIGRpc3BsYXkgdGhpcyBub2RlIGluIHRoZSBVSS5cbiAgICovXG4gIHJlYWRvbmx5IGRpc3BsYXk/OiBEaXNwbGF5SW5mbztcbn1cblxuLyoqXG4gKiBJbmZvcm1hdGlvbiBvbiBob3cgdG8gZGlzcGxheSBhIGNvbnN0cnVjdCBpbiB0aGUgVUkuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRGlzcGxheUluZm8ge1xuICAvKipcbiAgICogVGl0bGUgb2YgdGhlIHJlc291cmNlLlxuICAgKiBAZGVmYXVsdCAtIFRoZSB0eXBlIGFuZC9vciBpZGVudGlmaWVyIG9mIHRoZSByZXNvdXJjZVxuICAgKi9cbiAgcmVhZG9ubHkgdGl0bGU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIERlc2NyaXB0aW9uIG9mIHRoZSByZXNvdXJjZS5cbiAgICogQGRlZmF1bHQgLSBObyBkZXNjcmlwdGlvblxuICAgKi9cbiAgcmVhZG9ubHkgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgdGhlIHJlc291cmNlIHNob3VsZCBiZSBoaWRkZW4gZnJvbSB0aGUgVUkuXG4gICAqIEBkZWZhdWx0IGZhbHNlICh2aXNpYmxlKVxuICAgKi9cbiAgcmVhZG9ubHkgaGlkZGVuPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogVGhlIHNvdXJjZSBmaWxlIG9yIGxpYnJhcnkgd2hlcmUgdGhlIGNvbnN0cnVjdCB3YXMgZGVmaW5lZC5cbiAgICogQGRlZmF1bHQgLSBubyBzb3VyY2UgaW5mb3JtYXRpb25cbiAgICovXG4gIHJlYWRvbmx5IHNvdXJjZU1vZHVsZT86IHN0cmluZztcblxuICAvKipcbiAgICogVUkgY29tcG9uZW50cyB0byBkaXNwbGF5IGZvciB0aGlzIHJlc291cmNlLlxuICAgKiBAZGVmYXVsdCAtIG5vIFVJIGNvbXBvbmVudHNcbiAgICovXG4gIHJlYWRvbmx5IHVpPzogYW55W107IC8vIFVJQ29tcG9uZW50XG5cbiAgLyoqXG4gICAqIFRoZSBjb2xvciBvZiB0aGUgcmVzb3VyY2UgaW4gdGhlIFVJLlxuICAgKi9cbiAgcmVhZG9ubHkgY29sb3I/OiBDb2xvcnM7XG5cbiAgLyoqXG4gICAqIFRoZSBpY29uIG9mIHRoZSByZXNvdXJjZSBpbiB0aGUgVUkuXG4gICAqL1xuICByZWFkb25seSBpY29uPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRoZSBub2RlIGlzIGV4cGFuZGVkIG9yIGNvbGxhcHNlZCBieSBkZWZhdWx0IGluIHRoZSBVSS5cbiAgICogQnkgZGVmYXVsdCwgbm9kZXMgYXJlIGNvbGxhcHNlZC4gU2V0IHRoaXMgdG8gYHRydWVgIGlmIHlvdSB3YW50IHRoZSBub2RlIHRvIGJlIGV4cGFuZGVkIGJ5IGRlZmF1bHQuXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBleHBhbmRlZD86IGJvb2xlYW47XG59XG5cbi8qKiBAaW50ZXJuYWwgKi9cbmV4cG9ydCB0eXBlIFVJQ29tcG9uZW50ID1cbiAgfCBVSUZpZWxkXG4gIHwgVUlTZWN0aW9uXG4gIHwgVUlCdXR0b25cbiAgfCBVSUh0dHBDbGllbnRcbiAgfCBVSUZpbGVCcm93c2VyO1xuXG4vKiogQGludGVybmFsICovXG5leHBvcnQgaW50ZXJmYWNlIFVJRmllbGQge1xuICByZWFkb25seSBraW5kOiBcImZpZWxkXCI7XG4gIHJlYWRvbmx5IGxhYmVsOiBzdHJpbmc7XG4gIC8qKiBUaGUgY29uc3RydWN0IHBhdGggdG8gYSBjbG91ZC5GdW5jdGlvbiAqL1xuICByZWFkb25seSBoYW5kbGVyOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHJlZnJlc2hSYXRlOiBudW1iZXIgfCB1bmRlZmluZWQ7XG4gIHJlYWRvbmx5IGxpbms/OiBib29sZWFuO1xufVxuXG4vKiogQGludGVybmFsICovXG5leHBvcnQgaW50ZXJmYWNlIFVJQnV0dG9uIHtcbiAgcmVhZG9ubHkga2luZDogXCJidXR0b25cIjtcbiAgcmVhZG9ubHkgbGFiZWw6IHN0cmluZztcbiAgLyoqIFRoZSBjb25zdHJ1Y3QgcGF0aCB0byBhIGNsb3VkLkZ1bmN0aW9uICovXG4gIHJlYWRvbmx5IGhhbmRsZXI6IHN0cmluZztcbn1cblxuLyoqIEBpbnRlcm5hbCAqL1xuZXhwb3J0IGludGVyZmFjZSBVSVNlY3Rpb24ge1xuICByZWFkb25seSBraW5kOiBcInNlY3Rpb25cIjtcbiAgcmVhZG9ubHkgbGFiZWw/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGNoaWxkcmVuOiBVSUNvbXBvbmVudFtdO1xufVxuXG4vKiogQGludGVybmFsICovXG5leHBvcnQgaW50ZXJmYWNlIFVJSHR0cENsaWVudCB7XG4gIHJlYWRvbmx5IGtpbmQ6IFwiaHR0cC1jbGllbnRcIjtcbiAgcmVhZG9ubHkgbGFiZWw6IHN0cmluZztcbiAgcmVhZG9ubHkgZ2V0VXJsSGFuZGxlcjogc3RyaW5nO1xuICByZWFkb25seSBnZXRBcGlTcGVjSGFuZGxlcjogc3RyaW5nO1xufVxuXG4vKiogQGludGVybmFsICovXG5leHBvcnQgaW50ZXJmYWNlIFVJRmlsZUJyb3dzZXIge1xuICByZWFkb25seSBraW5kOiBcImZpbGUtYnJvd3NlclwiO1xuICByZWFkb25seSBsYWJlbDogc3RyaW5nO1xuICByZWFkb25seSBwdXRIYW5kbGVyOiBzdHJpbmc7XG4gIHJlYWRvbmx5IGRlbGV0ZUhhbmRsZXI6IHN0cmluZztcbiAgcmVhZG9ubHkgZ2V0SGFuZGxlcjogc3RyaW5nO1xuICByZWFkb25seSBsaXN0SGFuZGxlcjogc3RyaW5nO1xufVxuXG4vKipcbiAqIFRoZSBjb25zdHJ1Y3QgdHJlZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb25zdHJ1Y3RUcmVlIHtcbiAgLyoqXG4gICAqIFRoZSBjb25zdHJ1Y3QgdHJlZSB2ZXJzaW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgdmVyc2lvbjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgcm9vdCBub2RlLlxuICAgKi9cbiAgcmVhZG9ubHkgdHJlZTogQ29uc3RydWN0VHJlZU5vZGU7XG59XG5cbi8qKlxuICogU3ltYm9sIGZvciBhY2Nlc3NpbmcganNpaSBydW50aW1lIGluZm9ybWF0aW9uLlxuICovXG5jb25zdCBKU0lJX1JVTlRJTUVfU1lNQk9MID0gU3ltYm9sLmZvcihcImpzaWkucnR0aVwiKTtcblxuLyoqXG4gKiBTb3VyY2UgaW5mb3JtYXRpb24gb24gYSBjb25zdHJ1Y3QgKGNsYXNzIGZxbiBhbmQgdmVyc2lvbikuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ29uc3RydWN0SW5mbyB7XG4gIC8qKlxuICAgKiBGdWxseSBxdWFsaWZpZWQgY2xhc3MgbmFtZS5cbiAgICovXG4gIHJlYWRvbmx5IGZxbjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBWZXJzaW9uIG9mIHRoZSBtb2R1bGUuXG4gICAqL1xuICByZWFkb25seSB2ZXJzaW9uOiBzdHJpbmc7XG59XG5cbmZ1bmN0aW9uIGNvbnN0cnVjdEluZm9Gcm9tQ29uc3RydWN0KFxuICBjb25zdHJ1Y3Q6IElDb25zdHJ1Y3Rcbik6IENvbnN0cnVjdEluZm8gfCB1bmRlZmluZWQge1xuICBjb25zdCBqc2lpUnVudGltZUluZm8gPVxuICAgIE9iamVjdC5nZXRQcm90b3R5cGVPZihjb25zdHJ1Y3QpLmNvbnN0cnVjdG9yW0pTSUlfUlVOVElNRV9TWU1CT0xdO1xuICBpZiAoXG4gICAgdHlwZW9mIGpzaWlSdW50aW1lSW5mbyA9PT0gXCJvYmplY3RcIiAmJlxuICAgIGpzaWlSdW50aW1lSW5mbyAhPT0gbnVsbCAmJlxuICAgIHR5cGVvZiBqc2lpUnVudGltZUluZm8uZnFuID09PSBcInN0cmluZ1wiICYmXG4gICAgdHlwZW9mIGpzaWlSdW50aW1lSW5mby52ZXJzaW9uID09PSBcInN0cmluZ1wiXG4gICkge1xuICAgIHJldHVybiB7IGZxbjoganNpaVJ1bnRpbWVJbmZvLmZxbiwgdmVyc2lvbjoganNpaVJ1bnRpbWVJbmZvLnZlcnNpb24gfTtcbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3ludGhlc2l6ZVRyZWUoYXBwOiBBcHAsIG91dGRpcjogc3RyaW5nKSB7XG4gIGNvbnN0IHZpc2l0ID0gKGNvbnN0cnVjdDogSUNvbnN0cnVjdCk6IENvbnN0cnVjdFRyZWVOb2RlID0+IHtcbiAgICBjb25zdCBjaGlsZHJlbiA9IGNvbnN0cnVjdC5ub2RlLmNoaWxkcmVuLm1hcCgoYykgPT4gdmlzaXQoYykpO1xuICAgIGNvbnN0IGNoaWxkcmVuTWFwID0gY2hpbGRyZW5cbiAgICAgIC5maWx0ZXIoKGNoaWxkKSA9PiBjaGlsZCAhPT0gdW5kZWZpbmVkKVxuICAgICAgLnJlZHVjZSgobWFwLCBjaGlsZCkgPT4gT2JqZWN0LmFzc2lnbihtYXAsIHsgW2NoaWxkIS5pZF06IGNoaWxkIH0pLCB7fSk7XG5cbiAgICBjb25zdCBub2RlOiBDb25zdHJ1Y3RUcmVlTm9kZSA9IHtcbiAgICAgIGlkOiBjb25zdHJ1Y3Qubm9kZS5pZCB8fCBcIkFwcFwiLFxuICAgICAgcGF0aDogY29uc3RydWN0Lm5vZGUucGF0aCxcbiAgICAgIGNoaWxkcmVuOiBPYmplY3Qua2V5cyhjaGlsZHJlbk1hcCkubGVuZ3RoID09PSAwID8gdW5kZWZpbmVkIDogY2hpbGRyZW5NYXAsXG4gICAgICBjb25zdHJ1Y3RJbmZvOiBjb25zdHJ1Y3RJbmZvRnJvbUNvbnN0cnVjdChjb25zdHJ1Y3QpLFxuICAgICAgZGlzcGxheTogc3ludGhEaXNwbGF5KGNvbnN0cnVjdCksXG4gICAgfTtcblxuICAgIHJldHVybiBub2RlO1xuICB9O1xuXG4gIGNvbnN0IHRyZWU6IENvbnN0cnVjdFRyZWUgPSB7XG4gICAgdmVyc2lvbjogXCJ0cmVlLTAuMVwiLFxuICAgIHRyZWU6IHZpc2l0KGFwcC5ub2RlLnJvb3QpLFxuICB9O1xuXG4gIGZzLndyaXRlRmlsZVN5bmMoXG4gICAgcGF0aC5qb2luKG91dGRpciwgVFJFRV9GSUxFX1BBVEgpLFxuICAgIEpTT04uc3RyaW5naWZ5KHRyZWUsIHVuZGVmaW5lZCwgMiksXG4gICAgeyBlbmNvZGluZzogXCJ1dGY4XCIgfVxuICApO1xufVxuXG5mdW5jdGlvbiBzeW50aERpc3BsYXkoY29uc3RydWN0OiBJQ29uc3RydWN0KTogRGlzcGxheUluZm8gfCB1bmRlZmluZWQge1xuICBjb25zdCBkaXNwbGF5ID0gTm9kZS5vZihjb25zdHJ1Y3QpO1xuXG4gIGNvbnN0IHVpOiBVSUNvbXBvbmVudFtdID0gW107XG4gIC8vIGdlbmVyYXRlIHVpIGRhdGEgb25seSBiYXNlZCBvbiBkaXJlY3QgY2hpbGRyZW5cbiAgZm9yIChjb25zdCBjaGlsZCBvZiBjb25zdHJ1Y3Qubm9kZS5jaGlsZHJlbikge1xuICAgIGlmIChcbiAgICAgIFZpc3VhbENvbXBvbmVudC5pc1Zpc3VhbENvbXBvbmVudChjaGlsZCkgJiZcbiAgICAgIGNoaWxkLl9uZXdQYXJlbnQgPT09IHVuZGVmaW5lZFxuICAgICkge1xuICAgICAgdWkucHVzaChjaGlsZC5fdG9VSUNvbXBvbmVudCgpKTtcbiAgICB9XG4gIH1cblxuICBpZiAoXG4gICAgZGlzcGxheS5kZXNjcmlwdGlvbiB8fFxuICAgIGRpc3BsYXkudGl0bGUgfHxcbiAgICBkaXNwbGF5LmhpZGRlbiB8fFxuICAgIHVpIHx8XG4gICAgZGlzcGxheS5jb2xvciB8fFxuICAgIGRpc3BsYXkuaWNvbiB8fFxuICAgIGRpc3BsYXkuZXhwYW5kZWRcbiAgKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRpdGxlOiBkaXNwbGF5LnRpdGxlLFxuICAgICAgZGVzY3JpcHRpb246IGRpc3BsYXkuZGVzY3JpcHRpb24sXG4gICAgICBoaWRkZW46IGRpc3BsYXkuaGlkZGVuLFxuICAgICAgc291cmNlTW9kdWxlOiBkaXNwbGF5LnNvdXJjZU1vZHVsZSxcbiAgICAgIHVpOiB1aS5sZW5ndGggPiAwID8gdWkgOiB1bmRlZmluZWQsXG4gICAgICBjb2xvcjogaXNPZlR5cGVDb2xvcnMoZGlzcGxheS5jb2xvcikgPyBkaXNwbGF5LmNvbG9yIDogdW5kZWZpbmVkLFxuICAgICAgaWNvbjogZGlzcGxheS5pY29uLFxuICAgICAgZXhwYW5kZWQ6IGRpc3BsYXkuZXhwYW5kZWQsXG4gICAgfTtcbiAgfVxuICByZXR1cm47XG59XG4iXX0=