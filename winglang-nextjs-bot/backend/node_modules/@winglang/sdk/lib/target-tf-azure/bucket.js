"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Bucket = exports.StorageAccountPermissions = void 0;
const app_1 = require("./app");
const function_1 = require("./function");
const storage_blob_1 = require("../.gen/providers/azurerm/storage-blob");
const storage_container_1 = require("../.gen/providers/azurerm/storage-container");
const cloud = __importStar(require("../cloud"));
const core = __importStar(require("../core"));
const errors_1 = require("../core/errors");
const resource_names_1 = require("../shared/resource-names");
/**
 * Bucket names must be between 3 and 63 characters.
 *
 * You can use lowercase alphanumeric characters, dash (-)
 * and two or more consecutive dash characters aren't permitted.
 */
const BUCKET_NAME_OPTS = {
    maxLen: 63,
    case: resource_names_1.CaseConventions.LOWERCASE,
    disallowedRegex: /([^a-z0-9\-]+)|(\-{2,})/g,
};
/**
 * Azure bult-in storage account permissions.
 */
var StorageAccountPermissions;
(function (StorageAccountPermissions) {
    /** Read only permission */
    StorageAccountPermissions["READ"] = "Storage Blob Data Reader";
    /** Read write permission */
    StorageAccountPermissions["READ_WRITE"] = "Storage Blob Data Contributor";
})(StorageAccountPermissions || (exports.StorageAccountPermissions = StorageAccountPermissions = {}));
/**
 * Azure implementation of `cloud.Bucket`.
 *
 * @inflight `@winglang/sdk.cloud.IBucketClient`
 */
class Bucket extends cloud.Bucket {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        this.public = props.public ?? false;
        const app = app_1.App.of(this);
        this.storageAccount = app.storageAccount;
        const storageContainerName = resource_names_1.ResourceNames.generateName(this, BUCKET_NAME_OPTS);
        // name must begin and end with alphanumeric character
        if (storageContainerName.match(/(^\W{1,})|(\W{1,}$)/g)?.length) {
            throw new Error("Bucket names must begin and end with alphanumeric character.");
        }
        this.storageContainer = new storage_container_1.StorageContainer(this, "Bucket", {
            name: storageContainerName,
            storageAccountName: this.storageAccount.name,
            containerAccessType: this.public ? "blob" : "private",
        });
    }
    addObject(key, body) {
        // Blob naming conventions:
        // https://learn.microsoft.com/en-us/rest/api/storageservices/naming-and-referencing-containers--blobs--and-metadata#blob-names
        const blobName = key
            .split("/")
            .map((s) => encodeURIComponent(s))
            .join("/");
        new storage_blob_1.StorageBlob(this, `Blob-${key}`, {
            name: blobName,
            storageAccountName: this.storageAccount.name,
            storageContainerName: this.storageContainer.name,
            type: "Block",
            sourceContent: body,
        });
    }
    /** @internal */
    get _liftMap() {
        // TODO: After fixing the tests we realized that nothing is working-https://github.com/winglang/wing/issues/5123
        return {
        // [cloud.BucketInflightMethods.DELETE]: [],
        // [cloud.BucketInflightMethods.GET]: [],
        // [cloud.BucketInflightMethods.GET_JSON]: [],
        // [cloud.BucketInflightMethods.LIST]: [],
        // [cloud.BucketInflightMethods.PUT]: [],
        // [cloud.BucketInflightMethods.PUT_JSON]: [],
        // [cloud.BucketInflightMethods.EXISTS]: [],
        // [cloud.BucketInflightMethods.TRY_GET]: [],
        // [cloud.BucketInflightMethods.TRY_GET_JSON]: [],
        // [cloud.BucketInflightMethods.TRY_DELETE]: [],
        };
    }
    onLift(host, ops) {
        if (!(host instanceof function_1.Function)) {
            throw new Error("buckets can only be bound by tfazure.Function for now");
        }
        // TODO: investigate customized roles over builtin for finer grained access control: https://github.com/winglang/wing/issues/5598
        if (ops.includes(cloud.BucketInflightMethods.DELETE) ||
            ops.includes(cloud.BucketInflightMethods.TRY_DELETE) ||
            ops.includes(cloud.BucketInflightMethods.PUT) ||
            ops.includes(cloud.BucketInflightMethods.PUT_JSON)) {
            host.addPermission(this.storageAccount, {
                scope: this.storageAccount.id,
                roleDefinitionName: StorageAccountPermissions.READ_WRITE,
            });
        }
        else if (ops.includes(cloud.BucketInflightMethods.GET) ||
            ops.includes(cloud.BucketInflightMethods.LIST) ||
            ops.includes(cloud.BucketInflightMethods.GET_JSON) ||
            ops.includes(cloud.BucketInflightMethods.PUBLIC_URL) ||
            ops.includes(cloud.BucketInflightMethods.TRY_GET) ||
            ops.includes(cloud.BucketInflightMethods.TRY_GET_JSON) ||
            ops.includes(cloud.BucketInflightMethods.EXISTS)) {
            host.addPermission(this.storageAccount, {
                scope: this.storageAccount.id,
                roleDefinitionName: StorageAccountPermissions.READ,
            });
        }
        host.addEnvironment(this.envName(), this.storageContainer.name);
        host.addEnvironment(this.envStorageAccountName(), this.storageAccount.name);
        super.onLift(host, ops);
    }
    /**
     * Run an inflight whenever a file is uploaded to the bucket.
     */
    onCreate(fn, opts) {
        fn;
        opts;
        throw new errors_1.NotImplementedError("onCreate method isn't implemented yet on the current target.", {
            issue: "https://github.com/winglang/wing/issues/1954",
            resource: this.constructor.name,
            operation: cloud.BucketEventType.CREATE,
        });
    }
    /**
     * Run an inflight whenever a file is deleted from the bucket.
     */
    onDelete(fn, opts) {
        fn;
        opts;
        throw new errors_1.NotImplementedError("onDelete method isn't implemented yet on the current target.", {
            issue: "https://github.com/winglang/wing/issues/1954",
            resource: this.constructor.name,
            operation: cloud.BucketEventType.DELETE,
        });
    }
    /**
     * Run an inflight whenever a file is updated in the bucket.
     */
    onUpdate(fn, opts) {
        fn;
        opts;
        throw new errors_1.NotImplementedError("onUpdate method isn't implemented yet on the current target.", {
            issue: "https://github.com/winglang/wing/issues/1954",
            resource: this.constructor.name,
            operation: cloud.BucketEventType.UPDATE,
        });
    }
    /**
     * Run an inflight whenever a file is uploaded, modified, or deleted from the bucket.
     */
    onEvent(fn, opts) {
        fn;
        opts;
        throw new errors_1.NotImplementedError("onEvent method isn't implemented yet on the current target.", {
            issue: "https://github.com/winglang/wing/issues/1954",
            resource: this.constructor.name,
            operation: "onEvent",
        });
    }
    /** @internal */
    _toInflight() {
        return core.InflightClient.for(__dirname.replace("target-tf-azure", "shared-azure"), __filename, "BucketClient", [
            `process.env["${this.envName()}"]`,
            `process.env["${this.envStorageAccountName()}"]`,
        ]);
    }
    envName() {
        return `BUCKET_NAME_${this.storageContainer.node.addr.slice(-8)}`;
    }
    envStorageAccountName() {
        return `STORAGE_ACCOUNT_${this.storageContainer.node.addr.slice(-8)}`;
    }
}
exports.Bucket = Bucket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC10Zi1henVyZS9idWNrZXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSwrQkFBNEI7QUFDNUIseUNBQXNDO0FBRXRDLHlFQUFxRTtBQUNyRSxtRkFBK0U7QUFDL0UsZ0RBQWtDO0FBUWxDLDhDQUFnQztBQUNoQywyQ0FBcUQ7QUFDckQsNkRBSWtDO0FBR2xDOzs7OztHQUtHO0FBQ0gsTUFBTSxnQkFBZ0IsR0FBZ0I7SUFDcEMsTUFBTSxFQUFFLEVBQUU7SUFDVixJQUFJLEVBQUUsZ0NBQWUsQ0FBQyxTQUFTO0lBQy9CLGVBQWUsRUFBRSwwQkFBMEI7Q0FDNUMsQ0FBQztBQUVGOztHQUVHO0FBQ0gsSUFBWSx5QkFLWDtBQUxELFdBQVkseUJBQXlCO0lBQ25DLDJCQUEyQjtJQUMzQiw4REFBaUMsQ0FBQTtJQUNqQyw0QkFBNEI7SUFDNUIseUVBQTRDLENBQUE7QUFDOUMsQ0FBQyxFQUxXLHlCQUF5Qix5Q0FBekIseUJBQXlCLFFBS3BDO0FBRUQ7Ozs7R0FJRztBQUNILE1BQWEsTUFBTyxTQUFRLEtBQUssQ0FBQyxNQUFNO0lBTXRDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBMkIsRUFBRTtRQUNyRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDO1FBRXBDLE1BQU0sR0FBRyxHQUFHLFNBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFRLENBQUM7UUFDaEMsSUFBSSxDQUFDLGNBQWMsR0FBRyxHQUFHLENBQUMsY0FBYyxDQUFDO1FBRXpDLE1BQU0sb0JBQW9CLEdBQUcsOEJBQWEsQ0FBQyxZQUFZLENBQ3JELElBQUksRUFDSixnQkFBZ0IsQ0FDakIsQ0FBQztRQUVGLHNEQUFzRDtRQUN0RCxJQUFJLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDO1lBQy9ELE1BQU0sSUFBSSxLQUFLLENBQ2IsOERBQThELENBQy9ELENBQUM7UUFDSixDQUFDO1FBRUQsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksb0NBQWdCLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRTtZQUMzRCxJQUFJLEVBQUUsb0JBQW9CO1lBQzFCLGtCQUFrQixFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSTtZQUM1QyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFNBQVM7U0FDdEQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLFNBQVMsQ0FBQyxHQUFXLEVBQUUsSUFBWTtRQUN4QywyQkFBMkI7UUFDM0IsK0hBQStIO1FBQy9ILE1BQU0sUUFBUSxHQUFHLEdBQUc7YUFDakIsS0FBSyxDQUFDLEdBQUcsQ0FBQzthQUNWLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDakMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWIsSUFBSSwwQkFBVyxDQUFDLElBQUksRUFBRSxRQUFRLEdBQUcsRUFBRSxFQUFFO1lBQ25DLElBQUksRUFBRSxRQUFRO1lBQ2Qsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJO1lBQzVDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJO1lBQ2hELElBQUksRUFBRSxPQUFPO1lBQ2IsYUFBYSxFQUFFLElBQUk7U0FDcEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGdCQUFnQjtJQUNoQixJQUFXLFFBQVE7UUFDakIsZ0hBQWdIO1FBQ2hILE9BQU87UUFDTCw0Q0FBNEM7UUFDNUMseUNBQXlDO1FBQ3pDLDhDQUE4QztRQUM5QywwQ0FBMEM7UUFDMUMseUNBQXlDO1FBQ3pDLDhDQUE4QztRQUM5Qyw0Q0FBNEM7UUFDNUMsNkNBQTZDO1FBQzdDLGtEQUFrRDtRQUNsRCxnREFBZ0Q7U0FDakQsQ0FBQztJQUNKLENBQUM7SUFFTSxNQUFNLENBQUMsSUFBbUIsRUFBRSxHQUFhO1FBQzlDLElBQUksQ0FBQyxDQUFDLElBQUksWUFBWSxtQkFBUSxDQUFDLEVBQUUsQ0FBQztZQUNoQyxNQUFNLElBQUksS0FBSyxDQUFDLHVEQUF1RCxDQUFDLENBQUM7UUFDM0UsQ0FBQztRQUVELGlJQUFpSTtRQUNqSSxJQUNFLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQztZQUNoRCxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLENBQUM7WUFDcEQsR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDO1lBQzdDLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQyxFQUNsRCxDQUFDO1lBQ0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUN0QyxLQUFLLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFO2dCQUM3QixrQkFBa0IsRUFBRSx5QkFBeUIsQ0FBQyxVQUFVO2FBQ3pELENBQUMsQ0FBQztRQUNMLENBQUM7YUFBTSxJQUNMLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQztZQUM3QyxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUM7WUFDOUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDO1lBQ2xELEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQztZQUNwRCxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUM7WUFDakQsR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsWUFBWSxDQUFDO1lBQ3RELEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQyxFQUNoRCxDQUFDO1lBQ0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUN0QyxLQUFLLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFO2dCQUM3QixrQkFBa0IsRUFBRSx5QkFBeUIsQ0FBQyxJQUFJO2FBQ25ELENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVFLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRDs7T0FFRztJQUNJLFFBQVEsQ0FBQyxFQUF1QixFQUFFLElBQTRCO1FBQ25FLEVBQUUsQ0FBQztRQUNILElBQUksQ0FBQztRQUNMLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsOERBQThELEVBQzlEO1lBQ0UsS0FBSyxFQUFFLDhDQUE4QztZQUNyRCxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJO1lBQy9CLFNBQVMsRUFBRSxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQU07U0FDeEMsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0ksUUFBUSxDQUFDLEVBQXVCLEVBQUUsSUFBNEI7UUFDbkUsRUFBRSxDQUFDO1FBQ0gsSUFBSSxDQUFDO1FBQ0wsTUFBTSxJQUFJLDRCQUFtQixDQUMzQiw4REFBOEQsRUFDOUQ7WUFDRSxLQUFLLEVBQUUsOENBQThDO1lBQ3JELFFBQVEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUk7WUFDL0IsU0FBUyxFQUFFLEtBQUssQ0FBQyxlQUFlLENBQUMsTUFBTTtTQUN4QyxDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSSxRQUFRLENBQUMsRUFBdUIsRUFBRSxJQUE0QjtRQUNuRSxFQUFFLENBQUM7UUFDSCxJQUFJLENBQUM7UUFDTCxNQUFNLElBQUksNEJBQW1CLENBQzNCLDhEQUE4RCxFQUM5RDtZQUNFLEtBQUssRUFBRSw4Q0FBOEM7WUFDckQsUUFBUSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSTtZQUMvQixTQUFTLEVBQUUsS0FBSyxDQUFDLGVBQWUsQ0FBQyxNQUFNO1NBQ3hDLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNJLE9BQU8sQ0FBQyxFQUF1QixFQUFFLElBQTJCO1FBQ2pFLEVBQUUsQ0FBQztRQUNILElBQUksQ0FBQztRQUNMLE1BQU0sSUFBSSw0QkFBbUIsQ0FDM0IsNkRBQTZELEVBQzdEO1lBQ0UsS0FBSyxFQUFFLDhDQUE4QztZQUNyRCxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJO1lBQy9CLFNBQVMsRUFBRSxTQUFTO1NBQ3JCLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRCxnQkFBZ0I7SUFDVCxXQUFXO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQzVCLFNBQVMsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsY0FBYyxDQUFDLEVBQ3BELFVBQVUsRUFDVixjQUFjLEVBQ2Q7WUFDRSxnQkFBZ0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJO1lBQ2xDLGdCQUFnQixJQUFJLENBQUMscUJBQXFCLEVBQUUsSUFBSTtTQUNqRCxDQUNGLENBQUM7SUFDSixDQUFDO0lBRU8sT0FBTztRQUNiLE9BQU8sZUFBZSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ3BFLENBQUM7SUFFTyxxQkFBcUI7UUFDM0IsT0FBTyxtQkFBbUIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUN4RSxDQUFDO0NBQ0Y7QUEzTEQsd0JBMkxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL2FwcFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gfSBmcm9tIFwiLi9mdW5jdGlvblwiO1xuaW1wb3J0IHsgU3RvcmFnZUFjY291bnQgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXp1cmVybS9zdG9yYWdlLWFjY291bnRcIjtcbmltcG9ydCB7IFN0b3JhZ2VCbG9iIH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F6dXJlcm0vc3RvcmFnZS1ibG9iXCI7XG5pbXBvcnQgeyBTdG9yYWdlQ29udGFpbmVyIH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F6dXJlcm0vc3RvcmFnZS1jb250YWluZXJcIjtcbmltcG9ydCAqIGFzIGNsb3VkIGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0IHtcbiAgQnVja2V0T25EZWxldGVPcHRpb25zLFxuICBCdWNrZXRPbkV2ZW50T3B0aW9ucyxcbiAgQnVja2V0T25VcGRhdGVPcHRpb25zLFxuICBCdWNrZXRPbkNyZWF0ZU9wdGlvbnMsXG4gIElCdWNrZXRFdmVudEhhbmRsZXIsXG59IGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0ICogYXMgY29yZSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgTm90SW1wbGVtZW50ZWRFcnJvciB9IGZyb20gXCIuLi9jb3JlL2Vycm9yc1wiO1xuaW1wb3J0IHtcbiAgQ2FzZUNvbnZlbnRpb25zLFxuICBOYW1lT3B0aW9ucyxcbiAgUmVzb3VyY2VOYW1lcyxcbn0gZnJvbSBcIi4uL3NoYXJlZC9yZXNvdXJjZS1uYW1lc1wiO1xuaW1wb3J0IHsgSUluZmxpZ2h0SG9zdCB9IGZyb20gXCIuLi9zdGRcIjtcblxuLyoqXG4gKiBCdWNrZXQgbmFtZXMgbXVzdCBiZSBiZXR3ZWVuIDMgYW5kIDYzIGNoYXJhY3RlcnMuXG4gKlxuICogWW91IGNhbiB1c2UgbG93ZXJjYXNlIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzLCBkYXNoICgtKVxuICogYW5kIHR3byBvciBtb3JlIGNvbnNlY3V0aXZlIGRhc2ggY2hhcmFjdGVycyBhcmVuJ3QgcGVybWl0dGVkLlxuICovXG5jb25zdCBCVUNLRVRfTkFNRV9PUFRTOiBOYW1lT3B0aW9ucyA9IHtcbiAgbWF4TGVuOiA2MyxcbiAgY2FzZTogQ2FzZUNvbnZlbnRpb25zLkxPV0VSQ0FTRSxcbiAgZGlzYWxsb3dlZFJlZ2V4OiAvKFteYS16MC05XFwtXSspfChcXC17Mix9KS9nLFxufTtcblxuLyoqXG4gKiBBenVyZSBidWx0LWluIHN0b3JhZ2UgYWNjb3VudCBwZXJtaXNzaW9ucy5cbiAqL1xuZXhwb3J0IGVudW0gU3RvcmFnZUFjY291bnRQZXJtaXNzaW9ucyB7XG4gIC8qKiBSZWFkIG9ubHkgcGVybWlzc2lvbiAqL1xuICBSRUFEID0gXCJTdG9yYWdlIEJsb2IgRGF0YSBSZWFkZXJcIixcbiAgLyoqIFJlYWQgd3JpdGUgcGVybWlzc2lvbiAqL1xuICBSRUFEX1dSSVRFID0gXCJTdG9yYWdlIEJsb2IgRGF0YSBDb250cmlidXRvclwiLFxufVxuXG4vKipcbiAqIEF6dXJlIGltcGxlbWVudGF0aW9uIG9mIGBjbG91ZC5CdWNrZXRgLlxuICpcbiAqIEBpbmZsaWdodCBgQHdpbmdsYW5nL3Nkay5jbG91ZC5JQnVja2V0Q2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgQnVja2V0IGV4dGVuZHMgY2xvdWQuQnVja2V0IHtcbiAgLyoqIFN0b3JhZ2UgY29udGFpbmVyICovXG4gIHB1YmxpYyByZWFkb25seSBzdG9yYWdlQ29udGFpbmVyOiBTdG9yYWdlQ29udGFpbmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IHB1YmxpYzogYm9vbGVhbjtcbiAgcHJpdmF0ZSByZWFkb25seSBzdG9yYWdlQWNjb3VudDogU3RvcmFnZUFjY291bnQ7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IGNsb3VkLkJ1Y2tldFByb3BzID0ge30pIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIHRoaXMucHVibGljID0gcHJvcHMucHVibGljID8/IGZhbHNlO1xuXG4gICAgY29uc3QgYXBwID0gQXBwLm9mKHRoaXMpIGFzIEFwcDtcbiAgICB0aGlzLnN0b3JhZ2VBY2NvdW50ID0gYXBwLnN0b3JhZ2VBY2NvdW50O1xuXG4gICAgY29uc3Qgc3RvcmFnZUNvbnRhaW5lck5hbWUgPSBSZXNvdXJjZU5hbWVzLmdlbmVyYXRlTmFtZShcbiAgICAgIHRoaXMsXG4gICAgICBCVUNLRVRfTkFNRV9PUFRTXG4gICAgKTtcblxuICAgIC8vIG5hbWUgbXVzdCBiZWdpbiBhbmQgZW5kIHdpdGggYWxwaGFudW1lcmljIGNoYXJhY3RlclxuICAgIGlmIChzdG9yYWdlQ29udGFpbmVyTmFtZS5tYXRjaCgvKF5cXFd7MSx9KXwoXFxXezEsfSQpL2cpPy5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJCdWNrZXQgbmFtZXMgbXVzdCBiZWdpbiBhbmQgZW5kIHdpdGggYWxwaGFudW1lcmljIGNoYXJhY3Rlci5cIlxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLnN0b3JhZ2VDb250YWluZXIgPSBuZXcgU3RvcmFnZUNvbnRhaW5lcih0aGlzLCBcIkJ1Y2tldFwiLCB7XG4gICAgICBuYW1lOiBzdG9yYWdlQ29udGFpbmVyTmFtZSxcbiAgICAgIHN0b3JhZ2VBY2NvdW50TmFtZTogdGhpcy5zdG9yYWdlQWNjb3VudC5uYW1lLFxuICAgICAgY29udGFpbmVyQWNjZXNzVHlwZTogdGhpcy5wdWJsaWMgPyBcImJsb2JcIiA6IFwicHJpdmF0ZVwiLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFkZE9iamVjdChrZXk6IHN0cmluZywgYm9keTogc3RyaW5nKTogdm9pZCB7XG4gICAgLy8gQmxvYiBuYW1pbmcgY29udmVudGlvbnM6XG4gICAgLy8gaHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL2VuLXVzL3Jlc3QvYXBpL3N0b3JhZ2VzZXJ2aWNlcy9uYW1pbmctYW5kLXJlZmVyZW5jaW5nLWNvbnRhaW5lcnMtLWJsb2JzLS1hbmQtbWV0YWRhdGEjYmxvYi1uYW1lc1xuICAgIGNvbnN0IGJsb2JOYW1lID0ga2V5XG4gICAgICAuc3BsaXQoXCIvXCIpXG4gICAgICAubWFwKChzKSA9PiBlbmNvZGVVUklDb21wb25lbnQocykpXG4gICAgICAuam9pbihcIi9cIik7XG5cbiAgICBuZXcgU3RvcmFnZUJsb2IodGhpcywgYEJsb2ItJHtrZXl9YCwge1xuICAgICAgbmFtZTogYmxvYk5hbWUsXG4gICAgICBzdG9yYWdlQWNjb3VudE5hbWU6IHRoaXMuc3RvcmFnZUFjY291bnQubmFtZSxcbiAgICAgIHN0b3JhZ2VDb250YWluZXJOYW1lOiB0aGlzLnN0b3JhZ2VDb250YWluZXIubmFtZSxcbiAgICAgIHR5cGU6IFwiQmxvY2tcIixcbiAgICAgIHNvdXJjZUNvbnRlbnQ6IGJvZHksXG4gICAgfSk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyBnZXQgX2xpZnRNYXAoKTogY29yZS5MaWZ0TWFwIHtcbiAgICAvLyBUT0RPOiBBZnRlciBmaXhpbmcgdGhlIHRlc3RzIHdlIHJlYWxpemVkIHRoYXQgbm90aGluZyBpcyB3b3JraW5nLWh0dHBzOi8vZ2l0aHViLmNvbS93aW5nbGFuZy93aW5nL2lzc3Vlcy81MTIzXG4gICAgcmV0dXJuIHtcbiAgICAgIC8vIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuREVMRVRFXTogW10sXG4gICAgICAvLyBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkdFVF06IFtdLFxuICAgICAgLy8gW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5HRVRfSlNPTl06IFtdLFxuICAgICAgLy8gW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5MSVNUXTogW10sXG4gICAgICAvLyBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlBVVF06IFtdLFxuICAgICAgLy8gW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5QVVRfSlNPTl06IFtdLFxuICAgICAgLy8gW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5FWElTVFNdOiBbXSxcbiAgICAgIC8vIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0dFVF06IFtdLFxuICAgICAgLy8gW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5UUllfR0VUX0pTT05dOiBbXSxcbiAgICAgIC8vIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0RFTEVURV06IFtdLFxuICAgIH07XG4gIH1cblxuICBwdWJsaWMgb25MaWZ0KGhvc3Q6IElJbmZsaWdodEhvc3QsIG9wczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICBpZiAoIShob3N0IGluc3RhbmNlb2YgRnVuY3Rpb24pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJidWNrZXRzIGNhbiBvbmx5IGJlIGJvdW5kIGJ5IHRmYXp1cmUuRnVuY3Rpb24gZm9yIG5vd1wiKTtcbiAgICB9XG5cbiAgICAvLyBUT0RPOiBpbnZlc3RpZ2F0ZSBjdXN0b21pemVkIHJvbGVzIG92ZXIgYnVpbHRpbiBmb3IgZmluZXIgZ3JhaW5lZCBhY2Nlc3MgY29udHJvbDogaHR0cHM6Ly9naXRodWIuY29tL3dpbmdsYW5nL3dpbmcvaXNzdWVzLzU1OThcbiAgICBpZiAoXG4gICAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkRFTEVURSkgfHxcbiAgICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0RFTEVURSkgfHxcbiAgICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuUFVUKSB8fFxuICAgICAgb3BzLmluY2x1ZGVzKGNsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5QVVRfSlNPTilcbiAgICApIHtcbiAgICAgIGhvc3QuYWRkUGVybWlzc2lvbih0aGlzLnN0b3JhZ2VBY2NvdW50LCB7XG4gICAgICAgIHNjb3BlOiB0aGlzLnN0b3JhZ2VBY2NvdW50LmlkLFxuICAgICAgICByb2xlRGVmaW5pdGlvbk5hbWU6IFN0b3JhZ2VBY2NvdW50UGVybWlzc2lvbnMuUkVBRF9XUklURSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkdFVCkgfHxcbiAgICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuTElTVCkgfHxcbiAgICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuR0VUX0pTT04pIHx8XG4gICAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlBVQkxJQ19VUkwpIHx8XG4gICAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlRSWV9HRVQpIHx8XG4gICAgICBvcHMuaW5jbHVkZXMoY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLlRSWV9HRVRfSlNPTikgfHxcbiAgICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuRVhJU1RTKVxuICAgICkge1xuICAgICAgaG9zdC5hZGRQZXJtaXNzaW9uKHRoaXMuc3RvcmFnZUFjY291bnQsIHtcbiAgICAgICAgc2NvcGU6IHRoaXMuc3RvcmFnZUFjY291bnQuaWQsXG4gICAgICAgIHJvbGVEZWZpbml0aW9uTmFtZTogU3RvcmFnZUFjY291bnRQZXJtaXNzaW9ucy5SRUFELFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaG9zdC5hZGRFbnZpcm9ubWVudCh0aGlzLmVudk5hbWUoKSwgdGhpcy5zdG9yYWdlQ29udGFpbmVyLm5hbWUpO1xuICAgIGhvc3QuYWRkRW52aXJvbm1lbnQodGhpcy5lbnZTdG9yYWdlQWNjb3VudE5hbWUoKSwgdGhpcy5zdG9yYWdlQWNjb3VudC5uYW1lKTtcbiAgICBzdXBlci5vbkxpZnQoaG9zdCwgb3BzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gYW4gaW5mbGlnaHQgd2hlbmV2ZXIgYSBmaWxlIGlzIHVwbG9hZGVkIHRvIHRoZSBidWNrZXQuXG4gICAqL1xuICBwdWJsaWMgb25DcmVhdGUoZm46IElCdWNrZXRFdmVudEhhbmRsZXIsIG9wdHM/OiBCdWNrZXRPbkNyZWF0ZU9wdGlvbnMpOiB2b2lkIHtcbiAgICBmbjtcbiAgICBvcHRzO1xuICAgIHRocm93IG5ldyBOb3RJbXBsZW1lbnRlZEVycm9yKFxuICAgICAgXCJvbkNyZWF0ZSBtZXRob2QgaXNuJ3QgaW1wbGVtZW50ZWQgeWV0IG9uIHRoZSBjdXJyZW50IHRhcmdldC5cIixcbiAgICAgIHtcbiAgICAgICAgaXNzdWU6IFwiaHR0cHM6Ly9naXRodWIuY29tL3dpbmdsYW5nL3dpbmcvaXNzdWVzLzE5NTRcIixcbiAgICAgICAgcmVzb3VyY2U6IHRoaXMuY29uc3RydWN0b3IubmFtZSxcbiAgICAgICAgb3BlcmF0aW9uOiBjbG91ZC5CdWNrZXRFdmVudFR5cGUuQ1JFQVRFLFxuICAgICAgfVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUnVuIGFuIGluZmxpZ2h0IHdoZW5ldmVyIGEgZmlsZSBpcyBkZWxldGVkIGZyb20gdGhlIGJ1Y2tldC5cbiAgICovXG4gIHB1YmxpYyBvbkRlbGV0ZShmbjogSUJ1Y2tldEV2ZW50SGFuZGxlciwgb3B0cz86IEJ1Y2tldE9uRGVsZXRlT3B0aW9ucyk6IHZvaWQge1xuICAgIGZuO1xuICAgIG9wdHM7XG4gICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoXG4gICAgICBcIm9uRGVsZXRlIG1ldGhvZCBpc24ndCBpbXBsZW1lbnRlZCB5ZXQgb24gdGhlIGN1cnJlbnQgdGFyZ2V0LlwiLFxuICAgICAge1xuICAgICAgICBpc3N1ZTogXCJodHRwczovL2dpdGh1Yi5jb20vd2luZ2xhbmcvd2luZy9pc3N1ZXMvMTk1NFwiLFxuICAgICAgICByZXNvdXJjZTogdGhpcy5jb25zdHJ1Y3Rvci5uYW1lLFxuICAgICAgICBvcGVyYXRpb246IGNsb3VkLkJ1Y2tldEV2ZW50VHlwZS5ERUxFVEUsXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gYW4gaW5mbGlnaHQgd2hlbmV2ZXIgYSBmaWxlIGlzIHVwZGF0ZWQgaW4gdGhlIGJ1Y2tldC5cbiAgICovXG4gIHB1YmxpYyBvblVwZGF0ZShmbjogSUJ1Y2tldEV2ZW50SGFuZGxlciwgb3B0cz86IEJ1Y2tldE9uVXBkYXRlT3B0aW9ucyk6IHZvaWQge1xuICAgIGZuO1xuICAgIG9wdHM7XG4gICAgdGhyb3cgbmV3IE5vdEltcGxlbWVudGVkRXJyb3IoXG4gICAgICBcIm9uVXBkYXRlIG1ldGhvZCBpc24ndCBpbXBsZW1lbnRlZCB5ZXQgb24gdGhlIGN1cnJlbnQgdGFyZ2V0LlwiLFxuICAgICAge1xuICAgICAgICBpc3N1ZTogXCJodHRwczovL2dpdGh1Yi5jb20vd2luZ2xhbmcvd2luZy9pc3N1ZXMvMTk1NFwiLFxuICAgICAgICByZXNvdXJjZTogdGhpcy5jb25zdHJ1Y3Rvci5uYW1lLFxuICAgICAgICBvcGVyYXRpb246IGNsb3VkLkJ1Y2tldEV2ZW50VHlwZS5VUERBVEUsXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gYW4gaW5mbGlnaHQgd2hlbmV2ZXIgYSBmaWxlIGlzIHVwbG9hZGVkLCBtb2RpZmllZCwgb3IgZGVsZXRlZCBmcm9tIHRoZSBidWNrZXQuXG4gICAqL1xuICBwdWJsaWMgb25FdmVudChmbjogSUJ1Y2tldEV2ZW50SGFuZGxlciwgb3B0cz86IEJ1Y2tldE9uRXZlbnRPcHRpb25zKTogdm9pZCB7XG4gICAgZm47XG4gICAgb3B0cztcbiAgICB0aHJvdyBuZXcgTm90SW1wbGVtZW50ZWRFcnJvcihcbiAgICAgIFwib25FdmVudCBtZXRob2QgaXNuJ3QgaW1wbGVtZW50ZWQgeWV0IG9uIHRoZSBjdXJyZW50IHRhcmdldC5cIixcbiAgICAgIHtcbiAgICAgICAgaXNzdWU6IFwiaHR0cHM6Ly9naXRodWIuY29tL3dpbmdsYW5nL3dpbmcvaXNzdWVzLzE5NTRcIixcbiAgICAgICAgcmVzb3VyY2U6IHRoaXMuY29uc3RydWN0b3IubmFtZSxcbiAgICAgICAgb3BlcmF0aW9uOiBcIm9uRXZlbnRcIixcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3RvSW5mbGlnaHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY29yZS5JbmZsaWdodENsaWVudC5mb3IoXG4gICAgICBfX2Rpcm5hbWUucmVwbGFjZShcInRhcmdldC10Zi1henVyZVwiLCBcInNoYXJlZC1henVyZVwiKSxcbiAgICAgIF9fZmlsZW5hbWUsXG4gICAgICBcIkJ1Y2tldENsaWVudFwiLFxuICAgICAgW1xuICAgICAgICBgcHJvY2Vzcy5lbnZbXCIke3RoaXMuZW52TmFtZSgpfVwiXWAsXG4gICAgICAgIGBwcm9jZXNzLmVudltcIiR7dGhpcy5lbnZTdG9yYWdlQWNjb3VudE5hbWUoKX1cIl1gLFxuICAgICAgXVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGVudk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYEJVQ0tFVF9OQU1FXyR7dGhpcy5zdG9yYWdlQ29udGFpbmVyLm5vZGUuYWRkci5zbGljZSgtOCl9YDtcbiAgfVxuXG4gIHByaXZhdGUgZW52U3RvcmFnZUFjY291bnROYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBTVE9SQUdFX0FDQ09VTlRfJHt0aGlzLnN0b3JhZ2VDb250YWluZXIubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG59XG4iXX0=