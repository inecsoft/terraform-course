"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Counter = exports.StorageAccountPermissions = void 0;
const app_1 = require("./app");
const function_1 = require("./function");
const storage_table_1 = require("../.gen/providers/azurerm/storage-table");
const cloud = __importStar(require("../cloud"));
const core = __importStar(require("../core"));
const resource_names_1 = require("../shared/resource-names");
/**
 * - Table names must be unique within an account.
 * - Table names may contain only alphanumeric characters.
 * - Table names cannot begin with a numeric character.
 * - Table names are case-insensitive.
 * - Table names must be from 3 to 63 characters long.
 * - Some table names are reserved, including "tables".
 *   Attempting to create a table with a reserved table name returns error code 404 (Bad Request).
 *
 * @see https://learn.microsoft.com/en-us/rest/api/storageservices/understanding-the-table-service-data-model#table-names
 */
const TABLE_NAME_OPTS = {
    maxLen: 63,
    case: resource_names_1.CaseConventions.LOWERCASE,
    disallowedRegex: /(^[^a-z])|([^a-z0-9])/g,
    sep: "x",
};
/**
 * Azure bult-in storage account permissions.
 */
var StorageAccountPermissions;
(function (StorageAccountPermissions) {
    /** Read only permission */
    StorageAccountPermissions["READ"] = "Storage Table Data Reader";
    /** Read write permission */
    StorageAccountPermissions["READ_WRITE"] = "Storage Table Data Contributor";
})(StorageAccountPermissions || (exports.StorageAccountPermissions = StorageAccountPermissions = {}));
/**
 * Azure implementation of `cloud.Counter`.
 *
 * @inflight `@winglang/sdk.cloud.ICounterClient`
 */
class Counter extends cloud.Counter {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        const app = app_1.App.of(this);
        this.storageAccount = app.storageAccount;
        const storageTableName = resource_names_1.ResourceNames.generateName(this, TABLE_NAME_OPTS);
        this.storageTable = new storage_table_1.StorageTable(this, "CounterTable", {
            name: storageTableName,
            storageAccountName: this.storageAccount.name,
        });
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud.CounterInflightMethods.INC]: [],
            [cloud.CounterInflightMethods.DEC]: [],
            [cloud.CounterInflightMethods.SET]: [],
            [cloud.CounterInflightMethods.PEEK]: [],
        };
    }
    onLift(host, ops) {
        if (!(host instanceof function_1.Function)) {
            throw new Error("counters can only be bound by tfazure.Function for now");
        }
        // TODO: investigate customized roles over builtin for finer grained access control: https://github.com/winglang/wing/issues/5598
        if (ops.includes(cloud.CounterInflightMethods.PEEK)) {
            host.addPermission(this.storageAccount, {
                scope: this.storageAccount.id,
                roleDefinitionName: StorageAccountPermissions.READ,
            });
        }
        else if (ops.includes(cloud.CounterInflightMethods.INC) ||
            ops.includes(cloud.CounterInflightMethods.DEC) ||
            ops.includes(cloud.CounterInflightMethods.SET)) {
            host.addPermission(this.storageAccount, {
                scope: this.storageAccount.id,
                roleDefinitionName: StorageAccountPermissions.READ_WRITE,
            });
        }
        host.addEnvironment(this.envAccountKeyVariable(), this.storageAccount.primaryAccessKey);
        host.addEnvironment(this.envStorageAccountName(), this.storageAccount.name);
        host.addEnvironment(this.envStorageTableName(), this.storageTable.name);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core.InflightClient.for(__dirname.replace("target-tf-azure", "shared-azure"), __filename, "CounterClient", [
            `process.env["${this.envStorageAccountName()}"]`,
            `process.env["${this.envStorageTableName()}"]`,
            `"${this.envAccountKeyVariable()}"`,
            `${this.initial}`,
        ]);
    }
    envStorageAccountName() {
        return `STORAGE_ACCOUNT_${this.storageTable.node.addr.slice(-8)}`;
    }
    envAccountKeyVariable() {
        return `STORAGE_ACCOUNT_KEY_${this.storageTable.node.addr.slice(-8)}`;
    }
    envStorageTableName() {
        return `TABLE_NAME_${this.storageTable.node.addr.slice(-8)}`;
    }
}
exports.Counter = Counter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY291bnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90YXJnZXQtdGYtYXp1cmUvY291bnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLCtCQUE0QjtBQUM1Qix5Q0FBc0M7QUFFdEMsMkVBQXVFO0FBRXZFLGdEQUFrQztBQUNsQyw4Q0FBZ0M7QUFDaEMsNkRBSWtDO0FBR2xDOzs7Ozs7Ozs7O0dBVUc7QUFDSCxNQUFNLGVBQWUsR0FBZ0I7SUFDbkMsTUFBTSxFQUFFLEVBQUU7SUFDVixJQUFJLEVBQUUsZ0NBQWUsQ0FBQyxTQUFTO0lBQy9CLGVBQWUsRUFBRSx3QkFBd0I7SUFDekMsR0FBRyxFQUFFLEdBQUc7Q0FDVCxDQUFDO0FBRUY7O0dBRUc7QUFDSCxJQUFZLHlCQUtYO0FBTEQsV0FBWSx5QkFBeUI7SUFDbkMsMkJBQTJCO0lBQzNCLCtEQUFrQyxDQUFBO0lBQ2xDLDRCQUE0QjtJQUM1QiwwRUFBNkMsQ0FBQTtBQUMvQyxDQUFDLEVBTFcseUJBQXlCLHlDQUF6Qix5QkFBeUIsUUFLcEM7QUFFRDs7OztHQUlHO0FBQ0gsTUFBYSxPQUFRLFNBQVEsS0FBSyxDQUFDLE9BQU87SUFJeEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxRQUE0QixFQUFFO1FBQ3RFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXhCLE1BQU0sR0FBRyxHQUFHLFNBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFRLENBQUM7UUFDaEMsSUFBSSxDQUFDLGNBQWMsR0FBRyxHQUFHLENBQUMsY0FBYyxDQUFDO1FBRXpDLE1BQU0sZ0JBQWdCLEdBQUcsOEJBQWEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBRTNFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSw0QkFBWSxDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7WUFDekQsSUFBSSxFQUFFLGdCQUFnQjtZQUN0QixrQkFBa0IsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUk7U0FDN0MsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGdCQUFnQjtJQUNoQixJQUFXLFFBQVE7UUFDakIsT0FBTztZQUNMLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUU7WUFDdEMsQ0FBQyxLQUFLLENBQUMsc0JBQXNCLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRTtZQUN0QyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFO1lBQ3RDLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDeEMsQ0FBQztJQUNKLENBQUM7SUFFTSxNQUFNLENBQUMsSUFBbUIsRUFBRSxHQUFhO1FBQzlDLElBQUksQ0FBQyxDQUFDLElBQUksWUFBWSxtQkFBUSxDQUFDLEVBQUUsQ0FBQztZQUNoQyxNQUFNLElBQUksS0FBSyxDQUFDLHdEQUF3RCxDQUFDLENBQUM7UUFDNUUsQ0FBQztRQUVELGlJQUFpSTtRQUNqSSxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDcEQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUN0QyxLQUFLLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFO2dCQUM3QixrQkFBa0IsRUFBRSx5QkFBeUIsQ0FBQyxJQUFJO2FBQ25ELENBQUMsQ0FBQztRQUNMLENBQUM7YUFBTSxJQUNMLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLEdBQUcsQ0FBQztZQUM5QyxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLENBQUM7WUFDOUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsc0JBQXNCLENBQUMsR0FBRyxDQUFDLEVBQzlDLENBQUM7WUFDRCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7Z0JBQ3RDLEtBQUssRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUU7Z0JBQzdCLGtCQUFrQixFQUFFLHlCQUF5QixDQUFDLFVBQVU7YUFDekQsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksQ0FBQyxjQUFjLENBQ2pCLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxFQUM1QixJQUFJLENBQUMsY0FBYyxDQUFDLGdCQUFnQixDQUNyQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4RSxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsZ0JBQWdCO0lBQ1QsV0FBVztRQUNoQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUM1QixTQUFTLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLGNBQWMsQ0FBQyxFQUNwRCxVQUFVLEVBQ1YsZUFBZSxFQUNmO1lBQ0UsZ0JBQWdCLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxJQUFJO1lBQ2hELGdCQUFnQixJQUFJLENBQUMsbUJBQW1CLEVBQUUsSUFBSTtZQUM5QyxJQUFJLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxHQUFHO1lBQ25DLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRTtTQUNsQixDQUNGLENBQUM7SUFDSixDQUFDO0lBRU8scUJBQXFCO1FBQzNCLE9BQU8sbUJBQW1CLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ3BFLENBQUM7SUFFTyxxQkFBcUI7UUFDM0IsT0FBTyx1QkFBdUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDeEUsQ0FBQztJQUVPLG1CQUFtQjtRQUN6QixPQUFPLGNBQWMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDL0QsQ0FBQztDQUNGO0FBckZELDBCQXFGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9hcHBcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIH0gZnJvbSBcIi4vZnVuY3Rpb25cIjtcbmltcG9ydCB7IFN0b3JhZ2VBY2NvdW50IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F6dXJlcm0vc3RvcmFnZS1hY2NvdW50XCI7XG5pbXBvcnQgeyBTdG9yYWdlVGFibGUgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXp1cmVybS9zdG9yYWdlLXRhYmxlXCI7XG5cbmltcG9ydCAqIGFzIGNsb3VkIGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0ICogYXMgY29yZSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHtcbiAgQ2FzZUNvbnZlbnRpb25zLFxuICBOYW1lT3B0aW9ucyxcbiAgUmVzb3VyY2VOYW1lcyxcbn0gZnJvbSBcIi4uL3NoYXJlZC9yZXNvdXJjZS1uYW1lc1wiO1xuaW1wb3J0IHsgSUluZmxpZ2h0SG9zdCB9IGZyb20gXCIuLi9zdGRcIjtcblxuLyoqXG4gKiAtIFRhYmxlIG5hbWVzIG11c3QgYmUgdW5pcXVlIHdpdGhpbiBhbiBhY2NvdW50LlxuICogLSBUYWJsZSBuYW1lcyBtYXkgY29udGFpbiBvbmx5IGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzLlxuICogLSBUYWJsZSBuYW1lcyBjYW5ub3QgYmVnaW4gd2l0aCBhIG51bWVyaWMgY2hhcmFjdGVyLlxuICogLSBUYWJsZSBuYW1lcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZS5cbiAqIC0gVGFibGUgbmFtZXMgbXVzdCBiZSBmcm9tIDMgdG8gNjMgY2hhcmFjdGVycyBsb25nLlxuICogLSBTb21lIHRhYmxlIG5hbWVzIGFyZSByZXNlcnZlZCwgaW5jbHVkaW5nIFwidGFibGVzXCIuXG4gKiAgIEF0dGVtcHRpbmcgdG8gY3JlYXRlIGEgdGFibGUgd2l0aCBhIHJlc2VydmVkIHRhYmxlIG5hbWUgcmV0dXJucyBlcnJvciBjb2RlIDQwNCAoQmFkIFJlcXVlc3QpLlxuICpcbiAqIEBzZWUgaHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL2VuLXVzL3Jlc3QvYXBpL3N0b3JhZ2VzZXJ2aWNlcy91bmRlcnN0YW5kaW5nLXRoZS10YWJsZS1zZXJ2aWNlLWRhdGEtbW9kZWwjdGFibGUtbmFtZXNcbiAqL1xuY29uc3QgVEFCTEVfTkFNRV9PUFRTOiBOYW1lT3B0aW9ucyA9IHtcbiAgbWF4TGVuOiA2MyxcbiAgY2FzZTogQ2FzZUNvbnZlbnRpb25zLkxPV0VSQ0FTRSxcbiAgZGlzYWxsb3dlZFJlZ2V4OiAvKF5bXmEtel0pfChbXmEtejAtOV0pL2csXG4gIHNlcDogXCJ4XCIsXG59O1xuXG4vKipcbiAqIEF6dXJlIGJ1bHQtaW4gc3RvcmFnZSBhY2NvdW50IHBlcm1pc3Npb25zLlxuICovXG5leHBvcnQgZW51bSBTdG9yYWdlQWNjb3VudFBlcm1pc3Npb25zIHtcbiAgLyoqIFJlYWQgb25seSBwZXJtaXNzaW9uICovXG4gIFJFQUQgPSBcIlN0b3JhZ2UgVGFibGUgRGF0YSBSZWFkZXJcIixcbiAgLyoqIFJlYWQgd3JpdGUgcGVybWlzc2lvbiAqL1xuICBSRUFEX1dSSVRFID0gXCJTdG9yYWdlIFRhYmxlIERhdGEgQ29udHJpYnV0b3JcIixcbn1cblxuLyoqXG4gKiBBenVyZSBpbXBsZW1lbnRhdGlvbiBvZiBgY2xvdWQuQ291bnRlcmAuXG4gKlxuICogQGluZmxpZ2h0IGBAd2luZ2xhbmcvc2RrLmNsb3VkLklDb3VudGVyQ2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgQ291bnRlciBleHRlbmRzIGNsb3VkLkNvdW50ZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IHN0b3JhZ2VBY2NvdW50OiBTdG9yYWdlQWNjb3VudDtcbiAgcHVibGljIHJlYWRvbmx5IHN0b3JhZ2VUYWJsZTogU3RvcmFnZVRhYmxlO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBjbG91ZC5Db3VudGVyUHJvcHMgPSB7fSkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgY29uc3QgYXBwID0gQXBwLm9mKHRoaXMpIGFzIEFwcDtcbiAgICB0aGlzLnN0b3JhZ2VBY2NvdW50ID0gYXBwLnN0b3JhZ2VBY2NvdW50O1xuXG4gICAgY29uc3Qgc3RvcmFnZVRhYmxlTmFtZSA9IFJlc291cmNlTmFtZXMuZ2VuZXJhdGVOYW1lKHRoaXMsIFRBQkxFX05BTUVfT1BUUyk7XG5cbiAgICB0aGlzLnN0b3JhZ2VUYWJsZSA9IG5ldyBTdG9yYWdlVGFibGUodGhpcywgXCJDb3VudGVyVGFibGVcIiwge1xuICAgICAgbmFtZTogc3RvcmFnZVRhYmxlTmFtZSxcbiAgICAgIHN0b3JhZ2VBY2NvdW50TmFtZTogdGhpcy5zdG9yYWdlQWNjb3VudC5uYW1lLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgZ2V0IF9saWZ0TWFwKCk6IGNvcmUuTGlmdE1hcCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIFtjbG91ZC5Db3VudGVySW5mbGlnaHRNZXRob2RzLklOQ106IFtdLFxuICAgICAgW2Nsb3VkLkNvdW50ZXJJbmZsaWdodE1ldGhvZHMuREVDXTogW10sXG4gICAgICBbY2xvdWQuQ291bnRlckluZmxpZ2h0TWV0aG9kcy5TRVRdOiBbXSxcbiAgICAgIFtjbG91ZC5Db3VudGVySW5mbGlnaHRNZXRob2RzLlBFRUtdOiBbXSxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIG9uTGlmdChob3N0OiBJSW5mbGlnaHRIb3N0LCBvcHM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgaWYgKCEoaG9zdCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiY291bnRlcnMgY2FuIG9ubHkgYmUgYm91bmQgYnkgdGZhenVyZS5GdW5jdGlvbiBmb3Igbm93XCIpO1xuICAgIH1cblxuICAgIC8vIFRPRE86IGludmVzdGlnYXRlIGN1c3RvbWl6ZWQgcm9sZXMgb3ZlciBidWlsdGluIGZvciBmaW5lciBncmFpbmVkIGFjY2VzcyBjb250cm9sOiBodHRwczovL2dpdGh1Yi5jb20vd2luZ2xhbmcvd2luZy9pc3N1ZXMvNTU5OFxuICAgIGlmIChvcHMuaW5jbHVkZXMoY2xvdWQuQ291bnRlckluZmxpZ2h0TWV0aG9kcy5QRUVLKSkge1xuICAgICAgaG9zdC5hZGRQZXJtaXNzaW9uKHRoaXMuc3RvcmFnZUFjY291bnQsIHtcbiAgICAgICAgc2NvcGU6IHRoaXMuc3RvcmFnZUFjY291bnQuaWQsXG4gICAgICAgIHJvbGVEZWZpbml0aW9uTmFtZTogU3RvcmFnZUFjY291bnRQZXJtaXNzaW9ucy5SRUFELFxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5Db3VudGVySW5mbGlnaHRNZXRob2RzLklOQykgfHxcbiAgICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5Db3VudGVySW5mbGlnaHRNZXRob2RzLkRFQykgfHxcbiAgICAgIG9wcy5pbmNsdWRlcyhjbG91ZC5Db3VudGVySW5mbGlnaHRNZXRob2RzLlNFVClcbiAgICApIHtcbiAgICAgIGhvc3QuYWRkUGVybWlzc2lvbih0aGlzLnN0b3JhZ2VBY2NvdW50LCB7XG4gICAgICAgIHNjb3BlOiB0aGlzLnN0b3JhZ2VBY2NvdW50LmlkLFxuICAgICAgICByb2xlRGVmaW5pdGlvbk5hbWU6IFN0b3JhZ2VBY2NvdW50UGVybWlzc2lvbnMuUkVBRF9XUklURSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGhvc3QuYWRkRW52aXJvbm1lbnQoXG4gICAgICB0aGlzLmVudkFjY291bnRLZXlWYXJpYWJsZSgpLFxuICAgICAgdGhpcy5zdG9yYWdlQWNjb3VudC5wcmltYXJ5QWNjZXNzS2V5XG4gICAgKTtcbiAgICBob3N0LmFkZEVudmlyb25tZW50KHRoaXMuZW52U3RvcmFnZUFjY291bnROYW1lKCksIHRoaXMuc3RvcmFnZUFjY291bnQubmFtZSk7XG4gICAgaG9zdC5hZGRFbnZpcm9ubWVudCh0aGlzLmVudlN0b3JhZ2VUYWJsZU5hbWUoKSwgdGhpcy5zdG9yYWdlVGFibGUubmFtZSk7XG4gICAgc3VwZXIub25MaWZ0KGhvc3QsIG9wcyk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyBfdG9JbmZsaWdodCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBjb3JlLkluZmxpZ2h0Q2xpZW50LmZvcihcbiAgICAgIF9fZGlybmFtZS5yZXBsYWNlKFwidGFyZ2V0LXRmLWF6dXJlXCIsIFwic2hhcmVkLWF6dXJlXCIpLFxuICAgICAgX19maWxlbmFtZSxcbiAgICAgIFwiQ291bnRlckNsaWVudFwiLFxuICAgICAgW1xuICAgICAgICBgcHJvY2Vzcy5lbnZbXCIke3RoaXMuZW52U3RvcmFnZUFjY291bnROYW1lKCl9XCJdYCxcbiAgICAgICAgYHByb2Nlc3MuZW52W1wiJHt0aGlzLmVudlN0b3JhZ2VUYWJsZU5hbWUoKX1cIl1gLFxuICAgICAgICBgXCIke3RoaXMuZW52QWNjb3VudEtleVZhcmlhYmxlKCl9XCJgLFxuICAgICAgICBgJHt0aGlzLmluaXRpYWx9YCxcbiAgICAgIF1cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBlbnZTdG9yYWdlQWNjb3VudE5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFNUT1JBR0VfQUNDT1VOVF8ke3RoaXMuc3RvcmFnZVRhYmxlLm5vZGUuYWRkci5zbGljZSgtOCl9YDtcbiAgfVxuXG4gIHByaXZhdGUgZW52QWNjb3VudEtleVZhcmlhYmxlKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBTVE9SQUdFX0FDQ09VTlRfS0VZXyR7dGhpcy5zdG9yYWdlVGFibGUubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG5cbiAgcHJpdmF0ZSBlbnZTdG9yYWdlVGFibGVOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBUQUJMRV9OQU1FXyR7dGhpcy5zdG9yYWdlVGFibGUubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG59XG4iXX0=