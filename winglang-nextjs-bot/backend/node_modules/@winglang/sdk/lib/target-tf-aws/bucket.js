"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createEncryptedBucket = exports.Bucket = exports.BUCKET_PREFIX_OPTS = void 0;
const app_1 = require("./app");
const topic_1 = require("./topic");
const s3_bucket_1 = require("../.gen/providers/aws/s3-bucket");
const s3_bucket_notification_1 = require("../.gen/providers/aws/s3-bucket-notification");
const s3_bucket_policy_1 = require("../.gen/providers/aws/s3-bucket-policy");
const s3_bucket_public_access_block_1 = require("../.gen/providers/aws/s3-bucket-public-access-block");
const s3_object_1 = require("../.gen/providers/aws/s3-object");
const cloud = __importStar(require("../cloud"));
const core = __importStar(require("../core"));
const resource_names_1 = require("../shared/resource-names");
const shared_aws_1 = require("../shared-aws");
const bucket_1 = require("../shared-aws/bucket");
const permissions_1 = require("../shared-aws/permissions");
const EVENTS = {
    [cloud.BucketEventType.DELETE]: ["s3:ObjectRemoved:*"],
    [cloud.BucketEventType.CREATE]: ["s3:ObjectCreated:Put"],
    [cloud.BucketEventType.UPDATE]: ["s3:ObjectCreated:Post"],
};
/**
 * Bucket prefix provided to Terraform must be between 3 and 37 characters.
 *
 * Bucket names are allowed to contain lowercase alphanumeric characters and
 * dashes (-). We generate names without dots (.) to avoid some partial
 * restrictions on bucket names with dots.
 */
exports.BUCKET_PREFIX_OPTS = {
    maxLen: 37,
    case: resource_names_1.CaseConventions.LOWERCASE,
    disallowedRegex: /([^a-z0-9\-]+)/g,
    // add a dash to the end of the prefix to distinguish between the
    // Wing-generated portion of the name and the suffix generated by Terraform
    suffix: "-",
};
/**
 * AWS implementation of `cloud.Bucket`.
 *
 * @inflight `@winglang/sdk.aws.IAwsBucketClient`
 */
class Bucket extends cloud.Bucket {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        this.notificationTopics = [];
        this.notificationDependencies = [];
        this.public = props.public ?? false;
        this.bucket = createEncryptedBucket(this, this.public);
    }
    addObject(key, body) {
        new s3_object_1.S3Object(this, `S3Object-${key}`, {
            bucket: this.bucket.bucket,
            key,
            content: body,
        });
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud.BucketInflightMethods.DELETE]: [],
            [cloud.BucketInflightMethods.GET]: [],
            [cloud.BucketInflightMethods.GET_JSON]: [],
            [cloud.BucketInflightMethods.LIST]: [],
            [cloud.BucketInflightMethods.PUT]: [],
            [cloud.BucketInflightMethods.PUT_JSON]: [],
            [cloud.BucketInflightMethods.PUBLIC_URL]: [],
            [cloud.BucketInflightMethods.EXISTS]: [],
            [cloud.BucketInflightMethods.TRY_GET]: [],
            [cloud.BucketInflightMethods.TRY_GET_JSON]: [],
            [cloud.BucketInflightMethods.TRY_DELETE]: [],
            [cloud.BucketInflightMethods.SIGNED_URL]: [],
            [cloud.BucketInflightMethods.METADATA]: [],
            [cloud.BucketInflightMethods.COPY]: [],
            [cloud.BucketInflightMethods.RENAME]: [],
        };
    }
    createTopicHandler(eventType, inflight) {
        return bucket_1.BucketEventHandler.toTopicOnMessageHandler(inflight, eventType);
    }
    createTopic(actionType) {
        const handler = super.createTopic(actionType);
        // TODO: remove this constraint by adding generic permission APIs to cloud.Function
        if (!(handler instanceof topic_1.Topic)) {
            throw new Error("Topic only supports creating tfaws.Function right now");
        }
        handler.addPermissionToPublish(this, "s3.amazonaws.com", this.bucket.arn);
        this.notificationTopics.push({
            id: `on-${actionType.toLowerCase()}-notification`,
            events: EVENTS[actionType],
            topicArn: handler.topicArn,
        });
        this.notificationDependencies.push(handler.permissions);
        return handler;
    }
    _preSynthesize() {
        super._preSynthesize();
        if (this.notificationTopics.length) {
            new s3_bucket_notification_1.S3BucketNotification(this, `S3BucketNotification`, {
                bucket: this.bucket.id,
                topic: this.notificationTopics,
                dependsOn: this.notificationDependencies,
            });
        }
    }
    onLift(host, ops) {
        if (!shared_aws_1.AwsInflightHost.isAwsInflightHost(host)) {
            throw new Error("Host is expected to implement `IAwsInfightHost`");
        }
        host.addPolicyStatements(...(0, permissions_1.calculateBucketPermissions)(this.bucket.arn, ops));
        // The bucket name needs to be passed through an environment variable since
        // it may not be resolved until deployment time.
        host.addEnvironment(this.envName(), this.bucket.bucket);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core.InflightClient.for(__dirname.replace("target-tf-aws", "shared-aws"), __filename, "BucketClient", [`process.env["${this.envName()}"]`]);
    }
    envName() {
        return `BUCKET_NAME_${this.node.addr.slice(-8)}`;
    }
    get bucketArn() {
        return this.bucket.arn;
    }
    get bucketName() {
        return this.bucket.bucket;
    }
}
exports.Bucket = Bucket;
function createEncryptedBucket(scope, isPublic, name = "Default") {
    const bucketPrefix = resource_names_1.ResourceNames.generateName(scope, exports.BUCKET_PREFIX_OPTS);
    // names cannot begin with 'xn--'
    if (bucketPrefix.startsWith("xn--")) {
        throw new Error("AWS S3 bucket names cannot begin with 'xn--'.");
    }
    // names must begin with a letter or number
    if (!/^[a-z0-9]/.test(bucketPrefix)) {
        throw new Error("AWS S3 bucket names must begin with a letter or number.");
    }
    // names cannot end with '-s3alias' and must end with a letter or number,
    // but we do not need to handle these cases since we are generating the
    // prefix only
    const isTestEnvironment = app_1.App.of(scope).isTestEnvironment;
    const bucket = new s3_bucket_1.S3Bucket(scope, name, {
        bucketPrefix,
        forceDestroy: !!isTestEnvironment,
    });
    if (isPublic) {
        const publicAccessBlock = new s3_bucket_public_access_block_1.S3BucketPublicAccessBlock(scope, "PublicAccessBlock", {
            bucket: bucket.bucket,
            blockPublicAcls: false,
            blockPublicPolicy: false,
            ignorePublicAcls: false,
            restrictPublicBuckets: false,
        });
        const policy = {
            Version: "2012-10-17",
            Statement: [
                {
                    Effect: "Allow",
                    Principal: "*",
                    Action: ["s3:GetObject"],
                    Resource: [`${bucket.arn}/*`],
                },
            ],
        };
        new s3_bucket_policy_1.S3BucketPolicy(scope, "PublicPolicy", {
            bucket: bucket.bucket,
            policy: JSON.stringify(policy),
            dependsOn: [publicAccessBlock],
        });
    }
    return bucket;
}
exports.createEncryptedBucket = createEncryptedBucket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC10Zi1hd3MvYnVja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsK0JBQTRCO0FBQzVCLG1DQUE0QztBQUM1QywrREFBMkQ7QUFDM0QseUZBR3NEO0FBRXRELDZFQUF3RTtBQUN4RSx1R0FBZ0c7QUFDaEcsK0RBQTJEO0FBQzNELGdEQUFrQztBQUNsQyw4Q0FBZ0M7QUFDaEMsNkRBSWtDO0FBQ2xDLDhDQUFnRDtBQUNoRCxpREFBc0U7QUFDdEUsMkRBQXVFO0FBR3ZFLE1BQU0sTUFBTSxHQUFHO0lBQ2IsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsb0JBQW9CLENBQUM7SUFDdEQsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsc0JBQXNCLENBQUM7SUFDeEQsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsdUJBQXVCLENBQUM7Q0FDMUQsQ0FBQztBQUVGOzs7Ozs7R0FNRztBQUNVLFFBQUEsa0JBQWtCLEdBQWdCO0lBQzdDLE1BQU0sRUFBRSxFQUFFO0lBQ1YsSUFBSSxFQUFFLGdDQUFlLENBQUMsU0FBUztJQUMvQixlQUFlLEVBQUUsaUJBQWlCO0lBQ2xDLGlFQUFpRTtJQUNqRSwyRUFBMkU7SUFDM0UsTUFBTSxFQUFFLEdBQUc7Q0FDWixDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQWEsTUFBTyxTQUFRLEtBQUssQ0FBQyxNQUFNO0lBTXRDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBMkIsRUFBRTtRQUNyRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUpULHVCQUFrQixHQUFnQyxFQUFFLENBQUM7UUFDckQsNkJBQXdCLEdBQTJCLEVBQUUsQ0FBQztRQUtyRSxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDO1FBRXBDLElBQUksQ0FBQyxNQUFNLEdBQUcscUJBQXFCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU0sU0FBUyxDQUFDLEdBQVcsRUFBRSxJQUFZO1FBQ3hDLElBQUksb0JBQVEsQ0FBQyxJQUFJLEVBQUUsWUFBWSxHQUFHLEVBQUUsRUFBRTtZQUNwQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNO1lBQzFCLEdBQUc7WUFDSCxPQUFPLEVBQUUsSUFBSTtTQUNkLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxnQkFBZ0I7SUFDaEIsSUFBVyxRQUFRO1FBQ2pCLE9BQU87WUFDTCxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFO1lBQ3hDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUU7WUFDckMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRTtZQUMxQyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3RDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUU7WUFDckMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRTtZQUMxQyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFO1lBQzVDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUU7WUFDeEMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRTtZQUN6QyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFO1lBQzlDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxFQUFFLEVBQUU7WUFDNUMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsVUFBVSxDQUFDLEVBQUUsRUFBRTtZQUM1QyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFO1lBQzFDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDdEMsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtTQUN6QyxDQUFDO0lBQ0osQ0FBQztJQUVTLGtCQUFrQixDQUMxQixTQUFnQyxFQUNoQyxRQUFtQztRQUVuQyxPQUFPLDJCQUFrQixDQUFDLHVCQUF1QixDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUN6RSxDQUFDO0lBRVMsV0FBVyxDQUFDLFVBQWlDO1FBQ3JELE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFOUMsbUZBQW1GO1FBQ25GLElBQUksQ0FBQyxDQUFDLE9BQU8sWUFBWSxhQUFRLENBQUMsRUFBRSxDQUFDO1lBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsdURBQXVELENBQUMsQ0FBQztRQUMzRSxDQUFDO1FBRUQsT0FBTyxDQUFDLHNCQUFzQixDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUM7WUFDM0IsRUFBRSxFQUFFLE1BQU0sVUFBVSxDQUFDLFdBQVcsRUFBRSxlQUFlO1lBQ2pELE1BQU0sRUFBRSxNQUFNLENBQUMsVUFBVSxDQUFDO1lBQzFCLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtTQUMzQixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUV4RCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRU0sY0FBYztRQUNuQixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDdkIsSUFBSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDbkMsSUFBSSw2Q0FBb0IsQ0FBQyxJQUFJLEVBQUUsc0JBQXNCLEVBQUU7Z0JBQ3JELE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3RCLEtBQUssRUFBRSxJQUFJLENBQUMsa0JBQWtCO2dCQUM5QixTQUFTLEVBQUUsSUFBSSxDQUFDLHdCQUF3QjthQUN6QyxDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQztJQUVNLE1BQU0sQ0FBQyxJQUFtQixFQUFFLEdBQWE7UUFDOUMsSUFBSSxDQUFDLDRCQUFlLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUM3QyxNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUVELElBQUksQ0FBQyxtQkFBbUIsQ0FDdEIsR0FBRyxJQUFBLHdDQUEwQixFQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUNwRCxDQUFDO1FBRUYsMkVBQTJFO1FBQzNFLGdEQUFnRDtRQUNoRCxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hELEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRCxnQkFBZ0I7SUFDVCxXQUFXO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQzVCLFNBQVMsQ0FBQyxPQUFPLENBQUMsZUFBZSxFQUFFLFlBQVksQ0FBQyxFQUNoRCxVQUFVLEVBQ1YsY0FBYyxFQUNkLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQ3JDLENBQUM7SUFDSixDQUFDO0lBRU8sT0FBTztRQUNiLE9BQU8sZUFBZSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ25ELENBQUM7SUFFRCxJQUFXLFNBQVM7UUFDbEIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQztJQUN6QixDQUFDO0lBRUQsSUFBVyxVQUFVO1FBQ25CLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDNUIsQ0FBQztDQUNGO0FBdEhELHdCQXNIQztBQUVELFNBQWdCLHFCQUFxQixDQUNuQyxLQUFnQixFQUNoQixRQUFpQixFQUNqQixPQUFlLFNBQVM7SUFFeEIsTUFBTSxZQUFZLEdBQUcsOEJBQWEsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLDBCQUFrQixDQUFDLENBQUM7SUFFM0UsaUNBQWlDO0lBQ2pDLElBQUksWUFBWSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1FBQ3BDLE1BQU0sSUFBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRUQsMkNBQTJDO0lBQzNDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUM7UUFDcEMsTUFBTSxJQUFJLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFDO0lBQzdFLENBQUM7SUFFRCx5RUFBeUU7SUFDekUsdUVBQXVFO0lBQ3ZFLGNBQWM7SUFFZCxNQUFNLGlCQUFpQixHQUFHLFNBQUcsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsaUJBQWlCLENBQUM7SUFFMUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUU7UUFDdkMsWUFBWTtRQUNaLFlBQVksRUFBRSxDQUFDLENBQUMsaUJBQWlCO0tBQ2xDLENBQUMsQ0FBQztJQUVILElBQUksUUFBUSxFQUFFLENBQUM7UUFDYixNQUFNLGlCQUFpQixHQUFHLElBQUkseURBQXlCLENBQ3JELEtBQUssRUFDTCxtQkFBbUIsRUFDbkI7WUFDRSxNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU07WUFDckIsZUFBZSxFQUFFLEtBQUs7WUFDdEIsaUJBQWlCLEVBQUUsS0FBSztZQUN4QixnQkFBZ0IsRUFBRSxLQUFLO1lBQ3ZCLHFCQUFxQixFQUFFLEtBQUs7U0FDN0IsQ0FDRixDQUFDO1FBQ0YsTUFBTSxNQUFNLEdBQUc7WUFDYixPQUFPLEVBQUUsWUFBWTtZQUNyQixTQUFTLEVBQUU7Z0JBQ1Q7b0JBQ0UsTUFBTSxFQUFFLE9BQU87b0JBQ2YsU0FBUyxFQUFFLEdBQUc7b0JBQ2QsTUFBTSxFQUFFLENBQUMsY0FBYyxDQUFDO29CQUN4QixRQUFRLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQztpQkFDOUI7YUFDRjtTQUNGLENBQUM7UUFDRixJQUFJLGlDQUFjLENBQUMsS0FBSyxFQUFFLGNBQWMsRUFBRTtZQUN4QyxNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU07WUFDckIsTUFBTSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO1lBQzlCLFNBQVMsRUFBRSxDQUFDLGlCQUFpQixDQUFDO1NBQy9CLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDO0FBM0RELHNEQTJEQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElUZXJyYWZvcm1EZXBlbmRhYmxlIH0gZnJvbSBcImNka3RmXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vYXBwXCI7XG5pbXBvcnQgeyBUb3BpYyBhcyBBV1NUb3BpYyB9IGZyb20gXCIuL3RvcGljXCI7XG5pbXBvcnQgeyBTM0J1Y2tldCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvczMtYnVja2V0XCI7XG5pbXBvcnQge1xuICBTM0J1Y2tldE5vdGlmaWNhdGlvbixcbiAgUzNCdWNrZXROb3RpZmljYXRpb25Ub3BpYyxcbn0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9zMy1idWNrZXQtbm90aWZpY2F0aW9uXCI7XG5cbmltcG9ydCB7IFMzQnVja2V0UG9saWN5IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9zMy1idWNrZXQtcG9saWN5XCI7XG5pbXBvcnQgeyBTM0J1Y2tldFB1YmxpY0FjY2Vzc0Jsb2NrIH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9zMy1idWNrZXQtcHVibGljLWFjY2Vzcy1ibG9ja1wiO1xuaW1wb3J0IHsgUzNPYmplY3QgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL3MzLW9iamVjdFwiO1xuaW1wb3J0ICogYXMgY2xvdWQgZnJvbSBcIi4uL2Nsb3VkXCI7XG5pbXBvcnQgKiBhcyBjb3JlIGZyb20gXCIuLi9jb3JlXCI7XG5pbXBvcnQge1xuICBDYXNlQ29udmVudGlvbnMsXG4gIE5hbWVPcHRpb25zLFxuICBSZXNvdXJjZU5hbWVzLFxufSBmcm9tIFwiLi4vc2hhcmVkL3Jlc291cmNlLW5hbWVzXCI7XG5pbXBvcnQgeyBBd3NJbmZsaWdodEhvc3QgfSBmcm9tIFwiLi4vc2hhcmVkLWF3c1wiO1xuaW1wb3J0IHsgQnVja2V0RXZlbnRIYW5kbGVyLCBJQXdzQnVja2V0IH0gZnJvbSBcIi4uL3NoYXJlZC1hd3MvYnVja2V0XCI7XG5pbXBvcnQgeyBjYWxjdWxhdGVCdWNrZXRQZXJtaXNzaW9ucyB9IGZyb20gXCIuLi9zaGFyZWQtYXdzL3Blcm1pc3Npb25zXCI7XG5pbXBvcnQgeyBJSW5mbGlnaHRIb3N0IH0gZnJvbSBcIi4uL3N0ZFwiO1xuXG5jb25zdCBFVkVOVFMgPSB7XG4gIFtjbG91ZC5CdWNrZXRFdmVudFR5cGUuREVMRVRFXTogW1wiczM6T2JqZWN0UmVtb3ZlZDoqXCJdLFxuICBbY2xvdWQuQnVja2V0RXZlbnRUeXBlLkNSRUFURV06IFtcInMzOk9iamVjdENyZWF0ZWQ6UHV0XCJdLFxuICBbY2xvdWQuQnVja2V0RXZlbnRUeXBlLlVQREFURV06IFtcInMzOk9iamVjdENyZWF0ZWQ6UG9zdFwiXSxcbn07XG5cbi8qKlxuICogQnVja2V0IHByZWZpeCBwcm92aWRlZCB0byBUZXJyYWZvcm0gbXVzdCBiZSBiZXR3ZWVuIDMgYW5kIDM3IGNoYXJhY3RlcnMuXG4gKlxuICogQnVja2V0IG5hbWVzIGFyZSBhbGxvd2VkIHRvIGNvbnRhaW4gbG93ZXJjYXNlIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzIGFuZFxuICogZGFzaGVzICgtKS4gV2UgZ2VuZXJhdGUgbmFtZXMgd2l0aG91dCBkb3RzICguKSB0byBhdm9pZCBzb21lIHBhcnRpYWxcbiAqIHJlc3RyaWN0aW9ucyBvbiBidWNrZXQgbmFtZXMgd2l0aCBkb3RzLlxuICovXG5leHBvcnQgY29uc3QgQlVDS0VUX1BSRUZJWF9PUFRTOiBOYW1lT3B0aW9ucyA9IHtcbiAgbWF4TGVuOiAzNyxcbiAgY2FzZTogQ2FzZUNvbnZlbnRpb25zLkxPV0VSQ0FTRSxcbiAgZGlzYWxsb3dlZFJlZ2V4OiAvKFteYS16MC05XFwtXSspL2csXG4gIC8vIGFkZCBhIGRhc2ggdG8gdGhlIGVuZCBvZiB0aGUgcHJlZml4IHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gdGhlXG4gIC8vIFdpbmctZ2VuZXJhdGVkIHBvcnRpb24gb2YgdGhlIG5hbWUgYW5kIHRoZSBzdWZmaXggZ2VuZXJhdGVkIGJ5IFRlcnJhZm9ybVxuICBzdWZmaXg6IFwiLVwiLFxufTtcblxuLyoqXG4gKiBBV1MgaW1wbGVtZW50YXRpb24gb2YgYGNsb3VkLkJ1Y2tldGAuXG4gKlxuICogQGluZmxpZ2h0IGBAd2luZ2xhbmcvc2RrLmF3cy5JQXdzQnVja2V0Q2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgQnVja2V0IGV4dGVuZHMgY2xvdWQuQnVja2V0IGltcGxlbWVudHMgSUF3c0J1Y2tldCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgYnVja2V0OiBTM0J1Y2tldDtcbiAgcHJpdmF0ZSByZWFkb25seSBwdWJsaWM6IGJvb2xlYW47XG4gIHByaXZhdGUgcmVhZG9ubHkgbm90aWZpY2F0aW9uVG9waWNzOiBTM0J1Y2tldE5vdGlmaWNhdGlvblRvcGljW10gPSBbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb25EZXBlbmRlbmNpZXM6IElUZXJyYWZvcm1EZXBlbmRhYmxlW10gPSBbXTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogY2xvdWQuQnVja2V0UHJvcHMgPSB7fSkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgdGhpcy5wdWJsaWMgPSBwcm9wcy5wdWJsaWMgPz8gZmFsc2U7XG5cbiAgICB0aGlzLmJ1Y2tldCA9IGNyZWF0ZUVuY3J5cHRlZEJ1Y2tldCh0aGlzLCB0aGlzLnB1YmxpYyk7XG4gIH1cblxuICBwdWJsaWMgYWRkT2JqZWN0KGtleTogc3RyaW5nLCBib2R5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBuZXcgUzNPYmplY3QodGhpcywgYFMzT2JqZWN0LSR7a2V5fWAsIHtcbiAgICAgIGJ1Y2tldDogdGhpcy5idWNrZXQuYnVja2V0LFxuICAgICAga2V5LFxuICAgICAgY29udGVudDogYm9keSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIGdldCBfbGlmdE1hcCgpOiBjb3JlLkxpZnRNYXAge1xuICAgIHJldHVybiB7XG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkRFTEVURV06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5HRVRdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuR0VUX0pTT05dOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuTElTVF06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5QVVRdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuUFVUX0pTT05dOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuUFVCTElDX1VSTF06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5FWElTVFNdOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0dFVF06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5UUllfR0VUX0pTT05dOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuVFJZX0RFTEVURV06IFtdLFxuICAgICAgW2Nsb3VkLkJ1Y2tldEluZmxpZ2h0TWV0aG9kcy5TSUdORURfVVJMXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLk1FVEFEQVRBXTogW10sXG4gICAgICBbY2xvdWQuQnVja2V0SW5mbGlnaHRNZXRob2RzLkNPUFldOiBbXSxcbiAgICAgIFtjbG91ZC5CdWNrZXRJbmZsaWdodE1ldGhvZHMuUkVOQU1FXTogW10sXG4gICAgfTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjcmVhdGVUb3BpY0hhbmRsZXIoXG4gICAgZXZlbnRUeXBlOiBjbG91ZC5CdWNrZXRFdmVudFR5cGUsXG4gICAgaW5mbGlnaHQ6IGNsb3VkLklCdWNrZXRFdmVudEhhbmRsZXJcbiAgKTogY2xvdWQuSVRvcGljT25NZXNzYWdlSGFuZGxlciB7XG4gICAgcmV0dXJuIEJ1Y2tldEV2ZW50SGFuZGxlci50b1RvcGljT25NZXNzYWdlSGFuZGxlcihpbmZsaWdodCwgZXZlbnRUeXBlKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjcmVhdGVUb3BpYyhhY3Rpb25UeXBlOiBjbG91ZC5CdWNrZXRFdmVudFR5cGUpOiBjbG91ZC5Ub3BpYyB7XG4gICAgY29uc3QgaGFuZGxlciA9IHN1cGVyLmNyZWF0ZVRvcGljKGFjdGlvblR5cGUpO1xuXG4gICAgLy8gVE9ETzogcmVtb3ZlIHRoaXMgY29uc3RyYWludCBieSBhZGRpbmcgZ2VuZXJpYyBwZXJtaXNzaW9uIEFQSXMgdG8gY2xvdWQuRnVuY3Rpb25cbiAgICBpZiAoIShoYW5kbGVyIGluc3RhbmNlb2YgQVdTVG9waWMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUb3BpYyBvbmx5IHN1cHBvcnRzIGNyZWF0aW5nIHRmYXdzLkZ1bmN0aW9uIHJpZ2h0IG5vd1wiKTtcbiAgICB9XG5cbiAgICBoYW5kbGVyLmFkZFBlcm1pc3Npb25Ub1B1Ymxpc2godGhpcywgXCJzMy5hbWF6b25hd3MuY29tXCIsIHRoaXMuYnVja2V0LmFybik7XG5cbiAgICB0aGlzLm5vdGlmaWNhdGlvblRvcGljcy5wdXNoKHtcbiAgICAgIGlkOiBgb24tJHthY3Rpb25UeXBlLnRvTG93ZXJDYXNlKCl9LW5vdGlmaWNhdGlvbmAsXG4gICAgICBldmVudHM6IEVWRU5UU1thY3Rpb25UeXBlXSxcbiAgICAgIHRvcGljQXJuOiBoYW5kbGVyLnRvcGljQXJuLFxuICAgIH0pO1xuXG4gICAgdGhpcy5ub3RpZmljYXRpb25EZXBlbmRlbmNpZXMucHVzaChoYW5kbGVyLnBlcm1pc3Npb25zKTtcblxuICAgIHJldHVybiBoYW5kbGVyO1xuICB9XG5cbiAgcHVibGljIF9wcmVTeW50aGVzaXplKCkge1xuICAgIHN1cGVyLl9wcmVTeW50aGVzaXplKCk7XG4gICAgaWYgKHRoaXMubm90aWZpY2F0aW9uVG9waWNzLmxlbmd0aCkge1xuICAgICAgbmV3IFMzQnVja2V0Tm90aWZpY2F0aW9uKHRoaXMsIGBTM0J1Y2tldE5vdGlmaWNhdGlvbmAsIHtcbiAgICAgICAgYnVja2V0OiB0aGlzLmJ1Y2tldC5pZCxcbiAgICAgICAgdG9waWM6IHRoaXMubm90aWZpY2F0aW9uVG9waWNzLFxuICAgICAgICBkZXBlbmRzT246IHRoaXMubm90aWZpY2F0aW9uRGVwZW5kZW5jaWVzLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIG9uTGlmdChob3N0OiBJSW5mbGlnaHRIb3N0LCBvcHM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgaWYgKCFBd3NJbmZsaWdodEhvc3QuaXNBd3NJbmZsaWdodEhvc3QoaG9zdCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkhvc3QgaXMgZXhwZWN0ZWQgdG8gaW1wbGVtZW50IGBJQXdzSW5maWdodEhvc3RgXCIpO1xuICAgIH1cblxuICAgIGhvc3QuYWRkUG9saWN5U3RhdGVtZW50cyhcbiAgICAgIC4uLmNhbGN1bGF0ZUJ1Y2tldFBlcm1pc3Npb25zKHRoaXMuYnVja2V0LmFybiwgb3BzKVxuICAgICk7XG5cbiAgICAvLyBUaGUgYnVja2V0IG5hbWUgbmVlZHMgdG8gYmUgcGFzc2VkIHRocm91Z2ggYW4gZW52aXJvbm1lbnQgdmFyaWFibGUgc2luY2VcbiAgICAvLyBpdCBtYXkgbm90IGJlIHJlc29sdmVkIHVudGlsIGRlcGxveW1lbnQgdGltZS5cbiAgICBob3N0LmFkZEVudmlyb25tZW50KHRoaXMuZW52TmFtZSgpLCB0aGlzLmJ1Y2tldC5idWNrZXQpO1xuICAgIHN1cGVyLm9uTGlmdChob3N0LCBvcHMpO1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgX3RvSW5mbGlnaHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY29yZS5JbmZsaWdodENsaWVudC5mb3IoXG4gICAgICBfX2Rpcm5hbWUucmVwbGFjZShcInRhcmdldC10Zi1hd3NcIiwgXCJzaGFyZWQtYXdzXCIpLFxuICAgICAgX19maWxlbmFtZSxcbiAgICAgIFwiQnVja2V0Q2xpZW50XCIsXG4gICAgICBbYHByb2Nlc3MuZW52W1wiJHt0aGlzLmVudk5hbWUoKX1cIl1gXVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGVudk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYEJVQ0tFVF9OQU1FXyR7dGhpcy5ub2RlLmFkZHIuc2xpY2UoLTgpfWA7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGJ1Y2tldEFybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmJ1Y2tldC5hcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IGJ1Y2tldE5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5idWNrZXQuYnVja2V0O1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVFbmNyeXB0ZWRCdWNrZXQoXG4gIHNjb3BlOiBDb25zdHJ1Y3QsXG4gIGlzUHVibGljOiBib29sZWFuLFxuICBuYW1lOiBzdHJpbmcgPSBcIkRlZmF1bHRcIlxuKTogUzNCdWNrZXQge1xuICBjb25zdCBidWNrZXRQcmVmaXggPSBSZXNvdXJjZU5hbWVzLmdlbmVyYXRlTmFtZShzY29wZSwgQlVDS0VUX1BSRUZJWF9PUFRTKTtcblxuICAvLyBuYW1lcyBjYW5ub3QgYmVnaW4gd2l0aCAneG4tLSdcbiAgaWYgKGJ1Y2tldFByZWZpeC5zdGFydHNXaXRoKFwieG4tLVwiKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkFXUyBTMyBidWNrZXQgbmFtZXMgY2Fubm90IGJlZ2luIHdpdGggJ3huLS0nLlwiKTtcbiAgfVxuXG4gIC8vIG5hbWVzIG11c3QgYmVnaW4gd2l0aCBhIGxldHRlciBvciBudW1iZXJcbiAgaWYgKCEvXlthLXowLTldLy50ZXN0KGJ1Y2tldFByZWZpeCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJBV1MgUzMgYnVja2V0IG5hbWVzIG11c3QgYmVnaW4gd2l0aCBhIGxldHRlciBvciBudW1iZXIuXCIpO1xuICB9XG5cbiAgLy8gbmFtZXMgY2Fubm90IGVuZCB3aXRoICctczNhbGlhcycgYW5kIG11c3QgZW5kIHdpdGggYSBsZXR0ZXIgb3IgbnVtYmVyLFxuICAvLyBidXQgd2UgZG8gbm90IG5lZWQgdG8gaGFuZGxlIHRoZXNlIGNhc2VzIHNpbmNlIHdlIGFyZSBnZW5lcmF0aW5nIHRoZVxuICAvLyBwcmVmaXggb25seVxuXG4gIGNvbnN0IGlzVGVzdEVudmlyb25tZW50ID0gQXBwLm9mKHNjb3BlKS5pc1Rlc3RFbnZpcm9ubWVudDtcblxuICBjb25zdCBidWNrZXQgPSBuZXcgUzNCdWNrZXQoc2NvcGUsIG5hbWUsIHtcbiAgICBidWNrZXRQcmVmaXgsXG4gICAgZm9yY2VEZXN0cm95OiAhIWlzVGVzdEVudmlyb25tZW50LFxuICB9KTtcblxuICBpZiAoaXNQdWJsaWMpIHtcbiAgICBjb25zdCBwdWJsaWNBY2Nlc3NCbG9jayA9IG5ldyBTM0J1Y2tldFB1YmxpY0FjY2Vzc0Jsb2NrKFxuICAgICAgc2NvcGUsXG4gICAgICBcIlB1YmxpY0FjY2Vzc0Jsb2NrXCIsXG4gICAgICB7XG4gICAgICAgIGJ1Y2tldDogYnVja2V0LmJ1Y2tldCxcbiAgICAgICAgYmxvY2tQdWJsaWNBY2xzOiBmYWxzZSxcbiAgICAgICAgYmxvY2tQdWJsaWNQb2xpY3k6IGZhbHNlLFxuICAgICAgICBpZ25vcmVQdWJsaWNBY2xzOiBmYWxzZSxcbiAgICAgICAgcmVzdHJpY3RQdWJsaWNCdWNrZXRzOiBmYWxzZSxcbiAgICAgIH1cbiAgICApO1xuICAgIGNvbnN0IHBvbGljeSA9IHtcbiAgICAgIFZlcnNpb246IFwiMjAxMi0xMC0xN1wiLFxuICAgICAgU3RhdGVtZW50OiBbXG4gICAgICAgIHtcbiAgICAgICAgICBFZmZlY3Q6IFwiQWxsb3dcIixcbiAgICAgICAgICBQcmluY2lwYWw6IFwiKlwiLFxuICAgICAgICAgIEFjdGlvbjogW1wiczM6R2V0T2JqZWN0XCJdLFxuICAgICAgICAgIFJlc291cmNlOiBbYCR7YnVja2V0LmFybn0vKmBdLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9O1xuICAgIG5ldyBTM0J1Y2tldFBvbGljeShzY29wZSwgXCJQdWJsaWNQb2xpY3lcIiwge1xuICAgICAgYnVja2V0OiBidWNrZXQuYnVja2V0LFxuICAgICAgcG9saWN5OiBKU09OLnN0cmluZ2lmeShwb2xpY3kpLFxuICAgICAgZGVwZW5kc09uOiBbcHVibGljQWNjZXNzQmxvY2tdLFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGJ1Y2tldDtcbn1cbiJdfQ==