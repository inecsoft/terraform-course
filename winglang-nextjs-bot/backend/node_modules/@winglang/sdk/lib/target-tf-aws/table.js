"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Table = void 0;
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
const app_1 = require("./app");
const dynamodb_table_1 = require("../.gen/providers/aws/dynamodb-table");
const dynamodb_table_item_1 = require("../.gen/providers/aws/dynamodb-table-item");
const core = __importStar(require("../core"));
const ex = __importStar(require("../ex"));
const resource_names_1 = require("../shared/resource-names");
const shared_aws_1 = require("../shared-aws");
/**
 * Table names must be between 3 and 255 characters.
 * You can use alphanumeric characters, dot (.), dash (-), and underscores (_).
 */
const NAME_OPTS = {
    maxLen: 255,
    disallowedRegex: /[^a-zA-Z0-9\_\.\-]+/g,
};
/**
 * AWS implementation of `ex.Table`.
 *
 * @inflight `@winglang/sdk.ex.ITableClient`
 */
class Table extends ex.Table {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        const isTestEnvironment = app_1.App.of(scope).isTestEnvironment;
        this.table = new dynamodb_table_1.DynamodbTable(this, "Default", {
            name: resource_names_1.ResourceNames.generateName(this, {
                prefix: this.name,
                ...NAME_OPTS,
            }),
            attribute: [{ name: this.primaryKey, type: "S" }],
            hashKey: this.primaryKey,
            billingMode: "PAY_PER_REQUEST",
            pointInTimeRecovery: isTestEnvironment ? undefined : { enabled: true },
        });
    }
    addRow(key, row) {
        const item = { [this.primaryKey]: key, ...row };
        const marshalledItem = (0, util_dynamodb_1.marshall)(item);
        const stringifiedItem = JSON.stringify(marshalledItem);
        new dynamodb_table_item_1.DynamodbTableItem(this, `DynamodbTableItem-${key}`, {
            tableName: this.table.name,
            hashKey: this.table.hashKey,
            item: stringifiedItem,
        });
    }
    onLift(host, ops) {
        if (!shared_aws_1.AwsInflightHost.isAwsInflightHost(host)) {
            throw new Error("Host is expected to implement `IAwsInfightHost`");
        }
        if (ops.includes(ex.TableInflightMethods.INSERT) ||
            ops.includes(ex.TableInflightMethods.UPSERT)) {
            host.addPolicyStatements({
                actions: ["dynamodb:PutItem"],
                resources: [this.table.arn],
            });
        }
        if (ops.includes(ex.TableInflightMethods.UPDATE)) {
            host.addPolicyStatements({
                actions: ["dynamodb:UpdateItem"],
                resources: [this.table.arn],
            });
        }
        if (ops.includes(ex.TableInflightMethods.DELETE)) {
            host.addPolicyStatements({
                actions: ["dynamodb:DeleteItem"],
                resources: [this.table.arn],
            });
        }
        if (ops.includes(ex.TableInflightMethods.GET) ||
            ops.includes(ex.TableInflightMethods.TRYGET)) {
            host.addPolicyStatements({
                actions: ["dynamodb:GetItem"],
                resources: [this.table.arn],
            });
        }
        if (ops.includes(ex.TableInflightMethods.LIST)) {
            host.addPolicyStatements({
                actions: ["dynamodb:Scan"],
                resources: [this.table.arn],
            });
        }
        host.addEnvironment(this.envName(), this.table.name);
        host.addEnvironment(this.primaryKeyEnvName(), this.primaryKey);
        host.addEnvironment(this.columnsEnvName(), JSON.stringify(this.columns));
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core.InflightClient.for(__dirname.replace("target-tf-aws", "shared-aws"), __filename, "TableClient", [
            `process.env["${this.envName()}"]`,
            `process.env["${this.primaryKeyEnvName()}"]`,
            `process.env["${this.columnsEnvName()}"]`,
        ]);
    }
    /** @internal */
    get _liftMap() {
        return {
            [ex.TableInflightMethods.INSERT]: [],
            [ex.TableInflightMethods.UPSERT]: [],
            [ex.TableInflightMethods.UPDATE]: [],
            [ex.TableInflightMethods.DELETE]: [],
            [ex.TableInflightMethods.GET]: [],
            [ex.TableInflightMethods.TRYGET]: [],
            [ex.TableInflightMethods.LIST]: [],
        };
    }
    envName() {
        return `DYNAMODB_TABLE_NAME_${this.node.addr.slice(-8)}`;
    }
    primaryKeyEnvName() {
        return `${this.envName()}_PRIMARY_KEY`;
    }
    columnsEnvName() {
        return `${this.envName()}_COLUMNS`;
    }
    get dynamoTableArn() {
        return this.table.arn;
    }
    get dynamoTableName() {
        return this.table.name;
    }
}
exports.Table = Table;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXRmLWF3cy90YWJsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDBEQUFrRDtBQUVsRCwrQkFBNEI7QUFDNUIseUVBQXFFO0FBQ3JFLG1GQUE4RTtBQUM5RSw4Q0FBZ0M7QUFDaEMsMENBQTRCO0FBQzVCLDZEQUFzRTtBQUN0RSw4Q0FBZ0Q7QUFJaEQ7OztHQUdHO0FBQ0gsTUFBTSxTQUFTLEdBQWdCO0lBQzdCLE1BQU0sRUFBRSxHQUFHO0lBQ1gsZUFBZSxFQUFFLHNCQUFzQjtDQUN4QyxDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQWEsS0FBTSxTQUFRLEVBQUUsQ0FBQyxLQUFLO0lBR2pDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBdUIsRUFBRTtRQUNqRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixNQUFNLGlCQUFpQixHQUFHLFNBQUcsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsaUJBQWlCLENBQUM7UUFFMUQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLDhCQUFhLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRTtZQUM5QyxJQUFJLEVBQUUsOEJBQWEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFO2dCQUNyQyxNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUk7Z0JBQ2pCLEdBQUcsU0FBUzthQUNiLENBQUM7WUFDRixTQUFTLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUNqRCxPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVU7WUFDeEIsV0FBVyxFQUFFLGlCQUFpQjtZQUM5QixtQkFBbUIsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENB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LENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtZQUNwQyxDQUFDLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ25DLENBQUM7SUFDSixDQUFDO0lBRU8sT0FBTztRQUNiLE9BQU8sdUJBQXVCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDM0QsQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUM7SUFDekMsQ0FBQztJQUVPLGNBQWM7UUFDcEIsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDO0lBQ3JDLENBQUM7SUFFRCxJQUFXLGNBQWM7UUFDdkIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztJQUN4QixDQUFDO0lBRUQsSUFBVyxlQUFlO1FBQ3hCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7SUFDekIsQ0FBQztDQUNGO0FBbElELHNCQWtJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1hcnNoYWxsIH0gZnJvbSBcIkBhd3Mtc2RrL3V0aWwtZHluYW1vZGJcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9hcHBcIjtcbmltcG9ydCB7IER5bmFtb2RiVGFibGUgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL2R5bmFtb2RiLXRhYmxlXCI7XG5pbXBvcnQgeyBEeW5hbW9kYlRhYmxlSXRlbSB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvZHluYW1vZGItdGFibGUtaXRlbVwiO1xuaW1wb3J0ICogYXMgY29yZSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0ICogYXMgZXggZnJvbSBcIi4uL2V4XCI7XG5pbXBvcnQgeyBOYW1lT3B0aW9ucywgUmVzb3VyY2VOYW1lcyB9IGZyb20gXCIuLi9zaGFyZWQvcmVzb3VyY2UtbmFtZXNcIjtcbmltcG9ydCB7IEF3c0luZmxpZ2h0SG9zdCB9IGZyb20gXCIuLi9zaGFyZWQtYXdzXCI7XG5pbXBvcnQgeyBJQXdzVGFibGUgfSBmcm9tIFwiLi4vc2hhcmVkLWF3cy90YWJsZVwiO1xuaW1wb3J0IHsgSnNvbiwgSUluZmxpZ2h0SG9zdCB9IGZyb20gXCIuLi9zdGRcIjtcblxuLyoqXG4gKiBUYWJsZSBuYW1lcyBtdXN0IGJlIGJldHdlZW4gMyBhbmQgMjU1IGNoYXJhY3RlcnMuXG4gKiBZb3UgY2FuIHVzZSBhbHBoYW51bWVyaWMgY2hhcmFjdGVycywgZG90ICguKSwgZGFzaCAoLSksIGFuZCB1bmRlcnNjb3JlcyAoXykuXG4gKi9cbmNvbnN0IE5BTUVfT1BUUzogTmFtZU9wdGlvbnMgPSB7XG4gIG1heExlbjogMjU1LFxuICBkaXNhbGxvd2VkUmVnZXg6IC9bXmEtekEtWjAtOVxcX1xcLlxcLV0rL2csXG59O1xuXG4vKipcbiAqIEFXUyBpbXBsZW1lbnRhdGlvbiBvZiBgZXguVGFibGVgLlxuICpcbiAqIEBpbmZsaWdodCBgQHdpbmdsYW5nL3Nkay5leC5JVGFibGVDbGllbnRgXG4gKi9cbmV4cG9ydCBjbGFzcyBUYWJsZSBleHRlbmRzIGV4LlRhYmxlIGltcGxlbWVudHMgSUF3c1RhYmxlIHtcbiAgcHJpdmF0ZSByZWFkb25seSB0YWJsZTogRHluYW1vZGJUYWJsZTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogZXguVGFibGVQcm9wcyA9IHt9KSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICBjb25zdCBpc1Rlc3RFbnZpcm9ubWVudCA9IEFwcC5vZihzY29wZSkuaXNUZXN0RW52aXJvbm1lbnQ7XG5cbiAgICB0aGlzLnRhYmxlID0gbmV3IER5bmFtb2RiVGFibGUodGhpcywgXCJEZWZhdWx0XCIsIHtcbiAgICAgIG5hbWU6IFJlc291cmNlTmFtZXMuZ2VuZXJhdGVOYW1lKHRoaXMsIHtcbiAgICAgICAgcHJlZml4OiB0aGlzLm5hbWUsXG4gICAgICAgIC4uLk5BTUVfT1BUUyxcbiAgICAgIH0pLFxuICAgICAgYXR0cmlidXRlOiBbeyBuYW1lOiB0aGlzLnByaW1hcnlLZXksIHR5cGU6IFwiU1wiIH1dLFxuICAgICAgaGFzaEtleTogdGhpcy5wcmltYXJ5S2V5LFxuICAgICAgYmlsbGluZ01vZGU6IFwiUEFZX1BFUl9SRVFVRVNUXCIsXG4gICAgICBwb2ludEluVGltZVJlY292ZXJ5OiBpc1Rlc3RFbnZpcm9ubWVudCA/IHVuZGVmaW5lZCA6IHsgZW5hYmxlZDogdHJ1ZSB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFkZFJvdyhrZXk6IHN0cmluZywgcm93OiBKc29uKTogdm9pZCB7XG4gICAgY29uc3QgaXRlbSA9IHsgW3RoaXMucHJpbWFyeUtleV06IGtleSwgLi4ucm93IH07XG4gICAgY29uc3QgbWFyc2hhbGxlZEl0ZW0gPSBtYXJzaGFsbChpdGVtKTtcbiAgICBjb25zdCBzdHJpbmdpZmllZEl0ZW0gPSBKU09OLnN0cmluZ2lmeShtYXJzaGFsbGVkSXRlbSk7XG5cbiAgICBuZXcgRHluYW1vZGJUYWJsZUl0ZW0odGhpcywgYER5bmFtb2RiVGFibGVJdGVtLSR7a2V5fWAsIHtcbiAgICAgIHRhYmxlTmFtZTogdGhpcy50YWJsZS5uYW1lLFxuICAgICAgaGFzaEtleTogdGhpcy50YWJsZS5oYXNoS2V5LFxuICAgICAgaXRlbTogc3RyaW5naWZpZWRJdGVtLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIG9uTGlmdChob3N0OiBJSW5mbGlnaHRIb3N0LCBvcHM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgaWYgKCFBd3NJbmZsaWdodEhvc3QuaXNBd3NJbmZsaWdodEhvc3QoaG9zdCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkhvc3QgaXMgZXhwZWN0ZWQgdG8gaW1wbGVtZW50IGBJQXdzSW5maWdodEhvc3RgXCIpO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIG9wcy5pbmNsdWRlcyhleC5UYWJsZUluZmxpZ2h0TWV0aG9kcy5JTlNFUlQpIHx8XG4gICAgICBvcHMuaW5jbHVkZXMoZXguVGFibGVJbmZsaWdodE1ldGhvZHMuVVBTRVJUKVxuICAgICkge1xuICAgICAgaG9zdC5hZGRQb2xpY3lTdGF0ZW1lbnRzKHtcbiAgICAgICAgYWN0aW9uczogW1wiZHluYW1vZGI6UHV0SXRlbVwiXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbdGhpcy50YWJsZS5hcm5dLFxuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChvcHMuaW5jbHVkZXMoZXguVGFibGVJbmZsaWdodE1ldGhvZHMuVVBEQVRFKSkge1xuICAgICAgaG9zdC5hZGRQb2xpY3lTdGF0ZW1lbnRzKHtcbiAgICAgICAgYWN0aW9uczogW1wiZHluYW1vZGI6VXBkYXRlSXRlbVwiXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbdGhpcy50YWJsZS5hcm5dLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKG9wcy5pbmNsdWRlcyhleC5UYWJsZUluZmxpZ2h0TWV0aG9kcy5ERUxFVEUpKSB7XG4gICAgICBob3N0LmFkZFBvbGljeVN0YXRlbWVudHMoe1xuICAgICAgICBhY3Rpb25zOiBbXCJkeW5hbW9kYjpEZWxldGVJdGVtXCJdLFxuICAgICAgICByZXNvdXJjZXM6IFt0aGlzLnRhYmxlLmFybl0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICBvcHMuaW5jbHVkZXMoZXguVGFibGVJbmZsaWdodE1ldGhvZHMuR0VUKSB8fFxuICAgICAgb3BzLmluY2x1ZGVzKGV4LlRhYmxlSW5mbGlnaHRNZXRob2RzLlRSWUdFVClcbiAgICApIHtcbiAgICAgIGhvc3QuYWRkUG9saWN5U3RhdGVtZW50cyh7XG4gICAgICAgIGFjdGlvbnM6IFtcImR5bmFtb2RiOkdldEl0ZW1cIl0sXG4gICAgICAgIHJlc291cmNlczogW3RoaXMudGFibGUuYXJuXSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHMuaW5jbHVkZXMoZXguVGFibGVJbmZsaWdodE1ldGhvZHMuTElTVCkpIHtcbiAgICAgIGhvc3QuYWRkUG9saWN5U3RhdGVtZW50cyh7XG4gICAgICAgIGFjdGlvbnM6IFtcImR5bmFtb2RiOlNjYW5cIl0sXG4gICAgICAgIHJlc291cmNlczogW3RoaXMudGFibGUuYXJuXSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGhvc3QuYWRkRW52aXJvbm1lbnQodGhpcy5lbnZOYW1lKCksIHRoaXMudGFibGUubmFtZSk7XG4gICAgaG9zdC5hZGRFbnZpcm9ubWVudCh0aGlzLnByaW1hcnlLZXlFbnZOYW1lKCksIHRoaXMucHJpbWFyeUtleSk7XG4gICAgaG9zdC5hZGRFbnZpcm9ubWVudCh0aGlzLmNvbHVtbnNFbnZOYW1lKCksIEpTT04uc3RyaW5naWZ5KHRoaXMuY29sdW1ucykpO1xuXG4gICAgc3VwZXIub25MaWZ0KGhvc3QsIG9wcyk7XG4gIH1cblxuICAvKiogQGludGVybmFsICovXG4gIHB1YmxpYyBfdG9JbmZsaWdodCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBjb3JlLkluZmxpZ2h0Q2xpZW50LmZvcihcbiAgICAgIF9fZGlybmFtZS5yZXBsYWNlKFwidGFyZ2V0LXRmLWF3c1wiLCBcInNoYXJlZC1hd3NcIiksXG4gICAgICBfX2ZpbGVuYW1lLFxuICAgICAgXCJUYWJsZUNsaWVudFwiLFxuICAgICAgW1xuICAgICAgICBgcHJvY2Vzcy5lbnZbXCIke3RoaXMuZW52TmFtZSgpfVwiXWAsXG4gICAgICAgIGBwcm9jZXNzLmVudltcIiR7dGhpcy5wcmltYXJ5S2V5RW52TmFtZSgpfVwiXWAsXG4gICAgICAgIGBwcm9jZXNzLmVudltcIiR7dGhpcy5jb2x1bW5zRW52TmFtZSgpfVwiXWAsXG4gICAgICBdXG4gICAgKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIGdldCBfbGlmdE1hcCgpOiBjb3JlLkxpZnRNYXAge1xuICAgIHJldHVybiB7XG4gICAgICBbZXguVGFibGVJbmZsaWdodE1ldGhvZHMuSU5TRVJUXTogW10sXG4gICAgICBbZXguVGFibGVJbmZsaWdodE1ldGhvZHMuVVBTRVJUXTogW10sXG4gICAgICBbZXguVGFibGVJbmZsaWdodE1ldGhvZHMuVVBEQVRFXTogW10sXG4gICAgICBbZXguVGFibGVJbmZsaWdodE1ldGhvZHMuREVMRVRFXTogW10sXG4gICAgICBbZXguVGFibGVJbmZsaWdodE1ldGhvZHMuR0VUXTogW10sXG4gICAgICBbZXguVGFibGVJbmZsaWdodE1ldGhvZHMuVFJZR0VUXTogW10sXG4gICAgICBbZXguVGFibGVJbmZsaWdodE1ldGhvZHMuTElTVF06IFtdLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGVudk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYERZTkFNT0RCX1RBQkxFX05BTUVfJHt0aGlzLm5vZGUuYWRkci5zbGljZSgtOCl9YDtcbiAgfVxuXG4gIHByaXZhdGUgcHJpbWFyeUtleUVudk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7dGhpcy5lbnZOYW1lKCl9X1BSSU1BUllfS0VZYDtcbiAgfVxuXG4gIHByaXZhdGUgY29sdW1uc0Vudk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7dGhpcy5lbnZOYW1lKCl9X0NPTFVNTlNgO1xuICB9XG5cbiAgcHVibGljIGdldCBkeW5hbW9UYWJsZUFybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnRhYmxlLmFybjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZHluYW1vVGFibGVOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMudGFibGUubmFtZTtcbiAgfVxufVxuIl19