"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Website = void 0;
const fs_1 = require("fs");
const path_1 = require("path");
const cdktf_1 = require("cdktf");
const mime_types_1 = __importDefault(require("mime-types"));
const bucket_1 = require("./bucket");
const __1 = require("..");
const cloudfront_distribution_1 = require("../.gen/providers/aws/cloudfront-distribution");
const cloudfront_origin_access_control_1 = require("../.gen/providers/aws/cloudfront-origin-access-control");
const data_aws_iam_policy_document_1 = require("../.gen/providers/aws/data-aws-iam-policy-document");
const route53_record_1 = require("../.gen/providers/aws/route53-record");
const s3_bucket_policy_1 = require("../.gen/providers/aws/s3-bucket-policy");
const s3_bucket_website_configuration_1 = require("../.gen/providers/aws/s3-bucket-website-configuration");
const s3_object_1 = require("../.gen/providers/aws/s3-object");
const cloud = __importStar(require("../cloud"));
const misc_1 = require("../shared/misc");
const resource_names_1 = require("../shared/resource-names");
const std_1 = require("../std");
const INDEX_FILE = "index.html";
/**
 * AWS implementation of `cloud.Website`.
 *
 * @inflight `@winglang/sdk.cloud.IWebsiteClient`
 */
class Website extends cloud.Website {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.bucket = (0, bucket_1.createEncryptedBucket)(this, false, "WebsiteBucket");
        new s3_bucket_website_configuration_1.S3BucketWebsiteConfiguration(this, "BucketWebsiteConfiguration", {
            bucket: this.bucket.bucket,
            indexDocument: { suffix: INDEX_FILE },
            errorDocument: props.errorDocument
                ? { key: props.errorDocument }
                : undefined,
        });
        this.uploadFiles(this.path);
        // create a cloudfront oac
        const OAC_NAME_OPTIONS = {
            maxLen: 32,
            disallowedRegex: /[^a-zA-Z0-9-]/,
            suffix: "-cloudfront-oac",
        };
        const cloudfrontOac = new cloudfront_origin_access_control_1.CloudfrontOriginAccessControl(this, "CloudfrontOac", {
            name: resource_names_1.ResourceNames.generateName(this, OAC_NAME_OPTIONS),
            originAccessControlOriginType: "s3",
            signingBehavior: "always",
            signingProtocol: "sigv4",
        });
        // create a cloudFront distribution
        const distribution = new cloudfront_distribution_1.CloudfrontDistribution(this, "Distribution", {
            enabled: true,
            ...(this._domain?.domainName && { aliases: [this._domain.domainName] }),
            origin: [
                {
                    domainName: this.bucket.bucketRegionalDomainName,
                    originId: "s3Origin",
                    originAccessControlId: cloudfrontOac.id,
                },
            ],
            defaultRootObject: INDEX_FILE,
            customErrorResponse: props.errorDocument
                ? [
                    {
                        errorCode: 404,
                        responseCode: 200,
                        responsePagePath: `/${props.errorDocument}`,
                    },
                    {
                        errorCode: 403,
                        responseCode: 200,
                        responsePagePath: `/${props.errorDocument}`,
                    },
                ]
                : undefined,
            defaultCacheBehavior: {
                allowedMethods: ["GET", "HEAD"],
                cachedMethods: ["GET", "HEAD"],
                targetOriginId: "s3Origin",
                forwardedValues: {
                    queryString: false,
                    cookies: { forward: "none" },
                },
                compress: true,
                viewerProtocolPolicy: "redirect-to-https",
                minTtl: 0,
                defaultTtl: 3600,
                maxTtl: 86400,
            },
            restrictions: {
                geoRestriction: {
                    locations: [],
                    restrictionType: "none",
                },
            },
            priceClass: "PriceClass_100",
            viewerCertificate: {
                cloudfrontDefaultCertificate: true,
                ...(props.domain?.acmCertificateArn && {
                    acmCertificateArn: props.domain.acmCertificateArn,
                    sslSupportMethod: "sni-only",
                }),
                ...(props.domain?.iamCertificate && {
                    iamCertificate: props.domain.iamCertificate,
                    sslSupportMethod: "sni-only",
                }),
            },
        });
        // allow cloudfront distribution to read from private s3 bucket
        const allowDistributionReadOnly = new data_aws_iam_policy_document_1.DataAwsIamPolicyDocument(this, "AllowDistributionReadOnly", {
            statement: [
                {
                    actions: ["s3:GetObject"],
                    condition: [
                        {
                            test: "StringEquals",
                            values: [distribution.arn],
                            variable: "AWS:SourceArn",
                        },
                    ],
                    principals: [
                        {
                            identifiers: ["cloudfront.amazonaws.com"],
                            type: "Service",
                        },
                    ],
                    resources: [`${this.bucket.arn}/*`],
                },
            ],
        });
        // attach policy to s3 bucket
        new s3_bucket_policy_1.S3BucketPolicy(this, "DistributionS3BucketPolicy", {
            bucket: this.bucket.id,
            policy: allowDistributionReadOnly.json,
        });
        if (props.domain && props.domain.domainName && props.domain.hostedZoneId) {
            new route53_record_1.Route53Record(this, "Route53Record", {
                zoneId: props.domain.hostedZoneId,
                type: "A",
                name: props.domain.domainName,
                alias: {
                    name: distribution.domainName,
                    zoneId: distribution.hostedZoneId,
                    evaluateTargetHealth: false,
                },
            });
        }
        this._url = `https://${distribution.domainName}`;
        this.endpoint = new cloud.Endpoint(this, "Endpoint", this._url, {
            label: `Website ${this.node.path}`,
            browserSupport: true,
        });
        std_1.Node.of(this.endpoint).hidden = true;
    }
    get _endpoint() {
        return this.endpoint;
    }
    addFile(path, data, options) {
        new s3_object_1.S3Object(this, `File-${path}`, {
            dependsOn: [this.bucket],
            content: data,
            bucket: this.bucket.bucket,
            contentType: options?.contentType ?? "text/plain",
            key: (0, misc_1.normalPath)(path),
        });
        return `${this.url}/${path}`;
    }
    uploadFile(filePath) {
        const fileKey = (0, misc_1.normalPath)(filePath.replace(this.path, ""));
        const normalizedFullPath = (0, misc_1.normalPath)((0, path_1.resolve)(filePath));
        new s3_object_1.S3Object(this, `File${fileKey.replace(/\//g, "--")}`, {
            dependsOn: [this.bucket],
            key: fileKey,
            bucket: this.bucket.bucket,
            source: normalizedFullPath,
            sourceHash: cdktf_1.Fn.filemd5(normalizedFullPath),
            contentType: mime_types_1.default.contentType((0, path_1.extname)(filePath)) || undefined,
        });
    }
    uploadFiles(dir) {
        const files = (0, fs_1.readdirSync)(dir, { withFileTypes: true });
        for (const file of files) {
            const filename = (0, path_1.join)(dir, file.name);
            if (file.isDirectory()) {
                this.uploadFiles(filename);
            }
            else {
                this.uploadFile(filename);
            }
        }
    }
    /** @internal */
    _toInflight() {
        return __1.core.InflightClient.for(__dirname.replace("target-tf-aws", "shared-aws"), __filename, "WebsiteClient", []);
    }
    get bucketArn() {
        return this.bucket.arn;
    }
    get bucketName() {
        return this.bucket.bucketDomainName;
    }
}
exports.Website = Website;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vic2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90YXJnZXQtdGYtYXdzL3dlYnNpdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQkFBaUM7QUFDakMsK0JBQThDO0FBRTlDLGlDQUEyQjtBQUUzQiw0REFBOEI7QUFDOUIscUNBQWlEO0FBQ2pELDBCQUEwQjtBQUMxQiwyRkFBdUY7QUFDdkYsNkdBQXVHO0FBQ3ZHLHFHQUE4RjtBQUM5Rix5RUFBcUU7QUFFckUsNkVBQXdFO0FBQ3hFLDJHQUFxRztBQUNyRywrREFBMkQ7QUFDM0QsZ0RBQWtDO0FBQ2xDLHlDQUE0QztBQUM1Qyw2REFBc0U7QUFFdEUsZ0NBQThCO0FBRTlCLE1BQU0sVUFBVSxHQUFHLFlBQVksQ0FBQztBQUVoQzs7OztHQUlHO0FBQ0gsTUFBYSxPQUFRLFNBQVEsS0FBSyxDQUFDLE9BQU87SUFLeEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUEwQjtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUEsOEJBQXFCLEVBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxlQUFlLENBQUMsQ0FBQztRQUVsRSxJQUFJLDhEQUE0QixDQUFDLElBQUksRUFBRSw0QkFBNEIsRUFBRTtZQUNuRSxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNO1lBQzFCLGFBQWEsRUFBRSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUU7WUFDckMsYUFBYSxFQUFFLEtBQUssQ0FBQyxhQUFhO2dCQUNoQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLGFBQWEsRUFBRTtnQkFDOUIsQ0FBQyxDQUFDLFNBQVM7U0FDZCxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJ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QUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxJQUFXLFVBQVU7UUFDbkIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDO0lBQ3RDLENBQUM7Q0FDRjtBQXpORCwwQkF5TkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZWFkZGlyU3luYyB9IGZyb20gXCJmc1wiO1xuaW1wb3J0IHsgZXh0bmFtZSwgam9pbiwgcmVzb2x2ZSB9IGZyb20gXCJwYXRoXCI7XG5cbmltcG9ydCB7IEZuIH0gZnJvbSBcImNka3RmXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IG1pbWUgZnJvbSBcIm1pbWUtdHlwZXNcIjtcbmltcG9ydCB7IGNyZWF0ZUVuY3J5cHRlZEJ1Y2tldCB9IGZyb20gXCIuL2J1Y2tldFwiO1xuaW1wb3J0IHsgY29yZSB9IGZyb20gXCIuLlwiO1xuaW1wb3J0IHsgQ2xvdWRmcm9udERpc3RyaWJ1dGlvbiB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvY2xvdWRmcm9udC1kaXN0cmlidXRpb25cIjtcbmltcG9ydCB7IENsb3VkZnJvbnRPcmlnaW5BY2Nlc3NDb250cm9sIH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9jbG91ZGZyb250LW9yaWdpbi1hY2Nlc3MtY29udHJvbFwiO1xuaW1wb3J0IHsgRGF0YUF3c0lhbVBvbGljeURvY3VtZW50IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9kYXRhLWF3cy1pYW0tcG9saWN5LWRvY3VtZW50XCI7XG5pbXBvcnQgeyBSb3V0ZTUzUmVjb3JkIH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9yb3V0ZTUzLXJlY29yZFwiO1xuaW1wb3J0IHsgUzNCdWNrZXQgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL3MzLWJ1Y2tldFwiO1xuaW1wb3J0IHsgUzNCdWNrZXRQb2xpY3kgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL3MzLWJ1Y2tldC1wb2xpY3lcIjtcbmltcG9ydCB7IFMzQnVja2V0V2Vic2l0ZUNvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL3MzLWJ1Y2tldC13ZWJzaXRlLWNvbmZpZ3VyYXRpb25cIjtcbmltcG9ydCB7IFMzT2JqZWN0IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9zMy1vYmplY3RcIjtcbmltcG9ydCAqIGFzIGNsb3VkIGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0IHsgbm9ybWFsUGF0aCB9IGZyb20gXCIuLi9zaGFyZWQvbWlzY1wiO1xuaW1wb3J0IHsgTmFtZU9wdGlvbnMsIFJlc291cmNlTmFtZXMgfSBmcm9tIFwiLi4vc2hhcmVkL3Jlc291cmNlLW5hbWVzXCI7XG5pbXBvcnQgKiBhcyBhd3MgZnJvbSBcIi4uL3NoYXJlZC1hd3NcIjtcbmltcG9ydCB7IE5vZGUgfSBmcm9tIFwiLi4vc3RkXCI7XG5cbmNvbnN0IElOREVYX0ZJTEUgPSBcImluZGV4Lmh0bWxcIjtcblxuLyoqXG4gKiBBV1MgaW1wbGVtZW50YXRpb24gb2YgYGNsb3VkLldlYnNpdGVgLlxuICpcbiAqIEBpbmZsaWdodCBgQHdpbmdsYW5nL3Nkay5jbG91ZC5JV2Vic2l0ZUNsaWVudGBcbiAqL1xuZXhwb3J0IGNsYXNzIFdlYnNpdGUgZXh0ZW5kcyBjbG91ZC5XZWJzaXRlIGltcGxlbWVudHMgYXdzLklBd3NXZWJzaXRlIHtcbiAgcHVibGljIHJlYWRvbmx5IGJ1Y2tldDogUzNCdWNrZXQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgX3VybDogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IGVuZHBvaW50OiBjbG91ZC5FbmRwb2ludDtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogYXdzLkF3c1dlYnNpdGVQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgdGhpcy5idWNrZXQgPSBjcmVhdGVFbmNyeXB0ZWRCdWNrZXQodGhpcywgZmFsc2UsIFwiV2Vic2l0ZUJ1Y2tldFwiKTtcblxuICAgIG5ldyBTM0J1Y2tldFdlYnNpdGVDb25maWd1cmF0aW9uKHRoaXMsIFwiQnVja2V0V2Vic2l0ZUNvbmZpZ3VyYXRpb25cIiwge1xuICAgICAgYnVja2V0OiB0aGlzLmJ1Y2tldC5idWNrZXQsXG4gICAgICBpbmRleERvY3VtZW50OiB7IHN1ZmZpeDogSU5ERVhfRklMRSB9LFxuICAgICAgZXJyb3JEb2N1bWVudDogcHJvcHMuZXJyb3JEb2N1bWVudFxuICAgICAgICA/IHsga2V5OiBwcm9wcy5lcnJvckRvY3VtZW50IH1cbiAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgfSk7XG5cbiAgICB0aGlzLnVwbG9hZEZpbGVzKHRoaXMucGF0aCk7XG5cbiAgICAvLyBjcmVhdGUgYSBjbG91ZGZyb250IG9hY1xuICAgIGNvbnN0IE9BQ19OQU1FX09QVElPTlM6IE5hbWVPcHRpb25zID0ge1xuICAgICAgbWF4TGVuOiAzMixcbiAgICAgIGRpc2FsbG93ZWRSZWdleDogL1teYS16QS1aMC05LV0vLFxuICAgICAgc3VmZml4OiBcIi1jbG91ZGZyb250LW9hY1wiLFxuICAgIH07XG5cbiAgICBjb25zdCBjbG91ZGZyb250T2FjID0gbmV3IENsb3VkZnJvbnRPcmlnaW5BY2Nlc3NDb250cm9sKFxuICAgICAgdGhpcyxcbiAgICAgIFwiQ2xvdWRmcm9udE9hY1wiLFxuICAgICAge1xuICAgICAgICBuYW1lOiBSZXNvdXJjZU5hbWVzLmdlbmVyYXRlTmFtZSh0aGlzLCBPQUNfTkFNRV9PUFRJT05TKSxcbiAgICAgICAgb3JpZ2luQWNjZXNzQ29udHJvbE9yaWdpblR5cGU6IFwiczNcIixcbiAgICAgICAgc2lnbmluZ0JlaGF2aW9yOiBcImFsd2F5c1wiLFxuICAgICAgICBzaWduaW5nUHJvdG9jb2w6IFwic2lndjRcIixcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gY3JlYXRlIGEgY2xvdWRGcm9udCBkaXN0cmlidXRpb25cbiAgICBjb25zdCBkaXN0cmlidXRpb24gPSBuZXcgQ2xvdWRmcm9udERpc3RyaWJ1dGlvbih0aGlzLCBcIkRpc3RyaWJ1dGlvblwiLCB7XG4gICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgLi4uKHRoaXMuX2RvbWFpbj8uZG9tYWluTmFtZSAmJiB7IGFsaWFzZXM6IFt0aGlzLl9kb21haW4uZG9tYWluTmFtZV0gfSksXG4gICAgICBvcmlnaW46IFtcbiAgICAgICAge1xuICAgICAgICAgIGRvbWFpbk5hbWU6IHRoaXMuYnVja2V0LmJ1Y2tldFJlZ2lvbmFsRG9tYWluTmFtZSxcbiAgICAgICAgICBvcmlnaW5JZDogXCJzM09yaWdpblwiLFxuICAgICAgICAgIG9yaWdpbkFjY2Vzc0NvbnRyb2xJZDogY2xvdWRmcm9udE9hYy5pZCxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBkZWZhdWx0Um9vdE9iamVjdDogSU5ERVhfRklMRSxcbiAgICAgIGN1c3RvbUVycm9yUmVzcG9uc2U6IHByb3BzLmVycm9yRG9jdW1lbnRcbiAgICAgICAgPyBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGVycm9yQ29kZTogNDA0LFxuICAgICAgICAgICAgICByZXNwb25zZUNvZGU6IDIwMCxcbiAgICAgICAgICAgICAgcmVzcG9uc2VQYWdlUGF0aDogYC8ke3Byb3BzLmVycm9yRG9jdW1lbnR9YCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGVycm9yQ29kZTogNDAzLFxuICAgICAgICAgICAgICByZXNwb25zZUNvZGU6IDIwMCxcbiAgICAgICAgICAgICAgcmVzcG9uc2VQYWdlUGF0aDogYC8ke3Byb3BzLmVycm9yRG9jdW1lbnR9YCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXVxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIGRlZmF1bHRDYWNoZUJlaGF2aW9yOiB7XG4gICAgICAgIGFsbG93ZWRNZXRob2RzOiBbXCJHRVRcIiwgXCJIRUFEXCJdLFxuICAgICAgICBjYWNoZWRNZXRob2RzOiBbXCJHRVRcIiwgXCJIRUFEXCJdLFxuICAgICAgICB0YXJnZXRPcmlnaW5JZDogXCJzM09yaWdpblwiLFxuICAgICAgICBmb3J3YXJkZWRWYWx1ZXM6IHtcbiAgICAgICAgICBxdWVyeVN0cmluZzogZmFsc2UsXG4gICAgICAgICAgY29va2llczogeyBmb3J3YXJkOiBcIm5vbmVcIiB9LFxuICAgICAgICB9LFxuICAgICAgICBjb21wcmVzczogdHJ1ZSxcbiAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3k6IFwicmVkaXJlY3QtdG8taHR0cHNcIixcbiAgICAgICAgbWluVHRsOiAwLFxuICAgICAgICBkZWZhdWx0VHRsOiAzNjAwLFxuICAgICAgICBtYXhUdGw6IDg2NDAwLFxuICAgICAgfSxcbiAgICAgIHJlc3RyaWN0aW9uczoge1xuICAgICAgICBnZW9SZXN0cmljdGlvbjoge1xuICAgICAgICAgIGxvY2F0aW9uczogW10sXG4gICAgICAgICAgcmVzdHJpY3Rpb25UeXBlOiBcIm5vbmVcIixcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBwcmljZUNsYXNzOiBcIlByaWNlQ2xhc3NfMTAwXCIsXG4gICAgICB2aWV3ZXJDZXJ0aWZpY2F0ZToge1xuICAgICAgICBjbG91ZGZyb250RGVmYXVsdENlcnRpZmljYXRlOiB0cnVlLFxuICAgICAgICAuLi4ocHJvcHMuZG9tYWluPy5hY21DZXJ0aWZpY2F0ZUFybiAmJiB7XG4gICAgICAgICAgYWNtQ2VydGlmaWNhdGVBcm46IHByb3BzLmRvbWFpbi5hY21DZXJ0aWZpY2F0ZUFybixcbiAgICAgICAgICBzc2xTdXBwb3J0TWV0aG9kOiBcInNuaS1vbmx5XCIsXG4gICAgICAgIH0pLFxuICAgICAgICAuLi4ocHJvcHMuZG9tYWluPy5pYW1DZXJ0aWZpY2F0ZSAmJiB7XG4gICAgICAgICAgaWFtQ2VydGlmaWNhdGU6IHByb3BzLmRvbWFpbi5pYW1DZXJ0aWZpY2F0ZSxcbiAgICAgICAgICBzc2xTdXBwb3J0TWV0aG9kOiBcInNuaS1vbmx5XCIsXG4gICAgICAgIH0pLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIGFsbG93IGNsb3VkZnJvbnQgZGlzdHJpYnV0aW9uIHRvIHJlYWQgZnJvbSBwcml2YXRlIHMzIGJ1Y2tldFxuICAgIGNvbnN0IGFsbG93RGlzdHJpYnV0aW9uUmVhZE9ubHkgPSBuZXcgRGF0YUF3c0lhbVBvbGljeURvY3VtZW50KFxuICAgICAgdGhpcyxcbiAgICAgIFwiQWxsb3dEaXN0cmlidXRpb25SZWFkT25seVwiLFxuICAgICAge1xuICAgICAgICBzdGF0ZW1lbnQ6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBhY3Rpb25zOiBbXCJzMzpHZXRPYmplY3RcIl0sXG4gICAgICAgICAgICBjb25kaXRpb246IFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHRlc3Q6IFwiU3RyaW5nRXF1YWxzXCIsXG4gICAgICAgICAgICAgICAgdmFsdWVzOiBbZGlzdHJpYnV0aW9uLmFybl0sXG4gICAgICAgICAgICAgICAgdmFyaWFibGU6IFwiQVdTOlNvdXJjZUFyblwiLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIHByaW5jaXBhbHM6IFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGlkZW50aWZpZXJzOiBbXCJjbG91ZGZyb250LmFtYXpvbmF3cy5jb21cIl0sXG4gICAgICAgICAgICAgICAgdHlwZTogXCJTZXJ2aWNlXCIsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbYCR7dGhpcy5idWNrZXQuYXJufS8qYF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gYXR0YWNoIHBvbGljeSB0byBzMyBidWNrZXRcbiAgICBuZXcgUzNCdWNrZXRQb2xpY3kodGhpcywgXCJEaXN0cmlidXRpb25TM0J1Y2tldFBvbGljeVwiLCB7XG4gICAgICBidWNrZXQ6IHRoaXMuYnVja2V0LmlkLFxuICAgICAgcG9saWN5OiBhbGxvd0Rpc3RyaWJ1dGlvblJlYWRPbmx5Lmpzb24sXG4gICAgfSk7XG5cbiAgICBpZiAocHJvcHMuZG9tYWluICYmIHByb3BzLmRvbWFpbi5kb21haW5OYW1lICYmIHByb3BzLmRvbWFpbi5ob3N0ZWRab25lSWQpIHtcbiAgICAgIG5ldyBSb3V0ZTUzUmVjb3JkKHRoaXMsIFwiUm91dGU1M1JlY29yZFwiLCB7XG4gICAgICAgIHpvbmVJZDogcHJvcHMuZG9tYWluLmhvc3RlZFpvbmVJZCxcbiAgICAgICAgdHlwZTogXCJBXCIsXG4gICAgICAgIG5hbWU6IHByb3BzLmRvbWFpbi5kb21haW5OYW1lLFxuICAgICAgICBhbGlhczoge1xuICAgICAgICAgIG5hbWU6IGRpc3RyaWJ1dGlvbi5kb21haW5OYW1lLFxuICAgICAgICAgIHpvbmVJZDogZGlzdHJpYnV0aW9uLmhvc3RlZFpvbmVJZCxcbiAgICAgICAgICBldmFsdWF0ZVRhcmdldEhlYWx0aDogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLl91cmwgPSBgaHR0cHM6Ly8ke2Rpc3RyaWJ1dGlvbi5kb21haW5OYW1lfWA7XG5cbiAgICB0aGlzLmVuZHBvaW50ID0gbmV3IGNsb3VkLkVuZHBvaW50KHRoaXMsIFwiRW5kcG9pbnRcIiwgdGhpcy5fdXJsLCB7XG4gICAgICBsYWJlbDogYFdlYnNpdGUgJHt0aGlzLm5vZGUucGF0aH1gLFxuICAgICAgYnJvd3NlclN1cHBvcnQ6IHRydWUsXG4gICAgfSk7XG5cbiAgICBOb2RlLm9mKHRoaXMuZW5kcG9pbnQpLmhpZGRlbiA9IHRydWU7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0IF9lbmRwb2ludCgpOiBjbG91ZC5FbmRwb2ludCB7XG4gICAgcmV0dXJuIHRoaXMuZW5kcG9pbnQ7XG4gIH1cblxuICBwdWJsaWMgYWRkRmlsZShcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgZGF0YTogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBjbG91ZC5BZGRGaWxlT3B0aW9uc1xuICApOiBzdHJpbmcge1xuICAgIG5ldyBTM09iamVjdCh0aGlzLCBgRmlsZS0ke3BhdGh9YCwge1xuICAgICAgZGVwZW5kc09uOiBbdGhpcy5idWNrZXRdLFxuICAgICAgY29udGVudDogZGF0YSxcbiAgICAgIGJ1Y2tldDogdGhpcy5idWNrZXQuYnVja2V0LFxuICAgICAgY29udGVudFR5cGU6IG9wdGlvbnM/LmNvbnRlbnRUeXBlID8/IFwidGV4dC9wbGFpblwiLFxuICAgICAga2V5OiBub3JtYWxQYXRoKHBhdGgpLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGAke3RoaXMudXJsfS8ke3BhdGh9YDtcbiAgfVxuXG4gIHByaXZhdGUgdXBsb2FkRmlsZShmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgZmlsZUtleSA9IG5vcm1hbFBhdGgoZmlsZVBhdGgucmVwbGFjZSh0aGlzLnBhdGgsIFwiXCIpKTtcbiAgICBjb25zdCBub3JtYWxpemVkRnVsbFBhdGggPSBub3JtYWxQYXRoKHJlc29sdmUoZmlsZVBhdGgpKTtcblxuICAgIG5ldyBTM09iamVjdCh0aGlzLCBgRmlsZSR7ZmlsZUtleS5yZXBsYWNlKC9cXC8vZywgXCItLVwiKX1gLCB7XG4gICAgICBkZXBlbmRzT246IFt0aGlzLmJ1Y2tldF0sXG4gICAgICBrZXk6IGZpbGVLZXksXG4gICAgICBidWNrZXQ6IHRoaXMuYnVja2V0LmJ1Y2tldCxcbiAgICAgIHNvdXJjZTogbm9ybWFsaXplZEZ1bGxQYXRoLFxuICAgICAgc291cmNlSGFzaDogRm4uZmlsZW1kNShub3JtYWxpemVkRnVsbFBhdGgpLFxuICAgICAgY29udGVudFR5cGU6IG1pbWUuY29udGVudFR5cGUoZXh0bmFtZShmaWxlUGF0aCkpIHx8IHVuZGVmaW5lZCxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgdXBsb2FkRmlsZXMoZGlyOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBmaWxlcyA9IHJlYWRkaXJTeW5jKGRpciwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0pO1xuICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgY29uc3QgZmlsZW5hbWUgPSBqb2luKGRpciwgZmlsZS5uYW1lKTtcbiAgICAgIGlmIChmaWxlLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgdGhpcy51cGxvYWRGaWxlcyhmaWxlbmFtZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnVwbG9hZEZpbGUoZmlsZW5hbWUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIF90b0luZmxpZ2h0KCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNvcmUuSW5mbGlnaHRDbGllbnQuZm9yKFxuICAgICAgX19kaXJuYW1lLnJlcGxhY2UoXCJ0YXJnZXQtdGYtYXdzXCIsIFwic2hhcmVkLWF3c1wiKSxcbiAgICAgIF9fZmlsZW5hbWUsXG4gICAgICBcIldlYnNpdGVDbGllbnRcIixcbiAgICAgIFtdXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgYnVja2V0QXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuYnVja2V0LmFybjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgYnVja2V0TmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmJ1Y2tldC5idWNrZXREb21haW5OYW1lO1xuICB9XG59XG4iXX0=