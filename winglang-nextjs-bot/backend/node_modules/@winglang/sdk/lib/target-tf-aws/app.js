"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.App = void 0;
const api_1 = require("./api");
const bucket_1 = require("./bucket");
const counter_1 = require("./counter");
const endpoint_1 = require("./endpoint");
const function_1 = require("./function");
const on_deploy_1 = require("./on-deploy");
const queue_1 = require("./queue");
const redis_1 = require("./redis");
const schedule_1 = require("./schedule");
const secret_1 = require("./secret");
const table_1 = require("./table");
const test_runner_1 = require("./test-runner");
const topic_1 = require("./topic");
const website_1 = require("./website");
const data_aws_caller_identity_1 = require("../.gen/providers/aws/data-aws-caller-identity");
const data_aws_region_1 = require("../.gen/providers/aws/data-aws-region");
const data_aws_subnet_1 = require("../.gen/providers/aws/data-aws-subnet");
const data_aws_vpc_1 = require("../.gen/providers/aws/data-aws-vpc");
const eip_1 = require("../.gen/providers/aws/eip");
const internet_gateway_1 = require("../.gen/providers/aws/internet-gateway");
const nat_gateway_1 = require("../.gen/providers/aws/nat-gateway");
const provider_1 = require("../.gen/providers/aws/provider");
const route_table_1 = require("../.gen/providers/aws/route-table");
const route_table_association_1 = require("../.gen/providers/aws/route-table-association");
const s3_bucket_1 = require("../.gen/providers/aws/s3-bucket");
const subnet_1 = require("../.gen/providers/aws/subnet");
const vpc_1 = require("../.gen/providers/aws/vpc");
const cloud_1 = require("../cloud");
const ex_1 = require("../ex");
const resource_names_1 = require("../shared/resource-names");
const domain_1 = require("../shared-aws/domain");
const app_1 = require("../shared-tf/app");
const std_1 = require("../std");
/**
 * An app that knows how to synthesize constructs into a Terraform configuration
 * for AWS resources.
 */
class App extends app_1.CdktfApp {
    constructor(props) {
        super(props);
        this._target = "tf-aws";
        new provider_1.AwsProvider(this, "aws", {});
        this.subnets = {
            private: [],
            public: [],
        };
        test_runner_1.TestRunner._createTree(this, props.rootConstruct);
    }
    typeForFqn(fqn) {
        switch (fqn) {
            case cloud_1.API_FQN:
                return api_1.Api;
            case cloud_1.FUNCTION_FQN:
                return function_1.Function;
            case cloud_1.BUCKET_FQN:
                return bucket_1.Bucket;
            case cloud_1.QUEUE_FQN:
                return queue_1.Queue;
            case cloud_1.TOPIC_FQN:
                return topic_1.Topic;
            case cloud_1.COUNTER_FQN:
                return counter_1.Counter;
            case cloud_1.SCHEDULE_FQN:
                return schedule_1.Schedule;
            case ex_1.TABLE_FQN:
                return table_1.Table;
            case cloud_1.TOPIC_FQN:
                return topic_1.Topic;
            case std_1.TEST_RUNNER_FQN:
                return test_runner_1.TestRunner;
            case ex_1.REDIS_FQN:
                return redis_1.Redis;
            case cloud_1.WEBSITE_FQN:
                return website_1.Website;
            case cloud_1.SECRET_FQN:
                return secret_1.Secret;
            case cloud_1.ON_DEPLOY_FQN:
                return on_deploy_1.OnDeploy;
            case cloud_1.DOMAIN_FQN:
                return domain_1.Domain;
            case cloud_1.ENDPOINT_FQN:
                return endpoint_1.Endpoint;
        }
        return undefined;
    }
    /**
     * The AWS account ID of the App
     */
    get accountId() {
        if (!this.awsAccountIdProvider) {
            this.awsAccountIdProvider = new data_aws_caller_identity_1.DataAwsCallerIdentity(this, "account");
        }
        return this.awsAccountIdProvider.accountId;
    }
    /**
     * The AWS region of the App
     */
    get region() {
        if (!this.awsRegionProvider) {
            this.awsRegionProvider = new data_aws_region_1.DataAwsRegion(this, "Region");
        }
        return this.awsRegionProvider.name;
    }
    get codeBucket() {
        if (this._codeBucket) {
            return this._codeBucket;
        }
        const bucket = new s3_bucket_1.S3Bucket(this, "Code");
        const bucketPrefix = resource_names_1.ResourceNames.generateName(bucket, bucket_1.BUCKET_PREFIX_OPTS);
        bucket.bucketPrefix = bucketPrefix;
        this._codeBucket = bucket;
        return this._codeBucket;
    }
    /**
     * Returns the VPC for this app. Will create a new VPC if one does not exist.
     */
    get vpc() {
        if (this._vpc) {
            return this._vpc;
        }
        return this.parameters.value(`${this._target}/vpc`) === "existing"
            ? this.importExistingVpc()
            : this.createDefaultVpc();
    }
    importExistingVpc() {
        const vpcId = this.parameters.value(`${this._target}/vpc_id`);
        const privateSubnetIds = this.parameters.value(`${this._target}/private_subnet_ids`);
        const publicSubnetIds = this.parameters.value(`${this._target}/public_subnet_ids`);
        this._vpc = new data_aws_vpc_1.DataAwsVpc(this, "ExistingVpc", {
            id: vpcId,
        });
        for (const subnetId of privateSubnetIds) {
            this.subnets.private.push(new data_aws_subnet_1.DataAwsSubnet(this, `PrivateSubnet${subnetId.slice(-8)}`, {
                vpcId: vpcId,
                id: subnetId,
            }));
        }
        if (publicSubnetIds) {
            for (const subnetId of publicSubnetIds) {
                this.subnets.public.push(new data_aws_subnet_1.DataAwsSubnet(this, `PublicSubnet${subnetId.slice(-8)}`, {
                    vpcId: vpcId,
                    id: subnetId,
                }));
            }
        }
        return this._vpc;
    }
    createDefaultVpc() {
        const VPC_NAME_OPTS = {
            maxLen: 32,
            disallowedRegex: /[^a-zA-Z0-9-]/,
        };
        const identifier = resource_names_1.ResourceNames.generateName(this, VPC_NAME_OPTS);
        // create the app wide VPC
        this._vpc = new vpc_1.Vpc(this, "VPC", {
            cidrBlock: "10.0.0.0/16",
            enableDnsHostnames: true,
            enableDnsSupport: true,
            tags: {
                Name: `${identifier}-vpc`,
            },
        });
        // Create the subnets for the VPC, in order to ensure internet egress there
        // is a minimum requirement of 2 subnets, one public and one private. As well
        // as a NAT gateway and internet gateway. The NAT gateway is required to
        // allow the private subnet to route traffic to the internet. The internet
        // gateway is required to allow the NAT gateway to route traffic to the
        // internet.
        // Create the public subnet.
        // This subnet is intentionally small since most resources will be behind
        // private subnets. Incase that assumption is wrong this leaves room for 3 more /24 public subnets
        const publicSubnet = new subnet_1.Subnet(this, "PublicSubnet", {
            vpcId: this._vpc.id,
            cidrBlock: "10.0.0.0/24", // 10.0.0.0 - 10.0.0.255
            availabilityZone: `${this.region}a`,
            tags: {
                Name: `${identifier}-public-subnet-1`,
            },
        });
        // Create the private subnet
        const privateSubnet = new subnet_1.Subnet(this, "PrivateSubnet", {
            vpcId: this._vpc.id,
            cidrBlock: "10.0.4.0/22", // 10.0.4.0 - 10.0.7.255
            availabilityZone: `${this.region}a`,
            tags: {
                Name: `${identifier}-private-subnet-1`,
            },
        });
        const privateSubnet2 = new subnet_1.Subnet(this, "PrivateSubnet2", {
            vpcId: this._vpc.id,
            cidrBlock: "10.0.8.0/22", // 10.0.8.0 - 10.0.11.255
            availabilityZone: `${this.region}b`,
            tags: {
                Name: `${identifier}-private-subnet-2`,
            },
        });
        // Create the internet gateway
        const internetGateway = new internet_gateway_1.InternetGateway(this, "InternetGateway", {
            vpcId: this._vpc.id,
            tags: {
                Name: `${identifier}-internet-gateway`,
            },
        });
        // Create NAT gateway and Elastic IP for NAT
        const eip = new eip_1.Eip(this, "EIP", {});
        const nat = new nat_gateway_1.NatGateway(this, "NATGateway", {
            allocationId: eip.id,
            subnetId: publicSubnet.id,
            tags: {
                Name: `${identifier}-nat-gateway`,
            },
        });
        // Create route tables for public and private subnets
        const publicRouteTable = new route_table_1.RouteTable(this, "PublicRouteTable", {
            vpcId: this._vpc.id,
            route: [
                {
                    // This will route all traffic to the internet gateway
                    cidrBlock: "0.0.0.0/0",
                    gatewayId: internetGateway.id,
                },
            ],
            tags: {
                Name: `${identifier}-public-route-table-1`,
            },
        });
        const privateRouteTable = new route_table_1.RouteTable(this, "PrivateRouteTable", {
            vpcId: this._vpc.id,
            route: [
                {
                    // This will route all traffic to the NAT gateway
                    cidrBlock: "0.0.0.0/0",
                    natGatewayId: nat.id,
                },
            ],
            tags: {
                Name: `${identifier}-private-route-table-1`,
            },
        });
        const privateRouteTable2 = new route_table_1.RouteTable(this, "PrivateRouteTable2", {
            vpcId: this._vpc.id,
            route: [
                {
                    // This will route all traffic to the NAT gateway
                    cidrBlock: "0.0.0.0/0",
                    natGatewayId: nat.id,
                },
            ],
            tags: {
                Name: `${identifier}-private-route-table-2`,
            },
        });
        // Associate route tables with subnets
        new route_table_association_1.RouteTableAssociation(this, "PublicRouteTableAssociation", {
            subnetId: publicSubnet.id,
            routeTableId: publicRouteTable.id,
        });
        new route_table_association_1.RouteTableAssociation(this, "PrivateRouteTableAssociation", {
            subnetId: privateSubnet.id,
            routeTableId: privateRouteTable.id,
        });
        new route_table_association_1.RouteTableAssociation(this, "PrivateRouteTableAssociation2", {
            subnetId: privateSubnet2.id,
            routeTableId: privateRouteTable2.id,
        });
        this.subnets.public.push(publicSubnet);
        this.subnets.private.push(privateSubnet);
        this.subnets.private.push(privateSubnet2);
        return this._vpc;
    }
}
exports.App = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3RhcmdldC10Zi1hd3MvYXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQUE0QjtBQUM1QixxQ0FBc0Q7QUFDdEQsdUNBQW9DO0FBQ3BDLHlDQUFzQztBQUN0Qyx5Q0FBc0M7QUFDdEMsMkNBQXVDO0FBQ3ZDLG1DQUFnQztBQUNoQyxtQ0FBZ0M7QUFDaEMseUNBQXNDO0FBQ3RDLHFDQUFrQztBQUNsQyxtQ0FBZ0M7QUFDaEMsK0NBQTJDO0FBQzNDLG1DQUFnQztBQUNoQyx1Q0FBb0M7QUFDcEMsNkZBQXVGO0FBQ3ZGLDJFQUFzRTtBQUN0RSwyRUFBc0U7QUFDdEUscUVBQWdFO0FBQ2hFLG1EQUFnRDtBQUNoRCw2RUFBeUU7QUFDekUsbUVBQStEO0FBQy9ELDZEQUE2RDtBQUM3RCxtRUFBK0Q7QUFDL0QsMkZBQXNGO0FBQ3RGLCtEQUEyRDtBQUMzRCx5REFBc0Q7QUFDdEQsbURBQWdEO0FBQ2hELG9DQWFrQjtBQUVsQiw4QkFBNkM7QUFDN0MsNkRBQXNFO0FBQ3RFLGlEQUE4QztBQUM5QywwQ0FBNEM7QUFDNUMsZ0NBQXlDO0FBRXpDOzs7R0FHRztBQUNILE1BQWEsR0FBSSxTQUFRLGNBQVE7SUFXL0IsWUFBWSxLQUFlO1FBQ3pCLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQVhDLFlBQU8sR0FBRyxRQUFRLENBQUM7UUFZakMsSUFBSSxzQkFBVyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakMsSUFBSSxDQUFDLE9BQU8sR0FBRztZQUNiLE9BQU8sRUFBRSxFQUFFO1lBQ1gsTUFBTSxFQUFFLEVBQUU7U0FDWCxDQUFDO1FBRUYsd0JBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRVMsVUFBVSxDQUFDLEdBQVc7UUFDOUIsUUFBUSxHQUFHLEVBQUUs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QUMvRCxRQUFRLEVBQUUsY0FBYyxDQUFDLEVBQUU7WUFDM0IsWUFBWSxFQUFFLGtCQUFrQixDQUFDLEVBQUU7U0FDcEMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDMUMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7Q0FDRjtBQXRTRCxrQkFzU0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcGkgfSBmcm9tIFwiLi9hcGlcIjtcbmltcG9ydCB7IEJVQ0tFVF9QUkVGSVhfT1BUUywgQnVja2V0IH0gZnJvbSBcIi4vYnVja2V0XCI7XG5pbXBvcnQgeyBDb3VudGVyIH0gZnJvbSBcIi4vY291bnRlclwiO1xuaW1wb3J0IHsgRW5kcG9pbnQgfSBmcm9tIFwiLi9lbmRwb2ludFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gfSBmcm9tIFwiLi9mdW5jdGlvblwiO1xuaW1wb3J0IHsgT25EZXBsb3kgfSBmcm9tIFwiLi9vbi1kZXBsb3lcIjtcbmltcG9ydCB7IFF1ZXVlIH0gZnJvbSBcIi4vcXVldWVcIjtcbmltcG9ydCB7IFJlZGlzIH0gZnJvbSBcIi4vcmVkaXNcIjtcbmltcG9ydCB7IFNjaGVkdWxlIH0gZnJvbSBcIi4vc2NoZWR1bGVcIjtcbmltcG9ydCB7IFNlY3JldCB9IGZyb20gXCIuL3NlY3JldFwiO1xuaW1wb3J0IHsgVGFibGUgfSBmcm9tIFwiLi90YWJsZVwiO1xuaW1wb3J0IHsgVGVzdFJ1bm5lciB9IGZyb20gXCIuL3Rlc3QtcnVubmVyXCI7XG5pbXBvcnQgeyBUb3BpYyB9IGZyb20gXCIuL3RvcGljXCI7XG5pbXBvcnQgeyBXZWJzaXRlIH0gZnJvbSBcIi4vd2Vic2l0ZVwiO1xuaW1wb3J0IHsgRGF0YUF3c0NhbGxlcklkZW50aXR5IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9kYXRhLWF3cy1jYWxsZXItaWRlbnRpdHlcIjtcbmltcG9ydCB7IERhdGFBd3NSZWdpb24gfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL2RhdGEtYXdzLXJlZ2lvblwiO1xuaW1wb3J0IHsgRGF0YUF3c1N1Ym5ldCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvZGF0YS1hd3Mtc3VibmV0XCI7XG5pbXBvcnQgeyBEYXRhQXdzVnBjIH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9kYXRhLWF3cy12cGNcIjtcbmltcG9ydCB7IEVpcCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvZWlwXCI7XG5pbXBvcnQgeyBJbnRlcm5ldEdhdGV3YXkgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL2ludGVybmV0LWdhdGV3YXlcIjtcbmltcG9ydCB7IE5hdEdhdGV3YXkgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL25hdC1nYXRld2F5XCI7XG5pbXBvcnQgeyBBd3NQcm92aWRlciB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvcHJvdmlkZXJcIjtcbmltcG9ydCB7IFJvdXRlVGFibGUgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL3JvdXRlLXRhYmxlXCI7XG5pbXBvcnQgeyBSb3V0ZVRhYmxlQXNzb2NpYXRpb24gfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL3JvdXRlLXRhYmxlLWFzc29jaWF0aW9uXCI7XG5pbXBvcnQgeyBTM0J1Y2tldCB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvczMtYnVja2V0XCI7XG5pbXBvcnQgeyBTdWJuZXQgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL3N1Ym5ldFwiO1xuaW1wb3J0IHsgVnBjIH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy92cGNcIjtcbmltcG9ydCB7XG4gIEFQSV9GUU4sXG4gIEJVQ0tFVF9GUU4sXG4gIENPVU5URVJfRlFOLFxuICBET01BSU5fRlFOLFxuICBFTkRQT0lOVF9GUU4sXG4gIEZVTkNUSU9OX0ZRTixcbiAgT05fREVQTE9ZX0ZRTixcbiAgUVVFVUVfRlFOLFxuICBTQ0hFRFVMRV9GUU4sXG4gIFNFQ1JFVF9GUU4sXG4gIFRPUElDX0ZRTixcbiAgV0VCU0lURV9GUU4sXG59IGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0IHsgQXBwUHJvcHMgfSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgVEFCTEVfRlFOLCBSRURJU19GUU4gfSBmcm9tIFwiLi4vZXhcIjtcbmltcG9ydCB7IE5hbWVPcHRpb25zLCBSZXNvdXJjZU5hbWVzIH0gZnJvbSBcIi4uL3NoYXJlZC9yZXNvdXJjZS1uYW1lc1wiO1xuaW1wb3J0IHsgRG9tYWluIH0gZnJvbSBcIi4uL3NoYXJlZC1hd3MvZG9tYWluXCI7XG5pbXBvcnQgeyBDZGt0ZkFwcCB9IGZyb20gXCIuLi9zaGFyZWQtdGYvYXBwXCI7XG5pbXBvcnQgeyBURVNUX1JVTk5FUl9GUU4gfSBmcm9tIFwiLi4vc3RkXCI7XG5cbi8qKlxuICogQW4gYXBwIHRoYXQga25vd3MgaG93IHRvIHN5bnRoZXNpemUgY29uc3RydWN0cyBpbnRvIGEgVGVycmFmb3JtIGNvbmZpZ3VyYXRpb25cbiAqIGZvciBBV1MgcmVzb3VyY2VzLlxuICovXG5leHBvcnQgY2xhc3MgQXBwIGV4dGVuZHMgQ2RrdGZBcHAge1xuICBwdWJsaWMgcmVhZG9ubHkgX3RhcmdldCA9IFwidGYtYXdzXCI7XG5cbiAgcHJpdmF0ZSBhd3NSZWdpb25Qcm92aWRlcj86IERhdGFBd3NSZWdpb247XG4gIHByaXZhdGUgYXdzQWNjb3VudElkUHJvdmlkZXI/OiBEYXRhQXdzQ2FsbGVySWRlbnRpdHk7XG4gIHByaXZhdGUgX3ZwYz86IFZwYyB8IERhdGFBd3NWcGM7XG4gIHByaXZhdGUgX2NvZGVCdWNrZXQ/OiBTM0J1Y2tldDtcblxuICAvKiogU3VibmV0cyBzaGFyZWQgYWNyb3NzIGFwcCAqL1xuICBwdWJsaWMgc3VibmV0czogeyBba2V5OiBzdHJpbmddOiAoU3VibmV0IHwgRGF0YUF3c1N1Ym5ldClbXSB9O1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBBcHBQcm9wcykge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgICBuZXcgQXdzUHJvdmlkZXIodGhpcywgXCJhd3NcIiwge30pO1xuXG4gICAgdGhpcy5zdWJuZXRzID0ge1xuICAgICAgcHJpdmF0ZTogW10sXG4gICAgICBwdWJsaWM6IFtdLFxuICAgIH07XG5cbiAgICBUZXN0UnVubmVyLl9jcmVhdGVUcmVlKHRoaXMsIHByb3BzLnJvb3RDb25zdHJ1Y3QpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHR5cGVGb3JGcW4oZnFuOiBzdHJpbmcpOiBhbnkge1xuICAgIHN3aXRjaCAoZnFuKSB7XG4gICAgICBjYXNlIEFQSV9GUU46XG4gICAgICAgIHJldHVybiBBcGk7XG5cbiAgICAgIGNhc2UgRlVOQ1RJT05fRlFOOlxuICAgICAgICByZXR1cm4gRnVuY3Rpb247XG5cbiAgICAgIGNhc2UgQlVDS0VUX0ZRTjpcbiAgICAgICAgcmV0dXJuIEJ1Y2tldDtcblxuICAgICAgY2FzZSBRVUVVRV9GUU46XG4gICAgICAgIHJldHVybiBRdWV1ZTtcblxuICAgICAgY2FzZSBUT1BJQ19GUU46XG4gICAgICAgIHJldHVybiBUb3BpYztcblxuICAgICAgY2FzZSBDT1VOVEVSX0ZRTjpcbiAgICAgICAgcmV0dXJuIENvdW50ZXI7XG5cbiAgICAgIGNhc2UgU0NIRURVTEVfRlFOOlxuICAgICAgICByZXR1cm4gU2NoZWR1bGU7XG5cbiAgICAgIGNhc2UgVEFCTEVfRlFOOlxuICAgICAgICByZXR1cm4gVGFibGU7XG5cbiAgICAgIGNhc2UgVE9QSUNfRlFOOlxuICAgICAgICByZXR1cm4gVG9waWM7XG5cbiAgICAgIGNhc2UgVEVTVF9SVU5ORVJfRlFOOlxuICAgICAgICByZXR1cm4gVGVzdFJ1bm5lcjtcblxuICAgICAgY2FzZSBSRURJU19GUU46XG4gICAgICAgIHJldHVybiBSZWRpcztcblxuICAgICAgY2FzZSBXRUJTSVRFX0ZRTjpcbiAgICAgICAgcmV0dXJuIFdlYnNpdGU7XG5cbiAgICAgIGNhc2UgU0VDUkVUX0ZRTjpcbiAgICAgICAgcmV0dXJuIFNlY3JldDtcblxuICAgICAgY2FzZSBPTl9ERVBMT1lfRlFOOlxuICAgICAgICByZXR1cm4gT25EZXBsb3k7XG5cbiAgICAgIGNhc2UgRE9NQUlOX0ZRTjpcbiAgICAgICAgcmV0dXJuIERvbWFpbjtcblxuICAgICAgY2FzZSBFTkRQT0lOVF9GUU46XG4gICAgICAgIHJldHVybiBFbmRwb2ludDtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBBV1MgYWNjb3VudCBJRCBvZiB0aGUgQXBwXG4gICAqL1xuICBwdWJsaWMgZ2V0IGFjY291bnRJZCgpOiBzdHJpbmcge1xuICAgIGlmICghdGhpcy5hd3NBY2NvdW50SWRQcm92aWRlcikge1xuICAgICAgdGhpcy5hd3NBY2NvdW50SWRQcm92aWRlciA9IG5ldyBEYXRhQXdzQ2FsbGVySWRlbnRpdHkodGhpcywgXCJhY2NvdW50XCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5hd3NBY2NvdW50SWRQcm92aWRlci5hY2NvdW50SWQ7XG4gIH1cblxuICAvKipcbiAgICogVGhlIEFXUyByZWdpb24gb2YgdGhlIEFwcFxuICAgKi9cbiAgcHVibGljIGdldCByZWdpb24oKTogc3RyaW5nIHtcbiAgICBpZiAoIXRoaXMuYXdzUmVnaW9uUHJvdmlkZXIpIHtcbiAgICAgIHRoaXMuYXdzUmVnaW9uUHJvdmlkZXIgPSBuZXcgRGF0YUF3c1JlZ2lvbih0aGlzLCBcIlJlZ2lvblwiKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYXdzUmVnaW9uUHJvdmlkZXIubmFtZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY29kZUJ1Y2tldCgpOiBTM0J1Y2tldCB7XG4gICAgaWYgKHRoaXMuX2NvZGVCdWNrZXQpIHtcbiAgICAgIHJldHVybiB0aGlzLl9jb2RlQnVja2V0O1xuICAgIH1cbiAgICBjb25zdCBidWNrZXQgPSBuZXcgUzNCdWNrZXQodGhpcywgXCJDb2RlXCIpO1xuICAgIGNvbnN0IGJ1Y2tldFByZWZpeCA9IFJlc291cmNlTmFtZXMuZ2VuZXJhdGVOYW1lKGJ1Y2tldCwgQlVDS0VUX1BSRUZJWF9PUFRTKTtcbiAgICBidWNrZXQuYnVja2V0UHJlZml4ID0gYnVja2V0UHJlZml4O1xuICAgIHRoaXMuX2NvZGVCdWNrZXQgPSBidWNrZXQ7XG4gICAgcmV0dXJuIHRoaXMuX2NvZGVCdWNrZXQ7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgVlBDIGZvciB0aGlzIGFwcC4gV2lsbCBjcmVhdGUgYSBuZXcgVlBDIGlmIG9uZSBkb2VzIG5vdCBleGlzdC5cbiAgICovXG4gIHB1YmxpYyBnZXQgdnBjKCk6IFZwYyB8IERhdGFBd3NWcGMge1xuICAgIGlmICh0aGlzLl92cGMpIHtcbiAgICAgIHJldHVybiB0aGlzLl92cGM7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucGFyYW1ldGVycy52YWx1ZShgJHt0aGlzLl90YXJnZXR9L3ZwY2ApID09PSBcImV4aXN0aW5nXCJcbiAgICAgID8gdGhpcy5pbXBvcnRFeGlzdGluZ1ZwYygpXG4gICAgICA6IHRoaXMuY3JlYXRlRGVmYXVsdFZwYygpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbXBvcnRFeGlzdGluZ1ZwYygpOiBEYXRhQXdzVnBjIHtcbiAgICBjb25zdCB2cGNJZCA9IHRoaXMucGFyYW1ldGVycy52YWx1ZShgJHt0aGlzLl90YXJnZXR9L3ZwY19pZGApO1xuICAgIGNvbnN0IHByaXZhdGVTdWJuZXRJZHMgPSB0aGlzLnBhcmFtZXRlcnMudmFsdWUoXG4gICAgICBgJHt0aGlzLl90YXJnZXR9L3ByaXZhdGVfc3VibmV0X2lkc2BcbiAgICApO1xuICAgIGNvbnN0IHB1YmxpY1N1Ym5ldElkcyA9IHRoaXMucGFyYW1ldGVycy52YWx1ZShcbiAgICAgIGAke3RoaXMuX3RhcmdldH0vcHVibGljX3N1Ym5ldF9pZHNgXG4gICAgKTtcblxuICAgIHRoaXMuX3ZwYyA9IG5ldyBEYXRhQXdzVnBjKHRoaXMsIFwiRXhpc3RpbmdWcGNcIiwge1xuICAgICAgaWQ6IHZwY0lkLFxuICAgIH0pO1xuXG4gICAgZm9yIChjb25zdCBzdWJuZXRJZCBvZiBwcml2YXRlU3VibmV0SWRzKSB7XG4gICAgICB0aGlzLnN1Ym5ldHMucHJpdmF0ZS5wdXNoKFxuICAgICAgICBuZXcgRGF0YUF3c1N1Ym5ldCh0aGlzLCBgUHJpdmF0ZVN1Ym5ldCR7c3VibmV0SWQuc2xpY2UoLTgpfWAsIHtcbiAgICAgICAgICB2cGNJZDogdnBjSWQsXG4gICAgICAgICAgaWQ6IHN1Ym5ldElkLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAocHVibGljU3VibmV0SWRzKSB7XG4gICAgICBmb3IgKGNvbnN0IHN1Ym5ldElkIG9mIHB1YmxpY1N1Ym5ldElkcykge1xuICAgICAgICB0aGlzLnN1Ym5ldHMucHVibGljLnB1c2goXG4gICAgICAgICAgbmV3IERhdGFBd3NTdWJuZXQodGhpcywgYFB1YmxpY1N1Ym5ldCR7c3VibmV0SWQuc2xpY2UoLTgpfWAsIHtcbiAgICAgICAgICAgIHZwY0lkOiB2cGNJZCxcbiAgICAgICAgICAgIGlkOiBzdWJuZXRJZCxcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl92cGM7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZURlZmF1bHRWcGMoKTogVnBjIHtcbiAgICBjb25zdCBWUENfTkFNRV9PUFRTOiBOYW1lT3B0aW9ucyA9IHtcbiAgICAgIG1heExlbjogMzIsXG4gICAgICBkaXNhbGxvd2VkUmVnZXg6IC9bXmEtekEtWjAtOS1dLyxcbiAgICB9O1xuICAgIGNvbnN0IGlkZW50aWZpZXIgPSBSZXNvdXJjZU5hbWVzLmdlbmVyYXRlTmFtZSh0aGlzLCBWUENfTkFNRV9PUFRTKTtcblxuICAgIC8vIGNyZWF0ZSB0aGUgYXBwIHdpZGUgVlBDXG4gICAgdGhpcy5fdnBjID0gbmV3IFZwYyh0aGlzLCBcIlZQQ1wiLCB7XG4gICAgICBjaWRyQmxvY2s6IFwiMTAuMC4wLjAvMTZcIixcbiAgICAgIGVuYWJsZURuc0hvc3RuYW1lczogdHJ1ZSxcbiAgICAgIGVuYWJsZURuc1N1cHBvcnQ6IHRydWUsXG4gICAgICB0YWdzOiB7XG4gICAgICAgIE5hbWU6IGAke2lkZW50aWZpZXJ9LXZwY2AsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIHRoZSBzdWJuZXRzIGZvciB0aGUgVlBDLCBpbiBvcmRlciB0byBlbnN1cmUgaW50ZXJuZXQgZWdyZXNzIHRoZXJlXG4gICAgLy8gaXMgYSBtaW5pbXVtIHJlcXVpcmVtZW50IG9mIDIgc3VibmV0cywgb25lIHB1YmxpYyBhbmQgb25lIHByaXZhdGUuIEFzIHdlbGxcbiAgICAvLyBhcyBhIE5BVCBnYXRld2F5IGFuZCBpbnRlcm5ldCBnYXRld2F5LiBUaGUgTkFUIGdhdGV3YXkgaXMgcmVxdWlyZWQgdG9cbiAgICAvLyBhbGxvdyB0aGUgcHJpdmF0ZSBzdWJuZXQgdG8gcm91dGUgdHJhZmZpYyB0byB0aGUgaW50ZXJuZXQuIFRoZSBpbnRlcm5ldFxuICAgIC8vIGdhdGV3YXkgaXMgcmVxdWlyZWQgdG8gYWxsb3cgdGhlIE5BVCBnYXRld2F5IHRvIHJvdXRlIHRyYWZmaWMgdG8gdGhlXG4gICAgLy8gaW50ZXJuZXQuXG5cbiAgICAvLyBDcmVhdGUgdGhlIHB1YmxpYyBzdWJuZXQuXG4gICAgLy8gVGhpcyBzdWJuZXQgaXMgaW50ZW50aW9uYWxseSBzbWFsbCBzaW5jZSBtb3N0IHJlc291cmNlcyB3aWxsIGJlIGJlaGluZFxuICAgIC8vIHByaXZhdGUgc3VibmV0cy4gSW5jYXNlIHRoYXQgYXNzdW1wdGlvbiBpcyB3cm9uZyB0aGlzIGxlYXZlcyByb29tIGZvciAzIG1vcmUgLzI0IHB1YmxpYyBzdWJuZXRzXG4gICAgY29uc3QgcHVibGljU3VibmV0ID0gbmV3IFN1Ym5ldCh0aGlzLCBcIlB1YmxpY1N1Ym5ldFwiLCB7XG4gICAgICB2cGNJZDogdGhpcy5fdnBjLmlkLFxuICAgICAgY2lkckJsb2NrOiBcIjEwLjAuMC4wLzI0XCIsIC8vIDEwLjAuMC4wIC0gMTAuMC4wLjI1NVxuICAgICAgYXZhaWxhYmlsaXR5Wm9uZTogYCR7dGhpcy5yZWdpb259YWAsXG4gICAgICB0YWdzOiB7XG4gICAgICAgIE5hbWU6IGAke2lkZW50aWZpZXJ9LXB1YmxpYy1zdWJuZXQtMWAsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIHRoZSBwcml2YXRlIHN1Ym5ldFxuICAgIGNvbnN0IHByaXZhdGVTdWJuZXQgPSBuZXcgU3VibmV0KHRoaXMsIFwiUHJpdmF0ZVN1Ym5ldFwiLCB7XG4gICAgICB2cGNJZDogdGhpcy5fdnBjLmlkLFxuICAgICAgY2lkckJsb2NrOiBcIjEwLjAuNC4wLzIyXCIsIC8vIDEwLjAuNC4wIC0gMTAuMC43LjI1NVxuICAgICAgYXZhaWxhYmlsaXR5Wm9uZTogYCR7dGhpcy5yZWdpb259YWAsXG4gICAgICB0YWdzOiB7XG4gICAgICAgIE5hbWU6IGAke2lkZW50aWZpZXJ9LXByaXZhdGUtc3VibmV0LTFgLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHByaXZhdGVTdWJuZXQyID0gbmV3IFN1Ym5ldCh0aGlzLCBcIlByaXZhdGVTdWJuZXQyXCIsIHtcbiAgICAgIHZwY0lkOiB0aGlzLl92cGMuaWQsXG4gICAgICBjaWRyQmxvY2s6IFwiMTAuMC44LjAvMjJcIiwgLy8gMTAuMC44LjAgLSAxMC4wLjExLjI1NVxuICAgICAgYXZhaWxhYmlsaXR5Wm9uZTogYCR7dGhpcy5yZWdpb259YmAsXG4gICAgICB0YWdzOiB7XG4gICAgICAgIE5hbWU6IGAke2lkZW50aWZpZXJ9LXByaXZhdGUtc3VibmV0LTJgLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSB0aGUgaW50ZXJuZXQgZ2F0ZXdheVxuICAgIGNvbnN0IGludGVybmV0R2F0ZXdheSA9IG5ldyBJbnRlcm5ldEdhdGV3YXkodGhpcywgXCJJbnRlcm5ldEdhdGV3YXlcIiwge1xuICAgICAgdnBjSWQ6IHRoaXMuX3ZwYy5pZCxcbiAgICAgIHRhZ3M6IHtcbiAgICAgICAgTmFtZTogYCR7aWRlbnRpZmllcn0taW50ZXJuZXQtZ2F0ZXdheWAsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIE5BVCBnYXRld2F5IGFuZCBFbGFzdGljIElQIGZvciBOQVRcbiAgICBjb25zdCBlaXAgPSBuZXcgRWlwKHRoaXMsIFwiRUlQXCIsIHt9KTtcbiAgICBjb25zdCBuYXQgPSBuZXcgTmF0R2F0ZXdheSh0aGlzLCBcIk5BVEdhdGV3YXlcIiwge1xuICAgICAgYWxsb2NhdGlvbklkOiBlaXAuaWQsXG4gICAgICBzdWJuZXRJZDogcHVibGljU3VibmV0LmlkLFxuICAgICAgdGFnczoge1xuICAgICAgICBOYW1lOiBgJHtpZGVudGlmaWVyfS1uYXQtZ2F0ZXdheWAsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIHJvdXRlIHRhYmxlcyBmb3IgcHVibGljIGFuZCBwcml2YXRlIHN1Ym5ldHNcbiAgICBjb25zdCBwdWJsaWNSb3V0ZVRhYmxlID0gbmV3IFJvdXRlVGFibGUodGhpcywgXCJQdWJsaWNSb3V0ZVRhYmxlXCIsIHtcbiAgICAgIHZwY0lkOiB0aGlzLl92cGMuaWQsXG4gICAgICByb3V0ZTogW1xuICAgICAgICB7XG4gICAgICAgICAgLy8gVGhpcyB3aWxsIHJvdXRlIGFsbCB0cmFmZmljIHRvIHRoZSBpbnRlcm5ldCBnYXRld2F5XG4gICAgICAgICAgY2lkckJsb2NrOiBcIjAuMC4wLjAvMFwiLFxuICAgICAgICAgIGdhdGV3YXlJZDogaW50ZXJuZXRHYXRld2F5LmlkLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIHRhZ3M6IHtcbiAgICAgICAgTmFtZTogYCR7aWRlbnRpZmllcn0tcHVibGljLXJvdXRlLXRhYmxlLTFgLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHByaXZhdGVSb3V0ZVRhYmxlID0gbmV3IFJvdXRlVGFibGUodGhpcywgXCJQcml2YXRlUm91dGVUYWJsZVwiLCB7XG4gICAgICB2cGNJZDogdGhpcy5fdnBjLmlkLFxuICAgICAgcm91dGU6IFtcbiAgICAgICAge1xuICAgICAgICAgIC8vIFRoaXMgd2lsbCByb3V0ZSBhbGwgdHJhZmZpYyB0byB0aGUgTkFUIGdhdGV3YXlcbiAgICAgICAgICBjaWRyQmxvY2s6IFwiMC4wLjAuMC8wXCIsXG4gICAgICAgICAgbmF0R2F0ZXdheUlkOiBuYXQuaWQsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgdGFnczoge1xuICAgICAgICBOYW1lOiBgJHtpZGVudGlmaWVyfS1wcml2YXRlLXJvdXRlLXRhYmxlLTFgLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHByaXZhdGVSb3V0ZVRhYmxlMiA9IG5ldyBSb3V0ZVRhYmxlKHRoaXMsIFwiUHJpdmF0ZVJvdXRlVGFibGUyXCIsIHtcbiAgICAgIHZwY0lkOiB0aGlzLl92cGMuaWQsXG4gICAgICByb3V0ZTogW1xuICAgICAgICB7XG4gICAgICAgICAgLy8gVGhpcyB3aWxsIHJvdXRlIGFsbCB0cmFmZmljIHRvIHRoZSBOQVQgZ2F0ZXdheVxuICAgICAgICAgIGNpZHJCbG9jazogXCIwLjAuMC4wLzBcIixcbiAgICAgICAgICBuYXRHYXRld2F5SWQ6IG5hdC5pZCxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICB0YWdzOiB7XG4gICAgICAgIE5hbWU6IGAke2lkZW50aWZpZXJ9LXByaXZhdGUtcm91dGUtdGFibGUtMmAsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gQXNzb2NpYXRlIHJvdXRlIHRhYmxlcyB3aXRoIHN1Ym5ldHNcbiAgICBuZXcgUm91dGVUYWJsZUFzc29jaWF0aW9uKHRoaXMsIFwiUHVibGljUm91dGVUYWJsZUFzc29jaWF0aW9uXCIsIHtcbiAgICAgIHN1Ym5ldElkOiBwdWJsaWNTdWJuZXQuaWQsXG4gICAgICByb3V0ZVRhYmxlSWQ6IHB1YmxpY1JvdXRlVGFibGUuaWQsXG4gICAgfSk7XG5cbiAgICBuZXcgUm91dGVUYWJsZUFzc29jaWF0aW9uKHRoaXMsIFwiUHJpdmF0ZVJvdXRlVGFibGVBc3NvY2lhdGlvblwiLCB7XG4gICAgICBzdWJuZXRJZDogcHJpdmF0ZVN1Ym5ldC5pZCxcbiAgICAgIHJvdXRlVGFibGVJZDogcHJpdmF0ZVJvdXRlVGFibGUuaWQsXG4gICAgfSk7XG5cbiAgICBuZXcgUm91dGVUYWJsZUFzc29jaWF0aW9uKHRoaXMsIFwiUHJpdmF0ZVJvdXRlVGFibGVBc3NvY2lhdGlvbjJcIiwge1xuICAgICAgc3VibmV0SWQ6IHByaXZhdGVTdWJuZXQyLmlkLFxuICAgICAgcm91dGVUYWJsZUlkOiBwcml2YXRlUm91dGVUYWJsZTIuaWQsXG4gICAgfSk7XG5cbiAgICB0aGlzLnN1Ym5ldHMucHVibGljLnB1c2gocHVibGljU3VibmV0KTtcbiAgICB0aGlzLnN1Ym5ldHMucHJpdmF0ZS5wdXNoKHByaXZhdGVTdWJuZXQpO1xuICAgIHRoaXMuc3VibmV0cy5wcml2YXRlLnB1c2gocHJpdmF0ZVN1Ym5ldDIpO1xuICAgIHJldHVybiB0aGlzLl92cGM7XG4gIH1cbn1cbiJdfQ==