"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Topic = void 0;
const app_1 = require("./app");
const function_1 = require("./function");
const queue_1 = require("./queue");
const sns_topic_1 = require("../.gen/providers/aws/sns-topic");
const sns_topic_policy_1 = require("../.gen/providers/aws/sns-topic-policy");
const sns_topic_subscription_1 = require("../.gen/providers/aws/sns-topic-subscription");
const sqs_queue_policy_1 = require("../.gen/providers/aws/sqs-queue-policy");
const cloud = __importStar(require("../cloud"));
const core = __importStar(require("../core"));
const resource_names_1 = require("../shared/resource-names");
const shared_aws_1 = require("../shared-aws");
const permissions_1 = require("../shared-aws/permissions");
const topic_1 = require("../shared-aws/topic");
const std_1 = require("../std");
/**
 * Topic names are limited to 256 characters.
 * You can use alphanumeric characters, hyphens (-) and underscores (_).
 */
const NAME_OPTS = {
    maxLen: 256,
    disallowedRegex: /[^a-zA-Z0-9\_\-]+/g,
};
/**
 * AWS Implementation of `cloud.Topic`.
 *
 * @inflight `@winglang/sdk.cloud.ITopicClient`
 */
class Topic extends cloud.Topic {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        this.handlers = {};
        this.topic = new sns_topic_1.SnsTopic(this, "Default", {
            name: resource_names_1.ResourceNames.generateName(this, NAME_OPTS),
        });
    }
    onMessage(inflight, props = {}) {
        const functionHandler = topic_1.TopicOnMessageHandler.toFunctionHandler(inflight);
        let fn = this.handlers[inflight._id];
        if (fn) {
            return fn;
        }
        fn = new function_1.Function(
        // ok since we're not a tree root
        this.node.scope, app_1.App.of(this).makeId(this, `${this.node.id}-OnMessage`), functionHandler, props);
        this.handlers[inflight._id] = fn;
        // TODO: remove this constraint by adding generic permission APIs to cloud.Function
        if (!(fn instanceof function_1.Function)) {
            throw new Error("Topic only supports creating tfaws.Function right now");
        }
        new sns_topic_subscription_1.SnsTopicSubscription(this, app_1.App.of(this).makeId(this, "TopicSubscription"), {
            topicArn: this.topicArn,
            protocol: "lambda",
            endpoint: fn.functionArn,
        });
        fn.addPermissionToInvoke(this, "sns.amazonaws.com", this.topic.arn, {});
        std_1.Node.of(this).addConnection({
            source: this,
            sourceOp: cloud.TopicInflightMethods.PUBLISH,
            target: fn,
            targetOp: cloud.FunctionInflightMethods.INVOKE_ASYNC,
            name: "subscriber",
        });
        return fn;
    }
    subscribeQueue(queue) {
        if (!(queue instanceof queue_1.Queue)) {
            throw new Error("'subscribeQueue' allows only tfaws.Queue to be subscribed to the Topic");
        }
        new sns_topic_subscription_1.SnsTopicSubscription(this, app_1.App.of(this).makeId(this, "TopicSubscription"), {
            topicArn: this.topicArn,
            protocol: "sqs",
            endpoint: queue.queueArn,
            rawMessageDelivery: true,
        });
        new sqs_queue_policy_1.SqsQueuePolicy(this, `SqsQueuePolicy-${queue.node.addr}`, {
            queueUrl: queue.queueUrl,
            policy: JSON.stringify({
                Version: "2012-10-17",
                Statement: [
                    {
                        Effect: "Allow",
                        Principal: {
                            Service: "sns.amazonaws.com",
                        },
                        Action: "sqs:SendMessage",
                        Resource: `${queue.queueArn}`,
                        Condition: {
                            ArnEquals: {
                                "aws:SourceArn": `${this.topicArn}`,
                            },
                        },
                    },
                ],
            }),
        });
    }
    /**
     * Grants the given identity permissions to publish this topic.
     * @param source the resource that will publish to the topic
     * @param principal The AWS principal to grant publish permissions to (e.g. "s3.amazonaws.com", "events.amazonaws.com", "sns.amazonaws.com")
     * @param sourceArn source arn
     */
    addPermissionToPublish(source, principal, sourceArn) {
        this.permissions = new sns_topic_policy_1.SnsTopicPolicy(this, `PublishPermission-${source.node.addr}`, {
            arn: this.topic.arn,
            policy: JSON.stringify({
                Statement: [
                    {
                        Effect: "Allow",
                        Principal: {
                            Service: principal,
                        },
                        Action: "sns:Publish",
                        Resource: this.topic.arn,
                        Condition: {
                            ArnEquals: {
                                "aws:SourceArn": sourceArn,
                            },
                        },
                    },
                ],
            }),
        });
    }
    onLift(host, ops) {
        if (!shared_aws_1.AwsInflightHost.isAwsInflightHost(host)) {
            throw new Error("Host is expected to implement `IAwsInfightHost`");
        }
        host.addPolicyStatements(...(0, permissions_1.calculateTopicPermissions)(this.topic.arn, ops));
        host.addEnvironment(this.envName(), this.topic.arn);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core.InflightClient.for(__dirname.replace("target-tf-aws", "shared-aws"), __filename, "TopicClient", [`process.env["${this.envName()}"]`]);
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud.TopicInflightMethods.PUBLISH]: [],
        };
    }
    envName() {
        return `TOPIC_ARN_${this.node.addr.slice(-8)}`;
    }
    get topicArn() {
        return this.topic.arn;
    }
    get topicName() {
        return this.topic.name;
    }
}
exports.Topic = Topic;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9waWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXRmLWF3cy90b3BpYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLCtCQUE0QjtBQUM1Qix5Q0FBc0M7QUFDdEMsbUNBQWdDO0FBQ2hDLCtEQUEyRDtBQUMzRCw2RUFBd0U7QUFDeEUseUZBQW9GO0FBQ3BGLDZFQUF3RTtBQUN4RSxnREFBa0M7QUFDbEMsOENBQWdDO0FBQ2hDLDZEQUFzRTtBQUN0RSw4Q0FBZ0Q7QUFDaEQsMkRBQXNFO0FBQ3RFLCtDQUF1RTtBQUN2RSxnQ0FBdUQ7QUFFdkQ7OztHQUdHO0FBQ0gsTUFBTSxTQUFTLEdBQWdCO0lBQzdCLE1BQU0sRUFBRSxHQUFHO0lBQ1gsZUFBZSxFQUFFLG9CQUFvQjtDQUN0QyxDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQWEsS0FBTSxTQUFRLEtBQUssQ0FBQyxLQUFLO0lBU3BDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBMEIsRUFBRTtRQUNwRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQVJULGFBQVEsR0FBNkIsRUFBRSxDQUFDO1FBVXZELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxvQkFBUSxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUU7WUFDekMsSUFBSSxFQUFFLDhCQUFhLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxTQUFTLENBQUM7U0FDbEQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLFNBQVMsQ0FDZCxRQUFzQyxFQUN0QyxRQUFxQyxFQUFFO1FBRXZDLE1BQU0sZUFBZSxHQUFHLDZCQUFxQixDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3JDLElBQUks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QUMsY0FBYyxDQUFDLEdBQUcsQ0FDNUIsU0FBUyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsWUFBWSxDQUFDLEVBQ2hELFVBQVUsRUFDVixhQUFhLEVBQ2IsQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FDckMsQ0FBQztJQUNKLENBQUM7SUFDRCxnQkFBZ0I7SUFDaEIsSUFBVyxRQUFRO1FBQ2pCLE9BQU87WUFDTCxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFO1NBQ3pDLENBQUM7SUFDSixDQUFDO0lBRU8sT0FBTztRQUNiLE9BQU8sYUFBYSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ2pELENBQUM7SUFFRCxJQUFXLFFBQVE7UUFDakIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztJQUN4QixDQUFDO0lBRUQsSUFBVyxTQUFTO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7SUFDekIsQ0FBQztDQUNGO0FBckxELHNCQXFMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9hcHBcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIH0gZnJvbSBcIi4vZnVuY3Rpb25cIjtcbmltcG9ydCB7IFF1ZXVlIH0gZnJvbSBcIi4vcXVldWVcIjtcbmltcG9ydCB7IFNuc1RvcGljIH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9zbnMtdG9waWNcIjtcbmltcG9ydCB7IFNuc1RvcGljUG9saWN5IH0gZnJvbSBcIi4uLy5nZW4vcHJvdmlkZXJzL2F3cy9zbnMtdG9waWMtcG9saWN5XCI7XG5pbXBvcnQgeyBTbnNUb3BpY1N1YnNjcmlwdGlvbiB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3Mvc25zLXRvcGljLXN1YnNjcmlwdGlvblwiO1xuaW1wb3J0IHsgU3FzUXVldWVQb2xpY3kgfSBmcm9tIFwiLi4vLmdlbi9wcm92aWRlcnMvYXdzL3Nxcy1xdWV1ZS1wb2xpY3lcIjtcbmltcG9ydCAqIGFzIGNsb3VkIGZyb20gXCIuLi9jbG91ZFwiO1xuaW1wb3J0ICogYXMgY29yZSBmcm9tIFwiLi4vY29yZVwiO1xuaW1wb3J0IHsgTmFtZU9wdGlvbnMsIFJlc291cmNlTmFtZXMgfSBmcm9tIFwiLi4vc2hhcmVkL3Jlc291cmNlLW5hbWVzXCI7XG5pbXBvcnQgeyBBd3NJbmZsaWdodEhvc3QgfSBmcm9tIFwiLi4vc2hhcmVkLWF3c1wiO1xuaW1wb3J0IHsgY2FsY3VsYXRlVG9waWNQZXJtaXNzaW9ucyB9IGZyb20gXCIuLi9zaGFyZWQtYXdzL3Blcm1pc3Npb25zXCI7XG5pbXBvcnQgeyBJQXdzVG9waWMsIFRvcGljT25NZXNzYWdlSGFuZGxlciB9IGZyb20gXCIuLi9zaGFyZWQtYXdzL3RvcGljXCI7XG5pbXBvcnQgeyBJSW5mbGlnaHRIb3N0LCBOb2RlLCBSZXNvdXJjZSB9IGZyb20gXCIuLi9zdGRcIjtcblxuLyoqXG4gKiBUb3BpYyBuYW1lcyBhcmUgbGltaXRlZCB0byAyNTYgY2hhcmFjdGVycy5cbiAqIFlvdSBjYW4gdXNlIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzLCBoeXBoZW5zICgtKSBhbmQgdW5kZXJzY29yZXMgKF8pLlxuICovXG5jb25zdCBOQU1FX09QVFM6IE5hbWVPcHRpb25zID0ge1xuICBtYXhMZW46IDI1NixcbiAgZGlzYWxsb3dlZFJlZ2V4OiAvW15hLXpBLVowLTlcXF9cXC1dKy9nLFxufTtcblxuLyoqXG4gKiBBV1MgSW1wbGVtZW50YXRpb24gb2YgYGNsb3VkLlRvcGljYC5cbiAqXG4gKiBAaW5mbGlnaHQgYEB3aW5nbGFuZy9zZGsuY2xvdWQuSVRvcGljQ2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgVG9waWMgZXh0ZW5kcyBjbG91ZC5Ub3BpYyBpbXBsZW1lbnRzIElBd3NUb3BpYyB7XG4gIHByaXZhdGUgcmVhZG9ubHkgdG9waWM6IFNuc1RvcGljO1xuICBwcml2YXRlIHJlYWRvbmx5IGhhbmRsZXJzOiBSZWNvcmQ8c3RyaW5nLCBGdW5jdGlvbj4gPSB7fTtcbiAgLyoqXG4gICAqIFRvcGljJ3MgcHVibGlzaGluZyBwZXJtaXNzaW9ucy4gY2FuIGJlIHVzZSBhcyBhIGRlcGVuZGVuY3kgb2YgYW5vdGhlciByZXNvdXJjZS5cbiAgICogKHRoZSBvbmUgdGhhdCBnb3QgdGhlIHBlcm1pc3Npb25zIHRvIHB1Ymxpc2gpXG4gICAqICovXG4gIHB1YmxpYyBwZXJtaXNzaW9ucyE6IFNuc1RvcGljUG9saWN5O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBjbG91ZC5Ub3BpY1Byb3BzID0ge30pIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIHRoaXMudG9waWMgPSBuZXcgU25zVG9waWModGhpcywgXCJEZWZhdWx0XCIsIHtcbiAgICAgIG5hbWU6IFJlc291cmNlTmFtZXMuZ2VuZXJhdGVOYW1lKHRoaXMsIE5BTUVfT1BUUyksXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgb25NZXNzYWdlKFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JVG9waWNPbk1lc3NhZ2VIYW5kbGVyLFxuICAgIHByb3BzOiBjbG91ZC5Ub3BpY09uTWVzc2FnZU9wdGlvbnMgPSB7fVxuICApOiBjbG91ZC5GdW5jdGlvbiB7XG4gICAgY29uc3QgZnVuY3Rpb25IYW5kbGVyID0gVG9waWNPbk1lc3NhZ2VIYW5kbGVyLnRvRnVuY3Rpb25IYW5kbGVyKGluZmxpZ2h0KTtcbiAgICBsZXQgZm4gPSB0aGlzLmhhbmRsZXJzW2luZmxpZ2h0Ll9pZF07XG4gICAgaWYgKGZuKSB7XG4gICAgICByZXR1cm4gZm47XG4gICAgfVxuXG4gICAgZm4gPSBuZXcgRnVuY3Rpb24oXG4gICAgICAvLyBvayBzaW5jZSB3ZSdyZSBub3QgYSB0cmVlIHJvb3RcbiAgICAgIHRoaXMubm9kZS5zY29wZSEsXG4gICAgICBBcHAub2YodGhpcykubWFrZUlkKHRoaXMsIGAke3RoaXMubm9kZS5pZH0tT25NZXNzYWdlYCksXG4gICAgICBmdW5jdGlvbkhhbmRsZXIsXG4gICAgICBwcm9wc1xuICAgICk7XG4gICAgdGhpcy5oYW5kbGVyc1tpbmZsaWdodC5faWRdID0gZm47XG5cbiAgICAvLyBUT0RPOiByZW1vdmUgdGhpcyBjb25zdHJhaW50IGJ5IGFkZGluZyBnZW5lcmljIHBlcm1pc3Npb24gQVBJcyB0byBjbG91ZC5GdW5jdGlvblxuICAgIGlmICghKGZuIGluc3RhbmNlb2YgRnVuY3Rpb24pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUb3BpYyBvbmx5IHN1cHBvcnRzIGNyZWF0aW5nIHRmYXdzLkZ1bmN0aW9uIHJpZ2h0IG5vd1wiKTtcbiAgICB9XG5cbiAgICBuZXcgU25zVG9waWNTdWJzY3JpcHRpb24oXG4gICAgICB0aGlzLFxuICAgICAgQXBwLm9mKHRoaXMpLm1ha2VJZCh0aGlzLCBcIlRvcGljU3Vic2NyaXB0aW9uXCIpLFxuICAgICAge1xuICAgICAgICB0b3BpY0FybjogdGhpcy50b3BpY0FybixcbiAgICAgICAgcHJvdG9jb2w6IFwibGFtYmRhXCIsXG4gICAgICAgIGVuZHBvaW50OiBmbi5mdW5jdGlvbkFybixcbiAgICAgIH1cbiAgICApO1xuXG4gICAgZm4uYWRkUGVybWlzc2lvblRvSW52b2tlKHRoaXMsIFwic25zLmFtYXpvbmF3cy5jb21cIiwgdGhpcy50b3BpYy5hcm4sIHt9KTtcblxuICAgIE5vZGUub2YodGhpcykuYWRkQ29ubmVjdGlvbih7XG4gICAgICBzb3VyY2U6IHRoaXMsXG4gICAgICBzb3VyY2VPcDogY2xvdWQuVG9waWNJbmZsaWdodE1ldGhvZHMuUFVCTElTSCxcbiAgICAgIHRhcmdldDogZm4sXG4gICAgICB0YXJnZXRPcDogY2xvdWQuRnVuY3Rpb25JbmZsaWdodE1ldGhvZHMuSU5WT0tFX0FTWU5DLFxuICAgICAgbmFtZTogXCJzdWJzY3JpYmVyXCIsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gZm47XG4gIH1cblxuICBwdWJsaWMgc3Vic2NyaWJlUXVldWUocXVldWU6IGNsb3VkLlF1ZXVlKTogdm9pZCB7XG4gICAgaWYgKCEocXVldWUgaW5zdGFuY2VvZiBRdWV1ZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCInc3Vic2NyaWJlUXVldWUnIGFsbG93cyBvbmx5IHRmYXdzLlF1ZXVlIHRvIGJlIHN1YnNjcmliZWQgdG8gdGhlIFRvcGljXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbmV3IFNuc1RvcGljU3Vic2NyaXB0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIEFwcC5vZih0aGlzKS5tYWtlSWQodGhpcywgXCJUb3BpY1N1YnNjcmlwdGlvblwiKSxcbiAgICAgIHtcbiAgICAgICAgdG9waWNBcm46IHRoaXMudG9waWNBcm4sXG4gICAgICAgIHByb3RvY29sOiBcInNxc1wiLFxuICAgICAgICBlbmRwb2ludDogcXVldWUucXVldWVBcm4sXG4gICAgICAgIHJhd01lc3NhZ2VEZWxpdmVyeTogdHJ1ZSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgbmV3IFNxc1F1ZXVlUG9saWN5KHRoaXMsIGBTcXNRdWV1ZVBvbGljeS0ke3F1ZXVlLm5vZGUuYWRkcn1gLCB7XG4gICAgICBxdWV1ZVVybDogcXVldWUucXVldWVVcmwsXG4gICAgICBwb2xpY3k6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgVmVyc2lvbjogXCIyMDEyLTEwLTE3XCIsXG4gICAgICAgIFN0YXRlbWVudDogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIEVmZmVjdDogXCJBbGxvd1wiLFxuICAgICAgICAgICAgUHJpbmNpcGFsOiB7XG4gICAgICAgICAgICAgIFNlcnZpY2U6IFwic25zLmFtYXpvbmF3cy5jb21cIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBBY3Rpb246IFwic3FzOlNlbmRNZXNzYWdlXCIsXG4gICAgICAgICAgICBSZXNvdXJjZTogYCR7cXVldWUucXVldWVBcm59YCxcbiAgICAgICAgICAgIENvbmRpdGlvbjoge1xuICAgICAgICAgICAgICBBcm5FcXVhbHM6IHtcbiAgICAgICAgICAgICAgICBcImF3czpTb3VyY2VBcm5cIjogYCR7dGhpcy50b3BpY0Fybn1gLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSksXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR3JhbnRzIHRoZSBnaXZlbiBpZGVudGl0eSBwZXJtaXNzaW9ucyB0byBwdWJsaXNoIHRoaXMgdG9waWMuXG4gICAqIEBwYXJhbSBzb3VyY2UgdGhlIHJlc291cmNlIHRoYXQgd2lsbCBwdWJsaXNoIHRvIHRoZSB0b3BpY1xuICAgKiBAcGFyYW0gcHJpbmNpcGFsIFRoZSBBV1MgcHJpbmNpcGFsIHRvIGdyYW50IHB1Ymxpc2ggcGVybWlzc2lvbnMgdG8gKGUuZy4gXCJzMy5hbWF6b25hd3MuY29tXCIsIFwiZXZlbnRzLmFtYXpvbmF3cy5jb21cIiwgXCJzbnMuYW1hem9uYXdzLmNvbVwiKVxuICAgKiBAcGFyYW0gc291cmNlQXJuIHNvdXJjZSBhcm5cbiAgICovXG4gIHB1YmxpYyBhZGRQZXJtaXNzaW9uVG9QdWJsaXNoKFxuICAgIHNvdXJjZTogUmVzb3VyY2UsXG4gICAgcHJpbmNpcGFsOiBzdHJpbmcsXG4gICAgc291cmNlQXJuOiBzdHJpbmdcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5wZXJtaXNzaW9ucyA9IG5ldyBTbnNUb3BpY1BvbGljeShcbiAgICAgIHRoaXMsXG4gICAgICBgUHVibGlzaFBlcm1pc3Npb24tJHtzb3VyY2Uubm9kZS5hZGRyfWAsXG4gICAgICB7XG4gICAgICAgIGFybjogdGhpcy50b3BpYy5hcm4sXG4gICAgICAgIHBvbGljeTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIFN0YXRlbWVudDogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBFZmZlY3Q6IFwiQWxsb3dcIixcbiAgICAgICAgICAgICAgUHJpbmNpcGFsOiB7XG4gICAgICAgICAgICAgICAgU2VydmljZTogcHJpbmNpcGFsLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBBY3Rpb246IFwic25zOlB1Ymxpc2hcIixcbiAgICAgICAgICAgICAgUmVzb3VyY2U6IHRoaXMudG9waWMuYXJuLFxuICAgICAgICAgICAgICBDb25kaXRpb246IHtcbiAgICAgICAgICAgICAgICBBcm5FcXVhbHM6IHtcbiAgICAgICAgICAgICAgICAgIFwiYXdzOlNvdXJjZUFyblwiOiBzb3VyY2VBcm4sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSksXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBvbkxpZnQoaG9zdDogSUluZmxpZ2h0SG9zdCwgb3BzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIGlmICghQXdzSW5mbGlnaHRIb3N0LmlzQXdzSW5mbGlnaHRIb3N0KGhvc3QpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJIb3N0IGlzIGV4cGVjdGVkIHRvIGltcGxlbWVudCBgSUF3c0luZmlnaHRIb3N0YFwiKTtcbiAgICB9XG5cbiAgICBob3N0LmFkZFBvbGljeVN0YXRlbWVudHMoLi4uY2FsY3VsYXRlVG9waWNQZXJtaXNzaW9ucyh0aGlzLnRvcGljLmFybiwgb3BzKSk7XG5cbiAgICBob3N0LmFkZEVudmlyb25tZW50KHRoaXMuZW52TmFtZSgpLCB0aGlzLnRvcGljLmFybik7XG5cbiAgICBzdXBlci5vbkxpZnQoaG9zdCwgb3BzKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIF90b0luZmxpZ2h0KCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNvcmUuSW5mbGlnaHRDbGllbnQuZm9yKFxuICAgICAgX19kaXJuYW1lLnJlcGxhY2UoXCJ0YXJnZXQtdGYtYXdzXCIsIFwic2hhcmVkLWF3c1wiKSxcbiAgICAgIF9fZmlsZW5hbWUsXG4gICAgICBcIlRvcGljQ2xpZW50XCIsXG4gICAgICBbYHByb2Nlc3MuZW52W1wiJHt0aGlzLmVudk5hbWUoKX1cIl1gXVxuICAgICk7XG4gIH1cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwdWJsaWMgZ2V0IF9saWZ0TWFwKCk6IGNvcmUuTGlmdE1hcCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIFtjbG91ZC5Ub3BpY0luZmxpZ2h0TWV0aG9kcy5QVUJMSVNIXTogW10sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZW52TmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgVE9QSUNfQVJOXyR7dGhpcy5ub2RlLmFkZHIuc2xpY2UoLTgpfWA7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRvcGljQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMudG9waWMuYXJuO1xuICB9XG5cbiAgcHVibGljIGdldCB0b3BpY05hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy50b3BpYy5uYW1lO1xuICB9XG59XG4iXX0=