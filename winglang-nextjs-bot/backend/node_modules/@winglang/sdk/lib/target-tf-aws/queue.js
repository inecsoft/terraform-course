"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Queue = void 0;
const app_1 = require("./app");
const function_1 = require("./function");
const lambda_event_source_mapping_1 = require("../.gen/providers/aws/lambda-event-source-mapping");
const sqs_queue_1 = require("../.gen/providers/aws/sqs-queue");
const cloud = __importStar(require("../cloud"));
const core = __importStar(require("../core"));
const resource_names_1 = require("../shared/resource-names");
const shared_aws_1 = require("../shared-aws");
const permissions_1 = require("../shared-aws/permissions");
const queue_1 = require("../shared-aws/queue");
const std_1 = require("../std");
/**
 * Queue names are limited to 80 characters.
 * You can use alphanumeric characters, hyphens (-), and underscores (_).
 */
const NAME_OPTS = {
    maxLen: 80,
    disallowedRegex: /[^a-zA-Z0-9\_\-]+/g,
};
/**
 * AWS implementation of `cloud.Queue`.
 *
 * @inflight `@winglang/sdk.aws.IAwsQueueClient`
 */
class Queue extends cloud.Queue {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        const queueOpt = props.dlq
            ? {
                visibilityTimeoutSeconds: props.timeout
                    ? props.timeout.seconds
                    : std_1.Duration.fromSeconds(30).seconds,
                messageRetentionSeconds: props.retentionPeriod
                    ? props.retentionPeriod.seconds
                    : std_1.Duration.fromHours(1).seconds,
                name: resource_names_1.ResourceNames.generateName(this, NAME_OPTS),
                redrivePolicy: JSON.stringify({
                    deadLetterTargetArn: queue_1.Queue.from(props.dlq.queue)?.queueArn,
                    maxReceiveCount: props.dlq.maxDeliveryAttempts ?? cloud.DEFAULT_DELIVERY_ATTEMPTS,
                }),
            }
            : {
                visibilityTimeoutSeconds: props.timeout
                    ? props.timeout.seconds
                    : std_1.Duration.fromSeconds(30).seconds,
                messageRetentionSeconds: props.retentionPeriod
                    ? props.retentionPeriod.seconds
                    : std_1.Duration.fromHours(1).seconds,
                name: resource_names_1.ResourceNames.generateName(this, NAME_OPTS),
            };
        this.queue = new sqs_queue_1.SqsQueue(this, "Default", queueOpt);
    }
    /** @internal */
    get _liftMap() {
        return {
            [cloud.QueueInflightMethods.PUSH]: [],
            [cloud.QueueInflightMethods.PURGE]: [],
            [cloud.QueueInflightMethods.APPROX_SIZE]: [],
            [cloud.QueueInflightMethods.POP]: [],
        };
    }
    setConsumer(inflight, props = {}) {
        const functionHandler = queue_1.QueueSetConsumerHandler.toFunctionHandler(inflight);
        const fn = new function_1.Function(
        // ok since we're not a tree root
        this.node.scope, app_1.App.of(this).makeId(this, `${this.node.id}-SetConsumer`), functionHandler, {
            ...props,
            timeout: std_1.Duration.fromSeconds(this.queue.visibilityTimeoutSeconds ?? 30),
        });
        if (!shared_aws_1.AwsInflightHost.isAwsInflightHost(fn)) {
            throw new Error("Host is expected to implement `IAwsInfightHost`");
        }
        fn.addPolicyStatements({
            actions: [
                "sqs:ReceiveMessage",
                "sqs:ChangeMessageVisibility",
                "sqs:GetQueueUrl",
                "sqs:DeleteMessage",
                "sqs:GetQueueAttributes",
            ],
            resources: [this.queue.arn],
        });
        new lambda_event_source_mapping_1.LambdaEventSourceMapping(this, "EventSourceMapping", {
            functionName: fn.functionName,
            eventSourceArn: this.queue.arn,
            batchSize: props.batchSize ?? 1,
            functionResponseTypes: ["ReportBatchItemFailures"], // It allows the function to return the messages that failed to the queue
        });
        std_1.Node.of(this).addConnection({
            source: this,
            sourceOp: cloud.QueueInflightMethods.PUSH,
            target: fn,
            targetOp: cloud.FunctionInflightMethods.INVOKE,
            name: "consumer",
        });
        return fn;
    }
    onLift(host, ops) {
        const env = this.envName();
        if (!shared_aws_1.AwsInflightHost.isAwsInflightHost(host)) {
            throw new Error("Host is expected to implement `IAwsInfightHost`");
        }
        host.addPolicyStatements(...(0, permissions_1.calculateQueuePermissions)(this.queue.arn, ops));
        // The queue url needs to be passed through an environment variable since
        // it may not be resolved until deployment time.
        host.addEnvironment(env, this.queue.url);
        super.onLift(host, ops);
    }
    /** @internal */
    _toInflight() {
        return core.InflightClient.for(__dirname.replace("target-tf-aws", "shared-aws"), __filename, "QueueClient", [`process.env["${this.envName()}"]`]);
    }
    envName() {
        return `QUEUE_URL_${this.node.addr.slice(-8)}`;
    }
    get queueArn() {
        return this.queue.arn;
    }
    get queueName() {
        return this.queue.name;
    }
    get queueUrl() {
        return this.queue.url;
    }
}
exports.Queue = Queue;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVldWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdGFyZ2V0LXRmLWF3cy9xdWV1ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLCtCQUE0QjtBQUM1Qix5Q0FBc0M7QUFDdEMsbUdBQTZGO0FBQzdGLCtEQUEyRDtBQUMzRCxnREFBa0M7QUFDbEMsOENBQWdDO0FBQ2hDLDZEQUFzRTtBQUN0RSw4Q0FBMkQ7QUFDM0QsMkRBQXNFO0FBQ3RFLCtDQUc2QjtBQUM3QixnQ0FBdUQ7QUFFdkQ7OztHQUdHO0FBQ0gsTUFBTSxTQUFTLEdBQWdCO0lBQzdCLE1BQU0sRUFBRSxFQUFFO0lBQ1YsZUFBZSxFQUFFLG9CQUFvQjtDQUN0QyxDQUFDO0FBRUY7Ozs7R0FJRztBQUNILE1BQWEsS0FBTSxTQUFRLEtBQUssQ0FBQyxLQUFLO0lBR3BDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsUUFBMEIsRUFBRTtRQUNwRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsR0FBRztZQUN4QixDQUFDLENBQUM7Z0JBQ0Usd0JBQXdCLEVBQUUsS0FBSyxDQUFDLE9BQU87b0JBQ3JDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU87b0JBQ3ZCLENBQUMsQ0FBQyxjQUFRLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU87Z0JBQ3BDLHVCQUF1QixFQUFFLEtBQUssQ0FBQyxlQUFlO29CQUM1QyxDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxPQUFPO29CQUMvQixDQUFDLENBQUMsY0FBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPO2dCQUNqQyxJQUFJLEVBQUUsOEJBQWEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQztnQkFDakQsYUFBYSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7b0JBQzVCLG1CQUFtQixFQUFFLGFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxRQUFRO29CQUM3RCxlQUFlLEVBQ2IsS0FBSyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxLQUFLLENBQUMseUJBQXlCO2lCQUNuRSxDQUFDO2FBQ0g7WUFDSCxDQUFDLENBQUM7Z0JBQ0Usd0JBQXdCLEVBQUUsS0FBSyxDQUFDLE9BQU87b0JBQ3JDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU87b0JBQ3ZCLENBQUMsQ0FBQyxjQUFRLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU87Z0JBQ3BDLHVCQUF1QixFQUFFLEtBQUssQ0FBQyxlQUFlO29CQUM1QyxDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxPQUFPO29CQUMvQixDQUFDLENBQUMsY0FBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPO2dCQUNqQyxJQUFJLEVBQUUsOEJBQWEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQzthQUNsRCxDQUFDO1FBRU4sSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLG9CQUFRLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQsZ0JBQWdCO0lBQ2hCLElBQVcsUUFBUTtRQUNqQixPQUFPO1lBQ0wsQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNyQyxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFO1lBQ3RDLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxFQUFFLEVBQUU7WUFDNUMsQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRTtTQUNyQyxDQUFDO0lBQ0osQ0FBQztJQUVNLFdBQVcsQ0FDaEIsUUFBd0MsRUFDeEMsUUFBdUMsRUFBRTtRQUV6QyxNQUFNLGVBQWUsR0FBRywrQkFBdUIsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1RSxNQUFNLEVBQUUsR0FBRyxJQUFJLG1CQUFRO1FBQ3JCLGlDQUFpQztRQUNqQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQU0sRUFDaEIsU0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLGNBQWMsQ0FBQyxFQUN4RCxlQUFlLEVBQ2Y7WUFDRSxHQUFHLEtBQUs7WUFDUixPQUFPLEVBQUUsY0FBUSxDQUFDLFdBQVcsQ0FDM0IsSUFBSSxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsSUFBSSxFQUFFLENBQzFDO1NBQ0YsQ0FDRixDQUFDO1FBRUYsSUFBSSxDQUFDLDRCQUFlLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUMzQyxNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUVELEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQztZQUNyQixPQUFPLEVBQUU7Z0JBQ1Asb0JBQW9CO2dCQUNwQiw2QkFBNkI7Z0JBQzdCLGlCQUFpQjtnQkFDakIsbUJBQW1CO2dCQUNuQix3QkFBd0I7YUFDekI7WUFDRCxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztTQUM1QixDQUFDLENBQUM7UUFFSCxJQUFJLHNEQUF3QixDQUFDLElBQUksRUFBRSxvQkFBb0IsRUFBRTtZQUN2RCxZQUFZLEVBQUUsRUFBRSxDQUFDLFlBQVk7WUFDN0IsY0FBYyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRztZQUM5QixTQUFTLEVBQUUsS0FBSyxDQUFDLFNBQVMsSUFBSSxDQUFDO1lBQy9CLHFCQUFxQixFQUFFLENBQUMseUJBQXlCLENBQUMsRUFBRSx5RUFBeUU7U0FDOUgsQ0FBQyxDQUFDO1FBRUgsVUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUFhLENBQUM7WUFDMUIsTUFBTSxFQUFFLElBQUk7WUFDWixRQUFRLEVBQUUsS0FBSyxDQUFDLG9CQUFvQixDQUFDLElBQUk7WUFDekMsTUFBTSxFQUFFLEVBQUU7WUFDVixRQUFRLEVBQUUsS0FBSyxDQUFDLHVCQUF1QixDQUFDLE1BQU07WUFDOUMsSUFBSSxFQUFFLFVBQVU7U0FDakIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDO0lBRU0sTUFBTSxDQUFDLElBQW1CLEVBQUUsR0FBYTtRQUM5QyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFM0IsSUFBSSxDQUFDLDRCQUFlLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUM3QyxNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUVELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLElBQUEsdUNBQXlCLEVBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUU1RSx5RUFBeUU7UUFDekUsZ0RBQWdEO1FBQ2hELElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFekMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQUVELGdCQUFnQjtJQUNULFdBQVc7UUFDaEIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FDNUIsU0FBUyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsWUFBWSxDQUFDLEVBQ2hELFVBQVUsRUFDVixhQUFhLEVBQ2IsQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FDckMsQ0FBQztJQUNKLENBQUM7SUFFTyxPQUFPO1FBQ2IsT0FBTyxhQUFhLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDakQsQ0FBQztJQUVELElBQVcsUUFBUTtRQUNqQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxJQUFXLFNBQVM7UUFDbEIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztJQUN6QixDQUFDO0lBRUQsSUFBVyxRQUFRO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7SUFDeEIsQ0FBQztDQUNGO0FBeElELHNCQXdJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9hcHBcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIH0gZnJvbSBcIi4vZnVuY3Rpb25cIjtcbmltcG9ydCB7IExhbWJkYUV2ZW50U291cmNlTWFwcGluZyB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3MvbGFtYmRhLWV2ZW50LXNvdXJjZS1tYXBwaW5nXCI7XG5pbXBvcnQgeyBTcXNRdWV1ZSB9IGZyb20gXCIuLi8uZ2VuL3Byb3ZpZGVycy9hd3Mvc3FzLXF1ZXVlXCI7XG5pbXBvcnQgKiBhcyBjbG91ZCBmcm9tIFwiLi4vY2xvdWRcIjtcbmltcG9ydCAqIGFzIGNvcmUgZnJvbSBcIi4uL2NvcmVcIjtcbmltcG9ydCB7IE5hbWVPcHRpb25zLCBSZXNvdXJjZU5hbWVzIH0gZnJvbSBcIi4uL3NoYXJlZC9yZXNvdXJjZS1uYW1lc1wiO1xuaW1wb3J0IHsgQXdzSW5mbGlnaHRIb3N0LCBJQXdzUXVldWUgfSBmcm9tIFwiLi4vc2hhcmVkLWF3c1wiO1xuaW1wb3J0IHsgY2FsY3VsYXRlUXVldWVQZXJtaXNzaW9ucyB9IGZyb20gXCIuLi9zaGFyZWQtYXdzL3Blcm1pc3Npb25zXCI7XG5pbXBvcnQge1xuICBRdWV1ZSBhcyBBd3NRdWV1ZSxcbiAgUXVldWVTZXRDb25zdW1lckhhbmRsZXIsXG59IGZyb20gXCIuLi9zaGFyZWQtYXdzL3F1ZXVlXCI7XG5pbXBvcnQgeyBEdXJhdGlvbiwgSUluZmxpZ2h0SG9zdCwgTm9kZSB9IGZyb20gXCIuLi9zdGRcIjtcblxuLyoqXG4gKiBRdWV1ZSBuYW1lcyBhcmUgbGltaXRlZCB0byA4MCBjaGFyYWN0ZXJzLlxuICogWW91IGNhbiB1c2UgYWxwaGFudW1lcmljIGNoYXJhY3RlcnMsIGh5cGhlbnMgKC0pLCBhbmQgdW5kZXJzY29yZXMgKF8pLlxuICovXG5jb25zdCBOQU1FX09QVFM6IE5hbWVPcHRpb25zID0ge1xuICBtYXhMZW46IDgwLFxuICBkaXNhbGxvd2VkUmVnZXg6IC9bXmEtekEtWjAtOVxcX1xcLV0rL2csXG59O1xuXG4vKipcbiAqIEFXUyBpbXBsZW1lbnRhdGlvbiBvZiBgY2xvdWQuUXVldWVgLlxuICpcbiAqIEBpbmZsaWdodCBgQHdpbmdsYW5nL3Nkay5hd3MuSUF3c1F1ZXVlQ2xpZW50YFxuICovXG5leHBvcnQgY2xhc3MgUXVldWUgZXh0ZW5kcyBjbG91ZC5RdWV1ZSBpbXBsZW1lbnRzIElBd3NRdWV1ZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgcXVldWU6IFNxc1F1ZXVlO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBjbG91ZC5RdWV1ZVByb3BzID0ge30pIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIGNvbnN0IHF1ZXVlT3B0ID0gcHJvcHMuZGxxXG4gICAgICA/IHtcbiAgICAgICAgICB2aXNpYmlsaXR5VGltZW91dFNlY29uZHM6IHByb3BzLnRpbWVvdXRcbiAgICAgICAgICAgID8gcHJvcHMudGltZW91dC5zZWNvbmRzXG4gICAgICAgICAgICA6IER1cmF0aW9uLmZyb21TZWNvbmRzKDMwKS5zZWNvbmRzLFxuICAgICAgICAgIG1lc3NhZ2VSZXRlbnRpb25TZWNvbmRzOiBwcm9wcy5yZXRlbnRpb25QZXJpb2RcbiAgICAgICAgICAgID8gcHJvcHMucmV0ZW50aW9uUGVyaW9kLnNlY29uZHNcbiAgICAgICAgICAgIDogRHVyYXRpb24uZnJvbUhvdXJzKDEpLnNlY29uZHMsXG4gICAgICAgICAgbmFtZTogUmVzb3VyY2VOYW1lcy5nZW5lcmF0ZU5hbWUodGhpcywgTkFNRV9PUFRTKSxcbiAgICAgICAgICByZWRyaXZlUG9saWN5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICBkZWFkTGV0dGVyVGFyZ2V0QXJuOiBBd3NRdWV1ZS5mcm9tKHByb3BzLmRscS5xdWV1ZSk/LnF1ZXVlQXJuLFxuICAgICAgICAgICAgbWF4UmVjZWl2ZUNvdW50OlxuICAgICAgICAgICAgICBwcm9wcy5kbHEubWF4RGVsaXZlcnlBdHRlbXB0cyA/PyBjbG91ZC5ERUZBVUxUX0RFTElWRVJZX0FUVEVNUFRTLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9XG4gICAgICA6IHtcbiAgICAgICAgICB2aXNpYmlsaXR5VGltZW91dFNlY29uZHM6IHByb3BzLnRpbWVvdXRcbiAgICAgICAgICAgID8gcHJvcHMudGltZW91dC5zZWNvbmRzXG4gICAgICAgICAgICA6IER1cmF0aW9uLmZyb21TZWNvbmRzKDMwKS5zZWNvbmRzLFxuICAgICAgICAgIG1lc3NhZ2VSZXRlbnRpb25TZWNvbmRzOiBwcm9wcy5yZXRlbnRpb25QZXJpb2RcbiAgICAgICAgICAgID8gcHJvcHMucmV0ZW50aW9uUGVyaW9kLnNlY29uZHNcbiAgICAgICAgICAgIDogRHVyYXRpb24uZnJvbUhvdXJzKDEpLnNlY29uZHMsXG4gICAgICAgICAgbmFtZTogUmVzb3VyY2VOYW1lcy5nZW5lcmF0ZU5hbWUodGhpcywgTkFNRV9PUFRTKSxcbiAgICAgICAgfTtcblxuICAgIHRoaXMucXVldWUgPSBuZXcgU3FzUXVldWUodGhpcywgXCJEZWZhdWx0XCIsIHF1ZXVlT3B0KTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIGdldCBfbGlmdE1hcCgpOiBjb3JlLkxpZnRNYXAge1xuICAgIHJldHVybiB7XG4gICAgICBbY2xvdWQuUXVldWVJbmZsaWdodE1ldGhvZHMuUFVTSF06IFtdLFxuICAgICAgW2Nsb3VkLlF1ZXVlSW5mbGlnaHRNZXRob2RzLlBVUkdFXTogW10sXG4gICAgICBbY2xvdWQuUXVldWVJbmZsaWdodE1ldGhvZHMuQVBQUk9YX1NJWkVdOiBbXSxcbiAgICAgIFtjbG91ZC5RdWV1ZUluZmxpZ2h0TWV0aG9kcy5QT1BdOiBbXSxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIHNldENvbnN1bWVyKFxuICAgIGluZmxpZ2h0OiBjbG91ZC5JUXVldWVTZXRDb25zdW1lckhhbmRsZXIsXG4gICAgcHJvcHM6IGNsb3VkLlF1ZXVlU2V0Q29uc3VtZXJPcHRpb25zID0ge31cbiAgKTogY2xvdWQuRnVuY3Rpb24ge1xuICAgIGNvbnN0IGZ1bmN0aW9uSGFuZGxlciA9IFF1ZXVlU2V0Q29uc3VtZXJIYW5kbGVyLnRvRnVuY3Rpb25IYW5kbGVyKGluZmxpZ2h0KTtcbiAgICBjb25zdCBmbiA9IG5ldyBGdW5jdGlvbihcbiAgICAgIC8vIG9rIHNpbmNlIHdlJ3JlIG5vdCBhIHRyZWUgcm9vdFxuICAgICAgdGhpcy5ub2RlLnNjb3BlISxcbiAgICAgIEFwcC5vZih0aGlzKS5tYWtlSWQodGhpcywgYCR7dGhpcy5ub2RlLmlkfS1TZXRDb25zdW1lcmApLFxuICAgICAgZnVuY3Rpb25IYW5kbGVyLFxuICAgICAge1xuICAgICAgICAuLi5wcm9wcyxcbiAgICAgICAgdGltZW91dDogRHVyYXRpb24uZnJvbVNlY29uZHMoXG4gICAgICAgICAgdGhpcy5xdWV1ZS52aXNpYmlsaXR5VGltZW91dFNlY29uZHMgPz8gMzBcbiAgICAgICAgKSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKCFBd3NJbmZsaWdodEhvc3QuaXNBd3NJbmZsaWdodEhvc3QoZm4pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJIb3N0IGlzIGV4cGVjdGVkIHRvIGltcGxlbWVudCBgSUF3c0luZmlnaHRIb3N0YFwiKTtcbiAgICB9XG5cbiAgICBmbi5hZGRQb2xpY3lTdGF0ZW1lbnRzKHtcbiAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgXCJzcXM6UmVjZWl2ZU1lc3NhZ2VcIixcbiAgICAgICAgXCJzcXM6Q2hhbmdlTWVzc2FnZVZpc2liaWxpdHlcIixcbiAgICAgICAgXCJzcXM6R2V0UXVldWVVcmxcIixcbiAgICAgICAgXCJzcXM6RGVsZXRlTWVzc2FnZVwiLFxuICAgICAgICBcInNxczpHZXRRdWV1ZUF0dHJpYnV0ZXNcIixcbiAgICAgIF0sXG4gICAgICByZXNvdXJjZXM6IFt0aGlzLnF1ZXVlLmFybl0sXG4gICAgfSk7XG5cbiAgICBuZXcgTGFtYmRhRXZlbnRTb3VyY2VNYXBwaW5nKHRoaXMsIFwiRXZlbnRTb3VyY2VNYXBwaW5nXCIsIHtcbiAgICAgIGZ1bmN0aW9uTmFtZTogZm4uZnVuY3Rpb25OYW1lLFxuICAgICAgZXZlbnRTb3VyY2VBcm46IHRoaXMucXVldWUuYXJuLFxuICAgICAgYmF0Y2hTaXplOiBwcm9wcy5iYXRjaFNpemUgPz8gMSxcbiAgICAgIGZ1bmN0aW9uUmVzcG9uc2VUeXBlczogW1wiUmVwb3J0QmF0Y2hJdGVtRmFpbHVyZXNcIl0sIC8vIEl0IGFsbG93cyB0aGUgZnVuY3Rpb24gdG8gcmV0dXJuIHRoZSBtZXNzYWdlcyB0aGF0IGZhaWxlZCB0byB0aGUgcXVldWVcbiAgICB9KTtcblxuICAgIE5vZGUub2YodGhpcykuYWRkQ29ubmVjdGlvbih7XG4gICAgICBzb3VyY2U6IHRoaXMsXG4gICAgICBzb3VyY2VPcDogY2xvdWQuUXVldWVJbmZsaWdodE1ldGhvZHMuUFVTSCxcbiAgICAgIHRhcmdldDogZm4sXG4gICAgICB0YXJnZXRPcDogY2xvdWQuRnVuY3Rpb25JbmZsaWdodE1ldGhvZHMuSU5WT0tFLFxuICAgICAgbmFtZTogXCJjb25zdW1lclwiLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGZuO1xuICB9XG5cbiAgcHVibGljIG9uTGlmdChob3N0OiBJSW5mbGlnaHRIb3N0LCBvcHM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgY29uc3QgZW52ID0gdGhpcy5lbnZOYW1lKCk7XG5cbiAgICBpZiAoIUF3c0luZmxpZ2h0SG9zdC5pc0F3c0luZmxpZ2h0SG9zdChob3N0KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSG9zdCBpcyBleHBlY3RlZCB0byBpbXBsZW1lbnQgYElBd3NJbmZpZ2h0SG9zdGBcIik7XG4gICAgfVxuXG4gICAgaG9zdC5hZGRQb2xpY3lTdGF0ZW1lbnRzKC4uLmNhbGN1bGF0ZVF1ZXVlUGVybWlzc2lvbnModGhpcy5xdWV1ZS5hcm4sIG9wcykpO1xuXG4gICAgLy8gVGhlIHF1ZXVlIHVybCBuZWVkcyB0byBiZSBwYXNzZWQgdGhyb3VnaCBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSBzaW5jZVxuICAgIC8vIGl0IG1heSBub3QgYmUgcmVzb2x2ZWQgdW50aWwgZGVwbG95bWVudCB0aW1lLlxuICAgIGhvc3QuYWRkRW52aXJvbm1lbnQoZW52LCB0aGlzLnF1ZXVlLnVybCk7XG5cbiAgICBzdXBlci5vbkxpZnQoaG9zdCwgb3BzKTtcbiAgfVxuXG4gIC8qKiBAaW50ZXJuYWwgKi9cbiAgcHVibGljIF90b0luZmxpZ2h0KCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNvcmUuSW5mbGlnaHRDbGllbnQuZm9yKFxuICAgICAgX19kaXJuYW1lLnJlcGxhY2UoXCJ0YXJnZXQtdGYtYXdzXCIsIFwic2hhcmVkLWF3c1wiKSxcbiAgICAgIF9fZmlsZW5hbWUsXG4gICAgICBcIlF1ZXVlQ2xpZW50XCIsXG4gICAgICBbYHByb2Nlc3MuZW52W1wiJHt0aGlzLmVudk5hbWUoKX1cIl1gXVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGVudk5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYFFVRVVFX1VSTF8ke3RoaXMubm9kZS5hZGRyLnNsaWNlKC04KX1gO1xuICB9XG5cbiAgcHVibGljIGdldCBxdWV1ZUFybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnF1ZXVlLmFybjtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcXVldWVOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMucXVldWUubmFtZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcXVldWVVcmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5xdWV1ZS51cmw7XG4gIH1cbn1cbiJdfQ==