"use strict";
// Copyright (c) HashiCorp, Inc
// SPDX-License-Identifier: MPL-2.0
// ----------------------------------------------------------------------
// PROPERTY MAPPERS
//
// These are used while converting generated classes/property bags to Terraform JSON objects
//
// We use identity mappers for the primitive types. These don't do anything but are there to make the code
// generation work out nicely (so the code generator doesn't need to emit different code for primitive
Object.defineProperty(exports, "__esModule", { value: true });
exports.isComplexElement = exports.canInspect = exports.hashMapperHcl = exports.hashMapper = exports.listMapperHcl = exports.listMapper = exports.numberToHclTerraform = exports.anyToHclTerraform = exports.booleanToHclTerraform = exports.stringToHclTerraform = exports.numberToTerraform = exports.anyToTerraform = exports.booleanToTerraform = exports.stringToTerraform = void 0;
const encoding_1 = require("./tokens/private/encoding");
Object.defineProperty(exports, "isComplexElement", { enumerable: true, get: function () { return encoding_1.isComplexElement; } });
const tokens_1 = require("./tokens");
const terraform_dynamic_block_1 = require("./terraform-dynamic-block");
const terraform_dynamic_expression_1 = require("./terraform-dynamic-expression");
// eslint-disable-next-line jsdoc/require-jsdoc
function identity(x) {
    return x;
}
exports.stringToTerraform = identity;
exports.booleanToTerraform = identity;
exports.anyToTerraform = identity;
exports.numberToTerraform = identity;
exports.stringToHclTerraform = identity;
exports.booleanToHclTerraform = identity;
exports.anyToHclTerraform = identity;
exports.numberToHclTerraform = identity;
/**
 * @param isBlockType blocks and lists of objects need to be handled different in Terraform
 *                    but are represented exactly the same in generated bindings
 *                    currently this is used to resolve TerraformDynamicBlocks if not within
 *                    a block type (will be resolved to a for expression for those instead of
 *                    a dynamic block)
 */
function listMapper(elementMapper, isBlockType) {
    return (x) => {
        if (!canInspect(x)) {
            return x;
        }
        // replace dynamic expressions for block types so they can be detected and replaced properly by processDynamicAttributes()
        // which also relocates them to dynamic.attributeName (something we can't do when resolving a value, put it somewhere else)
        // if isBlockType is false, the TerraformDynamicExpression that is present will be resolved (it implements IResolvable) to a
        // for expression directly (which can be used e.g. within Terraform functions or for attributes that are not of a block type)
        if (terraform_dynamic_expression_1.TerraformDynamicExpression.isTerraformDynamicExpression(x) &&
            isBlockType) {
            return terraform_dynamic_block_1.TerraformDynamicBlock.fromDynamicExpression(x);
        }
        if (!Array.isArray(x)) {
            return x;
        }
        return x.map(elementMapper);
    };
}
exports.listMapper = listMapper;
/**
 * @param isBlockType blocks and lists of objects need to be handled different in Terraform
 *                    but are represented exactly the same in generated bindings
 *                    currently this is used to resolve TerraformDynamicBlocks if not within
 *                    a block type (will be resolved to a for expression for those instead of
 *                    a dynamic block)
 */
function listMapperHcl(elementMapper, isBlockType) {
    return (x) => {
        if (!canInspect(x)) {
            return x;
        }
        // replace dynamic expressions for block types so they can be detected and replaced properly by processDynamicAttributes()
        // which also relocates them to dynamic.attributeName (something we can't do when resolving a value, put it somewhere else)
        // if isBlockType is false, the TerraformDynamicExpression that is present will be resolved (it implements IResolvable) to a
        // for expression directly (which can be used e.g. within Terraform functions or for attributes that are not of a block type)
        if (terraform_dynamic_expression_1.TerraformDynamicExpression.isTerraformDynamicExpression(x) &&
            isBlockType) {
            return terraform_dynamic_block_1.TerraformDynamicBlock.fromDynamicExpression(x);
        }
        if (!Array.isArray(x)) {
            return x;
        }
        return x.map(elementMapper);
    };
}
exports.listMapperHcl = listMapperHcl;
// eslint-disable-next-line jsdoc/require-jsdoc
function hashMapper(elementMapper) {
    return (x) => {
        if (!canInspect(x)) {
            return x;
        }
        // Check if it's a token object
        if ((0, encoding_1.containsComplexElement)(x)) {
            return x;
        }
        if (tokens_1.Tokenization.isResolvable(x)) {
            return x;
        }
        // We can't treat strings as hashes (likely a token or a misconfiguration)
        if (typeof x === "string") {
            return x;
        }
        if ((0, encoding_1.containsMapToken)(x)) {
            return x;
        }
        const ret = {};
        Object.keys(x).forEach((key) => {
            ret[key] = elementMapper(x[key]);
        });
        return ret;
    };
}
exports.hashMapper = hashMapper;
/**
 *
 */
function hashMapperHcl(elementMapper) {
    return (x) => {
        if (!canInspect(x)) {
            return x;
        }
        // Check if it's a token object
        if ((0, encoding_1.containsComplexElement)(x)) {
            return x;
        }
        if (tokens_1.Tokenization.isResolvable(x)) {
            return x;
        }
        // We can't treat strings as hashes (likely a token or a misconfiguration)
        if (typeof x === "string") {
            return x;
        }
        if ((0, encoding_1.containsMapToken)(x)) {
            return x;
        }
        const ret = {};
        Object.keys(x).forEach((key) => {
            ret[key] = elementMapper(x[key]);
        });
        return ret;
    };
}
exports.hashMapperHcl = hashMapperHcl;
/**
 * Return whether this object can be validated at all
 *
 * True unless it's undefined
 */
function canInspect(x) {
    // Note: using weak equality on purpose, we also want to catch undefined
    return x != null;
}
exports.canInspect = canInspect;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVudGltZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJ1bnRpbWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLCtCQUErQjtBQUMvQixtQ0FBbUM7QUFDbkMseUVBQXlFO0FBQ3pFLG1CQUFtQjtBQUNuQixFQUFFO0FBQ0YsNEZBQTRGO0FBQzVGLEVBQUU7QUFDRiwwR0FBMEc7QUFDMUcsc0dBQXNHOzs7QUFFdEcsd0RBSW1DO0FBOEsxQixpR0FoTFAsMkJBQWdCLE9BZ0xPO0FBN0t6QixxQ0FBd0M7QUFDeEMsdUVBQWtFO0FBQ2xFLGlGQUE0RTtBQUs1RSwrQ0FBK0M7QUFDL0MsU0FBUyxRQUFRLENBQUMsQ0FBTTtJQUN0QixPQUFPLENBQUMsQ0FBQztBQUNYLENBQUM7QUFFWSxRQUFBLGlCQUFpQixHQUFXLFFBQVEsQ0FBQztBQUNyQyxRQUFBLGtCQUFrQixHQUFXLFFBQVEsQ0FBQztBQUN0QyxRQUFBLGNBQWMsR0FBVyxRQUFRLENBQUM7QUFDbEMsUUFBQSxpQkFBaUIsR0FBVyxRQUFRLENBQUM7QUFFckMsUUFBQSxvQkFBb0IsR0FBVyxRQUFRLENBQUM7QUFDeEMsUUFBQSxxQkFBcUIsR0FBVyxRQUFRLENBQUM7QUFDekMsUUFBQSxpQkFBaUIsR0FBVyxRQUFRLENBQUM7QUFDckMsUUFBQSxvQkFBb0IsR0FBVyxRQUFRLENBQUM7QUFFckQ7Ozs7OztHQU1HO0FBQ0gsU0FBZ0IsVUFBVSxDQUN4QixhQUFxQixFQUNyQixXQUFxQjtJQUVyQixPQUFPLENBQUMsQ0FBTSxFQUFFLEVBQUU7UUFDaEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ25CLE9BQU8sQ0FBQyxDQUFDO1FBQ1gsQ0FBQztRQUVELDBIQUEwSDtRQUMxSCwySEFBMkg7UUFDM0gsNEhBQTRIO1FBQzVILDZIQUE2SDtRQUM3SCxJQUNFLHlEQUEwQixDQUFDLDRCQUE0QixDQUFDLENBQUMsQ0FBQztZQUMxRCxXQUFXLEVBQ1gsQ0FB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MEVBQTBFO1FBQzFFLElBQUksT0FBTyxDQUFDLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDMUIsT0FBTyxDQUFDLENBQUM7UUFDWCxDQUFDO1FBRUQsSUFBSSxJQUFBLDJCQUFnQixFQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDeEIsT0FBTyxDQUFDLENBQUM7UUFDWCxDQUFDO1FBRUQsTUFBTSxHQUFHLEdBQVEsRUFBRSxDQUFDO1FBRXBCLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDN0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNuQyxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQWhDRCxzQ0FnQ0M7QUFFRDs7OztHQUlHO0FBQ0gsU0FBZ0IsVUFBVSxDQUFDLENBQU07SUFDL0Isd0VBQXdFO0lBQ3hFLE9BQU8sQ0FBQyxJQUFJLElBQUksQ0FBQztBQUNuQixDQUFDO0FBSEQsZ0NBR0MiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIEhhc2hpQ29ycCwgSW5jXG4vLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTVBMLTIuMFxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gUFJPUEVSVFkgTUFQUEVSU1xuLy9cbi8vIFRoZXNlIGFyZSB1c2VkIHdoaWxlIGNvbnZlcnRpbmcgZ2VuZXJhdGVkIGNsYXNzZXMvcHJvcGVydHkgYmFncyB0byBUZXJyYWZvcm0gSlNPTiBvYmplY3RzXG4vL1xuLy8gV2UgdXNlIGlkZW50aXR5IG1hcHBlcnMgZm9yIHRoZSBwcmltaXRpdmUgdHlwZXMuIFRoZXNlIGRvbid0IGRvIGFueXRoaW5nIGJ1dCBhcmUgdGhlcmUgdG8gbWFrZSB0aGUgY29kZVxuLy8gZ2VuZXJhdGlvbiB3b3JrIG91dCBuaWNlbHkgKHNvIHRoZSBjb2RlIGdlbmVyYXRvciBkb2Vzbid0IG5lZWQgdG8gZW1pdCBkaWZmZXJlbnQgY29kZSBmb3IgcHJpbWl0aXZlXG5cbmltcG9ydCB7XG4gIGNvbnRhaW5zQ29tcGxleEVsZW1lbnQsXG4gIGlzQ29tcGxleEVsZW1lbnQsXG4gIGNvbnRhaW5zTWFwVG9rZW4sXG59IGZyb20gXCIuL3Rva2Vucy9wcml2YXRlL2VuY29kaW5nXCI7XG5pbXBvcnQgeyBUb2tlbml6YXRpb24gfSBmcm9tIFwiLi90b2tlbnNcIjtcbmltcG9ydCB7IFRlcnJhZm9ybUR5bmFtaWNCbG9jayB9IGZyb20gXCIuL3RlcnJhZm9ybS1keW5hbWljLWJsb2NrXCI7XG5pbXBvcnQgeyBUZXJyYWZvcm1EeW5hbWljRXhwcmVzc2lvbiB9IGZyb20gXCIuL3RlcnJhZm9ybS1keW5hbWljLWV4cHJlc3Npb25cIjtcblxuLy8gdnMuIGNvbXBsZXggdHlwZXMpLlxuZXhwb3J0IHR5cGUgTWFwcGVyID0gKHg6IGFueSkgPT4gYW55O1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUganNkb2MvcmVxdWlyZS1qc2RvY1xuZnVuY3Rpb24gaWRlbnRpdHkoeDogYW55KSB7XG4gIHJldHVybiB4O1xufVxuXG5leHBvcnQgY29uc3Qgc3RyaW5nVG9UZXJyYWZvcm06IE1hcHBlciA9IGlkZW50aXR5O1xuZXhwb3J0IGNvbnN0IGJvb2xlYW5Ub1RlcnJhZm9ybTogTWFwcGVyID0gaWRlbnRpdHk7XG5leHBvcnQgY29uc3QgYW55VG9UZXJyYWZvcm06IE1hcHBlciA9IGlkZW50aXR5O1xuZXhwb3J0IGNvbnN0IG51bWJlclRvVGVycmFmb3JtOiBNYXBwZXIgPSBpZGVudGl0eTtcblxuZXhwb3J0IGNvbnN0IHN0cmluZ1RvSGNsVGVycmFmb3JtOiBNYXBwZXIgPSBpZGVudGl0eTtcbmV4cG9ydCBjb25zdCBib29sZWFuVG9IY2xUZXJyYWZvcm06IE1hcHBlciA9IGlkZW50aXR5O1xuZXhwb3J0IGNvbnN0IGFueVRvSGNsVGVycmFmb3JtOiBNYXBwZXIgPSBpZGVudGl0eTtcbmV4cG9ydCBjb25zdCBudW1iZXJUb0hjbFRlcnJhZm9ybTogTWFwcGVyID0gaWRlbnRpdHk7XG5cbi8qKlxuICogQHBhcmFtIGlzQmxvY2tUeXBlIGJsb2NrcyBhbmQgbGlzdHMgb2Ygb2JqZWN0cyBuZWVkIHRvIGJlIGhhbmRsZWQgZGlmZmVyZW50IGluIFRlcnJhZm9ybVxuICogICAgICAgICAgICAgICAgICAgIGJ1dCBhcmUgcmVwcmVzZW50ZWQgZXhhY3RseSB0aGUgc2FtZSBpbiBnZW5lcmF0ZWQgYmluZGluZ3NcbiAqICAgICAgICAgICAgICAgICAgICBjdXJyZW50bHkgdGhpcyBpcyB1c2VkIHRvIHJlc29sdmUgVGVycmFmb3JtRHluYW1pY0Jsb2NrcyBpZiBub3Qgd2l0aGluXG4gKiAgICAgICAgICAgICAgICAgICAgYSBibG9jayB0eXBlICh3aWxsIGJlIHJlc29sdmVkIHRvIGEgZm9yIGV4cHJlc3Npb24gZm9yIHRob3NlIGluc3RlYWQgb2ZcbiAqICAgICAgICAgICAgICAgICAgICBhIGR5bmFtaWMgYmxvY2spXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBsaXN0TWFwcGVyKFxuICBlbGVtZW50TWFwcGVyOiBNYXBwZXIsXG4gIGlzQmxvY2tUeXBlPzogYm9vbGVhblxuKTogTWFwcGVyIHtcbiAgcmV0dXJuICh4OiBhbnkpID0+IHtcbiAgICBpZiAoIWNhbkluc3BlY3QoeCkpIHtcbiAgICAgIHJldHVybiB4O1xuICAgIH1cblxuICAgIC8vIHJlcGxhY2UgZHluYW1pYyBleHByZXNzaW9ucyBmb3IgYmxvY2sgdHlwZXMgc28gdGhleSBjYW4gYmUgZGV0ZWN0ZWQgYW5kIHJlcGxhY2VkIHByb3Blcmx5IGJ5IHByb2Nlc3NEeW5hbWljQXR0cmlidXRlcygpXG4gICAgLy8gd2hpY2ggYWxzbyByZWxvY2F0ZXMgdGhlbSB0byBkeW5hbWljLmF0dHJpYnV0ZU5hbWUgKHNvbWV0aGluZyB3ZSBjYW4ndCBkbyB3aGVuIHJlc29sdmluZyBhIHZhbHVlLCBwdXQgaXQgc29tZXdoZXJlIGVsc2UpXG4gICAgLy8gaWYgaXNCbG9ja1R5cGUgaXMgZmFsc2UsIHRoZSBUZXJyYWZvcm1EeW5hbWljRXhwcmVzc2lvbiB0aGF0IGlzIHByZXNlbnQgd2lsbCBiZSByZXNvbHZlZCAoaXQgaW1wbGVtZW50cyBJUmVzb2x2YWJsZSkgdG8gYVxuICAgIC8vIGZvciBleHByZXNzaW9uIGRpcmVjdGx5ICh3aGljaCBjYW4gYmUgdXNlZCBlLmcuIHdpdGhpbiBUZXJyYWZvcm0gZnVuY3Rpb25zIG9yIGZvciBhdHRyaWJ1dGVzIHRoYXQgYXJlIG5vdCBvZiBhIGJsb2NrIHR5cGUpXG4gICAgaWYgKFxuICAgICAgVGVycmFmb3JtRHluYW1pY0V4cHJlc3Npb24uaXNUZXJyYWZvcm1EeW5hbWljRXhwcmVzc2lvbih4KSAmJlxuICAgICAgaXNCbG9ja1R5cGVcbiAgICApIHtcbiAgICAgIHJldHVybiBUZXJyYWZvcm1EeW5hbWljQmxvY2suZnJvbUR5bmFtaWNFeHByZXNzaW9uKHgpO1xuICAgIH1cblxuICAgIGlmICghQXJyYXkuaXNBcnJheSh4KSkge1xuICAgICAgcmV0dXJuIHg7XG4gICAgfVxuXG4gICAgcmV0dXJuIHgubWFwKGVsZW1lbnRNYXBwZXIpO1xuICB9O1xufVxuXG4vKipcbiAqIEBwYXJhbSBpc0Jsb2NrVHlwZSBibG9ja3MgYW5kIGxpc3RzIG9mIG9iamVjdHMgbmVlZCB0byBiZSBoYW5kbGVkIGRpZmZlcmVudCBpbiBUZXJyYWZvcm1cbiAqICAgICAgICAgICAgICAgICAgICBidXQgYXJlIHJlcHJlc2VudGVkIGV4YWN0bHkgdGhlIHNhbWUgaW4gZ2VuZXJhdGVkIGJpbmRpbmdzXG4gKiAgICAgICAgICAgICAgICAgICAgY3VycmVudGx5IHRoaXMgaXMgdXNlZCB0byByZXNvbHZlIFRlcnJhZm9ybUR5bmFtaWNCbG9ja3MgaWYgbm90IHdpdGhpblxuICogICAgICAgICAgICAgICAgICAgIGEgYmxvY2sgdHlwZSAod2lsbCBiZSByZXNvbHZlZCB0byBhIGZvciBleHByZXNzaW9uIGZvciB0aG9zZSBpbnN0ZWFkIG9mXG4gKiAgICAgICAgICAgICAgICAgICAgYSBkeW5hbWljIGJsb2NrKVxuICovXG5leHBvcnQgZnVuY3Rpb24gbGlzdE1hcHBlckhjbChcbiAgZWxlbWVudE1hcHBlcjogTWFwcGVyLFxuICBpc0Jsb2NrVHlwZT86IGJvb2xlYW5cbik6IE1hcHBlciB7XG4gIHJldHVybiAoeDogYW55KSA9PiB7XG4gICAgaWYgKCFjYW5JbnNwZWN0KHgpKSB7XG4gICAgICByZXR1cm4geDtcbiAgICB9XG5cbiAgICAvLyByZXBsYWNlIGR5bmFtaWMgZXhwcmVzc2lvbnMgZm9yIGJsb2NrIHR5cGVzIHNvIHRoZXkgY2FuIGJlIGRldGVjdGVkIGFuZCByZXBsYWNlZCBwcm9wZXJseSBieSBwcm9jZXNzRHluYW1pY0F0dHJpYnV0ZXMoKVxuICAgIC8vIHdoaWNoIGFsc28gcmVsb2NhdGVzIHRoZW0gdG8gZHluYW1pYy5hdHRyaWJ1dGVOYW1lIChzb21ldGhpbmcgd2UgY2FuJ3QgZG8gd2hlbiByZXNvbHZpbmcgYSB2YWx1ZSwgcHV0IGl0IHNvbWV3aGVyZSBlbHNlKVxuICAgIC8vIGlmIGlzQmxvY2tUeXBlIGlzIGZhbHNlLCB0aGUgVGVycmFmb3JtRHluYW1pY0V4cHJlc3Npb24gdGhhdCBpcyBwcmVzZW50IHdpbGwgYmUgcmVzb2x2ZWQgKGl0IGltcGxlbWVudHMgSVJlc29sdmFibGUpIHRvIGFcbiAgICAvLyBmb3IgZXhwcmVzc2lvbiBkaXJlY3RseSAod2hpY2ggY2FuIGJlIHVzZWQgZS5nLiB3aXRoaW4gVGVycmFmb3JtIGZ1bmN0aW9ucyBvciBmb3IgYXR0cmlidXRlcyB0aGF0IGFyZSBub3Qgb2YgYSBibG9jayB0eXBlKVxuICAgIGlmIChcbiAgICAgIFRlcnJhZm9ybUR5bmFtaWNFeHByZXNzaW9uLmlzVGVycmFmb3JtRHluYW1pY0V4cHJlc3Npb24oeCkgJiZcbiAgICAgIGlzQmxvY2tUeXBlXG4gICAgKSB7XG4gICAgICByZXR1cm4gVGVycmFmb3JtRHluYW1pY0Jsb2NrLmZyb21EeW5hbWljRXhwcmVzc2lvbih4KTtcbiAgICB9XG5cbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoeCkpIHtcbiAgICAgIHJldHVybiB4O1xuICAgIH1cblxuICAgIHJldHVybiB4Lm1hcChlbGVtZW50TWFwcGVyKTtcbiAgfTtcbn1cblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGpzZG9jL3JlcXVpcmUtanNkb2NcbmV4cG9ydCBmdW5jdGlvbiBoYXNoTWFwcGVyKGVsZW1lbnRNYXBwZXI6IE1hcHBlcik6IE1hcHBlciB7XG4gIHJldHVybiAoeDogYW55KSA9PiB7XG4gICAgaWYgKCFjYW5JbnNwZWN0KHgpKSB7XG4gICAgICByZXR1cm4geDtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiBpdCdzIGEgdG9rZW4gb2JqZWN0XG4gICAgaWYgKGNvbnRhaW5zQ29tcGxleEVsZW1lbnQoeCkpIHtcbiAgICAgIHJldHVybiB4O1xuICAgIH1cblxuICAgIGlmIChUb2tlbml6YXRpb24uaXNSZXNvbHZhYmxlKHgpKSB7XG4gICAgICByZXR1cm4geDtcbiAgICB9XG5cbiAgICAvLyBXZSBjYW4ndCB0cmVhdCBzdHJpbmdzIGFzIGhhc2hlcyAobGlrZWx5IGEgdG9rZW4gb3IgYSBtaXNjb25maWd1cmF0aW9uKVxuICAgIGlmICh0eXBlb2YgeCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIHg7XG4gICAgfVxuXG4gICAgaWYgKGNvbnRhaW5zTWFwVG9rZW4oeCkpIHtcbiAgICAgIHJldHVybiB4O1xuICAgIH1cblxuICAgIGNvbnN0IHJldDogYW55ID0ge307XG5cbiAgICBPYmplY3Qua2V5cyh4KS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIHJldFtrZXldID0gZWxlbWVudE1hcHBlcih4W2tleV0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJldDtcbiAgfTtcbn1cblxuLyoqXG4gKlxuICovXG5leHBvcnQgZnVuY3Rpb24gaGFzaE1hcHBlckhjbChlbGVtZW50TWFwcGVyOiBNYXBwZXIpOiBNYXBwZXIge1xuICByZXR1cm4gKHg6IGFueSkgPT4ge1xuICAgIGlmICghY2FuSW5zcGVjdCh4KSkge1xuICAgICAgcmV0dXJuIHg7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgaXQncyBhIHRva2VuIG9iamVjdFxuICAgIGlmIChjb250YWluc0NvbXBsZXhFbGVtZW50KHgpKSB7XG4gICAgICByZXR1cm4geDtcbiAgICB9XG5cbiAgICBpZiAoVG9rZW5pemF0aW9uLmlzUmVzb2x2YWJsZSh4KSkge1xuICAgICAgcmV0dXJuIHg7XG4gICAgfVxuXG4gICAgLy8gV2UgY2FuJ3QgdHJlYXQgc3RyaW5ncyBhcyBoYXNoZXMgKGxpa2VseSBhIHRva2VuIG9yIGEgbWlzY29uZmlndXJhdGlvbilcbiAgICBpZiAodHlwZW9mIHggPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiB4O1xuICAgIH1cblxuICAgIGlmIChjb250YWluc01hcFRva2VuKHgpKSB7XG4gICAgICByZXR1cm4geDtcbiAgICB9XG5cbiAgICBjb25zdCByZXQ6IGFueSA9IHt9O1xuXG4gICAgT2JqZWN0LmtleXMoeCkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICByZXRba2V5XSA9IGVsZW1lbnRNYXBwZXIoeFtrZXldKTtcbiAgICB9KTtcblxuICAgIHJldHVybiByZXQ7XG4gIH07XG59XG5cbi8qKlxuICogUmV0dXJuIHdoZXRoZXIgdGhpcyBvYmplY3QgY2FuIGJlIHZhbGlkYXRlZCBhdCBhbGxcbiAqXG4gKiBUcnVlIHVubGVzcyBpdCdzIHVuZGVmaW5lZFxuICovXG5leHBvcnQgZnVuY3Rpb24gY2FuSW5zcGVjdCh4OiBhbnkpIHtcbiAgLy8gTm90ZTogdXNpbmcgd2VhayBlcXVhbGl0eSBvbiBwdXJwb3NlLCB3ZSBhbHNvIHdhbnQgdG8gY2F0Y2ggdW5kZWZpbmVkXG4gIHJldHVybiB4ICE9IG51bGw7XG59XG5leHBvcnQgeyBpc0NvbXBsZXhFbGVtZW50IH07XG4iXX0=